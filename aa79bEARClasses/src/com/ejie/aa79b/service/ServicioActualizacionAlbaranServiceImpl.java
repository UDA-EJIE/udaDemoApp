package com.ejie.aa79b.service;

import java.util.List;
import java.util.Locale;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.support.ReloadableResourceBundleMessageSource;
import org.springframework.stereotype.Service;

import com.ejie.aa79b.dao.GenericoDao;
import com.ejie.aa79b.dao.RegistroAccionesDao;
import com.ejie.aa79b.dao.ServicioActualizacionAlbaranDao;
import com.ejie.aa79b.dao.TareasGeneralDao;
import com.ejie.aa79b.model.Albaran;
import com.ejie.aa79b.model.DatosPagoProveedores;
import com.ejie.aa79b.model.Expediente;
import com.ejie.aa79b.model.RegistroAcciones;
import com.ejie.aa79b.model.enums.AccionesEnum;
import com.ejie.aa79b.model.enums.EstadoAlbaranEnum;
import com.ejie.aa79b.model.enums.PuntosMenuEnum;
import com.ejie.x38.dto.JQGridRequestDto;
import com.ejie.x38.dto.JQGridResponseDto;
import com.ejie.x38.dto.TableRowDto;

/**
 * RegistroAccionesServiceImpl generated by UDA, 05-dic-2017 12:40:37.
 * 
 * @author UDA
 */

@Service(value = "servicioActualizacionAlbaranService")
public class ServicioActualizacionAlbaranServiceImpl extends GenericoServiceImpl<Albaran>
		implements ServicioActualizacionAlbaranService {

	@Autowired()
	private ServicioActualizacionAlbaranDao servicioActualizacionAlbaranDao;
	@Autowired()
	private RegistroAccionesDao registroAccionesDao;
	@Autowired()
	private TareasGeneralDao tareasGeneralDao;
	@Autowired()
	private ReloadableResourceBundleMessageSource appMessageSource;

	@Override()
	protected GenericoDao<Albaran> getDao() {
		return this.servicioActualizacionAlbaranDao;
	}

	@Override
	public JQGridResponseDto<Albaran> filter(Albaran albaranFilter, JQGridRequestDto jqGridRequestDto,
			boolean startsWith) {

		List<Albaran> listaAlbaran = this.servicioActualizacionAlbaranDao.findAllLike(albaranFilter, jqGridRequestDto,
				false);

		Long recordNum = this.servicioActualizacionAlbaranDao.findAllLikeCount(albaranFilter, false);

		if (jqGridRequestDto.getMultiselection().getSelectedIds() != null) {
			List<TableRowDto<Albaran>> reorderSelection = this.servicioActualizacionAlbaranDao
					.reorderSelection(albaranFilter, jqGridRequestDto, startsWith);
			return new JQGridResponseDto<Albaran>(jqGridRequestDto, recordNum, listaAlbaran, reorderSelection);
		}
		return new JQGridResponseDto<Albaran>(jqGridRequestDto, recordNum, listaAlbaran);
	}

	@Override
	public Albaran obtenerDatosDetalleAlbaran(Albaran albaran) {
		return this.servicioActualizacionAlbaranDao.obtenerDatosDetalleAlbaran(albaran);
	}

	@Override
	public JQGridResponseDto<DatosPagoProveedores> detalleTareasAlbaran(DatosPagoProveedores datosPagoProveedores,
			JQGridRequestDto jqGridRequestDto, Boolean startsWith) {

		@SuppressWarnings("unchecked")
		List<DatosPagoProveedores> listaTareasAlbaran = (List<DatosPagoProveedores>) this.servicioActualizacionAlbaranDao
				.detalleTareasAlbaran(datosPagoProveedores, jqGridRequestDto, false, false);

		Long recordNum = 0L;
		if (listaTareasAlbaran != null && !listaTareasAlbaran.isEmpty()) {
			recordNum = (Long) this.servicioActualizacionAlbaranDao.detalleTareasAlbaran(datosPagoProveedores,
					jqGridRequestDto, false, true);
		}

		if (jqGridRequestDto != null) {
			return new JQGridResponseDto<DatosPagoProveedores>(jqGridRequestDto, recordNum, listaTareasAlbaran);
		} else {
			return new JQGridResponseDto<DatosPagoProveedores>(new JQGridRequestDto(), recordNum, listaTareasAlbaran);
		}
	}

	@Override
	public Integer comprobarEstadoAlbaranTareas(String[] refAlbaranListString) {
		Integer result = 0;
		boolean salir = false;
		List<Albaran> albaranList = this.servicioActualizacionAlbaranDao
				.datosAlbaranTareasAsocPorIdAlbaranIn(refAlbaranListString);
		for (int x = 0; x < albaranList.size() && !salir; x++) {
			if (albaranList.get(x).getEstado().equals(EstadoAlbaranEnum.PAGADO.getValue())) {
				result = 1;
				salir = true;
			} else if (albaranList.get(x).getNumTareasAsoc() > 0) {
				result = 2;
				salir = true;
			}
		}
		return result;
	}

	@Override
	public void borrarAlbaran(String[] refAlbaranListString, Locale locale) {
		this.servicioActualizacionAlbaranDao.borrarAlbaran(refAlbaranListString);
		RegistroAcciones registroAcciones = new RegistroAcciones();
		registroAcciones.setIdPuntoMenu(PuntosMenuEnum.CONSULTA_ALBARANES_PROVEDOR.getValue());
		registroAcciones.setIdAccion(AccionesEnum.BORRADO.getValue());

		StringBuilder refAlbaranStr = new StringBuilder();
		for (int i = 0; i > refAlbaranListString.length; i++) {
			if (refAlbaranListString[i + 1] != "") {
				refAlbaranStr.append(refAlbaranListString[i] + ", ");
			} else {
				refAlbaranStr.append(refAlbaranListString[i]);
			}
		}

		registroAcciones
				.setObserv(this.appMessageSource.getMessage("label.regAcciones.albaranBorradoConRef", null, locale)
						+ " " + refAlbaranStr);
		this.registroAccionesDao.add(registroAcciones);
	}

	@Override
	public void desasociarAlbaran(String[] idTareasList, Locale locale) {
		this.servicioActualizacionAlbaranDao.desasociarAlbaran(idTareasList);
		List<Expediente> expList = this.tareasGeneralDao.obtenerAnyoNumexpEstadoBitacoraInIdTarea(idTareasList);
		RegistroAcciones registroAcciones = new RegistroAcciones();
		registroAcciones.setIdPuntoMenu(PuntosMenuEnum.CONSULTA_ALBARANES_PROVEDOR.getValue());
		registroAcciones.setIdAccion(AccionesEnum.MODIFICACION.getValue());

		for (Expediente exp : expList) {
			registroAcciones.setAnyo(exp.getAnyo());
			registroAcciones.setNumExp(exp.getNumExp());
			registroAcciones.setEstadoBitacora(exp.getEstadoBitacora());
			registroAcciones
					.setObserv(this.appMessageSource.getMessage("label.regAcciones.tareaDesasociada", null, locale)
							+ " " + exp.getExpedienteTradRev().getTradosExp().getIdTarea());
		}

		this.registroAccionesDao.add(registroAcciones);
	}

	@Override
	public List<Albaran> filterGetSelectedIds(Albaran filterAlbaran, JQGridRequestDto tableData) {
		return this.servicioActualizacionAlbaranDao.filterGetSelectedIds(filterAlbaran, tableData);
	}
}
