package com.ejie.aa79b.service;

import java.io.ByteArrayInputStream;
import java.lang.reflect.Method;
import java.math.BigDecimal;
import java.util.Date;
import java.util.Iterator;
import java.util.LinkedHashSet;
import java.util.List;
import java.util.Properties;
import java.util.Set;
import java.util.zip.ZipEntry;
import java.util.zip.ZipInputStream;

import javax.servlet.http.HttpServletRequest;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.dao.CargaTrabajoDao;
import com.ejie.aa79b.dao.DatosPagoProveedoresDao;
import com.ejie.aa79b.dao.DatosTareaTradosDocsDao;
import com.ejie.aa79b.dao.DatosTareaTradosMetadatosDao;
import com.ejie.aa79b.dao.TareasDao;
import com.ejie.aa79b.dao.TareasGeneralDao;
import com.ejie.aa79b.dao.TareasGestionInterpretacionDao;
import com.ejie.aa79b.model.DatosPagoProveedores;
import com.ejie.aa79b.model.DatosTareaTrados;
import com.ejie.aa79b.model.DatosTareaTradosDocs;
import com.ejie.aa79b.model.DocumentoTarea;
import com.ejie.aa79b.model.DocumentosExpediente;
import com.ejie.aa79b.model.ExpTareasResumen;
import com.ejie.aa79b.model.ExpedienteTradRev;
import com.ejie.aa79b.model.LimitePresupuesto;
import com.ejie.aa79b.model.Lotes;
import com.ejie.aa79b.model.MetadatosBusqueda;
import com.ejie.aa79b.model.PersonalIZO;
import com.ejie.aa79b.model.TareaIdaba;
import com.ejie.aa79b.model.TareaReflection;
import com.ejie.aa79b.model.TareaTrados;
import com.ejie.aa79b.model.Tareas;
import com.ejie.aa79b.model.TareasGestionInterpretacion;
import com.ejie.aa79b.model.TiposTarea;
import com.ejie.aa79b.model.enums.ActivoEnum;
import com.ejie.aa79b.model.enums.EstadoEjecucionTareaEnum;
import com.ejie.aa79b.model.enums.TipoTareaGestionAsociadaEnum;
import com.ejie.aa79b.webservices.P43jService;
import com.ejie.aa79b.webservices.PIDService;
import com.ejie.aa79b.webservices.p43j.P43JErrorType;
import com.ejie.aa79b.webservices.p43j.P43JFinalizacionIzoberriRespuestaType;
import com.ejie.aa79b.webservices.p43j.P43JListaErroresType;
import com.ejie.x38.dto.JQGridRequestDto;
import com.ejie.x38.dto.JQGridResponseDto;

/**
 * TareasGeneralServiceImpl generated by UDA, 28-nov-2017 15:23:30.
 * 
 * @author UDA
 */

@Service(value = "tareasGeneralService")
public class TareasGeneralServiceImpl implements TareasGeneralService {

	@Autowired()
	private CargaTrabajoDao cargaTrabajoDao;
	@Autowired
	private TareasGeneralDao tareasGeneralDao;
	@Autowired()
	private TareasDao tareasDao;
	@Autowired()
	private TareasGestionInterpretacionDao tareasGestion;
	@Autowired()
	private DatosTareaTradosDocsDao datosTareaTradosDocsDao;
	@Autowired()
	private DatosPagoProveedoresDao datosPagoProveedoresDao;
	@Autowired()
	private DatosTareaTradosMetadatosDao datosTareaTradosMetadatosDao;
	@Autowired()
	private TiposTareaService tiposTareasService;
	@Autowired()
	private DatosPagoProveedoresService datosPagoProveedoresService;

	@Autowired()
	private PIDService pidService;
	@Autowired()
	private Properties appConfiguration;
	@Autowired()
	private P43jService p43jService;

	private static final Logger LOGGER = LoggerFactory.getLogger(TareasGeneralServiceImpl.class);

	/****************************
	 * INICIO TIPO TAREA: CORREDACCION
	 *******************************************************/
	@Override
	public JQGridResponseDto<DocumentoTarea> filterCorredaccion(DocumentoTarea filterDocumentoTarea,
			JQGridRequestDto jqGridRequestDto, Boolean startsWith) {

		List<DocumentoTarea> listaT = this.tareasGeneralDao.findAllDocsTipoCorredaccion(filterDocumentoTarea,
				jqGridRequestDto, false);
		Long recordNum = this.tareasGeneralDao.findAllDocsTipoCorredaccionCount(filterDocumentoTarea, false);

		return new JQGridResponseDto<DocumentoTarea>(jqGridRequestDto, recordNum, listaT);
	}

	@Override
	public JQGridResponseDto<DocumentoTarea> filterCorredaccionXliff(DocumentoTarea filterDocumentoTarea,
			JQGridRequestDto jqGridRequestDto, Boolean startsWith) {

		List<DocumentoTarea> listaT = this.tareasGeneralDao.findAllDocsTipoCorredaccionXliff(filterDocumentoTarea,
				jqGridRequestDto, false);
		Long recordNum = this.tareasGeneralDao.findAllDocsTipoCorredaccionXliffCount(filterDocumentoTarea, false);

		return new JQGridResponseDto<DocumentoTarea>(jqGridRequestDto, recordNum, listaT);
	}

	@Override
	public DocumentoTarea findRegCorredaccion(DocumentoTarea filterDocumentoTarea) {

		return this.tareasGeneralDao.findRegCorredaccion(filterDocumentoTarea);
	}

	/**
	 * 
	 * @param tarea   Tarea
	 * @param request HttpServletRequest
	 */
	@Override
	public void finalizarTarea(Tareas tarea, HttpServletRequest request) {
		// Dependiente de la tarea -> Reflexión
		try {
			final TiposTarea tipoTarea = this.tiposTareasService.find(new TiposTarea(tarea.getTipoTarea().getId015()));

			final TareaReflection tareaReflection = new TareaReflection();
			tareaReflection.setRequest(request);
			tareaReflection.setTarea(tarea);

			final Class<?> c = Class.forName("com.ejie.aa79b.utils.FinalizarTareaUtils");
			Class<?>[] paramTypes = { TareaReflection.class };
			Object o = c.newInstance();
			Method method = null;
			if (Constants.SI.equals(tipoTarea.getIndGestionAsoc015())) {
				method = c.getDeclaredMethod("finalizarTarea" + tarea.getTipoTarea().getId015(), paramTypes);
			} else {
				method = c.getDeclaredMethod("finalizarTareaSinGestionAsociada", paramTypes);
			}
			method.invoke(o, tareaReflection);
		} catch (Exception e) {
			TareasGeneralServiceImpl.LOGGER.info("Información: No existe el método invocado por reflexión. ", e);
		}

	}

	/****************************
	 * INICIO TIPO TAREA: Sin Gestion Asociada
	 *******************************************************/

	@Override
	public TareaIdaba getTareasIdaba(Long idExpediente, BigDecimal idTarea, Long idTipoTarea, Long anyoExpediente) {
		return this.tareasGeneralDao.getTareasIdaba(idExpediente, idTarea, idTipoTarea, anyoExpediente);
	}

	/****************************
	 * INICIO TIPO TAREA: No Conformidad Cliente
	 *******************************************************/

	@Override
	public Tareas findTareaBasica(BigDecimal idTarea) {
		return this.tareasGeneralDao.findTareaBasica(idTarea);
	}

	@Override
	public TareasGestionInterpretacion findTareaInterpretacion(BigDecimal idTarea) {

		TareasGestionInterpretacion tareasGestionInterpretacion = this.tareasGestion.findTareaInterpretacion(idTarea);
		LimitePresupuesto limitePresupuesto = this.comprobarFechasPresupuesto(
				tareasGestionInterpretacion.getFechaLimite(), tareasGestionInterpretacion.getIndPresupuesto(),
				tareasGestionInterpretacion.getAnyo(), tareasGestionInterpretacion.getNumExp(),
				TipoTareaGestionAsociadaEnum.GESTION_INTERPRETACION.getValue());
		if (limitePresupuesto.getEsInformado()) {
			tareasGestionInterpretacion.setFechaLimite(limitePresupuesto.getFechaPropuesta());
			tareasGestionInterpretacion.setHoraLimite(limitePresupuesto.getHoraPropuesta());
			tareasGestionInterpretacion.setFechaLimiteSeleccionable(limitePresupuesto.getFechaLimite());
			tareasGestionInterpretacion.setHoraLimiteSeleccionable(limitePresupuesto.getHoraLimite());
		}
		return tareasGestionInterpretacion;
	}

	@Override
	public ExpTareasResumen findDatosPagoProveedor(BigDecimal idTarea) {
		ExpTareasResumen expTareasResumen = this.cargaTrabajoDao.findTarea(idTarea);

		DatosPagoProveedores datosPagoProveedoresFilter = new DatosPagoProveedores();
		datosPagoProveedoresFilter.setIdTarea(idTarea);
		DatosPagoProveedores datosPagoProveedores = this.datosPagoProveedoresService.find(datosPagoProveedoresFilter);

		expTareasResumen.getTarea().setDatosPagoProveedores(datosPagoProveedores);
		expTareasResumen.getTarea().setIndFacturacion(this.tareasGeneralDao.obtenerIndFactTareaTradRel(idTarea));

		Tareas tareaFilter = new Tareas();
		tareaFilter.setIdTarea(idTarea);
		tareaFilter.setAnyo(expTareasResumen.getAnyo());
		tareaFilter.setNumExp(expTareasResumen.getNumExp());

		TiposTarea tipoTareaFilter = new TiposTarea();
		tipoTareaFilter.setId015(expTareasResumen.getTarea().getTipoTarea().getId015());
		tareaFilter.setTipoTarea(tipoTareaFilter);

		List<DocumentosExpediente> docusList = this.tareasGeneralDao.findAllDocumentosTarea(tareaFilter, null, false);

		DatosTareaTrados datosTareaTrados = this.obtenerDatosTrados(tareaFilter);
		expTareasResumen.getTarea().setDatosTareaTrados(datosTareaTrados);
		expTareasResumen.setPalPresuspuesto(this.tareasGeneralDao.getPalPresupuesto());
		expTareasResumen.setPalTrados(this.tareasGeneralDao.getPalTrados());
		expTareasResumen.getTarea().getLotes().setIva(this.tareasGeneralDao.getIVA());

		if (!docusList.isEmpty()) {
			expTareasResumen.getTarea().setDocumentosExpediente(docusList);
		}
		return expTareasResumen;

	}

	@Override
	public void updateDatosPagoProveedor(DatosPagoProveedores datosPagoProveedores) {
		this.datosPagoProveedoresDao.update(datosPagoProveedores);

	}

	private DatosTareaTrados obtenerDatosTrados(Tareas tarea) {
		DatosTareaTrados datosTareaTrados = null;

		if (existeTareaTrados(tarea)) {
			Tareas tareaTrados = this.tareasDao.findTareaTrados(tarea.getAnyo(), tarea.getNumExp());

			if (tareaTrados != null) {
				if (EstadoEjecucionTareaEnum.EJECUTADA.getValue() == tareaTrados.getEstadoEjecucion()) {
					datosTareaTrados = tareasGeneralDao.findDatosTareaTradosEjecutada(tarea.getIdTarea(),
							tareaTrados.getIdTarea());
				}
				if (datosTareaTrados.getNumTotalPal() == 0) {
					datosTareaTrados = tareasGeneralDao.findDatosTareaTradosSinEjecutar(tarea.getIdTarea());
				}
			} else {
				datosTareaTrados = tareasGeneralDao.findDatosTareaTradosSinEjecutar(tarea.getIdTarea());
			}
		}

		return datosTareaTrados;
	}

	/**
	 * @param tarea
	 * @return
	 */
	private boolean existeTareaTrados(Tareas tarea) {
		return existenDatosTareaNulos(tarea)
				&& TipoTareaGestionAsociadaEnum.INTERPRETAR.getValue() != tarea.getTipoTarea().getId015();
	}

	/**
	 * @param tarea
	 * @return
	 */
	private boolean existenDatosTareaNulos(Tareas tarea) {
		return tarea != null && tarea.getTipoTarea() != null && tarea.getAnyo() != null && tarea.getNumExp() != null;
	}

	/****************************
	 * INICIO TIPO TAREA: TRADUCCION
	 *******************************************************/
	@Override
	public JQGridResponseDto<DocumentoTarea> filterTraduccion(DocumentoTarea filterDocumentoTarea,
			JQGridRequestDto jqGridRequestDto, boolean b) {
		List<DocumentoTarea> listaT = this.tareasGeneralDao.findAllDocsTipoTraduccion(filterDocumentoTarea,
				jqGridRequestDto, false);
		Long recordNum = this.tareasGeneralDao.findAllDocsTipoTraduccionCount(filterDocumentoTarea, false);

		return new JQGridResponseDto<DocumentoTarea>(jqGridRequestDto, recordNum, listaT);
	}

	@Override
	public DocumentoTarea findRegTraduccionRevision(DocumentoTarea filterDocumentoTarea) {
		return this.tareasGeneralDao.findRegTraduccionRevision(filterDocumentoTarea);
	}

	/****************************
	 * FIN TIPO TAREA: TRADUCCION
	 *******************************************************/

	@Override
	public Boolean validarDocumentosTareaFinalizar(BigDecimal idTarea, Long idTipoTarea) {
		Boolean valido = false;
		Integer count = this.tareasGeneralDao.validarDocumentosTareaFinalizar(idTarea, idTipoTarea);
		if (count == 0) {
			valido = true;
		}
		return valido;
	}

	@Override
	public Boolean validarDocumentosTareaFinalizarEntregaTrad(BigDecimal idTarea, Integer iFirmaNecesaria) {
		Boolean valido = false;
		Integer count = this.tareasGeneralDao.validarDocumentosTareaFinalizarEntregaTrad(idTarea, iFirmaNecesaria);
		if (count == 0) {
			valido = true;
		}
		return valido;
	}

	@Override
	public JQGridResponseDto<DocumentosExpediente> findDocumentosTarea(Tareas filterTareas,
			JQGridRequestDto jqGridRequestDto, boolean b) {
		List<DocumentosExpediente> listaT = this.tareasGeneralDao.findAllDocumentosTarea(filterTareas, jqGridRequestDto,
				false);
		Long recordNum = this.tareasGeneralDao.findAllDocumentosTareaCount(filterTareas, false);

		return new JQGridResponseDto<DocumentosExpediente>(jqGridRequestDto, recordNum, listaT);
	}

	/****************************
	 * INICIO TIPO TAREA: REVISION
	 *******************************************************/
	@Override
	public JQGridResponseDto<DocumentoTarea> filterRevision(DocumentoTarea filterDocumentoTarea,
			JQGridRequestDto jqGridRequestDto, boolean startsWith) {
		List<DocumentoTarea> listaT = this.tareasGeneralDao.findAllDocsTipoRevision(filterDocumentoTarea,
				jqGridRequestDto, false);
		Long recordNum = this.tareasGeneralDao.findAllDocsTipoRevisionCount(filterDocumentoTarea, false);

		return new JQGridResponseDto<DocumentoTarea>(jqGridRequestDto, recordNum, listaT);
	}

	/****************************
	 * FIN TIPO TAREA: REVISION
	 *******************************************************/

	@Override
	public DocumentoTarea findRegJustificante(DocumentoTarea filterDocumentoTarea) {
		return this.tareasGeneralDao.findRegJustificante(filterDocumentoTarea);
	}

	/****************************
	 * INICIO TIPO TAREA: TRADOS
	 *******************************************************/

	@Override
	public TareaTrados cargaInicialTareaTrados(Long anyoExp, Integer numExp, BigDecimal idTarea) {

		TareaTrados tareaTrados = this.tareasGeneralDao.cargaInicialTareaTrados(anyoExp, numExp, idTarea);
		LimitePresupuesto limitePresupuesto = this.comprobarFechasPresupuesto(tareaTrados.getFechaLimite(),
				tareaTrados.getIndPresupuesto(), anyoExp, numExp,
				TipoTareaGestionAsociadaEnum.PROYECTO_TRADOS.getValue());
		if (limitePresupuesto.getEsInformado()) {
			tareaTrados.setFechaLimite(limitePresupuesto.getFechaPropuesta());
			tareaTrados.setHoraLimite(limitePresupuesto.getHoraPropuesta());
			tareaTrados.setHoraLimiteSeleccionable(limitePresupuesto.getHoraLimite());
			tareaTrados.setFechaLimiteSeleccionable(limitePresupuesto.getFechaLimite());
		}

		if (tareaTrados.getDatosTareaTrados().getIdFicheroTrados() != null) {
			DatosTareaTradosDocs filterDocTareaTrados = new DatosTareaTradosDocs();
			filterDocTareaTrados.setIdTarea(idTarea);
			List<DatosTareaTradosDocs> listaDocs = this.datosTareaTradosDocsDao.getDocsTareaTrados(filterDocTareaTrados,
					null);
			tareaTrados.setlDocsTarea(listaDocs);
			List<MetadatosBusqueda> listaMetadatos = this.datosTareaTradosMetadatosDao.getMetadatosTareaTrados(anyoExp,
					numExp);
			tareaTrados.setlMetadatos(listaMetadatos);
		}
		return tareaTrados;
	}

	public LimitePresupuesto comprobarFechasPresupuesto(Date fechaLimite, String indPresupuesto, Long anyoExp,
			Integer numExp, int tipoTarea) {
		LimitePresupuesto fechasLimitePre = new LimitePresupuesto();
		fechasLimitePre.setEsInformado(false);
		// comprobar si fecha limite es nula y si ( es trados o si (es gestion
		// interpretacion y requiere
		// presupuesto))
		if (fechaLimite == null && (TipoTareaGestionAsociadaEnum.PROYECTO_TRADOS.getValue() == tipoTarea
				|| (TipoTareaGestionAsociadaEnum.GESTION_INTERPRETACION.getValue() == tipoTarea
						&& ActivoEnum.SI.getValue().equals(indPresupuesto)))) {
			fechasLimitePre = this.tareasGeneralDao.obtenerLimitePresupuesto(anyoExp, numExp);
			if (fechaLimite == null && TipoTareaGestionAsociadaEnum.PROYECTO_TRADOS.getValue() == tipoTarea
					&& ActivoEnum.NO.getValue().equals(indPresupuesto)) {
				// si estrados, no requiere presupuesto y no tiene fecha limite
				// guardada, no se propone ninguna fecha limite
				fechasLimitePre.setFechaPropuesta(null);
				fechasLimitePre.setHoraPropuesta(null);
			}
			fechasLimitePre.setEsInformado(true);
		}
		return fechasLimitePre;
	}

	/****************************
	 * FIN TIPO TAREA: TRADOS
	 *******************************************************/

	/****************************
	 * INICIO TIPO TAREA: REVISION TRADUCCION EXTERNA
	 *******************************************************/

	@Override()
	public JQGridResponseDto<Tareas> getDocsRevisionTraduccionExterna(DocumentoTarea filterDocumentoTarea,
			JQGridRequestDto jqGridRequestDto, boolean startsWith) {
		List<Tareas> listaT = this.tareasGeneralDao.findDocsRevisionTraduccionExterna(filterDocumentoTarea,
				jqGridRequestDto, false);
		Long recordNum = this.tareasGeneralDao.findDocsRevisionTraduccionExternaCount(filterDocumentoTarea, false);

		return new JQGridResponseDto<Tareas>(jqGridRequestDto, recordNum, listaT);
	}

	@Override()
	public Lotes cargarDatosLoteAsignado(Tareas tarea) {
		return this.tareasGeneralDao.cargarDatosLoteAsignado(tarea);
	}

	@Override()
	public DatosPagoProveedores cargarDatosDePagoAProveedorAsignado(Tareas tarea) {
		return this.tareasGeneralDao.cargarDatosDePagoAProveedorAsignado(tarea);
	}

	@Override()
	public Lotes cargarDatosLoteAsignadoRevisionExterna(Tareas tarea) {
		return this.tareasGeneralDao.cargarDatosLoteAsignadoRevisionExterna(tarea);
	}

	@Override()
	public DatosPagoProveedores cargarDatosDePagoAProveedorAsignadoRevisionExterna(Tareas tarea) {
		return this.tareasGeneralDao.cargarDatosDePagoAProveedorAsignadoRevisionExterna(tarea);
	}

	/****************************
	 * FIN TIPO TAREA: REVISION TRADUCCION EXTERNA
	 *******************************************************/

	/****************************
	 * INICIO TIPO TAREA: REVISION CON ENTREGA A CLIENTE
	 *******************************************************/

	@Override
	public JQGridResponseDto<Tareas> getDocsRevisionEntregaCliente(DocumentoTarea filterDocumentoTarea,
			JQGridRequestDto jqGridRequestDto, boolean startsWith) {
		List<Tareas> listaT = this.tareasGeneralDao.findDocsRevisionEntregaCliente(filterDocumentoTarea,
				jqGridRequestDto, false);
		Long recordNum = this.tareasGeneralDao.findDocsRevisionEntregaClienteCount(filterDocumentoTarea, false);

		return new JQGridResponseDto<Tareas>(jqGridRequestDto, recordNum, listaT);
	}

	@Override
	public JQGridResponseDto<Tareas> getDocsRevisadosEntregaClte(Tareas filterTareas, JQGridRequestDto jqGridRequestDto,
			boolean startsWith) {
		List<Tareas> listaT = this.tareasGeneralDao.findDocsRevisadosEntregaClte(filterTareas, jqGridRequestDto, false);
		Long recordNum = this.tareasGeneralDao.findDocsRevisadosEntregaClteCount(filterTareas, false);

		return new JQGridResponseDto<Tareas>(jqGridRequestDto, recordNum, listaT);
	}

	@Override
	public JQGridResponseDto<Tareas> getDocsTraducidosEntregaClte(Tareas filterTareas,
			JQGridRequestDto jqGridRequestDto, boolean startsWith) {
		List<Tareas> listaT = this.tareasGeneralDao.findDocsTraducidosEntregaClte(filterTareas, jqGridRequestDto,
				false);
		Long recordNum = this.tareasGeneralDao.findDocsTraducidosEntregaClteCount(filterTareas, false);

		return new JQGridResponseDto<Tareas>(jqGridRequestDto, recordNum, listaT);
	}

	@Override
	public JQGridResponseDto<DocumentoTarea> filterEntregaClteTradXliff(DocumentoTarea filterDocumentoTarea,
			JQGridRequestDto jqGridRequestDto, Boolean startsWith) {

		List<DocumentoTarea> listaT = this.tareasGeneralDao.findAllDocsEntregaClteTradXliff(filterDocumentoTarea,
				jqGridRequestDto, false);
		Long recordNum = this.tareasGeneralDao.findAllDocsEntregaClteTradXliffCount(filterDocumentoTarea, false);

		return new JQGridResponseDto<DocumentoTarea>(jqGridRequestDto, recordNum, listaT);
	}

	@Override
	public List<Tareas> findDocsRevisionEntregaCliente(DocumentoTarea filterDocumentoTarea,
			JQGridRequestDto jqGridRequestDto, boolean startsWith) {
		return this.tareasGeneralDao.findDocsRevisionEntregaCliente(filterDocumentoTarea, jqGridRequestDto, false);
	}

	@Override
	public List<Tareas> findDocsTraduccionEntregaCliente(DocumentoTarea filterDocumentoTarea,
			JQGridRequestDto jqGridRequestDto, boolean startsWith) {
		return this.tareasGeneralDao.findDocsTraduccionEntregaCliente(filterDocumentoTarea, jqGridRequestDto, false);
	}

	@Override
	public ExpedienteTradRev findDatosExpFinIzoberri(BigDecimal idTarea) {
		return this.tareasGeneralDao.findDatosExpFinIzoberri(idTarea);
	}

	/**
	 * compara los archivos del zip original con los del final firmado...
	 */
	@Override
	public Boolean comprobarFirmaDocumentosTareaEntrega(List<Tareas> listaDocs) throws Exception {
		Boolean correcto = true;
		int errcount = 0;

		for (Tareas unaFilaDocTarea : listaDocs) {

			Set<String> archivosOriginal = new LinkedHashSet<String>();
			Set<String> archivosFinal = new LinkedHashSet<String>();

			// Si no es ZIP no se hace nada
			if (Constants.ZIP.equalsIgnoreCase(
					unaFilaDocTarea.getDocumentoTarea().getDocumentoOriginal().getFicheros().get(0).getExtension())) {

				// ORIGINAL
				String oidOriginal = unaFilaDocTarea.getDocumentoTarea().getDocumentoOriginal().getFicheros().get(0)
						.getOid();
				ZipInputStream zipStream = new ZipInputStream(
						new ByteArrayInputStream(this.pidService.getDocument(oidOriginal)));
				ZipEntry entry = null;
				while ((entry = zipStream.getNextEntry()) != null) {
					archivosOriginal.add((String) entry.getName().toLowerCase());
					zipStream.closeEntry();
				}
				zipStream.close();

				// FINAL FIRMADO
				String oidFinal = unaFilaDocTarea.getDocumentoTarea().getDocumentoFinalFirmado().getOid();
				ZipInputStream zipStream2 = new ZipInputStream(
						new ByteArrayInputStream(this.pidService.getDocument(oidFinal)));
				ZipEntry entry2 = null;
				while ((entry2 = zipStream2.getNextEntry()) != null) {
					archivosFinal.add((String) entry2.getName().toLowerCase());
					zipStream2.closeEntry();
				}
				zipStream2.close();

				// COMPARACIÓN DE NOMBRES DE FICHEROS
				errcount += compararSetsFicherosZIP(errcount, archivosOriginal, archivosFinal);
				if (errcount > 0) {
					TareasGeneralServiceImpl.LOGGER.info(errcount + " archivos NO coinciden");
					correcto = false;
				}
			}
		}
		return correcto;
	}

	@Override
	public String comprobarWSIzoberri(ExpedienteTradRev expedienteTradRev, List<Tareas> listaDocs) throws Exception {
		StringBuilder errores = new StringBuilder();
		for (Tareas unaFilaDocTarea : listaDocs) {

			String oidDocFinalFirmado = unaFilaDocTarea.getDocumentoTarea().getDocumentoFinalFirmado().getOid();
			byte[] documentoPrueba = this.pidService.getDocument(oidDocFinalFirmado);
			String propiedadRutaPif = this.appConfiguration.getProperty("rutaPifP43j");
			String rutaPifP43j = this.pidService.subidaPifP43j(
					unaFilaDocTarea.getDocumentoTarea().getDocumentoFinalFirmado().getNombre(), documentoPrueba,
					propiedadRutaPif);

			P43JFinalizacionIzoberriRespuestaType respuestaIzo;

			// LLAMADA REAL
			// ..........................................................................
			respuestaIzo = this.p43jService.llamadaWSBoletinP43(
					Long.toString(expedienteTradRev.getAnyo()) + "/" + Long.toString(expedienteTradRev.getNumExp()),
					expedienteTradRev.getRefTramitagune(), rutaPifP43j);

			TareasGeneralServiceImpl.LOGGER.info("XpeIzo: " + respuestaIzo.getExpeIzo() + " | ExpeApli: "
					+ respuestaIzo.getExpeApli() + " >>> : " + respuestaIzo.getValorResultado());

			if (!Constants.STRING_CERO.equals(respuestaIzo.getValorResultado())) {

				// CONTROL DE ERRORES ............................
				String erroresP43J = "";
				P43JListaErroresType p43JListaErroresType = respuestaIzo.getListaErrores();
				if (p43JListaErroresType != null && p43JListaErroresType.getError() != null) {
					List<P43JErrorType> listaErr = p43JListaErroresType.getError();
					if (!listaErr.isEmpty()) {
						if (comprobarErrorYaEnviado(listaErr)) {
							errores.append("1");
						} else {
							erroresP43J = volcarErrores(erroresP43J, listaErr);
							errores.append(erroresP43J);
							TareasGeneralServiceImpl.LOGGER.info("erroresP43J: " + erroresP43J);
						}
					}
				}
			} else {
				errores.append("0");
				TareasGeneralServiceImpl.LOGGER.info("Envio a P43J CORRECTO");
			}
		}
		return errores.toString();
	}

	/**
	 * @param erroresP43J
	 * @param listaErr
	 * @return
	 */
	private String volcarErrores(String erroresP43J, List<P43JErrorType> listaErr) {
		String erroresTmp = erroresP43J;
		for (P43JErrorType error : listaErr) {
			erroresTmp += " Error: " + error.getErrorTipo();
			erroresTmp += " - " + error.getErrorTexto();
		}
		// escapamos la comilla simple en el texto del error, para
		// que no casque javascript
		erroresTmp = erroresTmp.replaceAll("'", "\\\\'");
		return erroresTmp;
	}

	/**
	 * @param erroresP43J
	 * @param listaErr
	 * @return
	 */
	private boolean comprobarErrorYaEnviado(List<P43JErrorType> listaErr) {
		for (P43JErrorType error : listaErr) {
			if (Constants.COD_ERROR_IZOBERRI_YA_ENVIADO.equals(error.getErrorTipo())) {
				return true;
			}
		}
		return false;
	}

	/**
	 * @param errcount
	 * @param archivosOriginal
	 * @param archivosFinal
	 * @return
	 */
	private int compararSetsFicherosZIP(int errcount, Set<String> archivosOriginal, Set<String> archivosFinal) {
		int errcountParcial = errcount;
		String nombre;
		String nombreSinExtension;
		for (Iterator<String> i = archivosOriginal.iterator(); i.hasNext();) {
			nombre = (String) i.next();
			if (!archivosFinal.contains(nombre)) {
				TareasGeneralServiceImpl.LOGGER.info("No existe archivo en ZIP final: " + nombre);
				errcountParcial += 1;
			}
		}

		for (Iterator<String> i = archivosFinal.iterator(); i.hasNext();) {
			nombre = (String) i.next();
			nombreSinExtension = nombre.substring(0, nombre.lastIndexOf("."));

			if ((!Constants.FIRMA_EXTENSION
					.equalsIgnoreCase(nombre.substring(nombre.lastIndexOf(".") + 1, nombre.length())))
					&& (!archivosFinal.contains(nombreSinExtension + "." + Constants.FIRMA_EXTENSION))) {
				TareasGeneralServiceImpl.LOGGER.info("No existe archivo de firma de: " + nombre);
				errcountParcial += 1;

			}

		}
		return errcountParcial;
	}

	/****************************
	 * FIN TIPO TAREA: REVISION CON ENTREGA A CLIENTE
	 *******************************************************/

	@Override()
	public List<DocumentoTarea> findDocsDetalleTarea(BigDecimal idTarea, String idioma) {
		return this.tareasGeneralDao.findDocsDetalleTarea(idTarea, idioma);
	}

	@Override
	public DatosTareaTrados findDatosTareaTradosEjecutada(BigDecimal idTarea, BigDecimal idTareaTrados) {
		return this.tareasGeneralDao.findDatosTareaTradosEjecutada(idTarea, idTareaTrados);
	}

	@Override
	public DatosTareaTrados findDatosTareaTradosSinEjecutar(BigDecimal idTarea) {
		return this.tareasGeneralDao.findDatosTareaTradosSinEjecutar(idTarea);
	}

	@Override
	public List<PersonalIZO> findPersonasPorRecursoAsignacion(Tareas tarea, String idTipoExp) {
		return this.tareasGeneralDao.findPersonasPorRecursoAsignacion(tarea, idTipoExp);
	}

	@Override
	public List<PersonalIZO> findProveedoresPorRecursoAsignacion(Tareas tarea, String idTipoExp) {
		return this.tareasGeneralDao.findProveedoresPorRecursoAsignacion(tarea, idTipoExp);
	}

	@Override
	public JQGridResponseDto<DocumentoTarea> filterTraduccionEntregaCliente(DocumentoTarea filterDocumentoTarea,
			JQGridRequestDto jqGridRequestDto, Boolean startsWith) {
		List<DocumentoTarea> listaT = this.tareasGeneralDao
				.findAllDocsTipoTraduccionEntregaCliente(filterDocumentoTarea, jqGridRequestDto, false);
		Long recordNum = this.tareasGeneralDao.findAllDocsTipoTraduccionEntregaClienteCount(filterDocumentoTarea,
				false);

		return new JQGridResponseDto<DocumentoTarea>(jqGridRequestDto, recordNum, listaT);
	}

	@Override
	public JQGridResponseDto<DocumentoTarea> getDocumentosRevTradExtXliff(DocumentoTarea filterDocumentoTarea,
			JQGridRequestDto jqGridRequestDto, Boolean startsWith) {
		List<DocumentoTarea> listaT = this.tareasGeneralDao.findAllRevTradExtTradXliff(filterDocumentoTarea,
				jqGridRequestDto, false);
		Long recordNum = this.tareasGeneralDao.findAllDocsRevTradExtXliffCount(filterDocumentoTarea, false);

		return new JQGridResponseDto<DocumentoTarea>(jqGridRequestDto, recordNum, listaT);
	}

	@Override
	public Integer crearTareasExpediente(Long anyo, Integer numExp, String nif) {
		return this.tareasGeneralDao.crearTareasExpediente(anyo, numExp, nif);
	}

	@Override
	public JQGridResponseDto<DocumentoTarea> filterTraduccionXliff(DocumentoTarea filterDocumentoTarea,
			JQGridRequestDto jqGridRequestDto, boolean startsWith) {
		List<DocumentoTarea> listaT = this.tareasGeneralDao.findAllDocsTraduccionXliff(filterDocumentoTarea,
				jqGridRequestDto, false);
		Long recordNum = this.tareasGeneralDao.findAllDocsTraduccionXliffCount(filterDocumentoTarea, false);

		return new JQGridResponseDto<DocumentoTarea>(jqGridRequestDto, recordNum, listaT);
	}

	@Override
	public JQGridResponseDto<DocumentoTarea> filterNoConformidadProveedorTrad(DocumentoTarea filterDocumentoTarea,
			JQGridRequestDto jqGridRequestDto, boolean startsWith) {
		List<DocumentoTarea> listaT = this.tareasGeneralDao.findAllDocsNoConformidadProveedorTrad(filterDocumentoTarea,
				jqGridRequestDto, false);
		Long recordNum = this.tareasGeneralDao.findAllDocsNoConformidadProveedorTradCount(filterDocumentoTarea, false);

		return new JQGridResponseDto<DocumentoTarea>(jqGridRequestDto, recordNum, listaT);
	}

	@Override
	public JQGridResponseDto<DocumentoTarea> filterXliffNoConformidadProveedorTrad(DocumentoTarea filterDocumentoTarea,
			JQGridRequestDto jqGridRequestDto, boolean startsWith) {
		List<DocumentoTarea> listaT = this.tareasGeneralDao
				.findAllDocsXliffNoConformidadProveedorTrad(filterDocumentoTarea, jqGridRequestDto, false);
		Long recordNum = this.tareasGeneralDao.findAllDocsXliffNoConformidadProveedorTradCount(filterDocumentoTarea,
				false);

		return new JQGridResponseDto<DocumentoTarea>(jqGridRequestDto, recordNum, listaT);
	}

	@Override
	public JQGridResponseDto<DocumentoTarea> filterNoConformidadProveedorRev(DocumentoTarea filterDocumentoTarea,
			JQGridRequestDto jqGridRequestDto, boolean startsWith) {
		List<DocumentoTarea> listaT = this.tareasGeneralDao.findAllDocsNoConformidadProveedorRev(filterDocumentoTarea,
				jqGridRequestDto, false);
		Long recordNum = this.tareasGeneralDao.findAllDocsNoConformidadProveedorRevCount(filterDocumentoTarea, false);

		return new JQGridResponseDto<DocumentoTarea>(jqGridRequestDto, recordNum, listaT);
	}

	@Override
	public JQGridResponseDto<Tareas> getDocsRevisionTraduccionInterna(DocumentoTarea filterDocumentoTarea,
			JQGridRequestDto jqGridRequestDto, boolean startsWith) {
		List<Tareas> listaT = this.tareasGeneralDao.findDocsRevisionTraduccionInterna(filterDocumentoTarea,
				jqGridRequestDto, false);
		Long recordNum = this.tareasGeneralDao.findDocsRevisionTraduccionInternaCount(filterDocumentoTarea, false);

		return new JQGridResponseDto<Tareas>(jqGridRequestDto, recordNum, listaT);
	}

	@Override
	public JQGridResponseDto<DocumentoTarea> getDocumentosRevTradIntXliff(DocumentoTarea filterDocumentoTarea,
			JQGridRequestDto jqGridRequestDto, boolean startsWith) {
		List<DocumentoTarea> listaT = this.tareasGeneralDao.findAllRevTradIntTradXliff(filterDocumentoTarea,
				jqGridRequestDto, false);
		Long recordNum = this.tareasGeneralDao.findAllDocsRevTradIntXliffCount(filterDocumentoTarea, false);

		return new JQGridResponseDto<DocumentoTarea>(jqGridRequestDto, recordNum, listaT);
	}

	@Override
	public JQGridResponseDto<DocumentoTarea> filterNoConformidadTraductor(DocumentoTarea filterDocumentoTarea,
			JQGridRequestDto jqGridRequestDto, boolean startsWith) {
		List<DocumentoTarea> listaT = this.tareasGeneralDao.findAllNoConformidadTraductor(filterDocumentoTarea,
				jqGridRequestDto, false);
		Long recordNum = this.tareasGeneralDao.findAllNoConformidadTraductorCount(filterDocumentoTarea, false);

		return new JQGridResponseDto<DocumentoTarea>(jqGridRequestDto, recordNum, listaT);
	}

}