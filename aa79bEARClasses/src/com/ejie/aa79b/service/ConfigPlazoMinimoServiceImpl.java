package com.ejie.aa79b.service;

import java.util.LinkedHashMap;
import java.util.Locale;
import java.util.Map;

import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.support.ReloadableResourceBundleMessageSource;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.dao.ConfigPlazoMinimoDao;
import com.ejie.aa79b.dao.GenericoDao;
import com.ejie.aa79b.dao.RegistroAccionesDao;
import com.ejie.aa79b.model.ConfigPlazoMinimo;
import com.ejie.aa79b.model.DatosBasicos;
import com.ejie.aa79b.model.RegistroAcciones;
import com.ejie.aa79b.utils.Utils;

/**
 * ConfigPlazoMinimoServiceImpl generated by UDA, 05-dic-2017 15:17:18.
 * 
 * @author UDA
 */

@Service(value = "configPlazoMinimoService")
public class ConfigPlazoMinimoServiceImpl extends GenericoServiceImpl<ConfigPlazoMinimo>
		implements ConfigPlazoMinimoService {

	@Autowired()
	private ConfigPlazoMinimoDao configPlazoMinimoDao;
	@Autowired()
	private RegistroAccionesDao registroAccionesDao;
	@Autowired()
	private ReloadableResourceBundleMessageSource msg;

	@Override
	protected GenericoDao<ConfigPlazoMinimo> getDao() {
		return this.configPlazoMinimoDao;
	}

	@Override()
	@Transactional(rollbackFor = Throwable.class)
	public DatosBasicos update(DatosBasicos datosBasicos) {
		ConfigPlazoMinimo normal = this.configPlazoMinimoDao.find(datosBasicos.getUsuarioNormal());
		ConfigPlazoMinimo vip = this.configPlazoMinimoDao.find(datosBasicos.getUsuarioVIP());

		this.configPlazoMinimoDao.update(datosBasicos.getUsuarioNormal());
		this.configPlazoMinimoDao.update(datosBasicos.getUsuarioVIP());

		Boolean insertar = false;
		RegistroAcciones reg = new RegistroAcciones();
		reg.setIdPuntoMenu(Constants.PUNTO_MENU_DATOS_BASICOS);
		reg.setIdAccion(Constants.ACCION_MODIFICACION);
		Map<String, String> parametros = new LinkedHashMap<String, String>();
		parametros.put("palabrasTradHora", "label.palabrasTradHora");
		parametros.put("palabrasRevHora", "label.palabrasRevHora");
		parametros.put("horasGestionTrad", "label.horasGestionTrad");
		parametros.put("horasGestionRev", "label.horasGestionRev");
		parametros.put("horasEmisionPresupuesto", "label.horasEmisionPresupuesto");
		parametros.put("horasAceptPresupuesto", "label.horasAceptPresupuesto");
		Locale locale = new Locale(Constants.LANG_EUSKERA);
		StringBuilder observ = new StringBuilder();
		observ.append(this.msg.getMessage("label.calculoPlazoMinimoRequerido", null, locale)).append("\n");
		String observNormal = Utils.observacionesRegistro(datosBasicos.getUsuarioNormal(), normal, parametros, this.msg,
				locale);
		if (StringUtils.isNotBlank(observNormal)) {
			observ.append(this.msg.getMessage("label.usuarioNormal", null, locale)).append("\n");
			observ.append(observNormal);
			insertar = true;
		}
		String observVIP = Utils.observacionesRegistro(datosBasicos.getUsuarioVIP(), vip, parametros, this.msg, locale);
		if (StringUtils.isNotBlank(observVIP)) {
			observ.append(this.msg.getMessage("label.usuarioVIP", null, locale)).append("\n");
			observ.append(observVIP);
			insertar = true;
		}
		reg.setObserv(observ.toString());
		if (insertar) {
			this.registroAccionesDao.add(reg);
		}
		return datosBasicos;
	}

}
