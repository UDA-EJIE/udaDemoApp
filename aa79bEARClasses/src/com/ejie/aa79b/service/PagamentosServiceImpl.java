package com.ejie.aa79b.service;

import java.math.BigDecimal;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.dao.GenericoDao;
import com.ejie.aa79b.dao.LotesDao;
import com.ejie.aa79b.dao.PagamentosDao;
import com.ejie.aa79b.model.Albaran;
import com.ejie.aa79b.model.DatosPagoProveedores;
import com.ejie.aa79b.model.Pagamentos;
import com.ejie.x38.dto.JQGridRequestDto;
import com.ejie.x38.dto.JQGridResponseDto;
import com.ejie.x38.dto.TableRowDto;

/**
 * PagamentosServiceImpl generated by UDA, 19/out/2018 10:01:21.
 * 
 * @author UDA
 */

@Service(value = "PagamentosService")
public class PagamentosServiceImpl extends GenericoServiceImpl<Pagamentos> implements PagamentosService {

	@Autowired
	private PagamentosDao pagamentosDao;
	@Autowired
	private LotesDao lotesDao;

	@Override
	protected GenericoDao<Pagamentos> getDao() {
		return this.pagamentosDao;
	}

	@Override
	public List<DatosPagoProveedores> getTareasExcelDetalle(Pagamentos filterPagamentos) {
		return (List<DatosPagoProveedores>) this.pagamentosDao.getTareasExcelDetalle(filterPagamentos);
	}

	@Override
	public boolean updateEstado(BigDecimal idAlb, Integer idEstado) {
		return (Boolean) this.pagamentosDao.updateEstado(idAlb, idEstado);
	}

	@Override
	public boolean updateInfoAlbaran(BigDecimal idAlb, String referencia, BigDecimal valor, Integer idLote) {
		// Actualizo el estado, factura e importe del albarán
		boolean rdo = this.pagamentosDao.updateInfoAlbaran(idAlb, referencia, valor);
		if (rdo) {
			// Marcar como pagadas las tareas del albarán
			this.pagamentosDao.updateIndPagadoTareasAlbaran(idAlb, Constants.SI);
			this.lotesDao.actualizaImporteConsumido(idLote, valor);
		}
		return rdo;
	}

	@Override
	public JQGridResponseDto<DatosPagoProveedores> getTareasAlbaran(Pagamentos filterPagamentos,
			JQGridRequestDto jqGridRequestDto, boolean b) {

		@SuppressWarnings("unchecked")
		List<DatosPagoProveedores> lista = (List<DatosPagoProveedores>) this.pagamentosDao
				.getTareasAlbaran(filterPagamentos, jqGridRequestDto, false, false);

		Long recordNum = 0L;

		if (lista != null && !lista.isEmpty()) {
			recordNum = (Long) this.pagamentosDao.getTareasAlbaran(filterPagamentos, jqGridRequestDto, false, true);
		}

		if (jqGridRequestDto != null) {
			return new JQGridResponseDto<DatosPagoProveedores>(jqGridRequestDto, recordNum, lista);
		} else {
			return new JQGridResponseDto<DatosPagoProveedores>(new JQGridRequestDto(), recordNum, lista);
		}
	}

	@Override
	public List<Albaran> getAlbaranesLote(Integer idLote, Integer tipo) {
		return this.pagamentosDao.getAlbaranesLote(idLote, tipo);
	}

	@Override
	public JQGridResponseDto<Pagamentos> filter(Pagamentos filter, JQGridRequestDto jqGridRequestDto,
			Boolean startsWith) {
		List<Pagamentos> listaT = this.getDao().findAllLike(filter, jqGridRequestDto, false);

		Long recordNum = this.pagamentosDao.findAllLikeCountPropio(filter, false);

		if (jqGridRequestDto.getMultiselection().getSelectedIds() != null) {
			List<TableRowDto<Pagamentos>> reorderSelection = this.getDao().reorderSelection(filter, jqGridRequestDto,
					startsWith);
			return new JQGridResponseDto<Pagamentos>(jqGridRequestDto, recordNum, listaT, reorderSelection);
		}
		return new JQGridResponseDto<Pagamentos>(jqGridRequestDto, recordNum, listaT);
	}

}
