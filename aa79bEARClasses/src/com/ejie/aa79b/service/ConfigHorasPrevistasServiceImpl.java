package com.ejie.aa79b.service;

import java.util.LinkedHashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;

import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.support.ReloadableResourceBundleMessageSource;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.dao.ConfigHorasPrevistasDao;
import com.ejie.aa79b.dao.ConfigHorasPrevistasProveedorExtDao;
import com.ejie.aa79b.dao.GenericoDao;
import com.ejie.aa79b.dao.LimitePalConcorDao;
import com.ejie.aa79b.dao.LimitePalConcorProvExtDao;
import com.ejie.aa79b.dao.RegistroAccionesDao;
import com.ejie.aa79b.model.ConfigHorasPrevistas;
import com.ejie.aa79b.model.ConfigHorasPrevistasProveedorExt;
import com.ejie.aa79b.model.LimitePalConcor;
import com.ejie.aa79b.model.RegistroAcciones;
import com.ejie.aa79b.utils.Utils;
import com.ejie.x38.dto.JQGridRequestDto;
import com.ejie.x38.dto.JQGridResponseDto;

/**
 * ConfigHorasPrevistasServiceImpl generated by UDA, 05-dic-2017 15:17:18.
 * 
 * @author UDA
 */

@Service(value = "configHorasPrevistasService")
public class ConfigHorasPrevistasServiceImpl extends GenericoServiceImpl<ConfigHorasPrevistas>
		implements ConfigHorasPrevistasService {

	@Autowired()
	private ConfigHorasPrevistasDao configHorasPrevistasDao;
	@Autowired()
	private ConfigHorasPrevistasProveedorExtDao configHorasPrevistasProveedorExtDao;
	@Autowired()
	private LimitePalConcorDao limitePalConcorDao;
	@Autowired()
	private LimitePalConcorProvExtDao limitePalConcorProvExtDao;
	@Autowired()
	private RegistroAccionesDao registroAccionesDao;
	@Autowired()
	private ReloadableResourceBundleMessageSource msg;

	@Override
	protected GenericoDao<ConfigHorasPrevistas> getDao() {
		return this.configHorasPrevistasDao;
	}

	@Override()
	@Transactional(rollbackFor = Throwable.class)
	public ConfigHorasPrevistas update(ConfigHorasPrevistas bean) {
		ConfigHorasPrevistas original = this.configHorasPrevistasDao.find(bean);

		if (this.configHorasPrevistasDao.isConfigHorasPrevistasAlreadyStored(bean) > 0) {
			this.configHorasPrevistasDao.update(bean);
		} else {
			this.configHorasPrevistasDao.add(bean);
		}

		RegistroAcciones regHorasPrevistas = new RegistroAcciones();
		regHorasPrevistas.setIdPuntoMenu(Constants.PUNTO_MENU_DATOS_BASICOS);
		regHorasPrevistas.setIdAccion(Constants.ACCION_MODIFICACION);
		Map<String, String> paramHorasPrevistas = new LinkedHashMap<String, String>();
		paramHorasPrevistas.put("palTradHora", "label.palTradHora");
		paramHorasPrevistas.put("limPalConcor", "label.limPalConcor");
		paramHorasPrevistas.put("palHoraConcor95100", "label.palHoraConcor95100");
		paramHorasPrevistas.put("palHoraConcor8594", "label.palHoraConcor8594");
		paramHorasPrevistas.put("palHoraConcor084", "label.palHoraConcor084");
		paramHorasPrevistas.put("palRevHora", "label.palRevHora");
		Locale locale = new Locale(Constants.LANG_EUSKERA);
		String aux = Utils.observacionesRegistro(bean, original, paramHorasPrevistas, this.msg, locale);
		if (StringUtils.isNotBlank(aux)) {
			StringBuilder observ = new StringBuilder();
			observ.append(this.msg.getMessage("label.calculoHorasPrevistas", null, locale)).append("\n");
			observ.append(aux);
			regHorasPrevistas.setObserv(observ.toString());
			this.registroAccionesDao.add(regHorasPrevistas);
		}
		return bean;
	}

	@Override
	public JQGridResponseDto<ConfigHorasPrevistas> datosBasicosFilter(ConfigHorasPrevistas filterConfigHorasPrevistas,
			JQGridRequestDto jqGridRequestDto, boolean startsWith) {
		@SuppressWarnings("unchecked")
		List<ConfigHorasPrevistas> listaConfigHorasPrevistas = (List<ConfigHorasPrevistas>) this.configHorasPrevistasDao
				.datosBasicosFilter(filterConfigHorasPrevistas, jqGridRequestDto, false, false);

		Long recordNum = 0L;

		if (listaConfigHorasPrevistas != null && !listaConfigHorasPrevistas.isEmpty()) {
			recordNum = (Long) this.configHorasPrevistasDao.datosBasicosFilter(filterConfigHorasPrevistas,
					jqGridRequestDto, false, true);
		}

		if (jqGridRequestDto != null) {
			return new JQGridResponseDto<ConfigHorasPrevistas>(jqGridRequestDto, recordNum, listaConfigHorasPrevistas);
		} else {
			return new JQGridResponseDto<ConfigHorasPrevistas>(new JQGridRequestDto(), recordNum,
					listaConfigHorasPrevistas);
		}
	}

	@Override
	@Transactional(rollbackFor = Throwable.class)
	public Integer editHorasPrevistas(LimitePalConcor limitePalConcor, List<ConfigHorasPrevistas> listaConfigHoras) {
		Integer resul = 0;
		if (this.limitePalConcorDao.isLimPalConcorStored(limitePalConcor)) {
			resul = this.limitePalConcorDao.updateLimPalConcor(limitePalConcor);
		} else {
			resul = this.limitePalConcorDao.addLimPalConcor(limitePalConcor);
		}
		for (ConfigHorasPrevistas configHorasPrevista : listaConfigHoras) {
			if (this.configHorasPrevistasDao.isConfigHorasPrevistasAlreadyStored(configHorasPrevista) > 0) {
				this.configHorasPrevistasDao.update(configHorasPrevista);
				resul++;
			} else {
				this.configHorasPrevistasDao.add(configHorasPrevista);
				resul++;
			}
		}
		return resul;
	}

	@Override
	public JQGridResponseDto<ConfigHorasPrevistasProveedorExt> provExtDatosBasicosFilter(
			ConfigHorasPrevistasProveedorExt filterConfigHorasPrevistas, JQGridRequestDto jqGridRequestDto, boolean b) {
		@SuppressWarnings("unchecked")
		List<ConfigHorasPrevistasProveedorExt> listaConfigHorasPrevistas = (List<ConfigHorasPrevistasProveedorExt>) this.configHorasPrevistasProveedorExtDao
				.datosBasicosFilter(filterConfigHorasPrevistas, jqGridRequestDto, false, false);

		Long recordNum = 0L;

		if (listaConfigHorasPrevistas != null && !listaConfigHorasPrevistas.isEmpty()) {
			recordNum = (Long) this.configHorasPrevistasProveedorExtDao.datosBasicosFilter(filterConfigHorasPrevistas,
					jqGridRequestDto, false, true);
		}

		if (jqGridRequestDto != null) {
			return new JQGridResponseDto<ConfigHorasPrevistasProveedorExt>(jqGridRequestDto, recordNum,
					listaConfigHorasPrevistas);
		} else {
			return new JQGridResponseDto<ConfigHorasPrevistasProveedorExt>(new JQGridRequestDto(), recordNum,
					listaConfigHorasPrevistas);
		}
	}

	@Override
	@Transactional(rollbackFor = Throwable.class)
	public Integer editHorasPrevistasProveedorExterno(LimitePalConcor limitePalConcor,
			List<ConfigHorasPrevistasProveedorExt> listaConfigHoras) {
		Integer resul = 0;
		if (this.limitePalConcorProvExtDao.isLimPalConcorStored(limitePalConcor)) {
			resul = this.limitePalConcorProvExtDao.updateLimPalConcor(limitePalConcor);
		} else {
			resul = this.limitePalConcorProvExtDao.addLimPalConcor(limitePalConcor);
		}
		for (ConfigHorasPrevistasProveedorExt configHorasPrevista : listaConfigHoras) {
			if (this.configHorasPrevistasProveedorExtDao.isConfigHorasPrevistasAlreadyStored(configHorasPrevista) > 0) {
				this.configHorasPrevistasProveedorExtDao.update(configHorasPrevista);
				resul++;
			} else {
				this.configHorasPrevistasProveedorExtDao.add(configHorasPrevista);
				resul++;
			}
		}
		return resul;
	}

}
