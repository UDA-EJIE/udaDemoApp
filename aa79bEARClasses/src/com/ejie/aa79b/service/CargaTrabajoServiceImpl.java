package com.ejie.aa79b.service;

import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import java.util.Locale;

import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.dao.CargaTrabajoDao;
import com.ejie.aa79b.dao.ExpedienteDao;
import com.ejie.aa79b.dao.GenericoDao;
import com.ejie.aa79b.dao.TareasDao;
import com.ejie.aa79b.dao.TareasGeneralDao;
import com.ejie.aa79b.dao.TareasTrabajoDao;
import com.ejie.aa79b.model.DocumentoTarea;
import com.ejie.aa79b.model.ExpTareasResumen;
import com.ejie.aa79b.model.Expediente;
import com.ejie.aa79b.model.Gantt;
import com.ejie.aa79b.model.GanttValues;
import com.ejie.aa79b.model.Tareas;
import com.ejie.aa79b.model.TareasTrabajo;
import com.ejie.aa79b.model.enums.EstadoAceptacionTareaEnum;
import com.ejie.aa79b.model.enums.EstadoEjecucionTareaEnum;
import com.ejie.aa79b.security.Usuario;
import com.ejie.x38.dto.JQGridRequestDto;
import com.ejie.x38.dto.JQGridResponseDto;
import com.ejie.x38.dto.TableRowDto;

/**
 * ExpedienteServiceImpl generated by UDA, 31-ene-2018 15:08:48.
 *
 * @author UDA
 */

@Service(value = "cargaTrabajoService")
public class CargaTrabajoServiceImpl extends GenericoServiceImpl<ExpTareasResumen> implements CargaTrabajoService {

	@Autowired()
	private CargaTrabajoDao cargaTrabajoDao;
	@Autowired()
	private TareasGeneralDao tareasGeneralDao;
	@Autowired()
	private ExpedienteDao expedienteDao;
	@Autowired()
	private TareasTrabajoDao tareasTrabajoDao;
	@Autowired()
	private TareasDao tareasDao;

	@Override
	public JQGridResponseDto<ExpTareasResumen> filtroExpTareas(ExpTareasResumen expTareasResumenFilter,
			JQGridRequestDto jqGridRequestDto, boolean startsWith) {

		List<ExpTareasResumen> listaT = this.cargaTrabajoDao.filtroExpTareas(expTareasResumenFilter, jqGridRequestDto,
				false, false);

		Long recordNum = this.cargaTrabajoDao.filtroTareasCount(expTareasResumenFilter, false);

		if (jqGridRequestDto.getMultiselection().getSelectedIds() != null) {
			List<TableRowDto<ExpTareasResumen>> reorderSelection = this.cargaTrabajoDao
					.reorderSelection(expTareasResumenFilter, jqGridRequestDto, startsWith);
			return new JQGridResponseDto<ExpTareasResumen>(jqGridRequestDto, recordNum, listaT, reorderSelection);
		}
		return new JQGridResponseDto<ExpTareasResumen>(jqGridRequestDto, recordNum, listaT);
	}

	@Override
	public Integer procComprobarEstadoTareasDependientes(final BigDecimal idTarea, final Long anyo,
			final Integer numExp) {
		return this.cargaTrabajoDao.procComprobarEstadoTareasDependientes(idTarea, anyo, numExp);
	}

	@Override
	public ExpTareasResumen findTarea(BigDecimal idTarea, String idioma) {
		ExpTareasResumen expTareasResumen = this.cargaTrabajoDao.findTarea(idTarea);
		List<DocumentoTarea> docusList = this.tareasGeneralDao.findDocsDetalleTarea(idTarea, idioma);
		if (null != docusList) {
			expTareasResumen.setDocuTareasList(docusList);
		}
		if (null != expTareasResumen.getTarea()) {
			Expediente expedienteFilter = new Expediente();
			expedienteFilter.setAnyo(expTareasResumen.getTarea().getAnyo());
			expedienteFilter.setNumExp(expTareasResumen.getTarea().getNumExp());

			Expediente expediente = this.expedienteDao.find(expedienteFilter);
			expTareasResumen.setOrigen(expediente.getIdTipoExpediente());
			expTareasResumen.setOrigen(expediente.getOrigen());
			expTareasResumen.setAplicacionOrigen(expediente.getAplicacionOrigen());
			if (expTareasResumen.getExpedienteTradRev() != null) {
				expTareasResumen.getExpedienteTradRev()
						.setIndConfidencial(expediente.getExpedienteTradRev().getIndConfidencial());
				expTareasResumen.getExpedienteTradRev().setIdIdioma(expediente.getExpedienteTradRev().getIdIdioma());
				expTareasResumen.getExpedienteTradRev()
						.setFechaFinalIzo(expediente.getExpedienteTradRev().getFechaFinalIzo());
				expTareasResumen.getExpedienteTradRev()
						.setHoraFinalIzo(expediente.getExpedienteTradRev().getHoraFinalIzo());
			}
		}
		return expTareasResumen;
	}

	@Override
	public JQGridResponseDto<ExpTareasResumen> filtroTareasDependiente(ExpTareasResumen expTareasResumenFilter,
			JQGridRequestDto jqGridRequestDto, boolean startsWith) {

		List<ExpTareasResumen> listaT = this.cargaTrabajoDao.filtroTareasDependiente(expTareasResumenFilter,
				jqGridRequestDto, false);

		Long recordNum = this.cargaTrabajoDao.filtroTareasDependienteCount(expTareasResumenFilter, false);

		return new JQGridResponseDto<ExpTareasResumen>(jqGridRequestDto, recordNum, listaT);
	}

	@Override()
	@Transactional(rollbackFor = Throwable.class)
	public ExpTareasResumen updateEstadoAceptacion(ExpTareasResumen expTareasResumen) {
		return this.cargaTrabajoDao.updateEstadoAceptacion(expTareasResumen);
	}

	@Override()
	@Transactional(rollbackFor = Throwable.class)
	public List<Gantt> getExpTareasGantt(ExpTareasResumen expTareasResumen, Locale locale) {
		List<ExpTareasResumen> tareaList = this.cargaTrabajoDao.getExpTareasGantt(expTareasResumen, false);

		List<Gantt> listaGantt = new ArrayList<Gantt>();

		String idPersonaActual = "";

		for (int i = 0; i < tareaList.size(); i++) {
			idPersonaActual = createNewGantt(locale, tareaList, listaGantt, idPersonaActual, i);
		}
		return listaGantt;
	}

	private String createNewGantt(Locale locale, List<ExpTareasResumen> tareaList, List<Gantt> listaGantt,
			String idPersonaActual, int i) {
		Gantt gantt = new Gantt();
		GanttValues ganttValues = new GanttValues();
		List<GanttValues> listaValues = new ArrayList<GanttValues>();
		String dni = idPersonaActual;
		if (EstadoEjecucionTareaEnum.EJECUTADA.getValue() != tareaList.get(i).getTarea().getEstadoEjecucion()
				&& EstadoAceptacionTareaEnum.PENDIENTE_ASIGNACION.getValue() != tareaList.get(i).getTarea()
						.getEstadoAsignado()) {
			if (!idPersonaActual.equals(tareaList.get(i).getTarea().getPersonaAsignada().getDni())) {
				dni = tareaList.get(i).getTarea().getPersonaAsignada().getDni();
				gantt.setName(tareaList.get(i).getTarea().getPersonaAsignada().getNombreCompletoSinComas());
			} else if ((i % 10) == 0) {
				// 10 son las filas por p√°gina del gantt
				gantt.setName(tareaList.get(i).getTarea().getPersonaAsignada().getNombreCompletoSinComas());
			}

			setGanttValues(locale, tareaList, i, gantt, ganttValues);
			listaValues.add(ganttValues);
			gantt.setValues(listaValues);
			listaGantt.add(gantt);
		}
		return dni;
	}

	private void setGanttValues(Locale locale, List<ExpTareasResumen> tareaList, int i, Gantt gantt,
			GanttValues ganttValues) {
		if (tareaList.get(i).getTarea().getIdTarea() != null) {
			if (this.esTareaDeExpediente(tareaList.get(i))) {
				gantt.setDesc(
						"(" + tareaList.get(i).getTarea().getAnyoNumExpConcatenado() + ") " + tareaList.get(i).getTitulo());
			} else {
				gantt.setDesc(
						"(" + tareaList.get(i).getOtrosTrabajos().getIdTrabajo() + ") " + tareaList.get(i).getOtrosTrabajos().getDescTrabajo());
			}

			tareaList.get(i).getTarea().getPersonaAsignada().getNombreCompletoSinComas();

			ganttValues.setFrom(tareaList.get(i).getTarea().getFechaIni());
			ganttValues.setTo(tareaList.get(i).getTarea().getFechaFin());

			setGanttLabels(locale, tareaList, i, ganttValues);

			setGanttCustomClass(tareaList, i, ganttValues);
			if (this.esTareaDeExpediente(tareaList.get(i))) {
				ganttValues.setDataObj(tareaList.get(i).getTarea().getAnyo() + "," + tareaList.get(i).getTarea().getNumExp()
						+ "," + tareaList.get(i).getTarea().getIdTarea());
			} else {
				ganttValues.setDataObj(tareaList.get(i).getOtrosTrabajos().getIdTrabajo()
						+ "," + tareaList.get(i).getTarea().getIdTarea());
			}
		} else {
			gantt.setDesc("-");
			ganttValues.setFrom(new Date());
			ganttValues.setTo(new Date());
			ganttValues.setDesc("");
			ganttValues.setLabel("");
			ganttValues.setCustomClass("");
			ganttValues.setCustomClass("sinTarea");
			ganttValues.setDataObj("");
		}
	}

	private boolean esTareaDeExpediente(ExpTareasResumen expTareasResumen) {
		return expTareasResumen.getAnyo() != null && expTareasResumen.getAnyo() > 0 &&
				expTareasResumen.getNumExp() != null && expTareasResumen.getNumExp() > 0 &&
				StringUtils.isNotBlank(expTareasResumen.getTitulo());
	}

	private void setGanttLabels(Locale locale, List<ExpTareasResumen> tareaList, int i, GanttValues ganttValues) {
		if (Constants.LANG_CASTELLANO == locale.getLanguage()) {
			ganttValues.setDesc(tareaList.get(i).getTarea().getTipoTarea().getDescEs015());
			ganttValues.setLabel(tareaList.get(i).getTarea().getTipoTarea().getDescEs015());
		} else {
			ganttValues.setDesc(tareaList.get(i).getTarea().getTipoTarea().getDescEu015());
			ganttValues.setLabel(tareaList.get(i).getTarea().getTipoTarea().getDescEu015());
		}
	}

	private void setGanttCustomClass(List<ExpTareasResumen> tareaList, int i, GanttValues ganttValues) {
		if (EstadoAceptacionTareaEnum.PENDIENTE_ACEPTACION.getValue() == tareaList.get(i).getTarea()
				.getEstadoAsignado()) {
			ganttValues.setCustomClass(EstadoAceptacionTareaEnum.PENDIENTE_ACEPTACION.getCss());
		} else if (EstadoAceptacionTareaEnum.RECHAZADA.getValue() == tareaList.get(i).getTarea().getEstadoAsignado()) {
			ganttValues.setCustomClass(EstadoAceptacionTareaEnum.RECHAZADA.getCss());
		} else if (EstadoAceptacionTareaEnum.ACEPTADA.getValue() == tareaList.get(i).getTarea().getEstadoAsignado()
				&& EstadoEjecucionTareaEnum.PENDIENTE_EJECUCION.getValue() == tareaList.get(i).getTarea()
						.getEstadoEjecucion()) {
			ganttValues.setCustomClass(EstadoEjecucionTareaEnum.PENDIENTE_EJECUCION.getCss());
		} else if (EstadoEjecucionTareaEnum.RETRASADA.getValue() == tareaList.get(i).getTarea().getEstadoEjecucion()) {
			ganttValues.setCustomClass(EstadoEjecucionTareaEnum.RETRASADA.getCss());
		}
	}

	@Override()
	@Transactional(rollbackFor = Throwable.class)
	public List<Gantt> getExpGantt(ExpTareasResumen expTareasResumen, Boolean tareas, Locale locale) {
		List<ExpTareasResumen> expList = this.cargaTrabajoDao.getExpedientesTarea(expTareasResumen);
		List<ExpTareasResumen> tareaList = new ArrayList<ExpTareasResumen>();
		if (tareas) {
			tareaList = this.cargaTrabajoDao.getTareasExpediente(expTareasResumen);
		}
		return this.getListDateExpGantt(expList, tareaList, tareas, locale);
	}

	@Override
	public List<Tareas> obtenerDatosTareas(String tareasSeleccionados) {
		return this.cargaTrabajoDao.obtenerDatosTareas(tareasSeleccionados);
	}

	@Override()
	@Transactional(rollbackFor = Throwable.class)
	public void insertObsrvRechazo(BigDecimal idTarea, String motivoRechazo) {
		this.cargaTrabajoDao.insertObsrvRechazo(idTarea, motivoRechazo);
	}

	@Override()
	public Long comprobarConflictoFechas(String[] listaIdTareas) {
		return this.cargaTrabajoDao.comprobarConflictoFechas(listaIdTareas);
	}

	@Override
	protected GenericoDao<ExpTareasResumen> getDao() {
		return this.cargaTrabajoDao;
	}

	private List<Gantt> getListDateExpGantt(List<ExpTareasResumen> expList, List<ExpTareasResumen> tareaList,
			Boolean tareas, Locale locale) {

		List<Gantt> listaGantt = new ArrayList<Gantt>();

		int filas = 0;

		for (int i = 0; i < expList.size(); i++) {
			Gantt gantt = crearFilaGanttExpediente(expList, i);
			listaGantt.add(gantt);
			filas++;
			if (tareas) {
				int j = 0;
				for (j = 0; j < tareaList.size(); j++) {
					if (((StringUtils.isNotBlank(expList.get(i).getAnyoNumExpConcatenado()) &&
							expList.get(i).getAnyoNumExpConcatenado().equals(tareaList.get(j).getTarea().getAnyoNumExpConcatenado()))
							||	(expList.get(i).getOtrosTrabajos() != null && expList.get(i).getOtrosTrabajos().getIdTrabajo() != null &&
									tareaList.get(j).getOtrosTrabajos() != null &&
								expList.get(i).getOtrosTrabajos().getIdTrabajo().equals(tareaList.get(j).getOtrosTrabajos().getIdTrabajo())))
							&& EstadoEjecucionTareaEnum.EJECUTADA.getValue() != tareaList.get(j).getTarea()
									.getEstadoEjecucion()
							&& EstadoAceptacionTareaEnum.PENDIENTE_ASIGNACION.getValue() != tareaList.get(j).getTarea()
									.getEstadoAsignado()) {
						if (filas % 10 == 0) {
							crearFilaGanttExpediente(expList, i);
							listaGantt.add(gantt);
							filas++;
						}
						this.setDatosGanttList(expList, tareaList, locale, listaGantt, i, j, filas);
						filas++;
					}
				}
			}
		}
		return listaGantt;
	}

	private Gantt crearFilaGanttExpediente(List<ExpTareasResumen> expList, int i) {
		Gantt gantt = new Gantt();
		GanttValues ganttValues = new GanttValues();
		List<GanttValues> listaValues = new ArrayList<GanttValues>();
		if (expList.get(i).getAnyo() != null && expList.get(i).getAnyo() > 0 &&
				expList.get(i).getNumExp() != null && expList.get(i).getNumExp() > 0) {
			gantt.setName(expList.get(i).getAnyoNumExpConcatenado());
			gantt.setDesc(expList.get(i).getTitulo());

			ganttValues.setFrom(expList.get(i).getTarea().getFechaIni());
			ganttValues.setTo(expList.get(i).getTarea().getFechaFin());

			ganttValues.setDesc(expList.get(i).getTitulo());
			ganttValues.setLabel(expList.get(i).getTitulo());

		} else {
			// tarea trabajo
			gantt.setName(expList.get(i).getOtrosTrabajos().getIdTrabajo() + "");
			gantt.setDesc(expList.get(i).getOtrosTrabajos().getDescTrabajo());
			// probar bien
			ganttValues.setFrom(expList.get(i).getTareaTrabajo().getFechaIni());
			ganttValues.setTo(expList.get(i).getTareaTrabajo().getFechaFin());

			ganttValues.setDesc(expList.get(i).getOtrosTrabajos().getDescTrabajo());
			ganttValues.setLabel(expList.get(i).getOtrosTrabajos().getDescTrabajo());
		}

		ganttValues.setCustomClass(Constants.GANTT_EXP_CSS);
		listaValues.add(ganttValues);
		gantt.setValues(listaValues);
		return gantt;
	}

	private void setDatosGanttList(List<ExpTareasResumen> expList, List<ExpTareasResumen> tareaList, Locale locale,
			List<Gantt> listaGantt, int i, int j, int filas) {

		Gantt ganttTarea = new Gantt();
		GanttValues ganttValuesTarea = new GanttValues();
		List<GanttValues> listaValuesTarea = new ArrayList<GanttValues>();
		ganttTarea.setName("");
		if (expList.get(i).getAnyo() != null && expList.get(i).getAnyo() > 0 &&
				expList.get(i).getNumExp() != null && expList.get(i).getNumExp() > 0) {
			if (locale.getLanguage().equals(Constants.LANG_EUSKERA)) {
				ganttTarea.setDesc(tareaList.get(j).getTarea().getTipoTarea().getDescEu015());
			} else {
				ganttTarea.setDesc(tareaList.get(j).getTarea().getTipoTarea().getDescEs015());
			}
			ganttValuesTarea.setFrom(tareaList.get(j).getTarea().getFechaIni());
			ganttValuesTarea.setTo(tareaList.get(j).getTarea().getFechaFin());

			ganttValuesTarea.setDesc(tareaList.get(j).getTarea().getPersonaAsignada().getNombreCompletoSinComas());
			ganttValuesTarea.setLabel(tareaList.get(j).getTarea().getPersonaAsignada().getNombreCompletoSinComas());
		} else {
			// tarea trabajo
			if (locale.getLanguage().equals(Constants.LANG_EUSKERA)) {
				ganttTarea.setDesc(tareaList.get(j).getTareaTrabajo().getTipoTarea().getDescEu015());
			} else {
				ganttTarea.setDesc(tareaList.get(j).getTareaTrabajo().getTipoTarea().getDescEs015());
			}
			ganttValuesTarea.setFrom(tareaList.get(j).getTareaTrabajo().getFechaIni());
			ganttValuesTarea.setTo(tareaList.get(j).getTareaTrabajo().getFechaFin());

			ganttValuesTarea.setDesc(tareaList.get(j).getTareaTrabajo().getPersonaAsignada().getNombreCompletoSinComas());
			ganttValuesTarea.setLabel(tareaList.get(j).getTareaTrabajo().getPersonaAsignada().getNombreCompletoSinComas());
		}


		setGanttCustomClass(tareaList, j, ganttValuesTarea);

		if (expList.get(i).getAnyo() != null && expList.get(i).getAnyo() > 0 &&
				expList.get(i).getNumExp() != null && expList.get(i).getNumExp() > 0) {
			ganttValuesTarea.setDataObj(tareaList.get(j).getTarea().getAnyo() + ","
					+ tareaList.get(j).getTarea().getNumExp() + "," + tareaList.get(j).getTarea().getIdTarea());

		} else {
			ganttValuesTarea.setDataObj(tareaList.get(j).getOtrosTrabajos().getIdTrabajo() + ","
					+ tareaList.get(j).getTareaTrabajo().getIdTarea());
		}
		listaValuesTarea.add(ganttValuesTarea);
		ganttTarea.setValues(listaValuesTarea);
		listaGantt.add(ganttTarea);

	}

	@Override
	public List<ExpTareasResumen> filtroExpTareasGetSelectedIds(ExpTareasResumen expTareasResumenFilter,
			JQGridRequestDto tableData) {
		return this.cargaTrabajoDao.filtroExpTareasGetSelectedIds(expTareasResumenFilter, tableData);
	}

	@Override
	public JQGridResponseDto<ExpTareasResumen> filtroExpTareasTrabajo(ExpTareasResumen expTareasResumenFilter,
			JQGridRequestDto jqGridRequestDto, boolean startsWith) {
		List<ExpTareasResumen> listaT = this.cargaTrabajoDao.filtroExpTareasTrabajo(expTareasResumenFilter, jqGridRequestDto,
				false, false);

		Long recordNum = this.cargaTrabajoDao.filtroTareasTrabajoCount(expTareasResumenFilter, false);

		if (jqGridRequestDto.getMultiselection().getSelectedIds() != null) {
			List<TableRowDto<ExpTareasResumen>> reorderSelection = this.cargaTrabajoDao
					.reorderSelection(expTareasResumenFilter, jqGridRequestDto, startsWith);
			return new JQGridResponseDto<ExpTareasResumen>(jqGridRequestDto, recordNum, listaT, reorderSelection);
		}
		return new JQGridResponseDto<ExpTareasResumen>(jqGridRequestDto, recordNum, listaT);
	}

	@Override
	public List<ExpTareasResumen> filtroTareasTrabajoGetSelectedIds(ExpTareasResumen expTareasResumenFilter,
			JQGridRequestDto tableData) {
		return this.cargaTrabajoDao.filtroTareasTrabajoGetSelectedIds(expTareasResumenFilter, tableData);
	}

	@Override
	@Transactional(rollbackFor = Throwable.class)
	public Integer updateEstadoAceptacionTareaTrabajo(TareasTrabajo tareas) {
		return this.cargaTrabajoDao.updateEstadoAceptacionTareaTrabajo(tareas);
	}

	@Override
	@Transactional(rollbackFor = Throwable.class)
	public Integer insertObsrvRechazoTareaTrabajo(BigDecimal idTarea, String motivoRechazo) {
		return this.cargaTrabajoDao.insertObsrvRechazoTareaTrabajo(idTarea, motivoRechazo);
	}

	@Override
	public List<TareasTrabajo> obtenerDatosTareasTrabajo(String tareasSeleccionados) {
		return this.cargaTrabajoDao.obtenerDatosTareasTrabajo(tareasSeleccionados);
	}

	@Override
	public String tieneTareasPendientes() {
		Usuario credentials = (Usuario) SecurityContextHolder.getContext().getAuthentication().getCredentials();
		TareasTrabajo tareasTrabajo = new TareasTrabajo();
		tareasTrabajo.getPersonaAsignada().setDni(credentials.getNif());

		int tieneTrabajo = this.tareasTrabajoDao.comprobarTareasPendientesUsuario(tareasTrabajo);

		Tareas tareas = new Tareas();
		tareas.getPersonaAsignada().setDni(credentials.getNif());
		int tieneTradRev = this.tareasDao.comprobarTareasPendientesTradRevUsuario(tareas);

		int tieneInter = this.tareasDao.comprobarTareasPendientesInterpretacion(tareas);

		StringBuilder resultado = new StringBuilder();
		if (tieneTradRev > 0 ) {
			resultado.append("1");
		}else {
			resultado.append("0");
		}
		resultado.append(",");
		if (tieneInter > 0 ) {
			resultado.append("1");
		}else {
			resultado.append("0");
		}
		resultado.append(",");
		if (tieneTrabajo > 0) {
			resultado.append("1");
		}else {
			resultado.append("0");
		}
		return resultado.toString();
	}

	@Override
	public String tieneTareasPendientesAsignador(ExpTareasResumen expTareasResumen) {
		Integer resultado = Constants.CERO;
		for (String trabajador: expTareasResumen.getFiltroDatos()) {
			resultado = this.tareasTrabajoDao.comprobarTareasPendientesUsuarioAsignador(expTareasResumen, trabajador);
			if (resultado > Constants.CERO) {
				return resultado.toString();
			}
		}
		return resultado.toString();
	}
}
