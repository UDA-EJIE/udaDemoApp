package com.ejie.aa79b.service;

import java.math.BigDecimal;
import java.util.Collections;
import java.util.Date;
import java.util.List;

import org.apache.commons.lang.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.dao.DatosTareaTradosDao;
import com.ejie.aa79b.dao.DocumentosGeneralDao;
import com.ejie.aa79b.dao.GenericoDao;
import com.ejie.aa79b.dao.OidsAuxiliarDao;
import com.ejie.aa79b.dao.TareasDao;
import com.ejie.aa79b.model.DatosTareaTrados;
import com.ejie.aa79b.model.DocumentoTarea;
import com.ejie.aa79b.model.DocumentoTareaAdjunto;
import com.ejie.aa79b.model.DocumentosAlinear;
import com.ejie.aa79b.model.DocumentosExpediente;
import com.ejie.aa79b.model.DocumentosPostTraduccionBOE;
import com.ejie.aa79b.model.Tareas;
import com.ejie.aa79b.model.enums.TipoFicheroAdjuntoEnum;
import com.ejie.aa79b.model.webservices.Aa79bEntradaEliminarFichero;

/**
 * DocumentosGeneralServiceImpl generated by UDA, 28-nov-2017 15:23:30.
 *
 * @author UDA
 */

@Service(value = "documentosGeneralService")
public class DocumentosGeneralServiceImpl extends GenericoServiceImpl<DocumentoTareaAdjunto>
		implements DocumentosGeneralService {

	@Autowired
	private DocumentosGeneralDao documentosGeneralDao;
	@Autowired
	private DocumentosExpedienteService documentosExpedienteService;
	@Autowired
	private TareasGeneralService tareasGeneralService;
	@Autowired
	private ExpedienteTradRevService expedienteTradRevService;
	@Autowired
	private DatosTareaTradosDao datosTareaTradosDao;
	@Autowired()
	private OidsAuxiliarDao oidsAuxiliarDao;
	@Autowired()
	private TareasDao tareasDao;

	private static final Logger LOGGER = LoggerFactory.getLogger(DocumentosGeneralServiceImpl.class);

	@Override
	protected GenericoDao<DocumentoTareaAdjunto> getDao() {
		return this.documentosGeneralDao;
	}

	@Override
	@Transactional(rollbackFor = Throwable.class)
	public DocumentoTareaAdjunto addDocumentoTareaTrabajo(DocumentoTareaAdjunto bean, String idTablaIntermedia) {
		BigDecimal idFicheroActual = bean.getIdFichero();
		if (idFicheroActual != null) {
			//borramos el fichero anterior
			if ("C8".equals(idTablaIntermedia)) {
				this.documentosGeneralDao.removeC8(bean);
			}else {
				//Para D1
			}
			this.documentosGeneralDao.remove(idFicheroActual);
		}
		this.documentosGeneralDao.add(bean);
		if ("C8".equals(idTablaIntermedia)) {
			this.documentosGeneralDao.addC8(bean);
		}else {//para la tabla D1

		}
		return bean;
	}

	@Override
	@Transactional(rollbackFor = Throwable.class)
	public DocumentoTareaAdjunto addCondicional(DocumentoTareaAdjunto bean, int idTablaIntermedia) {
		if (bean.getIdFichero() == null) {
			this.documentosGeneralDao.add(bean);
		}
		switch (idTablaIntermedia) {
		case 87:
			this.documentosGeneralDao.add87(bean);
			break;
		case 92:
			this.documentosGeneralDao.add92(bean);
			break;
		case 93:
			this.documentosGeneralDao.add93(bean);
			break;
		case 96:
			this.documentosGeneralDao.add92(bean);
			break;
		default:
			break;
		}
		return bean;
	}

	@Override
	@Transactional(rollbackFor = Throwable.class)
	public DocumentoTareaAdjunto updateCondicional(DocumentoTareaAdjunto bean, int idTablaIntermedia) {
		this.documentosGeneralDao.update(bean);
		switch (idTablaIntermedia) {
		case 87:
			this.documentosGeneralDao.update87(bean);
			break;
		case 92:
			this.documentosGeneralDao.update92(bean);
			break;
		case 93:
			this.documentosGeneralDao.update93(bean);
			break;
		case 96:
			this.documentosGeneralDao.update92(bean);
			break;
		default:
			break;
		}
		return bean;
	}

	@Override
	public DocumentoTareaAdjunto cambiarvisibilidad(DocumentoTareaAdjunto bean, String numeroTabla) {
		return this.documentosGeneralDao.cambiarvisibilidad(bean, numeroTabla);
	}

	@Override
	@Transactional(rollbackFor = Throwable.class)
	public DocumentoTarea eliminarDocFinal(BigDecimal idTarea, BigDecimal elIdDocOriginal) {

		DocumentoTarea filterDocumentoTarea = new DocumentoTarea();
		filterDocumentoTarea.setIdTarea(idTarea);
		DocumentosExpediente docOriginal = new DocumentosExpediente();
		docOriginal.setIdDoc(elIdDocOriginal);
		filterDocumentoTarea.setDocumentoOriginal(docOriginal);
		DocumentoTarea docTarea = this.tareasGeneralService.findRegCorredaccion(filterDocumentoTarea);
		DocumentoTarea docTareaTrad = this.tareasGeneralService.findRegTraduccionRevision(filterDocumentoTarea);

		// anyadimos los documentos a la tabla A0
		if (StringUtils.isNotEmpty(docTarea.getDocumentoAdjunto().getOid())) {
			this.oidsAuxiliarDao.add(docTarea.getDocumentoAdjunto().getOid());
		}
		if (StringUtils.isNotEmpty(docTareaTrad.getDocumentoAdjunto().getOid())) {
			this.oidsAuxiliarDao.add(docTareaTrad.getDocumentoAdjunto().getOid());
		}

		// Borro registro de la 92 por idDocOriginal
		this.documentosGeneralDao.remove92(elIdDocOriginal);
		// Borro registro de la 83 por idDocOriginal
		this.documentosGeneralDao.remove83(elIdDocOriginal);
		// Borro registro de la 87 por idDocOriginal
		this.documentosGeneralDao.remove87(elIdDocOriginal);
		// Borro registro de la 88 por IdFichero
		this.documentosGeneralDao.remove(docTarea.getDocumentoAdjunto());

		// eliminar del PID y de la T56 (con docs relacionados y versiones si
		// las hay
		DocumentosExpediente documentosExpediente = new DocumentosExpediente();
		documentosExpediente.setIdDoc(elIdDocOriginal);
		this.documentosExpedienteService.removeConVuelta(documentosExpediente, Constants.PLANIFICACION);

		// ATENCION............ ACTUALIZAR NumTotalPalIZO y BORRAR el resto de
		// tablas intermedias (cuando sepamos cuales son...

		this.expedienteTradRevService.actualizarSumaNumTotalPalIzo(docTarea.getDocumentoOriginal().getAnyo(),
				docTarea.getDocumentoOriginal().getNumExp());
		return docTarea;
	}

	@Override
	@Transactional(rollbackFor = Throwable.class)
	public void eliminarDocXliff(BigDecimal idTarea, BigDecimal elIdDocXliff, String elOid) {

		// anyadir a tabla A0
		this.oidsAuxiliarDao.add(elOid);
		// Borro registro de la 96 por elIdDocXliff
		this.documentosGeneralDao.remove96(elIdDocXliff);
		// Borro registro de la 88 por IdFichero
		this.documentosGeneralDao.remove(elIdDocXliff);
	}

	@Override
	@Transactional(rollbackFor = Throwable.class)
	public DocumentosExpediente addOriginal(DocumentosExpediente documentosExpediente, String origen,
			BigDecimal idTarea) {

		DocumentosExpediente documentosExpedienteAux;
		documentosExpedienteAux = this.documentosExpedienteService.add(documentosExpediente, origen);
		DocumentosGeneralServiceImpl.LOGGER.info("[POST] : DocumentosExpediente insertado correctamente");

		DocumentoTareaAdjunto documentoTareaAdjunto = new DocumentoTareaAdjunto();
		documentoTareaAdjunto.setIdTarea(idTarea);
		documentoTareaAdjunto.setIdDocOriginal(documentosExpedienteAux.getIdDoc());

		// ATENCION............ ACTUALIZAR NumTotalPalIZO
		this.expedienteTradRevService.actualizarSumaNumTotalPalIzo(documentosExpediente.getAnyo(),
				documentosExpediente.getNumExp());

		return documentosExpedienteAux;
	}

	@Override
	@Transactional(rollbackFor = Throwable.class)
	public DocumentoTareaAdjunto add92(DocumentoTareaAdjunto documentoTareaAdjunto) {
		return this.documentosGeneralDao.add92(documentoTareaAdjunto);
	}

	@Override
	@Transactional(rollbackFor = Throwable.class)
	public DocumentoTareaAdjunto addXliff(DocumentoTareaAdjunto bean) {
		this.documentosGeneralDao.add(bean);
		this.documentosGeneralDao.add96(bean);
		return bean;
	}

	@Override
	@Transactional(rollbackFor = Throwable.class)
	public DocumentosAlinear addB6(DocumentosAlinear documentosAlinear) {
		return this.documentosGeneralDao.addB6(documentosAlinear);
	}

	@Override
	@Transactional(rollbackFor = Throwable.class)
	public DocumentosAlinear updateB6(DocumentosAlinear documentosAlinear) {
		return this.documentosGeneralDao.updateB6(documentosAlinear);
	}

	@Override
	@Transactional(rollbackFor = Throwable.class)
	public DocumentosAlinear consultaFicherosAlinear(BigDecimal idTarea) {
		return this.documentosGeneralDao.consultaFicherosAlinear(idTarea);
	}

	@Override
	@Transactional(rollbackFor = Throwable.class)
	public Integer actualizarValorIndCorreccionesAlinear(BigDecimal idTarea, String indCorrecciones) {
		if (Constants.CERO.equals(this.documentosGeneralDao.actualizarValorIndCorreccionesAlinear(idTarea,
				indCorrecciones))) {
			DocumentosAlinear docInsertar = new DocumentosAlinear();
			docInsertar.setIdTarea(idTarea);
			docInsertar.setIndCorreciones(indCorrecciones);
			this.documentosGeneralDao.addB6(docInsertar);
		}
		return Constants.UNO;
	}

	@Override
	public DocumentosPostTraduccionBOE add86(DocumentosPostTraduccionBOE documentosPostTraduccionBOE) {
		return this.documentosGeneralDao.add86(documentosPostTraduccionBOE);
	}

	@Override
	public int updateDocOriginalFinal(DocumentoTareaAdjunto documentoTareaAdjunto) {
		return this.documentosGeneralDao.updateDocOriginalFinal(documentoTareaAdjunto);
	}

	@Override
	public DocumentosPostTraduccionBOE update86(DocumentosPostTraduccionBOE documentosPostTraduccionBOE,
			Integer destinoUpload) {
		return this.documentosGeneralDao.update86(documentosPostTraduccionBOE, destinoUpload);
	}

	@Override
	public DocumentoTareaAdjunto update92(DocumentoTareaAdjunto documentoTareaAdjunto) {
		return this.documentosGeneralDao.update92(documentoTareaAdjunto);
	}

	@Override
	public DocumentosPostTraduccionBOE consultaFicherosBOE(BigDecimal idTarea) {
		return this.documentosGeneralDao.consultaFicherosBOE(idTarea);
	}

	@Override
	public List<DocumentoTareaAdjunto> findAllDocumentosTarea(DocumentoTareaAdjunto bean) {
		return this.documentosGeneralDao.findAllDocumentosTarea(bean);
	}

	@Override
	public boolean isRowCreated(BigDecimal idTarea, BigDecimal idDocOrig, int numeroTabla) {
		return this.documentosGeneralDao.isRowCreated(idTarea, idDocOrig, numeroTabla);
	}

	@Override
	public DocumentoTareaAdjunto add83(DocumentoTareaAdjunto documentoTareaAdjunto) {
		return this.documentosGeneralDao.add83(documentoTareaAdjunto);
	}

	@Override
	public Integer eliminarJustificante(BigDecimal idDocOriginal, BigDecimal idTarea) {
		DocumentoTarea filterDocumentoTarea = new DocumentoTarea();
		filterDocumentoTarea.setIdTarea(idTarea);
		DocumentosExpediente docOriginal = new DocumentosExpediente();
		docOriginal.setIdDoc(idDocOriginal);
		filterDocumentoTarea.setDocumentoOriginal(docOriginal);
		DocumentoTarea documentoTarea = this.tareasGeneralService.findRegJustificante(filterDocumentoTarea);
		// anyadimos el oid a la tabla A0
		this.oidsAuxiliarDao.add(documentoTarea.getDocumentoAdjunto().getOid());
		int resul = 0;
		resul += this.documentosGeneralDao.eliminarJustificante(documentoTarea.getDocumentoAdjunto().getIdFichero());
		this.documentosGeneralDao.remove(documentoTarea.getDocumentoAdjunto().getIdFichero());
		return resul;
	}

	@Override
	public void addTipoFichero(DocumentoTareaAdjunto documentoTareaAdjunto, Integer tipoFichero) {
		if (TipoFicheroAdjuntoEnum.TIPO_TRADUCCION_REVISION.getValue().equals(tipoFichero)) {
			this.addOrUpdateTipoFicheroTradRev(documentoTareaAdjunto);
		} else if (TipoFicheroAdjuntoEnum.TIPO_JUSTIFICANTE.getValue().equals(tipoFichero)) {
			this.addOrUpdateTipoFicheroJustificante(documentoTareaAdjunto);
		} else if (TipoFicheroAdjuntoEnum.TIPO_XLIFF.getValue().equals(tipoFichero)) {
			this.addOrUpdateFicheroXliff(documentoTareaAdjunto);
		} else if (TipoFicheroAdjuntoEnum.TIPO_BOE_INFORME.getValue().equals(tipoFichero)) {
			DocumentosPostTraduccionBOE documentosPostTraduccionBOE = new DocumentosPostTraduccionBOE();
			documentosPostTraduccionBOE.setIdTarea(documentoTareaAdjunto.getIdTarea());
			documentosPostTraduccionBOE.setIdFicheroInforme(documentoTareaAdjunto.getIdFichero());
			documentosPostTraduccionBOE.setFechaAltaInforme(new Date());
			this.addOrUpdateTipoFicheroBoeInforme(documentosPostTraduccionBOE);
		} else if (TipoFicheroAdjuntoEnum.TIPO_BOE_DOCUMENTO.getValue().equals(tipoFichero)) {
			DocumentosPostTraduccionBOE documentosPostTraduccionBOE = new DocumentosPostTraduccionBOE();
			documentosPostTraduccionBOE.setIdTarea(documentoTareaAdjunto.getIdTarea());
			documentosPostTraduccionBOE.setIdFicheroDoc(documentoTareaAdjunto.getIdFichero());
			documentosPostTraduccionBOE.setFechaAltaDoc(new Date());
			this.addOrUpdateTipoFicheroBoeDocumento(documentosPostTraduccionBOE);
		} else if (TipoFicheroAdjuntoEnum.TIPO_TRADOS.getValue().equals(tipoFichero)) {
			DatosTareaTrados datosTareaTrados = new DatosTareaTrados();
			datosTareaTrados.setIdTarea(documentoTareaAdjunto.getIdTarea());
			datosTareaTrados.setIdFicheroTrados(documentoTareaAdjunto.getIdFichero());
			this.addOrUpdateIdFichero(datosTareaTrados);
		} else if (TipoFicheroAdjuntoEnum.TIPO_FINAL.getValue().equals(tipoFichero)) {
			this.addOrUpdateTipoFinal(documentoTareaAdjunto);
		}
	}

	@Override
	public Integer removeTipoFichero(Aa79bEntradaEliminarFichero bean) {
		if (TipoFicheroAdjuntoEnum.TIPO_XLIFF.getValue().equals(bean.getTipoFichero())) {
			return this.documentosGeneralDao.remove96(bean.getIdDoc());
		}
		return Constants.CERO;
	}

	private void addOrUpdateTipoFicheroTradRev(DocumentoTareaAdjunto documentoTareaAdjunto) {
		if (this.documentosGeneralDao.updateIdFichero87(documentoTareaAdjunto) == Constants.CERO) {
			this.documentosGeneralDao.add87(documentoTareaAdjunto);
		}
	}

	private void addOrUpdateTipoFicheroJustificante(DocumentoTareaAdjunto documentoTareaAdjunto) {
		if (this.documentosGeneralDao.updateIdFichero93(documentoTareaAdjunto) == Constants.CERO) {
			this.documentosGeneralDao.add93(documentoTareaAdjunto);
		}
	}

	private void addOrUpdateFicheroXliff(DocumentoTareaAdjunto documentoTareaAdjunto) {
		this.documentosGeneralDao.add96(documentoTareaAdjunto);
	}

	private void addOrUpdateTipoFicheroBoeInforme(DocumentosPostTraduccionBOE documentosPostTraduccionBOE) {
		if (this.documentosGeneralDao.updateIdFichero86(documentosPostTraduccionBOE) == Constants.CERO) {
			this.documentosGeneralDao.add86(documentosPostTraduccionBOE);
		}
	}

	private void addOrUpdateTipoFicheroBoeDocumento(DocumentosPostTraduccionBOE documentosPostTraduccionBOE) {
		if (this.documentosGeneralDao.updateIdDoc86(documentosPostTraduccionBOE) == Constants.CERO) {
			this.documentosGeneralDao.add86(documentosPostTraduccionBOE);
		}
	}

	private void addOrUpdateIdFichero(DatosTareaTrados datosTareaTrados) {
		if (this.datosTareaTradosDao.updateIdFichero(datosTareaTrados) == Constants.CERO) {
			this.datosTareaTradosDao.add(datosTareaTrados);
		}
	}

	private void addOrUpdateTipoFinal(DocumentoTareaAdjunto documentoTareaAdjunto) {
		if (this.documentosGeneralDao.updateIdFichero92(documentoTareaAdjunto) == Constants.CERO) {
			this.documentosGeneralDao.add92(documentoTareaAdjunto);
		}

	}

	@Override
	public Integer actualizarValorIndCorreccionesBOE(BigDecimal idTarea, String indCorrecciones) {
		if (Constants.CERO == this.documentosGeneralDao.actualizarValorIndCorreccionesBOE(idTarea, indCorrecciones)) {
			DocumentosPostTraduccionBOE docInsertar = new DocumentosPostTraduccionBOE();
			docInsertar.setIdTarea(idTarea);
			docInsertar.setIndCorreciones(indCorrecciones);
			this.documentosGeneralDao.add86(docInsertar);
		}
		return Constants.UNO;
	}

	@Override
	public Integer eliminarSoloFicheroFinal(BigDecimal idDocOriginal, BigDecimal idTarea) {
		DocumentoTarea filterDocumentoTarea = new DocumentoTarea();
		filterDocumentoTarea.setIdTarea(idTarea);
		DocumentosExpediente docOriginal = new DocumentosExpediente();
		docOriginal.setIdDoc(idDocOriginal);
		filterDocumentoTarea.setDocumentoOriginal(docOriginal);
		DocumentoTarea documentoTarea = this.tareasGeneralService.findRegTraduccionRevision(filterDocumentoTarea);
		// anyadimos el oid a la tabla A0
		this.oidsAuxiliarDao.add(documentoTarea.getDocumentoAdjunto().getOid());
		int resul = 0;
		this.documentosGeneralDao.remove87WithIdFicheroTraducido(documentoTarea.getDocumentoAdjunto().getIdFichero());
		this.documentosGeneralDao.remove(documentoTarea.getDocumentoAdjunto().getIdFichero());
		return resul;
	}

	@Override
	public Boolean oidEstaEn88OEn56(String oid) {
		return this.documentosGeneralDao.oidEstaEn88OEn56(oid);
	}

	@Override
	public DocumentoTareaAdjunto updateD1(DocumentoTareaAdjunto docTarea) {
		return this.documentosGeneralDao.updateD1(docTarea);
	}

	@Override
	public boolean isRowCreatedD1(BigDecimal idTarea) {
		return this.documentosGeneralDao.isRowCreatedD1(idTarea);
	}

	@Override
	public DocumentoTareaAdjunto addD1(DocumentoTareaAdjunto docTarea) {
		return this.documentosGeneralDao.addD1(docTarea);
	}

	@Override
	@Transactional(rollbackFor = Throwable.class)
	public Integer eliminarDocumentoSalidaTareaTrabajo(BigDecimal idFichero, BigDecimal idTarea, String oid) {
		Integer ret = 0;
		// anyadir a tabla A0
		this.oidsAuxiliarDao.add(oid);
		// Borro registro de la D1 por idFichero
		ret = this.documentosGeneralDao.removeD1(idTarea, idFichero);
		// Borro registro de la 88 por IdFichero
		this.documentosGeneralDao.remove(idFichero);

		return ret;
	}

	@Override
	public List<DocumentoTareaAdjunto> obtenerDocsXliffDeExpediente(DocumentosExpediente filter){
		Tareas tareaFilter = new Tareas();
		tareaFilter.setAnyo(filter.getAnyo());
		tareaFilter.setNumExp(filter.getNumExp());
		Tareas docTarea = this.tareasDao.obtenerUltimaTareaEjecutadaConDocXliff(tareaFilter);
		if (docTarea != null) {
			return this.documentosGeneralDao.obtenerDocsXliffDeTarea(docTarea);
		}
		return Collections.emptyList();

	}


}