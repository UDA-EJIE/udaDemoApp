package com.ejie.aa79b.service;

import java.util.LinkedHashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;

import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.support.ReloadableResourceBundleMessageSource;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.dao.ContactoExcepFactDao;
import com.ejie.aa79b.dao.ExcepcionFacturacionDao;
import com.ejie.aa79b.dao.GenericoDao;
import com.ejie.aa79b.dao.RegistroAccionesDao;
import com.ejie.aa79b.dao.SolicitanteDao;
import com.ejie.aa79b.model.ContactoExcepFact;
import com.ejie.aa79b.model.ExcepcionFacturacion;
import com.ejie.aa79b.model.RegistroAcciones;
import com.ejie.aa79b.model.Solicitante;
import com.ejie.aa79b.model.enums.TipoExcepcionEnum;
import com.ejie.aa79b.utils.Utils;
import com.ejie.x38.dto.JQGridRequestDto;
import com.ejie.x38.dto.JQGridResponseDto;
import com.ejie.x38.dto.TableRowDto;

/**
 * ExcepcionFacturacionServiceImpl generated by UDA, 29-ene-2018 12:16:09.
 * 
 * @author UDA
 */

@Service(value = "excepcionFacturacionService")
public class ExcepcionFacturacionServiceImpl extends GenericoServiceImpl<ExcepcionFacturacion>
		implements ExcepcionFacturacionService {

	private static final String LABPORCENTAJE = "label.porcentajeFactAplica";
	private static final String LABID = "label.id";
	private static final String LABENTASOC = "label.entidadAsociada";
	private static final String LABCONTACTO = "label.contacto";

	@Autowired
	private ExcepcionFacturacionDao excepcionFacturacionDao;
	@Autowired
	private ContactoExcepFactDao contactoExcepFactDao;
	@Autowired()
	private RegistroAccionesDao registroAccionesDao;
	@Autowired()
	private ReloadableResourceBundleMessageSource msg;
	@Autowired
	private SolicitanteDao solicitanteDao;

	@Override
	protected GenericoDao<ExcepcionFacturacion> getDao() {
		return this.excepcionFacturacionDao;
	}

	/**
	 * Inserts a single row in the ExcepcionFacturacion table.
	 *
	 * @param excepcionFacturacion
	 *            ExcepcionFacturacion
	 * @return ExcepcionFacturacion
	 */
	@Override
	@Transactional(rollbackFor = Throwable.class)
	public ExcepcionFacturacion add(ExcepcionFacturacion excepcionFacturacion) {
		ExcepcionFacturacion excepcionFacturacionAux = this.excepcionFacturacionDao.add(excepcionFacturacion);

		excepcionFacturacion.getContacto().setDni(excepcionFacturacion.getDniContacto036());
		excepcionFacturacion.setContacto(this.solicitanteDao.find(excepcionFacturacion.getContacto()));
		this.solicitanteDao.guardarFoto(excepcionFacturacion.getContacto());

		ContactoExcepFact contactoExcepFact;
		Solicitante contactoAux = new Solicitante();
		for (int x = 0; x < excepcionFacturacion.getPersonasSolicitantes().size(); x++) {
			// Inserts en la 37 ( ¿con foto? )
			contactoExcepFact = excepcionFacturacion.getPersonasSolicitantes().get(x);
			contactoExcepFact.setIdExcepcion037(excepcionFacturacion.getId036());
			this.contactoExcepFactDao.add(contactoExcepFact);
			contactoAux.setDni(contactoExcepFact.getDniTrabajador037());
			this.solicitanteDao.guardarFoto(this.solicitanteDao.find(contactoAux));
		}

		// Registro de acciones...
		RegistroAcciones regAcciones = new RegistroAcciones();
		regAcciones.setIdPuntoMenu(Constants.PUNTO_MENU_DATOS_FACTURACION);
		regAcciones.setIdAccion(Constants.ACCION_ALTA);
		Locale locale = new Locale(Constants.LANG_EUSKERA);

		StringBuilder observ = new StringBuilder();
		observ.append(this.msg.getMessage("label.excepcion.crearExcepcion", null, locale)).append(" - ");
		observ.append(this.msg.getMessage(LABID, null, locale)).append(": ").append(excepcionFacturacionAux.getId036())
				.append(": \n");
		observ.append(this.msg.getMessage(LABENTASOC, null, locale)).append(": ");
		observ.append(excepcionFacturacionAux.getTipoEntidadAsoc036()).append(" ");
		observ.append(excepcionFacturacionAux.getIdEntidadAsoc036()).append(": \n");
		observ.append(this.msg.getMessage(LABCONTACTO, null, locale)).append(": ")
				.append(excepcionFacturacionAux.getDniContacto036()).append(": \n");
		observ.append(this.msg.getMessage(LABPORCENTAJE, null, locale)).append(": ")
				.append(excepcionFacturacionAux.getPorFactura036()).append(": \n");
		regAcciones.setObserv(observ.toString());
		this.registroAccionesDao.add(regAcciones);

		return excepcionFacturacionAux;
	}

	/**
	 * Updates a single row in the ExcepcionFacturacion table.
	 *
	 * @param excepcionFacturacion
	 *            ExcepcionFacturacion
	 * @return ExcepcionFacturacion
	 */
	@Override
	@Transactional(rollbackFor = Throwable.class)
	public ExcepcionFacturacion update(ExcepcionFacturacion excepcionFacturacion) {

		ExcepcionFacturacion original = this.excepcionFacturacionDao.find(excepcionFacturacion);
		this.excepcionFacturacionDao.update(excepcionFacturacion);

		excepcionFacturacion.getContacto().setDni(excepcionFacturacion.getDniContacto036());
		excepcionFacturacion.setContacto(this.solicitanteDao.find(excepcionFacturacion.getContacto()));
		this.solicitanteDao.guardarFoto(excepcionFacturacion.getContacto());

		this.contactoExcepFactDao.borraTodosPorIdExcepcion(excepcionFacturacion.getId036());
		ContactoExcepFact contactoExcepFact;
		Solicitante contactoAux = new Solicitante();
		for (int x = 0; x < excepcionFacturacion.getPersonasSolicitantes().size(); x++) {
			// Inserts en la 37 ( ¿con foto? )
			contactoExcepFact = excepcionFacturacion.getPersonasSolicitantes().get(x);
			contactoExcepFact.setIdExcepcion037(excepcionFacturacion.getId036());
			this.contactoExcepFactDao.add(contactoExcepFact);
			contactoAux.setDni(contactoExcepFact.getDniTrabajador037());
			this.solicitanteDao.guardarFoto(this.solicitanteDao.find(contactoAux));
		}

		RegistroAcciones regAcciones = new RegistroAcciones();
		regAcciones.setIdPuntoMenu(Constants.PUNTO_MENU_DATOS_FACTURACION);
		regAcciones.setIdAccion(Constants.ACCION_MODIFICACION);

		Map<String, String> paramRegAcciones = new LinkedHashMap<String, String>();
		paramRegAcciones.put("tipoEntidadAsoc036", "label.tipoEntidad");
		paramRegAcciones.put("idEntidadAsoc036", LABENTASOC);
		paramRegAcciones.put("dniContacto036", LABCONTACTO);
		paramRegAcciones.put("porFactura036", LABPORCENTAJE);

		Locale locale = new Locale(Constants.LANG_EUSKERA);
		String aux = Utils.observacionesRegistro(excepcionFacturacion, original, paramRegAcciones, this.msg, locale);
		if (StringUtils.isNotBlank(aux)) {
			StringBuilder observ = new StringBuilder();
			observ.append(this.msg.getMessage(LABID, null, locale)).append(": ").append(original.getId036())
					.append(" - ");
			observ.append(this.msg.getMessage("mensaje.excepcionModificada", null, locale)).append(":\n ");
			observ.append(aux);
			regAcciones.setObserv(observ.toString());
			this.registroAccionesDao.add(regAcciones);
		}

		return excepcionFacturacion;
	}

	/**
	 * Deletes a single row in the ExcepcionFacturacion table.
	 *
	 * @param excepcionFacturacion
	 *            ExcepcionFacturacion
	 */
	@Override
	@Transactional(rollbackFor = Throwable.class)
	public void remove(ExcepcionFacturacion excepcionFacturacion) {

		this.contactoExcepFactDao.borraTodosPorIdExcepcion(excepcionFacturacion.getId036());

		ExcepcionFacturacion excepcionFacturacionAux = this.excepcionFacturacionDao.find(excepcionFacturacion);
		this.excepcionFacturacionDao.remove(excepcionFacturacion);

		// Registro de acciones...
		RegistroAcciones regAcciones = new RegistroAcciones();
		regAcciones.setIdPuntoMenu(Constants.PUNTO_MENU_DATOS_FACTURACION);
		regAcciones.setIdAccion(Constants.ACCION_BORRADO);
		Locale locale = new Locale(Constants.LANG_EUSKERA);

		StringBuilder observ = new StringBuilder();
		observ.append(this.msg.getMessage("mensaje.excepcionesEliminadas", null, locale)).append(" - ");
		observ.append(excepcionFacturacionAux.getTipoEntidad036()).append(" ")
				.append(excepcionFacturacionAux.getIdEntidad036()).append(" ");
		regAcciones.setObserv(observ.toString());
		this.registroAccionesDao.add(regAcciones);
	}

	/**
	 * Filter method in the T table.
	 *
	 * @param filter
	 *            T
	 * @param jqGridRequestDto
	 *            JQGridRequestDto
	 * @param startsWith
	 *            Boolean
	 * @return JQGridResponseDto<T>
	 */
	@Override
	public JQGridResponseDto<ExcepcionFacturacion> filtroConJoinsConcatenado(ExcepcionFacturacion filter,
			JQGridRequestDto jqGridRequestDto, Boolean startsWith) {

		List<ExcepcionFacturacion> listaT = this.excepcionFacturacionDao.filtroConJoinsConcatenado(filter,
				jqGridRequestDto, false);
		Long recordNum = this.excepcionFacturacionDao.filtroConJoinsConcatenadoCount(filter, false);

		if (jqGridRequestDto.getMultiselection().getSelectedIds() != null) {
			List<TableRowDto<ExcepcionFacturacion>> reorderSelection = this.getDao().reorderSelection(filter,
					jqGridRequestDto, startsWith);
			return new JQGridResponseDto<ExcepcionFacturacion>(jqGridRequestDto, recordNum, listaT, reorderSelection);
		}
		return new JQGridResponseDto<ExcepcionFacturacion>(jqGridRequestDto, recordNum, listaT);
	}

	/**
	 * validarExcepcionNueva.
	 *
	 * @param excepcionFacturacion
	 *            ExcepcionFacturacion
	 * @return vuelta int 0 - no hay errores 1- ya existe excepción para esa
	 *         entidad y contacto a facturar 2- El sumatorio excede de 100% 3-
	 *         Contacto solicitante ya está en otra excepción
	 */
	@Override
	public int validarExcepcionNueva(ExcepcionFacturacion excepcionFacturacion) {
		int vuelta = 0;

		if ((excepcionFacturacion.getIdEntidadAsoc036() != null) && (excepcionFacturacion.getDniContacto036() != null)
				&& (excepcionFacturacion.getPorFactura036() != null)) {

			// Comprobación de entidad y usuario activos...
			if (this.solicitanteDao.comprobarEntidadYSolicitanteValidos(excepcionFacturacion.getTipoEntidadAsoc036(),
					excepcionFacturacion.getIdEntidadAsoc036(), excepcionFacturacion.getDniContacto036()) == 0) {
				vuelta = 4;
			} else {
				vuelta = validarExcepcionNuevaRestoTipos(excepcionFacturacion, vuelta);
			}
		} else {
			vuelta = 0;
			// Si no hay datos, pq es un alta y los campos están
			// vacios, para que salte la validación de campos
		}
		return vuelta;

	}

	/**
	 * @param excepcionFacturacion
	 * @param vuelta
	 * @return
	 */
	private int validarExcepcionNuevaRestoTipos(ExcepcionFacturacion excepcionFacturacion, int vuelta) {
		int vuelta2 = vuelta;
		ExcepcionFacturacion excepcionFacturacionAux = new ExcepcionFacturacion();

		excepcionFacturacionAux.setTipoExcepcion036(excepcionFacturacion.getTipoExcepcion036());
		excepcionFacturacionAux.setTipoEntidad036(excepcionFacturacion.getTipoEntidad036());
		excepcionFacturacionAux.setIdEntidad036(excepcionFacturacion.getIdEntidad036());
		excepcionFacturacionAux.setTipoEntidadAsoc036(excepcionFacturacion.getTipoEntidadAsoc036());
		excepcionFacturacionAux.setIdEntidadAsoc036(excepcionFacturacion.getIdEntidadAsoc036());
		excepcionFacturacionAux.setDniContacto036(excepcionFacturacion.getDniContacto036());

		List<ExcepcionFacturacion> listaExcepcionFacturacion = this.excepcionFacturacionDao
				.findAll(excepcionFacturacionAux, null);

		if ((listaExcepcionFacturacion.isEmpty())
				|| (excepcionFacturacion.getId036() == listaExcepcionFacturacion.get(0).getId036())) {

			excepcionFacturacionAux.setTipoEntidadAsoc036(null);
			excepcionFacturacionAux.setIdEntidadAsoc036(null);
			excepcionFacturacionAux.setDniContacto036(null);
			if (excepcionFacturacion.getId036() != null) {
				excepcionFacturacionAux.setId036(excepcionFacturacion.getId036());
			}
			vuelta2 = validarExcepcionPorTipo(excepcionFacturacion, vuelta, excepcionFacturacionAux);

		} else {
			vuelta2 = 1;
		}
		return vuelta2;
	}

	/**
	 * @param excepcionFacturacion
	 * @param vuelta
	 * @param excepcionFacturacionAux
	 * @return
	 */
	private int validarExcepcionPorTipo(ExcepcionFacturacion excepcionFacturacion, int vuelta,
			ExcepcionFacturacion excepcionFacturacionAux) {
		int v = vuelta;
		if (Integer.parseInt(TipoExcepcionEnum.PORENTIDAD.getValue()) == excepcionFacturacionAux
				.getTipoExcepcion036()) {
			// para excepciones de TIPO "ENTIDAD SOLICITANTE" (suma de
			// porcentajes no puede superar 100)
			int sumatorio = this.excepcionFacturacionDao.sumatorioPorcentajesExcepEntidad(excepcionFacturacionAux);
			if (sumatorio + excepcionFacturacion.getPorFactura036() > 100) {
				v = 2;
			}
		} else {
			// para excepciones de TIPO "CONTACTO SOLICITANTE" (el/los contacto
			// solicitante no pueden estar en otra excepción)
			if ((excepcionFacturacion.getPersonasSolicitantes() != null)
					&& (!excepcionFacturacion.getPersonasSolicitantes().isEmpty())) {
				excepcionFacturacionAux.setPersonasSolicitantes(excepcionFacturacion.getPersonasSolicitantes());
				int contactosDuplicados = this.excepcionFacturacionDao
						.validarContactoSolicDuplicado(excepcionFacturacionAux);
				if (contactosDuplicados > 0) {
					v = 3;
				}
			}

		}
		return v;
	}

}
