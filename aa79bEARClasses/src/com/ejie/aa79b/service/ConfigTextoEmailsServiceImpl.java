package com.ejie.aa79b.service;
import java.util.HashMap;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;

import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.support.ReloadableResourceBundleMessageSource;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.dao.ConfigDireccionEmailDao;
import com.ejie.aa79b.dao.ConfigTextoEmailsDao;
import com.ejie.aa79b.dao.GenericoDao;
import com.ejie.aa79b.dao.RegistroAccionesDao;
import com.ejie.aa79b.model.ConfigDireccionEmail;
import com.ejie.aa79b.model.ConfigTextoEmails;
import com.ejie.aa79b.model.DatosBasicos;
import com.ejie.aa79b.model.RegistroAcciones;
import com.ejie.aa79b.utils.Utils;

/**
 * ConfigTextoEmailsServiceImpl generated by UDA, 05-dic-2017 15:17:18.
 * @author UDA
 */

@Service(value = "configTextoEmailsService")
public class ConfigTextoEmailsServiceImpl extends GenericoServiceImpl<ConfigTextoEmails> implements ConfigTextoEmailsService {

	@Autowired()
	private ConfigTextoEmailsDao configTextoEmailsDao;
	@Autowired()
	private ConfigDireccionEmailDao configDireccionEmailDao;
	@Autowired()
	private RegistroAccionesDao registroAccionesDao;
    @Autowired()
    private ReloadableResourceBundleMessageSource msg;

	@Override()
	protected GenericoDao<ConfigTextoEmails> getDao() {
		return this.configTextoEmailsDao;
	}

	@Override()
	@Transactional(rollbackFor = Throwable.class)
	public DatosBasicos update(DatosBasicos datosBasicos) {
		ConfigDireccionEmail original = this.configDireccionEmailDao.find(datosBasicos.getConfigDireccionEmail());
		this.configDireccionEmailDao.update(datosBasicos.getConfigDireccionEmail());

		ConfigDireccionEmail originalInterpretacion = this.configDireccionEmailDao.find(datosBasicos.getConfigDireccionEmailInterpretacion());
		this.configDireccionEmailDao.update(datosBasicos.getConfigDireccionEmailInterpretacion());

		List<ConfigTextoEmails> avisos = this.configTextoEmailsDao.findAll(new ConfigTextoEmails(), null);
		for (ConfigTextoEmails configTextoEmails : datosBasicos.getTextoEmails()) {
			this.configTextoEmailsDao.update(configTextoEmails);
		}
		Boolean insertar = false;
		RegistroAcciones reg = new RegistroAcciones();
		reg.setIdPuntoMenu(Constants.PUNTO_MENU_DATOS_BASICOS);
		reg.setIdAccion(Constants.ACCION_MODIFICACION);
		Map<String, String> parametros = new LinkedHashMap<String, String>();
		parametros.put("dirEmail", "label.remitente");
		Locale locale = new Locale(Constants.LANG_EUSKERA);
		String aux = Utils.observacionesRegistro(datosBasicos.getConfigDireccionEmail(), original, parametros, this.msg, locale);
		StringBuilder observ = new StringBuilder();

		if (StringUtils.isNotBlank(aux)) {
			observ.append(this.msg.getMessage("label.configEmailsAviso", null, locale)).append("\n");
			observ.append(aux);
			insertar = true;
		}
		Map<String, String> parametrosInterpretacion = new LinkedHashMap<String, String>();
		parametrosInterpretacion.put("dirEmail", "label.emailAvisosInterpretacion");
		String auxInterpretacion = Utils.observacionesRegistro(datosBasicos.getConfigDireccionEmailInterpretacion(), originalInterpretacion, parametrosInterpretacion, this.msg, locale);

		if (StringUtils.isNotBlank(auxInterpretacion)) {
			observ.append(auxInterpretacion);
			insertar = true;
		}
		//Pasamos la lista actual de avisos a un mapa para poder comparar más fácilmente
		Map<Integer, ConfigTextoEmails> mapaAvisos = new HashMap<Integer, ConfigTextoEmails>();
		for (ConfigTextoEmails configTextoEmails : datosBasicos.getTextoEmails()) {
			mapaAvisos.put(configTextoEmails.getId(), configTextoEmails);
		}

		StringBuilder strAvisos = new StringBuilder();
		for (ConfigTextoEmails configTextoEmails : avisos) {
			if (!configTextoEmails.equals(mapaAvisos.get(configTextoEmails.getId()))) {
				strAvisos.append(configTextoEmails.getTipoAviso().getDescEu()).append("\n");
				insertar = true;
			}
		}
		if (strAvisos.length() > 0) {
			observ.append(this.msg.getMessage("mensaje.avisosModificados", null, locale)).append("\n");
			observ.append(strAvisos);
		}
		reg.setObserv(observ.toString());
		if (insertar) {
			this.registroAccionesDao.add(reg);
		}

		return datosBasicos;
	}

}

