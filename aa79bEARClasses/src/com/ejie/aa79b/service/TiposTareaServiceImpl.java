package com.ejie.aa79b.service;

import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;

import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.support.ReloadableResourceBundleMessageSource;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.common.PropertiesConstants;
import com.ejie.aa79b.dao.ExpedienteDao;
import com.ejie.aa79b.dao.GenericoDao;
import com.ejie.aa79b.dao.GestorExpedienteDao;
import com.ejie.aa79b.dao.PropiedadDao;
import com.ejie.aa79b.dao.RegistroAccionesDao;
import com.ejie.aa79b.dao.TareasDao;
import com.ejie.aa79b.dao.TiposTareaDao;
import com.ejie.aa79b.model.Expediente;
import com.ejie.aa79b.model.Propiedad;
import com.ejie.aa79b.model.RegistroAcciones;
import com.ejie.aa79b.model.TiposTarea;
import com.ejie.aa79b.model.enums.EstadoExpedienteEnum;
import com.ejie.aa79b.model.enums.TipoExpedienteEnum;
import com.ejie.aa79b.utils.Utils;

/**
 * TiposTareaServiceImpl generated by UDA, 28-nov-2017 9:50:00.
 * 
 * @author UDA
 */

@Service(value = "tiposTareaService")
public class TiposTareaServiceImpl extends GenericoServiceImpl<TiposTarea> implements TiposTareaService {

	@Autowired
	private TiposTareaDao tiposTareaDao;

	@Autowired
	private RegistroAccionesDao registroAccionesDao;

	@Autowired
	private PropiedadDao propiedadDao;

	@Autowired
	private GestorExpedienteDao gestorExpedienteDao;

	@Autowired
	private ExpedienteDao expedienteDao;

	@Autowired
	private TareasDao tareasDao;

	@Autowired()
	private ReloadableResourceBundleMessageSource msg;

	@Override
	protected GenericoDao<TiposTarea> getDao() {
		return this.tiposTareaDao;
	}

	@Override()
	@Transactional(rollbackFor = Throwable.class)
	public TiposTarea update(TiposTarea bean) {
		TiposTarea original = this.tiposTareaDao.find(bean);
		this.tiposTareaDao.update(bean);

		RegistroAcciones regTiposTarea = new RegistroAcciones();
		regTiposTarea.setIdPuntoMenu(Constants.PUNTO_MENU_TIPOS_TAREA);
		regTiposTarea.setIdAccion(Constants.ACCION_MODIFICACION);
		Map<String, String> paramTiposTarea = new LinkedHashMap<String, String>();
		paramTiposTarea.put("estado015", "label.estado");

		Locale locale = new Locale(Constants.LANG_EUSKERA);
		String aux = Utils.observacionesRegistro(bean, original, paramTiposTarea, this.msg, locale);
		if (StringUtils.isNotBlank(aux)) {
			StringBuilder observ = new StringBuilder();
			observ.append(original.getDescEu015()).append(" (id=").append(original.getId015()).append("): \n");
			observ.append(aux);
			regTiposTarea.setObserv(observ.toString());
			this.registroAccionesDao.add(regTiposTarea);
		}
		return bean;
	}

	@Override
	public List<TiposTarea> findTiposTareaManuales(Expediente expediente) {
		List<TiposTarea> listTiposTarea = new ArrayList<TiposTarea>();

		Propiedad propiedad = new Propiedad();
		propiedad.setId(PropertiesConstants.COD_ENTIDAD_BOE);

		Propiedad propiedadRst = this.propiedadDao.find(propiedad);

		Expediente expedienteRst = this.gestorExpedienteDao.find(expediente);

		boolean correspondeBOE = this.isPropiedadValida(propiedadRst) && this.isCodigoEntidadValido(expedienteRst)
				&& propiedadRst.getValor()
						.equals(expedienteRst.getGestorExpediente().getEntidad().getCodigo().toString());

		Expediente exp = this.expedienteDao.find(expediente);

		boolean isCorredaccion = isExpedienteCorredaccion(exp);
		boolean isExpCerrado = isExpedienteCerrado(exp);

		// comprobamos si hay una tarea de no conformidad de cliente sin responder
		boolean noConfSinResponer = false;
		if (this.tareasDao.countTareasNoConfClienteSinEjec(expediente) > 0) {
			noConfSinResponer = true;
		}

		listTiposTarea = this.tiposTareaDao.findTiposTareaManuales(expediente.getIdTipoExpediente(), correspondeBOE,
				isCorredaccion, isExpCerrado, noConfSinResponer);

		return listTiposTarea;
	}

	@Override
	public List<TiposTarea> getTipoTareaPorTipoExpediente(Expediente expediente) {
		return this.tiposTareaDao.getTipoTareaPorTipoExpediente(expediente);
	}

	@Override
	public TiposTarea getTipoTareaPorIdTarea(BigDecimal idTarea) {
		return this.tiposTareaDao.getTipoTareaPorIdTarea(idTarea);
	}

	/**
	 * @param expediente
	 * @return boolean
	 */
	private boolean isExpedienteCorredaccion(Expediente expediente) {
		boolean isCorredaccion = false;

		if (TipoExpedienteEnum.TRADUCCION.getValue().equals(expediente.getIdTipoExpediente())
				&& expediente.getExpedienteTradRev() != null) {
			isCorredaccion = Constants.SI.equals(expediente.getExpedienteTradRev().getIndCorredaccion());
		}
		return isCorredaccion;
	}

	/**
	 * @param expediente
	 * @return boolean
	 */
	private boolean isExpedienteCerrado(Expediente expediente) {
		return isEstadoFaseExpNoNulo(expediente)
				&& EstadoExpedienteEnum.CERRADO.getValue() == expediente.getBitacoraExpediente().getEstadoExp().getId();
	}

	/**
	 * @param expediente
	 * @return
	 */
	private boolean isEstadoFaseExpNoNulo(Expediente expediente) {
		return expediente.getBitacoraExpediente() != null && expediente.getBitacoraExpediente().getEstadoExp() != null
				&& expediente.getBitacoraExpediente().getFaseExp() != null;
	}

	/**
	 * @param propiedadRst
	 * @return boolean
	 */
	private boolean isPropiedadValida(Propiedad propiedadRst) {
		return propiedadRst != null && propiedadRst.getValor() != null;
	}

	/**
	 * @param expedienteRst
	 * @return boolean
	 */
	private boolean isCodigoEntidadValido(Expediente expedienteRst) {
		return expedienteRst != null && expedienteRst.getGestorExpediente() != null
				&& expedienteRst.getGestorExpediente().getEntidad() != null
				&& expedienteRst.getGestorExpediente().getEntidad().getCodigo() != null;
	}

}
