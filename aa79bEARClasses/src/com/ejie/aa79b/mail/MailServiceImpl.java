package com.ejie.aa79b.mail;

import java.io.InputStream;
import java.io.UnsupportedEncodingException;
import java.nio.ByteBuffer;
import java.nio.CharBuffer;
import java.nio.charset.Charset;
import java.util.List;
import java.util.Locale;
import java.util.Map;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.support.ReloadableResourceBundleMessageSource;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.stereotype.Service;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.common.CustomMimeMessagePreparator;
import com.ejie.aa79b.model.ConfigDireccionEmail;
import com.ejie.aa79b.model.ConfigTextoEmails;
import com.ejie.aa79b.model.ParametrosEmail;
import com.ejie.aa79b.service.ConfigDireccionEmailService;
import com.ejie.aa79b.service.ConfigTextoEmailsService;
import com.ejie.aa79b.utils.Utils;

/**
 * OrdenPreciosServiceImpl generated by UDA, 15-dic-2017 14:11:45.
 *
 * @author UDA
 */
@Service(value = "mailService")
public class MailServiceImpl implements MailService {

	@Autowired()
	private JavaMailSender mailSender;
	@Autowired()
	private ConfigDireccionEmailService configDireccionEmailService;
	@Autowired()
	private ConfigTextoEmailsService configtextoEmailsService;
	@Autowired()
	private ReloadableResourceBundleMessageSource appMessageSource;

	private static final Logger LOGGER = LoggerFactory.getLogger(MailServiceImpl.class);
	private static final String UTF_8 = "UTF-8";
	private static final String LATIN1 = "ISO-8859-1";

	@Override()
	public void sendMailWithParameters(int idTipoAviso, List<String> listaDestinatarios,
			ParametrosEmail parametrosEmail) {
		this.mailSender.send(this.getMensaje(idTipoAviso, listaDestinatarios, parametrosEmail));
	}

	private CustomMimeMessagePreparator getMensaje(int idTipoAviso, List<String> listaDestinatarios,
			ParametrosEmail parametrosEmail) {

		// Se obtiene el remitente
		ConfigDireccionEmail bean = new ConfigDireccionEmail(Constants.CERO);
		bean = this.configDireccionEmailService.find(bean);

		// Se obtiene el mensaje
		ConfigTextoEmails configTextoEmails = new ConfigTextoEmails();
		configTextoEmails.setId(idTipoAviso);
		configTextoEmails = this.configtextoEmailsService.find(configTextoEmails);

		// Plantilla de correo electrónico
		InputStream plantillaHtml;

		plantillaHtml = MailServiceImpl.class.getResourceAsStream("/mail/plantillaMail.txt");

		String strPlantillaHtml = Utils.convertStreamToString(plantillaHtml);

		Charset utf8charset = Charset.forName(LATIN1);
		Charset iso88591charset = Charset.forName(LATIN1);
		CharBuffer decodedMsg = iso88591charset.decode(ByteBuffer.wrap(strPlantillaHtml.getBytes()));
		ByteBuffer encodedMsg = utf8charset.encode(decodedMsg);
		String utfMsg = new String(encodedMsg.array());

		// Definición del mensaje
		utfMsg = utfMsg.replace("{TITLE}", "");
		utfMsg = utfMsg.replace("{LEGEND}", "");

		StringBuilder messageEu = new StringBuilder();
		StringBuilder messageEs = new StringBuilder();

		if (configTextoEmails != null) {
			messageEu.append(this.getParameterValue(configTextoEmails.getTextoMailEu()));
			messageEs.append(this.getParameterValue(configTextoEmails.getTextoMailEs()));
		}
		if (parametrosEmail != null) {
			messageEu.append(this.ObtenerInfoAdic(parametrosEmail.getInfoEu()));
			messageEs.append(this.ObtenerInfoAdic(parametrosEmail.getInfoEs()));
		}

		utfMsg = utfMsg.replace("{MESSAGE_EU}", messageEu.toString());
		utfMsg = utfMsg.replace("{MESSAGE_ES}", messageEs.toString());

		CustomMimeMessagePreparator mensaje = new CustomMimeMessagePreparator();
		mensaje.setRemitente(bean.getDirEmail());
		mensaje.setAsunto("");
		if (configTextoEmails != null && parametrosEmail != null) {
			String preAsunto = parametrosEmail.getAnyoNumExpediente()!= null?parametrosEmail.getAnyoNumExpediente():(parametrosEmail.getNumTrabajo()!=null?parametrosEmail.getNumTrabajo():"");
			mensaje.setAsunto(preAsunto + " - "
					+ configTextoEmails.getAsuntoEu().toUpperCase() + " / " + configTextoEmails.getAsuntoEs());
		}
		mensaje.getDestinatarios().clear();
		mensaje.setDestinatarios(listaDestinatarios);
		mensaje.setTexto(utfMsg);


		MailServiceImpl.LOGGER.debug("-------- >ENVIO DE EMAIL");
		MailServiceImpl.LOGGER.debug("-------- >Asunto mensaje" + mensaje.getAsunto());
		MailServiceImpl.LOGGER.debug("-------- >Cuerpo mensaje" + utfMsg);

		return mensaje;
	}

	@Override()
	public void sendMailWithParametersEliminacion(int idTipoAviso, List<String> listaDestinatarios,
			ParametrosEmail parametrosEmail) {
		this.mailSender.send(this.getMensajeEliminacion(idTipoAviso, listaDestinatarios, parametrosEmail));
	}

	private CustomMimeMessagePreparator getMensajeEliminacion(int idTipoAviso, List<String> listaDestinatarios,
			ParametrosEmail parametrosEmail) {

		// Se obtiene el remitente
		ConfigDireccionEmail bean = new ConfigDireccionEmail(Constants.CERO);
		bean = this.configDireccionEmailService.find(bean);

		// Se obtiene el mensaje
		ConfigTextoEmails configTextoEmails = new ConfigTextoEmails();
		configTextoEmails.setId(idTipoAviso);
		configTextoEmails = this.configtextoEmailsService.find(configTextoEmails);

		// Plantilla de correo electrónico
		InputStream plantillaHtml;

		plantillaHtml = MailServiceImpl.class.getResourceAsStream("/mail/plantillaMail.txt");

		String strPlantillaHtml = Utils.convertStreamToString(plantillaHtml);

		Charset utf8charset = Charset.forName(LATIN1);
		Charset iso88591charset = Charset.forName(LATIN1);
		CharBuffer decodedMsg = iso88591charset.decode(ByteBuffer.wrap(strPlantillaHtml.getBytes()));
		ByteBuffer encodedMsg = utf8charset.encode(decodedMsg);
		String utfMsg = new String(encodedMsg.array());

		// Definición del mensaje
		utfMsg = utfMsg.replace("{TITLE}", "");
		utfMsg = utfMsg.replace("{LEGEND}", "");

		StringBuilder asunto = new StringBuilder();
		StringBuilder messageEu = new StringBuilder();
		StringBuilder messageEs = new StringBuilder();

		String codAplic = "";
		String observaciones = "";
		try {
			codAplic = new String(this.getParameterValue(parametrosEmail.getInfoEs().get(Constants.LABEL_COD_APLIC)).getBytes(UTF_8), LATIN1);
			observaciones = new String(this.getParameterValue(parametrosEmail.getInfoEs().get(Constants.LABEL_OBSERVACIONES)).getBytes(UTF_8), LATIN1);
		} catch (UnsupportedEncodingException e) {
			MailServiceImpl.LOGGER.info("Excepcion adaptando el charset de los parametros del email", e);
		}

		Locale localeEu = new Locale(Constants.LANG_EUSKERA);

		asunto.append(parametrosEmail.getAnyoNumExpediente() + " " + configTextoEmails.getAsuntoEu() + " / "
		+ parametrosEmail.getAnyoNumExpediente() + " " + configTextoEmails.getAsuntoEs());
		messageEu.append(codAplic + " aplikaziotik " + parametrosEmail.getAnyoNumExpediente()
		+ " " + configTextoEmails.getTextoMailEu() + ": " + observaciones);
		messageEs.append("Desde la aplicaci&oacute;n " + codAplic + " " + configTextoEmails.getTextoMailEs() + " " + parametrosEmail.getAnyoNumExpediente()
		+ ", por las siguientes razones: " + observaciones);

		utfMsg = utfMsg.replace("{MESSAGE_EU}", messageEu.toString());
		utfMsg = utfMsg.replace("{MESSAGE_ES}", messageEs.toString());

		CustomMimeMessagePreparator mensaje = new CustomMimeMessagePreparator();
		mensaje.setRemitente(bean.getDirEmail());
		mensaje.setAsunto(asunto.toString());
		mensaje.getDestinatarios().clear();
		mensaje.setDestinatarios(listaDestinatarios);
		mensaje.setTexto(utfMsg);

		MailServiceImpl.LOGGER.debug("-------- >ENVIO DE EMAIL");
		MailServiceImpl.LOGGER.debug("-------- >Asunto mensaje" + mensaje.getAsunto());
		MailServiceImpl.LOGGER.debug("-------- >Cuerpo mensaje" + utfMsg);

		return mensaje;
	}

	private StringBuilder ObtenerInfoAdic(Map<String, String> info) {
		StringBuilder infoAdic = new StringBuilder();
		try {
			for (String key : info.keySet()) {
				infoAdic.append("<p class='info'><b>")
						.append(new String(this.getParameterValue(key).getBytes(UTF_8), LATIN1)).append("</b>");
				if (!key.equals(Constants.EMPTY)) {
					infoAdic.append(": ");
				}
				infoAdic.append(new String(this.getParameterValue(info.get(key)).getBytes(UTF_8), LATIN1))
						.append("</p>");
			}
		} catch (UnsupportedEncodingException e) {
			MailServiceImpl.LOGGER.info("Excepcion adaptando el charset de los parametros del email", e);
		}
		return infoAdic;

	}

	/**
	 * @param parametrosEmail
	 * @return
	 */
	public String getParameterValue(String parameterValue) {
		String rst;
		if (parameterValue != null) {
			rst = parameterValue;
		} else {
			rst = "";
		}
		return rst;
	}




	@Override()
	public void sendMailWithParametersTipoAviso(int idTipoAviso, List<String> listaDestinatarios, ParametrosEmail parametrosEmail) {
		this.mailSender.send(this.getMensajeAviso(idTipoAviso, listaDestinatarios, parametrosEmail));
	}

	private CustomMimeMessagePreparator getMensajeAviso(int idTipoAviso, List<String> listaDestinatarios,ParametrosEmail parametrosEmail) {

		// Se obtiene el remitente
		ConfigDireccionEmail bean = new ConfigDireccionEmail(Constants.CERO);
		bean = this.configDireccionEmailService.find(bean);

		// Se obtiene el mensaje
		ConfigTextoEmails configTextoEmails = new ConfigTextoEmails();
		configTextoEmails.setId(idTipoAviso);
		configTextoEmails = this.configtextoEmailsService.find(configTextoEmails);

		// Plantilla de correo electrónico
		InputStream plantillaHtml;

		plantillaHtml = MailServiceImpl.class.getResourceAsStream("/mail/plantillaMail.txt");

		String strPlantillaHtml = Utils.convertStreamToString(plantillaHtml);

		Charset utf8charset = Charset.forName(LATIN1);
		Charset iso88591charset = Charset.forName(LATIN1);
		CharBuffer decodedMsg = iso88591charset.decode(ByteBuffer.wrap(strPlantillaHtml.getBytes()));
		ByteBuffer encodedMsg = utf8charset.encode(decodedMsg);
		String utfMsg = new String(encodedMsg.array());

		// Definición del mensaje
		utfMsg = utfMsg.replace("{TITLE}", "");
		utfMsg = utfMsg.replace("{LEGEND}", "");

		StringBuilder asunto = new StringBuilder();
		StringBuilder messageEu = new StringBuilder();
		StringBuilder messageEs = new StringBuilder();

//		asunto.append(configTextoEmails.getAsuntoEu() + parametrosEmail.getAnyoNumExpediente() + " espedientean" + " / "
//		+ configTextoEmails.getAsuntoEs() + " " + parametrosEmail.getAnyoNumExpediente() );

//		messageEu.append( configTextoEmails.getTextoMailEu() + parametrosEmail.getAnyoNumExpediente()	+ " " +  " espedientera." + observaciones);
//		messageEs.append( configTextoEmails.getTextoMailEs() + " " + parametrosEmail.getAnyoNumExpediente()+ ".");
		//metiendo vble en la plantilla {{numExp}}

		asunto.append(configTextoEmails.getAsuntoEu().replace("{{numExp}}", parametrosEmail.getAnyoNumExpediente()) + " / "
				+ configTextoEmails.getAsuntoEs().replace("{{numExp}}", parametrosEmail.getAnyoNumExpediente()) );

		messageEu.append( configTextoEmails.getTextoMailEu().replace("{{numExp}}", parametrosEmail.getAnyoNumExpediente()) );
		messageEs.append( configTextoEmails.getTextoMailEs().replace("{{numExp}}", parametrosEmail.getAnyoNumExpediente()));

		utfMsg = utfMsg.replace("{MESSAGE_EU}", messageEu.toString());
		utfMsg = utfMsg.replace("{MESSAGE_ES}", messageEs.toString());

		CustomMimeMessagePreparator mensaje = new CustomMimeMessagePreparator();
		mensaje.setRemitente(bean.getDirEmail());
		mensaje.setAsunto(asunto.toString());
		mensaje.getDestinatarios().clear();
		mensaje.setDestinatarios(listaDestinatarios);
		mensaje.setTexto(utfMsg);

		MailServiceImpl.LOGGER.debug("-------- >ENVIO DE EMAIL");
		MailServiceImpl.LOGGER.debug("-------- >Asunto mensaje {}", mensaje.getAsunto());
		MailServiceImpl.LOGGER.debug("-------- >Cuerpo mensaje {}", utfMsg);

		return mensaje;
	}

}