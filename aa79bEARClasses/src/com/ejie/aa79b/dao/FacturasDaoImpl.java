package com.ejie.aa79b.dao;

import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;
import java.util.Locale;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.support.ReloadableResourceBundleMessageSource;
import org.springframework.dao.support.DataAccessUtils;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.common.DBConstants;
import com.ejie.aa79b.common.DaoConstants;
import com.ejie.aa79b.common.SqlUtils;
import com.ejie.aa79b.dao.mapper.Aa79bSalidaConsultaFacturasRowMapper;
import com.ejie.aa79b.dao.mapper.FacturasRowMapperConsulta;
import com.ejie.aa79b.dao.mapper.FacturasRowMapperDocumento;
import com.ejie.aa79b.dao.mapper.FacturasRowMapperExpFactInter;
import com.ejie.aa79b.dao.mapper.FacturasRowMapperExpFactTrad;
import com.ejie.aa79b.dao.mapper.ObtenerFacturasRowMapper;
import com.ejie.aa79b.model.Entidad;
import com.ejie.aa79b.model.EstadoFactura;
import com.ejie.aa79b.model.Facturas;
import com.ejie.aa79b.model.Fichero;
import com.ejie.aa79b.model.Persona;
import com.ejie.aa79b.model.enums.Aa06aEstadoFacturaEnum;
import com.ejie.aa79b.model.enums.EstadoFacturaEnum;
import com.ejie.aa79b.model.enums.TipoDocumentoPagoEnum;
import com.ejie.aa79b.model.enums.TipoExpedienteEnum;
import com.ejie.aa79b.model.webservices.Aa79bExpediente;
import com.ejie.aa79b.model.webservices.Aa79bSalidaConsultaFacturas;
import com.ejie.aa79b.utils.DAOUtils;
import com.ejie.aa79b.utils.DateUtils;
import com.ejie.aa79b.utils.Utils;
import com.ejie.x38.dto.JQGridRequestDto;

/**
 * ExcepcionFacturacionDaoImpl generated by UDA, 29-ene-2018 12:16:08.
 *
 * @author UDA
 */

@Repository
@Transactional
public class FacturasDaoImpl extends GenericoDaoImpl<Facturas> implements FacturasDao {

	public FacturasDaoImpl() {
		super(Facturas.class);
	}

	@Autowired()
	private ReloadableResourceBundleMessageSource msg;

	protected static final String DDMMYY = "DD/mm/YY";
	protected static final String FACTURAS_EXPEDIENTE = "facturasExpediente";
	protected static final String EXPEDIENTE = "expediente";
	protected static final String EXPEDIENTE_TRAD_REV = "expedienteTradRev";
	protected static final String FACTURACION_EXP_TRAD = "facturacionExpTrad";
	protected static final String DATOS_FACTURACION = "datosFacturacion";
	protected static final String RELEVANCIA = "relevancia";
	protected static final String FACTURAS = "facturas";
	protected static final String EXPEDIENTE_FACTURAR = "expedienteFacturar";
	protected static final String GESTOR = "gestor";
	protected static final String DATOS_SOLICITANTE = "datosSolicitante";
	protected static final String DATOS_IDIOMA = "datosIdioma";
	protected static final String EXPEDIENTE_INTER = "expedienteInter";
	protected static final String DATOS_FACTURACION_EXP = "datosFacturacionExp";
	protected static final String DATOS_FACTURACION_INTER = "datosFacturacionInter";
	protected static final String DATOS_TIPO_ACTO = "datosTipoActo";
	protected static final String DATOS_FICHEROS = "datosFichero";

	private RowMapper<Facturas> rwMapObtenerFacturas = new ObtenerFacturasRowMapper();

	private RowMapper<Facturas> getRwMapObtenerFacturas() {
		return this.rwMapObtenerFacturas;
	}

	private RowMapper<Entidad> rwMapEntidad = new RowMapper<Entidad>() {
		@Override
		public Entidad mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			Entidad entidad = new Entidad();
			entidad.setCodigo(resultSet.getInt("CODIGO"));
			entidad.setTipo(resultSet.getString("TIPO"));
			entidad.setDescEs(resultSet.getString("DESC_AMP_ES"));
			entidad.setDescEu(resultSet.getString("DESC_AMP_EU"));
			return entidad;
		}
	};

	private RowMapper<EstadoFactura> rwMapEstadosFactura = new RowMapper<EstadoFactura>() {
		@Override
		public EstadoFactura mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			EstadoFactura estadoFactura = new EstadoFactura();
			estadoFactura.setIndEstadoFactura(resultSet.getLong("REG_ID"));
			estadoFactura.setEstadoFacturaDescEs(resultSet.getString("DESC_ES"));
			estadoFactura.setEstadoFacturaDescEu(resultSet.getString("DESC_EU"));
			return estadoFactura;
		}
	};

	private RowMapper<Persona> rwMapPersona = new RowMapper<Persona>() {
		@Override
		public Persona mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			Persona persona = new Persona();
			persona.setPreDni(resultSet.getString("PREDNI_077"));
			persona.setSufDni(resultSet.getString("SUFDNI_077"));
			persona.setDni(resultSet.getString("DNI_077"));
			persona.setNombre(resultSet.getString("NOMBRE_077"));
			persona.setApellido1(resultSet.getString("APEL1_077"));
			persona.setApellido2(resultSet.getString("APEL2_077"));
			return persona;
		}
	};

	private RowMapper<Fichero> rwMapDocumentoFactura = new RowMapper<Fichero>() {
		@Override
		public Fichero mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			Fichero fichero = new Fichero();
			String nombreFich = resultSet.getString("NOMBREFICHERO");
			nombreFich = nombreFich.replace(".", "-" + resultSet.getString("IDFACTURA") + ".");
			fichero.setCodigo(resultSet.getInt("DOCUMENTOID"));
			fichero.setNombre(nombreFich);
			fichero.setOid(resultSet.getString("OID"));
			fichero.setExtension(resultSet.getString("TIPOFICHERO"));
			return fichero;
		}
	};

	private RowMapper<Aa79bSalidaConsultaFacturas> rwMapConsultaFacturas = new Aa79bSalidaConsultaFacturasRowMapper();
	private RowMapper<Facturas> rwMapDetalleFactura = new FacturasRowMapperConsulta();
	private RowMapper<Aa79bExpediente> rwMapExpFactTrad = new FacturasRowMapperExpFactTrad();
	private RowMapper<Aa79bExpediente> rwMapExpFactInter = new FacturasRowMapperExpFactInter();
	private RowMapper<Fichero> rwMapDocumento = new FacturasRowMapperDocumento();

	@Override
	public List<Entidad> findEntidadesFactura(Entidad entidadFilter) {
		StringBuilder query = new StringBuilder();
		List<Object> params = new ArrayList<Object>();

		query.append(DaoConstants.SELECT + DaoConstants.DISTINCT);
		query.append("CODIGO, ");
		query.append("TIPO, ");
		query.append("DESC_AMP_ES, ");
		query.append("DESC_AMP_EU ");
		query.append(DaoConstants.FROM);
		query.append("X54JAPI_ENTIDADES_SOLIC");
		query.append(DaoConstants.JOIN + "AA79BA4S01" + DaoConstants.ON);
		query.append("ID_ENTIDAD_ASOC_0A4 = CODIGO" + DaoConstants.AND);
		query.append("TIPO_ENTIDAD_ASOC_0A4 = TIPO");

		if (entidadFilter.getDescAmpEs() != null) {
			query.append(
					SqlUtils.generarWhereLikeNormalizado("DESC_AMP_ES", entidadFilter.getDescAmpEs(), params, false));
		}
		if (entidadFilter.getDescAmpEu() != null) {
			query.append(
					SqlUtils.generarWhereLikeNormalizado("DESC_AMP_EU", entidadFilter.getDescAmpEu(), params, false));
		}

		return this.getJdbcTemplate().query(query.toString(), this.rwMapEntidad, params.toArray());
	}

	@Override
	public List<Persona> findContactoDeEntidadFaturas(Facturas facturasFilter) {
		StringBuilder query = new StringBuilder();
		List<Object> params = new ArrayList<Object>();
		query.append(DaoConstants.SELECT + DaoConstants.DISTINCT);
		query.append("PREDNI_077, ");
		query.append("SUFDNI_077, ");
		query.append("DNI_077, ");
		query.append("NOMBRE_077, ");
		query.append("APEL1_077, ");
		query.append("APEL2_077 ");
		query.append(DaoConstants.FROM);
		query.append("AA79B77S01");
		query.append(DaoConstants.JOIN + "AA79BA4S01" + DaoConstants.ON);
		query.append("DNI_CONTACTO_0A4 = DNI_077");
		query.append(DaoConstants.WHERE_1_1);
		if (facturasFilter.getIdEntidadAsoc() != null) {
			query.append(" AND ID_ENTIDAD_ASOC_0A4 = ?");
			params.add(facturasFilter.getIdEntidadAsoc());
		}
		if (facturasFilter.getTipoEntidadAsoc() != null) {
			query.append(" AND TIPO_ENTIDAD_ASOC_0A4 = ?");
			params.add(facturasFilter.getTipoEntidadAsoc());
		}

		if (facturasFilter.getPersona() != null && facturasFilter.getPersona().getNombreFiltro() != null) {
			query.append(SqlUtils.generarWhereLikeNormalizado("(NOMBRE_077 || ' ' || APEL1_077 || ' ' || APEL2_077)",
					facturasFilter.getPersona().getNombreFiltro(), params, false));
		}

		return this.getJdbcTemplate().query(query.toString(), this.rwMapPersona, params.toArray());
	}

	@Override
	public Fichero getDocumentoFactura(Facturas bean) {

		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder(DaoConstants.SELECT);
		query.append(DaoConstants.T19_MINUSCULA + DaoConstants.SIGNO_PUNTO + "T19_DOCUMENTO_ID DOCUMENTOID, ");
		query.append(DaoConstants.T19_MINUSCULA + DaoConstants.SIGNO_PUNTO + "T19_NOMBRE_FICHERO NOMBREFICHERO, ");
		query.append(DaoConstants.T19_MINUSCULA + DaoConstants.SIGNO_PUNTO + "T19_TIPO_FICHERO TIPOFICHERO, ");
		query.append(DaoConstants.T19_MINUSCULA + DaoConstants.SIGNO_PUNTO + "T19_OID OID ");
		query.append(", FACTURAS.ID_FACTURA_0A4 IDFACTURA ");
		query.append(DaoConstants.FROM + "W0519S01" + DaoConstants.BLANK + DaoConstants.T19_MINUSCULA);
		query.append(" JOIN AA79BA4S01 FACTURAS ON FACTURAS.ID_LIQUIDACION_0A4 = T19.T12_REFERENCIA ");
		query.append(DaoConstants.WHERE);
		query.append(DaoConstants.T19_MINUSCULA + DaoConstants.SIGNO_PUNTO + "T19_TIPO_DOCUMENTO"
				+ DaoConstants.SIGNOIGUAL + TipoDocumentoPagoEnum.FACTURA.getValue());
		query.append(DaoConstants.AND + DaoConstants.T19_MINUSCULA + DaoConstants.SIGNO_PUNTO + "T12_REFERENCIA"
				+ DaoConstants.SIGNOIGUAL + DaoConstants.SIGNOINTERROGACION);
		params.add(bean.getIdLiquidacion());

		List<Fichero> result = this.getJdbcTemplate().query(query.toString(), this.rwMapDocumentoFactura,
				params.toArray());

		return DataAccessUtils.uniqueResult(result);
	}

	@Override
	public List<EstadoFactura> estadosFactura(boolean facturaE, boolean baja) {

		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder(FacturasDaoImpl.STRING_BUILDER_INIT);
		query.append(DaoConstants.SELECT);
		query.append("T00_REG_ID REG_ID, ");
		query.append("T00_DESC_ES DESC_ES, ");
		query.append("T00_DESC_EU DESC_EU ");
		query.append(DaoConstants.FROM);

		if (facturaE) {
			query.append("W05B_ESTADOS_FACTURAE");
		} else {
			query.append("W05B_ESTADOS_FACTURA");
		}

		if (baja) {
			query.append(" WHERE NOT T00_REG_ID = (" + EstadoFacturaEnum.ANULADA.getValue() + ")");
		}

		return this.getJdbcTemplate().query(query.toString(), this.rwMapEstadosFactura, params.toArray());
	}

	@Override
	public List<Facturas> filterFacturas(Facturas bean, JQGridRequestDto jqGridRequestDto, Boolean startsWith) {
		Locale es = new Locale(Constants.LANG_CASTELLANO);
		Locale eu = new Locale(Constants.LANG_EUSKERA);
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder(FacturasDaoImpl.STRING_BUILDER_INIT);
		StringBuilder paginatedQuery = new StringBuilder(FacturasDaoImpl.STRING_BUILDER_INIT);
		query.append(DaoConstants.SELECT);
		query.append("a4.ID_FACTURA_0A4 IDFACTURA, ");
		query.append("a4.ID_LIQUIDACION_0A4 IDLIQUIDACION, ");
		// NO ESTA RELACIONADA W05 AUN
		query.append("CASE WHEN  t12.T12_EJ_CONTABLE is null THEN '9999999999' ELSE ");
		query.append(
				"SUBSTR(t12.T12_EJ_CONTABLE,3,2) || LPAD(a4.APP_ID_0A4,2,'0') || SUBSTR(a4.ID_LIQUIDACION_0A4,3,6) END CODCONCATENADO, ");
		query.append("e1.CODIGO CODIGO, ");
		query.append("e1.DESC_AMP_ES DESCAMPES, ");
		query.append("e1.DESC_AMP_EU DESCAMPEU, ");
		query.append("t1.NOMBRE_077 NOMBRE, ");
		query.append("t1.APEL1_077 APEL1, ");
		query.append("t1.APEL2_077 APEL2, ");
		query.append("NVL(t12.T12_IMPORTE_TOTAL, 0) IMPORTETOTAL, ");
		query.append("a4.FECHA_EMISION_0A4 FECHAEMISION, ");
		query.append("e2.T00_REG_ID IDESTADOFACTURA ");
		/* decode con EstadoFacturaEnum */
		query.append(
				DAOUtils.getDecodeAcciones("e2.T00_REG_ID", "ESTADOFACTURADESCES", this.msg, "EstadoFacturaEnum", es));
		query.append(
				DAOUtils.getDecodeAcciones("e2.T00_REG_ID", "ESTADOFACTURADESCEU", this.msg, "EstadoFacturaEnum", eu));
		/* decode con EstadoFacturaEnum */
		query.append(", e3.T00_REG_ID IDESTADOEFACTURA, ");
		query.append("e3.T00_DESC_ES ESTADOEFACTURADESCES, ");
		query.append("e3.T00_DESC_EU ESTADOEFACTURADESCEU, ");
		query.append("e4.T00_REG_ID IDESTADOINCIDENCIA, ");
		query.append("e4.T00_DESC_ES ESTADOINCIDENCIADESCES, ");
		query.append("e4.T00_DESC_EU ESTADOINCIDENCIADESCEU, ");
		query.append("e5.T00_REG_ID IDESTADOERROR, ");
		query.append("e5.T00_DESC_ES ESTADOERRORDESCES, ");
		query.append("e5.T00_DESC_EU ESTADOERRORDESCEU, ");
        query.append("t12.T12_FECHA_PAGO FECHAPAGO, ");
		query.append("e6.CENTRO_ORGANICO CENTROORGANICO, ");
		query.append("e6.DESCRIPCION_CASTELLANO_AMP CENTROORGANICODESCES, ");
		query.append("e6.DESCRIPCION_EUSKERA_AMP CENTROORGANICODESCEU");
		query.append(this.getFromFilterFacturas());
		query.append(DaoConstants.WHERE_1_1);
		query.append(this.getWhereFacturasEntidad(bean, params));
		query.append(this.getGroupByFilterFacturas());
		paginatedQuery.append(Utils.getPaginationQuery(jqGridRequestDto, false, query));

		return this.getJdbcTemplate().query(paginatedQuery.toString(), this.getRwMapObtenerFacturas(),
				params.toArray());
	}

	public String getGroupByFilterFacturas() {
		StringBuilder groupBy = new StringBuilder(FacturasDaoImpl.STRING_BUILDER_INIT);
		groupBy.append(" GROUP BY ");
		groupBy.append(" a4.ID_FACTURA_0A4, ");
		groupBy.append("  a4.ID_LIQUIDACION_0A4, ");
		groupBy.append(" e1.CODIGO, ");
		groupBy.append(" e1.DESC_AMP_ES, ");
		groupBy.append(" e1.DESC_AMP_EU, ");
		groupBy.append(" t1.NOMBRE_077, ");
		groupBy.append(" t1.APEL1_077, ");
		groupBy.append(" t1.APEL2_077, ");
		groupBy.append(" NVL(t12.T12_IMPORTE_TOTAL, 0), ");
		groupBy.append(" a4.FECHA_EMISION_0A4, ");
		groupBy.append(" e2.T00_REG_ID, ");
		groupBy.append(" DECODE(e2.T00_REG_ID, '7', 'Erroneo', '1', 'Pendiente de cobro', "
				+ "'2', 'Cobrado', '4', 'Anulada', '5', 'Devoluci�n de ingreso' , '6', 'No anulada'), ");
		groupBy.append(" DECODE(e2.T00_REG_ID, '7', 'Okerra', '1', 'Ordaindu gabe', '2',"
				+ " 'Ordainduta', '4', 'Baliogabetuta', '5', 'Diru-sarrera itzulita', '6', 'Baliogabetu gabe'), ");
		groupBy.append(" e3.T00_REG_ID, ");
		groupBy.append(" e3.T00_DESC_ES, ");
		groupBy.append(" e3.T00_DESC_EU, ");
		groupBy.append(" e4.T00_REG_ID, ");
		groupBy.append(" e4.T00_DESC_ES, ");
		groupBy.append(" e4.T00_DESC_EU, ");
		groupBy.append(" e5.T00_REG_ID, ");
		groupBy.append(" e5.T00_DESC_ES, ");
		groupBy.append(" e5.T00_DESC_EU, ");
		groupBy.append(" t12.T12_FECHA_PAGO, ");
		groupBy.append("CASE WHEN t12.t12_ej_contable IS NULL THEN '9999999999' ELSE");
		groupBy.append(" SUBSTR(t12.T12_EJ_CONTABLE,3,2) || LPAD(a4.APP_ID_0A4,2,'0') || SUBSTR(a4.ID_LIQUIDACION_0A4,3,6) END, ");
		groupBy.append(" e6.CENTRO_ORGANICO, ");
		groupBy.append(" e6.DESCRIPCION_CASTELLANO_AMP, ");
		groupBy.append(" e6.DESCRIPCION_EUSKERA_AMP ");
		return groupBy.toString();
	}

	private String getFromFilterFacturas() {
		StringBuilder from = new StringBuilder();
		from.append(DaoConstants.FROM);
		from.append("AA79BA4S01 a4");
		from.append(DaoConstants.LEFT_JOIN + "W0512S01 t12 ON a4.ID_LIQUIDACION_0A4 = t12.T12_REFERENCIA");
		from.append(DaoConstants.LEFT_JOIN + "W0513S01 t13 ON a4.ID_LIQUIDACION_0A4 = t13.T12_REFERENCIA");
		from.append(DaoConstants.LEFT_JOIN
				+ "W0514S01 t14 ON a4.ID_LIQUIDACION_0A4 = t14.T12_REFERENCIA AND t14.T14_CORREGIDO = "
				+ Constants.CERO);
		from.append(DaoConstants.LEFT_JOIN + "AA79B77S01 t1 ON a4.DNI_CONTACTO_0A4 = t1.DNI_077");
		from.append(DaoConstants.LEFT_JOIN
				+ "X54JAPI_ENTIDADES_SOLIC e1 ON a4.ID_ENTIDAD_ASOC_0A4 = e1.CODIGO AND a4.TIPO_ENTIDAD_ASOC_0A4 = e1.TIPO");
		from.append(DaoConstants.LEFT_JOIN + "AA79B.W05B_ESTADOS_FACTURA e2 ON t12.T00_ESTADO_ID = e2.T00_REG_ID");
		from.append(DaoConstants.LEFT_JOIN + "AA79B.W05B_ESTADOS_FACTURAE e3 ON t12.T12_EST_FACTURA = e3.T00_REG_ID");
		from.append(DaoConstants.LEFT_JOIN + "AA79B.W05B_ESTADOS_INCIDENCIA e4 ON t13.T00_ID_ESTADO = e4.T00_REG_ID");
		from.append(DaoConstants.LEFT_JOIN + "AA79B.W05B_CODIGOS_ERROR e5 ON t14.T00_NIVEL_ERROR = e5.T00_REG_ID");
		from.append(" LEFT JOIN AA79BA5S01 a5 ");
		from.append(" ON a4.ID_FACTURA_0A4 = a5.ID_FACTURA_0A5 ");
		from.append(DaoConstants.LEFT_JOIN + "X54J52S01 e6 ON a4.DNI_CONTACTO_0A4 = e6.DNI");
		return from.toString();
	}

	@Override
	@Transactional(readOnly = true)
	public Long filterFacturasCount(Facturas bean, boolean startsWith) {
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder();
		query.append(DaoConstants.SELECT + " COUNT " + DaoConstants.ABRIR_PARENTESIS + DaoConstants.DISTINCT
				+ "a4.ID_FACTURA_0A4" + DaoConstants.CERRAR_PARENTESIS);
		query.append(this.getFromFilterFacturas());
		query.append(DaoConstants.WHERE_1_1);
		query.append(this.getWhereFacturasEntidad(bean, params));
		return this.getJdbcTemplate().queryForObject(query.toString(), params.toArray(), Long.class);
	}

	private String getWhereFacturasEntidad(Facturas facturas, List<Object> params) {

		StringBuilder where = new StringBuilder(FacturasDaoImpl.STRING_BUILDER_INIT);
		where.append(SqlUtils.generarWhereIgual(
				"(CASE WHEN t12.t12_ej_contable IS NULL THEN '9999999999' ELSE SUBSTR(t12.T12_EJ_CONTABLE,3,2) || LPAD(a4.APP_ID_0A4,2,'0') || SUBSTR(a4.ID_LIQUIDACION_0A4,3,6) END)",
				facturas.getIdFactura(), params));
		where.append(SqlUtils.generarWhereIgual("a4.ID_LIQUIDACION_0A4", facturas.getIdLiquidacion(), params));
		where.append(SqlUtils.generarWhereMayorIgualFecha("a4.FECHA_EMISION_0A4", DDMMYY,
				DateUtils.obtFechaHoraFormateada(facturas.getFechaEmisionIni(), Constants.HORA_MINUTOS_CERO), params));
		where.append(SqlUtils.generarWhereMenorIgualFecha("a4.FECHA_EMISION_0A4", DDMMYY,
				DateUtils.obtFechaHoraFormateada(facturas.getFechaEmisionFin(), Constants.HORA_MINUTOS_CERO), params));

		if (facturas.getDatosFacturacionInterpretacion() != null
				&& facturas.getDatosFacturacionInterpretacion().getEstadoFactura() != null) {
			where.append(SqlUtils.generarWhereIgual("t12.T00_ESTADO_ID",
					facturas.getDatosFacturacionInterpretacion().getEstadoFactura().getIndEstadoFactura(), params));
		}

		if (facturas.getDatosFacturacionInterpretacion() != null
				&& facturas.getDatosFacturacionInterpretacion().getEstadoFacturaE() != null) {
			where.append(SqlUtils.generarWhereIgual("t12.T12_EST_FACTURA",
					facturas.getDatosFacturacionInterpretacion().getEstadoFacturaE().getIndEstadoEFactura(), params));
		}

		if (facturas.getPersona() != null) {

			where.append(SqlUtils.generarWhereLike("t1.PREDNI_077||t1.DNI_077||t1.SUFDNI_077",
					facturas.getPersona().getDni(), params, false));

			where.append(SqlUtils.generarWhereLike("t1.PREDNI_077||t1.DNI_077||t1.SUFDNI_077",
					facturas.getPersona().getDniContacto(), params, false));

			if (facturas.getPersona().getEntidad() != null) {

				where.append(SqlUtils.generarWhereIgual("e1.CIF", facturas.getPersona().getEntidad().getCif(), params));
				where.append(SqlUtils.generarWhereIgual("a4.ID_ENTIDAD_ASOC_0A4",
						facturas.getPersona().getEntidad().getCodigo(), params));
				where.append(SqlUtils.generarWhereIgual("a4.TIPO_ENTIDAD_ASOC_0A4",
						facturas.getPersona().getEntidad().getTipo(), params));
			}
		}
		where.append(SqlUtils.generarWhereIgual("SUBSTR(a5.ANYO_0A5,3,4)",
				facturas.getAnyoExp() != null ? facturas.getAnyoExp().toString() : facturas.getAnyoExp(), params));
		where.append(SqlUtils.generarWhereIgual("a5.NUM_EXP_0A5", facturas.getNumExp(), params));

		return where.toString();
	}

	@Override
	protected String getSelect() {
		return null;
	}

	@Override
	protected String getFrom() {
		return null;
	}

	@Override
	protected RowMapper<Facturas> getRwMap() {
		return null;
	}

	@Override
	protected String[] getOrderBy() {
		return new String[0];
	}

	@Override
	protected String getPK() {
		return null;
	}

	@Override
	protected RowMapper<Facturas> getRwMapPK() {
		return null;
	}

	@Override
	protected String getWherePK(Facturas bean, List<Object> params) {
		return null;
	}

	@Override
	protected String getWhere(Facturas bean, List<Object> params) {
		return null;
	}

	@Override
	protected String getWhereLike(Facturas bean, Boolean startsWith, List<Object> params, Boolean search) {
		return null;
	}

	@Override
	public List<String> getTitulosExpedienteFacturados(Entidad entidad) {

		List<String> titulosExpediente = null;

		if (entidad.getTipo() != null && entidad.getCodigo() != null) {
			StringBuilder query = new StringBuilder();
			List<Object> params = new ArrayList<Object>();

			query.append(DaoConstants.SELECT);
			query.append(DaoConstants.DISTINCT);
			query.append(DaoConstants.T1_MINUSCULA);
			query.append(DaoConstants.SIGNO_PUNTO);
			query.append(DBConstants.TITULO_051);
			query.append(DaoConstants.BLANK);
			query.append(DBConstants.TITULO);
			query.append(DaoConstants.BLANK);
			query.append(DaoConstants.FROM);
			query.append(DBConstants.TABLA_51);
			query.append(DaoConstants.BLANK);
			query.append(DaoConstants.T1_MINUSCULA);
			query.append(DaoConstants.SIGNO_COMA);
			query.append(DBConstants.TABLA_A4);
			query.append(DaoConstants.BLANK);
			query.append(DaoConstants.T2_MINUSCULA);
			query.append(DaoConstants.SIGNO_COMA);
			query.append(DBConstants.TABLA_A5);
			query.append(DaoConstants.BLANK);
			query.append(DaoConstants.T3_MINUSCULA);
			query.append(DaoConstants.WHERE);
			query.append(DaoConstants.T2_MINUSCULA);
			query.append(DaoConstants.SIGNO_PUNTO);
			query.append(DBConstants.TIPO_ENTIDAD_ASOC_0A4);
			query.append(DaoConstants.SIGNOIGUAL_INTERROGACION);
			query.append(DaoConstants.AND);
			query.append(DaoConstants.T2_MINUSCULA);
			query.append(DaoConstants.SIGNO_PUNTO);
			query.append(DBConstants.ID_ENTIDAD_ASOC_0A4);
			query.append(DaoConstants.SIGNOIGUAL_INTERROGACION);
			query.append(DaoConstants.AND);
			query.append(DaoConstants.T2_MINUSCULA);
			query.append(DaoConstants.SIGNO_PUNTO);
			query.append(DBConstants.ID_FACTURA_0A4);
			query.append(DaoConstants.SIGNOIGUAL);
			query.append(DaoConstants.T3_MINUSCULA);
			query.append(DaoConstants.SIGNO_PUNTO);
			query.append(DBConstants.ID_FACTURA_0A5);
			query.append(DaoConstants.AND);
			query.append(DaoConstants.T1_MINUSCULA);
			query.append(DaoConstants.SIGNO_PUNTO);
			query.append(DBConstants.ANYO_051);
			query.append(DaoConstants.SIGNOIGUAL);
			query.append(DaoConstants.T3_MINUSCULA);
			query.append(DaoConstants.SIGNO_PUNTO);
			query.append(DBConstants.ANYO_0A5);
			query.append(DaoConstants.AND);
			query.append(DaoConstants.T1_MINUSCULA);
			query.append(DaoConstants.SIGNO_PUNTO);
			query.append(DBConstants.NUM_EXP_051);
			query.append(DaoConstants.SIGNOIGUAL);
			query.append(DaoConstants.T3_MINUSCULA);
			query.append(DaoConstants.SIGNO_PUNTO);
			query.append(DBConstants.NUM_EXP_0A5);
			query.append(DaoConstants.ORDER_BY);
			query.append(DaoConstants.T1_MINUSCULA);
			query.append(DaoConstants.SIGNO_PUNTO);
			query.append(DBConstants.TITULO_051);

			params.add(entidad.getTipo());
			params.add(entidad.getCodigo());

			titulosExpediente = this.getJdbcTemplate().queryForList(query.toString(), params.toArray(), String.class);
		}

		return titulosExpediente;
	}

	private String getSelectConsultaFacturas() {
		return this.getSelectConsultaFacturas(Constants.LANG_EUSKERA);
	}

	private String getSelectConsultaFacturas(String idioma) {
		Locale locale = new Locale(idioma);
		StringBuilder query = new StringBuilder();

		query.append(DaoConstants.SELECT + " DISTINCT ");
		query.append(DBConstants.ID_FACTURA_0A4);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.IDFACTURA);
		query.append(DaoConstants.SIGNO_COMA);
		query.append("CASE WHEN  t12.T12_EJ_CONTABLE is null THEN '9999999999' ELSE ");
		query.append(
				"SUBSTR(t12.T12_EJ_CONTABLE,3,2) || LPAD(APP_ID_0A4,2,'0') || SUBSTR(ID_LIQUIDACION_0A4,3,6) END CODCONCATENADO ");
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DBConstants.TIPO_ENTIDAD_ASOC_0A4);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.TIPOENTIDADASOCIADA);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DBConstants.ID_ENTIDAD_ASOC_0A4);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.IDENTIDADASOCIADA);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DBConstants.DNI_CONTACTO_0A4);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.DNICONTACTO);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DBConstants.FECHA_EMISION_0A4);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.FECHAEMISION);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.TO_CHAR + DaoConstants.ABRIR_PARENTESIS + DBConstants.FECHA_EMISION_0A4
				+ DaoConstants.SIGNO_COMA_SIN_ESPACIOS + DaoConstants.FORMATO_HORA + DaoConstants.CERRAR_PARENTESIS
				+ DBConstants.HORAEMISION + DaoConstants.SIGNO_COMA);
		query.append(DBConstants.TIPO_EXP_FACTURA_0A4);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.TIPOEXPFACTURA);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DBConstants.T12_IMPORTE_TOTAL);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.IMPORTETOTAL);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DBConstants.T12_IMPORTE_IVA);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.IMPORTEIVA);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DBConstants.T12_IMPORTE_BASE);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.IMPORTEBASE);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DBConstants.T12_TIPO_IVA);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.TIPOIVA);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.DECODE);
		query.append(DaoConstants.ABRIR_PARENTESIS);
		query.append(DaoConstants.T12_MINUSCULA_PUNTO + DBConstants.T00_ESTADO_ID + DaoConstants.SIGNO_COMA
				+ "1,1,2,2,4,4,5,1,6,1,7,1");
		query.append(DaoConstants.CERRAR_PARENTESIS);
		query.append(DaoConstants.AS);
		query.append(DBConstants.ESTADOFACTURA);
		query.append(DaoConstants.BLANK);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.DECODE);
		query.append(DaoConstants.ABRIR_PARENTESIS);
		query.append(DaoConstants.T12_MINUSCULA_PUNTO + DBConstants.T00_ESTADO_ID + DaoConstants.SIGNO_COMA
				+ DaoConstants.SIGNO_APOSTROFO + Aa06aEstadoFacturaEnum.PENDIENTE_COBRO.getValue()
				+ DaoConstants.SIGNO_APOSTROFO + DaoConstants.SIGNO_COMA + DaoConstants.SIGNO_APOSTROFO)
				.append(this.msg.getMessage(Aa06aEstadoFacturaEnum.PENDIENTE_COBRO.getLabel(), null, locale))
				.append(DaoConstants.SIGNO_APOSTROFO + DaoConstants.SIGNO_COMA + DaoConstants.SIGNO_APOSTROFO
						+ Aa06aEstadoFacturaEnum.COBRADO.getValue() + DaoConstants.SIGNO_APOSTROFO
						+ DaoConstants.SIGNO_COMA + DaoConstants.SIGNO_APOSTROFO)
				.append(this.msg.getMessage(Aa06aEstadoFacturaEnum.COBRADO.getLabel(), null, locale))
				.append(DaoConstants.SIGNO_APOSTROFO + DaoConstants.SIGNO_COMA + DaoConstants.SIGNO_APOSTROFO
						+ Aa06aEstadoFacturaEnum.ANULADO.getValue() + DaoConstants.SIGNO_APOSTROFO
						+ DaoConstants.SIGNO_COMA + DaoConstants.SIGNO_APOSTROFO)
				.append(this.msg.getMessage(Aa06aEstadoFacturaEnum.ANULADO.getLabel(), null, locale))
				.append(DaoConstants.SIGNO_APOSTROFO + DaoConstants.SIGNO_COMA + DaoConstants.SIGNO_APOSTROFO
						+ Aa06aEstadoFacturaEnum.DEVOLUCION_INGRESO.getValue() + DaoConstants.SIGNO_APOSTROFO
						+ DaoConstants.SIGNO_COMA + DaoConstants.SIGNO_APOSTROFO)
				.append(this.msg.getMessage(Aa06aEstadoFacturaEnum.DEVOLUCION_INGRESO.getLabel(), null, locale))
				.append(DaoConstants.SIGNO_APOSTROFO + DaoConstants.SIGNO_COMA + DaoConstants.SIGNO_APOSTROFO
						+ Aa06aEstadoFacturaEnum.NO_ANULADAS.getValue() + DaoConstants.SIGNO_APOSTROFO
						+ DaoConstants.SIGNO_COMA + DaoConstants.SIGNO_APOSTROFO)
				.append(this.msg.getMessage(Aa06aEstadoFacturaEnum.NO_ANULADAS.getLabel(), null, locale))
				.append(DaoConstants.SIGNO_APOSTROFO + DaoConstants.SIGNO_COMA + DaoConstants.SIGNO_APOSTROFO
						+ Aa06aEstadoFacturaEnum.ERRONEO.getValue() + DaoConstants.SIGNO_APOSTROFO
						+ DaoConstants.SIGNO_COMA + DaoConstants.SIGNO_APOSTROFO)
				.append(this.msg.getMessage(Aa06aEstadoFacturaEnum.ERRONEO.getLabel(), null, locale))
				.append(DaoConstants.SIGNO_APOSTROFO);
		query.append(DaoConstants.CERRAR_PARENTESIS);
		query.append(DaoConstants.AS);
		query.append(DBConstants.DESCESTADOFACTURA);
		query.append(DaoConstants.BLANK);

		return query.toString();
	}

	private String getFromConsultaFacturas() {
		StringBuilder query = new StringBuilder();

		query.append(DaoConstants.FROM);
		query.append(DBConstants.TABLA_A4);
		query.append(DaoConstants.JOIN);
		query.append(DBConstants.VISTAW05B12);
		query.append(DaoConstants.BLANK);
		query.append(DaoConstants.T12_MINUSCULA);
		query.append(DaoConstants.ON);
		query.append(DBConstants.ID_LIQUIDACION_0A4);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(DaoConstants.T12_MINUSCULA);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.T12_REFERENCIA);
		return query.toString();
	}

	private String getWhereConsultaFacturas(Facturas factura, List<Object> params) {
		StringBuilder query = new StringBuilder();

		query.append(DaoConstants.WHERE_1_1);
		query.append(
				SqlUtils.generarWhereIgual(DBConstants.TIPO_ENTIDAD_ASOC_0A4, factura.getTipoEntidadAsoc(), params));
		query.append(SqlUtils.generarWhereIgual(DBConstants.ID_ENTIDAD_ASOC_0A4, factura.getIdEntidadAsoc(), params));
		query.append(SqlUtils.generarWhereIgual(
				"(CASE WHEN t12.t12_ej_contable IS NULL THEN '9999999999' ELSE SUBSTR(t12.T12_EJ_CONTABLE,3,2) || LPAD(a4.APP_ID_0A4,2,'0') || SUBSTR(a4.ID_LIQUIDACION_0A4,3,6) END)",
				factura.getIdFactura(), params));
		// Filtrado fecha emision desde y hasta
		// FechaEmisionDesde
		query.append(SqlUtils.generarWhereMayorIgualFecha(DBConstants.FECHA_EMISION_0A4, DDMMYY,
				DateUtils.obtFechaHoraFormateada(factura.getFechaEmisionIni(), Constants.HORA_MINUTOS_CERO), params));
		// FechaEmisionHasta
		query.append(SqlUtils.generarWhereMenorIgualFecha(DBConstants.FECHA_EMISION_0A4, DDMMYY,
				DateUtils.obtFechaHoraFormateada(factura.getFechaEmisionFin(), Constants.HORA_MINUTOS_CERO), params));
		if (factura.getDatosFacturacionInterpretacion() != null
				&& factura.getDatosFacturacionInterpretacion().getEstadoFactura() != null) {
			String estadoFactura = DaoConstants.DECODE + DaoConstants.ABRIR_PARENTESIS
					+ DaoConstants.T12_MINUSCULA_PUNTO + DBConstants.T00_ESTADO_ID + DaoConstants.SIGNO_COMA
					+ "1,1,2,2,4,4,5,1,6,1,7,1" + DaoConstants.CERRAR_PARENTESIS;
			query.append(SqlUtils.generarWhereIgual(estadoFactura,
					factura.getDatosFacturacionInterpretacion().getEstadoFactura().getIndEstadoFactura(), params));
		}
		query.append(SqlUtils.generarWhereIgual(DBConstants.DNI_CONTACTO_0A4, factura.getDniContacto(), params));
		if (factura.getPersona() != null) {
			query.append(SqlUtils.generarWhereLike(DBConstants.T12_NOMBRE_CLIENTE, factura.getPersona().getNombre(),
					params, false));
			if (factura.getPersona().getApellido1() != null) {
				String[] apellidos = factura.getPersona().getApellido1().trim().split(Constants.ESPACIO);
				String apellido1 = apellidos[0];
				String apellido2 = null;
				if (apellidos.length > 1) {
					apellido2 = apellidos[1];
				}

				query.append(DaoConstants.AND);
				query.append(DaoConstants.ABRIR_PARENTESIS);
				query.append(DaoConstants.ABRIR_PARENTESIS);
				query.append(DaoConstants.IGUAL_1_1);
				query.append(SqlUtils.generarWhereLikeNormalizado(DBConstants.T12_APE1, apellido1, params, false));
				query.append(DaoConstants.CERRAR_PARENTESIS);
				if (apellido2 != null) {
					query.append(DaoConstants.OR);
					query.append(DaoConstants.ABRIR_PARENTESIS);
					query.append(DaoConstants.IGUAL_1_1);
					query.append(SqlUtils.generarWhereLikeNormalizado(DBConstants.T12_APE2, apellido2, params, false));
					query.append(DaoConstants.CERRAR_PARENTESIS);
				}
				query.append(DaoConstants.CERRAR_PARENTESIS);
			}
		}
		query.append(SqlUtils.generarWhereIgual("SUBSTR(" + DBConstants.ANYO_0A5 + ",3,4)",
				factura.getAnyoExp() != null ? factura.getAnyoExp().toString() : factura.getAnyoExp(), params));

		if (factura.getNumExp() != null && factura.getNumExp() != 0) {
			query.append(SqlUtils.generarWhereIgual(DBConstants.NUM_EXP_0A5, factura.getNumExp(), params));
		}
		query.append(SqlUtils.generarWhereIgual(DBConstants.TITULO_051, factura.getTituloExp(), params));

		return query.toString();
	}

	@Override
	public Facturas findDetalleFactura(Long idFactura) {
		StringBuilder query = new StringBuilder();
		List<Object> params = new ArrayList<Object>();

		query.append(getSelectConsultaFacturas());
		query.append(getFromConsultaFacturas());
		query.append(getWhereDetalleFactura(idFactura, params));

		List<Facturas> listFacturas = this.getJdbcTemplate().query(query.toString(), this.rwMapDetalleFactura,
				params.toArray());

		return DataAccessUtils.uniqueResult(listFacturas);
	}

	private String getWhereDetalleFactura(Long idFactura, List<Object> params) {
		StringBuilder query = new StringBuilder();

		query.append(DaoConstants.WHERE_1_1);
		query.append(SqlUtils.generarWhereIgual(DBConstants.ID_FACTURA_0A4, idFactura, params));

		return query.toString();
	}

	@Override
	public boolean getAccesoFactura(Facturas factura) {
		StringBuilder query = new StringBuilder();
		List<Object> params = new ArrayList<Object>();
		query.append(DaoConstants.SELECT_COUNT + DaoConstants.FROM + DBConstants.TABLA_A4);
		query.append(DaoConstants.WHERE + DBConstants.ID_ENTIDAD_ASOC_0A4 + DaoConstants.SIGNOIGUAL_INTERROGACION);
		query.append(DaoConstants.AND + DBConstants.TIPO_ENTIDAD_ASOC_0A4 + DaoConstants.SIGNOIGUAL_INTERROGACION);
		query.append(DaoConstants.AND + DBConstants.ID_FACTURA_0A4 + DaoConstants.SIGNOIGUAL_INTERROGACION);
		params.add(factura.getIdEntidadAsoc());
		params.add(factura.getTipoEntidadAsoc());
		params.add(factura.getIdFactura());

		Long resul = this.getJdbcTemplate().queryForObject(query.toString(), params.toArray(), Long.class);
		return (resul != null && resul > 0);
	}

	/**
	 * @return String
	 */
	private String getSelectExpFactTrad() {
		Locale eu = new Locale(Constants.LANG_EUSKERA);
		StringBuilder query = new StringBuilder();

		query.append(DaoConstants.SELECT);
		// Facturas expediente
		query.append(FACTURAS_EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ID_FACTURA_0A5);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.IDFACTURA);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(FACTURAS_EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ANYO_0A5);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.ANYO);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(FACTURAS_EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.NUM_EXP_0A5);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.NUMEXP);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.SUBSTR);
		query.append(DaoConstants.ABRIR_PARENTESIS);
		query.append(FACTURAS_EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ANYO_0A5);
		query.append(",3,4) || '/' || LPAD(");
		query.append(FACTURAS_EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.NUM_EXP_0A5);
		query.append(",6,'0') ");
		query.append(DBConstants.ANYONUMEXPCONCATENADO);
		query.append(DaoConstants.SIGNO_COMA);
		// Expediente
		query.append(EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ID_TIPO_EXPEDIENTE_051);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.IDTIPOEXPEDIENTE);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.DECODE + DaoConstants.ABRIR_PARENTESIS);
		query.append(EXPEDIENTE + DaoConstants.SIGNO_PUNTO + DBConstants.ID_TIPO_EXPEDIENTE_051
				+ DaoConstants.SIGNO_COMA + DaoConstants.SIGNO_APOSTROFO + TipoExpedienteEnum.INTERPRETACION.getValue()
				+ DaoConstants.SIGNO_APOSTROFO + DaoConstants.SIGNO_COMA + DaoConstants.SIGNO_APOSTROFO)
				.append(this.msg.getMessage("label.interpretacionAbr", null, eu))
				.append(DaoConstants.SIGNO_APOSTROFO + DaoConstants.SIGNO_COMA + DaoConstants.SIGNO_APOSTROFO
						+ TipoExpedienteEnum.TRADUCCION.getValue() + DaoConstants.SIGNO_APOSTROFO
						+ DaoConstants.SIGNO_COMA + DaoConstants.SIGNO_APOSTROFO)
				.append(this.msg.getMessage("label.traduccionAbr", null, eu))
				.append(DaoConstants.SIGNO_APOSTROFO + DaoConstants.SIGNO_COMA + DaoConstants.SIGNO_APOSTROFO
						+ TipoExpedienteEnum.REVISION.getValue() + DaoConstants.SIGNO_APOSTROFO
						+ DaoConstants.SIGNO_COMA + DaoConstants.SIGNO_APOSTROFO)
				.append(this.msg.getMessage("label.revisionAbr", null, eu)).append(DaoConstants.SIGNO_APOSTROFO);
		query.append(DaoConstants.CERRAR_PARENTESIS);
		query.append(DaoConstants.AS + DBConstants.TIPOEXPEDIENTEDESCEU + DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.DECODE + DaoConstants.ABRIR_PARENTESIS);
		query.append(EXPEDIENTE + DaoConstants.SIGNO_PUNTO + DBConstants.ID_TIPO_EXPEDIENTE_051
				+ DaoConstants.SIGNO_COMA + DaoConstants.SIGNO_APOSTROFO + TipoExpedienteEnum.INTERPRETACION.getValue()
				+ DaoConstants.SIGNO_APOSTROFO + DaoConstants.SIGNO_COMA + DaoConstants.SIGNO_APOSTROFO).append("I")
				.append(DaoConstants.SIGNO_APOSTROFO + DaoConstants.SIGNO_COMA + DaoConstants.SIGNO_APOSTROFO
						+ TipoExpedienteEnum.TRADUCCION.getValue() + DaoConstants.SIGNO_APOSTROFO
						+ DaoConstants.SIGNO_COMA + DaoConstants.SIGNO_APOSTROFO)
				.append("T")
				.append(DaoConstants.SIGNO_APOSTROFO + DaoConstants.SIGNO_COMA + DaoConstants.SIGNO_APOSTROFO
						+ TipoExpedienteEnum.REVISION.getValue() + DaoConstants.SIGNO_APOSTROFO
						+ DaoConstants.SIGNO_COMA + DaoConstants.SIGNO_APOSTROFO)
				.append("R").append(DaoConstants.SIGNO_APOSTROFO);
		query.append(DaoConstants.CERRAR_PARENTESIS);
		query.append(DaoConstants.AS + DBConstants.TIPOEXPEDIENTEDESCES + DaoConstants.SIGNO_COMA);
		// Expediente de traduccion/revisión
		query.append(EXPEDIENTE_TRAD_REV);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ID_RELEVANCIA_053);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.IDRELEVANCIA);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(EXPEDIENTE_TRAD_REV);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ID_IDIOMA_053);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.IDIDIOMA);
		query.append(DaoConstants.SIGNO_COMA);
		// Datos facturación expediente traducción
		query.append(FACTURACION_EXP_TRAD);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.TARIFA_PAL_097);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.TARIFAPAL);
		query.append(DaoConstants.SIGNO_COMA);
		// Datos facturación
		query.append(DATOS_FACTURACION);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.NUM_TOTAL_PAL_FACTURAR_098);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.NUMTOTALPALFACTURAR);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DATOS_FACTURACION);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.NUM_PAL_CONCOR_0_84_098);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.NUMPALCONCOR084);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DATOS_FACTURACION);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.NUM_PAL_CONCOR_85_94_098);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.NUMPALCONCOR8594);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DATOS_FACTURACION);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.NUM_PAL_CONCOR_95_100_098);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.NUMPALCONCOR95100);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DATOS_FACTURACION);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.IMPORTE_DIFICULTAD_098);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.IMPORTEDIFICULTAD);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DATOS_FACTURACION);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.IMPORTE_URGENCIA_098);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.IMPORTEURGENCIA);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DATOS_FACTURACION);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.IMPORTE_BASE_098);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.IMPORTEBASE);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DATOS_FACTURACION);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.IMPORTE_IVA_098);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.IMPORTEIVA);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DATOS_FACTURACION);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.IMPORTE_TOTAL_098);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.IMPORTETOTAL);
		query.append(DaoConstants.SIGNO_COMA);
		// Relevancia
		query.append(RELEVANCIA);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.DESC_RELEVANCIA_ES_010);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.DESCRELEVANCIAES);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(RELEVANCIA);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.DESC_RELEVANCIA_EU_010);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.DESCRELEVANCIAEU);
		query.append(DaoConstants.SIGNO_COMA);
		// Datos solicitante
		query.append(DATOS_SOLICITANTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.NOMBRE_077);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.NOMBRESOLICITANTE);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DATOS_SOLICITANTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.APEL1_077);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.APEL1SOLICITANTE);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DATOS_SOLICITANTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.APEL2_077);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.APEL2SOLICITANTE);
		query.append(DaoConstants.SIGNO_COMA);
		// Idioma
		query.append(DATOS_IDIOMA);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.DESC_IDIOMA_ES_009);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.DESCIDIOMAES);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DATOS_IDIOMA);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.DESC_IDIOMA_EU_009);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.DESCIDIOMAEU);

		return query.toString();
	}

	/**
	 * @return String
	 */
	private String getFromExpFactTrad() {
		StringBuilder query = new StringBuilder();

		query.append(DaoConstants.FROM);
		// Facturas
		query.append(DBConstants.TABLA_A4);
		query.append(DaoConstants.BLANK);
		query.append(FACTURAS);
		query.append(DaoConstants.JOIN);
		// Facturas expediente
		query.append(DBConstants.TABLA_A5);
		query.append(DaoConstants.BLANK);
		query.append(FACTURAS_EXPEDIENTE);
		query.append(DaoConstants.ON);
		query.append(FACTURAS);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ID_FACTURA_0A4);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(FACTURAS_EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ID_FACTURA_0A5);
		query.append(DaoConstants.JOIN);
		// Expediente
		query.append(DBConstants.TABLA_51);
		query.append(DaoConstants.BLANK);
		query.append(EXPEDIENTE);
		query.append(DaoConstants.ON);
		query.append(FACTURAS_EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ANYO_0A5);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ANYO_051);
		query.append(DaoConstants.AND);
		query.append(FACTURAS_EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.NUM_EXP_0A5);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.NUM_EXP_051);
		query.append(DaoConstants.JOIN);
		// Expediente traducción/revisión
		query.append(DBConstants.TABLA_53);
		query.append(DaoConstants.BLANK);
		query.append(EXPEDIENTE_TRAD_REV);
		query.append(DaoConstants.ON);
		query.append(EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ANYO_051);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(EXPEDIENTE_TRAD_REV);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ANYO_053);
		query.append(DaoConstants.AND);
		query.append(EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.NUM_EXP_051);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(EXPEDIENTE_TRAD_REV);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.NUM_EXP_053);
		query.append(DaoConstants.JOIN);
		// Expediente a facturar
		query.append(DBConstants.TABLA_58);
		query.append(DaoConstants.BLANK);
		query.append(EXPEDIENTE_FACTURAR);
		query.append(DaoConstants.ON);
		query.append(EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ANYO_051);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(EXPEDIENTE_FACTURAR);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ANYO_058);
		query.append(DaoConstants.AND);
		query.append(EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.NUM_EXP_051);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(EXPEDIENTE_FACTURAR);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.NUM_EXP_058);
		query.append(DaoConstants.AND);
		query.append(EXPEDIENTE_FACTURAR);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.TIPO_ENTIDAD_ASOC_058);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(FACTURAS);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.TIPO_ENTIDAD_ASOC_0A4);
		query.append(DaoConstants.AND);
		query.append(EXPEDIENTE_FACTURAR);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ID_ENTIDAD_ASOC_058);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(FACTURAS);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ID_ENTIDAD_ASOC_0A4);
		query.append(DaoConstants.AND);
		query.append(EXPEDIENTE_FACTURAR);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.DNI_CONTACTO_058);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(FACTURAS);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.DNI_CONTACTO_0A4);
		query.append(DaoConstants.JOIN);
		// Datos facturación expedientes traducidos
		query.append(DBConstants.TABLA_97);
		query.append(DaoConstants.BLANK);
		query.append(FACTURACION_EXP_TRAD);
		query.append(DaoConstants.ON);
		query.append(EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ANYO_051);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(FACTURACION_EXP_TRAD);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ANYO_097);
		query.append(DaoConstants.AND);
		query.append(EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.NUM_EXP_051);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(FACTURACION_EXP_TRAD);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.NUM_EXP_097);
		query.append(DaoConstants.JOIN);
		// Datos facturación contacto/entidad traducción
		query.append(DBConstants.TABLA_98);
		query.append(DaoConstants.BLANK);
		query.append(DATOS_FACTURACION);
		query.append(DaoConstants.ON);
		query.append(EXPEDIENTE_FACTURAR);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ID_058);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(DATOS_FACTURACION);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ID_098);
		query.append(DaoConstants.JOIN);
		// Tipos de relevancia
		query.append(DBConstants.TABLA_10);
		query.append(DaoConstants.BLANK);
		query.append(RELEVANCIA);
		query.append(DaoConstants.ON);
		query.append(EXPEDIENTE_TRAD_REV);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ID_RELEVANCIA_053);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(RELEVANCIA);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ID_TIPO_RELEVANCIA_010);
		// GestorExpediente
		query.append(DaoConstants.JOIN);
		query.append(DBConstants.TABLA_54);
		query.append(DaoConstants.BLANK);
		query.append(GESTOR);
		query.append(DaoConstants.ON);
		query.append(EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ANYO_051);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(GESTOR);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ANYO_054);
		query.append(DaoConstants.AND);
		query.append(EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.NUM_EXP_051);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(GESTOR);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.NUM_EXP_054);
		// NombreApellidosGestor
		query.append(DaoConstants.JOIN);
		query.append(DBConstants.TABLA_77);
		query.append(DaoConstants.BLANK);
		query.append(DATOS_SOLICITANTE);
		query.append(DaoConstants.ON);
		query.append(GESTOR);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.DNI_SOLICITANTE_054);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(DATOS_SOLICITANTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.DNI_077);
		// Idioma
		query.append(DaoConstants.JOIN);
		query.append(DBConstants.TABLA_09);
		query.append(DaoConstants.BLANK);
		query.append(DATOS_IDIOMA);
		query.append(DaoConstants.ON);
		query.append(EXPEDIENTE_TRAD_REV);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ID_IDIOMA_053);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(DATOS_IDIOMA);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ID_IDIOMA_009);

		return query.toString();
	}

	private String getWhereExpFactTrad(Long idFactura, List<Object> params) {
		StringBuilder query = new StringBuilder();

		query.append(DaoConstants.WHERE_1_1);
		query.append(SqlUtils.generarWhereIgual(FACTURAS + DaoConstants.SIGNO_PUNTO + DBConstants.ID_FACTURA_0A4,
				idFactura, params));

		return query.toString();
	}

	/**
	 * @return String
	 */
	private String getSelectExpFactInter() {
		Locale eu = new Locale(Constants.LANG_EUSKERA);
		StringBuilder query = new StringBuilder();

		query.append(DaoConstants.SELECT);
		// Facturas expediente
		query.append(FACTURAS_EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ID_FACTURA_0A5);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.IDFACTURA);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(FACTURAS_EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ANYO_0A5);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.ANYO);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(FACTURAS_EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.NUM_EXP_0A5);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.NUMEXP);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.SUBSTR);
		query.append(DaoConstants.ABRIR_PARENTESIS);
		query.append(FACTURAS_EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ANYO_0A5);
		query.append(",3,4) || '/' || LPAD(");
		query.append(FACTURAS_EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.NUM_EXP_0A5);
		query.append(",6,'0') ");
		query.append(DBConstants.ANYONUMEXPCONCATENADO);
		query.append(DaoConstants.SIGNO_COMA);
		// Expediente
		query.append(EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.FECHA_ALTA_051);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.FECHAALTA);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.TO_CHAR);
		query.append(DaoConstants.ABRIR_PARENTESIS);
		query.append(EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.FECHA_ALTA_051);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.FORMATO_HORA);
		query.append(DaoConstants.CERRAR_PARENTESIS);
		query.append(DBConstants.HORAALTA);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ID_TIPO_EXPEDIENTE_051);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.IDTIPOEXPEDIENTE);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.DECODE + DaoConstants.ABRIR_PARENTESIS);
		query.append(EXPEDIENTE + DaoConstants.SIGNO_PUNTO + DBConstants.ID_TIPO_EXPEDIENTE_051
				+ DaoConstants.SIGNO_COMA + DaoConstants.SIGNO_APOSTROFO + TipoExpedienteEnum.INTERPRETACION.getValue()
				+ DaoConstants.SIGNO_APOSTROFO + DaoConstants.SIGNO_COMA + DaoConstants.SIGNO_APOSTROFO)
				.append(this.msg.getMessage("label.interpretacionAbr", null, eu))
				.append(DaoConstants.SIGNO_APOSTROFO + DaoConstants.SIGNO_COMA + DaoConstants.SIGNO_APOSTROFO
						+ TipoExpedienteEnum.TRADUCCION.getValue() + DaoConstants.SIGNO_APOSTROFO
						+ DaoConstants.SIGNO_COMA + DaoConstants.SIGNO_APOSTROFO)
				.append(this.msg.getMessage("label.traduccionAbr", null, eu))
				.append(DaoConstants.SIGNO_APOSTROFO + DaoConstants.SIGNO_COMA + DaoConstants.SIGNO_APOSTROFO
						+ TipoExpedienteEnum.REVISION.getValue() + DaoConstants.SIGNO_APOSTROFO
						+ DaoConstants.SIGNO_COMA + DaoConstants.SIGNO_APOSTROFO)
				.append(this.msg.getMessage("label.revisionAbr", null, eu)).append(DaoConstants.SIGNO_APOSTROFO);
		query.append(DaoConstants.CERRAR_PARENTESIS);
		query.append(DaoConstants.AS + DBConstants.TIPOEXPEDIENTEDESCEU + DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.DECODE + DaoConstants.ABRIR_PARENTESIS);
		query.append(EXPEDIENTE + DaoConstants.SIGNO_PUNTO + DBConstants.ID_TIPO_EXPEDIENTE_051
				+ DaoConstants.SIGNO_COMA + DaoConstants.SIGNO_APOSTROFO + TipoExpedienteEnum.INTERPRETACION.getValue()
				+ DaoConstants.SIGNO_APOSTROFO + DaoConstants.SIGNO_COMA + DaoConstants.SIGNO_APOSTROFO).append("I")
				.append(DaoConstants.SIGNO_APOSTROFO + DaoConstants.SIGNO_COMA + DaoConstants.SIGNO_APOSTROFO
						+ TipoExpedienteEnum.TRADUCCION.getValue() + DaoConstants.SIGNO_APOSTROFO
						+ DaoConstants.SIGNO_COMA + DaoConstants.SIGNO_APOSTROFO)
				.append("T")
				.append(DaoConstants.SIGNO_APOSTROFO + DaoConstants.SIGNO_COMA + DaoConstants.SIGNO_APOSTROFO
						+ TipoExpedienteEnum.REVISION.getValue() + DaoConstants.SIGNO_APOSTROFO
						+ DaoConstants.SIGNO_COMA + DaoConstants.SIGNO_APOSTROFO)
				.append("R").append(DaoConstants.SIGNO_APOSTROFO);
		query.append(DaoConstants.CERRAR_PARENTESIS);
		query.append(DaoConstants.AS + DBConstants.TIPOEXPEDIENTEDESCES + DaoConstants.SIGNO_COMA);
		// Datos de facturación del expediente
		query.append(DATOS_FACTURACION_EXP);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.NUM_INTERPRETES_0A3);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.NUMINTERPRETES);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DATOS_FACTURACION_EXP);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.HORAS_INTERPRETACION_0A3);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.HORASINTERPRETACION);
		query.append(DaoConstants.SIGNO_COMA);
		// Datos de facturación del expediente de interpretación
		query.append(DATOS_FACTURACION_INTER);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.IMPORTE_BASE_0A6);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.IMPORTEBASE);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DATOS_FACTURACION_INTER);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.IMPORTE_IVA_0A6);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.IMPORTEIVA);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DATOS_FACTURACION_INTER);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.IMPORTE_TOTAL_0A6);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.IMPORTETOTAL);
		query.append(DaoConstants.SIGNO_COMA);
		// Tipo de acto
		query.append(DATOS_TIPO_ACTO);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.DESC_ES_008);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.TIPOACTODESCES);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DATOS_TIPO_ACTO);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.DESC_EU_008);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.TIPOACTODESCEU);
		query.append(DaoConstants.SIGNO_COMA);
		// Datos solicitante
		query.append(DATOS_SOLICITANTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.NOMBRE_077);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.NOMBRESOLICITANTE);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DATOS_SOLICITANTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.APEL1_077);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.APEL1SOLICITANTE);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DATOS_SOLICITANTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.APEL2_077);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.APEL2SOLICITANTE);

		return query.toString();
	}

	/**
	 * @return String
	 */
	private String getFromExpFactInter() {
		StringBuilder query = new StringBuilder();

		query.append(DaoConstants.FROM);
		// Facturas
		query.append(DBConstants.TABLA_A4);
		query.append(DaoConstants.BLANK);
		query.append(FACTURAS);
		query.append(DaoConstants.JOIN);
		// Facturas expediente
		query.append(DBConstants.TABLA_A5);
		query.append(DaoConstants.BLANK);
		query.append(FACTURAS_EXPEDIENTE);
		query.append(DaoConstants.ON);
		query.append(FACTURAS);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ID_FACTURA_0A4);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(FACTURAS_EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ID_FACTURA_0A5);
		query.append(DaoConstants.JOIN);
		// Expediente
		query.append(DBConstants.TABLA_51);
		query.append(DaoConstants.BLANK);
		query.append(EXPEDIENTE);
		query.append(DaoConstants.ON);
		query.append(FACTURAS_EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ANYO_0A5);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ANYO_051);
		query.append(DaoConstants.AND);
		query.append(FACTURAS_EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.NUM_EXP_0A5);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.NUM_EXP_051);
		query.append(DaoConstants.JOIN);
		// Expediente de interpretación
		query.append(DBConstants.TABLA_52);
		query.append(DaoConstants.BLANK);
		query.append(EXPEDIENTE_INTER);
		query.append(DaoConstants.ON);
		query.append(EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ANYO_051);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(EXPEDIENTE_INTER);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ANYO_052);
		query.append(DaoConstants.AND);
		query.append(EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.NUM_EXP_051);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(EXPEDIENTE_INTER);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.NUM_EXP_052);
		query.append(DaoConstants.JOIN);
		// Expediente a facturar
		query.append(DBConstants.TABLA_58);
		query.append(DaoConstants.BLANK);
		query.append(EXPEDIENTE_FACTURAR);
		query.append(DaoConstants.ON);
		query.append(EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ANYO_051);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(EXPEDIENTE_FACTURAR);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ANYO_058);
		query.append(DaoConstants.AND);
		query.append(EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.NUM_EXP_051);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(EXPEDIENTE_FACTURAR);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.NUM_EXP_058);
		query.append(DaoConstants.AND);
		query.append(EXPEDIENTE_FACTURAR);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.TIPO_ENTIDAD_ASOC_058);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(FACTURAS);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.TIPO_ENTIDAD_ASOC_0A4);
		query.append(DaoConstants.AND);
		query.append(EXPEDIENTE_FACTURAR);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ID_ENTIDAD_ASOC_058);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(FACTURAS);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ID_ENTIDAD_ASOC_0A4);
		query.append(DaoConstants.AND);
		query.append(EXPEDIENTE_FACTURAR);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.DNI_CONTACTO_058);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(FACTURAS);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.DNI_CONTACTO_0A4);
		query.append(DaoConstants.JOIN);
		// Datos de facturación de expedientes de interpretación
		query.append(DBConstants.TABLA_A3);
		query.append(DaoConstants.BLANK);
		query.append(DATOS_FACTURACION_EXP);
		query.append(DaoConstants.ON);
		query.append(EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ANYO_051);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(DATOS_FACTURACION_EXP);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ANYO_0A3);
		query.append(DaoConstants.AND);
		query.append(EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.NUM_EXP_051);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(DATOS_FACTURACION_EXP);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.NUM_EXP_0A3);
		query.append(DaoConstants.JOIN);
		// Datos de facturación entidad/contacto interpretación
		query.append(DBConstants.TABLA_A6);
		query.append(DaoConstants.BLANK);
		query.append(DATOS_FACTURACION_INTER);
		query.append(DaoConstants.ON);
		query.append(EXPEDIENTE_FACTURAR);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ID_058);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(DATOS_FACTURACION_INTER);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ID_0A6);
		query.append(DaoConstants.JOIN);
		// Tipos de acto
		query.append(DBConstants.TABLA_08);
		query.append(DaoConstants.BLANK);
		query.append(DATOS_TIPO_ACTO);
		query.append(DaoConstants.ON);
		query.append(EXPEDIENTE_INTER);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.TIPO_ACTO_052);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(DATOS_TIPO_ACTO);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ID_008);
		// GestorExpediente
		query.append(DaoConstants.JOIN);
		query.append(DBConstants.TABLA_54);
		query.append(DaoConstants.BLANK);
		query.append(GESTOR);
		query.append(DaoConstants.ON);
		query.append(EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ANYO_051);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(GESTOR);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ANYO_054);
		query.append(DaoConstants.AND);
		query.append(EXPEDIENTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.NUM_EXP_051);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(GESTOR);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.NUM_EXP_054);
		// NombreApellidosGestor
		query.append(DaoConstants.JOIN);
		query.append(DBConstants.TABLA_77);
		query.append(DaoConstants.BLANK);
		query.append(DATOS_SOLICITANTE);
		query.append(DaoConstants.ON);
		query.append(GESTOR);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.DNI_SOLICITANTE_054);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(DATOS_SOLICITANTE);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.DNI_077);

		return query.toString();
	}

	private String getWhereExpFactInter(Long idFactura, List<Object> params) {
		StringBuilder query = new StringBuilder();

		query.append(DaoConstants.WHERE_1_1);
		query.append(SqlUtils.generarWhereIgual(FACTURAS + DaoConstants.SIGNO_PUNTO + DBConstants.ID_FACTURA_0A4,
				idFactura, params));

		return query.toString();
	}

	@Override
	public Fichero findDocumentoFactura(Long idFactura) {
		return findDocumento(idFactura, TipoDocumentoPagoEnum.FACTURA.getValue());
	}

	@Override
	public Fichero findCartaPago(Long idFactura) {
		return findDocumento(idFactura, TipoDocumentoPagoEnum.CARTA_PAGO.getValue());
	}

	public Fichero findDocumento(Long idFactura, int tipoDocumento) {
		StringBuilder query = new StringBuilder();
		List<Object> params = new ArrayList<Object>();

		query.append(getSelectDocumento());
		query.append(getFromDocumento(tipoDocumento));
		query.append(getWhereDocumento(idFactura, params));

		List<Fichero> listFicheros = this.getJdbcTemplate().query(query.toString(), this.rwMapDocumento,
				params.toArray());

		return DataAccessUtils.uniqueResult(listFicheros);
	}

	/**
	 * @return String
	 */
	private String getSelectDocumento() {
		StringBuilder query = new StringBuilder();

		query.append(DaoConstants.SELECT);
		query.append(DATOS_FICHEROS);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.T19_OID);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.OIDFICHERO);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DATOS_FICHEROS);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.T19_NOMBRE_FICHERO);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.NOMBREFICHERO);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DATOS_FICHEROS);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.T19_TIPO_FICHERO);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.CONTENTTYPE);

		query.append(DaoConstants.SIGNO_COMA);
		query.append(FACTURAS);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(" ID_FACTURA_0A4 IDFACTURA ");
		return query.toString();
	}

	/**
	 * @param tipoDocumento int
	 * @return String
	 */
	private String getFromDocumento(int tipoDocumento) {
		StringBuilder query = new StringBuilder();

		query.append(DaoConstants.FROM);
		// Facturas
		query.append(DBConstants.TABLA_A4);
		query.append(DaoConstants.BLANK);
		query.append(FACTURAS);
		query.append(DaoConstants.JOIN);
		// Datos del fichero
		query.append(DBConstants.TABLA_W0519S01);
		query.append(DaoConstants.BLANK);
		query.append(DATOS_FICHEROS);
		query.append(DaoConstants.ON);
		query.append(FACTURAS);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ID_LIQUIDACION_0A4);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(DATOS_FICHEROS);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.T12_REFERENCIA);
		query.append(DaoConstants.AND);
		query.append(DATOS_FICHEROS);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.T19_TIPO_DOCUMENTO);
		query.append(DaoConstants.SIGNOIGUAL);
		query.append(tipoDocumento);

		return query.toString();
	}

	private String getWhereDocumento(Long idFactura, List<Object> params) {
		StringBuilder query = new StringBuilder();

		query.append(DaoConstants.WHERE_1_1);
		query.append(SqlUtils.generarWhereIgual(FACTURAS + DaoConstants.SIGNO_PUNTO + DBConstants.ID_FACTURA_0A4,
				idFactura, params));

		return query.toString();
	}

	@Override
	public Object consultaFacturas(Facturas factura, String idioma, JQGridRequestDto jqGridRequestDto,
			Boolean startsWith, Boolean isCount) {
		StringBuilder query = new StringBuilder(FacturasDaoImpl.STRING_BUILDER_INIT);
		StringBuilder paginatedQuery = new StringBuilder(FacturasDaoImpl.STRING_BUILDER_INIT);
		List<Object> params = new ArrayList<Object>();

		if (isCount) {
			query.append(DaoConstants.SELECT + DaoConstants.COUNT + DaoConstants.ABRIR_PARENTESIS
					+ DaoConstants.DISTINCT + DBConstants.ID_FACTURA_0A4 + DaoConstants.CERRAR_PARENTESIS);
		} else {
			query.append(getSelectConsultaFacturas(idioma));
		}

		query.append(getFromConsultaFacturas());
		this.getFromConsultaFacturasFilters(factura, query);
		query.append(getWhereConsultaFacturas(factura, params));

		paginatedQuery.append(Utils.getPaginationQuery(jqGridRequestDto, isCount, query));

		if (isCount) {
			return this.getJdbcTemplate().queryForObject(paginatedQuery.toString(), params.toArray(), Long.class);
		} else {
			return this.getJdbcTemplate().query(paginatedQuery.toString(), this.rwMapConsultaFacturas,
					params.toArray());
		}
	}

	public void getFromConsultaFacturasFilters(Facturas factura, StringBuilder query) {
		if (factura.getAnyoExp() != null || factura.getNumExp() != null
				|| factura.getTituloExp() != null && !factura.getTituloExp().isEmpty()) {
			query.append(" JOIN AA79BA5S01 ON ID_FACTURA_0A5 = ID_FACTURA_0A4 ");
		}
		if (factura.getTituloExp() != null && !factura.getTituloExp().isEmpty()) {
			query.append(" JOIN AA79B51S01 ON ANYO_051 = ANYO_0A5  AND NUM_EXP_051 = NUM_EXP_0A5");
		}
	}

	@Override
	public Object expedientesFacturaTraduccion(Long idFactura, JQGridRequestDto jqGridRequestDto, Boolean startsWith,
			Boolean isCount) {
		StringBuilder query = new StringBuilder(FacturasDaoImpl.STRING_BUILDER_INIT);
		StringBuilder paginatedQuery = new StringBuilder(FacturasDaoImpl.STRING_BUILDER_INIT);
		List<Object> params = new ArrayList<Object>();

		if (isCount) {
			query.append(DaoConstants.SELECT + DaoConstants.COUNT + DaoConstants.ABRIR_PARENTESIS);
			query.append(DaoConstants.DISTINCT);
			query.append("SUBSTR (ANYO_0A5, 2, 4)  || LPAD ( NUM_EXP_0A5, 6, '0' )");
			query.append(DaoConstants.CERRAR_PARENTESIS);
		} else {
			query.append(getSelectExpFactTrad());
		}

		query.append(getFromExpFactTrad());
		query.append(getWhereExpFactTrad(idFactura, params));

		paginatedQuery.append(Utils.getPaginationQuery(jqGridRequestDto, isCount, query));

		if (isCount) {
			return this.getJdbcTemplate().queryForObject(paginatedQuery.toString(), params.toArray(), Long.class);
		} else {
			return this.getJdbcTemplate().query(paginatedQuery.toString(), this.rwMapExpFactTrad, params.toArray());
		}
	}

	@Override
	public Object expedientesFacturaInterpretacion(Long idFactura, JQGridRequestDto jqGridRequestDto,
			Boolean startsWith, Boolean isCount) {
		StringBuilder query = new StringBuilder(FacturasDaoImpl.STRING_BUILDER_INIT);
		StringBuilder paginatedQuery = new StringBuilder(FacturasDaoImpl.STRING_BUILDER_INIT);
		List<Object> params = new ArrayList<Object>();

		if (isCount) {
			query.append(DaoConstants.SELECT + DaoConstants.COUNT + DaoConstants.ABRIR_PARENTESIS);
			query.append(DaoConstants.DISTINCT);
			query.append("SUBSTR (ANYO_0A5, 2, 4)  || LPAD ( NUM_EXP_0A5, 6, '0' )");
			query.append(DaoConstants.CERRAR_PARENTESIS);
		} else {
			query.append(getSelectExpFactInter());
		}

		query.append(getFromExpFactInter());
		query.append(getWhereExpFactInter(idFactura, params));

		paginatedQuery.append(Utils.getPaginationQuery(jqGridRequestDto, isCount, query));

		if (isCount) {
			return this.getJdbcTemplate().queryForObject(paginatedQuery.toString(), params.toArray(), Long.class);
		} else {
			return this.getJdbcTemplate().query(paginatedQuery.toString(), this.rwMapExpFactInter, params.toArray());
		}
	}

	@Override
	public void remove(Facturas factura) {
		String query = "DELETE FROM AA79BA4S01 WHERE ID_FACTURA_0A4=?";
		this.getJdbcTemplate().update(query, factura.getIdFactura());
	}

}