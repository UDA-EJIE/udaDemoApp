package com.ejie.aa79b.dao;

import java.math.BigDecimal;
import java.sql.CallableStatement;
import java.sql.Connection;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Types;
import java.util.ArrayList;
import java.util.List;

import org.springframework.dao.support.DataAccessUtils;
import org.springframework.jdbc.core.CallableStatementCallback;
import org.springframework.jdbc.core.CallableStatementCreator;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.common.DBConstants;
import com.ejie.aa79b.common.DaoConstants;
import com.ejie.aa79b.common.SqlUtils;
import com.ejie.aa79b.dao.mapper.DatosTareaTradosRowMapper;
import com.ejie.aa79b.model.DatosTareaTrados;
import com.ejie.aa79b.model.Expediente;
import com.ejie.aa79b.model.enums.EstadoEjecucionTareaEnum;
import com.ejie.aa79b.model.enums.TipoTareaGestionAsociadaEnum;

/**
 * DatosTareaTradosDaoImpl generated by UDA, 19-jun-2018 13:27:18.
 *
 * @author UDA
 */

@Repository
@Transactional
public class DatosTareaTradosDaoImpl extends GenericoDaoImpl<DatosTareaTrados> implements DatosTareaTradosDao {

	protected static final String ID_TAREA_090 = "ID_TAREA_090";

	protected static final String[] ORDER_BY_WHITE_LIST = new String[] { DBConstants.IDTAREA,
			DBConstants.IDFICHEROTRADOS, DBConstants.INDVISIBLE, DBConstants.PRESUPUESTO, DBConstants.FECHAENTREGA,
			DBConstants.TARIFAPAL, DBConstants.NUMTOTALPAL, DBConstants.NUMPALCONCOR084, DBConstants.NUMPALCONCOR8594,
			DBConstants.NUMPALCONCOR95100, "NUMPALCONCOR9599", "NUMPALCONCOR100" };

	/*
	 * ROW_MAPPERS
	 */
	private RowMapper<DatosTareaTrados> rwMap = new DatosTareaTradosRowMapper();

	private RowMapper<DatosTareaTrados> rwMapPK = new RowMapper<DatosTareaTrados>() {
		@Override
		public DatosTareaTrados mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			DatosTareaTrados datosTareaTrados = new DatosTareaTrados();
			datosTareaTrados.setIdTarea(resultSet.getBigDecimal("IDTAREA090"));

			return datosTareaTrados;
		}
	};

	/**
	 * Constructor
	 */
	public DatosTareaTradosDaoImpl() {
		super(DatosTareaTrados.class);
	}

	@Override
	public DatosTareaTrados add(DatosTareaTrados datostareatrados) {
		String query = "INSERT INTO AA79B90S01 (ID_TAREA_090, ID_FICHERO_TRADOS_090, IND_VISIBLE_090, PRESUPUESTO_090, FECHA_ENTREGA_090, TARIFA_PAL_090, NUM_TOTAL_PAL_090, NUM_PAL_CONCOR_0_84_090, NUM_PAL_CONCOR_85_94_090, NUM_PAL_CONCOR_95_100_090, NUM_PAL_CONCOR_95_99_090, NUM_PAL_CONCOR_100_090,NOMBRE_PROYECTO_090, FECHA_PROYECTO_090) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?)";
		this.getJdbcTemplate().update(query, datostareatrados.getIdTarea(), datostareatrados.getIdFicheroTrados(),
				datostareatrados.getIndVisible(), datostareatrados.getPresupuesto(), datostareatrados.getFechaEntrega(),
				datostareatrados.getTarifaPal(), datostareatrados.getNumTotalPal(),
				datostareatrados.getNumPalConcor084(), datostareatrados.getNumPalConcor8594(),
				datostareatrados.getNumPalConcor95100(), datostareatrados.getNumPalConcor9599(), datostareatrados.getNumPalConcor100(),datostareatrados.getNombreFicheroTrados(),
				datostareatrados.getFechaProyecto());
		return datostareatrados;
	}

	@Override
	public DatosTareaTrados update(DatosTareaTrados datostareatrados) {
		String query = "UPDATE AA79B90S01 SET ID_FICHERO_TRADOS_090=?, IND_VISIBLE_090=?, PRESUPUESTO_090=?, FECHA_ENTREGA_090=?, TARIFA_PAL_090=?, NUM_TOTAL_PAL_090=?, NUM_PAL_CONCOR_0_84_090=?, NUM_PAL_CONCOR_85_94_090=?, NUM_PAL_CONCOR_95_100_090=?, NUM_PAL_CONCOR_95_99_090=?, NUM_PAL_CONCOR_100_090=?, NOMBRE_PROYECTO_090=?, FECHA_PROYECTO_090=? WHERE ID_TAREA_090=?";
		this.getJdbcTemplate().update(query, datostareatrados.getIdFicheroTrados(), datostareatrados.getIndVisible(),
				datostareatrados.getPresupuesto(), datostareatrados.getFechaEntrega(), datostareatrados.getTarifaPal(),
				datostareatrados.getNumTotalPal(), datostareatrados.getNumPalConcor084(),
				datostareatrados.getNumPalConcor8594(), datostareatrados.getNumPalConcor95100(),
				datostareatrados.getNumPalConcor9599(), datostareatrados.getNumPalConcor100(),
				datostareatrados.getNombreFicheroTrados(), datostareatrados.getFechaProyecto(),
				datostareatrados.getIdTarea());
		return datostareatrados;
	}

	@Override
	public Integer updateIdFichero(DatosTareaTrados datostareatrados) {
		String query = "UPDATE AA79B90S01 SET ID_FICHERO_TRADOS_090=? WHERE ID_TAREA_090=?";
		return this.getJdbcTemplate().update(query, datostareatrados.getIdFicheroTrados(),
				datostareatrados.getIdTarea());
	}

	@Override
	public void remove(DatosTareaTrados datostareatrados) {
		String query = "DELETE FROM AA79B90S01 WHERE ID_TAREA_090=?";
		this.getJdbcTemplate().update(query, datostareatrados.getIdTarea());
	}

	@Override
	public DatosTareaTrados findDatosTareaTrados(Expediente expediente) {
		List<Object> params = new ArrayList<Object>();
		params.add(expediente.getAnyo());
		params.add(expediente.getNumExp());

		StringBuilder query = new StringBuilder(this.getSelect());
		query.append(this.getFrom());
		query.append(" WHERE t2.ANYO_081 = ? AND t2.NUM_EXP_081 = ? AND t2.ID_TIPO_TAREA_081 = ");
		query.append(TipoTareaGestionAsociadaEnum.PROYECTO_TRADOS.getValue());

		List<DatosTareaTrados> beanList = this.getJdbcTemplate().query(query.toString(), this.getRwMap(),
				params.toArray());
		return DataAccessUtils.uniqueResult(beanList);
	}

	@Override()
	protected String getSelect() {
		StringBuilder query = new StringBuilder();

		query.append("SELECT t1.ID_TAREA_090 IDTAREA");
		query.append(", t1.ID_FICHERO_TRADOS_090 IDFICHEROTRADOS");
		query.append(", t1.IND_VISIBLE_090 INDVISIBLE");
		query.append(", t1.PRESUPUESTO_090 PRESUPUESTO");
		query.append(", t1.IMPORTE_BASE_090 IMPORTEBASE");
		query.append(", t1.IMPORTE_IVA_090 IMPORTEIVA");
		query.append(", t1.POR_IVA_090 PORIVA");
		query.append(", t1.FECHA_ENTREGA_090 FECHAENTREGA");
		query.append(", TO_CHAR(t1.FECHA_ENTREGA_090,'HH24:MI') HORAENTREGA");
		query.append(", t1.TARIFA_PAL_090 TARIFAPAL");
		query.append(", NVL(t1.NUM_TOTAL_PAL_090, 0) AS NUMTOTALPAL");
		query.append(", NVL(t1.NUM_PAL_CONCOR_0_84_090, 0) AS NUMPALCONCOR084");
		query.append(", NVL(t1.NUM_PAL_CONCOR_85_94_090, 0) AS NUMPALCONCOR8594");
		query.append(", NVL(t1.NUM_PAL_CONCOR_95_100_090, 0) AS NUMPALCONCOR95100");
		query.append(", NVL(t1.NUM_PAL_CONCOR_95_99_090, 0) AS NUMPALCONCOR9599");
		query.append(", NVL(t1.NUM_PAL_CONCOR_100_090, 0) AS NUMPALCONCOR100");
		query.append(", t1.NOMBRE_PROYECTO_090 NOMBREPROYECTO");
		query.append(", t1.FECHA_PROYECTO_090 FECHAPROYECTO");
		query.append(", t2.ID_REQUERIMIENTO_081 IDREQUERIMIENTO");
		query.append(", t3.URL_ORDEN_030 URLORDEN ");
		query.append(", t4.PRECIO_MINIMO_032 PRECIOMINIMO ");

		return query.toString();
	}

	@Override()
	protected String getFrom() {
		StringBuilder query = new StringBuilder();

		query.append(" FROM AA79B90S01 t1 ");
		query.append(DaoConstants.LEFT_JOIN + DBConstants.TABLA_81 + " t2 ");
		query.append(DaoConstants.ON + "t1.ID_TAREA_090 = t2.ID_TAREA_081");
		query.append(DaoConstants.LEFT_JOIN + " AA79B30S01 t3 ON ID_ORDEN_090 = ID_030 ");
		query.append(DaoConstants.LEFT_JOIN + " AA79B32S01 t4 ON ID_030 = ID_ORDEN_032 ");

		return query.toString();
	}

	@Override()
	protected RowMapper<DatosTareaTrados> getRwMap() {
		return this.rwMap;
	}

	@Override()
	protected String[] getOrderBy() {
		return DatosTareaTradosDaoImpl.ORDER_BY_WHITE_LIST;
	}

	@Override()
	protected String getPK() {
		return ID_TAREA_090;
	}

	@Override()
	protected RowMapper<DatosTareaTrados> getRwMapPK() {
		return this.rwMapPK;
	}

	@Override()
	protected String getWherePK(DatosTareaTrados bean, List<Object> params) {
		params.add(bean.getIdTarea());
		return " WHERE t1.ID_TAREA_090 = ?";
	}

	@Override()
	protected String getWhere(DatosTareaTrados bean, List<Object> params) {

		return this.getWhereClause(bean, params);
	}

	@Override()
	protected String getWhereLike(DatosTareaTrados bean, Boolean startsWith, List<Object> params, Boolean search) {

		return this.getWhereClause(bean, params);
	}

	/**
	 * Obtiene la clausula where
	 *
	 * @param bean   DatosTareaTrados
	 * @param params List<Object>
	 * @return String
	 */
	private String getWhereClause(DatosTareaTrados bean, List<Object> params) {
		StringBuilder where = new StringBuilder(DatosTareaTradosDaoImpl.STRING_BUILDER_INIT);

		if (bean != null) {
			where.append(SqlUtils.generarWhereIgual(ID_TAREA_090, bean.getIdTarea(), params));
			where.append(SqlUtils.generarWhereIgual("ID_FICHERO_TRADOS_090", bean.getIdFicheroTrados(), params));
			where.append(SqlUtils.generarWhereIgual("IND_VISIBLE_090", bean.getIndVisible(), params));
			where.append(SqlUtils.generarWhereIgual("PRESUPUESTO_090", bean.getPresupuesto(), params));
			where.append(SqlUtils.generarWhereIgual("FECHA_ENTREGA_090", bean.getFechaEntrega(), params));
			where.append(SqlUtils.generarWhereIgual("TARIFA_PAL_090", bean.getTarifaPal(), params));
			where.append(SqlUtils.generarWhereIgual("NUM_TOTAL_PAL_090", bean.getNumTotalPal(), params));
			where.append(SqlUtils.generarWhereIgual("NUM_PAL_CONCOR_0_84_090", bean.getNumPalConcor084(), params));
			where.append(SqlUtils.generarWhereIgual("NUM_PAL_CONCOR_85_94_090", bean.getNumPalConcor8594(), params));
			where.append(SqlUtils.generarWhereIgual("NUM_PAL_CONCOR_95_100_090", bean.getNumPalConcor95100(), params));
			where.append(SqlUtils.generarWhereIgual("NUM_PAL_CONCOR_95_99_090", bean.getNumPalConcor9599(), params));
			where.append(SqlUtils.generarWhereIgual("NUM_PAL_CONCOR_100_090", bean.getNumPalConcor100(), params));
		}

		return where.toString();
	}

	@Override
	public BigDecimal calcularPresupuestoTraduccion(final Long anyo, final Integer numExp, final BigDecimal idTarea) {
		BigDecimal presupuesto = this.getJdbcTemplate().execute(new CallableStatementCreator() {
			@Override()
			public CallableStatement createCallableStatement(Connection connection) throws SQLException {
				CallableStatement callableStatement = connection
						.prepareCall("{?= call CALCULO_PRESUPUESTO_TRADUCCION(?,?,?)}");
				callableStatement.registerOutParameter(1, Types.NUMERIC);
				callableStatement.setLong(2, anyo);
				callableStatement.setInt(3, numExp);
				callableStatement.setBigDecimal(4, idTarea);
				return callableStatement;
			}
		}, new CallableStatementCallback<BigDecimal>() {

			@Override
			public BigDecimal doInCallableStatement(CallableStatement cs) throws SQLException {
				cs.execute();
				return cs.getBigDecimal(1);
			}
		});
		return presupuesto;
	}

	@Override
	public DatosTareaTrados getInfoDocumentoPresupuestoTraduccion(Long anyo, Integer numExp, Long idRequerimiento) {
		StringBuilder query = new StringBuilder();
		List<Object> params = new ArrayList<Object>();
		// recupero todos los campos para poder usar el rowmapper que ya existe
		query.append("SELECT t1.ID_TAREA_090 IDTAREA");
		query.append(", t1.ID_FICHERO_TRADOS_090 IDFICHEROTRADOS");
		query.append(", t1.IND_VISIBLE_090 INDVISIBLE");
		query.append(", t1.PRESUPUESTO_090 PRESUPUESTO");
		query.append(", NVL(t1.PRESUPUESTO_090, 0) as PRESUPUESTO");
		query.append(", NVL(t1.IMPORTE_BASE_090, 0) as IMPORTEBASE");
		query.append(", NVL(t1.IMPORTE_IVA_090, 0) as IMPORTEIVA");
		query.append(", t1.POR_IVA_090 PORIVA");
		query.append(", t1.FECHA_ENTREGA_090 FECHAENTREGA");
		query.append(", TO_CHAR(t1.FECHA_ENTREGA_090,'HH24:MI') HORAENTREGA");
		query.append(", t1.TARIFA_PAL_090 TARIFAPAL");
		query.append(", NVL(t1.TARIFA_PAL_090, 0) as TARIFAPAL");
		query.append(", t1.NUM_TOTAL_PAL_090 NUMTOTALPAL");
		query.append(", t1.NUM_PAL_CONCOR_0_84_090 NUMPALCONCOR084");
		query.append(", t1.NUM_PAL_CONCOR_85_94_090 NUMPALCONCOR8594");
		query.append(", t1.NUM_PAL_CONCOR_95_100_090 NUMPALCONCOR95100");
		query.append(", t1.NUM_PAL_CONCOR_95_99_090 NUMPALCONCOR9599");
		query.append(", t1.NUM_PAL_CONCOR_100_090 NUMPALCONCOR100");
		query.append(", t1.NOMBRE_PROYECTO_090 NOMBREPROYECTO");
		query.append(", t1.FECHA_PROYECTO_090 FECHAPROYECTO");
		query.append(", t2.ID_REQUERIMIENTO_081 IDREQUERIMIENTO");
		query.append(", t3.URL_ORDEN_030 URLORDEN");
		query.append(", t4.PRECIO_MINIMO_032 PRECIOMINIMO ");
		query.append(" FROM AA79B81S01 t2 JOIN AA79B90S01 t1 ON ID_TAREA_090 = ID_TAREA_081 ");
		query.append(DaoConstants.JOIN + " AA79B30S01 t3 ON ID_ORDEN_090 = ID_030 ");
		query.append(DaoConstants.JOIN + " AA79B32S01 t4 ON ID_030 = ID_ORDEN_032 ");
		query.append(" WHERE ID_TIPO_TAREA_081 = ").append(TipoTareaGestionAsociadaEnum.PROYECTO_TRADOS.getValue());

		if (!idRequerimiento.equals(Constants.MAGIC_NUMBER_MENOS_1_L)) {
			query.append(" AND ESTADO_EJECUCION_081 = ").append(EstadoEjecucionTareaEnum.EJECUTADA.getValue());
			query.append(" AND ID_REQUERIMIENTO_081 = ? ");
			params.add(idRequerimiento);
		}
		query.append(" AND ANYO_081 = ? AND NUM_EXP_081 = ? ");
		params.add(anyo);
		params.add(numExp);

		List<DatosTareaTrados> docList = this.getJdbcTemplate().query(query.toString(), this.getRwMap(),
				params.toArray());
		return DataAccessUtils.uniqueResult(docList);
	}
}
