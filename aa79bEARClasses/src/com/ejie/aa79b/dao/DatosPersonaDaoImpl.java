package com.ejie.aa79b.dao;

import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;
import java.util.Locale;

import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.support.ReloadableResourceBundleMessageSource;
import org.springframework.dao.support.DataAccessUtils;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.common.DBConstants;
import com.ejie.aa79b.common.DaoConstants;
import com.ejie.aa79b.common.SqlUtils;
import com.ejie.aa79b.dao.mapper.DatosPersonaPersonalIzoRowMapper;
import com.ejie.aa79b.dao.mapper.DatosPersonaProveedorExternoRowMapper;
import com.ejie.aa79b.dao.mapper.DatosPersonaReceptorAutorizadoRowMapper;
import com.ejie.aa79b.dao.mapper.DatosPersonaRowMapper;
import com.ejie.aa79b.dao.mapper.DatosPersonaSolicitanteRowMapper;
import com.ejie.aa79b.model.DatosPersona;
import com.ejie.aa79b.model.ListaDatosPersona;
import com.ejie.aa79b.model.enums.EstadoEnum;
import com.ejie.aa79b.model.enums.PerfilEnum;
import com.ejie.aa79b.model.enums.TipoEntidadEnum;
import com.ejie.aa79b.model.webservices.Aa79bPersona;
import com.ejie.aa79b.utils.DAOUtils;
import com.ejie.aa79b.utils.JQGridManagerCustom;
import com.ejie.aa79b.utils.Utils;
import com.ejie.x38.dao.RowNumResultSetExtractor;
import com.ejie.x38.dto.JQGridRequestDto;
import com.ejie.x38.dto.TableRowDto;

/**
 * DatosPersonaDaoImpl generated by UDA, 22-feb-2018 14:12:09.
 * 
 * @author UDA
 */

@Repository
@Transactional
public class DatosPersonaDaoImpl extends GenericoDaoImpl<DatosPersona> implements DatosPersonaDao {

	@Autowired()
	private ReloadableResourceBundleMessageSource msg;

	public DatosPersonaDaoImpl() {
		super(DatosPersona.class);
	}

	public static final String[] ORDER_BY_WHITE_LIST = new String[] { DBConstants.DNI, DBConstants.TIPIDEN,
			DBConstants.PREDNI, DBConstants.SUFDNI, DBConstants.NOMBRE, DBConstants.APEL1_DATOS_PERSONA,
			DBConstants.APEL2_DATOS_PERSONA, DBConstants.TIPO, DBConstants.CODIGO, DBConstants.CDIRNORA,
			DBConstants.IVA, DBConstants.FACTURABLE, DBConstants.ESTADO, DBConstants.CIF, DBConstants.DESCAMPEU,
			DBConstants.DESCAMPES, DBConstants.DESCEU, DBConstants.DESCES, "APELLIDOS", DBConstants.TIPOENTIDADDESCEU };

	/*
	 * ROW_MAPPERS
	 */
	private RowMapper<DatosPersona> rwMap = new DatosPersonaRowMapper();

	private RowMapper<DatosPersona> rwMapSolicitante = new DatosPersonaSolicitanteRowMapper();

	private RowMapper<DatosPersona> rwMapReceptorAutorizado = new DatosPersonaReceptorAutorizadoRowMapper();

	private RowMapper<DatosPersona> rwMapPersonalIZO = new DatosPersonaPersonalIzoRowMapper();

	private RowMapper<DatosPersona> rwMapProveedorExterno = new DatosPersonaProveedorExternoRowMapper();

	private RowMapper<DatosPersona> rwMapPK = new RowMapper<DatosPersona>() {
		@Override
		public DatosPersona mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			DatosPersona datosPersona = new DatosPersona();
			datosPersona.setDni(resultSet.getString(DBConstants.DNI));

			return datosPersona;
		}
	};

	private RowMapper<Aa79bPersona> rwMapAa79bPK = new RowMapper<Aa79bPersona>() {
		@Override
		public Aa79bPersona mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			Aa79bPersona datosPersona = new Aa79bPersona();
			datosPersona.setDni(resultSet.getString(DBConstants.DNI));

			return datosPersona;
		}
	};

	protected RowMapper<Aa79bPersona> getRwMapAa79bPK() {
		return this.rwMapAa79bPK;
	}

	private RowMapper<Aa79bPersona> rwMapPersonas = new RowMapper<Aa79bPersona>() {
		@Override()
		public Aa79bPersona mapRow(ResultSet resultSet, int rowNum) throws SQLException {

			Aa79bPersona persona = new Aa79bPersona();
			persona.setDni(resultSet.getString(DBConstants.DNI));
			persona.setNombre(resultSet.getString(DBConstants.NOMBRE));
			persona.setApe1(resultSet.getString("APE1"));
			persona.setApe2(resultSet.getString("APE2"));
			persona.setSufDni(resultSet.getString("SUFDNI"));
			persona.setPreDni(resultSet.getString("PREDNI"));
			return persona;
		}
	};

	@Override
	protected String getSelect() {

		StringBuilder query = new StringBuilder();
		query.append("SELECT t1.DNI_077 DNI");
		query.append(", t1.TIPIDEN_077 TIPIDEN");
		query.append(", t1.PREDNI_077 PREDNI");
		query.append(", t1.SUFDNI_077 SUFDNI");
		query.append(", t1.NOMBRE_077 NOMBRE");
		query.append(", t1.APEL1_077 APELLIDO1");
		query.append(", t1.APEL2_077 APELLIDO2");
		query.append(", (t1.PREDNI_077 || t1.DNI_077 || t1.SUFDNI_077) AS DNICOMPLETO");

		return query.toString();
	}

	@Override
	protected String getFrom() {
		return " FROM AA79B77S01 t1";
	}

	@Override
	protected RowMapper<DatosPersona> getRwMap() {
		return this.rwMap;
	}

	@Override
	protected String[] getOrderBy() {
		return DatosPersonaDaoImpl.ORDER_BY_WHITE_LIST;
	}

	@Override
	protected String getPK() {
		return DBConstants.DNI;
	}

	@Override
	protected RowMapper<DatosPersona> getRwMapPK() {
		return this.rwMapPK;
	}

	@Override
	protected String getWherePK(DatosPersona bean, List<Object> params) {
		params.add(bean.getDni());
		return "WHERE DNI = ?";
	}

	@Override
	protected String getWhere(DatosPersona bean, List<Object> params) {
		StringBuilder whereDatosPersona = new StringBuilder();
		whereDatosPersona.append(DaoConstants.WHERE_1_1);
		whereDatosPersona.append(SqlUtils.generarWhereLike("t1.DNI_077", bean.getDni(), params, false));
		whereDatosPersona.append(SqlUtils.generarWhereIgual("t1.TIPIDEN_077", bean.getTipIden(), params));
		whereDatosPersona.append(SqlUtils.generarWhereLike("t1.PREDNI_077", bean.getPreDni(), params, false));
		whereDatosPersona.append(SqlUtils.generarWhereLike("t1.SUFDNI_077", bean.getSufDni(), params, false));
		whereDatosPersona.append(SqlUtils.generarWhereLike("t1.NOMBRE_077", bean.getNombre(), params, false));
		whereDatosPersona.append(SqlUtils.generarWhereLike("t1.APEL1_077", bean.getApellido1(), params, false));
		whereDatosPersona.append(SqlUtils.generarWhereLike("t1.APEL2_077", bean.getApellido2(), params, false));

		return whereDatosPersona.toString();
	}

	@Override
	protected String getWhereLike(DatosPersona bean, Boolean startsWith, List<Object> params, Boolean search) {
		StringBuilder whereDatosPersona = new StringBuilder();
		whereDatosPersona.append(DaoConstants.WHERE_1_1);
		whereDatosPersona.append(SqlUtils.generarWhereLike("t1.DNI_077", bean.getDni(), params, startsWith));
		whereDatosPersona.append(SqlUtils.generarWhereIgual("t1.TIPIDEN_077", bean.getTipIden(), params));
		whereDatosPersona.append(SqlUtils.generarWhereLike("t1.PREDNI_077", bean.getPreDni(), params, startsWith));
		whereDatosPersona.append(SqlUtils.generarWhereLike("t1.SUFDNI_077", bean.getSufDni(), params, startsWith));
		whereDatosPersona.append(SqlUtils.generarWhereLike("t1.NOMBRE_077", bean.getNombre(), params, startsWith));
		whereDatosPersona.append(SqlUtils.generarWhereLike("t1.APEL1_077", bean.getApellido1(), params, startsWith));
		whereDatosPersona.append(SqlUtils.generarWhereLike("t1.APEL2_077", bean.getApellido2(), params, startsWith));

		return whereDatosPersona.toString();
	}

	/*
	 * OPERACIONES CRUD
	 */

	/**
	 * Inserts a single row in the DatosPersona table.
	 *
	 * @param datospersona DatosPersona
	 * @return DatosPersona
	 */
	@Override
	public DatosPersona add(DatosPersona datospersona) {
		String query = "INSERT INTO AA79B77S01 (DNI_077, TIPIDEN_077, PREDNI_077, SUFDNI_077, NOMBRE_077, APEL1_077, APEL2_077) VALUES (?,?,?,?,?,?,?)";
		this.getJdbcTemplate().update(query, datospersona.getDni(), datospersona.getTipIden(), datospersona.getPreDni(),
				datospersona.getSufDni(), datospersona.getNombre(), datospersona.getApellido1(),
				datospersona.getApellido2());
		return datospersona;
	}

	/**
	 * Updates a single row in the DatosPersona table.
	 *
	 * @param datospersona DatosPersona
	 * @return DatosPersona
	 */
	@Override
	public DatosPersona update(DatosPersona datospersona) {
		String query = "UPDATE AA79B77S01 SET  WHERE DNI_077=? AND TIPIDEN_077=? AND PREDNI_077=? AND SUFDNI_077=? AND NOMBRE_077=? AND APEL1_077=? AND APEL2_077=?";
		this.getJdbcTemplate().update(query, datospersona.getDni(), datospersona.getTipIden(), datospersona.getPreDni(),
				datospersona.getSufDni(), datospersona.getNombre(), datospersona.getApellido1(),
				datospersona.getApellido2());
		return datospersona;
	}

	/**
	 * Finds a single row in the DatosPersona table.
	 *
	 * @param datospersona DatosPersona
	 * @return DatosPersona
	 */
	@Override
	@Transactional(readOnly = true)
	public DatosPersona find(DatosPersona datospersona) {
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder();

		query.append(this.getSelect());
		query.append(this.getFrom());
		query.append(this.getWhere(datospersona, params));

		List<DatosPersona> datospersonaList = this.getJdbcTemplate().query(query.toString(), this.rwMap,
				params.toArray());
		return DataAccessUtils.uniqueResult(datospersonaList);
	}

	/**
	 * Removes a single row in the DatosPersona table.
	 *
	 * @param datospersona DatosPersona
	 * @return
	 */
	@Override
	public void remove(DatosPersona datospersona) {
		String query = "DELETE FROM AA79B77S01 WHERE DNI_077=? AND TIPIDEN_077=? AND PREDNI_077=? AND SUFDNI_077=? AND NOMBRE_077=? AND APEL1_077=? AND APEL2_077=?";
		this.getJdbcTemplate().update(query, datospersona.getDni(), datospersona.getTipIden(), datospersona.getPreDni(),
				datospersona.getSufDni(), datospersona.getNombre(), datospersona.getApellido1(),
				datospersona.getApellido2());
	}

	@Override
	@Transactional(readOnly = true)
	public List<DatosPersona> filterByRol(DatosPersona datosPersona, JQGridRequestDto jqGridRequestDto) {
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder(this.getSelectWithRol(datosPersona));
		query.append(this.getFromWithRol(datosPersona));

		query.append(DaoConstants.WHERE_1_1);
		query.append(this.getWhereWithRol(datosPersona, params));
		reemplazarSelectSiRolPersonalIzo(datosPersona, query);
		if (jqGridRequestDto != null) {
			if (jqGridRequestDto.getSidx() != null) {
				if (jqGridRequestDto.getSidx().indexOf(',') > 0) {
					jqGridRequestDto.setSidx("DNI_077");
					jqGridRequestDto.setSord("ASC");
				}
			}
			query = JQGridManagerCustom.getPaginationQuery(jqGridRequestDto, query);
		}
		// pagination - FIN

		if (datosPersona.getRol() != null) {
			if (Constants.ROL_SOLICITANTE.equals(datosPersona.getRol())) {
				return this.getJdbcTemplate().query(query.toString(), this.rwMapSolicitante, params.toArray());
			}
			if (Constants.ROL_RECEPTOR_AUTORIZADO.equals(datosPersona.getRol())) {
				return this.getJdbcTemplate().query(query.toString(), this.rwMapReceptorAutorizado,
						params.toArray());
			}
			if (Constants.ROL_PERSONAL_IZO.equals(datosPersona.getRol())) {
				return this.getJdbcTemplate().query(query.toString(), this.rwMapPersonalIZO, params.toArray());
			}
			if (Constants.ROL_PROVEEDOR_EXTERNO.equals(datosPersona.getRol())) {
				return this.getJdbcTemplate().query(query.toString(), this.rwMapProveedorExterno,
						params.toArray());
			}
		}
		return this.getJdbcTemplate().query(query.toString(), this.getRwMap(), params.toArray());
	}

	private void reemplazarSelectSiRolPersonalIzo(DatosPersona datosPersona, StringBuilder query) {
		if (Constants.ROL_PERSONAL_IZO.equals(datosPersona.getRol())) {
			query.replace(Constants.CERO, Constants.SEIS, DaoConstants.SELECT + DaoConstants.DISTINCT);
		}
	}

	public StringBuilder validJQGrid(JQGridRequestDto jQGridRequestDto, StringBuilder query,
			StringBuilder paginatedQuery) {
		if (jQGridRequestDto != null) {
			if (jQGridRequestDto.getSidx() != null) {
				if (jQGridRequestDto.getSidx().indexOf(',') > 0) {
					query.append(" ORDER BY DNI_077 ASC");
				} else {
					query.append(" ORDER BY " + jQGridRequestDto.getSidx() + " ");
					query.append(jQGridRequestDto.getSord());
				}

			}

			Long rows = jQGridRequestDto.getRows();
			Long page = jQGridRequestDto.getPage();
			if ((page != null) && (rows != null)) {
				return paginatedQuery.append("SELECT * FROM (SELECT rownum rnum, a.*  FROM (" + query
						+ ")a) where rnum > " + rows.longValue() * (page.longValue() - 1L) + " and rnum < "
						+ ((rows.longValue() * page.longValue()) + 1L));
			} else if (rows != null) {
				return paginatedQuery.append("SELECT * FROM (SELECT rownum rnum, a.*  FROM (" + query
						+ ")a) where rnum > 0 and rnum < " + (rows.longValue() + 1L));
			}
		}
		return query;
	}

	@Override
	@Transactional(readOnly = true)
	public Long filterByRolCount(DatosPersona datosPersona, boolean startsWith) {
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder();
		if (Constants.ROL_PERSONAL_IZO.equals(datosPersona.getRol())) {
			query.append("SELECT COUNT(DISTINCT t1.DNI)");
		} else {
			query.append("SELECT COUNT(1)");
		}
		query.append(this.getFromWithRol(datosPersona));
		query.append(DaoConstants.WHERE_1_1);
		query.append(this.getWhereWithRol(datosPersona, params));
		reemplazarSelectSiRolPersonalIzo(datosPersona, query);
		return this.getJdbcTemplate().queryForObject(query.toString(), params.toArray(), Long.class);
	}

	/**
	 * 
	 * funcion getFrom propia que apunta a diferentes tablas en funcion del rol
	 * pasado como parametro
	 */
	public String getFromWithRol(DatosPersona datosPersona) {
		StringBuilder from = new StringBuilder();

		if (datosPersona.getRol() != null) {
			if (Constants.ROL_SOLICITANTE.equals(datosPersona.getRol())) {
				from.append(" FROM X54JAPI_SOLICITANTES t1");
				from.append(
						" LEFT JOIN X54JAPI_ENTIDADES_SOLIC e1 ON t1.COD_ENTIDAD = e1.CODIGO AND t1.TIPO_ENTIDAD = e1.TIPO ");
			} else if (Constants.ROL_RECEPTOR_AUTORIZADO.equals(datosPersona.getRol())) {
				from.append(" FROM X54JAPI_TRABAJADORES_GIP t1");
				from.append(
						" LEFT JOIN X54JAPI_ENTDPTOS e1 ON t1.ENTDPTO = e1.CODIGO AND t1.TIPO_TRABAJADOR = e1.TIPO_ENTIDAD ");
			} else if (Constants.ROL_PERSONAL_IZO.equals(datosPersona.getRol())) {
				from.append(" FROM X54JAPI_PERSONAL_IZO t1");
				from.append(" LEFT JOIN AA79B24S01 t2 ON t1.DNI = t2.DNI_024 ");
				anyadirGruposDeTrabajoALaQuery(datosPersona, from);
			} else if (Constants.ROL_PROVEEDOR_EXTERNO.equals(datosPersona.getRol())) {
				from.append(" FROM X54JAPI_PROVEEDORES t1");
			}
		}
		return from.toString();
	}

	private void anyadirGruposDeTrabajoALaQuery(DatosPersona datosPersona, StringBuilder from) {
		if (StringUtils.isNotBlank(datosPersona.getIdsGrupoTrabajo())) {
			final String[] idsGrupoTrabajo = datosPersona.getIdsGrupoTrabajo().split(Constants.COMA);
			boolean gainerakoSeleccionada = false;
			boolean gainerakoYMasSeleccionados = false;
			for (String id : idsGrupoTrabajo) {
				if (Constants.CERO.toString().equals(id)) {
					gainerakoSeleccionada = true;
					if (idsGrupoTrabajo.length > Constants.UNO) {
						// seleccionado Gainerako y algun grupo mas
						gainerakoYMasSeleccionados = true;
					}
				}
			}
			getJoinsCasosTrabajadorGruposTrabajo(from, gainerakoSeleccionada, gainerakoYMasSeleccionados);
		}
	}

	private void getJoinsCasosTrabajadorGruposTrabajo(StringBuilder from, boolean gainerakoSeleccionada,
			boolean gainerakoYMasSeleccionados) {
		if (gainerakoYMasSeleccionados) {
			// seleccionado Gainerako y algun grupo mas
			from.append("  JOIN AA79B28S01 t3 ON(( t1.DNI NOT IN ( SELECT DISTINCT t3aux.DNI_TRABAJADOR_028 ");
			from.append(" FROM AA79B28S01 t3aux JOIN AA79B26S01 T26aux ");
			from.append(" ON t3aux.ID_GRUPO_028 = T26aux.ID_026 AND T26aux.ESTADO_026 = " + DaoConstants.SIGNO_APOSTROFO
					+ EstadoEnum.ALTA.getValue() + DaoConstants.SIGNO_APOSTROFO
					+ ")) OR ( t1.DNI = t3.DNI_TRABAJADOR_028)) ");
			from.append(" LEFT JOIN AA79B26S01 t26 ON t3.ID_GRUPO_028 = t26.ID_026 ");
			from.append(" AND t26.ESTADO_026 =  " + DaoConstants.SIGNO_APOSTROFO + EstadoEnum.ALTA.getValue()
					+ DaoConstants.SIGNO_APOSTROFO + " ");
		} else if (gainerakoSeleccionada) {
			// seleccionado Gainerako
			from.append(" JOIN AA79B28S01 t3 ON t1.DNI NOT IN ( SELECT DISTINCT t3aux.DNI_TRABAJADOR_028 ");
			from.append(" FROM AA79B28S01 t3aux JOIN AA79B26S01 T26aux ");
			from.append(" ON t3aux.ID_GRUPO_028 = T26aux.ID_026 AND T26aux.ESTADO_026 = " + DaoConstants.SIGNO_APOSTROFO
					+ EstadoEnum.ALTA.getValue() + DaoConstants.SIGNO_APOSTROFO + ") ");
		} else {
			// seleccionado grupo(s) sin Gainerako
			from.append(" JOIN AA79B28S01 t3 ON t1.DNI = t3.DNI_TRABAJADOR_028 ");
			from.append(" JOIN AA79B26S01 t26 ON t3.ID_GRUPO_028 = t26.ID_026 ");
			from.append(" AND t26.ESTADO_026 =  " + DaoConstants.SIGNO_APOSTROFO + EstadoEnum.ALTA.getValue()
					+ DaoConstants.SIGNO_APOSTROFO + " ");
		}
	}

	protected String getSelectWithRol(DatosPersona datosPersona) {
		Locale eu = new Locale("eu");
		StringBuilder query = new StringBuilder();

		if (this.isValidRol(datosPersona)) {
			query.append("SELECT t1.DNI DNI");
			query.append(", t1.TIPIDEN TIPIDEN");
			query.append(", t1.PREDNI PREDNI");
			query.append(", t1.SUFDNI SUFDNI");
			query.append(", NVL(t1.NOMBRE,'" + Constants.ESPACIO + "') NOMBRE");

			if (Constants.ROL_SOLICITANTE.equals(datosPersona.getRol())) {
				query.append(", NVL(t1.APEL1,'" + Constants.ESPACIO + "') APELLIDO1");
				query.append(", NVL(t1.APEL2,'" + Constants.ESPACIO + "') APELLIDO2");
				query.append(", NVL(t1.APEL1,'" + Constants.ESPACIO + "') || '/' || NVL(t1.APEL2,'" + Constants.ESPACIO
						+ "') APELLIDOS");
				query.append(", t1.GESTOR_EXPEDIENTES GESTOREXPEDIENTES");
				query.append(", t1.GESTOR_EXPEDIENTES_VIP GESTOREXPEDIENTESVIP");
				query.append(", t1.GESTOR_EXPEDIENTES_BOPV GESTOREXPEDIENTESBOPV");
				query.append(", t1.GESTOR_FACTURAS GESTORFACTURAS");
				query.append(", t1.COORDINADOR COORDINADOR");

				query.append(", e1.CODIGO CODIGO");
				query.append(", e1.TIPO TIPO");
				query.append(", DECODE(e1.TIPO");
				for (TipoEntidadEnum tipo : TipoEntidadEnum.values()) {
					query.append(", '").append(tipo.getValue()).append("'");
					query.append(", '").append(this.msg.getMessage(tipo.getLabel(), null, eu)).append("'");
				}
				query.append(") AS TIPOENTIDADDESCEU");
				query.append(", e1.CDIRNORA CDIRNORA");
				query.append(", e1.IVA IVA");
				query.append(", e1.FACTURABLE FACTURABLE");
				query.append(", e1.ESTADO ESTADO");
				query.append(", e1.CIF CIF");
				query.append(", e1.DESC_AMP_EU DESCAMPEU");
				query.append(", e1.DESC_AMP_ES DESCAMPES");
				query.append(", e1.DESC_EU DESCEU");
				query.append(", e1.DESC_ES DESCES");
			} else if (Constants.ROL_RECEPTOR_AUTORIZADO.equals(datosPersona.getRol())) {
				query.append(", NVL(t1.APE1,'" + Constants.ESPACIO + "') APELLIDO1");
				query.append(", NVL(t1.APE2,'" + Constants.ESPACIO + "') APELLIDO2");
				query.append(", NVL(t1.APE1,'" + Constants.ESPACIO + "') || '/' || NVL(t1.APE2,'" + Constants.ESPACIO
						+ "') APELLIDOS");

				query.append(", e1.CODIGO CODIGO");
				query.append(", e1.TIPO_ENTIDAD TIPO");
				query.append(", DECODE(e1.TIPO_ENTIDAD");
				for (TipoEntidadEnum tipo : TipoEntidadEnum.values()) {
					query.append(", '").append(tipo.getValue()).append("'");
					query.append(", '").append(this.msg.getMessage(tipo.getLabel(), null, eu)).append("'");
				}
				query.append(") AS TIPOENTIDADDESCEU");
				query.append(", e1.CIF CIF");
				query.append(", e1.DESC_EA DESCAMPEU");
				query.append(", e1.DESC_CA DESCAMPES");
				query.append(", e1.DESC_ER DESCEU");
				query.append(", e1.DESC_CR DESCES");
			} else if (Constants.ROL_PERSONAL_IZO.equals(datosPersona.getRol())) {
				query.append(", NVL(t1.APEL1,'" + Constants.ESPACIO + "') APELLIDO1");
				query.append(", NVL(t1.APEL2,'" + Constants.ESPACIO + "') APELLIDO2");
				query.append(", NVL(t1.APEL1,'" + Constants.ESPACIO + "') || '/' || NVL(t1.APEL2,'" + Constants.ESPACIO
						+ "') APELLIDOS");
				query.append(", t1.ESTADO ESTADO");
				query.append(", t1.TIPO_ENTIDAD AS TIPOENTIDAD");
				query.append(", t1.COD_ENTIDAD AS CODENTIDAD");
				query.append(DAOUtils.getDecodeAcciones("t1.TIPO_ENTIDAD", "TIPOENTIDADDESCEU", this.msg,
						"TipoEntidadEnum", eu));
				query.append(", t1.DESC_ES AS DESCES");
				query.append(", t1.DESC_EU AS DESCEU");
				query.append(", t1.CIF CIF");
				query.append(", t1.TECNICO_GESTOR AS TECNICOGESTOR");
				query.append(", t1.ASIGNADOR ASIGNADOR");
				query.append(", t1.TRADUCTOR TRADUCTOR");
				query.append(", t1.INTERPRETE INTERPRETE");
				query.append(", t2.IND_TELETRABAJO_024 INDTELETRABAJO");
				query.append(", t2.HORAS_GESTION_EXP_024 HORASGESTIONEXP");
				query.append(", DECODE(t2.IND_TELETRABAJO_024, '").append(Constants.SI).append("', '")
						.append(this.msg.getMessage("comun.si", null, eu)).append("', '").append(Constants.NO)
						.append("', '").append(this.msg.getMessage("comun.no", null, eu))
						.append("') AS DESCINDTELETRABAJO");
			} else if (Constants.ROL_PROVEEDOR_EXTERNO.equals(datosPersona.getRol())) {
				query.append(", NVL(t1.APEL1,'" + Constants.ESPACIO + "') APELLIDO1");
				query.append(", NVL(t1.APEL2,'" + Constants.ESPACIO + "') APELLIDO2");
				query.append(", NVL(t1.APEL1,'" + Constants.ESPACIO + "') || '/' || NVL(t1.APEL2,'" + Constants.ESPACIO
						+ "') APELLIDOS");
				query.append(", t1.ESTADO ESTADO");
				query.append(", t1.TIPO_ENTIDAD AS TIPOENTIDAD");
				query.append(", t1.COD_ENTIDAD AS CODENTIDAD");
				query.append(DAOUtils.getDecodeAcciones("t1.TIPO_ENTIDAD", "TIPOENTIDADDESCEU", this.msg,
						"TipoEntidadEnum", eu));
				query.append(", t1.DESC_ES AS DESCES");
				query.append(", t1.DESC_EU AS DESCEU");
				query.append(", t1.CIF AS CIF");
				query.append(", t1.TRADUCTOR TRADUCTOR");
				query.append(", t1.INTERPRETE INTERPRETE");
			}

		}
		return query.toString();
	}

	/**
	 * @param datosPersona
	 * @return
	 */
	private boolean isValidRol(DatosPersona datosPersona) {
		return datosPersona.getRol() != null && isValidTipoRol(datosPersona);
	}

	/**
	 * @param datosPersona
	 * @return
	 */
	private boolean isValidTipoRol(DatosPersona datosPersona) {
		return Constants.ROL_SOLICITANTE.equals(datosPersona.getRol())
				|| Constants.ROL_RECEPTOR_AUTORIZADO.equals(datosPersona.getRol())
				|| Constants.ROL_PERSONAL_IZO.equals(datosPersona.getRol())
				|| Constants.ROL_PROVEEDOR_EXTERNO.equals(datosPersona.getRol());
	}

	protected String getWhereWithRol(DatosPersona bean, List<Object> params) {
		StringBuilder whereDatosPersona = new StringBuilder();
		if (bean.getDni() != null) {
			whereDatosPersona.append(" AND ").append("t1.DNI").append("||").append("t1.PREDNI").append("||")
					.append("t1.SUFDNI").append(" LIKE ").append(" ? ");
			params.add(SqlUtils.normalizarCadenaLike(bean.getDni()).toUpperCase());

		}
		whereDatosPersona.append(SqlUtils.generarWhereIgual("t1.TIPIDEN", bean.getTipIden(), params));
		whereDatosPersona.append(SqlUtils.generarWhereLike("t1.PREDNI", bean.getPreDni(), params, false));
		whereDatosPersona.append(SqlUtils.generarWhereLike("t1.SUFDNI", bean.getSufDni(), params, false));
		if (StringUtils.isNotBlank(bean.getNombre())) {
			whereDatosPersona.append(SqlUtils.generarWhereLike("t1.NOMBRE", bean.getNombre().trim(), params, false));
		}
		whereDatosPersona.append(this.rolWhereAux(bean, params));
		if (bean.getEntidad() != null) {
			if (Constants.ROL_SOLICITANTE.equals(bean.getRol())
					|| Constants.ROL_RECEPTOR_AUTORIZADO.equals(bean.getRol())) {
				whereDatosPersona
						.append(SqlUtils.generarWhereIgual("e1.CODIGO", bean.getEntidad().getCodigo(), params));
			} else if (Constants.ROL_PROVEEDOR_EXTERNO.equals(bean.getRol())) {
				whereDatosPersona
						.append(SqlUtils.generarWhereIgual("t1.COD_ENTIDAD", bean.getEntidad().getCodigo(), params));
			}
		}
		getWhereClauseByRolAnyoNumExp(bean, params, whereDatosPersona);
		this.getWhereClauseGruposTrabajo(bean, params, whereDatosPersona);
		this.getWhereClausePermisos(bean, params, whereDatosPersona);

		return whereDatosPersona.toString();
	}

	/**
	 * @param bean
	 * @param params
	 * @param whereDatosPersona
	 */
	private void getWhereClauseGruposTrabajo(DatosPersona bean, List<Object> params, StringBuilder whereDatosPersona) {
		if (StringUtils.isNotBlank(bean.getIdsGrupoTrabajo())) {
			final String[] idsGrupoTrabajo = bean.getIdsGrupoTrabajo().split(Constants.COMA);
			boolean esAnd = true;
			StringBuilder whereGrupoTrabajo = new StringBuilder();
			for (String id : idsGrupoTrabajo) {
				if (!(Constants.CERO.toString().equals(id))) {
					if (esAnd) {
						whereGrupoTrabajo.append(DaoConstants.AND);
						whereGrupoTrabajo.append(DaoConstants.ABRIR_PARENTESIS);
						esAnd = false;
					} else {
						whereGrupoTrabajo.append(DaoConstants.OR);
					}
					whereGrupoTrabajo.append(" t3.ID_GRUPO_028 " + DaoConstants.SIGNOIGUAL + id);
				}
			}
			if (!esAnd) {
				whereGrupoTrabajo.append(DaoConstants.CERRAR_PARENTESIS);
			}

			whereDatosPersona.append(whereGrupoTrabajo);
		}
	}

	/**
	 * @param bean
	 * @param params
	 * @param whereDatosPersona
	 */
	private void getWhereClausePermisos(DatosPersona bean, List<Object> params, StringBuilder whereDatosPersona) {
		if (bean.getPermisoX54() != null) {
			List<String> permisos = new ArrayList<String>();
			if (PerfilEnum.TECNICO_GESTOR.getValue() == bean.getPermisoX54()) {
				SqlUtils.comprobarPermisos(Constants.SI, "t1.TECNICO_GESTOR", permisos);
			}
			if (PerfilEnum.ASIGNADOR.getValue() == bean.getPermisoX54()) {
				SqlUtils.comprobarPermisos(Constants.SI, "t1.ASIGNADOR", permisos);
			}
			if (PerfilEnum.TRADUCTOR.getValue() == bean.getPermisoX54()) {
				SqlUtils.comprobarPermisos(Constants.SI, "t1.TRADUCTOR", permisos);
			}
			if (PerfilEnum.INTERPRETE.getValue() == bean.getPermisoX54()) {
				SqlUtils.comprobarPermisos(Constants.SI, "t1.INTERPRETE", permisos);
			}
			whereDatosPersona.append(SqlUtils.generarWherePermisos(permisos, params));
		}
	}

	protected String rolWhereAux(DatosPersona bean, List<Object> params) {
		StringBuilder whereDatosPersona = new StringBuilder();
		if (Constants.ROL_SOLICITANTE.equals(bean.getRol())) {
			this.getWhereClauseApellidos(bean, params, whereDatosPersona);
			if (bean.getEntidad() != null) {
				whereDatosPersona
						.append(SqlUtils.generarWhereLike("e1.TIPO", bean.getEntidad().getTipo(), params, false));
			}

			whereDatosPersona.append(" AND CASE WHEN t1.GESTOR_EXPEDIENTES = 'S' OR t1.GESTOR_EXPEDIENTES_VIP = 'S' OR t1.GESTOR_EXPEDIENTES_BOPV = 'S' THEN 1 ELSE 0 END = 1");
			
		} else if (Constants.ROL_RECEPTOR_AUTORIZADO.equals(bean.getRol())) {
			if (StringUtils.isNotBlank(bean.getApellidos())) {
				whereDatosPersona.append(DaoConstants.AND);
				whereDatosPersona.append(DaoConstants.ABRIR_PARENTESIS);
				whereDatosPersona.append(DaoConstants.ABRIR_PARENTESIS);
				whereDatosPersona.append(DaoConstants.IGUAL_1_1);
				whereDatosPersona
						.append(SqlUtils.generarWhereLike("t1.APE1", bean.getApellido1().trim(), params, false));
				whereDatosPersona.append(DaoConstants.CERRAR_PARENTESIS);
				whereDatosPersona.append(DaoConstants.OR);
				whereDatosPersona.append(DaoConstants.ABRIR_PARENTESIS);
				whereDatosPersona.append(DaoConstants.IGUAL_1_1);
				whereDatosPersona
						.append(SqlUtils.generarWhereLike("t1.APE2", bean.getApellido2().trim(), params, false));
				whereDatosPersona.append(DaoConstants.CERRAR_PARENTESIS);
				whereDatosPersona.append(DaoConstants.CERRAR_PARENTESIS);
			}

			if (bean.getEntidad() != null) {
				whereDatosPersona.append(
						SqlUtils.generarWhereLike("e1.TIPO_ENTIDAD", bean.getEntidad().getTipo(), params, false));
			}
		} else if (Constants.ROL_PERSONAL_IZO.equals(bean.getRol())) {
			this.getWhereClauseApellidos(bean, params, whereDatosPersona);
		} else if (Constants.ROL_PROVEEDOR_EXTERNO.equals(bean.getRol())) {
			getWhereLikeClauseProveedor(bean, params, whereDatosPersona);
		}

		return whereDatosPersona.toString();
	}

	/**
	 * @param bean
	 * @param params
	 * @param whereDatosPersona
	 */
	private void getWhereClauseApellidos(DatosPersona bean, List<Object> params, StringBuilder whereDatosPersona) {
		if (StringUtils.isNotBlank(bean.getApellidos())) {
			whereDatosPersona.append(DaoConstants.AND);
			whereDatosPersona.append(DaoConstants.ABRIR_PARENTESIS);
			whereDatosPersona.append(DaoConstants.ABRIR_PARENTESIS);
			whereDatosPersona.append(DaoConstants.IGUAL_1_1);
			whereDatosPersona.append(SqlUtils.generarWhereLike("t1.APEL1", bean.getApellido1().trim(), params, false));
			whereDatosPersona.append(DaoConstants.CERRAR_PARENTESIS);
			whereDatosPersona.append(DaoConstants.OR);
			whereDatosPersona.append(DaoConstants.ABRIR_PARENTESIS);
			whereDatosPersona.append(DaoConstants.IGUAL_1_1);
			whereDatosPersona.append(SqlUtils.generarWhereLike("t1.APEL2", bean.getApellido2().trim(), params, false));
			whereDatosPersona.append(DaoConstants.CERRAR_PARENTESIS);
			whereDatosPersona.append(DaoConstants.CERRAR_PARENTESIS);
		}
	}

	protected String getWhereLikeWithRol(DatosPersona bean, Boolean startsWith, List<Object> params, Boolean search) {
		StringBuilder whereDatosPersona = new StringBuilder();
		getWhereLikeClauseByRol(bean, startsWith, params, whereDatosPersona);
		if (Constants.ROL_SOLICITANTE.equals(bean.getRol())) {
			getWhereLikeClauseSolicitante(bean, startsWith, params, whereDatosPersona);
		} else if (Constants.ROL_RECEPTOR_AUTORIZADO.equals(bean.getRol())) {
			getWhereLikeClauseReceptor(bean, startsWith, params, whereDatosPersona);
		} else if (Constants.ROL_PERSONAL_IZO.contentEquals(bean.getRol())) {
			this.getWhereClauseApellidos(bean, params, whereDatosPersona);
		} else if (Constants.ROL_PROVEEDOR_EXTERNO.contentEquals(bean.getRol())) {
			getWhereLikeClauseProveedor(bean, params, whereDatosPersona);
		}

		whereDatosPersona.append(SqlUtils.generarWhereIgual("e1.CODIGO", bean.getEntidad().getCodigo(), params));

		getWhereClauseByRolAnyoNumExp(bean, params, whereDatosPersona);

		return whereDatosPersona.toString();
	}

	/**
	 * @param bean
	 * @param params
	 * @param whereDatosPersona
	 */
	private void getWhereLikeClauseProveedor(DatosPersona bean, List<Object> params, StringBuilder whereDatosPersona) {
		this.getWhereClauseApellidos(bean, params, whereDatosPersona);

		if (bean.getEntidad() != null) {
			whereDatosPersona
					.append(SqlUtils.generarWhereLike("t1.TIPO_ENTIDAD", bean.getEntidad().getTipo(), params, false));
		}
	}

	/**
	 * @param bean
	 * @param startsWith
	 * @param params
	 * @param whereDatosPersona
	 */
	private void getWhereLikeClauseReceptor(DatosPersona bean, Boolean startsWith, List<Object> params,
			StringBuilder whereDatosPersona) {
		if (StringUtils.isNotBlank(bean.getApellidos())) {
			whereDatosPersona.append(DaoConstants.AND);
			whereDatosPersona.append(DaoConstants.ABRIR_PARENTESIS);
			whereDatosPersona.append(DaoConstants.IGUAL_1_1);
			whereDatosPersona.append(SqlUtils.generarWhereLike("t1.APE1", bean.getApellido1(), params, false));
			whereDatosPersona.append(DaoConstants.CERRAR_PARENTESIS);
			whereDatosPersona.append(DaoConstants.OR);
			whereDatosPersona.append(DaoConstants.ABRIR_PARENTESIS);
			whereDatosPersona.append(DaoConstants.IGUAL_1_1);
			whereDatosPersona.append(SqlUtils.generarWhereLike("t1.APE2", bean.getApellido2(), params, false));
			whereDatosPersona.append(DaoConstants.CERRAR_PARENTESIS);
		}

		whereDatosPersona
				.append(SqlUtils.generarWhereLike("e1.TIPO_ENTIDAD", bean.getEntidad().getTipo(), params, startsWith));
	}

	/**
	 * @param bean
	 * @param startsWith
	 * @param params
	 * @param whereDatosPersona
	 */
	private void getWhereLikeClauseSolicitante(DatosPersona bean, Boolean startsWith, List<Object> params,
			StringBuilder whereDatosPersona) {
		if (StringUtils.isNotBlank(bean.getApellidos())) {
			whereDatosPersona.append(DaoConstants.AND);
			whereDatosPersona.append(DaoConstants.ABRIR_PARENTESIS);
			whereDatosPersona.append(DaoConstants.IGUAL_1_1);
			whereDatosPersona.append(SqlUtils.generarWhereLike("t1.APEL1", bean.getApellido1(), params, startsWith));
			whereDatosPersona.append(DaoConstants.CERRAR_PARENTESIS);
			whereDatosPersona.append(DaoConstants.OR);
			whereDatosPersona.append(DaoConstants.ABRIR_PARENTESIS);
			whereDatosPersona.append(DaoConstants.IGUAL_1_1);
			whereDatosPersona.append(SqlUtils.generarWhereLike("t1.APEL2", bean.getApellido2(), params, startsWith));
			whereDatosPersona.append(DaoConstants.CERRAR_PARENTESIS);
		}

		whereDatosPersona.append(SqlUtils.generarWhereLike("e1.TIPO", bean.getEntidad().getTipo(), params, startsWith));

		if (bean.getSolicitante() != null) {
			whereDatosPersona.append(SqlUtils.generarWhereLike("t1.GESTOR_EXPEDIENTES",
					bean.getSolicitante().getGestorExpedientes(), params, startsWith));
			whereDatosPersona.append(SqlUtils.generarWhereLike("t1.GESTOR_EXPEDIENTES_VIP",
					bean.getSolicitante().getGestorExpedientesVIP(), params, startsWith));
			whereDatosPersona.append(SqlUtils.generarWhereLike("t1.GESTOR_EXPEDIENTES_BOPV",
					bean.getSolicitante().getGestorExpedientesBOPV(), params, startsWith));
			whereDatosPersona.append(SqlUtils.generarWhereLike("t1.GESTOR_FACTURAS",
					bean.getSolicitante().getGestorFacturas(), params, startsWith));
			whereDatosPersona.append(SqlUtils.generarWhereLike("t1.COORDINADOR", bean.getSolicitante().getCoordinador(),
					params, startsWith));
		}
	}

	/**
	 * @param bean
	 * @param startsWith
	 * @param params
	 * @param whereDatosPersona
	 */
	private void getWhereLikeClauseByRol(DatosPersona bean, Boolean startsWith, List<Object> params,
			StringBuilder whereDatosPersona) {
		if (bean.getDni() != null) {
			whereDatosPersona.append(SqlUtils.generarWhereLike("t1.DNI", bean.getDni().toString(), params, startsWith));
		}
		whereDatosPersona.append(SqlUtils.generarWhereIgual("t1.TIPIDEN", bean.getTipIden(), params));
		whereDatosPersona.append(SqlUtils.generarWhereLike("t1.PREDNI", bean.getPreDni(), params, startsWith));
		whereDatosPersona.append(SqlUtils.generarWhereLike("t1.SUFDNI", bean.getSufDni(), params, startsWith));
		if (StringUtils.isNotBlank(bean.getNombre())) {
			whereDatosPersona.append(SqlUtils.generarWhereLike("t1.NOMBRE", bean.getNombre(), params, startsWith));
		}
	}

	/**
	 * @param bean
	 * @param params
	 * @param whereDatosPersona
	 */
	private void getWhereClauseByRolAnyoNumExp(DatosPersona bean, List<Object> params,
			StringBuilder whereDatosPersona) {
		if (isValidAnyoNumExp(bean)) {
			whereDatosPersona.append(" AND t1.DNI NOT IN (");
			whereDatosPersona.append(" SELECT d1.DNI_RECEPTOR_063 FROM AA79B63S01 d1 ");
			whereDatosPersona.append(" WHERE (d1.ANYO_063=? AND d1.NUM_EXP_063=?)) ");
			params.add(bean.getAnyo());
			params.add(bean.getNumExp());
		}
	}

	/**
	 * @param bean
	 * @return
	 */
	private boolean isValidAnyoNumExp(DatosPersona bean) {
		return bean.getRol() != null && !Constants.ROL_PERSONAL_IZO.equals(bean.getRol()) && bean.getAnyo() != null
				&& bean.getNumExp() != null;
	}

	@Override
	@Transactional(readOnly = true)
	public ListaDatosPersona getDatosPersona(ListaDatosPersona listaDatosPersona) {
		StringBuilder query = new StringBuilder();
		ListaDatosPersona listaDatosPersonaAux = new ListaDatosPersona();
		List<DatosPersona> lDatosPersona = new ArrayList<DatosPersona>();
		DatosPersona datosPersonaAux = new DatosPersona();
		if (listaDatosPersona != null && listaDatosPersona.getListaDatosPersona() != null
				&& !listaDatosPersona.getListaDatosPersona().isEmpty()) {
			// obtenemos el primer objeto Datospersona para hacer la select y el
			// getfrom con el rol correcto
			datosPersonaAux = listaDatosPersona.getListaDatosPersona().get(0);
			List<Object> params = new ArrayList<Object>();
			query.append(this.getSelectWithRol(datosPersonaAux));
			query.append(this.getFromWithRol(datosPersonaAux));
			query.append(DaoConstants.WHERE_1_1);
			// recorremos la lista de DatosPersona para completar el where con
			// lo dnis necesarios
			for (int i = 0; i < listaDatosPersona.getListaDatosPersona().size(); i++) {
				if (i == 0) {
					query.append(DaoConstants.AND);
				}
				query.append(DaoConstants.ABRIR_PARENTESIS);
				query.append(SqlUtils.generarWhereIgualSinAnd("t1.DNI",
						listaDatosPersona.getListaDatosPersona().get(i).getDni(), params));
				query.append(DaoConstants.CERRAR_PARENTESIS);
				query.append(DaoConstants.OR);
			}
			// eliminamos el ultimo 'OR' de la query
			query.setLength(query.length() - 3);
			if (datosPersonaAux.getRol() != null) {
				lDatosPersona = this.queryEnFuncionDelRol(datosPersonaAux, query, params);
			}
		}

		listaDatosPersonaAux.setListaDatosPersona(lDatosPersona);
		return listaDatosPersonaAux;
	}

	private List<DatosPersona> queryEnFuncionDelRol(DatosPersona datosPersonaAux, StringBuilder query,
			List<Object> params) {
		List<DatosPersona> lDatosPersona = new ArrayList<DatosPersona>();
		if (Constants.ROL_SOLICITANTE.equals(datosPersonaAux.getRol())) {
			lDatosPersona = this.getJdbcTemplate().query(query.toString(), this.rwMapSolicitante, params.toArray());
		}
		if (Constants.ROL_RECEPTOR_AUTORIZADO.equals(datosPersonaAux.getRol())) {
			lDatosPersona = this.getJdbcTemplate().query(query.toString(), this.rwMapReceptorAutorizado,
					params.toArray());
		}
		if (Constants.ROL_PERSONAL_IZO.equals(datosPersonaAux.getRol())) {
			lDatosPersona = this.getJdbcTemplate().query(query.toString(), this.rwMapPersonalIZO, params.toArray());
		}
		if (Constants.ROL_PROVEEDOR_EXTERNO.equals(datosPersonaAux.getRol())) {
			lDatosPersona = this.getJdbcTemplate().query(query.toString(), this.rwMapProveedorExterno,
					params.toArray());
		}
		return lDatosPersona;
	}

	@Override
	public List<TableRowDto<DatosPersona>> reorderSelection(DatosPersona filterDatosPersona,
			JQGridRequestDto jqGridRequestDto, boolean startsWith) {
		// SELECT
		List<Object> params = new ArrayList<Object>();
		StringBuilder subQuery = new StringBuilder(this.getSelectWithRol(filterDatosPersona));
		// FROM
		subQuery.append(this.getFromWithRol(filterDatosPersona));
		// FILTRADO
		subQuery.append(DaoConstants.WHERE_1_1);
		subQuery.append(this.getWhereLikeWithRol(filterDatosPersona, startsWith, params, false));

		StringBuilder query = DAOUtils.getReorderQuery(jqGridRequestDto, params, subQuery, this.getPK(), Constants.DOS,
				null);

		RowNumResultSetExtractor<DatosPersona> rowNumOrder = new RowNumResultSetExtractor<DatosPersona>(
				this.getRwMapPK(), jqGridRequestDto);

		return this.getJdbcTemplate().query(query.toString(), rowNumOrder, params.toArray());
	}

	@Override
	public Object findPersonasGIP(String dni, Aa79bPersona bean, JQGridRequestDto jqGridRequestDto, boolean startsWith,
			boolean isCount) {
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder();
		StringBuilder paginatedQuery = new StringBuilder();

		query.append("SELECT ");
		if (isCount) {
			query.append(" COUNT(1) ");
		} else {
			query.append(" PREDNI, ");
			query.append("DNI, ");
			query.append("SUFDNI, ");
			query.append("NOMBRE, ");
			query.append("APE1, ");
			query.append("APE2 ");
			query.append(", (PREDNI || DNI || SUFDNI) AS DNICOMPLETO ");
		}
		query.append("FROM X54JAPI_TRABAJADORES_GIP ");
		query.append(DaoConstants.WHERE_1_1);
		if (bean != null) {
			if (bean.getDni() != null) {
				query.append(" AND ").append("DNI").append("||").append("PREDNI").append("||").append("SUFDNI")
						.append(" LIKE ").append(" ? ");
				params.add(SqlUtils.normalizarCadenaLike(bean.getDni()).toUpperCase());
			}
			query.append(SqlUtils.generarWhereLike("NOMBRE", bean.getNombre(), params, startsWith));
			query.append(SqlUtils.generarWhereLike("APE1", bean.getApe1(), params, startsWith));
			query.append(SqlUtils.generarWhereLike("APE2", bean.getApe2(), params, startsWith));
			// excluir receptores ya autorizados
			params.add(bean.getAnyo());
			params.add(bean.getNumExp());
			query.append(" AND (");
			query.append(" NOT ");
			query.append(" EXISTS(");
			query.append("SELECT 1 FROM AA79B63S01 e1 ");
			query.append(" WHERE (e1.ANYO_063 = ? AND e1.NUM_EXP_063 = ? AND e1.DNI_RECEPTOR_063 = DNI)))");
		}

		params.add(dni);
		query.append(" AND DEPARTAMENTOGIP = ( ");
		query.append("SELECT DEPARTAMENTOGIP FROM X54JAPI_TRABAJADORES_GIP WHERE DNI = ? ) ");

		paginatedQuery.append(Utils.getPaginationQuery(jqGridRequestDto, isCount, query));

		if (isCount) {
			return this.getJdbcTemplate().queryForObject(paginatedQuery.toString(), params.toArray(), Long.class);
		} else {
			return this.getJdbcTemplate().query(paginatedQuery.toString(), this.rwMapPersonas, params.toArray());
		}
	}

	@Override
	public int comprobarSiExistePersona(DatosPersona datosPersona) {
		StringBuilder query = new StringBuilder();
		List<Object> params = new ArrayList<Object>();
		query.append("SELECT COUNT(DNI_077) ");
		query.append(this.getFrom());
		query.append(DaoConstants.WHERE_1_1);
		query.append(SqlUtils.generarWhereLike("t1.DNI_077", datosPersona.getDni(), params, false));
		return this.getJdbcTemplate().queryForInt(query.toString(), datosPersona.getDni());
	}

	@Override
	public List<TableRowDto<Aa79bPersona>> reorderSelectionPersonasGIP(Aa79bPersona bean,
			JQGridRequestDto jqGridRequestDto, List<String> listaIdsSeleccionados, boolean b) {
		// SELECT
		List<Object> params = new ArrayList<Object>();
		StringBuilder subQuery = new StringBuilder();
		subQuery.append("SELECT ");
		subQuery.append(" PREDNI ");
		subQuery.append("DNI ");
		subQuery.append("SUFDNI ");
		subQuery.append("NOMBRE ");
		subQuery.append("APE1 ");
		subQuery.append("APE2 ");
		// FROM
		subQuery.append("FROM X54JTRABAJADORES_GIP ");
		// FILTRADO
		subQuery.append(DaoConstants.WHERE_1_1);
		if (bean != null) {
			subQuery.append(SqlUtils.generarWhereIgual("DNI", bean.getDni(), params));
			subQuery.append(SqlUtils.generarWhereLike("NOMBRE", bean.getNombre(), params, false));
			subQuery.append(SqlUtils.generarWhereLike("APE1", bean.getApe1(), params, false));
			subQuery.append(SqlUtils.generarWhereLike("APE2", bean.getApe2(), params, false));
		}

		StringBuilder query = DAOUtils.getReorderQuery(jqGridRequestDto, params, subQuery, this.getPK(), Constants.UNO,
				null);

		RowNumResultSetExtractor<Aa79bPersona> rowNumOrder = new RowNumResultSetExtractor<Aa79bPersona>(
				this.rwMapAa79bPK, jqGridRequestDto);

		return this.getJdbcTemplate().query(query.toString(), rowNumOrder, params.toArray());
	}

	@Override
	public boolean comprobarPersona(String dni) {
		StringBuilder query = new StringBuilder();
		List<Object> params = new ArrayList<Object>();
		query.append("SELECT COUNT(1) FROM AA79B77S01 WHERE DNI_077 LIKE ?");
		params.add(dni);
		Long esta = this.getJdbcTemplate().queryForObject(query.toString(), params.toArray(), Long.class);
		return esta > 0;
	}

}
