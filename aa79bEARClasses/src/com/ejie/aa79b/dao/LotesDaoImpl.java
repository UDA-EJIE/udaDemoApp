package com.ejie.aa79b.dao;

import java.math.BigDecimal;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

import org.springframework.jdbc.core.RowMapper;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.common.DBConstants;
import com.ejie.aa79b.common.DaoConstants;
import com.ejie.aa79b.common.SqlUtils;
import com.ejie.aa79b.dao.mapper.LotesRowMapper;
import com.ejie.aa79b.dao.mapper.LotesRowMapperLotesVigentesExp;
import com.ejie.aa79b.model.EntidadesLote;
import com.ejie.aa79b.model.Expediente;
import com.ejie.aa79b.model.Lotes;
import com.ejie.aa79b.model.enums.EstadoExpedienteEnum;
import com.ejie.aa79b.model.enums.TipoTareaGestionAsociadaEnum;
import com.ejie.aa79b.utils.DAOUtils;
import com.ejie.x38.dao.RowNumResultSetExtractor;
import com.ejie.x38.dto.JQGridRequestDto;
import com.ejie.x38.dto.TableRowDto;

/**
 * LotesDaoImpl generated by UDA, 27-nov-2017 12:26:24.
 *
 * @author UDA
 */

@Repository()
@Transactional()
public class LotesDaoImpl extends GenericoDaoImpl<Lotes> implements LotesDao {

	protected static final String ID_LOTE_029 = "ID_LOTE_029";
	protected static final String TIPO_ENTIDAD_029 = "TIPO_ENTIDAD_029";
	protected static final String ID_EMPRESA_PROV_029 = "ID_EMPRESA_PROV_029";
	protected static final String NOMBRE_LOTE_029 = "NOMBRE_LOTE_029";
	protected static final String DESC_LOTE_EU_029 = "DESC_LOTE_EU_029";
	protected static final String DESC_LOTE_ES_029 = "DESC_LOTE_ES_029";
	protected static final String DNI_CONTACTO_029 = "DNI_CONTACTO_029";
	protected static final String FECHA_INICIO_029 = "FECHA_INICIO_029";
	protected static final String FECHA_FIN_029 = "FECHA_FIN_029";
	protected static final String IMPORTE_ASIGNADO_029 = "IMPORTE_ASIGNADO_029";
	protected static final String IMPORTE_CONSUMIDO_029 = "IMPORTE_CONSUMIDO_029";
	protected static final String ID_IDIOMA_DESTINO_029 = "ID_IDIOMA_DESTINO_029";
	protected static final String IMPORTE_PALABRA_029 = "IMPORTE_PALABRA_029";
	protected static final String POR_PAGO_PAL_CONCOR_85_94_029 = "POR_PAGO_PAL_CONCOR_85_94_029";
	protected static final String POR_PAGO_PAL_CONCOR_95_100_029 = "POR_PAGO_PAL_CONCOR_95_100_029";
	protected static final String POR_REVISION_029 = "POR_REVISION_029";
	protected static final String POR_RECARGO_FORMATO_029 = "POR_RECARGO_FORMATO_029";
	protected static final String IND_RECARGO_APREMIO_029 = "IND_RECARGO_APREMIO_029";
	protected static final String POR_RECARGO_APREMIO_029 = "POR_RECARGO_APREMIO_029";
	protected static final String ID_TIPO_PENALIZACION_029 = "ID_TIPO_PENALIZACION_029";
	protected static final String POR_PENALIZACION_029 = "POR_PENALIZACION_029";
	protected static final String RESOLUCION_029 = "RESOLUCION_029";
	protected static final String[] ORDER_BY_WHITE_LIST = new String[] { DBConstants.IDLOTE, DBConstants.TIPOENTIDAD,
			"IDEMPRESAPROV", DBConstants.NOMBRELOTE, "DESCLOTEEU", "DESCLOTEES", "DNICONTACTO", "FECHAINICIO",
			"FECHAFIN", "IMPORTEASIGNADO", "IMPORTECONSUMIDO", "IDIDIOMADESTINO", "IMPORTEPALABRA",
			"PORPAGOPALCONCOR8594", "PORPAGOPALCONCOR95100", "PORREVISION", "PORRECARGOFORMATO", "INDRECARGOAPREMIO",
			"PORRECARGOAPREMIO", "IDTIPOPENALIZACION", "PORPENALIZACION", "RESOLUCION", "IMPORTEPREVISTO",
			"IMPORTERESTANTE", "IMPORTEDISPONIBLE" };

	/*
	 * ROW_MAPPERS
	 */
	private RowMapper<Lotes> rwMap = new LotesRowMapper();

	private RowMapper<Lotes> rwMapLotCon = new LotesRowMapper() {
		@Override()
		public Lotes mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			Lotes bean = new Lotes();
			bean.setIdLote(resultSet.getInt(DBConstants.IDLOTE));
			bean.setNombreLote(resultSet.getString(DBConstants.NOMBRELOTE));
			return bean;
		}
	};

	private RowMapper<Lotes> rwMapPK = new RowMapper<Lotes>() {
		@Override()
		public Lotes mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			Lotes bean = new Lotes();
			bean.setIdLote(resultSet.getInt(DBConstants.IDLOTE));
			return bean;
		}
	};

	private RowMapper<Lotes> rwMapLotesVigentes = new LotesRowMapperLotesVigentesExp();

	private RowMapper<Lotes> rwMapLotesComboAlbaranes = new RowMapper<Lotes>() {
		@Override
		public Lotes mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			Lotes lote = new Lotes();
			lote.setIdLote(resultSet.getInt("IDLOTE"));
			lote.setNombreLote(resultSet.getString("NOMBRELOTE"));
			lote.setActivo(resultSet.getInt("ACTIVO"));
			return lote;
		}
	};

	private RowMapper<EntidadesLote> rwMapLoteDefecto = new RowMapper<EntidadesLote>() {
		@Override
		public EntidadesLote mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			EntidadesLote lote = new EntidadesLote();
			lote.setIdLote(resultSet.getLong("IDLOTE"));
			lote.setNombreLote(resultSet.getString("NOMBRELOTE"));
			lote.setDescLoteEs(resultSet.getString("DESCLOTEES"));
			lote.setDescLoteEu(resultSet.getString("DESCLOTEEU"));
			lote.setCodigo(resultSet.getInt("IDENTIDAD"));
			lote.setTipo(resultSet.getString("TIPOENTIDAD"));
			return lote;
		}
	};

	/**
	 * Constructor
	 */
	public LotesDaoImpl() {
		super(Lotes.class);
	}

	/*
	 * OPERACIONES CRUD
	 */

	@Override()
	public Lotes add(Lotes lotes) {
		StringBuilder queryId = new StringBuilder("SELECT AA79B29Q00.NEXTVAL FROM dual ");
		Long id = this.getJdbcTemplate().queryForObject(queryId.toString(), Long.class);
		lotes.setIdLote(id.intValue());

		String query = "INSERT INTO AA79B29S01 (ID_LOTE_029, TIPO_ENTIDAD_029, ID_EMPRESA_PROV_029, NOMBRE_LOTE_029, DESC_LOTE_EU_029, DESC_LOTE_ES_029, DNI_CONTACTO_029, FECHA_INICIO_029, FECHA_FIN_029, IMPORTE_ASIGNADO_029, IMPORTE_CONSUMIDO_029, ID_IDIOMA_DESTINO_029, IMPORTE_PALABRA_029, POR_PAGO_PAL_CONCOR_85_94_029, POR_PAGO_PAL_CONCOR_95_100_029, POR_REVISION_029, POR_RECARGO_FORMATO_029, IND_RECARGO_APREMIO_029, POR_RECARGO_APREMIO_029, ID_TIPO_PENALIZACION_029, POR_PENALIZACION_029, RESOLUCION_029, IND_TRAMITACION_RAPIDA_029) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)";
		this.getJdbcTemplate().update(query, lotes.getIdLote(), lotes.getEmpresasProveedoras().getTipo(),
				lotes.getEmpresasProveedoras().getCodigo(), lotes.getNombreLote(), lotes.getDescLoteEu(),
				lotes.getDescLoteEs(), lotes.getContacto() == null ? null : lotes.getContacto().getDni(),
				lotes.getFechaInicio(), lotes.getFechaFin(), lotes.getImporteAsignado(),
				lotes.getImporteConsumido() == null ? 0 : lotes.getImporteConsumido(), lotes.getIdIdiomaDestino(),
				lotes.getImportePalabra(), lotes.getPorPagoPalConcor8594(), lotes.getPorPagoPalConcor95100(),
				lotes.getPorRevision(), lotes.getPorRecargoFormato(),
				lotes.getIndRecargoApremio() == null ? Constants.NO : lotes.getIndRecargoApremio(),
				lotes.getPorRecargoApremio(), lotes.getIdTipoPenalizacion(), lotes.getPorPenalizacion(),
				lotes.getResolucion(), lotes.getIndTramitacionRapida());
		return lotes;
	}

	@Override()
	public Lotes update(Lotes lotes) {
		String query = "UPDATE AA79B29S01 SET TIPO_ENTIDAD_029=?, ID_EMPRESA_PROV_029=?, NOMBRE_LOTE_029=?, DESC_LOTE_EU_029=?, DESC_LOTE_ES_029=?, DNI_CONTACTO_029=?, FECHA_INICIO_029=?, FECHA_FIN_029=?, IMPORTE_ASIGNADO_029=?, IMPORTE_CONSUMIDO_029=?, ID_IDIOMA_DESTINO_029=?, IMPORTE_PALABRA_029=?, POR_PAGO_PAL_CONCOR_85_94_029=?, POR_PAGO_PAL_CONCOR_95_100_029=?, POR_REVISION_029=?, POR_RECARGO_FORMATO_029=?, IND_RECARGO_APREMIO_029=?, POR_RECARGO_APREMIO_029=?, ID_TIPO_PENALIZACION_029=?, POR_PENALIZACION_029=?, RESOLUCION_029=?, IND_TRAMITACION_RAPIDA_029 =? WHERE ID_LOTE_029=?";
		this.getJdbcTemplate().update(query, lotes.getEmpresasProveedoras().getTipo(),
				lotes.getEmpresasProveedoras().getCodigo(), lotes.getNombreLote(), lotes.getDescLoteEu(),
				lotes.getDescLoteEs(), lotes.getContacto() == null ? null : lotes.getContacto().getDni(),
				lotes.getFechaInicio(), lotes.getFechaFin(), lotes.getImporteAsignado(),
				lotes.getImporteConsumido() == null ? 0 : lotes.getImporteConsumido(), lotes.getIdIdiomaDestino(),
				lotes.getImportePalabra(), lotes.getPorPagoPalConcor8594(), lotes.getPorPagoPalConcor95100(),
				lotes.getPorRevision(), lotes.getPorRecargoFormato(),
				lotes.getIndRecargoApremio() == null ? Constants.NO : lotes.getIndRecargoApremio(),
				lotes.getPorRecargoApremio(), lotes.getIdTipoPenalizacion(), lotes.getPorPenalizacion(),
				lotes.getResolucion(), lotes.getIndTramitacionRapida(), lotes.getIdLote());
		return lotes;
	}

	@Override()
	public void remove(Lotes lotes) {
		String query = "DELETE FROM AA79B29S01 WHERE ID_LOTE_029=?";
		this.getJdbcTemplate().update(query, lotes.getIdLote());
	}

	@Override()
	protected String getSelect() {

		StringBuilder query = new StringBuilder();

		query.append("SELECT t1.ID_LOTE_029 IDLOTE");
		query.append(", t1.TIPO_ENTIDAD_029 TIPOENTIDAD");
		query.append(", t1.ID_EMPRESA_PROV_029 IDEMPRESAPROV");
		query.append(", t1.NOMBRE_LOTE_029 NOMBRELOTE");
		query.append(", t1.DESC_LOTE_EU_029 DESCLOTEEU");
		query.append(", t1.DESC_LOTE_ES_029 DESCLOTEES");
		query.append(", t1.DNI_CONTACTO_029 DNICONTACTO");
		query.append(", t1.FECHA_INICIO_029 FECHAINICIO");
		query.append(", t1.FECHA_FIN_029 FECHAFIN");
		query.append(", t1.IMPORTE_ASIGNADO_029 IMPORTEASIGNADO");
		query.append(", t1.IMPORTE_CONSUMIDO_029 IMPORTECONSUMIDO");
		query.append(", t1.ID_IDIOMA_DESTINO_029 IDIDIOMADESTINO");
		query.append(", t1.IMPORTE_PALABRA_029 IMPORTEPALABRA");
		query.append(", t1.POR_PAGO_PAL_CONCOR_85_94_029 PORPAGOPALCONCOR8594");
		query.append(", t1.POR_PAGO_PAL_CONCOR_95_100_029 PORPAGOPALCONCOR95100");
		query.append(", t1.POR_REVISION_029 PORREVISION");
		query.append(", t1.POR_RECARGO_FORMATO_029 PORRECARGOFORMATO");
		query.append(", t1.IND_RECARGO_APREMIO_029 INDRECARGOAPREMIO");
		query.append(", t1.POR_RECARGO_APREMIO_029 PORRECARGOAPREMIO");
		query.append(", t1.ID_TIPO_PENALIZACION_029 IDTIPOPENALIZACION");
		query.append(", t1.POR_PENALIZACION_029 PORPENALIZACION");
		query.append(", t1.RESOLUCION_029 RESOLUCION");
		query.append(", t1.IND_TRAMITACION_RAPIDA_029 IND_TRAMITACION_RAPIDA ");
		query.append(", IMPORTE_PREVISTO_LOTE(t1.ID_LOTE_029, NULL) IMPORTEPREVISTO");
		query.append(", (t1.IMPORTE_ASIGNADO_029 - t1.IMPORTE_CONSUMIDO_029) IMPORTERESTANTE");
		query.append(
				", (t1.IMPORTE_ASIGNADO_029 - (t1.IMPORTE_CONSUMIDO_029 + IMPORTE_PREVISTO_LOTE(t1.ID_LOTE_029, NULL))) IMPORTEDISPONIBLE");

		// Para ordenaci√≥n con acentos etc
		query.append(", ").append(SqlUtils.normalizarCampoSql("t1.DESC_LOTE_EU_029")).append(" AS DESCLOTENORMEU");
		query.append(", ").append(SqlUtils.normalizarCampoSql("t1.DESC_LOTE_ES_029")).append(" AS DESCLOTENORMES");

		return query.toString();
	}

	public String getSelectLotesVigentesExp(String documentos) {

		StringBuilder query = new StringBuilder();

		query.append(this.getSelect());
		query.append(", COSTE_EXPEDIENTE_LOTE(t3.ANYO_053,t3.NUM_EXP_053,t1.ID_LOTE_029,'").append(documentos)
				.append("') COSTEEXPEDIENTE");
		query.append(", t2.DESC_AMP_ES DESCAMPES");
		query.append(", t2.DESC_AMP_EU DESCAMPEU");
		query.append(", t2.DESC_ES DESCES");
		query.append(", t2.DESC_EU DESCEU");

		return query.toString();
	}

	@Override()
	protected String getFrom() {
		StringBuilder query = new StringBuilder();

		query.append(" FROM AA79B29S01 t1 ");

		return query.toString();
	}

	protected String getFromLotesVigentesExp() {
		StringBuilder query = new StringBuilder();

		query.append(this.getFrom());
		query.append(
				" JOIN X54JAPI_ENTIDADES_SOLIC t2 ON t1.TIPO_ENTIDAD_029 = t2.TIPO AND t1.ID_EMPRESA_PROV_029 = t2.CODIGO ");
		query.append(
				" JOIN AA79B53S01 t3 ON t1.FECHA_INICIO_029 <= t3.FECHA_FINAL_IZO_053 AND t1.FECHA_FIN_029 >= t3.FECHA_FINAL_IZO_053 ");

		return query.toString();
	}

	@Override()
	protected RowMapper<Lotes> getRwMap() {
		return this.rwMap;
	}

	@Override()
	protected String[] getOrderBy() {
		return LotesDaoImpl.ORDER_BY_WHITE_LIST;
	}

	@Override()
	protected String getPK() {
		return ID_LOTE_029;
	}

	@Override()
	protected RowMapper<Lotes> getRwMapPK() {
		return this.rwMapPK;
	}

	@Override()
	protected String getWherePK(Lotes bean, List<Object> params) {
		params.add(bean.getIdLote());
		return " WHERE ID_LOTE_029 = ?";
	}

	@Override
	protected String getWhere(Lotes bean, List<Object> params) {

		StringBuilder where = new StringBuilder(LotesDaoImpl.STRING_BUILDER_INIT);

		if (bean != null) {
			where.append(SqlUtils.generarWhereIgual(ID_LOTE_029, bean.getIdLote(), params));
			if (bean.getEmpresasProveedoras() != null) {
				where.append(
						SqlUtils.generarWhereIgual(TIPO_ENTIDAD_029, bean.getEmpresasProveedoras().getTipo(), params));
				where.append(SqlUtils.generarWhereIgual(ID_EMPRESA_PROV_029, bean.getEmpresasProveedoras().getCodigo(),
						params));
			}
			where.append(SqlUtils.generarWhereLikeNormalizado(NOMBRE_LOTE_029, bean.getNombreLote(), params, false));
			where.append(SqlUtils.generarWhereLikeNormalizado(DESC_LOTE_EU_029, bean.getDescLoteEu(), params, false));
			where.append(SqlUtils.generarWhereLikeNormalizado(DESC_LOTE_ES_029, bean.getDescLoteEs(), params, false));
			if (bean.getContacto() != null) {
				where.append(SqlUtils.generarWhereIgual(DNI_CONTACTO_029, bean.getContacto().getDni(), params));
			}
			where.append(SqlUtils.generarWhereIgual(FECHA_INICIO_029, bean.getFechaInicio(), params));
			where.append(SqlUtils.generarWhereIgual(FECHA_FIN_029, bean.getFechaFin(), params));
			where.append(SqlUtils.generarWhereIgual(IMPORTE_ASIGNADO_029, bean.getImporteAsignado(), params));
			where.append(SqlUtils.generarWhereIgual(IMPORTE_CONSUMIDO_029, bean.getImporteConsumido(), params));
			where.append(SqlUtils.generarWhereIgual(ID_IDIOMA_DESTINO_029, bean.getIdIdiomaDestino(), params));
			where.append(SqlUtils.generarWhereIgual(IMPORTE_PALABRA_029, bean.getImportePalabra(), params));
			where.append(
					SqlUtils.generarWhereIgual(POR_PAGO_PAL_CONCOR_85_94_029, bean.getPorPagoPalConcor8594(), params));
			where.append(SqlUtils.generarWhereIgual(POR_PAGO_PAL_CONCOR_95_100_029, bean.getPorPagoPalConcor95100(),
					params));
			where.append(SqlUtils.generarWhereIgual(POR_REVISION_029, bean.getPorRevision(), params));
			where.append(SqlUtils.generarWhereIgual(POR_RECARGO_FORMATO_029, bean.getPorRecargoFormato(), params));
			where.append(SqlUtils.generarWhereIgual(IND_RECARGO_APREMIO_029, bean.getIndRecargoApremio(), params));
			where.append(SqlUtils.generarWhereIgual(POR_RECARGO_APREMIO_029, bean.getPorRecargoApremio(), params));
			where.append(SqlUtils.generarWhereIgual(ID_TIPO_PENALIZACION_029, bean.getIdTipoPenalizacion(), params));
			where.append(SqlUtils.generarWhereIgual(POR_PENALIZACION_029, bean.getPorPenalizacion(), params));
			where.append(SqlUtils.generarWhereIgual(RESOLUCION_029, bean.getResolucion(), params));
		}

		return where.toString();
	}

	@Override
	protected String getWhereLike(Lotes bean, Boolean startsWith, List<Object> params, Boolean search) {

		StringBuilder where = new StringBuilder(LotesDaoImpl.STRING_BUILDER_INIT);

		if (bean != null) {
			where.append(SqlUtils.generarWhereIgual(ID_LOTE_029, bean.getIdLote(), params));
			if (bean.getEmpresasProveedoras() != null) {
				where.append(
						SqlUtils.generarWhereIgual(TIPO_ENTIDAD_029, bean.getEmpresasProveedoras().getTipo(), params));
				where.append(SqlUtils.generarWhereIgual(ID_EMPRESA_PROV_029, bean.getEmpresasProveedoras().getCodigo(),
						params));
			}
			where.append(
					SqlUtils.generarWhereLikeNormalizado(NOMBRE_LOTE_029, bean.getNombreLote(), params, startsWith));
			where.append(
					SqlUtils.generarWhereLikeNormalizado(DESC_LOTE_EU_029, bean.getDescLoteEu(), params, startsWith));
			where.append(
					SqlUtils.generarWhereLikeNormalizado(DESC_LOTE_ES_029, bean.getDescLoteEs(), params, startsWith));
			if (bean.getContacto() != null) {
				where.append(SqlUtils.generarWhereIgual(DNI_CONTACTO_029, bean.getContacto().getDni(), params));
			}
			where.append(SqlUtils.generarWhereIgual(FECHA_INICIO_029, bean.getFechaInicio(), params));
			where.append(SqlUtils.generarWhereIgual(FECHA_FIN_029, bean.getFechaFin(), params));
			where.append(SqlUtils.generarWhereIgual(IMPORTE_ASIGNADO_029, bean.getImporteAsignado(), params));
			where.append(SqlUtils.generarWhereIgual(IMPORTE_CONSUMIDO_029, bean.getImporteConsumido(), params));
			where.append(SqlUtils.generarWhereIgual(ID_IDIOMA_DESTINO_029, bean.getIdIdiomaDestino(), params));
			where.append(SqlUtils.generarWhereIgual(IMPORTE_PALABRA_029, bean.getImportePalabra(), params));
			where.append(
					SqlUtils.generarWhereIgual(POR_PAGO_PAL_CONCOR_85_94_029, bean.getPorPagoPalConcor8594(), params));
			where.append(SqlUtils.generarWhereIgual(POR_PAGO_PAL_CONCOR_95_100_029, bean.getPorPagoPalConcor95100(),
					params));
			where.append(SqlUtils.generarWhereIgual(POR_REVISION_029, bean.getPorRevision(), params));
			where.append(SqlUtils.generarWhereIgual(POR_RECARGO_FORMATO_029, bean.getPorRecargoFormato(), params));
			where.append(SqlUtils.generarWhereIgual(IND_RECARGO_APREMIO_029, bean.getIndRecargoApremio(), params));
			where.append(SqlUtils.generarWhereIgual(POR_RECARGO_APREMIO_029, bean.getPorRecargoApremio(), params));
			where.append(SqlUtils.generarWhereIgual(ID_TIPO_PENALIZACION_029, bean.getIdTipoPenalizacion(), params));
			where.append(SqlUtils.generarWhereIgual(POR_PENALIZACION_029, bean.getPorPenalizacion(), params));
			where.append(SqlUtils.generarWhereIgual(RESOLUCION_029, bean.getResolucion(), params));
		}

		return where.toString();
	}

	private String getWhereLotesVigentesExp(Expediente expediente, List<Object> params) {
		return this.getWhereClauseLotesVigentes(expediente, params);
	}

	private String getWhereLikeLotesVigentesExp(Expediente expediente, Boolean startsWith, List<Object> params,
			Boolean search) {
		return this.getWhereClauseLotesVigentes(expediente, params);
	}

	/**
	 * @param expediente
	 * @param params
	 * @return
	 */
	private String getWhereClauseLotesVigentes(Expediente expediente, List<Object> params) {
		StringBuilder where = new StringBuilder();

		where.append(DaoConstants.WHERE_1_1);
		where.append(SqlUtils.generarWhereIgual("t3.ANYO_053", expediente.getAnyo(), params));
		where.append(SqlUtils.generarWhereIgual("t3.NUM_EXP_053", expediente.getNumExp(), params));

		return where.toString();
	}

	@Override
	public List<Lotes> getLotesExpedientePlanificacion(Lotes lotes, JQGridRequestDto jqGridRequestDto) {
		StringBuilder query = new StringBuilder();
		List<Object> params = new ArrayList<Object>();
		query.append("Select DISTINCT ID_LOTE_081 IDLOTE, NOMBRE_LOTE_029 NOMBRELOTE from aa79b81T00 ");
		query.append("LEFT JOIN aa79b29S01 on ID_LOTE_081 = ID_LOTE_029 ");
		query.append("LEFT JOIN aa79b51S01 on ANYO_081 = ANYO_051 and NUM_EXP_081 = NUM_EXP_051 ");
		query.append("LEFT JOIN AA79B59S01 on  ANYO_059 = ANYO_051 and NUM_EXP_059 = NUM_EXP_051 AND "
				+ "ID_ESTADO_BITACORA_059 = ESTADO_BITACORA_051 ");
		Object[] listaEstados = { EstadoExpedienteEnum.EN_CURSO.getValue(), EstadoExpedienteEnum.CERRADO.getValue() };
		query.append(SqlUtils.generarWhereIn("ID_ESTADO_EXP_059", listaEstados, params));
		query.append(" WHERE ID_LOTE_081 IS NOT NULL");
		return this.getJdbcTemplate().query(query.toString(), this.rwMapLotCon, params.toArray());
	}

	@Override
	@Transactional(readOnly = true)
	public List<Lotes> filterLotesVigentesExp(Expediente expediente, JQGridRequestDto jqGridRequestDto) {
		List<Object> params = new ArrayList<Object>();
		StringBuilder paginatedQuery = new StringBuilder();
		StringBuilder query = new StringBuilder(this.getSelectLotesVigentesExp(expediente.getDocumentos()));
		query.append(this.getFromLotesVigentesExp());
		query.append(this.getWhereLotesVigentesExp(expediente, params));

		paginatedQuery.append(this.validJQGrid(jqGridRequestDto, query, new StringBuilder()));

		return this.getJdbcTemplate().query(paginatedQuery.toString(), this.rwMapLotesVigentes, params.toArray());
	}

	@Override
	@Transactional(readOnly = true)
	public Long filterLotesVigentesExpCount(Expediente expediente, boolean startsWith) {
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder();
		query.append("SELECT COUNT(1)");
		query.append(this.getFromLotesVigentesExp());
		query.append(this.getWhereLotesVigentesExp(expediente, params));

		return this.getJdbcTemplate().queryForObject(query.toString(), params.toArray(), Long.class);
	}

	@Override
	public List<TableRowDto<Lotes>> reorderSelectionLotesVigentesExp(Expediente expediente,
			JQGridRequestDto jqGridRequestDto, boolean startsWith) {
		// SELECT
		List<Object> params = new ArrayList<Object>();
		StringBuilder subQuery = new StringBuilder(this.getSelectLotesVigentesExp(expediente.getDocumentos()));
		// FROM
		subQuery.append(this.getFromLotesVigentesExp());
		// FILTRADO
		subQuery.append(this.getWhereLikeLotesVigentesExp(expediente, startsWith, params, false));

		StringBuilder query = DAOUtils.getReorderQuery(jqGridRequestDto, params, subQuery, this.getPK(), Constants.UNO,
				null);

		RowNumResultSetExtractor<Lotes> rowNumOrder = new RowNumResultSetExtractor<Lotes>(this.getRwMapPK(),
				jqGridRequestDto);

		return this.getJdbcTemplate().query(query.toString(), rowNumOrder, params.toArray());
	}

	public StringBuilder validJQGrid(JQGridRequestDto jQGridRequestDto, StringBuilder query,
			StringBuilder paginatedQuery) {
		if (jQGridRequestDto != null) {
			if (jQGridRequestDto.getSidx() != null) {
				if (jQGridRequestDto.getSidx().indexOf(',') > 0) {
					query.append(" ORDER BY ID_LOTE_029 ASC");
				} else {
					query.append(" ORDER BY " + jQGridRequestDto.getSidx() + " ");
					query.append(jQGridRequestDto.getSord());
				}

			}

			Long rows = jQGridRequestDto.getRows();
			Long page = jQGridRequestDto.getPage();
			if ((page != null) && (rows != null)) {
				return paginatedQuery.append("SELECT * FROM (SELECT rownum rnum, a.*  FROM (" + query
						+ ")a) where rnum > " + rows.longValue() * (page.longValue() - 1L) + " and rnum < "
						+ ((rows.longValue() * page.longValue()) + 1L));
			} else if (rows != null) {
				return paginatedQuery.append("SELECT * FROM (SELECT rownum rnum, a.*  FROM (" + query
						+ ")a) where rnum > 0 and rnum < " + (rows.longValue() + 1L));
			}
		}
		return query;
	}

	/**
	 * TODO actualizar con tipo e id entidad
	 */
	@Override
	public List<Lotes> getLotesNoPagados(Long codEntidad, Integer indPagado) {

		List<Object> params = new ArrayList<Object>();

		StringBuilder query = new StringBuilder(DaoConstants.SELECT + DaoConstants.DISTINCT + "ID_LOTE_029 IDLOTE"
				+ DaoConstants.SIGNO_COMA + " NOMBRE_LOTE_029 NOMBRELOTE, ");
		query.append(" CASE WHEN ( FECHA_INICIO_029 <= SYSDATE AND FECHA_FIN_029 >= SYSDATE ) THEN 1 ");
		query.append(" ELSE 0 END ACTIVO ");
		query.append(DaoConstants.FROM + DBConstants.TABLA_29 + DaoConstants.SIGNO_COMA);
		query.append(DBConstants.TABLA_081 + " tareaFact," + DBConstants.TABLA_081 + " tareaRevPago,"
				+ DBConstants.TABLA_94);
		query.append(DaoConstants.WHERE + " tareaFact.ID_LOTE_081 = ID_LOTE_029 " + DaoConstants.AND
				+ " tareafact.IND_FACTURABLE_081 = '" + Constants.SI + "' " + DaoConstants.AND
				+ " tarearevpago.ID_TIPO_TAREA_081 = " + TipoTareaGestionAsociadaEnum.REVISION_PAGO_PROVEEDOR.getValue()
				+ DaoConstants.AND + " tareaFact.ID_TAREA_081 = tareaRevPago.ID_TAREA_REL_081 ");
		query.append(DaoConstants.AND + "tareaRevPago" + DaoConstants.SIGNO_PUNTO + DBConstants.ID_TAREA_081
				+ DaoConstants.SIGNOIGUAL + "ID_TAREA_094 ");
		query.append(DaoConstants.AND + " IND_ALBARAN_094 = '" + Constants.SI + "' ");
		query.append(DaoConstants.AND + " ID_EMPRESA_PROV_029 " + DaoConstants.SIGNOIGUAL_INTERROGACION);

		if (Constants.UNO == indPagado) {
			query.append(DaoConstants.AND + " IND_PAGADO_094 = '" + Constants.NO + "' ");
		}

		params.add(codEntidad);
		return this.getJdbcTemplate().query(query.toString(), this.rwMapLotesComboAlbaranes, params.toArray());

	}

	@Override
	public EntidadesLote getLoteExpedienteDefecto(Long anyo, Integer numExp) {

		List<Object> params = new ArrayList<Object>();

		StringBuilder query = new StringBuilder(DaoConstants.SELECT + "t1.ID_LOTE_029 IDLOTE");
		query.append(", t1.NOMBRE_LOTE_029 NOMBRELOTE");
		query.append(", t1.DESC_LOTE_EU_029 DESCLOTEEU");
		query.append(", t1.DESC_LOTE_ES_029 DESCLOTEES");
		query.append(", t4.ID_ENTIDAD_0D2 IDENTIDAD");
		query.append(", t4.TIPO_ENTIDAD_0D2 TIPOENTIDAD");
		query.append(DaoConstants.FROM + DBConstants.TABLA_29).append(" t1 ");
        query.append(" JOIN aa79b53s01 t3 ON t1.fecha_inicio_029 <= t3.fecha_final_izo_053 AND t1.fecha_fin_029 >= t3.fecha_final_izo_053");
		query.append(" JOIN aa79b54s01 t5 ON t3.anyo_053 = t5.anyo_054 AND t3.num_exp_053 = t5.num_exp_054");
		query.append(" JOIN aa79bd2s01 t4 ON t1.ID_LOTE_029 = t4.ID_LOTE_0D2 AND t5.id_entidad_054 = t4.id_entidad_0d2 AND t5.tipo_entidad_054 = t4.tipo_entidad_0d2");
		query.append(DaoConstants.WHERE_1_1);
		query.append(SqlUtils.generarWhereIgual("t3.ANYO_053", anyo, params));
		query.append(SqlUtils.generarWhereIgual("t3.NUM_EXP_053",numExp, params));
		List<EntidadesLote> lotes =  this.getJdbcTemplate().query(query.toString(), this.rwMapLoteDefecto, params.toArray());
		if (lotes.isEmpty()) {
			return new EntidadesLote();
		}
		return lotes.get(0);

	}

	@Override()
	public int actualizaImporteConsumido(Integer idLote, BigDecimal importeFactura) {
		int actualizado = 0;
		String query = "UPDATE AA79B29S01 SET IMPORTE_CONSUMIDO_029=IMPORTE_CONSUMIDO_029+? WHERE ID_LOTE_029=?";

		actualizado = this.getJdbcTemplate().update(query, importeFactura, idLote);
		return actualizado;
	}

	@Override
	public List<Lotes> getLotesNoPagados(String tipo, Integer codigo, Integer indPagado) {
		List<Object> paramsLNP = new ArrayList<Object>();

		StringBuilder queryLNP = new StringBuilder(DaoConstants.SELECT + DaoConstants.DISTINCT + "ID_LOTE_029 IDLOTE"
				+ DaoConstants.SIGNO_COMA + " NOMBRE_LOTE_029 NOMBRELOTE, ");
		queryLNP.append(" CASE WHEN ( FECHA_INICIO_029 <= SYSDATE AND FECHA_FIN_029 >= SYSDATE ) THEN 1 ");
		queryLNP.append(" ELSE 0 END ACTIVO ");
		queryLNP.append(DaoConstants.FROM + DBConstants.TABLA_29 + DaoConstants.SIGNO_COMA);
		queryLNP.append(DBConstants.TABLA_081 + " tareaFact," + DBConstants.TABLA_081 + " tareaRevPago,"
				+ DBConstants.TABLA_94);
		queryLNP.append(DaoConstants.WHERE + " tareaFact.ID_LOTE_081 = ID_LOTE_029 " + DaoConstants.AND
				+ " tareafact.IND_FACTURABLE_081 = '" + Constants.SI + "' " + DaoConstants.AND
				+ " tarearevpago.ID_TIPO_TAREA_081 = " + TipoTareaGestionAsociadaEnum.REVISION_PAGO_PROVEEDOR.getValue()
				+ DaoConstants.AND + " tareaFact.ID_TAREA_081 = tareaRevPago.ID_TAREA_REL_081 ");
		queryLNP.append(DaoConstants.AND + "tareaRevPago" + DaoConstants.SIGNO_PUNTO + DBConstants.ID_TAREA_081
				+ DaoConstants.SIGNOIGUAL + "ID_TAREA_094 ");
		queryLNP.append(DaoConstants.AND + " IND_ALBARAN_094 = '" + Constants.SI + "' ");
		queryLNP.append(SqlUtils.generarWhereLike("TIPO_ENTIDAD_029 ", tipo, paramsLNP, false));
		queryLNP.append(SqlUtils.generarWhereIgual("ID_EMPRESA_PROV_029 ", codigo, paramsLNP));

		if (Constants.UNO == indPagado) {
			queryLNP.append(DaoConstants.AND + " IND_PAGADO_094 = '" + Constants.NO + "' ");
		}

		return this.getJdbcTemplate().query(queryLNP.toString(), this.rwMapLotesComboAlbaranes, paramsLNP.toArray());
	}

}
