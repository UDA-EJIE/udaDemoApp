package com.ejie.aa79b.dao;

import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

import org.springframework.jdbc.core.RowMapper;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.ejie.aa79b.common.SqlUtils;
import com.ejie.aa79b.model.ContactoExcepFact;
import com.ejie.aa79b.model.Entidad;
import com.ejie.aa79b.model.ExcepcionFacturacion;
import com.ejie.aa79b.model.Solicitante;
import com.ejie.x38.dto.JQGridManager;
import com.ejie.x38.dto.JQGridRequestDto;

/**
 * ExcepcionFacturacionDaoImpl generated by UDA, 29-ene-2018 12:16:08.
 * 
 * @author UDA
 */

@Repository
@Transactional
public class ExcepcionFacturacionDaoImpl extends GenericoDaoImpl<ExcepcionFacturacion>
		implements ExcepcionFacturacionDao {

	protected static final String ID036 = "ID036";
	protected static final String ID_036 = "ID_036";

	private static final String TIPOENTIDADASOC036 = "TIPOENTIDADASOC036";
	private static final String IDENTIDADASOC036 = "IDENTIDADASOC036";
	private static final String DNICONTACTO036 = "DNICONTACTO036";
	private static final String PORFACTURA036 = "PORFACTURA036";

	private static final String DEFAULT_WHERE_JOIN = " WHERE 1=1 ";

	protected static final String[] ORDER_BY_WHITE_LIST = new String[] { ID036, "TIPOENTIDAD036", "IDENTIDAD036",
			"TIPOEXCEPCION036", TIPOENTIDADASOC036, IDENTIDADASOC036, DNICONTACTO036, PORFACTURA036, "ENTIDADDESCAMP",
			"SOLICITANTEAPEL1", "CONTACTOAPEL1", "SOLICITANTESCONCATENADOS" };

	/*
	 * ROW_MAPPERS
	 */
	private RowMapper<ExcepcionFacturacion> rwMap = new RowMapper<ExcepcionFacturacion>() {
		@Override()
		public ExcepcionFacturacion mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			ExcepcionFacturacion excepcionFacturacionAux = new ExcepcionFacturacion(resultSet.getLong(ID036));
			excepcionFacturacionAux.setTipoEntidad036(resultSet.getString("TIPOENTIDAD036"));
			excepcionFacturacionAux.setIdEntidad036(resultSet.getInt("IDENTIDAD036"));
			excepcionFacturacionAux.setTipoExcepcion036(resultSet.getInt("TIPOEXCEPCION036"));
			excepcionFacturacionAux.setTipoEntidadAsoc036(resultSet.getString(TIPOENTIDADASOC036));
			excepcionFacturacionAux.setIdEntidadAsoc036(resultSet.getInt(IDENTIDADASOC036));
			excepcionFacturacionAux.setDniContacto036(resultSet.getString(DNICONTACTO036));
			excepcionFacturacionAux.setPorFactura036(resultSet.getLong(PORFACTURA036));
			return excepcionFacturacionAux;
		}
	};

	private RowMapper<ExcepcionFacturacion> rwMapPK = new RowMapper<ExcepcionFacturacion>() {
		@Override
		public ExcepcionFacturacion mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			return new ExcepcionFacturacion(resultSet.getLong(ID036));
		}
	};

	private class RWContactosConcatenados implements RowMapper<ExcepcionFacturacion> {
		@Override()
		public ExcepcionFacturacion mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			ExcepcionFacturacion excepcionFacturacionAux = new ExcepcionFacturacion(resultSet.getLong(ID036));
			excepcionFacturacionAux.setTipoEntidad036(resultSet.getString("TIPOENTIDAD036"));
			excepcionFacturacionAux.setIdEntidad036(resultSet.getInt("IDENTIDAD036"));
			excepcionFacturacionAux.setTipoExcepcion036(resultSet.getInt("TIPOEXCEPCION036"));
			excepcionFacturacionAux.setTipoEntidadAsoc036(resultSet.getString(TIPOENTIDADASOC036));
			excepcionFacturacionAux.setIdEntidadAsoc036(resultSet.getInt(IDENTIDADASOC036));
			excepcionFacturacionAux.setDniContacto036(resultSet.getString(DNICONTACTO036));
			excepcionFacturacionAux.setPorFactura036(resultSet.getLong(PORFACTURA036));

			Entidad entidadSolicitante = new Entidad();
			entidadSolicitante.setCodigo(resultSet.getInt("IDENTIDAD036"));
			entidadSolicitante.setTipo(resultSet.getString("TIPOENTIDAD036"));
			entidadSolicitante.setDescAmpEu(resultSet.getString("ENTIDADDESCAMP"));
			excepcionFacturacionAux.setEntidadSolicitante(entidadSolicitante);

			Entidad entidadFactura = new Entidad();
			entidadFactura.setCodigo(resultSet.getInt(IDENTIDADASOC036));
			entidadFactura.setTipo(resultSet.getString(TIPOENTIDADASOC036));
			entidadFactura.setDescAmpEu(resultSet.getString("ENTIDADFACTDESCAMP"));
			excepcionFacturacionAux.setEntidadFactura(entidadFactura);

			Solicitante contacto = new Solicitante();
			contacto.setApellido1(resultSet.getString("CONTACTOAPEL1"));
			contacto.setApellido2(resultSet.getString("CONTACTOAPEL2"));
			contacto.setNombre(resultSet.getString("CONTACTONOMBRE"));
			contacto.setDni(resultSet.getString("DNICONTACTO036"));
			excepcionFacturacionAux.setContacto(contacto);

			excepcionFacturacionAux.setSolicitantesConcatenados(resultSet.getString("SOLICITANTESCONCATENADOS"));
			excepcionFacturacionAux.setDnisSolicConcatenados(resultSet.getString("DNISSOLICITANTESCONCATENADOS"));

			return excepcionFacturacionAux;
		}
	}

	private RowMapper<ExcepcionFacturacion> rwMapContactosConcatenados = new RWContactosConcatenados();

	/**
	 * Constructor
	 */
	public ExcepcionFacturacionDaoImpl() {
		/* Constructor */
		super(ExcepcionFacturacion.class);
	}
	/*
	 * OPERACIONES CRUD
	 */

	/**
	 * Inserts a single row in the ExcepcionFacturacion table.
	 *
	 * @param excepcionfacturacion
	 *            ExcepcionFacturacion
	 * @return ExcepcionFacturacion
	 */
	@Override
	public ExcepcionFacturacion add(ExcepcionFacturacion excepcionfacturacion) {
		final Long elId = this.getNextVal("AA79B36Q00");
		String query = "INSERT INTO AA79B36S01 (ID_036, TIPO_ENTIDAD_036, ID_ENTIDAD_036, TIPO_EXCEPCION_036, TIPO_ENTIDAD_ASOC_036, ID_ENTIDAD_ASOC_036, DNI_CONTACTO_036, POR_FACTURA_036) VALUES (?,?,?,?,?,?,?,?)";
		this.getJdbcTemplate().update(query, elId, excepcionfacturacion.getTipoEntidad036(),
				excepcionfacturacion.getIdEntidad036(), excepcionfacturacion.getTipoExcepcion036(),
				excepcionfacturacion.getTipoEntidadAsoc036(), excepcionfacturacion.getIdEntidadAsoc036(),
				excepcionfacturacion.getDniContacto036(), excepcionfacturacion.getPorFactura036());
		excepcionfacturacion.setId036(elId);
		return excepcionfacturacion;
	}

	/**
	 * Updates a single row in the ExcepcionFacturacion table.
	 *
	 * @param excepcionfacturacion
	 *            ExcepcionFacturacion
	 * @return ExcepcionFacturacion
	 */
	@Override
	public ExcepcionFacturacion update(ExcepcionFacturacion excepcionfacturacion) {
		String query = "UPDATE AA79B36S01 SET TIPO_ENTIDAD_036=?, ID_ENTIDAD_036=?, TIPO_EXCEPCION_036=?, TIPO_ENTIDAD_ASOC_036=?, ID_ENTIDAD_ASOC_036=?, DNI_CONTACTO_036=?,POR_FACTURA_036=? WHERE ID_036=?";
		this.getJdbcTemplate().update(query, excepcionfacturacion.getTipoEntidad036(),
				excepcionfacturacion.getIdEntidad036(), excepcionfacturacion.getTipoExcepcion036(),
				excepcionfacturacion.getTipoEntidadAsoc036(), excepcionfacturacion.getIdEntidadAsoc036(),
				excepcionfacturacion.getDniContacto036(), excepcionfacturacion.getPorFactura036(),
				excepcionfacturacion.getId036());
		return excepcionfacturacion;
	}

	/**
	 * Removes a single row in the ExcepcionFacturacion table.
	 *
	 * @param excepcionfacturacion
	 *            ExcepcionFacturacion
	 * @return
	 */
	@Override
	public void remove(ExcepcionFacturacion excepcionfacturacion) {
		String query = "DELETE FROM AA79B36S01 WHERE ID_036=?";
		this.getJdbcTemplate().update(query, excepcionfacturacion.getId036());
	}

	/**
	 * The method getQuery.
	 * 
	 * @return String OJO CON ESTE MÉTOD
	 */
	@Override()
	protected String getSelect() {
		StringBuilder sb = new StringBuilder();
		sb.append(
				"SELECT t1.ID_036 ID036, t1.TIPO_ENTIDAD_036 TIPOENTIDAD036, t1.ID_ENTIDAD_036 IDENTIDAD036, t1.TIPO_EXCEPCION_036 TIPOEXCEPCION036, t1.TIPO_ENTIDAD_ASOC_036 TIPOENTIDADASOC036, t1.ID_ENTIDAD_ASOC_036 IDENTIDADASOC036, t1.DNI_CONTACTO_036 DNICONTACTO036, t1.POR_FACTURA_036 PORFACTURA036 ");
		return sb.toString();
	}

	@Override()
	protected String getFrom() {
		return " FROM AA79B36S01 t1  ";
	}

	@Override()
	protected RowMapper<ExcepcionFacturacion> getRwMap() {
		return this.rwMap;
	}

	@Override()
	protected String[] getOrderBy() {
		return ExcepcionFacturacionDaoImpl.ORDER_BY_WHITE_LIST;
	}

	@Override()
	protected String getPK() {
		return ID_036;
	}

	@Override()
	protected RowMapper<ExcepcionFacturacion> getRwMapPK() {
		return this.rwMapPK;
	}

	protected RowMapper<ExcepcionFacturacion> getRwMapContactosConcatenados() {
		return this.rwMapContactosConcatenados;
	}

	@Override()
	protected String getWherePK(ExcepcionFacturacion bean, List<Object> params) {
		params.add(bean.getId036());
		return "  WHERE t1.ID_036 = ?  ";
	}

	/*
	 * MÉTODOS PRIVADOS
	 */
	@Override()
	protected String getWhere(ExcepcionFacturacion bean, List<Object> params) {

		StringBuilder where = new StringBuilder(HorasHorariosAtencionDaoImpl.STRING_BUILDER_INIT);

		where.append(SqlUtils.generarWhereIgual(ID_036, bean.getId036(), params));
		where.append(SqlUtils.generarWhereIgual("TIPO_ENTIDAD_036", bean.getTipoEntidad036(), params));
		where.append(SqlUtils.generarWhereIgual("ID_ENTIDAD_036", bean.getIdEntidad036(), params));
		where.append(SqlUtils.generarWhereIgual("TIPO_EXCEPCION_036", bean.getTipoExcepcion036(), params));
		where.append(SqlUtils.generarWhereIgual("TIPO_ENTIDAD_ASOC_036", bean.getTipoEntidadAsoc036(), params));
		where.append(SqlUtils.generarWhereIgual("ID_ENTIDAD_ASOC_036", bean.getIdEntidadAsoc036(), params));
		where.append(SqlUtils.generarWhereIgual("DNI_CONTACTO_036", bean.getDniContacto036(), params));
		where.append(SqlUtils.generarWhereIgual("POR_FACTURA_036", bean.getPorFactura036(), params));
		return where.toString();
	}

	@Override
	protected String getWhereLike(ExcepcionFacturacion bean, Boolean startsWith, List<Object> params, Boolean search) {

		StringBuilder whereLike = new StringBuilder(HorasHorariosAtencionDaoImpl.STRING_BUILDER_INIT);
		whereLike.append(SqlUtils.generarWhereIgual(ID_036, bean.getId036(), params));
		whereLike.append(SqlUtils.generarWhereLike("TIPO_ENTIDAD_036", bean.getTipoEntidad036(), params, startsWith));
		whereLike.append(SqlUtils.generarWhereIgual("ID_ENTIDAD_036", bean.getIdEntidad036(), params));
		whereLike.append(SqlUtils.generarWhereIgual("TIPO_EXCEPCION_036", bean.getTipoExcepcion036(), params));
		whereLike.append(SqlUtils.generarWhereIgual("TIPO_ENTIDAD_ASOC_036", bean.getTipoEntidadAsoc036(), params));
		whereLike.append(SqlUtils.generarWhereIgual("ID_ENTIDAD_ASOC_036", bean.getIdEntidadAsoc036(), params));
		whereLike.append(SqlUtils.generarWhereIgual("DNI_CONTACTO_036", bean.getDniContacto036(), params));
		whereLike.append(SqlUtils.generarWhereIgual("POR_FACTURA_036", bean.getPorFactura036(), params));
		return whereLike.toString();
	}

	/**
	 * Finds rows in the T table using like.
	 * 
	 * @param bean
	 *            T
	 * @param jqGridRequestDto
	 *            JQGridRequestDto
	 * @param startsWith
	 *            Boolean
	 * @return List<T>
	 */
	@Override
	@Transactional(readOnly = true)
	public List<ExcepcionFacturacion> filtroConJoinsConcatenado(ExcepcionFacturacion bean,
			JQGridRequestDto jqGridRequestDto, Boolean startsWith) {
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder(this.getSelect());
		query.append(
				" , t3.DESC_AMP_EU ENTIDADFACTDESCAMP, t4.NOMBRE_077 CONTACTONOMBRE, t4.APEL1_077 CONTACTOAPEL1, t4.APEL2_077 CONTACTOAPEL2, LISTAGG(t5.NOMBRE_077 || ' ' || t5.APEL1_077 || ' ' || t5.APEL2_077 , ', ') WITHIN GROUP (ORDER BY t5.NOMBRE_077) SOLICITANTESCONCATENADOS,LISTAGG(t5.DNI_077, ',') WITHIN GROUP (ORDER BY t5.DNI_077) DNISSOLICITANTESCONCATENADOS, t6.DESC_AMP_EU ENTIDADDESCAMP");

		query.append(this.getFrom(bean, params));
		query.append(
				" LEFT JOIN X54JAPI_ENTIDADES_SOLIC t3 ON (t3.CODIGO = t1.ID_ENTIDAD_ASOC_036 AND t3.TIPO = t1.TIPO_ENTIDAD_ASOC_036) ");
		query.append(" LEFT JOIN AA79B77S01 t4 ON t4.DNI_077 = t1.DNI_CONTACTO_036 ");
		query.append(
				" LEFT JOIN X54JAPI_ENTIDADES_SOLIC t6 ON (t6.CODIGO = t1.ID_ENTIDAD_036 AND t6.TIPO = t1.TIPO_ENTIDAD_036) ");
		query.append(" LEFT JOIN AA79B37S01 t2 ON ID_036=ID_EXCEPCION_037 ");
		query.append(" LEFT JOIN AA79B77S01 t5 ON t2.DNI_TRABAJADOR_037 = t5.DNI_077 ");

		query.append(ExcepcionFacturacionDaoImpl.DEFAULT_WHERE_JOIN);
		query.append(this.getWhere(bean, params));
		query.append(
				" GROUP BY t1.ID_036, t1.TIPO_ENTIDAD_036, t1.ID_ENTIDAD_036, t1.TIPO_EXCEPCION_036, t1.TIPO_ENTIDAD_ASOC_036, t1.ID_ENTIDAD_ASOC_036, t1.DNI_CONTACTO_036, t1.POR_FACTURA_036, t3.DESC_AMP_EU, t4.NOMBRE_077, t4.APEL1_077, t4.APEL2_077, t6.DESC_AMP_EU");
		if (jqGridRequestDto != null) {
			query = JQGridManager.getPaginationQuery(jqGridRequestDto, query, this.getOrderBy());
		}

		return this.getJdbcTemplate().query(query.toString(), this.getRwMapContactosConcatenados(), params.toArray());
	}

	/**
	 * Counts rows in the T table using like.
	 * 
	 * @param bean
	 *            T
	 * @param startsWith
	 *            Boolean
	 * @return Long
	 */
	@Override
	@Transactional(readOnly = true)
	public Long filtroConJoinsConcatenadoCount(ExcepcionFacturacion bean, Boolean startsWith) {
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder("SELECT COUNT(1)");
		query.append(this.getFrom(bean, params));
		query.append(ExcepcionFacturacionDaoImpl.DEFAULT_WHERE_JOIN);
		query.append(this.getWhere(bean, params));
		return this.getJdbcTemplate().queryForObject(query.toString(), params.toArray(), Long.class);
	}

	@Override
	public Integer sumatorioPorcentajesExcepEntidad(ExcepcionFacturacion bean) {
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder(
				"SELECT NVL(SUM(POR_FACTURA_036),0) sumaPorcentajes FROM AA79B36S01 WHERE TIPO_ENTIDAD_036 = ?  AND ID_ENTIDAD_036 = ? AND TIPO_EXCEPCION_036 = ?");
		params.add(bean.getTipoEntidad036());
		params.add(bean.getIdEntidad036());
		params.add(bean.getTipoExcepcion036());
		if (bean.getId036() != null) {
			query.append("  AND ID_036 != ? ");
			params.add(bean.getId036());
		}

		return this.getJdbcTemplate().queryForObject(query.toString(), params.toArray(), Integer.class);
	}

	@Override
	public Integer validarContactoSolicDuplicado(ExcepcionFacturacion bean) {
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder(
				"SELECT COUNT(1) FROM AA79B36S01 t1 LEFT JOIN  AA79B37S01 t2 ON t2.ID_EXCEPCION_037 = t1.ID_036 ");
		query.append(" WHERE TIPO_ENTIDAD_036 = ?  AND ID_ENTIDAD_036 = ? AND TIPO_EXCEPCION_036 = ? ");
		params.add(bean.getTipoEntidad036());
		params.add(bean.getIdEntidad036());
		params.add(bean.getTipoExcepcion036());
		if (bean.getId036() != null) {
			query.append("  AND t1.ID_036 != ? ");
			params.add(bean.getId036());
		}
		query.append(" AND t2.DNI_TRABAJADOR_037 IN (");
		for (ContactoExcepFact unContacto : bean.getPersonasSolicitantes()) {
			query.append("?,");
			params.add(unContacto.getDniTrabajador037());
		}
		String strQuery = query.substring(0, query.length() - 1) + ")";
		return this.getJdbcTemplate().queryForObject(strQuery, params.toArray(), Integer.class);
	}

	@Override
	public List<ExcepcionFacturacion> findExcepcionesSolicitante(ExcepcionFacturacion bean, String dni) {
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder(this.getSelect());

		params.add(dni);

		query.append(this.getFrom());
		query.append(" JOIN AA79B37S01 t2 ON t1.ID_036 = t2.ID_EXCEPCION_037 ");
		query.append(" AND t2.DNI_TRABAJADOR_037 = ? ");
		query.append(GenericoDaoImpl.DEFAULT_WHERE);
		query.append(this.getWhere(bean, params));

		return this.getJdbcTemplate().query(query.toString(), this.getRwMap(), params.toArray());
	}

	@Override
	public List<ExcepcionFacturacion> findExcepcionesFacturacion(ExcepcionFacturacion bean) {
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder(this.getSelect());
		query.append(this.getFrom());
		query.append(GenericoDaoImpl.DEFAULT_WHERE);
		query.append(this.getWhere(bean, params));

		return this.getJdbcTemplate().query(query.toString(), this.getRwMap(), params.toArray());
	}

}