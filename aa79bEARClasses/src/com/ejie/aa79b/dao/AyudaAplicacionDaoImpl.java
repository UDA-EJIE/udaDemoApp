package com.ejie.aa79b.dao;

import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.List;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.dao.DataAccessException;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.ejie.aa79b.common.DBConstants;
import com.ejie.aa79b.common.SqlUtils;
import com.ejie.aa79b.model.AyudaAplicacion;

/**
 * AyudaAplicacionDaoImpl generated by UDA, 16-nov-2017 14:42:24.
 * 
 * @author UDA
 */

@Repository()
@Transactional()
public class AyudaAplicacionDaoImpl extends GenericoDaoImpl<AyudaAplicacion> implements AyudaAplicacionDao {

	protected static final String IDAYUDA = "IDAYUDA";
	protected static final String CONTENIDO = "CONTENIDO";
	protected static final String IDAYUDAPADRE = "IDAYUDAPADRE";
	protected static final String ORDEN = "ORDEN";
	protected static final String LEVEL = "LEVEL";
	protected static final String ID_AYUDA_017 = "ID_AYUDA_017";
	protected static final String TITULO_017 = "TITULO_017";
	protected static final String ID_AYUDA_PADRE_017 = "ID_AYUDA_PADRE_017";
	protected static final String ORDEN_017 = "ORDEN_017";
	protected static final String[] ORDER_BY_WHITE_LIST = new String[] { IDAYUDA, DBConstants.TITULO, CONTENIDO,
			IDAYUDAPADRE, ORDEN };

	/**
	 * LOGGER: Logger.
	 */
	private static final Logger LOGGER = LoggerFactory.getLogger(AyudaAplicacionDaoImpl.class);

	/*
	 * ROW_MAPPERS
	 */
	private RowMapper<AyudaAplicacion> rwMap = new RowMapper<AyudaAplicacion>() {
		@Override()
		public AyudaAplicacion mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			AyudaAplicacion ayudaAplicacion = new AyudaAplicacion();
			ayudaAplicacion.setIdAyuda(resultSet.getLong(IDAYUDA));
			ayudaAplicacion.setTitulo(resultSet.getString(DBConstants.TITULO));
			ayudaAplicacion.setContenido(SqlUtils.getClob( resultSet,CONTENIDO));
			ayudaAplicacion.setIdAyudaPadre(resultSet.getLong(IDAYUDAPADRE));
			ayudaAplicacion.setOrden(resultSet.getLong(ORDEN));
			return ayudaAplicacion;
		}
	};

	private RowMapper<AyudaAplicacion> rwMapPK = new RowMapper<AyudaAplicacion>() {
		@Override()
		public AyudaAplicacion mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			AyudaAplicacion ayudaAplicacion = new AyudaAplicacion();
			ayudaAplicacion.setIdAyuda(resultSet.getLong(IDAYUDA));
			return ayudaAplicacion;
		}
	};

	private RowMapper<AyudaAplicacion> rwMapTree = new RowMapper<AyudaAplicacion>() {
		@Override()
		public AyudaAplicacion mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			AyudaAplicacion ayudaAplicacion = new AyudaAplicacion();
			ayudaAplicacion.setIdAyuda(resultSet.getLong(IDAYUDA));
			ayudaAplicacion.setTitulo(resultSet.getString(DBConstants.TITULO));
			ayudaAplicacion.setContenido(SqlUtils.getClob( resultSet,CONTENIDO));
			ayudaAplicacion.setIdAyudaPadre(resultSet.getLong(IDAYUDAPADRE));
			ayudaAplicacion.setOrden(resultSet.getLong(ORDEN));
			ayudaAplicacion.setLevel(resultSet.getBigDecimal(LEVEL).intValue());
			return ayudaAplicacion;
		}
	};

	/**
	 * Constructor
	 */
	public AyudaAplicacionDaoImpl() {
		super(AyudaAplicacion.class);
	}

	@Override()
	public AyudaAplicacion add(AyudaAplicacion ayudaaplicacion) {

		StringBuilder queryId = new StringBuilder("SELECT AA79B17Q00.NEXTVAL FROM dual ");
		Long id = this.getJdbcTemplate().queryForObject(queryId.toString(), Long.class);
		ayudaaplicacion.setIdAyuda(id);

		StringBuilder sbOrden = new StringBuilder();
		sbOrden.append("( SELECT NVL(MAX(t1.ORDEN_017), 0) + 1");
		sbOrden.append(this.getFrom());
		sbOrden.append(" WHERE t1.ID_AYUDA_PADRE_017 = ");
		sbOrden.append(ayudaaplicacion.getIdAyudaPadre());
		sbOrden.append(" )");

		Long orden = this.getJdbcTemplate().queryForObject(sbOrden.toString(), Long.class);
		if (orden != 0) {
			ayudaaplicacion.setOrden(orden);
		} else {
			// Cuando se crea el primer hijo de un padre la select que calcula
			// el orden correspondiente
			// devuelve null y su conversion a tipo Long es 0. Por ello
			// asignamos orden 1 manualmente.
			// Para los restantes casos asignamos el orden que devuelve la
			// select ejecutada.
			ayudaaplicacion.setOrden(new Long(1));
		}

		StringBuilder sb = new StringBuilder();
		sb.append("INSERT INTO AA79B17S01 (ID_AYUDA_017, TITULO_017, CONTENIDO_017, ID_AYUDA_PADRE_017, ORDEN_017)");
		sb.append(" VALUES (?,?,?,?,?)");

		String query = sb.toString();

		try {
			this.getJdbcTemplate().update(query, ayudaaplicacion.getIdAyuda(), ayudaaplicacion.getTitulo(),
					ayudaaplicacion.getContenido() != null && ayudaaplicacion.getContenido().length() > 0
							? ayudaaplicacion.getContenido()
							: null,
					ayudaaplicacion.getIdAyudaPadre(), ayudaaplicacion.getOrden());
		} catch (DataAccessException e) {
			AyudaAplicacionDaoImpl.LOGGER.error(e.getMessage(), e);
		} catch (Exception e) {
			AyudaAplicacionDaoImpl.LOGGER.error(e.getMessage(), e);
		}
		return ayudaaplicacion;
	}

	@Override()
	public AyudaAplicacion update(AyudaAplicacion ayudaaplicacion) {
		String query = "UPDATE AA79B17S01 SET CONTENIDO_017=?  WHERE ID_AYUDA_017=?";

		try {
			this.getJdbcTemplate().update(query,
					ayudaaplicacion.getContenido() != null && ayudaaplicacion.getContenido().length() > 0
							? ayudaaplicacion.getContenido()
							: null,
					ayudaaplicacion.getIdAyuda());
		} catch (DataAccessException e) {
			AyudaAplicacionDaoImpl.LOGGER.error(e.getMessage(), e);
		} catch (Exception e) {
			AyudaAplicacionDaoImpl.LOGGER.error(e.getMessage(), e);
		}
		return ayudaaplicacion;
	}

	/**
	 * Updates a single row in the AyudaAplicacion table.
	 *
	 * @param ayudaaplicacion
	 *            AyudaAplicacion
	 * @return AyudaAplicacion
	 */
	@Override()
	public AyudaAplicacion rename(AyudaAplicacion ayudaaplicacion) {
		String query = "UPDATE AA79B17S01 SET TITULO_017=?  WHERE ID_AYUDA_017=?";

		this.getJdbcTemplate().update(query, ayudaaplicacion.getTitulo(), ayudaaplicacion.getIdAyuda());

		return ayudaaplicacion;
	}

	@Override()
	public void remove(AyudaAplicacion ayudaaplicacion) {
		String query = "DELETE FROM AA79B17S01 WHERE ID_AYUDA_017=?";
		this.getJdbcTemplate().update(query, ayudaaplicacion.getIdAyuda());
	}

	@Override()
	protected String getSelect() {
		StringBuilder queryAA = new StringBuilder();

		queryAA.append("SELECT t1.ID_AYUDA_017 IDAYUDA");
		queryAA.append(", t1.TITULO_017 TITULO");
		queryAA.append(", t1.CONTENIDO_017 CONTENIDO");
		queryAA.append(", t1.ID_AYUDA_PADRE_017 IDAYUDAPADRE");
		queryAA.append(", t1.ORDEN_017 ORDEN");

		return queryAA.toString();
	}

	@Override()
	protected String getFrom() {
		return " FROM AA79B17S01 t1";
	}

	@Override()
	protected RowMapper<AyudaAplicacion> getRwMap() {
		return this.rwMap;
	}

	@Override()
	protected String[] getOrderBy() {
		return AyudaAplicacionDaoImpl.ORDER_BY_WHITE_LIST;
	}

	@Override()
	protected String getPK() {
		return ID_AYUDA_017;
	}

	@Override()
	protected RowMapper<AyudaAplicacion> getRwMapPK() {
		return this.rwMapPK;
	}

	@Override()
	protected String getWherePK(AyudaAplicacion bean, List<Object> params) {
		params.add(bean.getIdAyuda());
		return " WHERE t1.ID_AYUDA_017 = ?";
	}

	@Override
	protected String getWhere(AyudaAplicacion bean, List<Object> params) {

		StringBuilder where = new StringBuilder(AyudaAplicacionDaoImpl.STRING_BUILDER_INIT);

		where.append(SqlUtils.generarWhereIgual(ID_AYUDA_017, bean.getIdAyuda(), params));
		where.append(SqlUtils.generarWhereLikeNormalizado(TITULO_017, bean.getTitulo(), params, false));
		where.append(SqlUtils.generarWhereIgual(ID_AYUDA_PADRE_017, bean.getIdAyudaPadre(), params));
		where.append(SqlUtils.generarWhereIgual(ORDEN_017, bean.getOrden(), params));

		return where.toString();
	}

	@Override
	protected String getWhereLike(AyudaAplicacion bean, Boolean startsWith, List<Object> params, Boolean search) {

		StringBuilder where = new StringBuilder(AyudaAplicacionDaoImpl.STRING_BUILDER_INIT);

		where.append(SqlUtils.generarWhereIgual(ID_AYUDA_017, bean.getIdAyuda(), params));
		where.append(SqlUtils.generarWhereLikeNormalizado(TITULO_017, bean.getTitulo(), params, startsWith));
		where.append(SqlUtils.generarWhereIgual(ID_AYUDA_PADRE_017, bean.getIdAyudaPadre(), params));
		where.append(SqlUtils.generarWhereIgual(ORDEN_017, bean.getOrden(), params));

		return where.toString();
	}

	/**
	 * Finds a list of rows in the AyudaAplicacion table.
	 * 
	 * @param bean
	 *            AyudaAplicacion
	 *
	 * @return List<AyudaAplicacion>
	 */
	@Transactional(readOnly = true)
	@Override()
	public List<AyudaAplicacion> findAll(AyudaAplicacion bean) {

		StringBuilder query = new StringBuilder(this.getSelect());
		query.append(", LEVEL");
		query.append(this.getFrom());
		query.append(this.getAdditionalClauses(bean));

		return this.getJdbcTemplate().query(query.toString(), this.rwMapTree);
	}

	/**
	 * Gets additional clauses
	 * 
	 * @param bean
	 *            AyudaAplicacion
	 * 
	 * @return String
	 */
	private String getAdditionalClauses(AyudaAplicacion bean) {
		StringBuilder additionalClauses = new StringBuilder(AyudaAplicacionDaoImpl.STRING_BUILDER_INIT);
		Long idAyudaPadre;

		if (bean != null && bean.getIdAyudaPadre() != null) {
			idAyudaPadre = bean.getIdAyudaPadre();
		} else {
			idAyudaPadre = new Long(0);
		}

		additionalClauses.append(" START WITH t1.ID_AYUDA_PADRE_017 = ");
		additionalClauses.append(idAyudaPadre);
		additionalClauses.append(" CONNECT BY PRIOR ID_AYUDA_017 = ID_AYUDA_PADRE_017");
		additionalClauses.append(" ORDER SIBLINGS BY ORDEN_017");

		return additionalClauses.toString();
	}

	/**
	 * Updates a single row in the AyudaAplicacion table.
	 *
	 * @param ayudaaplicacion
	 *            AyudaAplicacion
	 * @return AyudaAplicacion
	 */
	@Override()
	public AyudaAplicacion move(AyudaAplicacion ayudaaplicacion) {
		String query = "UPDATE AA79B17S01 SET ORDEN_017=?, ID_AYUDA_PADRE_017=?  WHERE ID_AYUDA_017=?";

		this.getJdbcTemplate().update(query, ayudaaplicacion.getOrden(), ayudaaplicacion.getIdAyudaPadre(),
				ayudaaplicacion.getIdAyuda());

		return ayudaaplicacion;
	}

}
