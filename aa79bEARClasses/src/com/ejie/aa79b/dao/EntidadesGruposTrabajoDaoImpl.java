package com.ejie.aa79b.dao;

import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;
import java.util.Locale;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.i18n.LocaleContextHolder;
import org.springframework.context.support.ReloadableResourceBundleMessageSource;
import org.springframework.dao.support.DataAccessUtils;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.common.DBConstants;
import com.ejie.aa79b.common.DaoConstants;
import com.ejie.aa79b.common.SqlUtils;
import com.ejie.aa79b.model.EntidadesGruposTrabajo;
import com.ejie.aa79b.model.enums.ActivoEnum;
import com.ejie.aa79b.model.enums.TipoEntidadEnum;
import com.ejie.x38.dto.JQGridRequestDto;
import com.ejie.x38.dto.JQGridRequestDto.Multiselection;

/**
 * EntidadesGruposTrabajoDaoImpl generated by UDA, 24-nov-2017 10:10:28.
 * 
 * @author UDA
 */

@Repository()
@Transactional
public class EntidadesGruposTrabajoDaoImpl extends GenericoDaoImpl<EntidadesGruposTrabajo>
		implements EntidadesGruposTrabajoDao {

	@Autowired()
	private ReloadableResourceBundleMessageSource msg;

	public EntidadesGruposTrabajoDaoImpl() {
		super(EntidadesGruposTrabajo.class);
	}

	public static final String[] ORDER_BY_WHITE_LIST = new String[] { "IDGRUPO027", "IDENTIDAD027", DBConstants.DESCES,
			DBConstants.DESCEU, "TIPODESC" };

	/*
	 * ROW_MAPPERS
	 */
	private RowMapper<EntidadesGruposTrabajo> rwMap = new RowMapper<EntidadesGruposTrabajo>() {
		@Override
		public EntidadesGruposTrabajo mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			EntidadesGruposTrabajo bean = new EntidadesGruposTrabajo();
			bean.setIdGrupo(resultSet.getLong("IDGRUPO027"));
			bean.setTipo(resultSet.getString("TIPOENTIDAD027"));
			bean.setTipoDesc(resultSet.getString("TIPODESC"));
			bean.setCodigo(resultSet.getInt("IDENTIDAD027"));
			bean.setDescEs(resultSet.getString(DBConstants.DESCES));
			bean.setDescEu(resultSet.getString(DBConstants.DESCEU));
			bean.setFacturableDesc(resultSet.getString("FACTURABLEDESC"));
			bean.setIvaDesc(resultSet.getString("IVADESC"));
			return bean;
		}
	};

	private RowMapper<EntidadesGruposTrabajo> rwMapPK = new RowMapper<EntidadesGruposTrabajo>() {
		@Override
		public EntidadesGruposTrabajo mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			EntidadesGruposTrabajo bean = new EntidadesGruposTrabajo();
			bean.setCodigoCompleto(resultSet.getString(1));
			return bean;
		}
	};

	@Override()
	public EntidadesGruposTrabajo add(EntidadesGruposTrabajo entidadesgrupostrabajo) {
		String query = "INSERT INTO AA79B27S01 (ID_GRUPO_027, TIPO_ENTIDAD_027, ID_ENTIDAD_027) VALUES (?,?,?)";
		this.getJdbcTemplate().update(query, entidadesgrupostrabajo.getIdGrupo(), entidadesgrupostrabajo.getTipo(),
				entidadesgrupostrabajo.getCodigo());
		return entidadesgrupostrabajo;
	}

	@Override()
	public void remove(EntidadesGruposTrabajo entidadesgrupostrabajo) {
		String query = "DELETE FROM AA79B27S01 WHERE ID_GRUPO_027=? AND TIPO_ENTIDAD_027 = ? AND ID_ENTIDAD_027 = ?";
		this.getJdbcTemplate().update(query, entidadesgrupostrabajo.getIdGrupo(), entidadesgrupostrabajo.getTipo(),
				entidadesgrupostrabajo.getCodigo());
	}

	@Override()
	public void removeWhereID(EntidadesGruposTrabajo entidadesgrupostrabajo) {
		String query = "DELETE FROM AA79B27S01 WHERE ID_GRUPO_027=?";
		this.getJdbcTemplate().update(query, entidadesgrupostrabajo.getIdGrupo());
	}

	@Override()
	protected String getSelect() {
		Locale locale = LocaleContextHolder.getLocale();
		StringBuilder selectEntGrupos = new StringBuilder();
		selectEntGrupos.append("SELECT NVL(t1.ID_GRUPO_027, 0) IDGRUPO027");
		selectEntGrupos.append(", TIPO TIPOENTIDAD027");
		selectEntGrupos.append(", CODIGO IDENTIDAD027");
		selectEntGrupos.append(", DESC_ES DESCES");
		selectEntGrupos.append(", DESC_EU DESCEU");
		selectEntGrupos.append(", DECODE(TIPO");
		for (TipoEntidadEnum tipo : TipoEntidadEnum.values()) {
			selectEntGrupos.append(", '").append(tipo.getValue()).append("'");
			selectEntGrupos.append(", '").append(this.msg.getMessage(tipo.getLabel(), null, locale)).append("'");
		}
		selectEntGrupos.append(") AS TIPODESC");
		selectEntGrupos.append(", FACTURABLE");
		selectEntGrupos.append(", DECODE(FACTURABLE, '").append(ActivoEnum.SI.getValue()).append("', '")
				.append(this.msg.getMessage(ActivoEnum.SI.getLabel(), null, locale)).append("', '")
				.append(ActivoEnum.NO.getValue()).append("', '")
				.append(this.msg.getMessage(ActivoEnum.NO.getLabel(), null, locale)).append("') AS FACTURABLEDESC");
		selectEntGrupos.append(", IVA");
		selectEntGrupos.append(", DECODE(IVA, '").append(ActivoEnum.SI.getValue()).append("', '")
				.append(this.msg.getMessage(ActivoEnum.SI.getLabel(), null, locale)).append("', '")
				.append(ActivoEnum.NO.getValue()).append("', '")
				.append(this.msg.getMessage(ActivoEnum.NO.getLabel(), null, locale)).append("') AS IVADESC");
		return selectEntGrupos.toString();
	}

	@Override()
	protected String getFrom() {
		StringBuilder fromEntGrupo = new StringBuilder();
		fromEntGrupo.append(" FROM X54JAPI_ENTIDADES_SOLIC");
		fromEntGrupo.append(" LEFT JOIN AA79B27S01 t1 ON TIPO = TIPO_ENTIDAD_027 AND CODIGO = ID_ENTIDAD_027");
		fromEntGrupo.append(" LEFT JOIN AA79B26S01 t2 ON ID_026 = ID_GRUPO_027");
		return fromEntGrupo.toString();
	}

	@Override()
	protected RowMapper<EntidadesGruposTrabajo> getRwMap() {
		return this.rwMap;
	}

	@Override()
	protected String[] getOrderBy() {
		return ORDER_BY_WHITE_LIST;
	}

	@Override()
	protected String getPK() {
		return "ID_GRUPO_027 || '_' || TIPO_ENTIDAD_027 || '_' || ID_ENTIDAD_027";
	}

	@Override()
	protected RowMapper<EntidadesGruposTrabajo> getRwMapPK() {
		return this.rwMapPK;
	}

	@Override()
	protected String getWherePK(EntidadesGruposTrabajo bean, List<Object> params) {
		params.add(bean.getIdGrupo());
		params.add(bean.getTipo());
		params.add(bean.getCodigo());
		return " WHERE ID_GRUPO_027 = ? AND TIPO_ENTIDAD_027 = ? AND ID_ENTIDAD_027 = ?";
	}

	@Override()
	protected String getWhere(EntidadesGruposTrabajo bean, List<Object> params) {
		StringBuilder where = new StringBuilder(EntidadesGruposTrabajoDaoImpl.STRING_BUILDER_INIT);
		where.append(SqlUtils.generarWhereIgual("NVL(ID_GRUPO_027, 0)", bean.getIdGrupo(), params));
		where.append(SqlUtils.generarWhereIgual("TIPO_ENTIDAD_027", bean.getTipo(), params));
		where.append(SqlUtils.generarWhereIgual("ID_ENTIDAD_027", bean.getCodigo(), params));
		if (bean.getIdGrupo() != null && bean.getIdGrupo() == 0) {
			where.append(SqlUtils.generarWhereIgual(DBConstants.ESTADO, Constants.ALTA, params));
		}
		where.append(SqlUtils.generarWhereIgual("ESTADO_026", bean.getEstadoGrupo(), params));
		return where.toString();
	}

	@Override()
	protected String getWhereLike(EntidadesGruposTrabajo bean, Boolean startsWith, List<Object> params,
			Boolean search) {
		StringBuilder where = new StringBuilder(EntidadesGruposTrabajoDaoImpl.STRING_BUILDER_INIT);
		where.append(SqlUtils.generarWhereIgual("NVL(ID_GRUPO_027, 0)", bean.getIdGrupo(), params));
		where.append(SqlUtils.generarWhereIgual("TIPO_ENTIDAD_027", bean.getTipo(), params));
		where.append(SqlUtils.generarWhereIgual("ID_ENTIDAD_027", bean.getCodigo(), params));
		if (bean.getIdGrupo() != null && bean.getIdGrupo() == 0) {
			where.append(SqlUtils.generarWhereIgual(DBConstants.ESTADO, Constants.ALTA, params));
		}
		where.append(SqlUtils.generarWhereIgual("ESTADO_026", bean.getEstadoGrupo(), params));

		return where.toString();
	}

	@Override()
	public void removeMultiple(EntidadesGruposTrabajo bean, JQGridRequestDto jqGridRequestDto, Boolean startsWith) {
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder(this.getSelect());
		query.append(this.getFrom(bean, params));

		query.append(" WHERE 1 = 1");
		query.append(this.getWhereLike(bean, startsWith, params, false));
		Multiselection multi = jqGridRequestDto.getMultiselection();
		if (multi.getSelectedAll()) {
			query.append(SqlUtils.generarWhereNotIn(this.getPK(), multi.getSelectedIds(), params));
		} else {
			query.append(SqlUtils.generarWhereIn(this.getPK(), multi.getSelectedIds(), params));
		}

		List<EntidadesGruposTrabajo> rdo = this.getJdbcTemplate().query(query.toString(), this.getRwMap(),
				params.toArray());

		List<Object[]> paramDelete = new ArrayList<Object[]>();
		List<Object> aux = new ArrayList<Object>();
		for (EntidadesGruposTrabajo entidad : rdo) {
			aux.clear();
			aux.add(entidad.getIdGrupo());
			aux.add(entidad.getTipo());
			aux.add(entidad.getCodigo());
			paramDelete.add(aux.toArray());
		}
		String delete = "DELETE FROM AA79B27S01 WHERE ID_GRUPO_027=? AND TIPO_ENTIDAD_027 = ? AND ID_ENTIDAD_027 = ?";
		this.getJdbcTemplate().batchUpdate(delete, paramDelete);
	}

	@Override
	public EntidadesGruposTrabajo findEntidad(EntidadesGruposTrabajo entidadesGruposTrabajo) {
		StringBuilder query = new StringBuilder(this.getSelect());
		List<Object> params = new ArrayList<Object>();
		query.append(this.getFrom());
		query.append(DaoConstants.WHERE_1_1);
		query.append(DaoConstants.AND);
		query.append("TIPO = ?");
		query.append(DaoConstants.AND);
		query.append("CODIGO = ?");
		params.add(entidadesGruposTrabajo.getTipo());
		params.add(entidadesGruposTrabajo.getCodigo());
		List<EntidadesGruposTrabajo> entidadList = this.getJdbcTemplate().query(query.toString(), this.rwMap,
				params.toArray());
		return DataAccessUtils.uniqueResult(entidadList);

	}

}
