package com.ejie.aa79b.dao;

import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.dao.support.DataAccessUtils;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.ejie.aa79b.common.DBConstants;
import com.ejie.aa79b.common.DaoConstants;
import com.ejie.aa79b.common.SqlUtils;
import com.ejie.aa79b.model.FasesExpediente;
import com.ejie.aa79b.model.enums.FaseExpedienteEnum;
import com.ejie.aa79b.model.enums.TipoExpedienteEnum;

/**
 * FasesExpedienteDaoImpl generated by UDA, 02-feb-2018 10:27:12.
 * 
 * @author UDA
 */

@Repository
@Transactional
public class FasesExpedienteDaoImpl extends GenericoDaoImpl<FasesExpediente> implements FasesExpedienteDao {

	protected static final String ID_FASES_EXPEDIENTE = "ID_061";
	protected static final String DESC_EU_FASES_EXPEDIENTE = "DESC_EU_061";
	protected static final String DESC_ES_FASES_EXPEDIENTE = "DESC_ES_061";
	protected static final String DESC_ABR_EU_FASES_EXPEDIENTE = "DESC_ABR_EU_061";
	protected static final String DESC_ABR_ES_FASES_EXPEDIENTE = "DESC_ABR_ES_061";
	protected static final String ID_ESTADO_FASES_EXPEDIENTE = "ID_ESTADO_061";

	public static final String[] ORDER_BY_WHITE_LIST = new String[] { ID_FASES_EXPEDIENTE, DESC_EU_FASES_EXPEDIENTE,
			DESC_ES_FASES_EXPEDIENTE, DESC_ABR_ES_FASES_EXPEDIENTE, DESC_ABR_ES_FASES_EXPEDIENTE,
			ID_ESTADO_FASES_EXPEDIENTE, "ESTADOSEXPEDIENTEDESCEU060", "ESTADOSEXPEDIENTEDESCES060",
			"ESTADOSEXPEDIENTEDESCABREU060", "ESTADOSEXPEDIENTEDESCABRES060" };

	public FasesExpedienteDaoImpl() {
		// Constructor
		super(FasesExpediente.class);
	}

	/*
	 * ROW_MAPPERS
	 */
	private RowMapper<FasesExpediente> rwMap = new RowMapper<FasesExpediente>() {
		@Override
		public FasesExpediente mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			FasesExpediente fasesExpediente = new FasesExpediente();
			fasesExpediente.setId(resultSet.getLong(ID_FASES_EXPEDIENTE));
			fasesExpediente.setDescEu(resultSet.getString(DESC_EU_FASES_EXPEDIENTE));
			fasesExpediente.setDescEs(resultSet.getString(DESC_ES_FASES_EXPEDIENTE));
			fasesExpediente.setDescAbrEu(resultSet.getString(DESC_ABR_EU_FASES_EXPEDIENTE));
			fasesExpediente.setDescAbrEs(resultSet.getString(DESC_ABR_ES_FASES_EXPEDIENTE));
			fasesExpediente.setIdEstadosExpediente(resultSet.getLong(ID_ESTADO_FASES_EXPEDIENTE));
			return fasesExpediente;
		}
	};

	private RowMapper<FasesExpediente> rwMapPK = new RowMapper<FasesExpediente>() {
		@Override
		public FasesExpediente mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			return new FasesExpediente(resultSet.getLong("ID061"));
		}
	};

	/*
	 * OPERACIONES CRUD
	 */

	/**
	 * Inserts a single row in the FasesExpediente table.
	 *
	 * @param fasesexpediente FasesExpediente
	 * @return FasesExpediente
	 */
	@Override
	public FasesExpediente add(FasesExpediente fasesexpediente) {
		String query = "INSERT INTO AA79B61S01 (ID_061, ID_ESTADO_061, DESC_EU_061, DESC_ES_061, DESC_ABR_EU_061, DESC_ABR_ES_061) VALUES (?,?,?,?,?,?)";
		this.getJdbcTemplate().update(query, fasesexpediente.getId(), fasesexpediente.getIdEstadosExpediente(),
				fasesexpediente.getDescEu(), fasesexpediente.getDescEs(), fasesexpediente.getDescAbrEu(),
				fasesexpediente.getDescAbrEs());
		return fasesexpediente;
	}

	/**
	 * Updates a single row in the FasesExpediente table.
	 *
	 * @param fasesexpediente FasesExpediente
	 * @return FasesExpediente
	 */
	@Override
	public FasesExpediente update(FasesExpediente fasesexpediente) {
		String query = "UPDATE AA79B61S01 SET ID_ESTADO_061=?, DESC_EU_061=?, DESC_ES_061=?, DESC_ABR_EU_061=?, DESC_ABR_ES_061=? WHERE ID_061=?";
		this.getJdbcTemplate().update(query, fasesexpediente.getIdEstadosExpediente(), fasesexpediente.getDescEu(),
				fasesexpediente.getDescEs(), fasesexpediente.getDescAbrEu(), fasesexpediente.getDescAbrEs(),
				fasesexpediente.getId());
		return fasesexpediente;
	}

	/**
	 * Finds a single row in the FasesExpediente table.
	 *
	 * @param fasesexpediente FasesExpediente
	 * @return FasesExpediente
	 */
	@Override
	@Transactional(readOnly = true)
	public FasesExpediente find(FasesExpediente fasesexpediente) {
		String query = "SELECT t1.ID_061 ID061, t1.DESC_EU_061 DESCEU061, t1.DESC_ES_061 DESCES061, t1.DESC_ABR_EU_061 DESCABREU061, t1.DESC_ABR_ES_061 DESCABRES061, t2.ID_060 ESTADOSEXPEDIENTEID060, t2.DESC_EU_060 ESTADOSEXPEDIENTEDESCEU060, t2.DESC_ES_060 ESTADOSEXPEDIENTEDESCES060, t2.DESC_ABR_EU_060 ESTADOSEXPEDIENTEDESCABREU060, t2.DESC_ABR_ES_060 ESTADOSEXPEDIENTEDESCABRES060, t2.CLASS_060 ESTADOSEXPEDIENTECLASS FROM AA79B61S01 t1 , ESTADOS_EXPEDIENTE t2  WHERE t1.ID_061 = ?   AND t1.ID_ESTADO_061= t2.ID_060(+)";

		List<FasesExpediente> fasesexpedienteList = this.getJdbcTemplate().query(query, this.rwMap,
				fasesexpediente.getId());
		return DataAccessUtils.uniqueResult(fasesexpedienteList);
	}

	/**
	 * Removes a single row in the FasesExpediente table.
	 *
	 * @param fasesexpediente FasesExpediente
	 * @return
	 */
	@Override
	public void remove(FasesExpediente fasesexpediente) {
		String query = "DELETE FROM AA79B61S01 WHERE ID_061=?";
		this.getJdbcTemplate().update(query, fasesexpediente.getId());
	}

	@Override
	protected String getSelect() {

		StringBuilder sbFase = new StringBuilder();

		sbFase.append("SELECT t1.ID_061 ID_061");
		sbFase.append(", t1.DESC_EU_061 DESC_EU_061");
		sbFase.append(", t1.DESC_ES_061 DESC_ES_061");
		sbFase.append(", t1.DESC_ABR_EU_061 DESC_ABR_EU_061");
		sbFase.append(", t1.DESC_ABR_ES_061 DESC_ABR_ES_061");
		sbFase.append(", t1.ID_ESTADO_061 ID_ESTADO_061");

		sbFase.append(", ").append(SqlUtils.normalizarCampoSql("t1.DESC_EU_061")).append(" AS DESCNORMEU");
		sbFase.append(", ").append(SqlUtils.normalizarCampoSql("t1.DESC_ES_061")).append(" AS DESCNORMES");
		sbFase.append(", ").append(SqlUtils.normalizarCampoSql("t1.DESC_ABR_EU_061")).append(" AS DESCNORMABREU");
		sbFase.append(", ").append(SqlUtils.normalizarCampoSql("t1.DESC_ABR_ES_061")).append(" AS DESCNORMABRES");

		return sbFase.toString();
	}

	@Override
	protected String getFrom() {
		return " FROM AA79B61S01 t1 ";
	}

	@Override
	protected RowMapper<FasesExpediente> getRwMap() {
		return this.rwMap;
	}

	@Override
	protected String[] getOrderBy() {
		return EstadosExpedienteDaoImpl.ORDER_BY_WHITE_LIST;
	}

	@Override
	protected String getPK() {
		return ID_ESTADO_FASES_EXPEDIENTE;
	}

	@Override
	protected RowMapper<FasesExpediente> getRwMapPK() {
		return this.rwMapPK;
	}

	@Override
	protected String getWherePK(FasesExpediente bean, List<Object> params) {
		params.add(bean.getId());
		return " WHERE t1.ID_061 = ?";
	}

	@Override
	protected String getWhere(FasesExpediente bean, List<Object> params) {
		StringBuilder where = new StringBuilder(FasesExpedienteDaoImpl.STRING_BUILDER_INIT);
		where.append(SqlUtils.generarWhereIgual("t1.ID_061", bean.getId(), params));
		where.append(SqlUtils.generarWhereLikeNormalizado("t1.DESC_ES_061", bean.getDescEs(), params, false));
		where.append(SqlUtils.generarWhereLikeNormalizado("t1.DESC_EU_061", bean.getDescEu(), params, false));
		where.append(SqlUtils.generarWhereLikeNormalizado("t1.DESC_ABR_ES_061", bean.getDescEs(), params, false));
		where.append(SqlUtils.generarWhereLikeNormalizado("t1.DESC_ABR_EU_061", bean.getDescEu(), params, false));
		where.append(SqlUtils.generarWhereIgual("t1.ID_ESTADO_061", bean.getIdEstadosExpediente(), params));

		Map<String, Object> mapWhere = new HashMap<String, Object>();
		mapWhere.put("query", where);
		mapWhere.put("params", params);

		return where.toString();
	}

	@Override
	protected String getWhereLike(FasesExpediente bean, Boolean startsWith, List<Object> params, Boolean search) {
		StringBuilder where = new StringBuilder(FasesExpedienteDaoImpl.STRING_BUILDER_INIT);
		where.append(SqlUtils.generarWhereIgual("t1.ID_061", bean.getId(), params));
		where.append(SqlUtils.generarWhereLikeNormalizado("t1.DESC_ES_061", bean.getDescEs(), params, startsWith));
		where.append(SqlUtils.generarWhereLikeNormalizado("t1.DESC_EU_061", bean.getDescEu(), params, startsWith));
		where.append(SqlUtils.generarWhereLikeNormalizado("t1.DESC_ABR_ES_061", bean.getDescEs(), params, startsWith));
		where.append(SqlUtils.generarWhereLikeNormalizado("t1.DESC_ABR_EU_061", bean.getDescEu(), params, startsWith));
		where.append(SqlUtils.generarWhereIgual("t1.ID_ESTADO_061", bean.getIdEstadosExpediente(), params));

		Map<String, Object> mapWhere = new HashMap<String, Object>();
		mapWhere.put("query", where);
		mapWhere.put("params", params);

		return where.toString();
	}

	@Override()
	public List<FasesExpediente> findAllCambioEstadoExp(FasesExpediente bean, String tipoExpediente) {
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder(this.getSelect());
		query.append(this.getFrom());
		query.append(FasesExpedienteDaoImpl.DEFAULT_WHERE);
		query.append(DaoConstants.AND + DaoConstants.T1_MINUSCULA_PUNTO + DBConstants.ID_061
				+ DaoConstants.SIGNO_DISTINTO + FaseExpedienteEnum.ALTA.getValue());
		query.append(DaoConstants.AND + DaoConstants.T1_MINUSCULA_PUNTO + DBConstants.ID_061
				+ DaoConstants.SIGNO_DISTINTO + FaseExpedienteEnum.PDTE_TRAM_CLIENTE.getValue());
		query.append(DaoConstants.AND + DaoConstants.T1_MINUSCULA_PUNTO + DBConstants.ID_061
				+ DaoConstants.SIGNO_DISTINTO + FaseExpedienteEnum.PDTE_TRAM_SUBSANACION.getValue());
		query.append(DaoConstants.AND + DaoConstants.T1_MINUSCULA_PUNTO + DBConstants.ID_061
				+ DaoConstants.SIGNO_DISTINTO + FaseExpedienteEnum.PDTE_PROYECTO_TRADOS.getValue());
		query.append(DaoConstants.AND + DaoConstants.T1_MINUSCULA_PUNTO + DBConstants.ID_061
				+ DaoConstants.SIGNO_DISTINTO + FaseExpedienteEnum.PENDIENTE_ESTUDIO.getValue());
		if (TipoExpedienteEnum.INTERPRETACION.getValue().equals(tipoExpediente)) {
			query.append(DaoConstants.AND + DaoConstants.T1_MINUSCULA_PUNTO + DBConstants.ID_061
					+ DaoConstants.SIGNO_DISTINTO + FaseExpedienteEnum.PDTE_REV_FACTURACION.getValue());
		}

		query.append(this.getWhere(bean, params));

		return this.getJdbcTemplate().query(query.toString(), this.getRwMap(), params.toArray());
	}

	@Override
	public List<FasesExpediente> getFasesExpedientePlanificacion(List<Integer> listaEstados) {
		StringBuilder query = new StringBuilder(this.getSelect());
		query.append(this.getFrom());
		if (listaEstados != null && !listaEstados.isEmpty()) {
			query.append(DaoConstants.WHERE + DaoConstants.T1_MINUSCULA_PUNTO + DBConstants.ID_ESTADO_061
					+ DaoConstants.IN + DaoConstants.ABRIR_PARENTESIS);
			boolean esPrimero = true;
			for (Integer estado : listaEstados) {
				if (esPrimero) {
					esPrimero = false;
				} else {
					query.append(DaoConstants.SIGNO_COMA);
				}
				query.append(estado);
			}
			query.append(DaoConstants.CERRAR_PARENTESIS);
		}
		query.append(" ORDER BY t1.ID_061");
		return this.getJdbcTemplate().query(query.toString(), this.getRwMap());
	}

}
