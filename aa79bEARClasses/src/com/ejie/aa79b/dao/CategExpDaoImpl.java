package com.ejie.aa79b.dao;

import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

import org.springframework.dao.support.DataAccessUtils;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.common.DBConstants;
import com.ejie.aa79b.common.DaoConstants;
import com.ejie.aa79b.common.SqlUtils;
import com.ejie.aa79b.model.CategExp;
import com.ejie.aa79b.model.Expediente;
import com.ejie.aa79b.model.ListaCategExp;
import com.ejie.aa79b.model.ListaExpediente;
import com.ejie.aa79b.model.MetadatosBusqueda;
import com.ejie.aa79b.model.MetadatosExpedientes;
import com.ejie.aa79b.utils.ConsultaExpedienteUtils;

/**
 * CategExpDaoImpl generated by UDA, 08-mar-2018 10:51:54.
 *
 * @author UDA
 */

@Repository
@Transactional
public class CategExpDaoImpl extends GenericoDaoImpl<CategExp> implements CategExpDao {

	public CategExpDaoImpl() {
		// Constructor
		super(CategExp.class);
	}

	protected static final String IDMETADATO_CATEG_EXP = "IDMETADATO";
	public static final String[] ORDER_BY_WHITE_LIST = new String[] { DBConstants.ANYO, DBConstants.NUMEXP,
			IDMETADATO_CATEG_EXP, "DESCMETADATOEU" };

	/*
	 * ROW_MAPPERS
	 */
	private RowMapper<CategExp> rwMap = new RowMapper<CategExp>() {
		@Override
		public CategExp mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			CategExp categExp = new CategExp();
			categExp.setAnyo(resultSet.getLong(DBConstants.ANYO));
			categExp.setNumExp(resultSet.getInt(DBConstants.NUMEXP));
			categExp.setIdMetadato(resultSet.getLong(IDMETADATO_CATEG_EXP));

			MetadatosBusqueda metadato = new MetadatosBusqueda();
			metadato.setId(resultSet.getLong(IDMETADATO_CATEG_EXP));
			metadato.setDescEs(resultSet.getString("DESCMETADATOES"));
			metadato.setDescEu(resultSet.getString("DESCMETADATOEU"));
			metadato.setEstado(resultSet.getString("ESTADO"));
			categExp.setMetadato(metadato);

			return categExp;
		}
	};

	private RowMapper<CategExp> rwMapPK = new RowMapper<CategExp>() {
		@Override
		public CategExp mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			CategExp categExp = new CategExp();
			categExp.setAnyo(resultSet.getLong(DBConstants.ANYO));
			categExp.setNumExp(resultSet.getInt(DBConstants.NUMEXP));
			categExp.setIdMetadato(resultSet.getLong(IDMETADATO_CATEG_EXP));

			return categExp;
		}
	};

	/*
	 * OPERACIONES CRUD
	 */

	/**
	 * Inserts a single row in the CategExp table.
	 *
	 * @param categexp
	 *            CategExp
	 * @return CategExp
	 */
	@Override
	public CategExp add(CategExp categexp) {
		StringBuilder insert = new StringBuilder();
		insert.append("INSERT INTO AA79B62S01 ");
		insert.append("(ANYO_062, NUM_EXP_062, ID_METADATO_062) ");
		insert.append("VALUES (?,?,?)");
		this.getJdbcTemplate().update(insert.toString(), categexp.getAnyo(), categexp.getNumExp(),
				categexp.getIdMetadato());
		return categexp;
	}

	/**
	 * Updates a single row in the CategExp table.
	 *
	 * @param categexp
	 *            CategExp
	 * @return CategExp
	 */
	@Override
	public CategExp update(CategExp categexp) {
		String query = "UPDATE AA79B62S01 SET  WHERE ANYO_062=? AND NUM_EXP_062=? AND ID_METADATO_062=?";
		this.getJdbcTemplate().update(query, categexp.getAnyo(), categexp.getNumExp(), categexp.getIdMetadato());
		return categexp;
	}

	/**
	 * Finds a single row in the CategExp table.
	 *
	 * @param categexp
	 *            CategExp
	 * @return CategExp
	 */
	@Override
	@Transactional(readOnly = true)
	public CategExp find(CategExp categexp) {
		String query = "SELECT t1.ANYO_062 ANYO062, t1.NUM_EXP_062 NUMEXP062, t1.ID_METADATO_062 IDMETADATO062 FROM AA79B62S01 t1  WHERE t1.ANYO_062 = ?   AND t1.NUM_EXP_062 = ?   AND t1.ID_METADATO_062 = ?  ";

		List<CategExp> categexpList = this.getJdbcTemplate().query(query, this.rwMap, categexp.getAnyo(),
				categexp.getNumExp(), categexp.getIdMetadato());
		return DataAccessUtils.uniqueResult(categexpList);
	}

	/**
	 * Removes a single row in the CategExp table.
	 *
	 * @param categexp
	 *            CategExp
	 * @return
	 */
	@Override
	public void remove(CategExp categexp) {
		String query = "DELETE FROM AA79B62S01 WHERE ANYO_062=? AND NUM_EXP_062=? AND ID_METADATO_062=?";
		this.getJdbcTemplate().update(query, categexp.getAnyo(), categexp.getNumExp(), categexp.getIdMetadato());
	}

	@Override
	protected String getSelect() {
		StringBuilder select = new StringBuilder();
		select.append("SELECT ");
		select.append("ANYO_062 ANYO");
		select.append(", NUM_EXP_062 NUMEXP");
		select.append(", ID_019 IDMETADATO, DESC_ES_019 DESCMETADATOES, DESC_EU_019 DESCMETADATOEU, ESTADO_019 ESTADO");
		return select.toString();
	}

	@Override
	protected String getFrom() {
		StringBuilder from = new StringBuilder();
		from.append(" FROM AA79B62S01 JOIN AA79B19S01 ON ID_METADATO_062 = ID_019");
		return from.toString();
	}

	@Override
	protected RowMapper<CategExp> getRwMap() {
		return this.rwMap;
	}

	@Override
	protected String[] getOrderBy() {
		return CategExpDaoImpl.ORDER_BY_WHITE_LIST;
	}

	@Override
	protected String getPK() {
		return "ANYO,NUMEXP,IDMETADATO";
	}

	@Override
	protected RowMapper<CategExp> getRwMapPK() {
		return this.rwMapPK;
	}

	@Override
	protected String getWherePK(CategExp bean, List<Object> params) {
		params.add(bean.getAnyo());
		params.add(bean.getNumExp());
		params.add(bean.getIdMetadato());
		return " WHERE ANYO = ? AND NUMEXP = ? AND IDMETADATO = ?";
	}

	@Override
	protected String getWhere(CategExp bean, List<Object> params) {
		StringBuilder where = new StringBuilder();
		where.append(SqlUtils.generarWhereIgual("ANYO_062", bean.getAnyo(), params));
		where.append(SqlUtils.generarWhereIgual("NUM_EXP_062", bean.getNumExp(), params));
		where.append(SqlUtils.generarWhereIgual("ID_METADATO_062", bean.getIdMetadato(), params));

		return where.toString();
	}

	@Override
	protected String getWhereLike(CategExp bean, Boolean startsWith, List<Object> params, Boolean search) {
		StringBuilder where = new StringBuilder();
		where.append(SqlUtils.generarWhereIgual("ANYO_062", bean.getAnyo(), params));
		where.append(SqlUtils.generarWhereIgual("NUM_EXP_062", bean.getNumExp(), params));
		where.append(SqlUtils.generarWhereIgual("ID_METADATO_062", bean.getIdMetadato(), params));

		return where.toString();
	}

	@Override
	public Long comprobarSiExiste(CategExp categExp) {
		StringBuilder query = new StringBuilder();
		List<Object> params = new ArrayList<Object>();
		query.append("SELECT COUNT(1) ");
		query.append(" FROM AA79B62S01 ");
		query.append(DaoConstants.WHERE_1_1);
		if (categExp != null && categExp.getAnyo() != null && categExp.getNumExp() != null
				&& categExp.getIdMetadato() != null) {
			query.append(SqlUtils.generarWhereIgual("ANYO_062", categExp.getAnyo(), params));
			query.append(SqlUtils.generarWhereIgual("NUM_EXP_062", categExp.getNumExp(), params));
			query.append(SqlUtils.generarWhereIgual("ID_METADATO_062", categExp.getIdMetadato(), params));
			return this.getJdbcTemplate().queryForObject(query.toString(), params.toArray(), Long.class);
		} else {
			return -1L;
		}
	}

	@Override
	public Integer eliminarAllCategExp(CategExp categExpFilter) {
		StringBuilder delete = new StringBuilder();
		delete.append("DELETE");
		delete.append(" FROM AA79B62S01 ");
		delete.append(" WHERE ANYO_062 = ? AND NUM_EXP_062 = ?");
		return this.getJdbcTemplate().update(delete.toString(), categExpFilter.getAnyo(), categExpFilter.getNumExp());

	}

	@Override
	public Integer eliminarMetadatosDeExpedientes(ListaExpediente listaExpedientes) {
		StringBuilder delete = new StringBuilder(CategExpDaoImpl.STRING_BUILDER_INIT);
		List<Object> params = new ArrayList<Object>();
		if (ConsultaExpedienteUtils.listaExpedientesValida(listaExpedientes)) {
			delete.append(DaoConstants.DELETE + DaoConstants.FROM + DBConstants.TABLA_62 + DaoConstants.WHERE);
			boolean esPrimero = true;
			for (Expediente expediente : listaExpedientes.getListaExpediente()) {
				if (esPrimero) {
					esPrimero = false;
				} else {
					delete.append(DaoConstants.OR);
				}
				delete.append(
						DaoConstants.ABRIR_PARENTESIS + DBConstants.ANYO_062 + DaoConstants.SIGNOIGUAL_INTERROGACION);
				delete.append(DaoConstants.AND + DBConstants.NUM_EXP_062 + DaoConstants.SIGNOIGUAL_INTERROGACION
						+ DaoConstants.CERRAR_PARENTESIS);
				params.add(expediente.getAnyo());
				params.add(expediente.getNumExp());
			}
			return this.getJdbcTemplate().update(delete.toString(), params.toArray());
		}
		return Constants.CERO;
	}

	@Override
	public Integer eliminarMetadatosSeleccionadosDeExpedientes(MetadatosExpedientes metadatosExpedientes) {
		ListaExpediente listaExpedientes = metadatosExpedientes.getListaExpedientes();
		ListaCategExp listaMetadatos = metadatosExpedientes.getListaMetadatos();


		StringBuilder delete = new StringBuilder(CategExpDaoImpl.STRING_BUILDER_INIT);
		List<Object> params = new ArrayList<Object>();
		if (ConsultaExpedienteUtils.listaExpedientesValida(listaExpedientes)) {
			delete.append(DaoConstants.DELETE + DaoConstants.FROM + DBConstants.TABLA_62 + DaoConstants.WHERE);
			boolean esPrimero = true;
			delete.append(
					DaoConstants.ABRIR_PARENTESIS);
			for (Expediente expediente : listaExpedientes.getListaExpediente()) {
				if (esPrimero) {
					esPrimero = false;
				} else {
					delete.append(DaoConstants.OR);
				}
				delete.append(
						DaoConstants.ABRIR_PARENTESIS + DBConstants.ANYO_062 + DaoConstants.SIGNOIGUAL_INTERROGACION);
				delete.append(DaoConstants.AND + DBConstants.NUM_EXP_062 + DaoConstants.SIGNOIGUAL_INTERROGACION
						+ DaoConstants.CERRAR_PARENTESIS);
				params.add(expediente.getAnyo());
				params.add(expediente.getNumExp());
			}
			delete.append(
					DaoConstants.CERRAR_PARENTESIS);
			delete.append(DaoConstants.AND);
			delete.append(
					DaoConstants.ABRIR_PARENTESIS);
			esPrimero = true;
			for (CategExp metadato : listaMetadatos.getListaCategExp()) {
				if (esPrimero) {
					esPrimero = false;
				} else {
					delete.append(DaoConstants.OR);
				}
				delete.append(
						DaoConstants.ABRIR_PARENTESIS + DBConstants.ID_METADATO_062 + DaoConstants.SIGNOIGUAL_INTERROGACION	+ DaoConstants.CERRAR_PARENTESIS);
				params.add(metadato.getIdMetadato());
			}
			delete.append(
					DaoConstants.CERRAR_PARENTESIS);
			return this.getJdbcTemplate().update(delete.toString(), params.toArray());
		}
		return Constants.CERO;
	}

	@Override
	public Integer guardarYOEliminarMetadatos(MetadatosExpedientes metadatosExpedientes) {
		StringBuilder insertMult = new StringBuilder(CategExpDaoImpl.STRING_BUILDER_INIT);
		final List<Object[]> params = new ArrayList<Object[]>();
		final List<Object> aux = new ArrayList<Object>();
		if (metadatosExpedientes != null
				&& ConsultaExpedienteUtils.listaExpedientesValida(metadatosExpedientes.getListaExpedientes())
				&& ConsultaExpedienteUtils.listaMetadatosValida(metadatosExpedientes.getListaMetadatos())) {
			insertMult.append(DaoConstants.INSERT_INTO + DBConstants.TABLA_62 + DaoConstants.ABRIR_PARENTESIS);
			insertMult.append(
					DBConstants.ANYO_062 + DaoConstants.SIGNO_COMA + DBConstants.NUM_EXP_062 + DaoConstants.SIGNO_COMA);
			insertMult.append(DBConstants.ID_METADATO_062 + DaoConstants.CERRAR_PARENTESIS);
			insertMult.append(" VALUES (?,?,?)");

			for (CategExp metadato : metadatosExpedientes.getListaMetadatos().getListaCategExp()) {
				for (Expediente expediente : metadatosExpedientes.getListaExpedientes().getListaExpediente()) {
					aux.clear();
					aux.add(expediente.getAnyo());
					aux.add(expediente.getNumExp());
					aux.add(metadato.getIdMetadato());
					params.add(aux.toArray());
				}
			}
			this.getJdbcTemplate().batchUpdate(insertMult.toString(), params);
			return metadatosExpedientes.getListaMetadatos().getListaCategExp().size();
		}
		return Constants.CERO;
	}

}
