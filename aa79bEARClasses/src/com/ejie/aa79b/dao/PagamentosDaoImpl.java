package com.ejie.aa79b.dao;

import java.math.BigDecimal;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;
import java.util.Locale;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.i18n.LocaleContextHolder;
import org.springframework.context.support.ReloadableResourceBundleMessageSource;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.common.DBConstants;
import com.ejie.aa79b.common.DaoConstants;
import com.ejie.aa79b.common.SqlUtils;
import com.ejie.aa79b.dao.mapper.DatosPagoProveedorTareaExcelRowMapper;
import com.ejie.aa79b.dao.mapper.DatosPagoProveedorTareaRowMapper;
import com.ejie.aa79b.dao.mapper.PagamentosRowMapper;
import com.ejie.aa79b.model.Albaran;
import com.ejie.aa79b.model.DatosPagoProveedores;
import com.ejie.aa79b.model.Pagamentos;
import com.ejie.aa79b.model.enums.EstadoAlbaranEnum;
import com.ejie.aa79b.model.enums.EstadoEjecucionTareaEnum;
import com.ejie.aa79b.model.enums.TipoTareaGestionAsociadaEnum;
import com.ejie.aa79b.utils.DAOUtils;
import com.ejie.aa79b.utils.Utils;
import com.ejie.x38.dto.JQGridRequestDto;

/**
 * PagamentosDaoImpl generated by UDA, 19/out/2018 10:01:21.
 *
 * @author UDA
 */

@Repository
@Transactional
public class PagamentosDaoImpl extends GenericoDaoImpl<Pagamentos> implements PagamentosDao {

	@Autowired()
	private ReloadableResourceBundleMessageSource appMessageSource;

	protected static final String CODENTIDAD = "ID_EMPRESA_PROV_029";
	protected static final String IDLOTE = "ID_LOTE_029";
	protected static final String IDALBARAN = "ID_099";
	protected static final String REFALBARAN = "REF_ALBARAN_099";
	protected static final String FECHAALTA = "FECHA_ALTA_099";
	protected static final String NTAREAS = "ID_TAREA_081";
	protected static final String NEXPEDIENTES = "NUM_EXP_053";
	protected static final String IMPORTETOTAL = "IMPORTE_TOTAL_094";
	protected static final String ESTADOALBARAN = "ESTADO_099";
	protected static final String IMPORTEFACTURA = "IMPORTE_FACTURA_099";

	protected static final String TAREAFACT = "tareaFact";
	protected static final String TAREAREVPAGO = "tareaRevPago";
	protected static final String EJECUCIONTAREA = "ejecucionTarea";
	protected static final String PAGOPROVEEDOR = "pagoProveedor";
	protected static final String TIPOSTAREA = "tiposTarea";
	protected static final String ALBARAN = "albaran";
	protected static final String PUNTO_IND_ALBARAN_094_IGUAL = ".IND_ALBARAN_094 = '";
	protected static final String PUNTO_ESTADO_EJECUCION_081_IGUAL = ".ESTADO_EJECUCION_081 = ";
	protected static final String PUNTO_ID_TAREA_081_IGUAL = ".ID_TAREA_081 = ";
	protected static final String IND_ALBARAN = "IND_ALBARAN_094";
	protected static final String ID_LOTE_081_IGUAL_INTERROG = " TAREAFACT.ID_LOTE_081 = ? ";
	protected static final String IND_FACTURABLE_IGUAL = " tareafact.IND_FACTURABLE_081 = '";
	protected static final String IND_PAGADO = "IND_PAGADO_094";
	protected static final String ESTADO_EJECUCION = "TAREAFACT.ESTADO_EJECUCION_081";
	protected static final String ACTIVO_ENUM = "ActivoEnum";

	public static final String[] ORDER_BY_WHITE_LIST = new String[] { "IDALBARAN", "REFALBARAN", "FECHAALTA", "NTAREAS",
			"NEXPEDIENTES", "IMPORTETOTAL", "ESTADOALBARAN", "IMPORTEFACTURA", "REFALBARANNORMES", "REFALBARANNORMEU",
			"DESCESTADOALBARAN", "REFALBARANNORM", "ANYONUMEXPCONCATENADO" };

	private RowMapper<Pagamentos> rwMap = new PagamentosRowMapper();

	private RowMapper<Pagamentos> rwMapPK = new RowMapper<Pagamentos>() {
		@Override
		public Pagamentos mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			Pagamentos bean = new Pagamentos();
			bean.setIdAlbaran(resultSet.getInt(DBConstants.IDALBARAN));
			return bean;
		}
	};

	private RowMapper<Albaran> rwMapAlbaranCombo = new RowMapper<Albaran>() {
		@Override
		public Albaran mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			Albaran albaran = new Albaran();
			albaran.setIdAlbaran(resultSet.getBigDecimal("ID"));
			albaran.setRefAlbaran(resultSet.getString("REFALBARAN"));
			return albaran;
		}
	};

	public PagamentosDaoImpl() {
		/* Constructor */
		super(Pagamentos.class);
	}

	/*
	 * OPERACIONES CRUD
	 */

	@Override()
	protected String getSelect() {

		StringBuilder query = new StringBuilder();
		Locale locale = LocaleContextHolder.getLocale();
		String desc = this.appMessageSource.getMessage("label.pendientealbaran", null, locale);

		query.append(DaoConstants.SELECT)
				.append(" 0 CODENTIDAD,ID_LOTE_099 IDLOTE, ID_099 IDALBARAN, COALESCE(REF_ALBARAN_099, '" + desc
						+ "') AS REFALBARAN, FECHA_ALTA_099 FECHAALTA, ");

		query.append(" COALESCE(").append(SqlUtils.normalizarCampoSql("REF_ALBARAN_099"))
				.append(", '" + desc + "') AS REFALBARANNORM, ");

		query.append(DaoConstants.TO_CHAR + DaoConstants.ABRIR_PARENTESIS + "FECHA_ALTA_099" + DaoConstants.SIGNO_COMA
				+ DaoConstants.FORMATO_HORA + DaoConstants.CERRAR_PARENTESIS);
		query.append(DaoConstants.BLANK + DBConstants.HORAALTA);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.COUNT + "(tareaFact.ID_TAREA_081) NTAREAS, " + DaoConstants.COUNT
				+ DaoConstants.ABRIR_PARENTESIS + DaoConstants.DISTINCT + DaoConstants.ABRIR_PARENTESIS
				+ "SUBSTR (tareafact.ANYO_081, 2, 4)||LPAD (tareafact.NUM_EXP_081, 6, '0' ))) NEXPEDIENTES,");
		query.append(DaoConstants.SUM + DaoConstants.ABRIR_PARENTESIS + DaoConstants.NVL + DaoConstants.ABRIR_PARENTESIS
				+ " IMPORTE_TOTAL_094," + Constants.CERO
				+ ")) IMPORTETOTAL,ESTADO_099 ESTADOALBARAN, NVL(IMPORTE_FACTURA_099,0) IMPORTEFACTURA, ");

		query.append("   '' NOMBRE_LOTE, 0 IMPORTE_ASIGNADO, 0 IMPORTE_CONSUMIDO ");
		query.append(", DECODE(ESTADO_099, NULL, '"
				+ this.appMessageSource.getMessage(EstadoAlbaranEnum.PENDIENTE_ASOCIAR_ALBARAN.getLabel(), null, locale)
				+ "',");
		query.append("'" + EstadoAlbaranEnum.PENDIENTE_ENVIAR_IZO.getValue() + "', '"
				+ this.appMessageSource.getMessage(EstadoAlbaranEnum.PENDIENTE_ENVIAR_IZO.getLabel(), null, locale) + "',");
		query.append("'" + EstadoAlbaranEnum.ENVIADO_IZO.getValue() + "', '"
				+ this.appMessageSource.getMessage(EstadoAlbaranEnum.ENVIADO_IZO.getLabel(), null, locale) + "',");
		query.append("'" + EstadoAlbaranEnum.PAGADO.getValue() + "', '"
				+ this.appMessageSource.getMessage(EstadoAlbaranEnum.PAGADO.getLabel(), null, locale)
				+ "') AS DESCESTADOALBARAN");

		return query.toString();
	}

	private RowMapper<DatosPagoProveedores> rwMapTarea = new DatosPagoProveedorTareaRowMapper();
	private RowMapper<DatosPagoProveedores> rwMapTareaExcel = new DatosPagoProveedorTareaExcelRowMapper();

	@Override()
	protected RowMapper<Pagamentos> getRwMapPK() {
		return this.rwMapPK;
	}
	/*
	 * OPERACIONES CRUD
	 */

	/**
	 * Mét odo para buscar las tareas para generar el excel del detalle de albaranes
	 * y pago a proveedor
	 */
	@Override
	public List<DatosPagoProveedores> getTareasExcelDetalle(Pagamentos filterPagamentos) {

		List<Object> params = new ArrayList<Object>();
		StringBuilder select = new StringBuilder(PagamentosDaoImpl.STRING_BUILDER_INIT);

		select.append(DaoConstants.SELECT);
		select.append(getSelectTablaTareas());

		select.append(
				" , X54P.DESC_ES, X54P.DESC_EU, LOTES.NOMBRE_LOTE_029, AA79B09S01.DESC_IDIOMA_EU_009, AA79B09S01.DESC_IDIOMA_ES_009, AA79B53T00.IND_PUBLICAR_BOPV_053, TAREAFACT.ANYO_081, TAREAFACT.NUM_EXP_081,IND_ALBARAN_094, ");
		select.append(" REF_ALBARAN_099,FECHA_ALTA_099, ESTADO_099, ID_099 ");

		select.append(getFrom());

		select.append(DaoConstants.LEFT_JOIN + DBConstants.TABLA_15 + DaoConstants.ON
				+ " TAREAFACT.ID_TIPO_TAREA_081 = ID_015 ");

		params.add(filterPagamentos.getIdLote());

		select.append(" INNER JOIN AA79B29S01 LOTES ON TAREAFACT.ID_LOTE_081 = LOTES.ID_LOTE_029 ");
		select.append(
				" INNER JOIN X54JAPI_ENTIDADES_SOLIC X54P ON LOTES.ID_EMPRESA_PROV_029 = X54P.CODIGO AND LOTES.TIPO_ENTIDAD_029 = X54P.TIPO ");
		select.append(" INNER JOIN AA79B09S01 ON LOTES.ID_IDIOMA_DESTINO_029 = AA79B09S01.ID_IDIOMA_009 ");
		select.append(
				" INNER JOIN AA79B53T00 ON TAREAFACT.ANYO_081 = AA79B53T00.ANYO_053 AND TAREAFACT.NUM_EXP_081 = AA79B53T00.NUM_EXP_053 ");

		select.append(DaoConstants.WHERE_1_1);
		select.append(DaoConstants.AND + IND_FACTURABLE_IGUAL + Constants.SI + "' ");
		select.append(DaoConstants.AND + ID_LOTE_081_IGUAL_INTERROG);
		params.add(filterPagamentos.getIdLote());

		select.append(SqlUtils.generarWhereIgual(IND_ALBARAN, filterPagamentos.getAsociableAlbaran(), params));
		select.append(SqlUtils.generarWhereIgual(IND_PAGADO, filterPagamentos.getIndPagado(), params));
		select.append(SqlUtils.generarWhereIgual(ESTADO_EJECUCION, filterPagamentos.getIdEstadoTarea(), params));

		if (filterPagamentos.getIdAlbaran() != null && Constants.CERO != filterPagamentos.getIdAlbaran().intValue()) {
			select.append(DaoConstants.AND + " COD_ALBARAN_094 = ? ");
			params.add(filterPagamentos.getIdAlbaran());
		} else {
			// Tareas PENDIENTES DE ALBARÁN
			select.append(DaoConstants.AND + " COD_ALBARAN_094 IS NULL ");
		}
		return this.getJdbcTemplate().query(select.toString(), this.rwMapTareaExcel, params.toArray());

	}

	@Override
	public Boolean updateEstado(BigDecimal idAlb, Integer idEstado) {
		int res = 0;

		String query = "UPDATE AA79B99T00 SET REF_FACTURA_099='', IMPORTE_FACTURA_099='', ESTADO_099=? WHERE ID_099=? ";
		res = this.getJdbcTemplate().update(query, idEstado, idAlb);

		return res > 0;

	}

	@Override
	public Boolean updateInfoAlbaran(BigDecimal idAlb, String referencia, BigDecimal valor) {
		int res = 0;

		String query = "UPDATE AA79B99T00 SET REF_FACTURA_099=?, IMPORTE_FACTURA_099=?, ESTADO_099=? WHERE ID_099=? ";
		res = this.getJdbcTemplate().update(query, referencia, valor, EstadoAlbaranEnum.PAGADO.getValue(), idAlb);

		return res > 0;

	}

	@Override
	public Boolean updateIndPagadoTareasAlbaran(BigDecimal idAlb, String indPagado) {
		int res = 0;

		String query = "UPDATE AA79B94S01 SET IND_PAGADO_094=? WHERE COD_ALBARAN_094=? ";
		res = this.getJdbcTemplate().update(query, indPagado, idAlb);
		return res > 0;

	}

	@Override
	protected String getFrom() {
		StringBuilder elFrom = new StringBuilder();
		elFrom.append(DaoConstants.FROM + DBConstants.TABLA_81 + DaoConstants.BLANK + TAREAFACT);

		elFrom.append(DaoConstants.JOIN + DBConstants.TABLA_81);
		elFrom.append(DaoConstants.BLANK);
		elFrom.append(TAREAREVPAGO + DaoConstants.ON);
		elFrom.append(TAREAREVPAGO + ".ID_TIPO_TAREA_081 = "
				+ TipoTareaGestionAsociadaEnum.REVISION_PAGO_PROVEEDOR.getValue());
		elFrom.append(DaoConstants.BLANK);
		elFrom.append(DaoConstants.AND);
		elFrom.append(DaoConstants.BLANK);
		elFrom.append(TAREAFACT + PUNTO_ID_TAREA_081_IGUAL + TAREAREVPAGO + ".ID_TAREA_REL_081");

		elFrom.append(DaoConstants.JOIN + DBConstants.TABLA_94);
		elFrom.append(DaoConstants.BLANK);
		elFrom.append(PAGOPROVEEDOR + DaoConstants.ON);
		elFrom.append(TAREAREVPAGO + PUNTO_ID_TAREA_081_IGUAL + PAGOPROVEEDOR + ".ID_TAREA_094");
		// no está IND_PAGADO. Para el Filter

		elFrom.append(DaoConstants.LEFT_JOIN + DBConstants.TABLA_99);
		elFrom.append(DaoConstants.BLANK);
		elFrom.append(ALBARAN + DaoConstants.ON);
		elFrom.append(PAGOPROVEEDOR + ".COD_ALBARAN_094 = " + ALBARAN + ".ID_099 " + DaoConstants.AND
				+ " ALBARAN.ID_LOTE_099 = ? ");

		return elFrom.toString();
	}

	@Override
	protected RowMapper<Pagamentos> getRwMap() {
		return this.rwMap;
	}

	@Override
	protected String[] getOrderBy() {
		return PagamentosDaoImpl.ORDER_BY_WHITE_LIST;
	}

	@Override
	protected String getPK() {
		return IDALBARAN;
	}

	@Override
	protected String getWherePK(Pagamentos bean, List<Object> params) {

		StringBuilder wherePK = new StringBuilder(PagamentosDaoImpl.STRING_BUILDER_INIT);
		wherePK.append(GenericoDaoImpl.DEFAULT_WHERE);
		wherePK.append(DaoConstants.AND + " ID_099 = ? ");
		wherePK.append(this.getGroupBy());
		// para el parámetro de idLote del From
		params.add(bean.getIdLote());
		params.add(bean.getIdAlbaran());
		return wherePK.toString();
	}

	@Override
	protected String getWhere(Pagamentos bean, List<Object> params) {
		return this.getWhereLike(bean, false, params, false);

	}

	protected String getGroupBy() {
		return DaoConstants.GROUP_BY
				+ "ID_LOTE_099, ID_099, REF_ALBARAN_099, FECHA_ALTA_099, ESTADO_099, IMPORTE_FACTURA_099 ";
	}

	@Override
	protected String getWhereLike(Pagamentos bean, Boolean startsWith, List<Object> params, Boolean search) {
		// para el parámetro de idLote del From
		params.add(bean.getIdLote());

		StringBuilder where = new StringBuilder(PagamentosDaoImpl.STRING_BUILDER_INIT);
		// para el buscador, condiciones fijas
		where.append(DaoConstants.AND + IND_FACTURABLE_IGUAL + Constants.SI + "' ");
		where.append(SqlUtils.generarWhereIgual(IND_ALBARAN, bean.getAsociableAlbaran(), params));
		where.append(SqlUtils.generarWhereIgual(IND_PAGADO, bean.getIndPagado(), params));
		if (bean.getIdEstadoTarea() != null) {
			if (EstadoEjecucionTareaEnum.RETRASADA.getValue() == bean.getIdEstadoTarea()) {
				where.append(" AND (tareafact.ESTADO_EJECUCION_081 = 1 AND tareafact.FECHA_FIN_081 > SYSDATE) ");
			} else {
				where.append(" AND tareafact.ESTADO_EJECUCION_081 = ? ");
				params.add(bean.getIdEstadoTarea());
			}
		}
		where.append(DaoConstants.AND + ID_LOTE_081_IGUAL_INTERROG);
		params.add(bean.getIdLote());

		if (bean.getEstadoAlbaran() != null) {
			if (EstadoAlbaranEnum.PENDIENTE_ASOCIAR_ALBARAN.getValue() == bean.getEstadoAlbaran()) {
				where.append(DaoConstants.AND + " ESTADO_099 IS NULL ");
			} else {
				where.append(DaoConstants.AND + " ESTADO_099 = ? ");
				params.add(bean.getEstadoAlbaran());
			}
		}
		where.append(SqlUtils.generarWhereIgual(IDALBARAN, bean.getIdAlbaran(), params));

		where.append(SqlUtils.generarWhereIgual(REFALBARAN, bean.getRefAlbaran(), params));

		where.append(SqlUtils.generarWhereLike("TAREAFACT.ANYO_081",
				bean.getIdAlbaranAnoExpediente() != null ? (bean.getIdAlbaranAnoExpediente()).toString() : "", params,
				startsWith));
		where.append(SqlUtils.generarWhereLike("TAREAFACT.NUM_EXP_081",
				bean.getIdAlbaranExpediente() != null ? (bean.getIdAlbaranExpediente()).toString() : "", params,
				startsWith));
		where.append(SqlUtils.generarWhereIgual("TAREAFACT.ID_TAREA_081", bean.getIdAlbaranTarea(), params));
		where.append(SqlUtils.generarWhereIgual("TAREAFACT.ID_TIPO_TAREA_081", bean.getIdAlbaranTipoTarea(), params));

		where.append(this.getGroupBy());
		return where.toString();
	}

	@Override
	@Transactional(readOnly = true)
	public Long findAllLikeCountPropio(Pagamentos bean, Boolean startsWith) {
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder(
				DaoConstants.SELECT_COUNT + DaoConstants.FROM + DaoConstants.ABRIR_PARENTESIS);

		query.append(this.getSelect());
		query.append(this.getFrom(bean, params));
		query.append(GenericoDaoImpl.DEFAULT_WHERE);
		query.append(this.getWhereLike(bean, startsWith, params, false));

		query.append(DaoConstants.CERRAR_PARENTESIS);

		return this.getJdbcTemplate().queryForObject(query.toString(), params.toArray(), Long.class);
	}

	public String getSelectTablaTareas() {
		Locale eu = new Locale(Constants.LANG_EUSKERA);
		Locale es = new Locale(Constants.LANG_CASTELLANO);
		StringBuilder select = new StringBuilder(PagamentosDaoImpl.STRING_BUILDER_INIT);
		select.append(
				" TAREAFACT.ANYO_081 ANYO,TAREAFACT.NUM_EXP_081 NUMEXP,SUBSTR(TAREAFACT.ANYO_081,2,4) || '/' || LPAD(TAREAFACT.NUM_EXP_081,6,'0') ANYONUMEXPCONCATENADO,TAREAFACT.ID_TAREA_081 IDTAREA, TAREAFACT.ID_TIPO_TAREA_081,DESC_EU_015, NUM_TOTAL_PAL_094 NUMTOTALPAL, NUM_PAL_CONCOR_0_84_094, NUM_PAL_CONCOR_85_94_094, ");
		select.append(
				" NUM_PAL_CONCOR_95_100_094, IND_RECARGO_FORMATO_094, NUM_PAL_RECARGO_FORMATO_094, IND_RECARGO_APREMIO_094, ");
		select.append(
				" POR_RECARGO_APREMIO_094, IND_PENALIZACION_094, POR_PENALIZACION_094, IVA_APLIC_094 IVAAPLIC, IMPORTE_PAL_APLIC_094 IMPORTEPALAPLIC, ");
		select.append(" IMPORTE_TAREA_094 IMPORTETAREA, IMPORTE_RECARGO_FORMATO_094 IMPORTERECARGOFORMATO, ");
		select.append(
				" IMPORTE_RECARGO_APREMIO_094 IMPORTERECARGOAPREMIO, IMPORTE_PENALIZACION_094 IMPORTEPENALIZACION, ");
		select.append(" IMPORTE_BASE_094 IMPORTEBASE, IMPORTE_IVA_094 IMPORTEIVA, IMPORTE_TOTAL_094 IMPORTETOTAL ");
		select.append(", TAREAFACT.IND_FACTURABLE_081 INDFACTURABLE ");
		select.append(DAOUtils.getDecodeAcciones("TAREAFACT.IND_FACTURABLE_081", "FACTURABLEDESCEU",
				this.appMessageSource, ACTIVO_ENUM, eu));
		select.append(DAOUtils.getDecodeAcciones("TAREAFACT.IND_FACTURABLE_081", "FACTURABLEDESCES",
				this.appMessageSource, ACTIVO_ENUM, es));
		select.append(" , IND_ALBARAN_094 INDALBARAN ");
		select.append(DAOUtils.getDecodeAcciones("IND_ALBARAN_094", "INDALBARANDESCEU", this.appMessageSource,
				ACTIVO_ENUM, eu));
		select.append(
				" , NIVEL_CALIDAD_094 NIVELCALIDAD, POR_PENAL_CALIDAD_094 PORPENALCALIDAD, IMP_PENAL_CALIDAD_094 IMPPENALCALIDAD");
		return select.toString();
	}

	@Override
	public Object getTareasAlbaran(Pagamentos filterPagamentos, JQGridRequestDto jqGridRequestDto, boolean startsWith,
			boolean isCount) {
		List<Object> params = new ArrayList<Object>();
		StringBuilder select = new StringBuilder(PagamentosDaoImpl.STRING_BUILDER_INIT);
		StringBuilder paginatedQuery = new StringBuilder(PagamentosDaoImpl.STRING_BUILDER_INIT);

		select.append(DaoConstants.SELECT);
		if (isCount) {
			select.append(" COUNT(DISTINCT tareafact.ID_TAREA_081) ");
		} else {
			/* query DSI */
			select.append(getSelectTablaTareas());
		}
		select.append(getFrom());
		select.append(DaoConstants.LEFT_JOIN + DBConstants.TABLA_15 + DaoConstants.ON
				+ " TAREAFACT.ID_TIPO_TAREA_081 = ID_015 ");

		params.add(filterPagamentos.getIdLote());

		select.append(DaoConstants.WHERE_1_1);
		select.append(DaoConstants.AND + IND_FACTURABLE_IGUAL + Constants.SI + "' ");
		select.append(DaoConstants.AND + ID_LOTE_081_IGUAL_INTERROG);
		params.add(filterPagamentos.getIdLote());

		select.append(SqlUtils.generarWhereIgual(IND_ALBARAN, filterPagamentos.getAsociableAlbaran(), params));
		select.append(SqlUtils.generarWhereIgual(IND_PAGADO, filterPagamentos.getIndPagado(), params));
		if (filterPagamentos.getIdEstadoTarea() != null) {
			if (EstadoEjecucionTareaEnum.RETRASADA.getValue() == filterPagamentos.getIdEstadoTarea()) {
				select.append(" AND (TAREAFACT.ESTADO_EJECUCION_081 = 1 AND TAREAFACT.FECHA_FIN_081 > SYSDATE)");
			} else {
				select.append(" AND TAREAFACT.ESTADO_EJECUCION_081 = ? ");
				params.add(filterPagamentos.getIdEstadoTarea());
			}
		}

		if (filterPagamentos.getIdAlbaran() != null && Constants.CERO != filterPagamentos.getIdAlbaran().intValue()) {
			select.append(DaoConstants.AND + " COD_ALBARAN_094 = ? ");
			params.add(filterPagamentos.getIdAlbaran());
		} else {
			// Tareas PENDIENTES DE ALBARAN
			select.append(DaoConstants.AND + " COD_ALBARAN_094 IS NULL ");
		}

		paginatedQuery.append(Utils.getPaginationQuery(jqGridRequestDto, isCount, select));
		if (isCount) {
			return this.getJdbcTemplate().queryForObject(paginatedQuery.toString(), params.toArray(), Long.class);
		} else {
			return this.getJdbcTemplate().query(paginatedQuery.toString(), this.rwMapTarea, params.toArray());
		}
	}

	@Override
	public List<Albaran> getAlbaranesLote(Integer idLote, Integer tipo) {
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder(
				DaoConstants.SELECT + " DISTINCT(ID_099 ) ID, REF_ALBARAN_099 REFALBARAN " + DaoConstants.FROM
						+ DBConstants.TABLA_99 + " JOIN AA79B94S01 ON ID_099 = COD_ALBARAN_094 ");
		query.append(DaoConstants.WHERE + " ID_LOTE_099 " + DaoConstants.SIGNOIGUAL_INTERROGACION);

		if (Constants.UNO == tipo) {
			// Albaranes no pagados
			query.append(" AND ESTADO_099 <> " + EstadoAlbaranEnum.PAGADO.getValue());
		}
		query.append(" ORDER BY REF_ALBARAN_099 ASC ");

		params.add(idLote);
		return this.getJdbcTemplate().query(query.toString(), this.rwMapAlbaranCombo, params.toArray());
	}
}
