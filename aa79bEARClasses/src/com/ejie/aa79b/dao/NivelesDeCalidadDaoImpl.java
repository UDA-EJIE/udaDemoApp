package com.ejie.aa79b.dao;

import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.support.ReloadableResourceBundleMessageSource;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.common.SqlUtils;
import com.ejie.aa79b.model.NivelesDeCalidad;

/**
 * TiposInterpretacionDaoImpl generated by UDA, 22-nov-2017 10:22:35.
 * 
 * @author UDA
 */

@Repository
@Transactional
public class NivelesDeCalidadDaoImpl extends GenericoDaoImpl<NivelesDeCalidad> implements NivelesDeCalidadDao {

	@Autowired()
	private ReloadableResourceBundleMessageSource msg;

	public NivelesDeCalidadDaoImpl() {
		super(NivelesDeCalidad.class);
	}

	protected static final String[] ORDER_BY_WHITE_LIST = new String[] { "ID", "NIVEL", "RANGOINI", "RANGOFIN",
			"PORPENALIZACION", "ESTADODESCES", "ESTADODESCEU" };

	/*
	 * ROW_MAPPERS
	 */
	private RowMapper<NivelesDeCalidad> rwMap = new RowMapper<NivelesDeCalidad>() {
		@Override
		public NivelesDeCalidad mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			NivelesDeCalidad nivelesDeCalidad = new NivelesDeCalidad(resultSet.getLong("ID"),
					resultSet.getLong("NIVEL"), resultSet.getLong("RANGOINI"), resultSet.getLong("RANGOFIN"),
					resultSet.getLong("PORPENALIZACION"), resultSet.getString("ESTADO"));
			nivelesDeCalidad.setDescRango(resultSet.getString("DESC_RANGO"));
			nivelesDeCalidad.setDescEstadoEs(resultSet.getString("ESTADODESCES"));
			nivelesDeCalidad.setDescEstadoEu(resultSet.getString("ESTADODESCEU"));
			return nivelesDeCalidad;
		}
	};

	private RowMapper<NivelesDeCalidad> rwMapPK = new RowMapper<NivelesDeCalidad>() {
		@Override
		public NivelesDeCalidad mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			return new NivelesDeCalidad(resultSet.getLong("ID"), resultSet.getLong("NIVEL"),
					resultSet.getLong("RANGOINI"), resultSet.getLong("RANGOFIN"), resultSet.getLong("PORPENALIZACION"),
					resultSet.getString("ESTADO"));
		}
	};

	@Override
	public NivelesDeCalidad add(NivelesDeCalidad nivelesDeCalidad) {

		String queryID = "SELECT AA79BB5Q00.NEXTVAL from dual";
		long elId = this.getJdbcTemplate().queryForObject(queryID, Long.class);

		String query = "INSERT INTO AA79BB5S01 (ID_0B5, NIVEL_0B5, RANGO_INI_CALIDAD_0B5, RANGO_FIN_CALIDAD_0B5, POR_PENALIZACION_0B5, ESTADO_0B5) VALUES (?,?,?,?,?,?)";
		this.getJdbcTemplate().update(query, elId, nivelesDeCalidad.getNivel(), nivelesDeCalidad.getRangoIni(),
				nivelesDeCalidad.getRangoFin(), nivelesDeCalidad.getPorPenalizacion(), nivelesDeCalidad.getEstado());
		return nivelesDeCalidad;
	}

	/**
	 * Updates a single row in the TiposInterpretacion table.
	 *
	 * @param tiposinterpretacion TiposInterpretacion
	 * @return TiposInterpretacion
	 */
	@Override
	public NivelesDeCalidad update(NivelesDeCalidad nivelesDeCalidad) {
		String query = "UPDATE AA79BB5S01 SET NIVEL_0B5=?, RANGO_INI_CALIDAD_0B5=?, RANGO_FIN_CALIDAD_0B5=?, ESTADO_0B5=?, POR_PENALIZACION_0B5=? WHERE ID_0B5=?";
		this.getJdbcTemplate().update(query, nivelesDeCalidad.getNivel(), nivelesDeCalidad.getRangoIni(),
				nivelesDeCalidad.getRangoFin(), nivelesDeCalidad.getEstado(), nivelesDeCalidad.getPorPenalizacion(),
				nivelesDeCalidad.getId());
		return nivelesDeCalidad;
	}

	@Override
	public boolean comprobarRango(NivelesDeCalidad nivelesDeCalidad) {
		List<Object> params = new ArrayList<Object>();

		StringBuilder query = new StringBuilder("SELECT COUNT(*) FROM AA79BB5S01 t1 WHERE 1=1");

		if (nivelesDeCalidad.getId() != null) {
			query.append(" AND t1.ID_0B5 != ? ");
		}
		query.append(" AND ESTADO_0B5 = '").append(Constants.ALTA).append("'");
		query.append(" AND ((? > t1.RANGO_INI_CALIDAD_0B5 AND ? < t1.RANGO_FIN_CALIDAD_0B5) ");
		query.append(" OR (? >= t1.RANGO_INI_CALIDAD_0B5 AND ? < t1.RANGO_FIN_CALIDAD_0B5) ");
		query.append(" OR (? <= t1.RANGO_INI_CALIDAD_0B5 AND ? >= t1.RANGO_FIN_CALIDAD_0B5 ))");

		if (nivelesDeCalidad.getId() != null) {
			params.add(nivelesDeCalidad.getId());
		}

		params.add(nivelesDeCalidad.getRangoFin());
		params.add(nivelesDeCalidad.getRangoFin());
		params.add(nivelesDeCalidad.getRangoIni());
		params.add(nivelesDeCalidad.getRangoIni());
		params.add(nivelesDeCalidad.getRangoIni());
		params.add(nivelesDeCalidad.getRangoFin());

		long numConflictos = this.getJdbcTemplate().queryForObject(query.toString(), params.toArray(), Long.class);

		return numConflictos != 0;
	}

	@Override
	public List<NivelesDeCalidad> getAllOrdered(NivelesDeCalidad bean) {
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder(this.getSelect());
		query.append(this.getFrom());
		query.append(GenericoDaoImpl.DEFAULT_WHERE);
		query.append(this.getWhere(bean, params));
		query.append(" ORDER BY t1.POR_PENALIZACION_0B5 ASC ");
		return this.getJdbcTemplate().query(query.toString(), this.rwMap, params.toArray());
	}

	public boolean comprobarNivel(NivelesDeCalidad nivelesDeCalidad) {
		List<Object> params = new ArrayList<Object>();

		StringBuilder query = new StringBuilder("SELECT COUNT(*) FROM AA79BB5S01 t1 WHERE 1=1");

		if (nivelesDeCalidad.getId() != null) {
			query.append(" AND t1.ID_0B5 != ? ");
		}
		query.append(" AND ESTADO_0B5 = '").append(Constants.ALTA).append("'");
		query.append(" AND t1.NIVEL_0B5 = ? ");

		if (nivelesDeCalidad.getId() != null) {
			params.add(nivelesDeCalidad.getId());
		}

		params.add(nivelesDeCalidad.getNivel());

		long numConflictos = this.getJdbcTemplate().queryForObject(query.toString(), params.toArray(), Long.class);

		return numConflictos != 0;
	}

	@Override
	protected String getSelect() {
		Locale es = new Locale("es");
		Locale eu = new Locale("eu");
		StringBuilder select = new StringBuilder();

		select.append("SELECT  t1.ID_0B5 ID");
		select.append(",  t1.NIVEL_0B5 NIVEL");
		select.append(", NVL(t1.RANGO_INI_CALIDAD_0B5,0) RANGOINI");
		select.append(", NVL(t1.RANGO_FIN_CALIDAD_0B5,0) RANGOFIN");
		select.append(
				",  '>=' || NVL(t1.RANGO_INI_CALIDAD_0B5,0) || ' - < ' || NVL(t1.RANGO_FIN_CALIDAD_0B5,0) || ' Penalizazioa: ' || t1.POR_PENALIZACION_0B5 || '%'  AS DESC_RANGO");
		select.append(", t1.POR_PENALIZACION_0B5 PORPENALIZACION");
		select.append(", t1.ESTADO_0B5 ESTADO");
		select.append(", DECODE(t1.ESTADO_0B5, 'A', '").append(this.msg.getMessage("estado.alta", null, es))
				.append("', 'B', '").append(this.msg.getMessage("estado.baja", null, es)).append("') AS ESTADODESCES");
		select.append(", DECODE(t1.ESTADO_0B5, 'A', '").append(this.msg.getMessage("estado.alta", null, eu))
				.append("', 'B', '").append(this.msg.getMessage("estado.baja", null, eu)).append("') AS ESTADODESCEU");

		return select.toString();
	}

	@Override()
	protected String getFrom() {
		return " FROM AA79BB5S01 t1";
	}

	@Override()
	protected RowMapper<NivelesDeCalidad> getRwMap() {
		return this.rwMap;
	}

	@Override()
	protected String[] getOrderBy() {
		return NivelesDeCalidadDaoImpl.ORDER_BY_WHITE_LIST;
	}

	@Override()
	protected String getPK() {
		return "ID_0B5";
	}

	@Override()
	protected RowMapper<NivelesDeCalidad> getRwMapPK() {
		return this.rwMapPK;
	}

	@Override()
	protected String getWherePK(NivelesDeCalidad bean, List<Object> params) {
		params.add(bean.getId());
		return " WHERE t1.ID_0B5 = ?";
	}

	@Override
	protected String getWhere(NivelesDeCalidad bean, List<Object> params) {
		StringBuilder where = new StringBuilder(NivelesDeCalidadDaoImpl.STRING_BUILDER_INIT);

		where.append(SqlUtils.generarWhereIgual("t1.ID_0B5", bean.getId(), params));

		where.append(SqlUtils.generarWhereIgual("t1.NIVEL_0B5", bean.getNivel(), params));

		where.append(SqlUtils.generarWhereIgual("t1.RANGO_INI_CALIDAD_0B5", bean.getRangoIni(), params));

		where.append(SqlUtils.generarWhereIgual("t1.RANGO_FIN_CALIDAD_0B5", bean.getRangoFin(), params));

		where.append(SqlUtils.generarWhereIgual("t1.POR_PENALIZACION_0B5", bean.getPorPenalizacion(), params));

		where.append(SqlUtils.generarWhereIgual("t1.ESTADO_0B5", bean.getEstado(), params));

		Map<String, Object> mapWhere = new HashMap<String, Object>();
		mapWhere.put("query", where);
		mapWhere.put("params", params);

		return where.toString();
	}

	@Override
	protected String getWhereLike(NivelesDeCalidad bean, Boolean startsWith, List<Object> params, Boolean search) {
		StringBuilder where = new StringBuilder(NivelesDeCalidadDaoImpl.STRING_BUILDER_INIT);

		where.append(SqlUtils.generarWhereIgual("t1.ID_0B5", bean.getId(), params));

		where.append(SqlUtils.generarWhereIgual("t1.NIVEL_0B5", bean.getNivel(), params));

		where.append(SqlUtils.generarWhereIgual("t1.RANGO_INI_CALIDAD_0B5", bean.getRangoIni(), params));

		where.append(SqlUtils.generarWhereIgual("t1.RANGO_FIN_CALIDAD_0B5", bean.getRangoFin(), params));

		where.append(SqlUtils.generarWhereIgual("t1.POR_PENALIZACION_0B5", bean.getPorPenalizacion(), params));

		where.append(SqlUtils.generarWhereIgual("t1.ESTADO_0B5", bean.getEstado(), params));

		Map<String, Object> mapWhere = new HashMap<String, Object>();
		mapWhere.put("query", where);
		mapWhere.put("params", params);

		return where.toString();
	}

}
