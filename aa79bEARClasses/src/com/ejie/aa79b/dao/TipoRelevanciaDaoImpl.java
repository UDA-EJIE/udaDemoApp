package com.ejie.aa79b.dao;

import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.support.ReloadableResourceBundleMessageSource;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.common.DBConstants;
import com.ejie.aa79b.common.DaoConstants;
import com.ejie.aa79b.common.SqlUtils;
import com.ejie.aa79b.model.TipoRelevancia;
import com.ejie.aa79b.model.enums.EstadoEnum;

/**
 * TipoRelevanciaDaoImpl generated by UDA, 24-oct-2017 15:14:42.
 * 
 * @author UDA
 */

@Repository
@Transactional
public class TipoRelevanciaDaoImpl extends GenericoDaoImpl<TipoRelevancia> implements TipoRelevanciaDao {

	@Autowired()
	private ReloadableResourceBundleMessageSource msg;

	private static final String DESC_RELEVANCIA_EU = "t1.DESC_RELEVANCIA_EU_010";
	private static final String DESC_RELEVANCIA_ES = "t1.DESC_RELEVANCIA_ES_010";
	private static final String IDTIPORELEVANCIA = "IDTIPORELEVANCIA";
	private static final String DESCRELEVANCIAEU = "DESCRELEVANCIAEU";
	private static final String DESCRELEVANCIAES = "DESCRELEVANCIAES";
	private static final String PRIORIDAD = "PRIORIDAD";
	private static final String ESTADODESCEU = "ESTADODESCEU";
	private static final String ESTADODESCES = "ESTADODESCES";

	protected static final String[] ORDER_BY_WHITE_LIST = new String[] { PRIORIDAD, IDTIPORELEVANCIA, DESCRELEVANCIAEU,
			DESCRELEVANCIAES, DBConstants.ESTADO, ESTADODESCEU, ESTADODESCES, "DESCNORMEU", "DESCNORMES" };

	/*
	 * ROW_MAPPERS
	 */
	private RowMapper<TipoRelevancia> rwMap = new RowMapper<TipoRelevancia>() {
		@Override
		public TipoRelevancia mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			TipoRelevancia tiporelevancia = new TipoRelevancia(resultSet.getLong(IDTIPORELEVANCIA),
					resultSet.getString(DESCRELEVANCIAEU), resultSet.getString(DESCRELEVANCIAES),
					resultSet.getLong(PRIORIDAD), resultSet.getString(DBConstants.ESTADO));

			tiporelevancia.setEstadoDescEs(resultSet.getString(ESTADODESCES));
			tiporelevancia.setEstadoDescEu(resultSet.getString(ESTADODESCEU));

			return tiporelevancia;
		}
	};

	private RowMapper<TipoRelevancia> rwMapPK = new RowMapper<TipoRelevancia>() {
		@Override()
		public TipoRelevancia mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			return new TipoRelevancia(resultSet.getLong(IDTIPORELEVANCIA));
		}
	};

	/*
	 * ROW_MAPPERS
	 */
	private RowMapper<TipoRelevancia> rwMapDocs = new RowMapper<TipoRelevancia>() {
		@Override
		public TipoRelevancia mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			TipoRelevancia tiporelevancia = new TipoRelevancia(resultSet.getLong(IDTIPORELEVANCIA),
					resultSet.getString(DESCRELEVANCIAEU), resultSet.getString(DESCRELEVANCIAES),
					resultSet.getLong(PRIORIDAD), resultSet.getString(DBConstants.ESTADO));

			tiporelevancia.setEstadoDescEs(resultSet.getString(ESTADODESCES));
			tiporelevancia.setEstadoDescEu(resultSet.getString(ESTADODESCEU));

			if (EstadoEnum.BAJA.getValue().equals(tiporelevancia.getEstado())) {
				tiporelevancia.setIdTipoRelevancia(Constants.MAGIC_NUMBER_MENOS_1_L);
			}

			return tiporelevancia;
		}
	};

	/**
	 * Constructor
	 */
	public TipoRelevanciaDaoImpl() {
		super(TipoRelevancia.class);
	}

	@Override()
	public TipoRelevancia add(TipoRelevancia tiporelevancia) {

		String query = "INSERT INTO AA79B10S01 (ID_TIPO_RELEVANCIA_010, DESC_RELEVANCIA_EU_010, DESC_RELEVANCIA_ES_010, PRIORIDAD_010, ESTADO_010) VALUES (AA79B10Q00.NEXTVAL,?,?,?,?)";
		this.getJdbcTemplate().update(query, tiporelevancia.getDescRelevanciaEu(), tiporelevancia.getDescRelevanciaEs(),
				tiporelevancia.getPrioridad(), tiporelevancia.getEstado());
		return tiporelevancia;
	}

	/**
	 * Updates a single row in the TipoRelevancia table.
	 *
	 * @param tiporelevancia
	 *            TipoRelevancia
	 * @return TipoRelevancia
	 */
	@Override()
	public TipoRelevancia update(TipoRelevancia tiporelevancia) {
		String query = "UPDATE AA79B10S01 SET DESC_RELEVANCIA_EU_010=?, DESC_RELEVANCIA_ES_010=?, PRIORIDAD_010=?, ESTADO_010=? WHERE ID_TIPO_RELEVANCIA_010=?";
		this.getJdbcTemplate().update(query, tiporelevancia.getDescRelevanciaEu(), tiporelevancia.getDescRelevanciaEs(),
				tiporelevancia.getPrioridad(), tiporelevancia.getEstado(), tiporelevancia.getIdTipoRelevancia());
		return tiporelevancia;
	}

	/**
	 * The method getQuery.
	 * 
	 * @return String
	 */
	@Override
	protected String getSelect() {
		Locale es = new Locale("es");
		Locale eu = new Locale("eu");
		StringBuilder sb = new StringBuilder();

		sb.append("SELECT t1.ID_TIPO_RELEVANCIA_010 IDTIPORELEVANCIA");
		sb.append(", t1.DESC_RELEVANCIA_EU_010 DESCRELEVANCIAEU");
		sb.append(", t1.DESC_RELEVANCIA_ES_010 DESCRELEVANCIAES");
		sb.append(", t1.PRIORIDAD_010 PRIORIDAD");
		sb.append(", t1.ESTADO_010 ESTADO");
		sb.append(", DECODE(t1.ESTADO_010, 'A', '").append(this.msg.getMessage("estado.alta", null, es))
				.append("', 'B', '").append(this.msg.getMessage("estado.baja", null, es)).append("') AS ESTADODESCES");
		sb.append(", DECODE(t1.ESTADO_010, 'A', '").append(this.msg.getMessage("estado.alta", null, eu))
				.append("', 'B', '").append(this.msg.getMessage("estado.baja", null, eu)).append("') AS ESTADODESCEU");
		// Para orenaci√≥n con acentos etc
		sb.append(", ").append(SqlUtils.normalizarCampoSql(DESC_RELEVANCIA_EU)).append(" AS DESCNORMEU");
		sb.append(", ").append(SqlUtils.normalizarCampoSql(DESC_RELEVANCIA_ES)).append(" AS DESCNORMES");

		return sb.toString();
	}

	@Override
	protected String getFrom() {
		return " FROM AA79B10S01 t1 ";
	}

	@Override
	protected RowMapper<TipoRelevancia> getRwMap() {
		return this.rwMap;
	}

	@Override
	protected String[] getOrderBy() {
		return TipoRelevanciaDaoImpl.ORDER_BY_WHITE_LIST;
	}

	@Override
	protected String getPK() {
		return "ID_TIPO_RELEVANCIA_010";
	}

	@Override
	protected RowMapper<TipoRelevancia> getRwMapPK() {
		return this.rwMapPK;
	}

	@Override
	protected String getWherePK(TipoRelevancia bean, List<Object> params) {
		params.add(bean.getIdTipoRelevancia());
		return "WHERE t1.ID_TIPO_RELEVANCIA_010 =?";
	}

	@Override
	protected String getWhere(TipoRelevancia bean, List<Object> params) {
		StringBuilder where = new StringBuilder(TipoRelevanciaDaoImpl.STRING_BUILDER_INIT);

		where.append(SqlUtils.generarWhereIgual("t1.ID_TIPO_RELEVANCIA_010", bean.getIdTipoRelevancia(), params));
		where.append(
				SqlUtils.generarWhereLikeNormalizado(DESC_RELEVANCIA_EU, bean.getDescRelevanciaEu(), params, false));
		where.append(
				SqlUtils.generarWhereLikeNormalizado(DESC_RELEVANCIA_ES, bean.getDescRelevanciaEs(), params, false));
		where.append(SqlUtils.generarWhereIgual("t1.PRIORIDAD_010", bean.getPrioridad(), params));
		where.append(SqlUtils.generarWhereIgual("t1.ESTADO_010", bean.getEstado(), params));
		Map<String, Object> mapWhere = new HashMap<String, Object>();
		mapWhere.put("query", where);
		mapWhere.put("params", params);

		return where.toString();
	}

	@Override
	protected String getWhereLike(TipoRelevancia bean, Boolean startsWith, List<Object> params, Boolean search) {
		StringBuilder where = new StringBuilder(TipoRelevanciaDaoImpl.STRING_BUILDER_INIT);

		where.append(SqlUtils.generarWhereIgual("t1.ID_TIPO_RELEVANCIA_010", bean.getIdTipoRelevancia(), params));
		where.append(SqlUtils.generarWhereLikeNormalizado(DESC_RELEVANCIA_EU, bean.getDescRelevanciaEu(), params,
				startsWith));
		where.append(SqlUtils.generarWhereLikeNormalizado(DESC_RELEVANCIA_ES, bean.getDescRelevanciaEs(), params,
				startsWith));
		where.append(SqlUtils.generarWhereIgual("t1.PRIORIDAD_010", bean.getPrioridad(), params));
		where.append(SqlUtils.generarWhereIgual("t1.ESTADO_010", bean.getEstado(), params));

		Map<String, Object> mapWhere = new HashMap<String, Object>();
		mapWhere.put("query", where);
		mapWhere.put("params", params);

		return where.toString();
	}

	@Override
	public boolean comprobarPrioridad(TipoRelevancia tiporelevancia) {
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder("SELECT COUNT(*) FROM AA79B10S01 t1 WHERE 1=1 ");
		if (tiporelevancia.getIdTipoRelevancia() != null) {
			query.append(" AND t1.ID_TIPO_RELEVANCIA_010 <> ? ");
			params.add(tiporelevancia.getIdTipoRelevancia());
		}
		if (tiporelevancia.getPrioridad() != null) {
			query.append(" AND t1.PRIORIDAD_010 = ? ");
			params.add(tiporelevancia.getPrioridad());
		}
		long numConflictos = this.getJdbcTemplate().queryForObject(query.toString(), params.toArray(), Long.class);
		return numConflictos != 0;
	}

	/**
	 * @param tipoRelevancia
	 *            TipoRelevancia Bean
	 * @return List<TipoRelevancia> lista de tipos.
	 */
	@Override()
	public List<TipoRelevancia> findAllByIdAndState(TipoRelevancia tipoRelevancia) {
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder(this.getSelect());
		query.append(this.getFrom());

		query.append(DaoConstants.WHERE_1_1);
		if (tipoRelevancia.getIdTipoRelevancia() != null) {
			query.append(" AND (t1.ID_TIPO_RELEVANCIA_010 = ? OR t1.ESTADO_010 = ?)");
			params.add(tipoRelevancia.getIdTipoRelevancia());
		} else {
			query.append(" AND t1.ESTADO_010 = ?");
		}

		params.add(tipoRelevancia.getEstado());

		return this.getJdbcTemplate().query(query.toString(), this.rwMapDocs, params.toArray());
	}
}
