package com.ejie.aa79b.dao;

import java.math.BigDecimal;
import java.sql.CallableStatement;
import java.sql.Connection;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Types;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.dao.support.DataAccessUtils;
import org.springframework.jdbc.core.CallableStatementCallback;
import org.springframework.jdbc.core.CallableStatementCreator;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.StringUtils;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.common.DaoConstants;
import com.ejie.aa79b.common.SqlUtils;
import com.ejie.aa79b.model.OtrosTrabajos;
import com.ejie.aa79b.model.enums.EstadoAceptacionTareaEnum;
import com.ejie.aa79b.model.enums.EstadoEjecucionTareaEnum;
import com.ejie.aa79b.model.enums.FiltroEstadoTrabajoEnum;
import com.ejie.aa79b.utils.DateUtils;

/**
 * OtrosTrabajosDaoImpl generated by UDA, 08-nov-2017 13:51:14.
 *
 * @author UDA
 */

@Repository
@Transactional
public class OtrosTrabajosDaoImpl extends GenericoDaoImpl<OtrosTrabajos> implements OtrosTrabajosDao {

	public OtrosTrabajosDaoImpl() {
		super(OtrosTrabajos.class);
	}

	protected static final String[] ORDER_BY_WHITE_LIST = new String[] { "IDTRABAJO", "DESCTRABAJO", "FECHAINICIO",
			"FECHAFINPREVISTA", "FECHAFIN"};

	/*
	 * ROW_MAPPERS
	 */
	private RowMapper<OtrosTrabajos> rwMap = new RowMapper<OtrosTrabajos>() {
		@Override
		public OtrosTrabajos mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			OtrosTrabajos trabajo = new OtrosTrabajos(resultSet.getBigDecimal("IDTRABAJO"), resultSet.getString("DESCTRABAJO"),
					resultSet.getDate("FECHAINICIO"), resultSet.getDate("FECHAFINPREVISTA"), resultSet.getDate("FECHAFIN"));
			trabajo.setHoraInicio(resultSet.getString("HORAINICIO"));
			trabajo.setHoraFinPrevista(resultSet.getString("HORAFINPREVISTA"));
			trabajo.setHoraFin(resultSet.getString("HORAFIN"));
			return trabajo;
		}
	};

	private RowMapper<OtrosTrabajos> rwMapBuscarTrabajo = new RowMapper<OtrosTrabajos>() {
		@Override
		public OtrosTrabajos mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			OtrosTrabajos trabajo = new OtrosTrabajos(resultSet.getBigDecimal("IDTRABAJO"), resultSet.getString("DESCTRABAJO"),
					resultSet.getDate("FECHAINICIO"), resultSet.getDate("FECHAFINPREVISTA"), resultSet.getDate("FECHAFIN"));
			trabajo.setHoraInicio(resultSet.getString("HORAINICIO"));
			trabajo.setHoraFinPrevista(resultSet.getString("HORAFINPREVISTA"));
			trabajo.setHoraFin(resultSet.getString("HORAFIN"));
			trabajo.setTareasCerradas(resultSet.getString("TAREASCERRADAS"));
			return trabajo;
		}
	};

	private RowMapper<OtrosTrabajos> rwMapPK = new RowMapper<OtrosTrabajos>() {
		@Override
		public OtrosTrabajos mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			OtrosTrabajos trabajo = new OtrosTrabajos(resultSet.getBigDecimal("IDTRABAJO"), resultSet.getString("DESCTRABAJO"),
					resultSet.getDate("FECHAINICIO"), resultSet.getDate("FECHAFINPREVISTA"), resultSet.getDate("FECHAFIN"));
			trabajo.setHoraInicio(resultSet.getString("HORAINICIO"));
			trabajo.setHoraFinPrevista(resultSet.getString("HORAFINPREVISTA"));
			trabajo.setHoraFin(resultSet.getString("HORAFIN"));
			return trabajo;
		}
	};

	/*
	 * OPERACIONES CRUD
	 */

	/**
	 * Inserts a single row in the OtrosTrabajos table.
	 *
	 * @param motivosrechazo
	 *            OtrosTrabajos
	 * @return OtrosTrabajos
	 */
	@Override
	public OtrosTrabajos add(OtrosTrabajos otrosTrabajos) {
		String query = "INSERT INTO AA79BC6S01 (ID_TRABAJO_0C6, DESC_TRABAJO_0C6, FECHA_INICIO_0C6, FECHA_FIN_PREVISTA_0C6) VALUES (AA79BC6Q00.NEXTVAL,?,?,?)";
		this.getJdbcTemplate().update(query, otrosTrabajos.getDescTrabajo(),
				DateUtils.obtFechaHoraFormateada(otrosTrabajos.getFechaInicio(), otrosTrabajos.getHoraInicio()),
				DateUtils.obtFechaHoraFormateada(otrosTrabajos.getFechaFinPrevista(), otrosTrabajos.getHoraFinPrevista()));
		return otrosTrabajos;
	}

	/**
	 * Updates a single row in the OtrosTrabajos table.
	 *
	 * @param motivosrechazo
	 *            OtrosTrabajos
	 * @return OtrosTrabajos
	 */
	@Override
	public OtrosTrabajos update(OtrosTrabajos otrosTrabajos) {
		String query = "UPDATE AA79BC6S01 SET DESC_TRABAJO_0C6=?, FECHA_INICIO_0C6=?, FECHA_FIN_PREVISTA_0C6=?, FECHA_FIN_0C6=? WHERE ID_TRABAJO_0C6=?";
		this.getJdbcTemplate().update(query, otrosTrabajos.getDescTrabajo(),
				DateUtils.obtFechaHoraFormateada(otrosTrabajos.getFechaInicio(), otrosTrabajos.getHoraInicio()),
				DateUtils.obtFechaHoraFormateada(otrosTrabajos.getFechaFinPrevista(), otrosTrabajos.getHoraFinPrevista()),
				DateUtils.obtFechaHoraFormateada(otrosTrabajos.getFechaFin(), otrosTrabajos.getHoraFin()), otrosTrabajos.getIdTrabajo());
		return otrosTrabajos;
	}

	/**
	 * Updates a single row in the OtrosTrabajos table.
	 *
	 * @param motivosrechazo
	 *            OtrosTrabajos
	 * @return OtrosTrabajos
	 */
	@Override()
	public void remove(OtrosTrabajos otrosTrabajos) {
		String query = "DELETE FROM AA79BC6S01 WHERE ID_TRABAJO_0C6=?";
		this.getJdbcTemplate().update(query, otrosTrabajos.getIdTrabajo());
	}

	/**
	 * Finds a single row in the OtrosTrabajos table.
	 *
	 * @param motivosrechazo
	 *            OtrosTrabajos
	 * @return OtrosTrabajos
	 */
	@Override()
	protected String getSelect() {
		StringBuilder select = new StringBuilder();
		select.append("SELECT  t1.ID_TRABAJO_0C6 IDTRABAJO");
		select.append(",  t1.DESC_TRABAJO_0C6 DESCTRABAJO");
		select.append(", t1.FECHA_INICIO_0C6 FECHAINICIO ");
		select.append(", TO_CHAR(t1.FECHA_INICIO_0C6,'HH24:MI') HORAINICIO");
		select.append(", t1.FECHA_FIN_PREVISTA_0C6 FECHAFINPREVISTA ");
		select.append(", TO_CHAR(t1.FECHA_FIN_PREVISTA_0C6,'HH24:MI') HORAFINPREVISTA");
		select.append(", t1.FECHA_FIN_0C6 FECHAFIN");
		select.append(", TO_CHAR(t1.FECHA_FIN_0C6,'HH24:MI') HORAFIN");
		return select.toString();
	}

	@Override()
	protected String getFrom() {
		return " FROM AA79BC6S01 t1";
	}

	@Override()
	protected RowMapper<OtrosTrabajos> getRwMap() {
		return this.rwMap;
	}

	@Override()
	protected String[] getOrderBy() {
		return OtrosTrabajosDaoImpl.ORDER_BY_WHITE_LIST;
	}

	@Override()
	protected String getPK() {
		return "ID_TRABAJO_0C6";
	}

	@Override()
	protected RowMapper<OtrosTrabajos> getRwMapPK() {
		return this.rwMapPK;
	}

	@Override()
	protected String getWherePK(OtrosTrabajos bean, List<Object> params) {
		params.add(bean.getIdTrabajo());
		return " WHERE t1.ID_TRABAJO_0C6 = ?";
	}

	@Override
	protected String getWhere(OtrosTrabajos bean, List<Object> params) {
		StringBuilder where = new StringBuilder(OtrosTrabajosDaoImpl.STRING_BUILDER_INIT);

		where.append(SqlUtils.generarWhereIgual("t1.ID_TRABAJO_0C6", bean.getIdTrabajo(), params));

		where.append(SqlUtils.generarWhereLikeNormalizado("t1.DESC_TRABAJO_0C6", bean.getDescTrabajo(), params, false));

		where.append(SqlUtils.generarWhereMayorIgualFecha(
				DaoConstants.T1_MINUSCULA + DaoConstants.SIGNO_PUNTO + "FECHA_INICIO_0C6", DaoConstants.DDMMYY,
				bean.getFechaInicioDesde(), params));
		where.append(SqlUtils.generarWhereMenorIgualFecha(
				DaoConstants.T1_MINUSCULA + DaoConstants.SIGNO_PUNTO + "FECHA_INICIO_0C6", DaoConstants.DDMMYY,
				bean.getFechaInicioHasta(), params));

		where.append(SqlUtils.generarWhereMayorIgualFecha(
				DaoConstants.T1_MINUSCULA + DaoConstants.SIGNO_PUNTO + "FECHA_FIN_PREVISTA_0C6", DaoConstants.DDMMYY,
				bean.getFechaFinPrevistaDesde(), params));
		where.append(SqlUtils.generarWhereMenorIgualFecha(
				DaoConstants.T1_MINUSCULA + DaoConstants.SIGNO_PUNTO + "FECHA_FIN_PREVISTA_0C6", DaoConstants.DDMMYY,
				bean.getFechaFinPrevistaHasta(), params));


		Map<String, Object> mapWhere = new HashMap<String, Object>();
		mapWhere.put("query", where);
		mapWhere.put("params", params);
		return where.toString();

	}

	@Override
	protected String getWhereLike(OtrosTrabajos bean, Boolean startsWith, List<Object> params, Boolean search) {
		StringBuilder where = new StringBuilder(OtrosTrabajosDaoImpl.STRING_BUILDER_INIT);

		where.append(SqlUtils.generarWhereIgual("t1.ID_TRABAJO_0C6", bean.getIdTrabajo(), params));

		where.append(SqlUtils.generarWhereLikeNormalizado("t1.DESC_TRABAJO_0C6", bean.getDescTrabajo(), params, false));

		where.append(SqlUtils.generarWhereMayorIgualFecha(
				DaoConstants.T1_MINUSCULA + DaoConstants.SIGNO_PUNTO + "FECHA_INICIO_0C6", DaoConstants.DDMMYY,
				bean.getFechaInicioDesde(), params));
		where.append(SqlUtils.generarWhereMenorIgualFecha(
				DaoConstants.T1_MINUSCULA + DaoConstants.SIGNO_PUNTO + "FECHA_INICIO_0C6", DaoConstants.DDMMYY,
				bean.getFechaInicioHasta(), params));

		where.append(SqlUtils.generarWhereMayorIgualFecha(
				DaoConstants.T1_MINUSCULA + DaoConstants.SIGNO_PUNTO + "FECHA_FIN_PREVISTA_0C6", DaoConstants.DDMMYY,
				bean.getFechaFinPrevistaDesde(), params));
		where.append(SqlUtils.generarWhereMenorIgualFecha(
				DaoConstants.T1_MINUSCULA + DaoConstants.SIGNO_PUNTO + "FECHA_FIN_PREVISTA_0C6", DaoConstants.DDMMYY,
				bean.getFechaFinPrevistaHasta(), params));

		if (!StringUtils.isEmpty(bean.getIndicadorEstado())){
			if (bean.getIndicadorEstado().equals(FiltroEstadoTrabajoEnum.TRABAJOS_ABIERTOS.getValue())) {
				where.append(" AND FECHA_FIN_0C6 is NULL");
			}else {
				where.append(" AND FECHA_FIN_0C6 is NOT NULL");
			}
		}


		if (bean.getFilterTarea()!= null) {
			//hay filtro por tareas
			where.append(" AND (SELECT COUNT(1) FROM AA79BC7S01 WHERE 1=1");
			where.append(" AND t1.ID_TRABAJO_0C6 = ID_TRABAJO_0C7");
			where.append(SqlUtils.generarWhereIgual("ID_TIPO_TAREA_0C7", bean.getFilterTarea().getTipoTarea(), params));

			if (bean.getFilterTarea().getPersonaAsignada()!= null) {
				where.append(SqlUtils.generarWhereIgual("DNI_RECURSO_0C7 ", bean.getFilterTarea().getPersonaAsignada().getDni(), params));
			}
			if (bean.getFilterTarea().getTieneSinAsignar()!=null) {
				if (bean.getFilterTarea().getTieneSinAsignar().equals(Constants.SI)) {
					where.append(" AND ESTADO_ASIGNACION_0C7 = ").append(EstadoAceptacionTareaEnum.PENDIENTE_ASIGNACION.getValue());
				}else {
					where.append(" AND ESTADO_ASIGNACION_0C7 <> ").append(EstadoAceptacionTareaEnum.PENDIENTE_ASIGNACION.getValue());
				}
			}
			if (bean.getFilterTarea().getTieneSinEjecutar()!=null) {
				if (bean.getFilterTarea().getTieneSinEjecutar().equals(Constants.SI)) {
					where.append(" AND ESTADO_EJECUCION_0C7 = ").append(EstadoEjecucionTareaEnum.PENDIENTE_EJECUCION.getValue());
				}else {
					where.append(" AND ESTADO_EJECUCION_0C7 <> ").append(EstadoEjecucionTareaEnum.PENDIENTE_EJECUCION.getValue());
				}
			}
			where.append(") > 0");
		}


		Map<String, Object> mapWhere = new HashMap<String, Object>();
		mapWhere.put("query", where);
		mapWhere.put("params", params);

		return where.toString();
	}


	@Override
	public Integer comprobarTieneTareasAsociadas(OtrosTrabajos otrosTrabajos) {
		StringBuilder queryCESBN = new StringBuilder();
		List<Object> paramsCESBN = new ArrayList<Object>();
		queryCESBN.append(" SELECT COUNT(1) ");
		queryCESBN.append(" FROM AA79BC7S01 t1 ");
		queryCESBN.append("WHERE ID_TRABAJO_0C7 = ?");
		paramsCESBN.add(otrosTrabajos.getIdTrabajo());
		return this.getJdbcTemplate().queryForObject(queryCESBN.toString(), Integer.class, paramsCESBN.toArray());
	}

	@Override
	public void eliminarFechaFinOtroTrabajoTarea(BigDecimal idTarea) {
		String query = "UPDATE AA79BC6S01 SET FECHA_FIN_0C6= NULL WHERE ID_TRABAJO_0C6= (SELECT ID_TRABAJO_0C7 FROM AA79BC7S01 WHERE ID_TAREA_0C7 = ?)";
		this.getJdbcTemplate().update(query, idTarea);
	}

	@Override
	public Integer llamarPLClonarTrabajo(final OtrosTrabajos otrosTrabajos) {

		return this.getJdbcTemplate().execute(new CallableStatementCreator() {
			@Override()
			public CallableStatement createCallableStatement(Connection connection) throws SQLException {
				CallableStatement callableStatement = connection
						.prepareCall("{? = call CLONAR_TRABAJO(?)}");
				callableStatement.registerOutParameter(1, Types.NUMERIC);
				callableStatement.setBigDecimal(2, otrosTrabajos.getIdTrabajo());
				return callableStatement;
			}
		}, new CallableStatementCallback<Integer>() {
			@Override
			public Integer doInCallableStatement(CallableStatement cs) throws SQLException {
				cs.execute();
				return cs.getInt(1);
			}
		});
	}

	/**
	 * Mét odo para buscar los trabajos para generar el excel
	 */
	@Override
	public List<OtrosTrabajos> getTrabajosExcelDetalle(OtrosTrabajos otrosTrabajos) {

		List<Object> params = new ArrayList<Object>();
		StringBuilder select = new StringBuilder(PagamentosDaoImpl.STRING_BUILDER_INIT);
		select.append(getSelect());
		select.append(getFrom());
		select.append(GenericoDaoImpl.DEFAULT_WHERE);
		select.append(this.getWhereLike(otrosTrabajos, false, params, false));
		select.append(" ORDER BY t1.ID_TRABAJO_0C6");

		return this.getJdbcTemplate().query(select.toString(), this.rwMap, params.toArray());

	}

	/**
	 * Mét odo para buscar los trabajos para generar el excel
	 */
	@Override
	public String getTrabajosExcelDetalleQuery(OtrosTrabajos otrosTrabajos, List<Object> params) {
		StringBuilder select = new StringBuilder(PagamentosDaoImpl.STRING_BUILDER_INIT);
		select.append("SELECT t1.ID_TRABAJO_0C6 ");
		select.append(getFrom());
		select.append(GenericoDaoImpl.DEFAULT_WHERE);
		select.append(this.getWhereLike(otrosTrabajos, false, params, false));
		return select.toString();

	}

	@Override
	public OtrosTrabajos buscarTrabajo(OtrosTrabajos otrosTrabajos) {
		StringBuilder select = new StringBuilder();
		select.append(this.getSelect());
		select.append(", t2.TAREAS_CERRADAS TAREASCERRADAS");
		select.append(this.getFrom());
		select.append(" LEFT JOIN (SELECT ID_TRABAJO_0C7, CASE WHEN COUNT(ID_TAREA_0C7) = SUM(CASE WHEN ESTADO_EJECUCION_0C7 = "
				+ EstadoEjecucionTareaEnum.EJECUTADA.getValue() + " THEN 1 ELSE 0 END) THEN 'S' ELSE 'N' END AS TAREAS_CERRADAS "
				+ "FROM AA79BC7S01 GROUP BY ID_TRABAJO_0C7) t2 ON t2.ID_TRABAJO_0C7 = t1.ID_TRABAJO_0C6 ");
		List<Object> params = new ArrayList<Object>();
		select.append(this.getWherePK(otrosTrabajos, params));
		return DataAccessUtils.uniqueResult(this.getJdbcTemplate().query(select.toString(), this.rwMapBuscarTrabajo, params.toArray()));
	}

}
