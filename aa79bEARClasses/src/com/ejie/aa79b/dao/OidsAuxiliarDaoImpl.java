package com.ejie.aa79b.dao;

import java.util.List;

import javax.annotation.Resource;
import javax.sql.DataSource;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.dao.DataAccessException;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

/**
 * DocumentoTareaDaoImpl generated by UDA, 14-Jul-18 15:23:30.
 * 
 * @author javarona
 */

@Repository()
@Transactional()
public class OidsAuxiliarDaoImpl implements OidsAuxiliarDao {

	private JdbcTemplate jdbcTemplate;

	protected static final String ID_018 = "ID_018";
	private static final Logger LOGGER = LoggerFactory.getLogger(OidsAuxiliarDaoImpl.class);

	/**
	 * @return JdbcTemplate
	 */
	public JdbcTemplate getJdbcTemplate() {
		return this.jdbcTemplate;
	}

	/**
	 * Method use to set the datasource.
	 *
	 * @param dataSource
	 *            DataSource
	 * @return
	 */
	@Resource()
	public void setDataSource(DataSource dataSource) {
		this.jdbcTemplate = new JdbcTemplate(dataSource);
	}

	@Override()
	public void add(String nuevoOID) {

		// CONTROLAR CON TRY/CATCH la excepción de "clave primaria duplicada"
		// por si acaso????
		try {
			String query = "INSERT INTO AA79BA0S01 (OID_0A0, FECHA_0A0) VALUES (?,SYSDATE)";
			this.jdbcTemplate.update(query, nuevoOID);
		} catch (DataAccessException e) {
			OidsAuxiliarDaoImpl.LOGGER.info("en OidsAuxiliarDao", e);
			if (e.getLocalizedMessage().contains("ORA-00001")) {
				OidsAuxiliarDaoImpl.LOGGER.info("Clave duplicada, el oid ya está en la tabla de borrado");
			}

		}
	}

	@Override()
	public void remove(String oid) {
		String query = "DELETE FROM AA79BA0S01 WHERE OID_0A0=?";
		this.getJdbcTemplate().update(query, oid);
	}

	@Override()
	public void removeOids24h() {
		String query = "DELETE FROM AA79BA0S01 WHERE FECHA_0A0 < SYSDATE - 1";
		this.getJdbcTemplate().update(query);
	}

	@Override()
	public List<String> getOids24h() {
		StringBuilder query = new StringBuilder();
		query.append("SELECT * FROM AA79BA0S01 WHERE FECHA_0A0 < SYSDATE - 1");
		return this.getJdbcTemplate().queryForList(query.toString(), String.class);

	}
}