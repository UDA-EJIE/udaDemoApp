/*! For license information please see rup.form.js.LICENSE.txt */
!function(e){"function"==typeof define&&define.amd?define(["jquery","./core/utils/jquery.form","./core/utils/form2object","./rup.base","./rup.validate","./rup.message"],e):e(jQuery)}((function(e){$.extend($.rup.iniRup,$.rup.rupSelectorObjectConstructor("rup_form",{})),$.fn.rup_form("extend",{ajaxFormSubmit:function(e){$.set_uda_ajax_mode_on(),this.ajaxSubmit(e)},ajaxSubmit:function(e){var t=this,r=$.extend(!0,{},$.fn.rup_form.defaults,e);$.set_uda_ajax_mode_on(),t.rup_form("configureOptions",r),r.formValidationRequired?(t.rup_validate(r.validate),t.valid()&&$(this).ajaxSubmit(r)):$(this).ajaxSubmit(r)},ajaxNotSubmit:function(e){var t=this,r=$.extend(!0,{},$.fn.rup_form.defaults,e);$.set_uda_ajax_mode_on(),t.rup_form("configureOptions",r),r.formValidationRequired?(t.submit(),t.valid()&&$(this).ajaxSubmit(r)):$(this).ajaxSubmit(r)},destroy:function(){var e=this;e.removeClass("rup_form"),$.removeData(e[0]),e.ajaxFormUnbind(),e.off()},formSerialize:function(){var e,t,r=[];return $.each(this.formToArray(),(function(a,i){e=$("[name='"+i.name+"']",self),void 0!==(t=e.attr("ruptype"))?(i.value=e["rup_"+t]("getRupValue"),r.push(i)):r.push(i)})),$.param(r)},formToJson:function(){return this[0]?window.form2object(this[0]):{}},fieldSerialize:function(){var e=[];return this.each((function(){var t=$(this).attr("name");if(t){var r=$(this).rup_form("fieldValue");if(r&&r.constructor==Array)for(var a=0,i=r.length;a<i;a++)e.push({name:t,value:r[a]});else null!=r&&e.push({name:$(this).attr("name"),value:r})}})),$.param(e)},fieldValue:function(){var e,t=[];return this.each((function(){var r=$(this).attr("ruptype");void 0!==r?(e=$(this)["rup_"+r]("getRupValue"),t.push(e)):$.merge(t,$(this).fieldValue())})),t},resetForm:function(){return $("#"+$.escapeSelector($(this).attr("id"))+" select").each((function(e,t){"select"==$(t).attr("ruptype")&&$(t).rup_select("clear")})),this.each((function(){$(this).resetForm()}))},clearForm:function(e){return this.each((function(){$("input,select,textarea",this).rup_form("clearFields",e)}))},clearFields:function(e){return this.each((function(){const t=$(this).attr("ruptype");void 0===t||"select"!==t?$(this).clearFields(e):"select"===t&&$(this).rup_select("clear")}))},configureOptions:function(t){var r,a,i,u=this;null!==t.url&&u.attr("action",t.url),r=$("input[type=file]:enabled",u).length>0,t.useJsonIfPossible&&!r?t.contentType="application/json":t.contentType="multipart/form-data",a=t.beforeSend,t.beforeSend=function(e,r){var i=!0;if("function"==typeof a&&(i=a.call(this,e,r)),!1===i)return!1;if("skip"!==i&&!1!==r.contentType&&-1!==r.contentType.indexOf("application/json")){var n=u.rup_form("formToJson");null!==t.multimodel&&(e.setRequestHeader("RUP_MULTI_ENTITY","true"),n.rupEntityMapping=t.multimodel),void 0!==r.extraData&&null!==r.extraData&&$.extend(n,r.extraData),r.data=$.toJSON(n)}},i=t.beforeSubmit,t.beforeSubmit=function(r,a,u){var n,o,s;if("function"==typeof i&&!1===i.call(this,r,a,u))return!1;s=e("input:file",a).length>0,(!$.rup.browser.xhrFileUploadSupport&&s||!0===u.iframe)&&(n=void 0!==t.type?t.type:u.type,-1===$.inArray(n.toUpperCase(),$.rup.IFRAME_ONLY_SUPPORTED_METHODS)&&(u.extraData=$.extend({},u.extraData,{_method:n.toUpperCase()})),u.url=$.rup_utils.setNoPortalParam(u.url),u.extraData=$.extend({},u.extraData,{_emulate_iframe_http_status:"true"}),u.url=u.url+(null===u.url.match("\\?")?"?":"&")+"_emulate_iframe_http_status=true",o=u.error,u.error=function(e,t,r){var a=$.rup.rupAjaxDefaultError(e,t,r);null!=o?$(o(e,t,r)):a&&$.rup.showErrorToUser(a)})},t.formValidationRequired=void 0!==t.validate,t.formValidationRequired&&(void 0===t.error&&(t.error=function(e){try{var t=JSON.parse(e.responseText);u.validate().invalid=t.rupErrorFields,u.validate().submited=t.rupErrorFields,u.validate().showErrors(t.rupErrorFields),void 0!==t.rupFeedback&&void 0!==u.validate().settings.feedback&&u.validate().settings.feedback.rup_feedback("set",$.rup_utils.printMsg(t.rupFeedback.message),void 0!==t.rupFeedback.style?t.rupFeedback.style:null)}catch(t){u.validate().settings.feedback.rup_feedback("set",e.responseText,"error")}}),t.validate.submitHandler=function(t){e(t).ajaxSubmit($(t).data("ajaxSettings"))},t.validate.feedback=t.feedback),u.data("ajaxSettings",t),u.data("settings",t)}}),$.fn.rup_form("extend",{}),$.fn.rup_form("extend",{_init:function(e){global.initRupI18nPromise.then((()=>{var t,r=this;t=$.extend(!0,{},$.fn.rup_form.defaults,e[0]),r.addClass("rup_form"),r.attr("ruptype","form"),r.rup_form("configureOptions",t),t.formValidationRequired?r.rup_validate(t.validate):r.ajaxForm(t)})).catch((e=>{console.error("Error al inicializar el componente:\n",e)}))}}),$.fn.rup_form.defaults={ajaxForm:null,feedback:null,multimodel:null,useJsonIfPossible:!0}}));