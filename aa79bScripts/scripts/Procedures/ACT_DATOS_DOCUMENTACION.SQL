CREATE OR REPLACE PROCEDURE ACT_DATOS_DOCUMENTACION (
   ANYO IN   NUMBER,
   CORR_EXP IN NUMBER
)
IS

NUM_PALABRAS NUMBER(6):= null;
FECHA_FINAL DATE:= sysdate;
IND_FACTURABLE VARCHAR2(1):= 'N';
ID_RELEVANCIA NUMBER(2):= null;
IND_URGENTE VARCHAR2(1):= 'N';
PRIORIDAD_RELEVANCIA NUMBER(2):=0;

TIPO_INTERPRETACION VARCHAR2(1):= 'I';
TIPO_TRADUCCION VARCHAR2(1):= 'T';
TIPO_REVISION VARCHAR2(1):= 'R';

CLASE_TRADUCCION NUMBER(2):= 1;
CLASE_REVISION NUMBER(2):= 2;

IND_PRESUPUESTO VARCHAR2(1);
IND_BOPV VARCHAR2(1);
IND_VIP VARCHAR2(1);
TIPO_EXPEDIENTE VARCHAR2(1);

ESTADO_EN_CURSO NUMBER(2):=3;
ESTADO_EXPEDIENTE NUMBER(2);

CURSOR C_DOCUMENTOS IS
(SELECT ID_DOC_056, NUM_PAL_IZO_056, TIPO_DOCUMENTO_056, ID_TIPO_RELEVANCIA_042, IND_FACTURABLE_042, IND_CONFIDENCIAL_042, IND_RECARGO_URGENCIA_042, PRIORIDAD_010
FROM AA79B56S01, AA79B42S01, AA79B10S01 WHERE TIPO_DOCUMENTO_056 = ID_042
AND ID_TIPO_RELEVANCIA_042 = ID_TIPO_RELEVANCIA_010
AND ANYO_056 = ANYO AND NUM_EXP_056 = CORR_EXP
AND CLASE_DOCUMENTO_056 in (CLASE_TRADUCCION, CLASE_REVISION) AND ID_DOC_VERSION_056 is null AND ID_DOC_REL_056 is null);

BEGIN
   	
	SELECT ID_TIPO_EXPEDIENTE_051, ID_ESTADO_EXP_059 INTO TIPO_EXPEDIENTE, ESTADO_EXPEDIENTE FROM AA79B51T00 
	JOIN AA79B59T00 ON ANYO_051 = ANYO_059 AND NUM_EXP_051 = NUM_EXP_059
	AND ESTADO_BITACORA_051 = ID_ESTADO_BITACORA_059
	WHERE ANYO_051 = ANYO AND NUM_EXP_051 = CORR_EXP;
	
		SELECT IND_VIP_054 INTO IND_VIP FROM AA79B54T00 WHERE ANYO_054 = ANYO AND NUM_EXP_054 = CORR_EXP;
		-- MIRAR SI ES DE BOLETIN PARA PONER EL IND FACTURABLE A N
		SELECT IND_PUBLICAR_BOPV_053, IND_PRESUPUESTO_053 INTO IND_BOPV, IND_PRESUPUESTO 
		FROM AA79B53T00 WHERE ANYO_053 = ANYO AND NUM_EXP_053 = CORR_EXP;
		
		FOR R_DOCUMENTOS IN C_DOCUMENTOS LOOP
			IF (R_DOCUMENTOS.NUM_PAL_IZO_056 is not null) THEN
				NUM_PALABRAS:= nvl(NUM_PALABRAS,0) + R_DOCUMENTOS.NUM_PAL_IZO_056;
			END IF;
			IF ((TIPO_EXPEDIENTE = TIPO_REVISION AND IND_BOPV = 'N') OR (TIPO_EXPEDIENTE = TIPO_TRADUCCION)) THEN
				IF (R_DOCUMENTOS.IND_FACTURABLE_042 = 'S') THEN
					IND_FACTURABLE:= 'S';
				END IF; 
			END IF;
			IF (R_DOCUMENTOS.IND_RECARGO_URGENCIA_042 = 'S') THEN
				IND_URGENTE:= 'S';
			END IF; 
			IF (PRIORIDAD_RELEVANCIA = 0) THEN
				PRIORIDAD_RELEVANCIA:= R_DOCUMENTOS.PRIORIDAD_010;
				ID_RELEVANCIA:= R_DOCUMENTOS.ID_TIPO_RELEVANCIA_042;
			ELSE
				IF (PRIORIDAD_RELEVANCIA > R_DOCUMENTOS.PRIORIDAD_010) THEN
					PRIORIDAD_RELEVANCIA:= R_DOCUMENTOS.PRIORIDAD_010;
					ID_RELEVANCIA:= R_DOCUMENTOS.ID_TIPO_RELEVANCIA_042;
				END IF;
			END IF;
		END LOOP;
		IF (NUM_PALABRAS is null OR NUM_PALABRAS = 0) THEN
			FECHA_FINAL:= null;
		ELSE
			FECHA_FINAL:= OBTENER_PLAZO_MINIMO_ENTREGA (TIPO_EXPEDIENTE, NUM_PALABRAS, IND_PRESUPUESTO, IND_VIP);
		END IF;	
		
		IF (ESTADO_EXPEDIENTE <> ESTADO_EN_CURSO) THEN
			UPDATE AA79B53T00 set NUM_TOTAL_PAL_IZO_053 = NUM_PALABRAS, IND_FACTURABLE_053 = IND_FACTURABLE, IND_URGENTE_053 = IND_URGENTE,
			ID_RELEVANCIA_053 = ID_RELEVANCIA, FECHA_FINAL_PROP_053 = FECHA_FINAL
			WHERE ANYO_053 = ANYO AND NUM_EXP_053 = CORR_EXP;
			
		ELSE
			UPDATE AA79B53T00 set NUM_TOTAL_PAL_IZO_053 = NUM_PALABRAS	WHERE ANYO_053 = ANYO AND NUM_EXP_053 = CORR_EXP;
		END IF;
	
END;
/