create or replace PROCEDURE ASOCIAR_DOC_A_ENTREGA( ANYO IN NUMBER, NUM_EXP IN NUMBER, DOC_ID IN NUMBER) IS

ID_TAREA_SELECCIONADA NUMBER(20):= 0;
ESTADO_TAREA_EJECUTADA NUMBER(1):= 3;
EXISTE_ENTRADA_083 NUMBER(1):= 0;

BEGIN
    --Buscamos la tarea de entrega (o corredaccion)
    -- Que esté asignada y no ejecutada?
    BEGIN
        SELECT ID_TAREA_081 INTO ID_TAREA_SELECCIONADA FROM AA79B81T00
        WHERE ANYO_081 = ANYO AND NUM_EXP_081 = NUM_EXP AND ID_TIPO_TAREA_081 IN (3, 19, 20) AND ESTADO_EJECUCION_081 <> ESTADO_TAREA_EJECUTADA AND IND_NO_CONFORMIDAD_081 = 'N';
    EXCEPTION
    WHEN NO_DATA_FOUND THEN
        ID_TAREA_SELECCIONADA := 0;
    END;
    -- Si hay tarea asignada, busco la entrada del doc y tarea en T83
    IF ( ID_TAREA_SELECCIONADA > 0) THEN    
        SELECT COUNT(1) INTO EXISTE_ENTRADA_083 FROM AA79B83T00
        WHERE ID_TAREA_083 = ID_TAREA_SELECCIONADA AND ID_DOC_083 = DOC_ID;
        -- Si no existe entrada en T83, hago la insert
        IF (EXISTE_ENTRADA_083 = 0) THEN
            INSERT INTO AA79B83T00 (ID_TAREA_083,ID_DOC_083) VALUES ( ID_TAREA_SELECCIONADA, DOC_ID );
        END IF;          
    END IF;    

END;
/