CREATE OR REPLACE PROCEDURE ACT_DATOS_PAGO_PROV (
   ID_TAREA IN NUMBER, 
   IND_FORMATO IN VARCHAR2, 
   PAL_FORMATO IN NUMBER,  
   IND_APREMIO IN VARCHAR2, 
   POR_APREMIO IN NUMBER, 
   IND_PENALIZACION IN VARCHAR2, 
   POR_PENALIZACION IN NUMBER,
   NIVEL_CALIDAD IN VARCHAR2
)
IS

ANYO NUMBER(4);
NUMEXP NUMBER(6);
TIPOTAREA NUMBER(2);
IDLOTE NUMBER(6);
TAREAREVPAGOPROVEEDORES NUMBER(20);
IVA NUMBER(3);
NUMTOTALPAL56 NUMBER(6,0);
NUMTOTALPAL91 NUMBER(6);
NUMPALCONCOR084 NUMBER(6);
NUMPALCONCOR8594 NUMBER(6);
NUMPALCONCOR95100 NUMBER(6);
POR_REVISION_FINAL NUMBER(3);
NUMPALIZO NUMBER(6);
NUM_TOTAL_PAL NUMBER(6);
POR_PENALIZACION_CALIDAD NUMBER(3);

IT NUMBER(8,2);
IFOR NUMBER(8,2);
IA NUMBER(8,2);
IR NUMBER(8,2);
ITP NUMBER(9,2);
IMPIVA NUMBER(8,2);
IBP NUMBER(8,2);
IC NUMBER(8,2);

EXISTETAREA NUMBER(1);
IND_ALBARAN VARCHAR2(1);

TAREA_TRADOS NUMBER(1):=  1;
TAREA_TRADUCIR NUMBER(1):=  2;
TAREA_REVISAR NUMBER(1):=  4;
TAREA_PAGO_PROV NUMBER(2):=  11;
REVISAR_TRADUCCION NUMBER(2):=  21;
ENTREGA_CLIENTE_REVISION NUMBER(2):=  20;

TYPE r_reg_provdataforupdate IS RECORD (
	IMPORTE_TAREA_094 NUMBER(8,2),
	IMPORTE_RECARGO_FORMATO_094	NUMBER(8,2),
	IMPORTE_RECARGO_APREMIO_094	NUMBER(8,2)
);
PROVFORUPDATE r_reg_provdataforupdate;

TYPE r_reg_proveedores IS RECORD (
	NUM_TOTAL_PAL_094 NUMBER(6),
	NUM_PAL_CONCOR_0_84_094	NUMBER(6),
	NUM_PAL_CONCOR_85_94_094 NUMBER(6),
	NUM_PAL_CONCOR_95_100_094 NUMBER(6),
	IND_RECARGO_FORMATO_094	VARCHAR2(1),
	NUM_PAL_RECARGO_FORMATO_094	NUMBER(6),
	IND_RECARGO_APREMIO_094	VARCHAR2(1),
	POR_RECARGO_APREMIO_094	NUMBER(3),
	IND_PENALIZACION_094 VARCHAR2(1),
	POR_PENALIZACION_094 NUMBER(3),
	IVA_APLIC_094 NUMBER(3),
	IMPORTE_PAL_APLIC_094 NUMBER(6,5),
	POR_REVISION_APLIC_094 NUMBER(3),
	IMPORTE_TAREA_094 NUMBER(8,2),
	IMPORTE_RECARGO_FORMATO_094	NUMBER(8,2),
	IMPORTE_RECARGO_APREMIO_094	NUMBER(8,2),
	IMPORTE_PENALIZACION_094 NUMBER(8,2),
	IMPORTE_BASE_094 NUMBER(8,2),
	IMPORTE_IVA_094	NUMBER(8,2),
	IMPORTE_TOTAL_094 NUMBER(9,2),
	IND_PAGADO_094 VARCHAR2(1),
	IND_ALBARAN_094	VARCHAR2(1),
	COD_ALBARAN_094	NUMBER(10)
);
PROVEEDORES r_reg_proveedores;

TYPE r_reg_lote IS RECORD (
	FECHA_INICIO_029 DATE,
	FECHA_FIN_029 DATE,
	IMPORTE_ASIGNADO_029 NUMBER(9,2),
    IMPORTE_CONSUMIDO_029 NUMBER(9,2), 
	IMPORTE_PALABRA_029 NUMBER(6,5),
	POR_PAGO_PAL_CONCOR_85_94_029 NUMBER(3),
	POR_PAGO_PAL_CONCOR_95_100_029 NUMBER(3),
	POR_REVISION_029 NUMBER(3),
	POR_RECARGO_FORMATO_029	NUMBER(3),
	IND_RECARGO_APREMIO_029	VARCHAR2(1),
	POR_RECARGO_APREMIO_029	NUMBER(3),
	ID_TIPO_PENALIZACION_029 VARCHAR2(1),
	POR_PENALIZACION_029 NUMBER(3)
);
LOTE r_reg_lote;

LIM_PALABRAS_TRADOS NUMBER(6);

IDTAREAREL NUMBER(20);

		
		

BEGIN 
	-- obtenemos el limite de palabras IZO  a partir del cual se realiza presupuesto y proyecto trados
	select  PAL_TRADOS_003 into LIM_PALABRAS_TRADOS from AA79B03T00 where ID_003 = 0;
	
	SELECT ANYO_081, NUM_EXP_081, ID_TIPO_TAREA_081, ID_LOTE_081, ID_TAREA_REL_081 INTO ANYO, NUMEXP, TIPOTAREA, IDLOTE, IDTAREAREL FROM AA79B81T00 WHERE ID_TAREA_081 = ID_TAREA;
	
	SELECT POR_IVA_031 INTO IVA FROM AA79B30T00, AA79B31T00 WHERE IND_VIGOR_030 = 'S' AND ID_030 = ID_ORDEN_031;
		
	IF (TIPOTAREA = TAREA_TRADUCIR OR TIPOTAREA = TAREA_REVISAR) THEN
	
		SELECT ID_TAREA_081 INTO TAREAREVPAGOPROVEEDORES FROM AA79B81T00 WHERE ID_TAREA_REL_081 = ID_TAREA AND ID_TIPO_TAREA_081 = TAREA_PAGO_PROV;
	
    	SELECT NUM_TOTAL_PAL_IZO_053 INTO NUMPALIZO FROM AA79B51T00 JOIN AA79B53T00 ON ANYO_053 = ANYO_051 AND NUM_EXP_053 = NUM_EXP_051 WHERE ANYO_053 = ANYO AND NUM_EXP_053 = NUMEXP;
	
		SELECT FECHA_INICIO_029, FECHA_FIN_029, IMPORTE_ASIGNADO_029, IMPORTE_CONSUMIDO_029, IMPORTE_PALABRA_029, 
		POR_PAGO_PAL_CONCOR_85_94_029, POR_PAGO_PAL_CONCOR_95_100_029, POR_REVISION_029, POR_RECARGO_FORMATO_029, IND_RECARGO_APREMIO_029, 
		POR_RECARGO_APREMIO_029, ID_TIPO_PENALIZACION_029, POR_PENALIZACION_029
		INTO LOTE FROM AA79B29T00 WHERE ID_LOTE_029 = IDLOTE;
		
		SELECT NVL(SUM(t56.num_pal_izo_056),0), NVL(SUM(tr2.num_total_pal_091),0), NVL(SUM(tr2.num_pal_concor_0_84_091),0), NVL(SUM(tr2.num_pal_concor_85_94_091),0), NVL(SUM(tr2.num_pal_concor_95_100_091),0)  
		INTO NUMTOTALPAL56, NUMTOTALPAL91, NUMPALCONCOR084, NUMPALCONCOR8594, NUMPALCONCOR95100
		FROM AA79B81T00 t81 
		LEFT JOIN AA79B83T00 t83 ON t81.id_tarea_081 = t83.id_tarea_083 
		LEFT JOIN AA79B56T00 t56 ON t83.id_doc_083 = t56.id_doc_056
		LEFT JOIN AA79B81T00 tr1 ON tr1.ANYO_081 = t81.ANYO_081 AND tr1.NUM_EXP_081 = t81.NUM_EXP_081 AND tr1.ID_TIPO_TAREA_081 = TAREA_TRADOS
		LEFT JOIN AA79B91T00 tr2 ON tr1.ID_TAREA_081 = tr2.ID_TAREA_091 AND tr2.id_doc_orig_091 = t83.id_doc_083 
		WHERE t81.ID_TAREA_081 = ID_TAREA
		GROUP BY t81.id_tarea_081;
			
		IF (TAREAREVPAGOPROVEEDORES IS NOT NULL) THEN
		
			-- importeRealizacionTarea
			IF (NUMPALIZO <= LIM_PALABRAS_TRADOS) THEN
  				NUM_TOTAL_PAL := NUMPALIZO;
  				NUMTOTALPAL91:= 0;
  				NUMPALCONCOR084:= 0;
  				NUMPALCONCOR8594:= 0; 
  				NUMPALCONCOR95100:= 0;
			ELSE
				IF (NUMTOTALPAL91 = 0) THEN
					NUM_TOTAL_PAL := NUMPALIZO;
				ELSE
					NUM_TOTAL_PAL := NUMTOTALPAL91;
				END IF;
			END IF;
		
			IF (TIPOTAREA = TAREA_TRADUCIR) THEN
				IF (NUM_TOTAL_PAL != 0 AND NUMPALCONCOR084 = 0 AND NUMPALCONCOR8594 = 0 AND NUMPALCONCOR95100 = 0) THEN
					IT := NUM_TOTAL_PAL * LOTE.IMPORTE_PALABRA_029;
				ELSE
					IT := (NUMPALCONCOR084 * LOTE.IMPORTE_PALABRA_029) + (NUMPALCONCOR8594 * LOTE.IMPORTE_PALABRA_029 * (LOTE.POR_PAGO_PAL_CONCOR_85_94_029/100)) + (NUMPALCONCOR95100 * LOTE.IMPORTE_PALABRA_029 * (LOTE.POR_PAGO_PAL_CONCOR_95_100_029/100));
				END IF;
				POR_REVISION_FINAL := 0;
			ELSE
				IT := NUM_TOTAL_PAL * LOTE.IMPORTE_PALABRA_029 * (LOTE.POR_REVISION_029/100);
				POR_REVISION_FINAL := LOTE.POR_REVISION_029;
			END IF;
			
			--importeRecargoFormato
			IFOR := PAL_FORMATO * LOTE.IMPORTE_PALABRA_029 * (LOTE.POR_RECARGO_FORMATO_029/100);
			
			--importeRecargoApremio
			IA := IT * (POR_APREMIO/100);
			
			--importePenalizacionRetraso
			IR := (IT) * (0/100);
			
			--importeTotalPagar
			ITP := (IT + IFOR + IA) - IR;
						
			--importeBasePagar
			IBP := ITP * 100/(100 + IVA);
			
			--importeCorrespondienteIVA
			IMPIVA := ITP - IBP;
	
			SELECT COUNT(1) INTO EXISTETAREA FROM AA79B94T00 WHERE ID_TAREA_094 = TAREAREVPAGOPROVEEDORES;
			
			IF (EXISTETAREA > 0) THEN
				
				UPDATE AA79B94T00 SET NUM_TOTAL_PAL_094 = NUM_TOTAL_PAL,
				NUM_PAL_CONCOR_0_84_094 = NUMPALCONCOR084,
				NUM_PAL_CONCOR_85_94_094 = NUMPALCONCOR8594,
				NUM_PAL_CONCOR_95_100_094 = NUMPALCONCOR95100,
				IND_RECARGO_FORMATO_094 = IND_FORMATO,
				NUM_PAL_RECARGO_FORMATO_094 = PAL_FORMATO,
				IND_RECARGO_APREMIO_094 = IND_APREMIO,
				POR_RECARGO_APREMIO_094 = POR_APREMIO,
				IVA_APLIC_094 = IVA,
				POR_REVISION_APLIC_094 =POR_REVISION_FINAL,
				IMPORTE_PAL_APLIC_094 = LOTE.IMPORTE_PALABRA_029,
				IMPORTE_TAREA_094 = IT,  
				IMPORTE_RECARGO_FORMATO_094 = IFOR,  
				IMPORTE_RECARGO_APREMIO_094 = IA, 
				IMPORTE_PENALIZACION_094 = IR,  
				IMPORTE_BASE_094 = IBP, 
				IMPORTE_IVA_094 = IMPIVA,  
				IMPORTE_TOTAL_094 = ITP 
				WHERE ID_TAREA_094 = TAREAREVPAGOPROVEEDORES;
			
			ELSE
			
				INSERT INTO AA79B94T00 (
				ID_TAREA_094,
				NUM_TOTAL_PAL_094,
				NUM_PAL_CONCOR_0_84_094,
				NUM_PAL_CONCOR_85_94_094,
				NUM_PAL_CONCOR_95_100_094,
				IND_RECARGO_FORMATO_094,
				NUM_PAL_RECARGO_FORMATO_094,
				IND_RECARGO_APREMIO_094,
				POR_RECARGO_APREMIO_094,
				IVA_APLIC_094,
				POR_REVISION_APLIC_094,
				IMPORTE_PAL_APLIC_094,
				IMPORTE_TAREA_094,  
				IMPORTE_RECARGO_FORMATO_094,  
				IMPORTE_RECARGO_APREMIO_094, 
				IMPORTE_PENALIZACION_094,  
				IMPORTE_BASE_094, 
				IMPORTE_IVA_094,  
				IMPORTE_TOTAL_094) VALUES (
				TAREAREVPAGOPROVEEDORES,
				NUM_TOTAL_PAL,
				NUMPALCONCOR084,
				NUMPALCONCOR8594,
				NUMPALCONCOR95100,
				IND_FORMATO,
				PAL_FORMATO,
				IND_APREMIO,
				POR_APREMIO,
				IVA,
				POR_REVISION_FINAL,
				LOTE.IMPORTE_PALABRA_029,
				IT,  
				IFOR,  
				IA, 
				IR,  
				IBP, 
				IMPIVA,  
				ITP);
				
			END IF;
		
		END IF;
		
	ELSE IF (TIPOTAREA = REVISAR_TRADUCCION) THEN
	
		SELECT ID_TAREA_081 INTO TAREAREVPAGOPROVEEDORES FROM AA79B81T00 
		WHERE ID_TIPO_TAREA_081 = TAREA_PAGO_PROV AND ID_TAREA_REL_081 = IDTAREAREL;
		
		SELECT IMPORTE_TAREA_094,
		IMPORTE_RECARGO_FORMATO_094,
		IMPORTE_RECARGO_APREMIO_094
		INTO PROVFORUPDATE
		FROM AA79B94T00
		WHERE ID_TAREA_094 = TAREAREVPAGOPROVEEDORES;
		
		IT := PROVFORUPDATE.IMPORTE_TAREA_094;
		IFOR := PROVFORUPDATE.IMPORTE_RECARGO_FORMATO_094;
		IA := PROVFORUPDATE.IMPORTE_RECARGO_APREMIO_094;
		
		--importePenalizacionRetraso
		IR := (IT) * (POR_PENALIZACION/100);
		
		--importeTotalPagar
		ITP := (IT + IFOR + IA) - IR;
				
		--importeBasePagar
		IBP := ITP * 100/(100 + IVA);
		
		--importeCorrespondienteIVA
		IMPIVA := ITP - IBP;
		
		UPDATE AA79B94T00 SET 
		IND_PENALIZACION_094 = IND_PENALIZACION,
		POR_PENALIZACION_094 = POR_PENALIZACION,
		IMPORTE_PENALIZACION_094 = IR,  
		IMPORTE_BASE_094 = IBP, 
		IMPORTE_IVA_094 = IMPIVA,  
		IMPORTE_TOTAL_094 = ITP
		WHERE ID_TAREA_094 = TAREAREVPAGOPROVEEDORES;
		
    	IF (NIVEL_CALIDAD IS NOT NULL) THEN
			SELECT POR_PENALIZACION_0B5 INTO POR_PENALIZACION_CALIDAD FROM AA79BB5T00 WHERE NIVEL_0B5 = NIVEL_CALIDAD AND ESTADO_0B5 = 'A';	
			
			--importePenalizacionCalidad
			IC := ROUND((IT) * (POR_PENALIZACION_CALIDAD/100),2);
			
			--importeTotalPagar
			ITP := (IT + IFOR + IA) - IR - IC;
					
			--importeBasePagar
			IBP := ITP * 100/(100 + IVA);
			
			--importeCorrespondienteIVA
			IMPIVA := ITP - IBP;
			
			UPDATE AA79B94T00 SET 
			NIVEL_CALIDAD_094 = NIVEL_CALIDAD,
			POR_PENAL_CALIDAD_094 = POR_PENALIZACION_CALIDAD,
			IMP_PENAL_CALIDAD_094 = IC,
			IMPORTE_BASE_094 = IBP, 
			IMPORTE_IVA_094 = IMPIVA,  
			IMPORTE_TOTAL_094 = ITP
			WHERE ID_TAREA_094 = TAREAREVPAGOPROVEEDORES;
		END IF;
	
	ELSE IF (TIPOTAREA = ENTREGA_CLIENTE_REVISION) THEN
	
		SELECT ID_TAREA_081 INTO TAREAREVPAGOPROVEEDORES FROM AA79B81T00 
		WHERE ID_TAREA_REL_081 = (Select tareaRev.ID_TAREA_081 FROM AA79B81T00 tareaEntr
		JOIN AA79B81T00 tareaRev ON tareaRev.ANYO_081 = tareaEntr.ANYO_081 AND 
		tareaRev.NUM_EXP_081 = tareaEntr.NUM_EXP_081 AND tareaRev.ID_TIPO_TAREA_081 = TAREA_REVISAR AND 
		tareaRev.ORDEN_081 < tareaEntr.ORDEN_081 
		WHERE tareaEntr.ID_TAREA_081 = ID_TAREA 
		ORDER BY tareaRev.ORDEN_081 DESC FETCH first 1 ROWS ONLY 
		)  AND ID_TIPO_TAREA_081 = TAREA_PAGO_PROV; 

		SELECT IMPORTE_TAREA_094,
		IMPORTE_RECARGO_FORMATO_094,
		IMPORTE_RECARGO_APREMIO_094
		INTO PROVFORUPDATE
		FROM AA79B94T00
		WHERE ID_TAREA_094 = TAREAREVPAGOPROVEEDORES;
		
		IT := PROVFORUPDATE.IMPORTE_TAREA_094;
		IFOR := PROVFORUPDATE.IMPORTE_RECARGO_FORMATO_094;
		IA := PROVFORUPDATE.IMPORTE_RECARGO_APREMIO_094;
		
		--importePenalizacionRetraso
		IR := (IT) * (POR_PENALIZACION/100);
		
		--importeTotalPagar
		ITP := (IT + IFOR + IA) - IR;
				
		--importeBasePagar
		IBP := ITP * 100/(100 + IVA);
		
		--importeCorrespondienteIVA
		IMPIVA := ITP - IBP;
		
		IF (NIVEL_CALIDAD IS NOT NULL) THEN
			SELECT POR_PENALIZACION_0B5 INTO POR_PENALIZACION_CALIDAD FROM AA79BB5T00 WHERE NIVEL_0B5 = NIVEL_CALIDAD AND ESTADO_0B5 = 'A';
			IF (IND_PENALIZACION = 'S' OR POR_PENALIZACION_CALIDAD != 0) THEN 
				IND_ALBARAN := 'N';
			ELSE
				IND_ALBARAN := 'S';
			END IF;
		ELSE
			IF (IND_PENALIZACION = 'S') THEN 
				IND_ALBARAN := 'N';
			ELSE
				IND_ALBARAN := 'S';
			END IF;
		END IF;
		
		UPDATE AA79B94T00 SET 
		IND_PENALIZACION_094 = IND_PENALIZACION,
		POR_PENALIZACION_094 = POR_PENALIZACION,
		IMPORTE_PENALIZACION_094 = IR,  
		IMPORTE_BASE_094 = IBP, 
		IMPORTE_IVA_094 = IMPIVA,  
		IMPORTE_TOTAL_094 = ITP,
		IND_ALBARAN_094 = IND_ALBARAN
		WHERE ID_TAREA_094 = TAREAREVPAGOPROVEEDORES;
    
    IF (NIVEL_CALIDAD IS NOT NULL) THEN
			--importePenalizacionCalidad
			IC := ROUND((IT) * (POR_PENALIZACION_CALIDAD/100),2);
			
			--importeTotalPagar
			ITP := (IT + IFOR + IA) - IR - IC;
					
			--importeBasePagar
			IBP := ITP * 100/(100 + IVA);
			
			--importeCorrespondienteIVA
			IMPIVA := ITP - IBP;
			
			UPDATE AA79B94T00 SET 
			NIVEL_CALIDAD_094 = NIVEL_CALIDAD,
			POR_PENAL_CALIDAD_094 = POR_PENALIZACION_CALIDAD,
			IMP_PENAL_CALIDAD_094 = IC,
			IMPORTE_BASE_094 = IBP, 
			IMPORTE_IVA_094 = IMPIVA,  
			IMPORTE_TOTAL_094 = ITP
			WHERE ID_TAREA_094 = TAREAREVPAGOPROVEEDORES;
		END IF;
	
	END IF;
  
		END IF;

	END IF;

END;
/