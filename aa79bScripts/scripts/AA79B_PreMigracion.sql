ALTER TABLE AA79B31T00 DROP CONSTRAINT AA79B30T00_31_FK;
ALTER TABLE AA79B32T00 DROP CONSTRAINT AA79B30T00_32_FK;
ALTER TABLE AA79B33T00 DROP CONSTRAINT AA79B30T00_33_FK;
ALTER TABLE AA79B34T00 DROP CONSTRAINT AA79B30T00_34_FK;
ALTER TABLE AA79B35T00 DROP CONSTRAINT AA79B30T00_35_FK;

ALTER TABLE AA79B31T00 ADD CONSTRAINT AA79B30T00_31_FK
FOREIGN KEY (ID_ORDEN_031)
REFERENCES AA79B30T00 (ID_030)
ON DELETE CASCADE;

ALTER TABLE AA79B32T00 ADD CONSTRAINT AA79B30T00_32_FK
FOREIGN KEY (ID_ORDEN_032)
REFERENCES AA79B30T00 (ID_030)
ON DELETE CASCADE;

ALTER TABLE AA79B33T00 ADD CONSTRAINT AA79B30T00_33_FK
FOREIGN KEY (ID_ORDEN_033)
REFERENCES AA79B30T00 (ID_030)
ON DELETE CASCADE;

ALTER TABLE AA79B34T00 ADD CONSTRAINT AA79B30T00_34_FK
FOREIGN KEY (ID_ORDEN_034)
REFERENCES AA79B30T00 (ID_030)
ON DELETE CASCADE;

ALTER TABLE AA79B35T00 ADD CONSTRAINT AA79B30T00_35_FK
FOREIGN KEY (ID_ORDEN_035)
REFERENCES AA79B30T00 (ID_030)
ON DELETE CASCADE;
/

-- Insertamos las ordenes de precios publicos
DECLARE

ID_ORDEN NUMBER(4);

CURSOR C_ORDEN is(
select  
T07_COD_TIPO_TARIFICACION,
T07_DESC_FEC_VIGOR,
T07_FEC_VIGOR,
T07_POR_IVA,
DECODE(T07_VIGOR,1,'S','N') AS VIGOR,
LEAD(T07_FEC_VIGOR) OVER (ORDER BY T07_FEC_VIGOR) AS fecha_fin,
T08_NUM_EUSK_FR,
T08_NUM_EUSK_JC,
T08_NUM_EUSK_JM,
T08_NUM_INT_OTROS_CAV,
T08_NUM_INT_OTROS_NO_CAV,
T08_NUM_MIN_INT_CAV,
T08_NUM_MIN_INT_NO_CAV,
T08_NUM_NO_EUSK_FR,
T08_NUM_NO_EUSK_JC,
T08_NUM_NO_EUSK_JM,
T08_NUM_PALABRAS_TOTALES,
T08_NUM_PORCEN_DIFICULTAD,
T08_NUM_PORCEN_URGENCIA,
T08_NUM_PRECIO_CERTIFICACION,
T08_NUM_PREC_MIN_TRAD,
T08_POR_RANGO_85_94,
T08_POR_RANGO_95_100,
T08_POR_UT,
T08_RANGO_UT
FROM r75b.R7507T00
JOIN r75b.R7508T00 ON T07_FEC_VIGOR = T08_FEC_VIGOR);



BEGIN
	
	FOR R_ORDEN IN C_ORDEN
    LOOP
		Select AA79B30Q00.nextVal into ID_ORDEN from dual;
		
		INSERT INTO AA79B30T00 (ID_030, TITULO_030, FECHA_VIGOR_030, FECHA_FIN_VIGOR_030, IND_VIGOR_030, URL_ORDEN_030) 
		VALUES (ID_ORDEN, R_ORDEN.T07_DESC_FEC_VIGOR, R_ORDEN.T07_FEC_VIGOR, R_ORDEN.fecha_fin ,R_ORDEN.VIGOR ,NULL);
		
		INSERT INTO AA79B31T00 (ID_031, ID_ORDEN_031, FECHA_DESDE_VIGENCIA_031, FECHA_HASTA_VIGENCIA_031, POR_IVA_031, IND_VIGENTE_031)
        VALUES (AA79B31Q00.nextVal, ID_ORDEN, R_ORDEN.T07_FEC_VIGOR, R_ORDEN.fecha_fin , R_ORDEN.T07_POR_IVA, 'S' );
        
        INSERT INTO AA79B32T00 (ID_ORDEN_032, POR_RECARGO_DIF_032, POR_RECARGO_URG_032, PRECIO_MINIMO_032, NUM_PALABRAS_TARIF_CONCOR_032,
                POR_PALABRA_CONCOR_0_84_032, POR_PALABRA_CONCOR_85_94_032, POR_PALABRA_CONCOR_95_100_032)
        VALUES (ID_ORDEN, R_ORDEN.T08_NUM_PORCEN_DIFICULTAD, R_ORDEN.T08_NUM_PORCEN_URGENCIA, R_ORDEN.T08_NUM_PREC_MIN_TRAD, R_ORDEN.T08_NUM_PALABRAS_TOTALES,
        		nvl(R_ORDEN.T08_POR_UT,100) , R_ORDEN.T08_POR_RANGO_85_94 , R_ORDEN.T08_POR_RANGO_95_100);
        		
        INSERT INTO AA79B33T00 (ID_ORDEN_033, ID_TIPO_RELEVANCIA_033, TARIFA_ES_EU_033, TARIFA_EU_ES_033)
        select ID_ORDEN, DENSE_RANK() OVER (PARTITION BY T06_FEC_VIGOR ORDER BY T06_FEC_VIGOR ASC, T06_COD_TIPO_TRADUCCION ASC) AS SEQUENCE, T06_PRECIO_E, T06_PRECIO_C 
		from r75b.r7506T00 WHERE T06_FEC_VIGOR = R_ORDEN.T07_FEC_VIGOR AND T06_COD_TIPO_TRADUCCION NOT IN (1, 4, 6,11)
		ORDER BY T06_FEC_VIGOR, T06_COD_TIPO_TRADUCCION;
		
		INSERT INTO AA79B34T00 (ID_ORDEN_034, ID_TIPO_RELEVANCIA_034, TARIFA_ES_EU_034, TARIFA_EU_ES_034)
        select ID_ORDEN, DENSE_RANK() OVER (PARTITION BY T05_FEC_VIGOR ORDER BY T05_FEC_VIGOR ASC, T05_COD_TIPO_REVISION ASC) AS SEQUENCE, T05_NUM_PRECIO_E, T05_NUM_PRECIO_C 
		from r75b.r7505T00 WHERE T05_FEC_VIGOR = R_ORDEN.T07_FEC_VIGOR AND T05_COD_TIPO_REVISION NOT IN (1, 4, 6,11)
		ORDER BY T05_FEC_VIGOR, T05_COD_TIPO_REVISION;
		
		INSERT INTO AA79B35T00 (ID_ORDEN_035, JORN_COMP_HORAS_DESDE_035, JORN_COMP_HORAS_HASTA_035, JORN_MEDIA_HORAS_DESDE_035, JORN_MEDIA_HORAS_HASTA_035,
                PREC_MIN_CAE_035, PREC_MIN_NO_CAE_035, PREC_HORA_REUNION_CAE_035, PREC_HORA_REUNION_NO_CAE_035, 
                PREC_JORN_CONGRESO_EU_035, PREC_MEDIA_CONGRESO_EU_035, PREC_HORA_CONGRESO_EU_035, 
                PREC_JORN_CONGRESO_NO_EU_035, PREC_MEDIA_CONGRESO_NO_EU_035, PREC_HORA_CONGRESO_NO_EU_035)
        VALUES (ID_ORDEN, 5,7,1, 4, R_ORDEN.T08_NUM_MIN_INT_CAV, R_ORDEN.T08_NUM_MIN_INT_NO_CAV, R_ORDEN.T08_NUM_INT_OTROS_CAV, R_ORDEN.T08_NUM_INT_OTROS_NO_CAV,
        	R_ORDEN.T08_NUM_EUSK_JC, R_ORDEN.T08_NUM_EUSK_JM, R_ORDEN.T08_NUM_EUSK_FR, R_ORDEN.T08_NUM_NO_EUSK_JC, R_ORDEN.T08_NUM_NO_EUSK_JM, R_ORDEN.T08_NUM_NO_EUSK_FR);
        
		
	END LOOP;
	COMMIT;
END;
/
