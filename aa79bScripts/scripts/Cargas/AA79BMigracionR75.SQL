ALTER TABLE AA79B51T00 DROP CONSTRAINT AA79B59T00_51_FK;
ALTER TABLE AA79B59T00 DROP CONSTRAINT AA79B64T00_59_FK;
ALTER TABLE AA79B92T00 DROP CONSTRAINT AA79B88T00_92_FK;
ALTER TABLE AA79B90T00 DROP CONSTRAINT AA79B88T00_90_FK;
ALTER TABLE AA79B87T00 DROP CONSTRAINT AA79B88T00_87_FK;
ALTER TABLE AA79B96T00 DROP CONSTRAINT AA79B88T00_96_FK;
ALTER TABLE AA79B93T00 DROP CONSTRAINT AA79B88T00_93_FK;
ALTER TABLE AA79B59T00 DROP CONSTRAINT AA79B67T00_59_FK;
/

DECLARE

ANYO_AUX NUMBER(4):= '&1';
NUM_AUX NUMBER(6):= '&1';

error_code NUMBER;
err_msg VARCHAR2(4000);

CURSOR C_EXP_R75 is(
SELECT t30_anyo                                                                                      AS ANYO_051,
  t30_N_EXP                                                                                          AS NUM_EXP_051,
  DECODE(T30_COD_TIPO_EXP,'2','R','3','T','4','I') AS ID_TIPO_EXPEDIENTE_051,
  DECODE(t30_VIA_WEB,'1','S','0','O','3','W')                AS ORIGEN_051,
  T30_FEC_SOLI                                                                                       AS FECHA_ALTA_051,
  replace(replace(SUBSTR(T30_DESC,1,149),chr(10),''),chr(13),'')                                     AS TITULO_051,
  T30_DESC AS DESC_R75_051,
  T30_PPTO AS IND_PRESUPUESTO,
  T30_FACTURABLE AS IND_FACTURABLE,
  T30_OBSERV_IZO AS OBSERVACIONES,
  T30_FEC_FIN AS FECHA_ENTREGA,
  T30_COD_APLIC_ORIG as APLIC_ORIGEN, 
  T30_NUM_FAC as NUM_FACTURA,
  T30_ANYO_FAC as ANYO_FACTURA
FROM r75b.r7530t00
JOIN r75b.r7521t00 ON
t30_cod_solicitante=t21_cod_solicitante and T30_COD_CONT_SOLI=T21_COD_CONT_SOLI
JOIN r75b.r7519t00 ON 
t21_cod_solicitante=t19_cod_solicitante
LEFT JOIN r75b.r7532t00 ON 
t30_anyo = t32_anyo and t30_N_EXP=t32_N_EXP AND T30_FASE=T32_FASE
LEFT JOIN (select t39_anyo, t39_N_EXP, T39_TOT_PAL, T39_COD_TIPO_DOCUMENTO from r75b.r7539t00 where t39_anyo||'@'||t39_N_EXP||'@'||t39_FASE  in (select  t39_anyo||'@'||t39_N_EXP||'@'||max(t39_FASE) from r75b.r7539t00 group by T39_anyo,t39_N_EXP)) t39 ON
t30_anyo = t39.t39_anyo and t30_N_EXP=t39.t39_N_EXP
WHERE 
t30_fase = 5
/**
 * Modificar a partir de aqui, para obtener los expedientes deseados
 */
AND ((T30_COD_TIPO_EXP =3 AND T30_ANYO>=2012 AND T30_ANYO <=2018 AND T19_COD_TIPO_SOLICITANTE not in (8, 9)
AND (
	(T30_COD_SOLICITANTE = 1012 AND t39.T39_TOT_PAL >=1000)
	OR (T30_COD_SOLICITANTE = 533 AND T32_BOPV = 0) 
	OR (T30_COD_SOLICITANTE = 3 AND T21_DPTO <> 'Hautaketa' AND t39.T39_COD_TIPO_DOCUMENTO <> 21)
	OR (T30_COD_SOLICITANTE not in (3,533,1012)  AND ( t39.T39_COD_TIPO_DOCUMENTO IN (1,54,44)   OR (t39.T39_COD_TIPO_DOCUMENTO not in (1, 54, 44, 38, 59)  AND t39.T39_TOT_PAL >=1000)))
)
)
OR (T30_COD_TIPO_EXP =4 AND T30_ANYO =2018)
OR (T30_ANYO =2019))
/**
* Para filtrar por un expediente concreto con variables pasadas
*/
AND 
 1 = (
 CASE WHEN ANYO_AUX <> '0' AND T30_ANYO = ANYO_AUX THEN 1  
 ELSE CASE WHEN ANYO_AUX = '0' THEN 1 
 ELSE 0 END END
 )
AND 
1 = (
 CASE WHEN NUM_AUX <> '0' AND t30_N_EXP = NUM_AUX THEN 1  
 ELSE CASE WHEN NUM_AUX = '0' THEN 1 
 ELSE 0 END END
 )
)ORDER BY 1,2,3 DESC;

 TYPE r_reg_gestor
IS
  RECORD
  (
   	ANYO_054  NUMBER(4),
    NUM_EXP_054  NUMBER(6),
	DNI_SOLICITANTE_054 VARCHAR2(10),
	PRE_DNI_SOLICITANTE_054 VARCHAR2(1),
	SUF_DNI_SOLICITANTE_054 VARCHAR2(1),
    TIPO_ENTIDAD_054 VARCHAR2(1),
    ID_ENTIDAD_054 NUMBER(8),
    IND_VIP_054 VARCHAR2(1),
    DNI_REPRESENTANTE_054 VARCHAR2(10),
    NOMBRE_077	VARCHAR2(20),	
	APEL1_077	VARCHAR2(40),	
	APEL2_077	VARCHAR2(40)
  );
  GESTOR r_reg_gestor;
  
  type dyncursor is ref cursor;
  
  TYPE r_reg_tarea
IS
  RECORD
  (
	ID_TIPO_REVISION_081 NUMBER(2),
	ANYO_081  NUMBER(4), 
    NUM_EXP_081  NUMBER(6), 
	FECHA_INICIO_081 DATE,
	FECHA_FIN_081 DATE,
	HORAS_PREVISTAS_081 VARCHAR2(10),
	COD_RECURSO NUMBER(4),
	TIPO_RECURSO NUMBER(2),
	FECHA_ASIGNACION_081 DATE,
	FECHA_ACEPTACION_081 DATE 
  );
  TAREA r_reg_tarea;
  
  C_TAREAS_TRAD dyncursor;
  
  TYPE r_reg_tarea_trad
  IS RECORD
  (
  ID_TIPO_REVISION_081 NUMBER(2),
  ANYO_081 NUMBER(4),
  NUM_EXP_081  NUMBER(6), 
  FECHA_INICIO_081 DATE,
  FECHA_FIN_081 DATE,
  HORAS_PREVISTAS_081 VARCHAR2(10),
  COD_RECURSO NUMBER(4),
  TIPO_RECURSO NUMBER(2),
  T40_TIPO_TAREA VARCHAR2(1), 
  FECHA_ASIGNACION_081 DATE,
  FECHA_ACEPTACION_081 DATE,
  T38_COD_DOC_CLI	NUMBER(8),
  T38_TIPO_CLI	VARCHAR2(100),
  T38_TAMANO_CLI	NUMBER(10,0),
  T38_FECHA_CLI	DATE,
  T38_NOMBRE_DOC_CLI	VARCHAR2(100),
  T38_OID_CLI	VARCHAR2(20),
  T38_COD_DOC_FIN	NUMBER(8),
  T38_TIPO_FIN	VARCHAR2(100),
  T38_TAMANO_FIN	NUMBER(10,0),
  T38_FECHA_FIN	DATE,
  T38_NOMBRE_DOC_FIN	VARCHAR2(100),
  T38_OID_FIN	VARCHAR2(20)
  );
  R_TAREASTRAD r_reg_tarea_trad;
  
  TYPE r_reg_lote
IS
  RECORD
  (
	T18_COD_PROVEEDOR	NUMBER(4),
	T18_COD_LOTE	NUMBER(4), 
    T18_DESC	VARCHAR2(200), 
	T18_URGENCIA	NUMBER(5,2),
	T18_DIFICULTAD	NUMBER(5,2),
	T18_IMP_EUSK_CAST	NUMBER(7,6),
	T18_IMP_CAST_EUSK	NUMBER(7,6),
	T18_POR_RANGO_95_100	NUMBER(3),
	T18_POR_RANGO_85_94	NUMBER(3),
	T18_POR_IVA_LOTE	NUMBER(2),
	T18_FEC_INI	DATE,
	T18_FEC_FIN	DATE,
	T18_IMP_TOTAL	NUMBER(8,2),
	T18_IMP_CONSUMIDO	NUMBER(8,2),
	T18_IMP_PREVISTO	NUMBER(8,2),
	T18_IMP_RESTANTE	NUMBER(8,2),
	T18_IMP_DISPONIBLE	NUMBER(8,2),
	TIPO_X54 VARCHAR2(1),
    ID_X54 NUMBER(8)
  );
  LOTE r_reg_lote;
  
 ID_LOTE NUMBER(6);
 ID_ALBARAN NUMBER(10);
 
 
  TYPE r_reg_pago_proveedor
IS
  RECORD
  (
   	ANYO_094 NUMBER(4),
   	NUM_EXP_094 NUMBER(6),
	NUM_TOTAL_PAL_094 NUMBER(6),
	NUM_PAL_CONCOR_0_84_094 NUMBER(6),
	NUM_PAL_CONCOR_85_94_094 NUMBER(6),
	NUM_PAL_CONCOR_95_100_094 NUMBER(6),
	IND_RECARGO_FORMATO_094 VARCHAR2(1),
	NUM_PAL_RECARGO_FORMATO_094 NUMBER(6),
    IND_RECARGO_APREMIO_094 VARCHAR2(1),
    POR_RECARGO_APREMIO_094 NUMBER(3),
    IND_PENALIZACION_094 VARCHAR2(1),
    POR_PENALIZACION_094 NUMBER(3),
    IVA_APLIC_094 NUMBER(3),
    IMPORTE_PAL_APLIC_094 NUMBER(6,5),
    POR_REVISION_APLIC_094 NUMBER(3),
    IMPORTE_TAREA_094  NUMBER(8,2),  
    IMPORTE_RECARGO_FORMATO_094  NUMBER(8,2),  
    IMPORTE_RECARGO_APREMIO_094  NUMBER(8,2),  
    IMPORTE_PENALIZACION_094  NUMBER(8,2),  
    IMPORTE_BASE_094 NUMBER(8,2),  
    IMPORTE_IVA_094 NUMBER(8,2),  
	IMPORTE_TOTAL_094 NUMBER(9,2),
	IND_PAGADO_094 VARCHAR2(1),
	IND_ALBARAN_094 VARCHAR2(1),
	T30_ALBARAN NUMBER(8)
  );
  DATOS_PAGO_PROVEEDOR r_reg_pago_proveedor;
  
  
   TYPE r_reg_documento_final
IS
  RECORD
  (
   	T38_COD_DOC	NUMBER(8),
	T38_TIPO	VARCHAR2(100),
	T38_TAMANO	NUMBER(10,0),
	T38_FECHA	DATE,
	T38_NOMBRE_DOC	VARCHAR2(100),
	T38_OID	VARCHAR2(20)
  );
  DOCUMENTO_FINAL r_reg_documento_final;
  
  
  
  TYPE r_reg_contacto
IS
  RECORD
  (
   	ANYO_058  NUMBER(4),
    NUM_EXP_058  NUMBER(6),
    DNI_CONTACTO_058 VARCHAR2(10),
    PRE_DNI_CONTACTO_058 VARCHAR2(1),
    SUF_DNI_CONTACTO_058 VARCHAR2(1),
    TIPO_ENTIDAD_ASOC_058 VARCHAR2(1),
    ID_ENTIDAD_ASOC_058 NUMBER(8),
    NOMBRE_077	VARCHAR2(20),	
	APEL1_077	VARCHAR2(40),	
	APEL2_077	VARCHAR2(40)
  );
  CONTACTO r_reg_contacto;
  
  TYPE r_reg_facturacion
IS
  RECORD
  (
   	ANYO_097  NUMBER(4),
    NUM_EXP_097  NUMBER(6),
    NUM_TOTAL_PAL_FACTURAR_097 NUMBER(6),
    NUM_PAL_CONCOR_0_84_097 NUMBER(6),
    NUM_PAL_CONCOR_85_94_097 NUMBER(6),
    NUM_PAL_CONCOR_95_100_097 NUMBER(6),
    TARIFA_PAL_097 NUMBER(5,4), 
    POR_IVA_097 NUMBER(3),
    IMPORTE_DIFICULTAD_097 NUMBER(8,2),  
    IMPORTE_URGENCIA_097 NUMBER(8,2),  
    IMPORTE_BASE_097 NUMBER(8,2),  
    IMPORTE_IVA_097 NUMBER(8,2),  
	IMPORTE_TOTAL_097 NUMBER(9,2)
  );
  DATOS_FACTURACION r_reg_facturacion;
  
  
  TYPE r_reg_fact_inter
IS
  RECORD
  (
   	ANYO_0A3  NUMBER(4),
    NUM_EXP_0A3  NUMBER(6),
    POR_IVA_0A3 NUMBER(3),
    NUM_INTERPRETES_0A3 NUMBER(2),
	HORAS_INTERPRETACION_0A3 VARCHAR2(150),
    IMPORTE_BASE_0A3 NUMBER(8,2),  
    IMPORTE_IVA_0A3 NUMBER(8,2),  
	IMPORTE_TOTAL_0A3 NUMBER(9,2)
  );
  DATOS_FACT_INTER r_reg_fact_inter;
  
  HORAS_INTERPRETACION_ACUM VARCHAR2(150);

ID_BITACORA NUMBER(2):= 0;
ID_DIR_NORA NUMBER(8);
ID_DOCU_NUEVO NUMBER(20);
ID_DOCU_TAREA NUMBER(20);
ID_TAREA_NUEVO NUMBER(20);
ID_TAREA_ANTERIOR NUMBER(20);
ID_NUEVO_FICHERO_FINAL NUMBER(20);
ID_FICHERO_USADO VARCHAR2(1):= 'S';
ID_CONT_FACT NUMBER(10);

NUM_EXP_ACTUAL NUMBER(6);
ANYO_ACTUAL NUMBER(4);
ID_ORDEN NUMBER(4);
CONTADOR NUMBER(1):= 0;
POR_EUSKERA NUMBER(3);
QUERY_DOCUS VARCHAR2(4000);
ORDEN_TAREA NUMBER(2):= 0;

IMPORTE_ENTIDAD        NUMBER(9,2):=0.0;
IMPORTE_BASE_ENTIDAD   NUMBER(8,2):=0.0;
IMPORTE_IVA_ENTIDAD    NUMBER(8,2):=0.0;
IMPORTE_DIFICULTAD_ENT NUMBER(8,2):=0.0;
IMPORTE_URGENCIA_ENT   NUMBER(8,2):=0.0;

-- NUMEROS DE PALABRAS PARA CADA ENTIDAD
NUM_TOTAL_PAL_FACTURAR_ENT NUMBER(6);
NUM_PAL_CONCOR_0_84_ENT    NUMBER(6);
NUM_PAL_CONCOR_85_94_ENT   NUMBER(6);
NUM_PAL_CONCOR_95_100_ENT  NUMBER(6);

REFERENCIA_PAGO VARCHAR2(13);
FECHA_EMISION DATE;
ID_FACTURA NUMBER(10);


C_DOCUMENTOS dyncursor;
C_TAREAS_INTER dyncursor;

TYPE r_reg_documentos IS RECORD (
    COD_DOC_R75 NUMBER(8),
	TIPO_DOCUMENTO_056 NUMBER(2),
	ANYO_056 NUMBER(4),
	NUM_EXP_056 NUMBER(6),
	EXTENSION_DOC_056 VARCHAR2(10),
	OID_FICHERO_056 VARCHAR2(150),
	RUTA_PIF_FICHERO_056 VARCHAR2(500),
	TAMANO_DOC_056 VARCHAR2(10),
	IND_ENCRIPTADO_056 VARCHAR2(1) ,
	ID_DOC_REL_056 NUMBER(20),
	CLASE_DOCUMENTO_056 NUMBER(2),
	CONTENT_TYPE_056 VARCHAR2(150),
	TITULO_056 VARCHAR2(256),
	NUM_PAL_SOLIC_056 NUMBER(6),
	NUM_PAL_IZO_056 NUMBER(6),
	PERSONA_CONTACTO_056 VARCHAR2(150),
	EMAIL_CONTACTO_056 VARCHAR2(256),
	TELEFONO_CONTACTO_056 VARCHAR2(15),
	DIRECCION_CONTACTO_056 VARCHAR2(256),
	ENTIDAD_CONTACTO_056 VARCHAR2(150),
	IND_VISIBLE_056 VARCHAR2(1),
	FECHA_ALTA_056 DATE,
	DNI_ALTA_056 VARCHAR2(10),
	ID_DOC_VERSION_056 NUMBER(20),
	NOMBRE_FICHERO_056 VARCHAR2(250),
	IND_ORIGEN_056 VARCHAR2(1)
);
R_DOCUMENTOS r_reg_documentos;

TYPE r_reg_tareas IS RECORD (
    ID_TIPO_TAREA_081 NUMBER(20),
	ID_TIPO_REVISION_081 NUMBER(2),
	ANYO_081 NUMBER(4),
	NUM_EXP_081 NUMBER(6),
	IND_FACTURABLE_081 VARCHAR2(1),
	FECHA_INICIO_081 DATE,
	FECHA_FIN_081 DATE,
	HORAS_PREVISTAS_081 VARCHAR2(10),
	RECURSO_ASIGNACION_081 VARCHAR2(1) ,
	DNI_RECURSO_081 VARCHAR2(10),
	TIPO_ENTIDAD_081 VARCHAR2(1),
	ID_ENTIDAD_081 NUMBER(8),
	ID_LOTE_081 NUMBER(6),
	ESTADO_ASIGNACION_081 NUMBER(1),
	ESTADO_EJECUCION_081 NUMBER(1),
	OBSERV_081 VARCHAR2(2000),
	ORDEN_081 NUMBER(2),
	DNI_ASIGNADOR_081 VARCHAR2(10),
	FECHA_ASIGNACION_081 DATE,
	FECHA_ACEPTACION_081 DATE,
	ID_TAREA_REL_081 NUMBER(20),
	ID_REQUERIMIENTO_081 NUMBER(10),
	IND_NO_CONFORMIDAD_081 VARCHAR2(11)
);
R_TAREAS_INTER r_reg_tareas;

BEGIN
 

	
	FOR R_EXP_R75 IN C_EXP_R75
    LOOP
    	BEGIN
      	NUM_EXP_ACTUAL := R_EXP_R75.NUM_EXP_051;
     	ANYO_ACTUAL:= R_EXP_R75.ANYO_051;
    	ID_BITACORA:= 1;
    	ORDEN_TAREA:=1;
    	-- BORRAMOS, SI ES QUE EXISTE, EL EXPEDIENTE QUE COINCIDA EN NUMERO y ANYO
    	-- Insertamos los oid de los ficheros de tareas que se van a borrar. No se hace de momento para no eliminar oid original de R75
    	--Insert into AA79BA0T00 (OID_0A0, FECHA_0A0)	SELECT OID_FICHERO_088, sysdate from AA79B92T00, AA79B81T00, AA79B88T00 WHERE ID_TAREA_081 = ID_TAREA_092 AND NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ANYO_081 =  R_EXP_R75.ANYO_051 AND ID_FICHERO_FINAL_092 = ID_FICHERO_088;
    	--Insert into AA79BA0T00 (OID_0A0, FECHA_0A0)	SELECT OID_FICHERO_088, sysdate from AA79B87T00, AA79B81T00, AA79B88T00  WHERE ID_TAREA_081 = ID_TAREA_087 AND NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ANYO_081 =  R_EXP_R75.ANYO_051 AND ID_FICHERO_TRADUCIDO_087 = ID_FICHERO_088;
    	--Insert into AA79BA0T00 (OID_0A0, FECHA_0A0)	SELECT OID_FICHERO_088, sysdate from AA79B93T00, AA79B81T00, AA79B88T00 WHERE ID_TAREA_081 = ID_TAREA_093 AND NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ANYO_081 =  R_EXP_R75.ANYO_051 AND ID_FICHERO_JUSTIFICANTE_093 = ID_FICHERO_088;
    	--Insert into AA79BA0T00 (OID_0A0, FECHA_0A0)	SELECT OID_FICHERO_088, sysdate from AA79B96T00, AA79B81T00, AA79B88T00 WHERE ID_TAREA_081 = ID_TAREA_096 AND NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ANYO_081 =  R_EXP_R75.ANYO_051 AND ID_FICHERO_XLIFF_096 = ID_FICHERO_088;
    	--Insert into AA79BA0T00 (OID_0A0, FECHA_0A0)	SELECT OID_FICHERO_088, sysdate from AA79BB1T00, AA79B81T00, AA79B88T00 WHERE ID_TAREA_081 = ID_TAREA_0B1 AND NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ANYO_081 =  R_EXP_R75.ANYO_051 AND ID_FICHERO_0B1 = ID_FICHERO_088;
    	--Insert into AA79BA0T00 (OID_0A0, FECHA_0A0)	SELECT OID_FICHERO_088, sysdate from AA79B86T00, AA79B81T00, AA79B88T00 WHERE ID_TAREA_086 = ID_TAREA_0B1 AND NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ANYO_081 =  R_EXP_R75.ANYO_051 AND ID_FICHERO_INFORME_086 = ID_FICHERO_088;
    	--Insert into AA79BA0T00 (OID_0A0, FECHA_0A0)	SELECT OID_FICHERO_088, sysdate from AA79B86T00, AA79B81T00, AA79B88T00 WHERE ID_TAREA_086 = ID_TAREA_0B1 AND NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ANYO_081 =  R_EXP_R75.ANYO_051 AND ID_FICHERO_DOC_086 = ID_FICHERO_088;
    	--Insert into AA79BA0T00 (OID_0A0, FECHA_0A0)	SELECT OID_FICHERO_088, sysdate from AA79B90T00, AA79B81T00, AA79B88T00 WHERE ID_TAREA_090 = ID_TAREA_0B1 AND NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ANYO_081 =  R_EXP_R75.ANYO_051 AND ID_FICHERO_TRADOS_090 = ID_FICHERO_088;
    	-- Borramos ficheros
    	delete aa79b88t00 WHERE id_fichero_088 in (Select ID_FICHERO_FINAL_092 from AA79B92T00, AA79B81T00 WHERE ID_TAREA_081 = ID_TAREA_092 AND NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ANYO_081 =  R_EXP_R75.ANYO_051);
    	delete aa79b88t00 WHERE id_fichero_088 in (Select ID_FICHERO_TRADUCIDO_087 from AA79B87T00, AA79B81T00 WHERE ID_TAREA_081 = ID_TAREA_087 AND NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ANYO_081 =  R_EXP_R75.ANYO_051);
    	delete aa79b88t00 WHERE id_fichero_088 in (Select ID_FICHERO_JUSTIFICANTE_093 from AA79B93T00, AA79B81T00 WHERE ID_TAREA_081 = ID_TAREA_093 AND NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ANYO_081 =  R_EXP_R75.ANYO_051);
    	delete aa79b88t00 WHERE id_fichero_088 in (Select ID_FICHERO_XLIFF_096 from AA79B96T00, AA79B81T00 WHERE ID_TAREA_081 = ID_TAREA_096 AND NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ANYO_081 =  R_EXP_R75.ANYO_051);
    	delete aa79b88t00 WHERE id_fichero_088 in (Select ID_FICHERO_0B1 from AA79BB1T00, AA79B81T00 WHERE ID_TAREA_081 = ID_TAREA_0B1 AND NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ANYO_081 =  R_EXP_R75.ANYO_051);
    	delete aa79b88t00 WHERE id_fichero_088 in (Select ID_FICHERO_INFORME_086 from AA79B86T00, AA79B81T00 WHERE ID_TAREA_081 = ID_TAREA_086 AND NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ANYO_081 =  R_EXP_R75.ANYO_051);
    	delete aa79b88t00 WHERE id_fichero_088 in (Select ID_FICHERO_DOC_086 from AA79B86T00, AA79B81T00 WHERE ID_TAREA_081 = ID_TAREA_086 AND NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ANYO_081 =  R_EXP_R75.ANYO_051);
    	delete aa79b88t00 WHERE id_fichero_088 in (Select ID_FICHERO_TRADOS_090 from AA79B90T00, AA79B81T00 WHERE ID_TAREA_081 = ID_TAREA_090 AND NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ANYO_081 =  R_EXP_R75.ANYO_051);
    	-- Borramos las tareas del expediente
    	delete aa79b81t00 where NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ANYO_081 =  R_EXP_R75.ANYO_051;
    	-- Borramos los requerimientos de un expediente
    	delete AA79B66T00 where ID_066 in (Select ID_REQUERIMIENTO_059 from AA79B59T00 WHERE  NUM_EXP_059 = R_EXP_R75.NUM_EXP_051 AND ANYO_059 =  R_EXP_R75.ANYO_051);
    	delete AA79B65T00 where ID_065 in (Select ID_REQUERIMIENTO_059 from AA79B59T00 WHERE  NUM_EXP_059 = R_EXP_R75.NUM_EXP_051 AND ANYO_059 =  R_EXP_R75.ANYO_051);
    	delete AA79B64T00 where ID_064 in (Select ID_REQUERIMIENTO_059 from AA79B59T00 WHERE  NUM_EXP_059 = R_EXP_R75.NUM_EXP_051 AND ANYO_059 =  R_EXP_R75.ANYO_051);
    	-- borramos un posible rechazo del expediente
    	delete AA79B68T00 where ID_068 in (Select ID_RECHAZO_059 from AA79B59T00 WHERE  NUM_EXP_059 = R_EXP_R75.NUM_EXP_051 AND ANYO_059 =  R_EXP_R75.ANYO_051);
    	delete AA79B67T00 where ID_067 in (Select ID_RECHAZO_059 from AA79B59T00 WHERE  NUM_EXP_059 = R_EXP_R75.NUM_EXP_051 AND ANYO_059 =  R_EXP_R75.ANYO_051);
    	delete AA79BA2T00 where ID_0A2 in (Select ID_ANULACION_059 from AA79B59T00 WHERE  NUM_EXP_059 = R_EXP_R75.NUM_EXP_051 AND ANYO_059 =  R_EXP_R75.ANYO_051);
    	delete AA79BA1T00 where ID_0A1 in (Select ID_ANULACION_059 from AA79B59T00 WHERE  NUM_EXP_059 = R_EXP_R75.NUM_EXP_051 AND ANYO_059 =  R_EXP_R75.ANYO_051);
    	-- borramos el registro de acciones
    	delete AA79B43T00 where NUM_EXP_043 = R_EXP_R75.NUM_EXP_051 AND ANYO_EXP_043 =  R_EXP_R75.ANYO_051;
    	
    	-- borramos bitacoras
    	update aa79b51T00 set ESTADO_BITACORA_051 = null where NUM_EXP_051 = R_EXP_R75.NUM_EXP_051 AND ANYO_051 =  R_EXP_R75.ANYO_051;
    	delete aa79b59t00 where NUM_EXP_059 = R_EXP_R75.NUM_EXP_051 AND ANYO_059 =  R_EXP_R75.ANYO_051;
    	-- borramos bitácora del solicitante
    	delete aa79b79t00 where NUM_EXP_079 = R_EXP_R75.NUM_EXP_051 AND ANYO_079 =  R_EXP_R75.ANYO_051;
    	-- AA79B80T00 LIBRO REGISTRO
    	delete aa79b80t00 where NUM_EXP_080 = R_EXP_R75.NUM_EXP_051 AND ANYO_080 =  R_EXP_R75.ANYO_051;
    	
    	-- insertamos los oids de los docs originales que se van a borrar. No se hace de momento para no eliminar oid original de R75
    	--Insert into AA79BA0T00 (OID_0A0, FECHA_0A0)	SELECT OID_FICHERO_056, sysdate from AA79B56T00 WHERE NUM_EXP_056 = R_EXP_R75.NUM_EXP_051 AND ANYO_056 =  R_EXP_R75.ANYO_051;
    	-- borramos los docs originales del expediente
    	delete aa79b56t00 where NUM_EXP_056 = R_EXP_R75.NUM_EXP_051 AND ANYO_056 =  R_EXP_R75.ANYO_051; 
    	-- 57 expedientes relacionados
    	delete aa79b57T00 where  NUM_EXP_057 = R_EXP_R75.NUM_EXP_051 AND ANYO_057 =  R_EXP_R75.ANYO_051; 
    	
    	-- expedientes a facturar, perviamente borrar los datos de facturación
    	-- Datos Facturacion expedientes traducción
    	delete AA79B97T00 WHERE NUM_EXP_097 = R_EXP_R75.NUM_EXP_051 AND ANYO_097 =  R_EXP_R75.ANYO_051; 
    	DELETE AA79B98T00 WHERE ID_098 IN (SELECT ID_058 FROM aa79b58t00 WHERE NUM_EXP_058 = R_EXP_R75.NUM_EXP_051 AND ANYO_058 =  R_EXP_R75.ANYO_051);
    	-- A3 Datos Facturacion expedientes interpretación
    	delete AA79BA3T00 WHERE NUM_EXP_0A3 = R_EXP_R75.NUM_EXP_051 AND ANYO_0A3 =  R_EXP_R75.ANYO_051; 
    	DELETE AA79BA6T00 WHERE ID_0A6 IN (SELECT ID_058 FROM aa79b58t00 WHERE NUM_EXP_058 = R_EXP_R75.NUM_EXP_051 AND ANYO_058 =  R_EXP_R75.ANYO_051);
    	-- ENTIDADES A FACTURAR
    	DELETE AA79B58T00 WHERE NUM_EXP_058 = R_EXP_R75.NUM_EXP_051 AND ANYO_058 =  R_EXP_R75.ANYO_051;
    	-- AA79B62T00 categorización expediente
    	DELETE AA79B62T00 WHERE NUM_EXP_062 = R_EXP_R75.NUM_EXP_051 AND ANYO_062 =  R_EXP_R75.ANYO_051;
    	-- AA79B63T00 (Receptores autorizados)
    	DELETE AA79B63T00 WHERE NUM_EXP_063 = R_EXP_R75.NUM_EXP_051 AND ANYO_063 =  R_EXP_R75.ANYO_051;
    	-- borramos la solicitud
    	-- solicitudes relacionadas
    	delete aa79b74T00 where  NUM_EXP_074 = R_EXP_R75.NUM_EXP_051 AND ANYO_074 =  R_EXP_R75.ANYO_051; 
    	-- 73 documentos solicitud, pasando oids
    	--Insert into AA79BA0T00 (OID_0A0, FECHA_0A0) SELECT OID_FICHERO_073, sysdate from AA79B73T00 WHERE NUM_EXP_073 = R_EXP_R75.NUM_EXP_051 AND ANYO_073 =  R_EXP_R75.ANYO_051;
    	delete AA79B73T00 where NUM_EXP_073 = R_EXP_R75.NUM_EXP_051 AND ANYO_073 =  R_EXP_R75.ANYO_051; 
    	-- 72 observaciones solicitud (lopd)
    	delete AA79B72T00 where NUM_EXP_072 = R_EXP_R75.NUM_EXP_051 AND ANYO_072 =  R_EXP_R75.ANYO_051; 
    	-- 71 solicitud traduccion revision
    	delete AA79B71T00 where NUM_EXP_071 = R_EXP_R75.NUM_EXP_051 AND ANYO_071 =  R_EXP_R75.ANYO_051; 
    	-- 70 solicitud interpretacion
    	delete AA79B70T00 where NUM_EXP_070 = R_EXP_R75.NUM_EXP_051 AND ANYO_070 =  R_EXP_R75.ANYO_051; 
    	-- 69 SOlicitud expediente
    	delete AA79B69T00 where NUM_EXP_069 = R_EXP_R75.NUM_EXP_051 AND ANYO_069 =  R_EXP_R75.ANYO_051; 
      
      -- 69 SOlicitud expediente
    	delete AA79BA5T00 where NUM_EXP_0A5 = R_EXP_R75.NUM_EXP_051 AND ANYO_0A5 =  R_EXP_R75.ANYO_051; 
    	
    	-- borramos el expediente
    	delete aa79b54t00 where NUM_EXP_054 = R_EXP_R75.NUM_EXP_051 AND ANYO_054 =  R_EXP_R75.ANYO_051; 
		delete aa79b55t00 where NUM_EXP_055 = R_EXP_R75.NUM_EXP_051 AND ANYO_055 =  R_EXP_R75.ANYO_051; 
    	delete aa79b52t00 where NUM_EXP_052 = R_EXP_R75.NUM_EXP_051 AND ANYO_052 =  R_EXP_R75.ANYO_051; 
		delete aa79b53t00 where NUM_EXP_053 = R_EXP_R75.NUM_EXP_051 AND ANYO_053 =  R_EXP_R75.ANYO_051; 
    	delete aa79b57t00 where NUM_EXP_057 = R_EXP_R75.NUM_EXP_051 AND ANYO_057 =  R_EXP_R75.ANYO_051; 
    	delete aa79b57t00 where NUM_EXP_REL_057 = R_EXP_R75.NUM_EXP_051 AND ANYO_EXP_REL_057 =  R_EXP_R75.ANYO_051; 
		delete aa79b51t00 where NUM_EXP_051= R_EXP_R75.NUM_EXP_051 AND ANYO_051 =  R_EXP_R75.ANYO_051; 
    
    -- Empezamos la inserción de expedientes.

		Insert into AA79B51T00 (ANYO_051,NUM_EXP_051,ID_TIPO_EXPEDIENTE_051,ORIGEN_051,FECHA_ALTA_051,TITULO_051,ESTADO_BITACORA_051,DNI_TECNICO_051,DNI_ASIGNADOR_051,IND_PRIORITARIO_051,FECHA_BAJA_051,ESTADO_BAJA_051,OBSV_BAJA_051,OBSV_FACT_051, APLIC_ORIGEN_051, DESC_R75_051) 
		values (R_EXP_R75.ANYO_051,R_EXP_R75.NUM_EXP_051,R_EXP_R75.ID_TIPO_EXPEDIENTE_051,R_EXP_R75.ORIGEN_051,R_EXP_R75.FECHA_ALTA_051,R_EXP_R75.TITULO_051,null,'16265343','16265343','N',null,'A',null,null,R_EXP_R75.APLIC_ORIGEN, R_EXP_R75.DESC_R75_051);
		-- Metemos las observaciones para el IZO.
		IF (R_EXP_R75.OBSERVACIONES is not null) THEN
			INSERT INTO AA79B55T00 (ANYO_055, NUM_EXP_055, OBSERVACIONES_055) values (R_EXP_R75.ANYO_051,R_EXP_R75.NUM_EXP_051,R_EXP_R75.OBSERVACIONES);
		END IF;
		IF (R_EXP_R75.ID_TIPO_EXPEDIENTE_051 = 'I') THEN
			-- DIRECCION NORA 
			select AA79B49Q00.nextVal into ID_DIR_NORA from dual;
			INSERT INTO AA79B49S01 (CDIRNORA_049, TIPONORA_049, CODPROV_049, CODMUNI_049, APROX_049)
			select ID_DIR_NORA, '0', LPAD(T31_MUN_PROV,2,'0'), LPAD(T31_MUN_MUNI,3,'0'), T31_LUGAR from r75b.r7531t00 where t31_anyo = R_EXP_R75.ANYO_051 
			and t31_N_EXP= R_EXP_R75.NUM_EXP_051 AND t31_fase= 5;
			
			-- INSERT EN LA 52
			Insert into AA79B52T00 (ANYO_052,NUM_EXP_052,MODO_INTERPRETACION_052,TIPO_ACTO_052,TIPO_PETICIONARIO_052,IND_PROGRAMADA_052,FECHA_INI_052,FECHA_FIN_052,DIR_NORA_052,
			IND_PRESUPUESTO_052,IND_FACTURABLE_052,
			PERSONA_CONTACTO_052,EMAIL_CONTACTO_052,TELEFONO_CONTACTO_052,IND_OBSERVACIONES_052) 
			select t31_anyo as ANYO_052,t31_N_EXP as NUM_EXP_053, T31_MODO_INTER AS MODO_INTERPRETACION_052, DECODE(T31_TIPO_INTER,5,0,T31_TIPO_INTER) AS TIPO_ACTO_052, DECODE(T31_PETICIONARIO,1, 'P', 'A') AS TIPO_PETICIONARIO_052,
			DECODE(T31_PROGRAMADA,'1','S','N') AS IND_PROGRAMADA_052, T31_FEC_INI_PRE AS FECHA_INI_052, T31_FEC_FIN_PRE AS FECHA_FIN_052, ID_DIR_NORA,
			DECODE(T30_PPTO,'1','S','N') AS IND_PRESUPUESTO_052, DECODE(T30_FACTURABLE,'1','S','N') AS IND_FACTURABLE_052, 
			T31_USU_FINAL AS PERSONA_CONTACTO_052, null as EMAIL_CONTACTO_052, null as TELEFONO_CONTACTO_052,
			DECODE(T30_OBSERV_IZO,null,'N','S') as IND_OBSERVACIONES_053
			from r75b.r7530t00,r75b.r7531t00 where t30_anyo = R_EXP_R75.ANYO_051 and t30_N_EXP= R_EXP_R75.NUM_EXP_051
			and t30_anyo = t31_anyo and t30_N_EXP=t31_N_EXP AND T30_FASE=T31_FASE AND
			t30_fase= 5  order by 1,2,3 desc;
		ELSE
			-- INSERT EN LA 53
			Insert into AA79B53T00 (ANYO_053,NUM_EXP_053,IND_PUBLICAR_BOPV_053,IND_PREVISTO_BOPV_053,ID_IDIOMA_053,IND_CONFIDENCIAL_053,IND_CORREDACCION_053,TEXTO_053,TIPO_REDACCION_053,PARTICIPANTES_053,REF_TRAMITAGUNE_053,NUM_TOTAL_PAL_IZO_053,
			NUM_TOTAL_PAL_SOLIC_053,FECHA_FINAL_SOLIC_053,FECHA_FINAL_PROP_053,FECHA_FINAL_IZO_053,IND_FACTURABLE_053,ID_RELEVANCIA_053,IND_URGENTE_053,IND_DIFICIL_053,IND_PRESUPUESTO_053,IND_OBSERVACIONES_053,IND_PUBLICADO_BOE_053,URL_BOE_053,FECHA_ENTREGA_REAL_053) 
			select t32_anyo as ANYO_053,t32_N_EXP as NUM_EXP_053,
			DECODE(t32_BOPV,'1','S','N') AS IND_PUBLICAR_BOPV_053,
			DECODE(t32_BOPV,'1','S','N') AS IND_PREVISTO_BOPV_053, 
			DECODE(t32_IDIOMA,'3','1','0','1',t32_IDIOMA) AS ID_IDIOMA_053,'N' as IND_CONFIDENCIAL_053,
 			'N'  as IND_CORREDACCION_053, 
			null as TEXTO_053, 
			null as TIPO_REDACCION_053,
			null as PARTICIPANTES_053, 
			T30_REF_SOLI as REF_TRAMITAGUNE_053, 
			T32_NUM_TOT_PAL AS NUM_TOTAL_PAL_IZO_053, 
			T32_NUM_TOT_PAL AS NUM_TOTAL_PAL_SOLIC_053, 
			T32_FEC_ENTR_SOL AS FECHA_FINAL_SOLIC_053, 
			T32_FEC_ENTR_IVAP AS FECHA_FINAL_PROP_053, 
			T30_FEC_FIN AS FECHA_FINAL_IZO_053, 
			DECODE(T30_FACTURABLE,'1','S','N') AS IND_FACTURABLE_053, 
			'3' AS ID_RELEVANCIA_053, 
			DECODE(T32_URGENCIA,'1','S','N') AS IND_URGENTE_053, 
			DECODE(T32_DIFICULTAD,'1','S','N') AS IND_DIFICIL_053, 
			DECODE(T32_PRESUPUESTO,'1','S','N') AS IND_PRESUPUESTO_053, 
			DECODE(T30_OBSERV_IZO,null,'N','S') as IND_OBSERVACIONES_053, 
			'N' AS IND_PUBLICADO_BOE_053, 
			null as URL_BOE_053, 
			nvl(T32_FEC_ENTR_IVAP, T30_FEC_FIN) AS FECHA_ENTREGA_REAL_053
			from r75b.r7530t00,r75b.r7532t00 where t30_anyo = R_EXP_R75.ANYO_051 and t30_N_EXP= R_EXP_R75.NUM_EXP_051
			and t30_anyo = t32_anyo and t30_N_EXP=t32_N_EXP AND T30_FASE=T32_FASE AND
			t30_fase=5  order by 1,2,3 desc;
		END IF;
		
		-- RECUPERAMOS EL GESTOR
		select t30_anyo as anyo_054,t30_n_exp as NUM_EXP_054, 
		decode(t21_dni, null,'00000000',trim(translate(t21_dni,translate(t21_dni, '1234567890', ' '),' '))) as DNI_SOLICITANTE_054,
		trim(translate(substr(t21_dni,0,1), '1234567890', ' ')) as PRE_DNI_SOLICITANTE_054, 
		decode(t21_dni, null, 'T',trim(translate(substr(t21_dni,length(t21_dni),1), '1234567890', ' ')))  as SUF_DNI_SOLICITANTE_054, 
   	 	nvl(TIPO_X54,'B') as TIPO_ENTIDAD_054,
   	 	nvl(ID_X54,570) as ID_ENTIDAD_054,
    	DECODE(t21_vips,'',0,t21_vips) as IND_VIP_054,null as DNI_REPRESENTANTE_054, T21_NOMBRE, T21_APEL1, T21_APEL2 into GESTOR from r75b.r7530t00,r75b.r7521t00,r75b.r7519t00, CODR75X54J  
    	where  t30_cod_solicitante=t21_cod_solicitante and  t21_cod_solicitante=t19_cod_solicitante  
		and T30_COD_CONT_SOLI=T21_COD_CONT_SOLI and t30_fase=5 and t30_anyo = R_EXP_R75.ANYO_051 AND t30_n_exp =R_EXP_R75.NUM_EXP_051 
		and t30_cod_solicitante = ID_R75 (+);
		
		--INSERTAMOS EL GESTOR
		Select count(1) into contador from AA79B77T00 WHERE DNI_077 = GESTOR.DNI_SOLICITANTE_054;
		IF (CONTADOR = 0) THEN
			Insert into AA79B77T00 (DNI_077,TIPIDEN_077,PREDNI_077,SUFDNI_077,NOMBRE_077,APEL1_077,APEL2_077) 
			values (GESTOR.DNI_SOLICITANTE_054,'1',GESTOR.PRE_DNI_SOLICITANTE_054,GESTOR.SUF_DNI_SOLICITANTE_054,GESTOR.NOMBRE_077,GESTOR.APEL1_077,GESTOR.APEL2_077);
		END IF;
		
		Insert into AA79B54T00 (ANYO_054,NUM_EXP_054,DNI_SOLICITANTE_054,TIPO_ENTIDAD_054,ID_ENTIDAD_054,IND_VIP_054,DNI_REPRESENTANTE_054) 
		values (R_EXP_R75.ANYO_051, R_EXP_R75.NUM_EXP_051, GESTOR.DNI_SOLICITANTE_054, GESTOR.TIPO_ENTIDAD_054, GESTOR.ID_ENTIDAD_054, GESTOR.IND_VIP_054, null);
		
		
		-- insertamos los documentos
		Select AA79B56Q00.nextval into ID_DOCU_NUEVO from dual;
		
		Insert into AA79B56T00 (ID_DOC_056,ANYO_056,NUM_EXP_056,OID_FICHERO_056,RUTA_PIF_FICHERO_056,EXTENSION_DOC_056,TAMANO_DOC_056,IND_ENCRIPTADO_056,CONTENT_TYPE_056,
		ID_DOC_REL_056,CLASE_DOCUMENTO_056,TIPO_DOCUMENTO_056,TITULO_056,NUM_PAL_SOLIC_056,NUM_PAL_IZO_056,PERSONA_CONTACTO_056,EMAIL_CONTACTO_056,TELEFONO_CONTACTO_056,
		DIRECCION_CONTACTO_056,ENTIDAD_CONTACTO_056,IND_VISIBLE_056,FECHA_ALTA_056,DNI_ALTA_056,ID_DOC_VERSION_056,NOMBRE_FICHERO_056,IND_ORIGEN_056) 
		Select ID_DOCU_NUEVO, ANYO_056, NUM_EXP_056, OID_FICHERO_056, RUTA_PIF_FICHERO_056, EXTENSION_DOC_056, TAMANO_DOC_056, IND_ENCRIPTADO_056,
        CONTENT_TYPE_056, ID_DOC_REL_056, CLASE_DOCUMENTO_056, TIPO_DOCUMENTO_056, TITULO_056, NUM_PAL_SOLIC_056, NUM_PAL_IZO_056, PERSONA_CONTACTO_056, 
		EMAIL_CONTACTO_056, TELEFONO_CONTACTO_056, DIRECCION_CONTACTO_056, ENTIDAD_CONTACTO_056, IND_VISIBLE_056, FECHA_ALTA_056, DNI_ALTA_056,
		ID_DOC_VERSION_056, NOMBRE_FICHERO_056, IND_ORIGEN_056 from(      
		select T39_COD_TIPO_DOCUMENTO AS TIPO_DOCUMENTO_056, t39_anyo AS ANYO_056, t39_N_EXP AS NUM_EXP_056,
		DECODE(INSTR(T38_NOMBRE_DOC,'.',-1),'0','mmm',SUBSTR(T38_NOMBRE_DOC,INSTR(T38_NOMBRE_DOC,'.',-1) +1,length(T38_NOMBRE_DOC))) AS EXTENSION_DOC_056,
		T38_OID AS OID_FICHERO_056, null  AS RUTA_PIF_FICHERO_056, T38_TAMANO AS TAMANO_DOC_056, 'N' AS IND_ENCRIPTADO_056,
		null AS ID_DOC_REL_056, 
		CASE WHEN T30_COD_TIPO_EXP=2 THEN 2
	    ELSE CASE WHEN T30_COD_TIPO_EXP=3 THEN 1
	    ELSE NULL END END AS CLASE_DOCUMENTO_056,
		T38_TIPO AS CONTENT_TYPE_056, DECODE(INSTR(T38_NOMBRE_DOC,'.',-1),0,T38_NOMBRE_DOC,SUBSTR(T38_NOMBRE_DOC,1,INSTR(T38_NOMBRE_DOC,'.',-1)-1))    AS TITULO_056,
		T39_TOT_PAL AS NUM_PAL_SOLIC_056, T39_TOT_PAL AS NUM_PAL_IZO_056,
		null AS PERSONA_CONTACTO_056, null AS EMAIL_CONTACTO_056, null AS TELEFONO_CONTACTO_056, null AS DIRECCION_CONTACTO_056, null AS ENTIDAD_CONTACTO_056,
		'S' AS IND_VISIBLE_056, T38_FECHA AS FECHA_ALTA_056, '16265343' AS DNI_ALTA_056, null AS ID_DOC_VERSION_056, T38_NOMBRE_DOC  AS NOMBRE_FICHERO_056,
		DECODE(t30_VIA_WEB,'1','E','0','I','3','E') AS IND_ORIGEN_056 
		from r75b.r7530t00,r75b.r7532t00,r75b.r7539t00,r75b.r7538t00 where  nvl(t39_COD_DOC1,t39_COD_DOC2)=t38_COD_DOC and
		t30_anyo = t32_anyo and t30_N_EXP=t32_N_EXP AND T30_FASE=T32_FASE AND  t39_COD_DOC2 is not null and 
		t30_fase = 5  and T30_COD_TIPO_EXP in (2,3) and t30_anyo = t39_anyo and t30_N_EXP=t39_N_EXP 
        AND t30_anyo = R_EXP_R75.ANYO_051 AND t30_n_exp =R_EXP_R75.NUM_EXP_051 
        AND t39_anyo||'@'||t39_N_EXP||'@'||t39_FASE  in (select  t39_anyo||'@'||t39_N_EXP||'@'||max(t39_FASE) from r75b.r7539t00
		group by T39_anyo,t39_N_EXP));
		
		-- insertamos la bitácora
		Insert into AA79B59T00 (ANYO_059,NUM_EXP_059,ID_ESTADO_BITACORA_059,ID_ESTADO_EXP_059,ID_FASE_EXPEDIENTE_059,DATO_ADIC_059,INFO_ADIC_059,ID_RECHAZO_059,ID_REQUERIMIENTO_059,ID_ANULACION_059,FECHA_ALTA_059) 
		values (R_EXP_R75.ANYO_051,R_EXP_R75.NUM_EXP_051,ID_BITACORA,'1','1',null,null,null,null,null,R_EXP_R75.FECHA_ALTA_051);
		ID_BITACORA:= ID_BITACORA + 1;
		IF (R_EXP_R75.ORIGEN_051 <> 'O') THEN
			Insert into AA79B59T00 (ANYO_059,NUM_EXP_059,ID_ESTADO_BITACORA_059,ID_ESTADO_EXP_059,ID_FASE_EXPEDIENTE_059,DATO_ADIC_059,INFO_ADIC_059,ID_RECHAZO_059,ID_REQUERIMIENTO_059,ID_ANULACION_059,FECHA_ALTA_059) 
			values (R_EXP_R75.ANYO_051,R_EXP_R75.NUM_EXP_051,ID_BITACORA,'2','2',null,null,null,null,null,R_EXP_R75.FECHA_ALTA_051);
			ID_BITACORA:= ID_BITACORA + 1;
			
			Insert into AA79B59T00 (ANYO_059,NUM_EXP_059,ID_ESTADO_BITACORA_059,ID_ESTADO_EXP_059,ID_FASE_EXPEDIENTE_059,DATO_ADIC_059,INFO_ADIC_059,ID_RECHAZO_059,ID_REQUERIMIENTO_059,ID_ANULACION_059,FECHA_ALTA_059) 
			values (R_EXP_R75.ANYO_051,R_EXP_R75.NUM_EXP_051,ID_BITACORA,'2','3',null,null,null,null,null,R_EXP_R75.FECHA_ALTA_051);
			ID_BITACORA:= ID_BITACORA + 1;
			
			Insert into AA79B79T00 (ID_079,ANYO_079,NUM_EXP_079,ID_ACCION_BITACORA_079,FECHA_ALTA_079,USUARIO_079) 
			values (AA79B79Q00.nextVal,R_EXP_R75.ANYO_051,R_EXP_R75.NUM_EXP_051,1,R_EXP_R75.FECHA_ALTA_051, nvl(GESTOR.APEL1_077,'') || ' ' ||nvl(GESTOR.APEL1_077,'') || ', ' || GESTOR.NOMBRE_077);
		ELSE
			Insert into AA79B79T00 (ID_079,ANYO_079,NUM_EXP_079,ID_ACCION_BITACORA_079,FECHA_ALTA_079,USUARIO_079) 
			values (AA79B79Q00.nextVal,R_EXP_R75.ANYO_051,R_EXP_R75.NUM_EXP_051,1,R_EXP_R75.FECHA_ALTA_051,'IZO');
		END IF;
		Insert into AA79B59T00 (ANYO_059,NUM_EXP_059,ID_ESTADO_BITACORA_059,ID_ESTADO_EXP_059,ID_FASE_EXPEDIENTE_059,DATO_ADIC_059,INFO_ADIC_059,ID_RECHAZO_059,ID_REQUERIMIENTO_059,ID_ANULACION_059,FECHA_ALTA_059) 
		values (R_EXP_R75.ANYO_051,R_EXP_R75.NUM_EXP_051,ID_BITACORA,'3','9',null,null,null,null,null,R_EXP_R75.FECHA_ALTA_051);
		ID_BITACORA:= ID_BITACORA + 1;
		
		-- Bitacora solicitante
		Insert into AA79B79T00 (ID_079,ANYO_079,NUM_EXP_079,ID_ACCION_BITACORA_079,FECHA_ALTA_079,USUARIO_079) 
		values (AA79B79Q00.nextVal,R_EXP_R75.ANYO_051,R_EXP_R75.NUM_EXP_051,17,R_EXP_R75.FECHA_ALTA_051,'IZO');
    	
    	
    	IF (R_EXP_R75.ORIGEN_051 <> 'O') THEN
    		--copiamos de los expedientes a la solicitud
    		Insert into AA79B69T00 (ANYO_069,NUM_EXP_069,ID_TIPO_EXPEDIENTE_069,FECHA_ALTA_069,TITULO_069) SELECT 
			ANYO_051, NUM_EXP_051,ID_TIPO_EXPEDIENTE_051,FECHA_ALTA_051,TITULO_051 from aa79b51t00 where ANYO_051 = R_EXP_R75.ANYO_051 and NUM_EXP_051= R_EXP_R75.NUM_EXP_051;
	
			-- observaciones en la 72
			Insert into AA79B72T00 (ANYO_072, NUM_EXP_072,  OBSERVACIONES_072)
			SELECT ANYO_055, NUM_EXP_055,  OBSERVACIONES_055 from aa79b55t00 where ANYO_055 = R_EXP_R75.ANYO_051 and NUM_EXP_055= R_EXP_R75.NUM_EXP_051;
			
    		IF (R_EXP_R75.ID_TIPO_EXPEDIENTE_051 = 'I') THEN
    			--en la 70
    			Insert INTO AA79B70T00 (ANYO_070, NUM_EXP_070, MODO_INTERPRETACION_070, TIPO_ACTO_070, TIPO_PETICIONARIO_070, IND_PROGRAMADA_070,
				FECHA_INI_070, FECHA_FIN_070, DIR_NORA_070, IND_PRESUPUESTO_070, PERSONA_CONTACTO_070, EMAIL_CONTACTO_070, TELEFONO_CONTACTO_070, IND_OBSERVACIONES_070)
    			Select ANYO_052, NUM_EXP_052, MODO_INTERPRETACION_052, TIPO_ACTO_052, TIPO_PETICIONARIO_052, IND_PROGRAMADA_052,
				FECHA_INI_052, FECHA_FIN_052, DIR_NORA_052, IND_PRESUPUESTO_052, PERSONA_CONTACTO_052, EMAIL_CONTACTO_052, TELEFONO_CONTACTO_052, IND_OBSERVACIONES_052
				from AA79B52T00 WHERE ANYO_052 = R_EXP_R75.ANYO_051 and NUM_EXP_052= R_EXP_R75.NUM_EXP_051;
			ELSE
    			INSERT INTO AA79B71T00 (ANYO_071,NUM_EXP_071,
				IND_PUBLICAR_BOPV_071,ID_IDIOMA_071,IND_CONFIDENCIAL_071,IND_CORREDACCION_071,TEXTO_071,TIPO_REDACCION_071,PARTICIPANTES_071,REF_TRAMITAGUNE_071,
				NUM_TOTAL_PAL_SOLIC_071,FECHA_FINAL_SOLIC_071,IND_FACTURABLE_071,ID_RELEVANCIA_071,
				IND_URGENTE_071,IND_PRESUPUESTO_071,IND_OBSERVACIONES_071)
				SELECT ANYO_053 as ANYO_071,NUM_EXP_053 as NUM_EXP_071,
				IND_PUBLICAR_BOPV_053 as IND_PUBLICAR_BOPV_071,
				ID_IDIOMA_053 as ID_IDIOMA_071,
				IND_CONFIDENCIAL_053 as IND_CONFIDENCIAL_071,
				IND_CORREDACCION_053 as IND_CORREDACCION_071,
				TEXTO_053 as TEXTO_071,
				TIPO_REDACCION_053 as TIPO_REDACCION_071,
				PARTICIPANTES_053 as PARTICIPANTES_071,
				REF_TRAMITAGUNE_053 as REF_TRAMITAGUNE_071,
				NUM_TOTAL_PAL_SOLIC_053 as NUM_TOTAL_PAL_SOLIC_071,
				FECHA_FINAL_SOLIC_053 as FECHA_FINAL_SOLIC_071,
				IND_FACTURABLE_053 as IND_FACTURABLE_071,
				ID_RELEVANCIA_053 as ID_RELEVANCIA_071,
				IND_URGENTE_053 as IND_URGENTE_071,
				IND_PRESUPUESTO_053 as IND_PRESUPUESTO_071,
				IND_OBSERVACIONES_053 as IND_OBSERVACIONES_071
				from aa79b53t00 where ANYO_053 = R_EXP_R75.ANYO_051 and NUM_EXP_053= R_EXP_R75.NUM_EXP_051;
    		END IF;
    		-- documentos
    		Insert into AA79B73T00 (ANYO_073,CLASE_DOCUMENTO_073,CONTENT_TYPE_073,DIRECCION_CONTACTO_073,EMAIL_CONTACTO_073,ENTIDAD_CONTACTO_073,EXTENSION_DOC_073,FECHA_ALTA_073,ID_DOC_REL_073,	
			ID_DOC_073,IND_ENCRIPTADO_073,NOMBRE_FICHERO_073,NUM_EXP_073,NUM_PAL_SOLIC_073,OID_FICHERO_073,PERSONA_CONTACTO_073,TAMANO_DOC_073,TELEFONO_CONTACTO_073,	
			TIPO_DOCUMENTO_073,TITULO_073) SELECT 
			ANYO_056, CLASE_DOCUMENTO_056,CONTENT_TYPE_056,DIRECCION_CONTACTO_056,EMAIL_CONTACTO_056,ENTIDAD_CONTACTO_056,EXTENSION_DOC_056,FECHA_ALTA_056,ID_DOC_REL_056,	
			ID_DOC_056,IND_ENCRIPTADO_056,NOMBRE_FICHERO_056,NUM_EXP_056,NUM_PAL_SOLIC_056,OID_FICHERO_056,PERSONA_CONTACTO_056,TAMANO_DOC_056,TELEFONO_CONTACTO_056,	
			TIPO_DOCUMENTO_056,TITULO_056 from AA79B56T00 where ANYO_056 = R_EXP_R75.ANYO_051 and NUM_EXP_056= R_EXP_R75.NUM_EXP_051;
    		
    	END IF;
    	
    	-- DAMOS DE ALTA LAS TAREAS DE TRADUCCION O INTERPRETACION
    	IF (R_EXP_R75.ID_TIPO_EXPEDIENTE_051 = 'I') THEN
    		-- Bucle con las tareas de interpretación
    		QUERY_DOCUS:= 'Select ''8'' as ID_TIPO_TAREA_081, null as ID_TIPO_REVISION_081, t30_anyo as ANYO_081, t30_N_EXP as NUM_EXP_081, ';
    		QUERY_DOCUS:= QUERY_DOCUS || '''N'' as IND_FACTURABLE_081, T26_FEC_INI_PREV as FECHA_INICIO_081, T26_FEC_FIN_PREV as FECHA_FIN_081, T26_NUM_HORAS/60 as HORAS_PREVISTAS_081,  ';
    		QUERY_DOCUS:= QUERY_DOCUS || '''I'' as RECURSO_ASIGNACION_081, ''16265343'' as DNI_RECURSO_081, null as TIPO_ENTIDAD_081, null as ID_ENTIDAD_081, null as ID_LOTE_081,';
    		QUERY_DOCUS:= QUERY_DOCUS || '3 as ESTADO_ASIGNACION_081, 3 as ESTADO_EJECUCION_081, null as OBSERV_081, 1 as ORDEN_081, ''16265343'' as DNI_ASIGNADOR_081, ';
    		QUERY_DOCUS:= QUERY_DOCUS || 'T26_FEC_ASIGNACION as FECHA_ASIGNACION_081, T26_FEC_ACEPTACION as FECHA_ACEPTACION_081, null as ID_TAREA_REL_081, ';
    		QUERY_DOCUS:= QUERY_DOCUS || 'null as ID_REQUERIMIENTO_081, ''N'' as IND_NO_CONFORMIDAD_081  ';
    		QUERY_DOCUS:= QUERY_DOCUS || 'from r75b.r7530t00,r75b.r7531t00,r75b.r7526t00 where t30_anyo =' || R_EXP_R75.ANYO_051 ||' and t30_N_EXP= ' || R_EXP_R75.NUM_EXP_051 ||' and t30_anyo = t31_anyo ';
    		QUERY_DOCUS:= QUERY_DOCUS || 'and t30_N_EXP=t31_N_EXP AND T30_FASE=T31_FASE AND t30_fase = 4  and T30_COD_TIPO_EXP=4 and t30_anyo = t26_anyo and t30_N_EXP=t26_N_EXP ';
    		QUERY_DOCUS:= QUERY_DOCUS || 'AND t26_anyo||''@''||t26_N_EXP||''@''||t26_COD_TAREA in (select t26_anyo||''@''||t26_n_exp||''@''||max(t26_COD_TAREA) from r75b.r7526t00 ';
    		QUERY_DOCUS:= QUERY_DOCUS || 'group by T26_anyo,t26_N_EXP) ';
    			
	    	open C_TAREAS_INTER for (QUERY_DOCUS);
			fetch C_TAREAS_INTER into R_TAREAS_INTER;
			WHILE C_TAREAS_INTER%FOUND LOOP
	    		SELECT AA79B81Q00.nextVal into ID_TAREA_NUEVO from dual;	
			
	    		Insert into AA79B81T00 (ID_TAREA_081,ID_TIPO_TAREA_081,ID_TIPO_REVISION_081,ANYO_081,NUM_EXP_081,IND_FACTURABLE_081,FECHA_INICIO_081,
				FECHA_FIN_081,HORAS_PREVISTAS_081,RECURSO_ASIGNACION_081,DNI_RECURSO_081,TIPO_ENTIDAD_081,ID_ENTIDAD_081,ID_LOTE_081,ESTADO_ASIGNACION_081,
				ESTADO_EJECUCION_081,OBSERV_081,ORDEN_081,DNI_ASIGNADOR_081,FECHA_ASIGNACION_081,FECHA_ACEPTACION_081,ID_TAREA_REL_081,ID_REQUERIMIENTO_081,
				IND_NO_CONFORMIDAD_081) values (ID_TAREA_NUEVO, R_TAREAS_INTER.ID_TIPO_TAREA_081, R_TAREAS_INTER.ID_TIPO_REVISION_081, R_EXP_R75.ANYO_051, R_EXP_R75.NUM_EXP_051,
				R_TAREAS_INTER.IND_FACTURABLE_081, R_TAREAS_INTER.FECHA_INICIO_081, R_TAREAS_INTER.FECHA_FIN_081, FORMAT_HORA_MINUTOS(R_TAREAS_INTER.HORAS_PREVISTAS_081),
				R_TAREAS_INTER.RECURSO_ASIGNACION_081, R_TAREAS_INTER.DNI_RECURSO_081, R_TAREAS_INTER.TIPO_ENTIDAD_081, R_TAREAS_INTER.ID_ENTIDAD_081, R_TAREAS_INTER.ID_LOTE_081,
				R_TAREAS_INTER.ESTADO_ASIGNACION_081, R_TAREAS_INTER.ESTADO_EJECUCION_081, R_TAREAS_INTER.OBSERV_081, ORDEN_TAREA, R_TAREAS_INTER.DNI_ASIGNADOR_081,
				R_TAREAS_INTER.FECHA_ASIGNACION_081, R_TAREAS_INTER.FECHA_ACEPTACION_081, R_TAREAS_INTER.ID_TAREA_REL_081, 
				R_TAREAS_INTER.ID_REQUERIMIENTO_081, R_TAREAS_INTER.IND_NO_CONFORMIDAD_081);
				 
				-- obtenemos el porcentaje de euskera
				select nvl(T31_POR_EUSK,0) into POR_EUSKERA
				from r75b.r7530t00,r75b.r7531t00 where t30_anyo = R_EXP_R75.ANYO_051 and t30_N_EXP= R_EXP_R75.NUM_EXP_051
				and t30_anyo = t31_anyo and t30_N_EXP=t31_N_EXP AND T30_FASE=T31_FASE AND
				t30_fase= 5;
				
				Insert into AA79B82T00 (ID_TAREA_082,DNI_RECURSO_082,FECHA_EJECUCION_082,HORAS_TAREA_082,IND_REALIZADA_082,IND_OBSV_082,POR_USO_EUSKERA_082) 
				values (ID_TAREA_NUEVO,'16265343',R_EXP_R75.FECHA_ENTREGA,null,'S','N',POR_EUSKERA);
	    		
				fetch C_TAREAS_INTER into R_TAREAS_INTER;
	  		END LOOP;
    	
  		ELSE IF (R_EXP_R75.ID_TIPO_EXPEDIENTE_051 = 'T') THEN
    			-- RECUPERAMOS LOS DATOS DE LAS TAREA DE PROVEEDOR
				QUERY_DOCUS:= 'Select null as ID_TIPO_REVISION_081, t30_anyo as ANYO_081, t30_N_EXP as NUM_EXP_081, ';
				QUERY_DOCUS:= QUERY_DOCUS || 'T26_FEC_INI_PREV as FECHA_INICIO_081, T40_FEC_FIN_PREV as FECHA_FIN_081, FORMAT_HORA_MINUTOS(T40_NUM_HORAS/60) as HORAS_PREVISTAS_081, ';
				QUERY_DOCUS:= QUERY_DOCUS || 'T12_COD_RECURSO as COD_RECURSO, T12_COD_TIPO_RECURSO as TIPO_RECURSO, T40_TIPO_TAREA, ';
				QUERY_DOCUS:= QUERY_DOCUS || 'T26_FEC_ASIGNACION as FECHA_ASIGNACION_081, T26_FEC_ACEPTACION as FECHA_ACEPTACION_081, ';
                QUERY_DOCUS:= QUERY_DOCUS || 'doccli.T38_COD_DOC, doccli.T38_TIPO, doccli.T38_TAMANO, doccli.T38_FECHA, doccli.T38_NOMBRE_DOC, doccli.T38_OID,  ';
                QUERY_DOCUS:= QUERY_DOCUS || 'docfin.T38_COD_DOC, docfin.T38_TIPO, docfin.T38_TAMANO, docfin.T38_FECHA, docfin.T38_NOMBRE_DOC, docfin.T38_OID ';
				QUERY_DOCUS:= QUERY_DOCUS || 'from r75b.r7530t00 ';
                QUERY_DOCUS:= QUERY_DOCUS || 'JOIN r75b.r7540t00 on t30_anyo = t40_anyo and t30_N_EXP=t40_N_EXP ';
                QUERY_DOCUS:= QUERY_DOCUS || 'JOIN r75b.r7526t00 ON T40_ANYO = T26_ANYO AND T40_FASE = T26_FASE AND T40_N_EXP = T26_N_EXP AND T40_COD_ORIG = T26_COD_ORIG AND T40_COD_TRAB = T26_COD_TRAB ';
                QUERY_DOCUS:= QUERY_DOCUS || 'JOIN r75b.r7512t00 ON  T26_COD_RECURSO = T12_COD_RECURSO ';
                QUERY_DOCUS:= QUERY_DOCUS || 'LEFT JOIN r75b.r7538t00 doccli ON  T40_COD_DOC1 = doccli.T38_COD_DOC ';
                QUERY_DOCUS:= QUERY_DOCUS || 'LEFT JOIN r75b.r7538t00 docfin ON  T40_COD_DOC2 = docfin.T38_COD_DOC ';
                QUERY_DOCUS:= QUERY_DOCUS || 'WHERE ';
                QUERY_DOCUS:= QUERY_DOCUS || 't30_fase = 5  and t30_anyo =' || R_EXP_R75.ANYO_051 ||' and t30_N_EXP= ' || R_EXP_R75.NUM_EXP_051 ||' ';
                QUERY_DOCUS:= QUERY_DOCUS || 'AND T40_TIPO_TAREA in (1) ORDER BY T40_TIPO_TAREA ASC ';
				
				open C_TAREAS_TRAD for (QUERY_DOCUS);
				fetch C_TAREAS_TRAD into R_TAREASTRAD;
				WHILE C_TAREAS_TRAD%FOUND LOOP
                    IF (R_TAREASTRAD.T40_TIPO_TAREA = 1) THEN
		    			-- TRADUCCION
		    			IF (R_TAREASTRAD.TIPO_RECURSO = 4) THEN 
		    				-- SE TRATA DE UN PROVEEDOR OBTENEMOS LOS DATOS DEL LOTE
			             	SELECT T18_COD_PROVEEDOR, T18_COD_LOTE, T18_DESC, T18_URGENCIA,T18_DIFICULTAD, T18_IMP_EUSK_CAST, T18_IMP_CAST_EUSK, T18_POR_RANGO_95_100, T18_POR_RANGO_85_94,
		            		T18_POR_IVA_LOTE,T18_FEC_INI, T18_FEC_FIN, T18_IMP_TOTAL, T18_IMP_CONSUMIDO, T18_IMP_PREVISTO, T18_IMP_RESTANTE, T18_IMP_DISPONIBLE, TIPO_X54, ID_X54 into LOTE FROM  r75b.R7516V00, CODR75X54J  
		                	WHERE T18_COD_LOTE = R_TAREASTRAD.COD_RECURSO AND ID_R75 = T18_COD_PROVEEDOR;
		                	-- COMPROBAMOS SI EXISTE EL LOTE Y SI NO EXISTE LO INSERTAMOS.
							BEGIN
								SELECT ID_LOTE_029 into ID_LOTE FROM AA79B29T00 WHERE COD_R75_029 = LOTE.T18_COD_LOTE;
							EXCEPTION
		        				WHEN NO_DATA_FOUND THEN
		   
					        	SELECT AA79B29Q00.nextVal into ID_LOTE from dual;
					        	-- INSERTAMOS LOTE
					        	INSERT INTO AA79B29T00 (ID_LOTE_029, TIPO_ENTIDAD_029, ID_EMPRESA_PROV_029, NOMBRE_LOTE_029, DESC_LOTE_EU_029, DESC_LOTE_ES_029, DNI_CONTACTO_029,
		        				FECHA_INICIO_029, FECHA_FIN_029, IMPORTE_ASIGNADO_029, IMPORTE_CONSUMIDO_029, ID_IDIOMA_DESTINO_029, IMPORTE_PALABRA_029, POR_PAGO_PAL_CONCOR_85_94_029,
		        				POR_PAGO_PAL_CONCOR_95_100_029, POR_REVISION_029, POR_RECARGO_FORMATO_029, IND_RECARGO_APREMIO_029, POR_RECARGO_APREMIO_029, ID_TIPO_PENALIZACION_029,
		        				POR_PENALIZACION_029, RESOLUCION_029, COD_R75_029) VALUES (ID_LOTE, LOTE.TIPO_X54, LOTE.ID_X54, LOTE.T18_DESC, LOTE.T18_DESC, LOTE.T18_DESC, NULL, 
		        				LOTE.T18_FEC_INI, LOTE.T18_FEC_FIN, LOTE.T18_IMP_TOTAL, LOTE.T18_IMP_CONSUMIDO, 2, LOTE.T18_IMP_CAST_EUSK, LOTE.T18_POR_RANGO_85_94, 
		        				LOTE.T18_POR_RANGO_95_100, 0, LOTE.T18_DIFICULTAD, 'S', LOTE.T18_URGENCIA, 1,0, NULL, LOTE.T18_COD_LOTE);
							END;	
                            
                            
		                	-- CREAMOS LA TAREA DE TRADUCCION DEL PROVEEDOR y EL DOCU ASOCIADO
							SELECT AA79B81Q00.nextVal into ID_TAREA_NUEVO from dual;
							Insert into AA79B81T00 (ID_TAREA_081,ID_TIPO_TAREA_081,ID_TIPO_REVISION_081,ANYO_081,NUM_EXP_081,IND_FACTURABLE_081,FECHA_INICIO_081,
							FECHA_FIN_081,HORAS_PREVISTAS_081,RECURSO_ASIGNACION_081,DNI_RECURSO_081,TIPO_ENTIDAD_081,ID_ENTIDAD_081,ID_LOTE_081,ESTADO_ASIGNACION_081,
							ESTADO_EJECUCION_081,OBSERV_081,ORDEN_081,DNI_ASIGNADOR_081,FECHA_ASIGNACION_081,FECHA_ACEPTACION_081,ID_TAREA_REL_081,ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081) 
							values (ID_TAREA_NUEVO,'2', null, R_TAREASTRAD.ANYO_081, R_TAREASTRAD.NUM_EXP_081, 'S', R_TAREASTRAD.FECHA_INICIO_081,
							R_TAREASTRAD.FECHA_FIN_081, R_TAREASTRAD.HORAS_PREVISTAS_081, 'P', null, null, null, ID_LOTE, 3, 3, null, ORDEN_TAREA, '16265343', R_TAREASTRAD.FECHA_ASIGNACION_081, 
							R_TAREASTRAD.FECHA_ACEPTACION_081, null, null, 'N');
							ORDEN_TAREA:= ORDEN_TAREA + 1;
							
							Insert into AA79B82T00 (ID_TAREA_082,DNI_RECURSO_082,FECHA_EJECUCION_082,HORAS_TAREA_082,IND_REALIZADA_082,IND_OBSV_082,POR_USO_EUSKERA_082) 
							values (ID_TAREA_NUEVO,'16265343',R_TAREASTRAD.FECHA_FIN_081,R_TAREASTRAD.HORAS_PREVISTAS_081,'S','N',null);
                            
							
							-- MIRAMOS SI HAY QUE CREAR UN DOCUMENTO DE TRABAJO
							IF (R_TAREASTRAD.T38_OID_CLI is not null) then
							SELECT COUNT(1) into contador from AA79B56T00 WHERE ANYO_056 = R_EXP_R75.ANYO_051 AND NUM_EXP_056 = R_EXP_R75.NUM_EXP_051 AND 
							OID_FICHERO_056 = R_TAREASTRAD.T38_OID_CLI;
                            
							
							IF (CONTADOR = 0 ) THEN
								Select AA79B56Q00.nextval into ID_DOCU_TAREA from dual;
								Insert into AA79B56T00 (ID_DOC_056,ANYO_056,NUM_EXP_056,OID_FICHERO_056,RUTA_PIF_FICHERO_056,EXTENSION_DOC_056,TAMANO_DOC_056,IND_ENCRIPTADO_056,CONTENT_TYPE_056,
								ID_DOC_REL_056,CLASE_DOCUMENTO_056,TIPO_DOCUMENTO_056,TITULO_056,NUM_PAL_SOLIC_056,NUM_PAL_IZO_056,PERSONA_CONTACTO_056,EMAIL_CONTACTO_056,TELEFONO_CONTACTO_056,
								DIRECCION_CONTACTO_056,ENTIDAD_CONTACTO_056,IND_VISIBLE_056,FECHA_ALTA_056,DNI_ALTA_056,ID_DOC_VERSION_056,NOMBRE_FICHERO_056,IND_ORIGEN_056) 
								values (ID_DOCU_TAREA, R_EXP_R75.ANYO_051, R_EXP_R75.NUM_EXP_051, R_TAREASTRAD.T38_OID_CLI, null, 
								DECODE(INSTR(R_TAREASTRAD.T38_NOMBRE_DOC_CLI,'.',-1),'0','mmm',SUBSTR(R_TAREASTRAD.T38_NOMBRE_DOC_CLI,INSTR(R_TAREASTRAD.T38_NOMBRE_DOC_CLI,'.',-1) +1,length(R_TAREASTRAD.T38_NOMBRE_DOC_CLI))),
								R_TAREASTRAD.T38_TAMANO_CLI, 'N', R_TAREASTRAD.T38_TIPO_CLI, null, 4, null, 
								DECODE(INSTR(R_TAREASTRAD.T38_NOMBRE_DOC_CLI,'.',-1),0,R_TAREASTRAD.T38_NOMBRE_DOC_CLI,SUBSTR(R_TAREASTRAD.T38_NOMBRE_DOC_CLI,1,INSTR(R_TAREASTRAD.T38_NOMBRE_DOC_CLI,'.',-1)-1)),
								null, null, null, null, null, null, null, 'S', R_TAREASTRAD.T38_FECHA_CLI, '16265343', null, R_TAREASTRAD.T38_NOMBRE_DOC_CLI, 'I');
							ELSE	
								SELECT ID_DOC_056 into ID_DOCU_TAREA from AA79B56T00 WHERE ANYO_056 = R_EXP_R75.ANYO_051 AND NUM_EXP_056 = R_EXP_R75.NUM_EXP_051 AND 
								OID_FICHERO_056 = R_TAREASTRAD.T38_OID_CLI;
							END IF;
                            ELSE
                                 ID_DOCU_TAREA:= ID_DOCU_NUEVO;
                            END IF;
							Insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) values (ID_TAREA_NUEVO, ID_DOCU_TAREA);
							
                            
							IF (ID_FICHERO_USADO = 'S') THEN
								SELECT AA79B88Q00.nextVal into ID_NUEVO_FICHERO_FINAL from dual;
								ID_FICHERO_USADO:= 'N';
							END IF;
			    			
							Insert into AA79B88T00 (ID_FICHERO_088,TITULO_FICHERO_088,EXTENSION_FICHERO_088,CONTENT_TYPE_FICHERO_088,TAMANO_FICHERO_088,
							IND_ENCRIPTADO_088,RUTA_PIF_FICHERO_088,OID_FICHERO_088,NOMBRE_FICHERO_088) 
							values (ID_NUEVO_FICHERO_FINAL, SUBSTR(R_TAREASTRAD.T38_NOMBRE_DOC_FIN,1,INSTR(R_TAREASTRAD.T38_NOMBRE_DOC_FIN,'.',-1)-1),
							DECODE(INSTR(R_TAREASTRAD.T38_NOMBRE_DOC_FIN,'.',-1),'0','mmm',SUBSTR(R_TAREASTRAD.T38_NOMBRE_DOC_FIN,INSTR(R_TAREASTRAD.T38_NOMBRE_DOC_FIN,'.',-1) +1,length(R_TAREASTRAD.T38_NOMBRE_DOC_FIN))),
							R_TAREASTRAD.T38_TIPO_FIN, R_TAREASTRAD.T38_TAMANO_FIN, 'N', null, R_TAREASTRAD.T38_OID_FIN, R_TAREASTRAD.T38_NOMBRE_DOC_FIN);
							
						    Insert into AA79B87T00 (ID_TAREA_087,ID_DOC_ORIG_087,ID_FICHERO_TRADUCIDO_087,FECHA_ALTA_087) 
							values (ID_TAREA_NUEVO,ID_DOCU_TAREA,ID_NUEVO_FICHERO_FINAL, R_TAREASTRAD.FECHA_FIN_081 );
						    ID_FICHERO_USADO:= 'S';
						    
			    			ID_TAREA_ANTERIOR:= ID_TAREA_NUEVO;
                            
				     
						     -- CREAMOS LA TAREA DE REVISION DE LA TRADUCCIÓN
						    /*SELECT AA79B81Q00.nextVal into ID_TAREA_NUEVO from dual;
							Insert into AA79B81T00 (ID_TAREA_081,ID_TIPO_TAREA_081,ID_TIPO_REVISION_081,ANYO_081,NUM_EXP_081,IND_FACTURABLE_081,FECHA_INICIO_081,
							FECHA_FIN_081,HORAS_PREVISTAS_081,RECURSO_ASIGNACION_081,DNI_RECURSO_081,TIPO_ENTIDAD_081,ID_ENTIDAD_081,ID_LOTE_081,ESTADO_ASIGNACION_081,
							ESTADO_EJECUCION_081,OBSERV_081,ORDEN_081,DNI_ASIGNADOR_081,FECHA_ASIGNACION_081,FECHA_ACEPTACION_081,ID_TAREA_REL_081,ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081) 
							values (ID_TAREA_NUEVO,'21', null, R_TAREASTRAD.ANYO_081, R_TAREASTRAD.NUM_EXP_081, 'N', R_TAREASTRAD.FECHA_INICIO_081,
							R_TAREASTRAD.FECHA_FIN_081, R_TAREASTRAD.HORAS_PREVISTAS_081, 'I', '16265343', null, null, null, 3, 3, null, ORDEN_TAREA, '16265343', R_TAREASTRAD.FECHA_ASIGNACION_081, 
							R_TAREASTRAD.FECHA_ACEPTACION_081, ID_TAREA_ANTERIOR, null, 'N');
							ORDEN_TAREA:= ORDEN_TAREA + 1;
							
							Insert into AA79B82T00 (ID_TAREA_082,DNI_RECURSO_082,FECHA_EJECUCION_082,HORAS_TAREA_082,IND_REALIZADA_082,IND_OBSV_082,POR_USO_EUSKERA_082) 
							values (ID_TAREA_NUEVO,'16265343',R_TAREASTRAD.FECHA_FIN_081,null,'S','N',null);
							
							Insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) values (ID_TAREA_NUEVO, ID_DOCU_TAREA);
							
                            dbms_output.put_line('TAREA_REVISION TRADUCCION');*/
                            
							-- CREAMOS LA TAREA DE REVISION DE DATOS DE FACTURACION
				    
						   SELECT AA79B81Q00.nextVal into ID_TAREA_NUEVO from dual;
							Insert into AA79B81T00 (ID_TAREA_081,ID_TIPO_TAREA_081,ID_TIPO_REVISION_081,ANYO_081,NUM_EXP_081,IND_FACTURABLE_081,FECHA_INICIO_081,
							FECHA_FIN_081,HORAS_PREVISTAS_081,RECURSO_ASIGNACION_081,DNI_RECURSO_081,TIPO_ENTIDAD_081,ID_ENTIDAD_081,ID_LOTE_081,ESTADO_ASIGNACION_081,
							ESTADO_EJECUCION_081,OBSERV_081,ORDEN_081,DNI_ASIGNADOR_081,FECHA_ASIGNACION_081,FECHA_ACEPTACION_081,ID_TAREA_REL_081,ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081) 
							values (ID_TAREA_NUEVO,'11', null, R_TAREASTRAD.ANYO_081, R_TAREASTRAD.NUM_EXP_081, 'N', R_TAREASTRAD.FECHA_INICIO_081,
							R_TAREASTRAD.FECHA_FIN_081, R_TAREASTRAD.HORAS_PREVISTAS_081, 'I', '16265343', null, null, null, 3, 3, null, ORDEN_TAREA, '16265343', R_TAREASTRAD.FECHA_ASIGNACION_081, 
							R_TAREASTRAD.FECHA_ACEPTACION_081, ID_TAREA_ANTERIOR, null, 'N');
							ORDEN_TAREA:= ORDEN_TAREA + 1;
							
							Insert into AA79B82T00 (ID_TAREA_082,DNI_RECURSO_082,FECHA_EJECUCION_082,HORAS_TAREA_082,IND_REALIZADA_082,IND_OBSV_082,POR_USO_EUSKERA_082) 
							values (ID_TAREA_NUEVO,'16265343',R_TAREASTRAD.FECHA_FIN_081,null,'S','N',null);
							
							Insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) values (ID_TAREA_NUEVO, ID_DOCU_TAREA);
                            
						     
			  				-- RECUPERAMOS LOS DATOS A PAGAR AL PROVEEDOR
							SELECT 
								a.T30_ANYO ANYO_094, 
							a.T30_N_EXP NUM_EXP_094,
							SUM(c.T39_TOT_PAL) NUM_TOTAL_PAL_094,
							SUM(c.T39_IZO_RANGO_0_84)  NUM_PAL_CONCOR_0_84_094, 
							SUM(c.T39_IZO_RANGO_85_94) NUM_PAL_CONCOR_85_94_094, 
							SUM(c.T39_IZO_RANGO_95_100) NUM_PAL_CONCOR_95_100_094, 
							DECODE(MAX(c.T39_NUM_PORCEN_FORMATO_TEXTO),0,'N','S') IND_RECARGO_FORMATO_094,
							MAX(c.T39_NUM_PORCEN_FORMATO_TEXTO) NUM_PAL_RECARGO_FORMATO_094,
							DECODE(MAX(c.T39_NUM_PORCEN_APREMIO_TEXTO),0,'N','S') IND_RECARGO_APREMIO_094,
							MAX(c.T39_NUM_PORCEN_APREMIO_TEXTO) POR_RECARGO_APREMIO_094,
		    				DECODE(MAX(c.T39_NUM_PORCEN_PENALIZADO),0,'N','S') IND_PENALIZACION_094,
							MAX(c.T39_NUM_PORCEN_PENALIZADO) POR_PENALIZACION_094,
							SUM(c.T39_POR_IVA_PROVEEDOR) IVA_APLIC_094,
						    MAX(c.T39_NUM_PRECIO_PROVEEDOR) IMPORTE_PAL_APLIC_094,
						    0 POR_REVISION_APLIC_094,
						    0 IMPORTE_TAREA_094,  
						    0 IMPORTE_RECARGO_FORMATO_094,  
						    0 IMPORTE_RECARGO_APREMIO_094,  
						    0 IMPORTE_PENALIZACION_094,  
						   	MAX(c.T39_IMP_A_FACTURAR_PROVEEDOR) IMPORTE_BASE_094,  
						    MAX((c.T39_IMP_PPTO_PROVEEDOR - c.T39_IMP_A_FACTURAR_PROVEEDOR)) IMPORTE_IVA_094,  
							 MAX (c.T39_IMP_PPTO_PROVEEDOR) IMPORTE_TOTAL_094,
							MIN(DECODE(a.T30_ALBARAN, NULL, 'N', 'S')) IND_PAGADO_094,
							MIN(DECODE(a.T30_ASOC_ALBARAN, 1, 'S', 'N')) IND_ALBARAN_094,
							MIN(a.T30_ALBARAN) T30_ALBARAN
							into DATOS_PAGO_PROVEEDOR
							FROM r75b.r7530t00 a 
							LEFT JOIN r75b.r7539t00 c 
							on a.T30_ANYO=c.T39_ANYO AND a.T30_N_EXP=c.T39_N_EXP AND a.T30_FASE=c.T39_FASE 
							LEFT JOIN r75b.r7532t00 d 
							on a.T30_ANYO=d.T32_ANYO AND a.T30_N_EXP=d.T32_N_EXP AND a.T30_FASE=d.T32_FASE 
							LEFT JOIN r75b.r7531t00 e 
							on a.T30_ANYO=e.T31_ANYO AND a.T30_N_EXP=e.T31_N_EXP AND a.T30_FASE=e.T31_FASE 
							WHERE a.T30_COD_TIPO_EXP <> 4  AND a.t30_anyo = R_EXP_R75.ANYO_051 AND a.t30_n_exp =R_EXP_R75.NUM_EXP_051 
							AND
							 a.t30_anyo||'@'||a.t30_N_EXP in (select x.t30_anyo||'@'||x.t30_N_EXP from r75b.r7530t00 x where x.T30_FASE=5)
							GROUP BY a.T30_ANYO, a.T30_N_EXP  ORDER BY a.T30_ANYO, a.T30_N_EXP;
							
							IF (DATOS_PAGO_PROVEEDOR.T30_ALBARAN is not null) THEN 
							-- COMPROBAMOS SI EXISTE EL ALBARAN Y SI NO EXISTE LO INSERTAMOS.
								BEGIN
									SELECT ID_099 into ID_ALBARAN FROM AA79B99T00 WHERE COD_R75_099 = DATOS_PAGO_PROVEEDOR.T30_ALBARAN;
								EXCEPTION
			        				WHEN NO_DATA_FOUND THEN
			   
						        	SELECT AA79B99Q00.nextVal into ID_ALBARAN from dual;
						        	-- INSERTAMOS ALBARAN
						        	INSERT INTO AA79B99T00 (ID_099, REF_ALBARAN_099, ID_LOTE_099, FECHA_ALTA_099, ESTADO_099, REF_FACTURA_099, IMPORTE_FACTURA_099, COD_R75_099) 
						        	SELECT ID_ALBARAN, T61_REF_ALBARAN, ID_LOTE, T61_FECHA, DECODE(T61_ESTADO, 'S',2,'E',3,'P',4,2),  T61_REF_FACTURA, T61_IMPORTE, DATOS_PAGO_PROVEEDOR.T30_ALBARAN 
						        	from r75b.R7561T00 where T61_COD_ALBARAN = DATOS_PAGO_PROVEEDOR.T30_ALBARAN;
								END;	
		    
		   					END IF;
							
		   					INSERT INTO AA79B94T00 (ID_TAREA_094, NUM_TOTAL_PAL_094, NUM_PAL_CONCOR_0_84_094, NUM_PAL_CONCOR_85_94_094, NUM_PAL_CONCOR_95_100_094,
							IND_RECARGO_FORMATO_094, NUM_PAL_RECARGO_FORMATO_094, IND_RECARGO_APREMIO_094, POR_RECARGO_APREMIO_094, IND_PENALIZACION_094, POR_PENALIZACION_094, 
							IVA_APLIC_094, IMPORTE_PAL_APLIC_094, POR_REVISION_APLIC_094, IMPORTE_TAREA_094, IMPORTE_RECARGO_FORMATO_094, IMPORTE_RECARGO_APREMIO_094, IMPORTE_PENALIZACION_094,  
		    				IMPORTE_BASE_094, IMPORTE_IVA_094, IMPORTE_TOTAL_094, IND_PAGADO_094, IND_ALBARAN_094, COD_ALBARAN_094)
		    				values(ID_TAREA_NUEVO, DATOS_PAGO_PROVEEDOR.NUM_TOTAL_PAL_094, DATOS_PAGO_PROVEEDOR.NUM_PAL_CONCOR_0_84_094, DATOS_PAGO_PROVEEDOR.NUM_PAL_CONCOR_85_94_094, 
		    				DATOS_PAGO_PROVEEDOR.NUM_PAL_CONCOR_95_100_094, DATOS_PAGO_PROVEEDOR.IND_RECARGO_FORMATO_094, DATOS_PAGO_PROVEEDOR.NUM_PAL_RECARGO_FORMATO_094, 
		    				DATOS_PAGO_PROVEEDOR.IND_RECARGO_APREMIO_094, DATOS_PAGO_PROVEEDOR.POR_RECARGO_APREMIO_094, DATOS_PAGO_PROVEEDOR.IND_PENALIZACION_094, DATOS_PAGO_PROVEEDOR.POR_PENALIZACION_094, 
							DATOS_PAGO_PROVEEDOR.IVA_APLIC_094, DATOS_PAGO_PROVEEDOR.IMPORTE_PAL_APLIC_094, DATOS_PAGO_PROVEEDOR.POR_REVISION_APLIC_094, DATOS_PAGO_PROVEEDOR.IMPORTE_TAREA_094, 
							DATOS_PAGO_PROVEEDOR.IMPORTE_RECARGO_FORMATO_094, DATOS_PAGO_PROVEEDOR.IMPORTE_RECARGO_APREMIO_094, DATOS_PAGO_PROVEEDOR.IMPORTE_PENALIZACION_094,  
		    				DATOS_PAGO_PROVEEDOR.IMPORTE_BASE_094, DATOS_PAGO_PROVEEDOR.IMPORTE_IVA_094, DATOS_PAGO_PROVEEDOR.IMPORTE_TOTAL_094, DATOS_PAGO_PROVEEDOR.IND_PAGADO_094, 
		    				DATOS_PAGO_PROVEEDOR.IND_ALBARAN_094, ID_ALBARAN);
		                	
		    			ELSE
		    				-- CREAMOS LA TAREA DE TRADUCCION INTERNA
							SELECT AA79B81Q00.nextVal into ID_TAREA_NUEVO from dual;
							Insert into AA79B81T00 (ID_TAREA_081,ID_TIPO_TAREA_081,ID_TIPO_REVISION_081,ANYO_081,NUM_EXP_081,IND_FACTURABLE_081,FECHA_INICIO_081,
							FECHA_FIN_081,HORAS_PREVISTAS_081,RECURSO_ASIGNACION_081,DNI_RECURSO_081,TIPO_ENTIDAD_081,ID_ENTIDAD_081,ID_LOTE_081,ESTADO_ASIGNACION_081,
							ESTADO_EJECUCION_081,OBSERV_081,ORDEN_081,DNI_ASIGNADOR_081,FECHA_ASIGNACION_081,FECHA_ACEPTACION_081,ID_TAREA_REL_081,ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081) 
							values (ID_TAREA_NUEVO,'2', null, R_TAREASTRAD.ANYO_081, R_TAREASTRAD.NUM_EXP_081, 'S', R_TAREASTRAD.FECHA_INICIO_081,
							R_TAREASTRAD.FECHA_FIN_081, R_TAREASTRAD.HORAS_PREVISTAS_081, 'I', '16265343', null, null, null, 3, 3, null, ORDEN_TAREA, '16265343', R_TAREASTRAD.FECHA_ASIGNACION_081, 
							R_TAREASTRAD.FECHA_ACEPTACION_081, null, null, 'N');
							ORDEN_TAREA:= ORDEN_TAREA + 1;
							
							Insert into AA79B82T00 (ID_TAREA_082,DNI_RECURSO_082,FECHA_EJECUCION_082,HORAS_TAREA_082,IND_REALIZADA_082,IND_OBSV_082,POR_USO_EUSKERA_082) 
							values (ID_TAREA_NUEVO,'16265343',R_TAREASTRAD.FECHA_FIN_081,R_TAREASTRAD.HORAS_PREVISTAS_081,'S','N',null);
							
							-- MIRAMOS SI HAY QUE CREAR UN DOCUMENTO DE TRABAJO
                            
                            IF (R_TAREASTRAD.T38_OID_CLI is not null) then
                            
							SELECT COUNT(1) into contador from AA79B56T00 WHERE ANYO_056 = R_EXP_R75.ANYO_051 AND NUM_EXP_056 = R_EXP_R75.NUM_EXP_051 AND 
							OID_FICHERO_056 = R_TAREASTRAD.T38_OID_CLI;
							
							IF (CONTADOR = 0 ) THEN
								Select AA79B56Q00.nextval into ID_DOCU_TAREA from dual;
								Insert into AA79B56T00 (ID_DOC_056,ANYO_056,NUM_EXP_056,OID_FICHERO_056,RUTA_PIF_FICHERO_056,EXTENSION_DOC_056,TAMANO_DOC_056,IND_ENCRIPTADO_056,CONTENT_TYPE_056,
								ID_DOC_REL_056,CLASE_DOCUMENTO_056,TIPO_DOCUMENTO_056,TITULO_056,NUM_PAL_SOLIC_056,NUM_PAL_IZO_056,PERSONA_CONTACTO_056,EMAIL_CONTACTO_056,TELEFONO_CONTACTO_056,
								DIRECCION_CONTACTO_056,ENTIDAD_CONTACTO_056,IND_VISIBLE_056,FECHA_ALTA_056,DNI_ALTA_056,ID_DOC_VERSION_056,NOMBRE_FICHERO_056,IND_ORIGEN_056) 
								values (ID_DOCU_TAREA, R_EXP_R75.ANYO_051, R_EXP_R75.NUM_EXP_051, R_TAREASTRAD.T38_OID_CLI, null, 
								DECODE(INSTR(R_TAREASTRAD.T38_NOMBRE_DOC_CLI,'.',-1),'0','mmm',SUBSTR(R_TAREASTRAD.T38_NOMBRE_DOC_CLI,INSTR(R_TAREASTRAD.T38_NOMBRE_DOC_CLI,'.',-1) +1,length(R_TAREASTRAD.T38_NOMBRE_DOC_CLI))),
								R_TAREASTRAD.T38_TAMANO_CLI, 'N', R_TAREASTRAD.T38_TIPO_CLI, null, 4, null, 
								DECODE(INSTR(R_TAREASTRAD.T38_NOMBRE_DOC_CLI,'.',-1),0,R_TAREASTRAD.T38_NOMBRE_DOC_CLI,SUBSTR(R_TAREASTRAD.T38_NOMBRE_DOC_CLI,1,INSTR(R_TAREASTRAD.T38_NOMBRE_DOC_CLI,'.',-1)-1)),
								null, null, null, null, null, null, null, 'S', R_TAREASTRAD.T38_FECHA_CLI, '16265343', null, R_TAREASTRAD.T38_NOMBRE_DOC_CLI, 'I');
							ELSE	
								SELECT ID_DOC_056 into ID_DOCU_TAREA from AA79B56T00 WHERE ANYO_056 = R_EXP_R75.ANYO_051 AND NUM_EXP_056 = R_EXP_R75.NUM_EXP_051 AND 
								OID_FICHERO_056 = R_TAREASTRAD.T38_OID_CLI;
							END IF;
                            ELSE
                                ID_DOCU_TAREA:= ID_DOCU_NUEVO;
                            END IF;
							Insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) values (ID_TAREA_NUEVO, ID_DOCU_TAREA);
							
							IF (ID_FICHERO_USADO = 'S') THEN
								SELECT AA79B88Q00.nextVal into ID_NUEVO_FICHERO_FINAL from dual;
								ID_FICHERO_USADO:= 'N';
							END IF;
			    			
							Insert into AA79B88T00 (ID_FICHERO_088,TITULO_FICHERO_088,EXTENSION_FICHERO_088,CONTENT_TYPE_FICHERO_088,TAMANO_FICHERO_088,
							IND_ENCRIPTADO_088,RUTA_PIF_FICHERO_088,OID_FICHERO_088,NOMBRE_FICHERO_088) 
							values (ID_NUEVO_FICHERO_FINAL, SUBSTR(R_TAREASTRAD.T38_NOMBRE_DOC_FIN,1,INSTR(R_TAREASTRAD.T38_NOMBRE_DOC_FIN,'.',-1)-1),
							DECODE(INSTR(R_TAREASTRAD.T38_NOMBRE_DOC_FIN,'.',-1),'0','mmm',SUBSTR(R_TAREASTRAD.T38_NOMBRE_DOC_FIN,INSTR(R_TAREASTRAD.T38_NOMBRE_DOC_FIN,'.',-1) +1,length(R_TAREASTRAD.T38_NOMBRE_DOC_FIN))),
							R_TAREASTRAD.T38_TIPO_FIN, R_TAREASTRAD.T38_TAMANO_FIN, 'N', null, R_TAREASTRAD.T38_OID_FIN, R_TAREASTRAD.T38_NOMBRE_DOC_FIN);
							
						    Insert into AA79B87T00 (ID_TAREA_087,ID_DOC_ORIG_087,ID_FICHERO_TRADUCIDO_087,FECHA_ALTA_087) 
							values (ID_TAREA_NUEVO,ID_DOCU_TAREA,ID_NUEVO_FICHERO_FINAL, R_TAREASTRAD.FECHA_FIN_081 );
						    ID_FICHERO_USADO:= 'S';
		    			END IF;
					
		    		END IF;
				fetch C_TAREAS_TRAD into R_TAREASTRAD;
	  			END LOOP;
	  	
	  			-- CREAMOS LA TAREA DE ENTREGA
                SELECT AA79B81Q00.nextVal into ID_TAREA_NUEVO from dual;
                Insert into AA79B81T00 (ID_TAREA_081,ID_TIPO_TAREA_081,ID_TIPO_REVISION_081,ANYO_081,NUM_EXP_081,IND_FACTURABLE_081,FECHA_INICIO_081,
                FECHA_FIN_081,HORAS_PREVISTAS_081,RECURSO_ASIGNACION_081,DNI_RECURSO_081,TIPO_ENTIDAD_081,ID_ENTIDAD_081,ID_LOTE_081,ESTADO_ASIGNACION_081,
                ESTADO_EJECUCION_081,OBSERV_081,ORDEN_081,DNI_ASIGNADOR_081,FECHA_ASIGNACION_081,FECHA_ACEPTACION_081,ID_TAREA_REL_081,ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081) 
                values (ID_TAREA_NUEVO,'19', null, R_EXP_R75.ANYO_051, R_EXP_R75.NUM_EXP_051, 'S', R_EXP_R75.FECHA_ENTREGA,
                R_EXP_R75.FECHA_ENTREGA, '1:00', 'I', '16265343', null, null, null, 3, 3, null, ORDEN_TAREA, '16265343', R_EXP_R75.FECHA_ENTREGA, 
                R_EXP_R75.FECHA_ENTREGA, null, null, 'N');
                ORDEN_TAREA:= ORDEN_TAREA + 1;
		                 
                Insert into AA79B82T00 (ID_TAREA_082,DNI_RECURSO_082,FECHA_EJECUCION_082,HORAS_TAREA_082,IND_REALIZADA_082,IND_OBSV_082,POR_USO_EUSKERA_082) 
                values (ID_TAREA_NUEVO,'16265343',R_EXP_R75.FECHA_ENTREGA,'1:00','S','N',null);
						
                Insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) values (ID_TAREA_NUEVO, ID_DOCU_NUEVO);
                
                -- recuperamos el docu final de la 39 y 38.
                select T38_COD_DOC, T38_TIPO, T38_TAMANO, T38_FECHA, T38_NOMBRE_DOC, T38_OID into DOCUMENTO_FINAL 
                from r75b.r7539t00
                LEFT JOIN r75b.r7538t00 on T39_COD_DOC2 = T38_COD_DOC 
                where t39_anyo = R_EXP_R75.ANYO_051 and t39_N_EXP= R_EXP_R75.NUM_EXP_051;
				
				IF (DOCUMENTO_FINAL.T38_COD_DOC is not null) THEN
				
					IF (ID_FICHERO_USADO = 'S') THEN
						SELECT AA79B88Q00.nextVal into ID_NUEVO_FICHERO_FINAL from dual;
						ID_FICHERO_USADO:= 'N';
					END IF;
					
					Insert into AA79B88T00 (ID_FICHERO_088,TITULO_FICHERO_088,EXTENSION_FICHERO_088,CONTENT_TYPE_FICHERO_088,TAMANO_FICHERO_088,
					IND_ENCRIPTADO_088,RUTA_PIF_FICHERO_088,OID_FICHERO_088,NOMBRE_FICHERO_088) 
					values (ID_NUEVO_FICHERO_FINAL, SUBSTR(DOCUMENTO_FINAL.T38_NOMBRE_DOC,1,INSTR(DOCUMENTO_FINAL.T38_NOMBRE_DOC,'.',-1)-1),
					DECODE(INSTR(DOCUMENTO_FINAL.T38_NOMBRE_DOC,'.',-1),'0','mmm',SUBSTR(DOCUMENTO_FINAL.T38_NOMBRE_DOC,INSTR(DOCUMENTO_FINAL.T38_NOMBRE_DOC,'.',-1) +1,length(DOCUMENTO_FINAL.T38_NOMBRE_DOC))),
					DOCUMENTO_FINAL.T38_TIPO, DOCUMENTO_FINAL.T38_TAMANO, 'N', null, DOCUMENTO_FINAL.T38_OID, DOCUMENTO_FINAL.T38_NOMBRE_DOC);
					
					 
					 Select count(1) into contador from AA79B88T00 WHERE ID_FICHERO_088 = ID_NUEVO_FICHERO_FINAL;
				     if (contador > 0) THEN
				        Insert into AA79B92T00 (ID_TAREA_092,ID_DOC_ORIG_092,ID_FICHERO_FINAL_092,IND_VISIBLE_092,FECHA_ALTA_092,ESTADO_FIRMA_092,
						ID_DOC_FIRMADO_ORIG_092,ID_DOC_FIRMADO_FINAL_092,ID_DOC_FIRMADO_092) 
						values (ID_TAREA_NUEVO,ID_DOCU_NUEVO,ID_NUEVO_FICHERO_FINAL,'S',R_EXP_R75.FECHA_ENTREGA,'0',null,null,null);
				          
				        ID_FICHERO_USADO:= 'S';
				      END IF;
				 END IF;
				 
    		ELSE
    			-- REVISION
    			--RECUPERAMOS LOS DATOS DE LA TAREA
    			QUERY_DOCUS:= 'Select DECODE(T39_COD_TIPO_REVISION,1,3,8,3,7,3,2,2,9,2,4,2,5,2,10,1,6,1,T39_COD_TIPO_REVISION) as ID_TIPO_REVISION_081, t30_anyo as ANYO_081, t30_N_EXP as NUM_EXP_081, ';
				QUERY_DOCUS:= QUERY_DOCUS || 'T26_FEC_INI_PREV as FECHA_INICIO_081, T40_FEC_FIN_PREV as FECHA_FIN_081, FORMAT_HORA_MINUTOS(T40_NUM_HORAS/60) as HORAS_PREVISTAS_081, ';
				QUERY_DOCUS:= QUERY_DOCUS || 'T12_COD_RECURSO as COD_RECURSO, T12_COD_TIPO_RECURSO as TIPO_RECURSO, T40_TIPO_TAREA, ';
				QUERY_DOCUS:= QUERY_DOCUS || 'T26_FEC_ASIGNACION as FECHA_ASIGNACION_081, T26_FEC_ACEPTACION as FECHA_ACEPTACION_081, ';
                QUERY_DOCUS:= QUERY_DOCUS || ' doccli.T38_COD_DOC, doccli.T38_TIPO, doccli.T38_TAMANO, doccli.T38_FECHA, doccli.T38_NOMBRE_DOC, doccli.T38_OID,  ';
                QUERY_DOCUS:= QUERY_DOCUS || 'docfin.T38_COD_DOC, docfin.T38_TIPO, docfin.T38_TAMANO, docfin.T38_FECHA, docfin.T38_NOMBRE_DOC, docfin.T38_OID ';
				QUERY_DOCUS:= QUERY_DOCUS || 'from r75b.r7530t00 ';
				QUERY_DOCUS:= QUERY_DOCUS || 'JOIN r75b.r7539t00 on t30_anyo = t39_anyo and t30_N_EXP=t39_N_EXP AND ';
 				QUERY_DOCUS:= QUERY_DOCUS || 't39_anyo||''@''||t39_N_EXP||''@''||t39_FASE  in (select  t39_anyo||''@''||t39_N_EXP||''@''||max(t39_FASE) from r75b.r7539t00 '; 
	 			QUERY_DOCUS:= QUERY_DOCUS || 'group by T39_anyo,t39_N_EXP) ';
                QUERY_DOCUS:= QUERY_DOCUS || 'JOIN r75b.r7540t00 on t30_anyo = t40_anyo and t30_N_EXP=t40_N_EXP ';
                QUERY_DOCUS:= QUERY_DOCUS || 'JOIN r75b.r7526t00 ON T40_ANYO = T26_ANYO AND T40_FASE = T26_FASE AND T40_N_EXP = T26_N_EXP AND T40_COD_ORIG = T26_COD_ORIG AND T40_COD_TRAB = T26_COD_TRAB ';
                QUERY_DOCUS:= QUERY_DOCUS || 'JOIN r75b.r7512t00 ON  T26_COD_RECURSO = T12_COD_RECURSO ';
                QUERY_DOCUS:= QUERY_DOCUS || 'LEFT JOIN r75b.r7538t00 doccli ON  T40_COD_DOC1 = doccli.T38_COD_DOC ';
                QUERY_DOCUS:= QUERY_DOCUS || 'LEFT JOIN r75b.r7538t00 docfin ON  nvl(T40_COD_DOC2,T39_COD_DOC2) = docfin.T38_COD_DOC ';
                QUERY_DOCUS:= QUERY_DOCUS || 'WHERE ';
                QUERY_DOCUS:= QUERY_DOCUS || 't30_fase = 5  and t30_anyo =' || R_EXP_R75.ANYO_051 ||' and t30_N_EXP= ' || R_EXP_R75.NUM_EXP_051 ||' ';
                QUERY_DOCUS:= QUERY_DOCUS || 'AND T40_TIPO_TAREA in (2) ORDER BY T40_TIPO_TAREA ASC ';	
    		
    			open C_TAREAS_TRAD for (QUERY_DOCUS);
				fetch C_TAREAS_TRAD into R_TAREASTRAD;
				WHILE C_TAREAS_TRAD%FOUND LOOP
					IF (R_TAREASTRAD.T40_TIPO_TAREA = 2) THEN
		    			-- TRADUCCION
		    			IF (R_TAREASTRAD.TIPO_RECURSO = 4) THEN 
		    				-- SE TRATA DE UN PROVEEDOR OBTENEMOS LOS DATOS DEL LOTE
			             	SELECT T18_COD_PROVEEDOR, T18_COD_LOTE, T18_DESC, T18_URGENCIA,T18_DIFICULTAD, T18_IMP_EUSK_CAST, T18_IMP_CAST_EUSK, T18_POR_RANGO_95_100, T18_POR_RANGO_85_94,
		            		T18_POR_IVA_LOTE,T18_FEC_INI, T18_FEC_FIN, T18_IMP_TOTAL, T18_IMP_CONSUMIDO, T18_IMP_PREVISTO, T18_IMP_RESTANTE, T18_IMP_DISPONIBLE, TIPO_X54, ID_X54 into LOTE FROM  r75b.R7516V00, CODR75X54J  
		                	WHERE T18_COD_LOTE = R_TAREASTRAD.COD_RECURSO AND ID_R75 = T18_COD_PROVEEDOR;
		                	-- COMPROBAMOS SI EXISTE EL LOTE Y SI NO EXISTE LO INSERTAMOS.
							BEGIN
								SELECT ID_LOTE_029 into ID_LOTE FROM AA79B29T00 WHERE COD_R75_029 = LOTE.T18_COD_LOTE;
							EXCEPTION
		        				WHEN NO_DATA_FOUND THEN
		   
					        	SELECT AA79B29Q00.nextVal into ID_LOTE from dual;
					        	-- INSERTAMOS LOTE
					        	INSERT INTO AA79B29T00 (ID_LOTE_029, TIPO_ENTIDAD_029, ID_EMPRESA_PROV_029, NOMBRE_LOTE_029, DESC_LOTE_EU_029, DESC_LOTE_ES_029, DNI_CONTACTO_029,
		        				FECHA_INICIO_029, FECHA_FIN_029, IMPORTE_ASIGNADO_029, IMPORTE_CONSUMIDO_029, ID_IDIOMA_DESTINO_029, IMPORTE_PALABRA_029, POR_PAGO_PAL_CONCOR_85_94_029,
		        				POR_PAGO_PAL_CONCOR_95_100_029, POR_REVISION_029, POR_RECARGO_FORMATO_029, IND_RECARGO_APREMIO_029, POR_RECARGO_APREMIO_029, ID_TIPO_PENALIZACION_029,
		        				POR_PENALIZACION_029, RESOLUCION_029, COD_R75_029) VALUES (ID_LOTE, LOTE.TIPO_X54, LOTE.ID_X54, LOTE.T18_DESC, LOTE.T18_DESC, LOTE.T18_DESC, NULL, 
		        				LOTE.T18_FEC_INI, LOTE.T18_FEC_FIN, LOTE.T18_IMP_TOTAL, LOTE.T18_IMP_CONSUMIDO, 2, LOTE.T18_IMP_CAST_EUSK, LOTE.T18_POR_RANGO_85_94, 
		        				LOTE.T18_POR_RANGO_95_100, 0, LOTE.T18_DIFICULTAD, 'S', LOTE.T18_URGENCIA, 1,0, NULL, LOTE.T18_COD_LOTE);
							END;	
		                	-- CREAMOS LA TAREA DE REVISION DEL PROVEEDOR y EL DOCU ASOCIADO
							SELECT AA79B81Q00.nextVal into ID_TAREA_NUEVO from dual;
							Insert into AA79B81T00 (ID_TAREA_081,ID_TIPO_TAREA_081,ID_TIPO_REVISION_081,ANYO_081,NUM_EXP_081,IND_FACTURABLE_081,FECHA_INICIO_081,
							FECHA_FIN_081,HORAS_PREVISTAS_081,RECURSO_ASIGNACION_081,DNI_RECURSO_081,TIPO_ENTIDAD_081,ID_ENTIDAD_081,ID_LOTE_081,ESTADO_ASIGNACION_081,
							ESTADO_EJECUCION_081,OBSERV_081,ORDEN_081,DNI_ASIGNADOR_081,FECHA_ASIGNACION_081,FECHA_ACEPTACION_081,ID_TAREA_REL_081,ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081) 
							values (ID_TAREA_NUEVO,'4', null, R_TAREASTRAD.ANYO_081, R_TAREASTRAD.NUM_EXP_081, 'S', R_TAREASTRAD.FECHA_INICIO_081,
							R_TAREASTRAD.FECHA_FIN_081, R_TAREASTRAD.HORAS_PREVISTAS_081, 'P', null, null, null, ID_LOTE, 3, 3, null, ORDEN_TAREA, '16265343', R_TAREASTRAD.FECHA_ASIGNACION_081, 
							R_TAREASTRAD.FECHA_ACEPTACION_081, null, null, 'N');
							ORDEN_TAREA:= ORDEN_TAREA + 1;
							
							Insert into AA79B82T00 (ID_TAREA_082,DNI_RECURSO_082,FECHA_EJECUCION_082,HORAS_TAREA_082,IND_REALIZADA_082,IND_OBSV_082,POR_USO_EUSKERA_082) 
							values (ID_TAREA_NUEVO,'16265343',R_TAREASTRAD.FECHA_FIN_081,R_TAREASTRAD.HORAS_PREVISTAS_081,'S','N',null);
							
							-- MIRAMOS SI HAY QUE CREAR UN DOCUMENTO DE TRABAJO
							IF (R_TAREASTRAD.T38_OID_CLI is not null) then
							SELECT COUNT(1) into contador from AA79B56T00 WHERE ANYO_056 = R_EXP_R75.ANYO_051 AND NUM_EXP_056 = R_EXP_R75.NUM_EXP_051 AND 
							OID_FICHERO_056 = R_TAREASTRAD.T38_OID_CLI;
							
							IF (CONTADOR = 0 ) THEN
								Select AA79B56Q00.nextval into ID_DOCU_TAREA from dual;
								Insert into AA79B56T00 (ID_DOC_056,ANYO_056,NUM_EXP_056,OID_FICHERO_056,RUTA_PIF_FICHERO_056,EXTENSION_DOC_056,TAMANO_DOC_056,IND_ENCRIPTADO_056,CONTENT_TYPE_056,
								ID_DOC_REL_056,CLASE_DOCUMENTO_056,TIPO_DOCUMENTO_056,TITULO_056,NUM_PAL_SOLIC_056,NUM_PAL_IZO_056,PERSONA_CONTACTO_056,EMAIL_CONTACTO_056,TELEFONO_CONTACTO_056,
								DIRECCION_CONTACTO_056,ENTIDAD_CONTACTO_056,IND_VISIBLE_056,FECHA_ALTA_056,DNI_ALTA_056,ID_DOC_VERSION_056,NOMBRE_FICHERO_056,IND_ORIGEN_056) 
								values (ID_DOCU_TAREA, R_EXP_R75.ANYO_051, R_EXP_R75.NUM_EXP_051, R_TAREASTRAD.T38_OID_CLI, null, 
								DECODE(INSTR(R_TAREASTRAD.T38_NOMBRE_DOC_CLI,'.',-1),'0','mmm',SUBSTR(R_TAREASTRAD.T38_NOMBRE_DOC_CLI,INSTR(R_TAREASTRAD.T38_NOMBRE_DOC_CLI,'.',-1) +1,length(R_TAREASTRAD.T38_NOMBRE_DOC_CLI))),
								R_TAREASTRAD.T38_TAMANO_CLI, 'N', R_TAREASTRAD.T38_TIPO_CLI, null, 4, null, 
								DECODE(INSTR(R_TAREASTRAD.T38_NOMBRE_DOC_CLI,'.',-1),0,R_TAREASTRAD.T38_NOMBRE_DOC_CLI,SUBSTR(R_TAREASTRAD.T38_NOMBRE_DOC_CLI,1,INSTR(R_TAREASTRAD.T38_NOMBRE_DOC_CLI,'.',-1)-1)),
								null, null, null, null, null, null, null, 'S', R_TAREASTRAD.T38_FECHA_CLI, '16265343', null, R_TAREASTRAD.T38_NOMBRE_DOC_CLI, 'I');
							ELSE	
								SELECT ID_DOC_056 into ID_DOCU_TAREA from AA79B56T00 WHERE ANYO_056 = R_EXP_R75.ANYO_051 AND NUM_EXP_056 = R_EXP_R75.NUM_EXP_051 AND 
								OID_FICHERO_056 = R_TAREASTRAD.T38_OID_CLI;
							END IF;
                            ELSE
                                ID_DOCU_TAREA:= ID_DOCU_NUEVO;
                            END IF;
							Insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) values (ID_TAREA_NUEVO, ID_DOCU_TAREA);
							
							IF (ID_FICHERO_USADO = 'S') THEN
								SELECT AA79B88Q00.nextVal into ID_NUEVO_FICHERO_FINAL from dual;
								ID_FICHERO_USADO:= 'N';
							END IF;
			    			
							Insert into AA79B88T00 (ID_FICHERO_088,TITULO_FICHERO_088,EXTENSION_FICHERO_088,CONTENT_TYPE_FICHERO_088,TAMANO_FICHERO_088,
							IND_ENCRIPTADO_088,RUTA_PIF_FICHERO_088,OID_FICHERO_088,NOMBRE_FICHERO_088) 
							values (ID_NUEVO_FICHERO_FINAL, SUBSTR(R_TAREASTRAD.T38_NOMBRE_DOC_FIN,1,INSTR(R_TAREASTRAD.T38_NOMBRE_DOC_FIN,'.',-1)-1),
							DECODE(INSTR(R_TAREASTRAD.T38_NOMBRE_DOC_FIN,'.',-1),'0','mmm',SUBSTR(R_TAREASTRAD.T38_NOMBRE_DOC_FIN,INSTR(R_TAREASTRAD.T38_NOMBRE_DOC_FIN,'.',-1) +1,length(R_TAREASTRAD.T38_NOMBRE_DOC_FIN))),
							R_TAREASTRAD.T38_TIPO_FIN, R_TAREASTRAD.T38_TAMANO_FIN, 'N', null, R_TAREASTRAD.T38_OID_FIN, R_TAREASTRAD.T38_NOMBRE_DOC_FIN);
							
						    Insert into AA79B87T00 (ID_TAREA_087,ID_DOC_ORIG_087,ID_FICHERO_TRADUCIDO_087,FECHA_ALTA_087) 
							values (ID_TAREA_NUEVO,ID_DOCU_TAREA,ID_NUEVO_FICHERO_FINAL, R_TAREASTRAD.FECHA_FIN_081 );
						    ID_FICHERO_USADO:= 'S';
						    
			    			ID_TAREA_ANTERIOR:= ID_TAREA_NUEVO;
				    		
							-- CREAMOS LA TAREA DE REVISION DE DATOS DE FACTURACION
				    
						   SELECT AA79B81Q00.nextVal into ID_TAREA_NUEVO from dual;
							Insert into AA79B81T00 (ID_TAREA_081,ID_TIPO_TAREA_081,ID_TIPO_REVISION_081,ANYO_081,NUM_EXP_081,IND_FACTURABLE_081,FECHA_INICIO_081,
							FECHA_FIN_081,HORAS_PREVISTAS_081,RECURSO_ASIGNACION_081,DNI_RECURSO_081,TIPO_ENTIDAD_081,ID_ENTIDAD_081,ID_LOTE_081,ESTADO_ASIGNACION_081,
							ESTADO_EJECUCION_081,OBSERV_081,ORDEN_081,DNI_ASIGNADOR_081,FECHA_ASIGNACION_081,FECHA_ACEPTACION_081,ID_TAREA_REL_081,ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081) 
							values (ID_TAREA_NUEVO,'11', null, R_TAREASTRAD.ANYO_081, R_TAREASTRAD.NUM_EXP_081, 'N', R_TAREASTRAD.FECHA_INICIO_081,
							R_TAREASTRAD.FECHA_FIN_081, R_TAREASTRAD.HORAS_PREVISTAS_081, 'I', '16265343', null, null, null, 3, 3, null, ORDEN_TAREA, '16265343', R_TAREASTRAD.FECHA_ASIGNACION_081, 
							R_TAREASTRAD.FECHA_ACEPTACION_081, ID_TAREA_ANTERIOR, null, 'N');
							ORDEN_TAREA:= ORDEN_TAREA + 1;
							
							Insert into AA79B82T00 (ID_TAREA_082,DNI_RECURSO_082,FECHA_EJECUCION_082,HORAS_TAREA_082,IND_REALIZADA_082,IND_OBSV_082,POR_USO_EUSKERA_082) 
							values (ID_TAREA_NUEVO,'16265343',R_TAREASTRAD.FECHA_FIN_081,null,'S','N',null);
							
							Insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) values (ID_TAREA_NUEVO, ID_DOCU_TAREA);
						     
			  				-- RECUPERAMOS LOS DATOS A PAGAR AL PROVEEDOR
							SELECT 
								a.T30_ANYO ANYO_094, 
							a.T30_N_EXP NUM_EXP_094,
							SUM(c.T39_TOT_PAL) NUM_TOTAL_PAL_094,
							SUM(c.T39_IZO_RANGO_0_84)  NUM_PAL_CONCOR_0_84_094, 
							SUM(c.T39_IZO_RANGO_85_94) NUM_PAL_CONCOR_85_94_094, 
							SUM(c.T39_IZO_RANGO_95_100) NUM_PAL_CONCOR_95_100_094, 
							DECODE(MAX(c.T39_NUM_PORCEN_FORMATO_TEXTO),0,'N','S') IND_RECARGO_FORMATO_094,
							MAX(c.T39_NUM_PORCEN_FORMATO_TEXTO) NUM_PAL_RECARGO_FORMATO_094,
							DECODE(MAX(c.T39_NUM_PORCEN_APREMIO_TEXTO),0,'N','S') IND_RECARGO_APREMIO_094,
							MAX(c.T39_NUM_PORCEN_APREMIO_TEXTO) POR_RECARGO_APREMIO_094,
		    				DECODE(MAX(c.T39_NUM_PORCEN_PENALIZADO),0,'N','S') IND_PENALIZACION_094,
							MAX(c.T39_NUM_PORCEN_PENALIZADO) POR_PENALIZACION_094,
							SUM(c.T39_POR_IVA_PROVEEDOR) IVA_APLIC_094,
						    MAX(c.T39_NUM_PRECIO_PROVEEDOR) IMPORTE_PAL_APLIC_094,
						    0 POR_REVISION_APLIC_094,
						    0 IMPORTE_TAREA_094,  
						    0 IMPORTE_RECARGO_FORMATO_094,  
						    0 IMPORTE_RECARGO_APREMIO_094,  
						    0 IMPORTE_PENALIZACION_094,  
						   	MAX(c.T39_IMP_A_FACTURAR_PROVEEDOR) IMPORTE_BASE_094,  
						    MAX((c.T39_IMP_PPTO_PROVEEDOR - c.T39_IMP_A_FACTURAR_PROVEEDOR)) IMPORTE_IVA_094,  
							 MAX (c.T39_IMP_PPTO_PROVEEDOR) IMPORTE_TOTAL_094,
							MIN(DECODE(a.T30_ALBARAN, NULL, 'N', 'S')) IND_PAGADO_094,
							MIN(DECODE(a.T30_ASOC_ALBARAN, 1, 'S', 'N')) IND_ALBARAN_094,
							MIN(a.T30_ALBARAN) T30_ALBARAN
							into DATOS_PAGO_PROVEEDOR
							FROM r75b.r7530t00 a 
							LEFT JOIN r75b.r7539t00 c 
							on a.T30_ANYO=c.T39_ANYO AND a.T30_N_EXP=c.T39_N_EXP AND a.T30_FASE=c.T39_FASE 
							LEFT JOIN r75b.r7532t00 d 
							on a.T30_ANYO=d.T32_ANYO AND a.T30_N_EXP=d.T32_N_EXP AND a.T30_FASE=d.T32_FASE 
							LEFT JOIN r75b.r7531t00 e 
							on a.T30_ANYO=e.T31_ANYO AND a.T30_N_EXP=e.T31_N_EXP AND a.T30_FASE=e.T31_FASE 
							WHERE a.T30_COD_TIPO_EXP <> 4  AND a.t30_anyo = R_EXP_R75.ANYO_051 AND a.t30_n_exp =R_EXP_R75.NUM_EXP_051 
							AND
							 a.t30_anyo||'@'||a.t30_N_EXP in (select x.t30_anyo||'@'||x.t30_N_EXP from r75b.r7530t00 x where x.T30_FASE=5)
							GROUP BY a.T30_ANYO, a.T30_N_EXP  ORDER BY a.T30_ANYO, a.T30_N_EXP;
							
							IF (DATOS_PAGO_PROVEEDOR.T30_ALBARAN is not null) THEN 
							-- COMPROBAMOS SI EXISTE EL ALBARAN Y SI NO EXISTE LO INSERTAMOS.
								BEGIN
									SELECT ID_099 into ID_ALBARAN FROM AA79B99T00 WHERE COD_R75_099 = DATOS_PAGO_PROVEEDOR.T30_ALBARAN;
								EXCEPTION
			        				WHEN NO_DATA_FOUND THEN
			   
						        	SELECT AA79B99Q00.nextVal into ID_ALBARAN from dual;
						        	-- INSERTAMOS ALBARAN
						        	INSERT INTO AA79B99T00 (ID_099, REF_ALBARAN_099, ID_LOTE_099, FECHA_ALTA_099, ESTADO_099, REF_FACTURA_099, IMPORTE_FACTURA_099, COD_R75_099) 
						        	SELECT ID_ALBARAN, T61_REF_ALBARAN, ID_LOTE, T61_FECHA, DECODE(T61_ESTADO, 'S',2,'E',3,'P',4,2),  T61_REF_FACTURA, T61_IMPORTE, DATOS_PAGO_PROVEEDOR.T30_ALBARAN 
						        	from r75b.R7561T00 where T61_COD_ALBARAN = DATOS_PAGO_PROVEEDOR.T30_ALBARAN;
								END;	
		    
		   					END IF;
							
		   					INSERT INTO AA79B94T00 (ID_TAREA_094, NUM_TOTAL_PAL_094, NUM_PAL_CONCOR_0_84_094, NUM_PAL_CONCOR_85_94_094, NUM_PAL_CONCOR_95_100_094,
							IND_RECARGO_FORMATO_094, NUM_PAL_RECARGO_FORMATO_094, IND_RECARGO_APREMIO_094, POR_RECARGO_APREMIO_094, IND_PENALIZACION_094, POR_PENALIZACION_094, 
							IVA_APLIC_094, IMPORTE_PAL_APLIC_094, POR_REVISION_APLIC_094, IMPORTE_TAREA_094, IMPORTE_RECARGO_FORMATO_094, IMPORTE_RECARGO_APREMIO_094, IMPORTE_PENALIZACION_094,  
		    				IMPORTE_BASE_094, IMPORTE_IVA_094, IMPORTE_TOTAL_094, IND_PAGADO_094, IND_ALBARAN_094, COD_ALBARAN_094)
		    				values(ID_TAREA_NUEVO, DATOS_PAGO_PROVEEDOR.NUM_TOTAL_PAL_094, DATOS_PAGO_PROVEEDOR.NUM_PAL_CONCOR_0_84_094, DATOS_PAGO_PROVEEDOR.NUM_PAL_CONCOR_85_94_094, 
		    				DATOS_PAGO_PROVEEDOR.NUM_PAL_CONCOR_95_100_094, DATOS_PAGO_PROVEEDOR.IND_RECARGO_FORMATO_094, DATOS_PAGO_PROVEEDOR.NUM_PAL_RECARGO_FORMATO_094, 
		    				DATOS_PAGO_PROVEEDOR.IND_RECARGO_APREMIO_094, DATOS_PAGO_PROVEEDOR.POR_RECARGO_APREMIO_094, DATOS_PAGO_PROVEEDOR.IND_PENALIZACION_094, DATOS_PAGO_PROVEEDOR.POR_PENALIZACION_094, 
							DATOS_PAGO_PROVEEDOR.IVA_APLIC_094, DATOS_PAGO_PROVEEDOR.IMPORTE_PAL_APLIC_094, DATOS_PAGO_PROVEEDOR.POR_REVISION_APLIC_094, DATOS_PAGO_PROVEEDOR.IMPORTE_TAREA_094, 
							DATOS_PAGO_PROVEEDOR.IMPORTE_RECARGO_FORMATO_094, DATOS_PAGO_PROVEEDOR.IMPORTE_RECARGO_APREMIO_094, DATOS_PAGO_PROVEEDOR.IMPORTE_PENALIZACION_094,  
		    				DATOS_PAGO_PROVEEDOR.IMPORTE_BASE_094, DATOS_PAGO_PROVEEDOR.IMPORTE_IVA_094, DATOS_PAGO_PROVEEDOR.IMPORTE_TOTAL_094, DATOS_PAGO_PROVEEDOR.IND_PAGADO_094, 
		    				DATOS_PAGO_PROVEEDOR.IND_ALBARAN_094, ID_ALBARAN);
		    			
		    				
		    				
						 END IF;
		    				
                        
                    END IF;
				fetch C_TAREAS_TRAD into R_TAREASTRAD;
	  			END LOOP;
			
	  			
	  			
	  			-- CREAMOS LA TAREA DE ENTREGA
                SELECT AA79B81Q00.nextVal into ID_TAREA_NUEVO from dual;
                Insert into AA79B81T00 (ID_TAREA_081,ID_TIPO_TAREA_081,ID_TIPO_REVISION_081,ANYO_081,NUM_EXP_081,IND_FACTURABLE_081,FECHA_INICIO_081,
                FECHA_FIN_081,HORAS_PREVISTAS_081,RECURSO_ASIGNACION_081,DNI_RECURSO_081,TIPO_ENTIDAD_081,ID_ENTIDAD_081,ID_LOTE_081,ESTADO_ASIGNACION_081,
                ESTADO_EJECUCION_081,OBSERV_081,ORDEN_081,DNI_ASIGNADOR_081,FECHA_ASIGNACION_081,FECHA_ACEPTACION_081,ID_TAREA_REL_081,ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081) 
                values (ID_TAREA_NUEVO,'20', 1, R_EXP_R75.ANYO_051, R_EXP_R75.NUM_EXP_051, 'S', R_EXP_R75.FECHA_ENTREGA,
                R_EXP_R75.FECHA_ENTREGA, '1:00', 'I', '16265343', null, null, null, 3, 3, null, ORDEN_TAREA, '16265343', R_EXP_R75.FECHA_ENTREGA, 
                R_EXP_R75.FECHA_ENTREGA, null, null, 'N');
                ORDEN_TAREA:= ORDEN_TAREA + 1;
		                 
                Insert into AA79B82T00 (ID_TAREA_082,DNI_RECURSO_082,FECHA_EJECUCION_082,HORAS_TAREA_082,IND_REALIZADA_082,IND_OBSV_082,POR_USO_EUSKERA_082) 
                values (ID_TAREA_NUEVO,'16265343',R_EXP_R75.FECHA_ENTREGA,'1:00','S','N',null);
						
                Insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) values (ID_TAREA_NUEVO, ID_DOCU_NUEVO);
                
                -- recuperamos el docu final de la 39 y 38.
                select T38_COD_DOC, T38_TIPO, T38_TAMANO, T38_FECHA, T38_NOMBRE_DOC, T38_OID into DOCUMENTO_FINAL 
                from r75b.r7539t00
                LEFT JOIN r75b.r7538t00 on T39_COD_DOC2 = T38_COD_DOC 
                where t39_anyo = R_EXP_R75.ANYO_051 and t39_N_EXP= R_EXP_R75.NUM_EXP_051;
				
				IF (DOCUMENTO_FINAL.T38_COD_DOC is not null) THEN
				
					IF (ID_FICHERO_USADO = 'S') THEN
						SELECT AA79B88Q00.nextVal into ID_NUEVO_FICHERO_FINAL from dual;
						ID_FICHERO_USADO:= 'N';
					END IF;
					
					Insert into AA79B88T00 (ID_FICHERO_088,TITULO_FICHERO_088,EXTENSION_FICHERO_088,CONTENT_TYPE_FICHERO_088,TAMANO_FICHERO_088,
					IND_ENCRIPTADO_088,RUTA_PIF_FICHERO_088,OID_FICHERO_088,NOMBRE_FICHERO_088) 
					values (ID_NUEVO_FICHERO_FINAL, SUBSTR(DOCUMENTO_FINAL.T38_NOMBRE_DOC,1,INSTR(DOCUMENTO_FINAL.T38_NOMBRE_DOC,'.',-1)-1),
					DECODE(INSTR(DOCUMENTO_FINAL.T38_NOMBRE_DOC,'.',-1),'0','mmm',SUBSTR(DOCUMENTO_FINAL.T38_NOMBRE_DOC,INSTR(DOCUMENTO_FINAL.T38_NOMBRE_DOC,'.',-1) +1,length(DOCUMENTO_FINAL.T38_NOMBRE_DOC))),
					DOCUMENTO_FINAL.T38_TIPO, DOCUMENTO_FINAL.T38_TAMANO, 'N', null, DOCUMENTO_FINAL.T38_OID, DOCUMENTO_FINAL.T38_NOMBRE_DOC);
					
					 
					 Select count(1) into contador from AA79B88T00 WHERE ID_FICHERO_088 = ID_NUEVO_FICHERO_FINAL;
				     if (contador > 0) THEN
				        Insert into AA79B92T00 (ID_TAREA_092,ID_DOC_ORIG_092,ID_FICHERO_FINAL_092,IND_VISIBLE_092,FECHA_ALTA_092,ESTADO_FIRMA_092,
						ID_DOC_FIRMADO_ORIG_092,ID_DOC_FIRMADO_FINAL_092,ID_DOC_FIRMADO_092) 
						values (ID_TAREA_NUEVO,ID_DOCU_NUEVO,ID_NUEVO_FICHERO_FINAL,'S',R_EXP_R75.FECHA_ENTREGA,'0',null,null,null);
				          
				        ID_FICHERO_USADO:= 'S';
				      END IF;
				 END IF;
	  			
	  			
    		END IF;
    	END IF;
    	
    	-- ENTIDADES A LAS QUE SE FACTURA y DATOS DE FACTURACION
		-- OBTENEMOS EL ID ORDEN A APLICAR Y LOS DATOS A INSERTAR EN LA 97
		SELECT ID_030 into ID_ORDEN
     FROM (SELECT ID_030,
               FECHA_VIGOR_030,
               rank() over (order by FECHA_VIGOR_030 desc) rnk
          from AA79B30T00 WHERE  TO_DATE(TO_CHAR(sysdate, 'YYYYMMDD'),'YYYYMMDD')>=  TO_DATE(TO_CHAR(FECHA_VIGOR_030, 'YYYYMMDD'),'YYYYMMDD') 
      AND TO_DATE(TO_CHAR(sysdate, 'YYYYMMDD'),'YYYYMMDD')<=  TO_DATE(TO_CHAR(nvl(FECHA_FIN_VIGOR_030,TO_DATE('20990101','YYYYMMDD')), 'YYYYMMDD'),'YYYYMMDD'))
      WHERE rnk = 1;
		
		-- Recuperamos el contacto de facturación
			IF (R_EXP_R75.NUM_FACTURA is not null) then
		        select t30_anyo as anyo_058,t30_n_exp as NUM_EXP_058, 
		        decode(t21_dni, null,null,trim(translate(t21_dni,translate(t21_dni, '1234567890', ' '),' '))) as DNI_CONTACTO_058,
		        trim(translate(substr(t21_dni,0,1), '1234567890', ' ')) as PRE_DNI_CONTACTO_058, 
		        decode(t21_dni, null, null,trim(translate(substr(t21_dni,length(t21_dni),1), '1234567890', ' ')))  as SUF_DNI_CONTACTO_058, 
		        nvl(TIPO_X54,'B') as TIPO_ENTIDAD_ASOC_058,
		        nvl(ID_X54,570) as ID_ENTIDAD_ASOC_058,
		        T21_NOMBRE, T21_APEL1, T21_APEL2 into CONTACTO from r75b.r7530t00,r75b.r7524t00, r75b.r7521t00,r75b.r7519t00, CODR75X54J  
		        where  
		        T30_NUM_FAC = T24_NUM_FACTURA AND  T30_ANYO_FAC = T24_ANYO
		        AND T24_COD_SOLICITANTE =t21_cod_solicitante (+)
		        and T24_COD_SOLICITANTE =t19_cod_solicitante  
		        and T24_COD_CONT_SOLI=T21_COD_CONT_SOLI (+) and t30_fase=5 and t30_anyo = R_EXP_R75.ANYO_051 AND t30_n_exp =R_EXP_R75.NUM_EXP_051
		        and T24_COD_SOLICITANTE = ID_R75 (+);
		    ELSE
		    	select t30_anyo as anyo_058,t30_n_exp as NUM_EXP_058, 
		        decode(t21_dni, null,null,trim(translate(t21_dni,translate(t21_dni, '1234567890', ' '),' '))) as DNI_CONTACTO_058,
		        trim(translate(substr(t21_dni,0,1), '1234567890', ' ')) as PRE_DNI_CONTACTO_058, 
		        decode(t21_dni, null, null,trim(translate(substr(t21_dni,length(t21_dni),1), '1234567890', ' ')))  as SUF_DNI_CONTACTO_058, 
		        nvl(TIPO_X54,'B') as TIPO_ENTIDAD_ASOC_058,
		        nvl(ID_X54,570) as ID_ENTIDAD_ASOC_058,
		        T21_NOMBRE, T21_APEL1, T21_APEL2 into CONTACTO from r75b.r7530t00,r75b.r7521t00,r75b.r7519t00, CODR75X54J  
		    	where  t30_cod_solicitante=t21_cod_solicitante and  t21_cod_solicitante=t19_cod_solicitante  
				and T30_COD_CONT_SOLI=T21_COD_CONT_SOLI and t30_fase=5 and t30_anyo = R_EXP_R75.ANYO_051 AND t30_n_exp =R_EXP_R75.NUM_EXP_051 
				and t30_cod_solicitante = ID_R75 (+);
		    END IF;
	
			--INSERTAMOS EL CONTACTO
		    IF (CONTACTO.DNI_CONTACTO_058 is not null) then   
		      Select count(1) into contador from AA79B77T00 WHERE DNI_077 = CONTACTO.DNI_CONTACTO_058;
		      IF (CONTADOR = 0) THEN
		        Insert into AA79B77T00 (DNI_077,TIPIDEN_077,PREDNI_077,SUFDNI_077,NOMBRE_077,APEL1_077,APEL2_077) 
		        values (CONTACTO.DNI_CONTACTO_058,'1',CONTACTO.PRE_DNI_CONTACTO_058,CONTACTO.SUF_DNI_CONTACTO_058,CONTACTO.NOMBRE_077,CONTACTO.APEL1_077,CONTACTO.APEL2_077);
		      END IF;
		    END IF;
		    
		    Select AA79B58Q00.nextval into ID_CONT_FACT from dual;
			INSERT INTO AA79B58T00 (ID_058, ANYO_058, NUM_EXP_058, TIPO_ENTIDAD_ASOC_058, ID_ENTIDAD_ASOC_058, DNI_CONTACTO_058, POR_FACTURA_058)
			values (ID_CONT_FACT, R_EXP_R75.ANYO_051, R_EXP_R75.NUM_EXP_051, CONTACTO.TIPO_ENTIDAD_ASOC_058, CONTACTO.ID_ENTIDAD_ASOC_058, CONTACTO.DNI_CONTACTO_058, 100);
    	
    	-- INSERTAMOS LOS DATOS DE FACTURACION
    	IF (R_EXP_R75.ID_TIPO_EXPEDIENTE_051 = 'I') THEN
			-- RECUPERAMOS LOS DATOS DE FACTURACION
			
    		IF (R_EXP_R75.IND_FACTURABLE = 1 ) THEN	
    			
    			SELECT 
					T30_ANYO ANYO_0A3, 
					T30_N_EXP NUM_EXP_0A3,
					SUM(T30_POR_IVA) AS POR_IVA_0A3,
					SUM(T31_NUM_INTER) AS NUM_INTERPRETES_0A3,
					SUM(T31_HORAS_DEDI) AS HORAS_INTERPRETACION_0A3,
					MIN(T30_IMP_A_FACTURAR) AS IMPORTE_BASE_0A3, 
					MIN(T30_IMP_A_FACTURAR*T30_POR_IVA/100) AS IMPORTE_IVA_0A3,
					MIN(T30_IMP_A_FACTURAR +  T30_IMP_A_FACTURAR*T30_POR_IVA/100)   AS IMPORTE_TOTAL_0A3
					into DATOS_FACT_INTER
					from r75b.r7530t00,r75b.r7531t00 where t30_anyo = R_EXP_R75.ANYO_051 and t30_N_EXP= R_EXP_R75.NUM_EXP_051
					and t30_anyo = t31_anyo and t30_N_EXP=t31_N_EXP AND T30_FASE=T31_FASE AND t30_fase= 5  
        			GROUP BY T30_ANYO, T30_N_EXP  ORDER BY T30_ANYO, T30_N_EXP;
        			
        			HORAS_INTERPRETACION_ACUM:= '';
        			-- calculamos las horas dedicadas por cada interprete
        			FOR Lcntr IN 1..DATOS_FACT_INTER.NUM_INTERPRETES_0A3
					LOOP
						IF (HORAS_INTERPRETACION_ACUM <> '') THEN
							HORAS_INTERPRETACION_ACUM := HORAS_INTERPRETACION_ACUM || ', ';
						END IF;
						HORAS_INTERPRETACION_ACUM := HORAS_INTERPRETACION_ACUM || FORMAT_HORA_MINUTOS(DATOS_FACT_INTER.HORAS_INTERPRETACION_0A3/DATOS_FACT_INTER.NUM_INTERPRETES_0A3);
					END LOOP;
        			
        			-- INSERTAMOS LOS DATOS DE FACTURACION DEL EXPEDIENTE en la A3
				insert into AA79BA3T00 (ANYO_0A3, NUM_EXP_0A3, ID_ORDEN_0A3, POR_IVA_0A3, PRECIO_MINIMO_0A3, NUM_INTERPRETES_0A3, HORAS_INTERPRETACION_0A3, IMPORTE_BASE_0A3, IMPORTE_IVA_0A3, IMPORTE_TOTAL_0A3, IND_REVISADO_0A3) 
				VALUES (DATOS_FACT_INTER.ANYO_0A3, 
					DATOS_FACT_INTER.NUM_EXP_0A3,
					ID_ORDEN,
					DATOS_FACT_INTER.POR_IVA_0A3,
					null,
					DATOS_FACT_INTER.NUM_INTERPRETES_0A3, 
					HORAS_INTERPRETACION_ACUM, 
					DATOS_FACT_INTER.IMPORTE_BASE_0A3, 
					DATOS_FACT_INTER.IMPORTE_IVA_0A3,
					DATOS_FACT_INTER.IMPORTE_TOTAL_0A3, 'S');
					
					
				-- recuperamos la dirección de facturación
				/*select AA79B49Q00.nextVal into ID_DIR_NORA from dual;
				INSERT INTO AA79B49S01 (CDIRNORA_049, TIPONORA_049, CODPROV_049, CODMUNI_049, APROX_049, CODPOST_049)
				SELECT ID_DIR_NORA, '0', LPAD(T19_MUN_PROV,2,'0'), LPAD(T19_MUN_MUNI,3,'0'), T19_DOMICILIO, T19_COD_POSTAL
				from r75b.r7530t00,r75b.r7521t00,r75b.r7519t00
				where  t30_cod_solicitante=t21_cod_solicitante and  t21_cod_solicitante=t19_cod_solicitante  
				and T30_COD_CONT_SOLI=T21_COD_CONT_SOLI and t30_fase=5 and t30_anyo = R_EXP_R75.ANYO_051 AND t30_n_exp =R_EXP_R75.NUM_EXP_051; */
			
			
				ID_DIR_NORA:= null;
        
				-- INSERTAMOS EN LA A6 los datos de facturacion para una entidad concreta.
				INSERT into AA79BA6T00 (ID_0A6, DIR_NORA_0A6, IND_FACTURABLE_0A6, IND_IVA_0A6, IMPORTE_BASE_0A6, IMPORTE_IVA_0A6, IMPORTE_TOTAL_0A6) 
				values (ID_CONT_FACT, ID_DIR_NORA, 'S', DECODE(DATOS_FACT_INTER.POR_IVA_0A3,0,'N','S'),
	    		DATOS_FACT_INTER.IMPORTE_BASE_0A3, DATOS_FACT_INTER.IMPORTE_IVA_0A3, DATOS_FACT_INTER.IMPORTE_TOTAL_0A3);
    		
    		
    		END IF;
			
		ELSE
			-- RECUPERAMOS LOS DATOS DE FACTURACION
			IF (R_EXP_R75.IND_FACTURABLE = 1 ) THEN	
		
				SELECT 
					a.T30_ANYO ANYO_097, 
					a.T30_N_EXP NUM_EXP_097,
					SUM(c.T39_TOT_PAL) NUM_TOTAL_PAL_FACTURAR_097,
					SUM(c.T39_IZO_RANGO_0_84)  NUM_PAL_CONCOR_0_84_097, 
					SUM(c.T39_IZO_RANGO_85_94) NUM_PAL_CONCOR_85_94_097, 
					SUM(c.T39_IZO_RANGO_95_100) NUM_PAL_CONCOR_95_100_097, 
					MAX(T39_NUM_PRECIO) AS TARIFA_PAL_097,
					SUM(T30_POR_IVA) AS POR_IVA_097,
					DECODE(MIN(T32_URGENCIA),0,0,ROUND((SUM(c.T39_IZO_RANGO_0_84)* MAX(T39_NUM_PRECIO) +
					SUM(c.T39_IZO_RANGO_95_100)* MAX(T39_NUM_PRECIO) *50/100+
					SUM(c.T39_IZO_RANGO_85_94)* MAX(T39_NUM_PRECIO)*80/100) *40/100,3))
					AS IMPORTE_URGENCIA_097, 
					DECODE(MIN(T32_DIFICULTAD),0,0, ROUND( (SUM(c.T39_IZO_RANGO_0_84)* MAX(T39_NUM_PRECIO) +
					SUM(c.T39_IZO_RANGO_95_100)* MAX(T39_NUM_PRECIO) *50/100+
					SUM(c.T39_IZO_RANGO_85_94)* MAX(T39_NUM_PRECIO)*80/100) * 25/100,3))
					 AS IMPORTE_DIFICULTAD_097, 
					MIN(a.T30_IMP_A_FACTURAR) AS IMPORTE_BASE_097, 
					MIN(a.T30_IMP_A_FACTURAR*T30_POR_IVA/100) AS IMPORTE_IVA_097,
					MIN(a.T30_IMP_A_FACTURAR +  a.T30_IMP_A_FACTURAR*T30_POR_IVA/100)   AS IMPORTE_TOTAL_097 
					into DATOS_FACTURACION
					FROM r75b.r7530t00 a 
					LEFT JOIN r75b.r7539t00 c 
					on a.T30_ANYO=c.T39_ANYO AND a.T30_N_EXP=c.T39_N_EXP AND a.T30_FASE=c.T39_FASE 
					LEFT JOIN r75b.r7532t00 d 
					on a.T30_ANYO=d.T32_ANYO AND a.T30_N_EXP=d.T32_N_EXP AND a.T30_FASE=d.T32_FASE 
					LEFT JOIN r75b.r7531t00 e 
					on a.T30_ANYO=e.T31_ANYO AND a.T30_N_EXP=e.T31_N_EXP AND a.T30_FASE=e.T31_FASE 
					WHERE a.T30_COD_TIPO_EXP <> 4  AND a.t30_anyo = R_EXP_R75.ANYO_051 AND a.t30_n_exp =R_EXP_R75.NUM_EXP_051 
					AND
					 a.t30_anyo||'@'||a.t30_N_EXP in (select x.t30_anyo||'@'||x.t30_N_EXP from r75b.r7530t00 x where x.T30_FASE=5)
					GROUP BY a.T30_ANYO, a.T30_N_EXP  ORDER BY a.T30_ANYO, a.T30_N_EXP;
					
					-- INSERTAMOS LOS DATOS DE FACTURACION DEL EXPEDIENTE en la 97
					insert into AA79B97T00 (ANYO_097, NUM_EXP_097, NUM_TOTAL_PAL_FACTURAR_097, NUM_PAL_CONCOR_0_84_097, NUM_PAL_CONCOR_85_94_097, NUM_PAL_CONCOR_95_100_097,
			    	ID_ORDEN_097, TARIFA_PAL_097, POR_IVA_097, IMPORTE_DIFICULTAD_097, IMPORTE_URGENCIA_097, IMPORTE_BASE_097, IMPORTE_IVA_097, IMPORTE_TOTAL_097,
					IND_REVISADO_097) VALUES (DATOS_FACTURACION.ANYO_097, 
						DATOS_FACTURACION.NUM_EXP_097,
						DATOS_FACTURACION.NUM_TOTAL_PAL_FACTURAR_097,
						DATOS_FACTURACION.NUM_PAL_CONCOR_0_84_097, 
						DATOS_FACTURACION.NUM_PAL_CONCOR_85_94_097, 
						DATOS_FACTURACION.NUM_PAL_CONCOR_95_100_097, 
						ID_ORDEN,
						DATOS_FACTURACION.TARIFA_PAL_097,
						DATOS_FACTURACION.POR_IVA_097,
						DATOS_FACTURACION.IMPORTE_URGENCIA_097, 
						DATOS_FACTURACION.IMPORTE_DIFICULTAD_097, 
						DATOS_FACTURACION.IMPORTE_BASE_097, 
						DATOS_FACTURACION.IMPORTE_IVA_097,
						DATOS_FACTURACION.IMPORTE_TOTAL_097, 'S');
			
					
			-- recuperamos la dirección de facturación
			/*select AA79B49Q00.nextVal into ID_DIR_NORA from dual;
			INSERT INTO AA79B49S01 (CDIRNORA_049, TIPONORA_049, CODPROV_049, CODMUNI_049, APROX_049, CODPOST_049)
			SELECT ID_DIR_NORA, '0', LPAD(T19_MUN_PROV,2,'0'), LPAD(T19_MUN_MUNI,3,'0'), T19_DOMICILIO, T19_COD_POSTAL
			from r75b.r7530t00,r75b.r7521t00,r75b.r7519t00
			where  t30_cod_solicitante=t21_cod_solicitante and  t21_cod_solicitante=t19_cod_solicitante  
			and T30_COD_CONT_SOLI=T21_COD_CONT_SOLI and t30_fase=5 and t30_anyo = R_EXP_R75.ANYO_051 AND t30_n_exp =R_EXP_R75.NUM_EXP_051; */
			
			
				ID_DIR_NORA:= null;
        
				-- INSERTAMOS EN LA 98 los datos de facturacion para una entidad concreta.
				INSERT into AA79B98T00 (ID_098, DIR_NORA_098, IND_FACTURABLE_098, IND_IVA_098, NUM_TOTAL_PAL_FACTURAR_098, NUM_PAL_CONCOR_0_84_098,
	    		NUM_PAL_CONCOR_85_94_098, NUM_PAL_CONCOR_95_100_098, IMPORTE_DIFICULTAD_098, IMPORTE_URGENCIA_098, IMPORTE_BASE_098,   
	    		IMPORTE_IVA_098, IMPORTE_TOTAL_098) values (ID_CONT_FACT, ID_DIR_NORA, 'S', DECODE(DATOS_FACTURACION.POR_IVA_097,0,'N','S'), DATOS_FACTURACION.NUM_TOTAL_PAL_FACTURAR_097, DATOS_FACTURACION.NUM_PAL_CONCOR_0_84_097,
	    		DATOS_FACTURACION.NUM_PAL_CONCOR_85_94_097, DATOS_FACTURACION.NUM_PAL_CONCOR_95_100_097, DATOS_FACTURACION.IMPORTE_DIFICULTAD_097, DATOS_FACTURACION.IMPORTE_URGENCIA_097,
	    		DATOS_FACTURACION.IMPORTE_BASE_097, DATOS_FACTURACION.IMPORTE_IVA_097, DATOS_FACTURACION.IMPORTE_TOTAL_097);
				
    		END IF;
				
		
		END IF;
		
		-- RECUPERAMOS LA FACTURA
		IF (R_EXP_R75.NUM_FACTURA is not null) then
			SELECT SUBSTR(T24_REFEREN,0,11), T24_FEC_EMISION into REFERENCIA_PAGO, FECHA_EMISION from r75b.r7524t00 where T24_ANYO = R_EXP_R75.ANYO_FACTURA AND T24_NUM_FACTURA = R_EXP_R75.NUM_FACTURA;
		
  
    	BEGIN          
      		select ID_FACTURA_0A4 into ID_FACTURA from AA79BA4T00 WHERE ID_LIQUIDACION_0A4 = REFERENCIA_PAGO;
			UPDATE AA79BA4T00 set TIPO_ENTIDAD_ASOC_0A4 = CONTACTO.TIPO_ENTIDAD_ASOC_058 , ID_ENTIDAD_ASOC_0A4=CONTACTO.ID_ENTIDAD_ASOC_058, DNI_CONTACTO_0A4=CONTACTO.DNI_CONTACTO_058 WHERE ID_FACTURA_0A4 = ID_FACTURA;
      		EXCEPTION
        	WHEN NO_DATA_FOUND THEN
   
		        SELECT substr(R_EXP_R75.ANYO_FACTURA, 3,2)||LPAD ('3',2,'0') ||LPAD(R_EXP_R75.NUM_FACTURA,6,'0') into ID_FACTURA from dual;
		        SELECT count(1) into contador from AA79BA4T00 WHERE ID_FACTURA_0A4 = ID_FACTURA;
		        IF (contador = 0 ) THEN
		        
			        INSERT INTO AA79BA4T00 (ID_FACTURA_0A4, TIPO_ENTIDAD_ASOC_0A4, ID_ENTIDAD_ASOC_0A4, DNI_CONTACTO_0A4, ID_LIQUIDACION_0A4, FECHA_EMISION_0A4, TIPO_EXP_FACTURA_0A4)
			        values (ID_FACTURA, CONTACTO.TIPO_ENTIDAD_ASOC_058, CONTACTO.ID_ENTIDAD_ASOC_058, CONTACTO.DNI_CONTACTO_058, REFERENCIA_PAGO, FECHA_EMISION, R_EXP_R75.ID_TIPO_EXPEDIENTE_051);
				END IF;
				
				
		
		END;
		Insert into AA79BA5T00 (ID_FACTURA_0A5, ANYO_0A5, NUM_EXP_0A5)
		values (ID_FACTURA, R_EXP_R75.ANYO_051, R_EXP_R75.NUM_EXP_051);	
    	
			
			
		END IF;
		    	
    	-- BITACORA CERRAR Y FINALIZAR
		Insert into AA79B59T00 (ANYO_059,NUM_EXP_059,ID_ESTADO_BITACORA_059,ID_ESTADO_EXP_059,ID_FASE_EXPEDIENTE_059,DATO_ADIC_059,INFO_ADIC_059,ID_RECHAZO_059,ID_REQUERIMIENTO_059,ID_ANULACION_059,FECHA_ALTA_059) 
		values (R_EXP_R75.ANYO_051,R_EXP_R75.NUM_EXP_051,ID_BITACORA,'6','13',null,null,null,null,null,R_EXP_R75.FECHA_ALTA_051);
		ID_BITACORA:= ID_BITACORA + 1;
		Insert into AA79B59T00 (ANYO_059,NUM_EXP_059,ID_ESTADO_BITACORA_059,ID_ESTADO_EXP_059,ID_FASE_EXPEDIENTE_059,DATO_ADIC_059,INFO_ADIC_059,ID_RECHAZO_059,ID_REQUERIMIENTO_059,ID_ANULACION_059,FECHA_ALTA_059) 
		values (R_EXP_R75.ANYO_051,R_EXP_R75.NUM_EXP_051,ID_BITACORA,'7','14',null,null,null,null,null,R_EXP_R75.FECHA_ALTA_051);
		update AA79B51T00 set ESTADO_BITACORA_051 = ID_BITACORA WHERE NUM_EXP_051 = R_EXP_R75.NUM_EXP_051 AND ANYO_051= R_EXP_R75.ANYO_051 ; 
		-- Bitacora solicitante
		IF (R_EXP_R75.ID_TIPO_EXPEDIENTE_051 <> 'I') THEN
			Insert into AA79B79T00 (ID_079,ANYO_079,NUM_EXP_079,ID_ACCION_BITACORA_079,FECHA_ALTA_079,USUARIO_079) 
      		values (AA79B79Q00.nextVal,R_EXP_R75.ANYO_051,R_EXP_R75.NUM_EXP_051,18,R_EXP_R75.FECHA_ALTA_051,'IZO');
		END IF;
		Insert into AA79B79T00 (ID_079,ANYO_079,NUM_EXP_079,ID_ACCION_BITACORA_079,FECHA_ALTA_079,USUARIO_079) 
		values (AA79B79Q00.nextVal,R_EXP_R75.ANYO_051,R_EXP_R75.NUM_EXP_051,19,R_EXP_R75.FECHA_ALTA_051,'IZO');
		Insert into AA79B79T00 (ID_079,ANYO_079,NUM_EXP_079,ID_ACCION_BITACORA_079,FECHA_ALTA_079,USUARIO_079) 
		values (AA79B79Q00.nextVal,R_EXP_R75.ANYO_051,R_EXP_R75.NUM_EXP_051,20,R_EXP_R75.FECHA_ALTA_051,'IZO');
		
		DELETE ERRORES_MIG WHERE ANYO_EXP = ANYO_ACTUAL AND NUM_EXP = NUM_EXP_ACTUAL;
		
		COMMIT;
		EXCEPTION  -- exception handlers begin
      	WHEN OTHERS THEN  -- handles all other errors
      	ROLLBACK;
      	error_code := SQLCODE;
      	err_msg := SUBSTR(SQLERRM, 1, 4000);

      	select count(1) into contador from ERRORES_MIG WHERE ANYO_EXP = ANYO_ACTUAL AND NUM_EXP = NUM_EXP_ACTUAL;
      	if (contador > 0) THEN
      		update ERRORES_MIG set ERROR_DET = DBMS_UTILITY.format_error_backtrace || '->' || err_msg, FECHA = sysdate WHERE ANYO_EXP = ANYO_ACTUAL AND NUM_EXP = NUM_EXP_ACTUAL;
      	ELSE
      		insert into ERRORES_MIG (ANYO_EXP, NUM_EXP, ERROR_DET, FECHA) values (ANYO_ACTUAL, NUM_EXP_ACTUAL, DBMS_UTILITY.format_error_backtrace || '->' || err_msg, sysdate);
      	END IF;
      	COMMIT;
      	
       
      END;
		
    END LOOP;
    
   EXCEPTION  -- exception handlers begin
      WHEN OTHERS THEN  -- handles all other errors
       ROLLBACK;
           
END;
/

ALTER TABLE AA79B51T00 ADD CONSTRAINT AA79B59T00_51_FK FOREIGN KEY (ANYO_051, NUM_EXP_051, ESTADO_BITACORA_051) REFERENCES AA79B59T00 (ANYO_059, NUM_EXP_059, ID_ESTADO_BITACORA_059);
ALTER TABLE AA79B59T00 ADD CONSTRAINT AA79B64T00_59_FK FOREIGN KEY (ID_REQUERIMIENTO_059) REFERENCES AA79B64T00 (ID_064);
ALTER TABLE AA79B92T00 ADD CONSTRAINT AA79B88T00_92_FK FOREIGN KEY (ID_FICHERO_FINAL_092) REFERENCES AA79B88T00 (ID_FICHERO_088);
ALTER TABLE AA79B90T00 ADD CONSTRAINT AA79B88T00_90_FK FOREIGN KEY (ID_FICHERO_TRADOS_090) REFERENCES AA79B88T00 (ID_FICHERO_088);
ALTER TABLE AA79B87T00 ADD CONSTRAINT AA79B88T00_87_FK FOREIGN KEY (ID_FICHERO_TRADUCIDO_087) REFERENCES AA79B88T00 (ID_FICHERO_088);
ALTER TABLE AA79B96T00 ADD CONSTRAINT AA79B88T00_96_FK FOREIGN KEY (ID_FICHERO_XLIFF_096) REFERENCES AA79B88T00 (ID_FICHERO_088);
ALTER TABLE AA79B93T00 ADD CONSTRAINT AA79B88T00_93_FK FOREIGN KEY (ID_FICHERO_JUSTIFICANTE_093) REFERENCES AA79B88T00 (ID_FICHERO_088);
ALTER TABLE AA79B59T00 ADD CONSTRAINT AA79B67T00_59_FK FOREIGN KEY (ID_RECHAZO_059) REFERENCES AA79B67T00 (ID_067);
/