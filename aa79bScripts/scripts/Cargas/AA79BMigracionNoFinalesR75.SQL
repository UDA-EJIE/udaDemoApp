ALTER TABLE AA79B51T00 DROP CONSTRAINT AA79B59T00_51_FK;
ALTER TABLE AA79B59T00 DROP CONSTRAINT AA79B64T00_59_FK;
ALTER TABLE AA79B92T00 DROP CONSTRAINT AA79B88T00_92_FK;
ALTER TABLE AA79B90T00 DROP CONSTRAINT AA79B88T00_90_FK;
ALTER TABLE AA79B87T00 DROP CONSTRAINT AA79B88T00_87_FK;
ALTER TABLE AA79B96T00 DROP CONSTRAINT AA79B88T00_96_FK;
ALTER TABLE AA79B93T00 DROP CONSTRAINT AA79B88T00_93_FK;
ALTER TABLE AA79B59T00 DROP CONSTRAINT AA79B67T00_59_FK;
/

DECLARE

ANYO_AUX NUMBER(4):= '&1';
NUM_AUX NUMBER(6):= '&2';

error_code NUMBER;
err_msg VARCHAR2(4000);

CURSOR C_EXP_R75 is(
SELECT t30_anyo                                                                                      AS ANYO_051,
  t30_N_EXP                                                                                          AS NUM_EXP_051,
  DECODE(T30_COD_TIPO_EXP,'2','R','3','T','4','I') AS ID_TIPO_EXPEDIENTE_051,
  DECODE(t30_VIA_WEB,'1','S','0','O','3','W')                AS ORIGEN_051,
  T30_FEC_SOLI                                                                                       AS FECHA_ALTA_051,
  replace(replace(SUBSTR(T30_DESC,1,149),chr(10),''),chr(13),'')                                     AS TITULO_051,
  T30_DESC AS DESC_R75_051,
  T30_PPTO AS IND_PRESUPUESTO,
  T30_FACTURABLE AS IND_FACTURABLE,
  T30_OBSERV_IZO AS OBSERVACIONES,
  T30_FEC_FIN AS FECHA_ENTREGA,
  T30_COD_APLIC_ORIG as APLIC_ORIGEN, 
  T30_NUM_FAC as NUM_FACTURA,
  T30_ANYO_FAC as ANYO_FACTURA,
  t30_FASE
FROM r75b.r7530t00
JOIN r75b.r7521t00 ON
t30_cod_solicitante=t21_cod_solicitante and T30_COD_CONT_SOLI=T21_COD_CONT_SOLI
JOIN r75b.r7519t00 ON 
t21_cod_solicitante=t19_cod_solicitante
LEFT JOIN r75b.r7532t00 ON 
t30_anyo = t32_anyo and t30_N_EXP=t32_N_EXP AND T30_FASE=T32_FASE
LEFT JOIN (select t39_anyo, t39_N_EXP, T39_TOT_PAL, T39_COD_TIPO_DOCUMENTO, t39_FASE  from r75b.r7539t00 where t39_anyo||'@'||t39_N_EXP||'@'||t39_FASE  in (select  t39_anyo||'@'||t39_N_EXP||'@'||max(t39_FASE) from r75b.r7539t00 group by T39_anyo,t39_N_EXP)) t39 ON
t30_anyo = t39.t39_anyo and t30_N_EXP=t39.t39_N_EXP /*and t30_fase = t39_FASE*/
WHERE 
T30_ANYO =2019
AND t30_fase <> 5
and t30_anyo||'@'||t30_N_EXP||'@'||t30_FASE  in (select  t30_anyo||'@'||t30_N_EXP||'@'||max(t30_FASE) from r75b.r7530t00 group by T30_anyo,t30_N_EXP)
and T30_FEC_RENUN IS NULL and T30_ANYO_AA79B is null and T30_N_EXP_AA79B is null
/**
* Para filtrar por un expediente concreto con variables pasadas
*/
AND 
 1 = (
 CASE WHEN ANYO_AUX <> '0' AND T30_ANYO = ANYO_AUX THEN 1  
 ELSE CASE WHEN ANYO_AUX = '0' THEN 1 
 ELSE 0 END END
 )
AND 
1 = (
 CASE WHEN NUM_AUX <> '0' AND t30_N_EXP = NUM_AUX THEN 1  
 ELSE CASE WHEN NUM_AUX = '0' THEN 1 
 ELSE 0 END END
 )
)ORDER BY 1,2,3 DESC;

 TYPE r_reg_gestor
IS
  RECORD
  (
   	ANYO_054  NUMBER(4),
    NUM_EXP_054  NUMBER(6),
	DNI_SOLICITANTE_054 VARCHAR2(10),
	PRE_DNI_SOLICITANTE_054 VARCHAR2(1),
	SUF_DNI_SOLICITANTE_054 VARCHAR2(1),
    TIPO_ENTIDAD_054 VARCHAR2(1),
    ID_ENTIDAD_054 NUMBER(8),
    IND_VIP_054 VARCHAR2(1),
    DNI_REPRESENTANTE_054 VARCHAR2(10),
    NOMBRE_077	VARCHAR2(20),	
	APEL1_077	VARCHAR2(40),	
	APEL2_077	VARCHAR2(40)
  );
  GESTOR r_reg_gestor;
  
  TYPE r_reg_contacto
IS
  RECORD
  (
   	ANYO_058  NUMBER(4),
    NUM_EXP_058  NUMBER(6),
    DNI_CONTACTO_058 VARCHAR2(10),
    PRE_DNI_CONTACTO_058 VARCHAR2(1),
    SUF_DNI_CONTACTO_058 VARCHAR2(1),
    TIPO_ENTIDAD_ASOC_058 VARCHAR2(1),
    ID_ENTIDAD_ASOC_058 NUMBER(8),
    NOMBRE_077	VARCHAR2(20),	
	APEL1_077	VARCHAR2(40),	
	APEL2_077	VARCHAR2(40)
  );
  CONTACTO r_reg_contacto;  
 
  HORAS_INTERPRETACION_ACUM VARCHAR2(150);

ID_BITACORA NUMBER(2):= 0;
ID_DIR_NORA NUMBER(8);
ID_DOCU_NUEVO NUMBER(20);
ID_TAREA_NUEVO NUMBER(20);
ID_TAREA_ANTERIOR NUMBER(20);
ID_NUEVO_FICHERO_FINAL NUMBER(20);
ID_FICHERO_USADO VARCHAR2(1):= 'S';
ID_CONT_FACT NUMBER(10);

NUM_EXP_ACTUAL NUMBER(6);
ANYO_ACTUAL NUMBER(4);
ID_ORDEN NUMBER(4);
CONTADOR NUMBER(1):= 0;
POR_EUSKERA NUMBER(3);
QUERY_DOCUS VARCHAR2(4000);
ORDEN_TAREA NUMBER(2):= 0;

IMPORTE_ENTIDAD        NUMBER(9,2):=0.0;
IMPORTE_BASE_ENTIDAD   NUMBER(8,2):=0.0;
IMPORTE_IVA_ENTIDAD    NUMBER(8,2):=0.0;
IMPORTE_DIFICULTAD_ENT NUMBER(8,2):=0.0;
IMPORTE_URGENCIA_ENT   NUMBER(8,2):=0.0;

-- NUMEROS DE PALABRAS PARA CADA ENTIDAD
NUM_TOTAL_PAL_FACTURAR_ENT NUMBER(6);
NUM_PAL_CONCOR_0_84_ENT    NUMBER(6);
NUM_PAL_CONCOR_85_94_ENT   NUMBER(6);
NUM_PAL_CONCOR_95_100_ENT  NUMBER(6);

REFERENCIA_PAGO VARCHAR2(13);
FECHA_EMISION DATE;
ID_FACTURA NUMBER(10);

type dyncursor is ref cursor;
C_DOCUMENTOS dyncursor;
C_TAREAS_INTER dyncursor;

TYPE r_reg_documentos IS RECORD (
    COD_DOC_R75 NUMBER(8),
	TIPO_DOCUMENTO_056 NUMBER(2),
	ANYO_056 NUMBER(4),
	NUM_EXP_056 NUMBER(6),
	EXTENSION_DOC_056 VARCHAR2(10),
	OID_FICHERO_056 VARCHAR2(150),
	RUTA_PIF_FICHERO_056 VARCHAR2(500),
	TAMANO_DOC_056 VARCHAR2(10),
	IND_ENCRIPTADO_056 VARCHAR2(1) ,
	ID_DOC_REL_056 NUMBER(20),
	CLASE_DOCUMENTO_056 NUMBER(2),
	CONTENT_TYPE_056 VARCHAR2(150),
	TITULO_056 VARCHAR2(256),
	NUM_PAL_SOLIC_056 NUMBER(6),
	NUM_PAL_IZO_056 NUMBER(6),
	PERSONA_CONTACTO_056 VARCHAR2(150),
	EMAIL_CONTACTO_056 VARCHAR2(256),
	TELEFONO_CONTACTO_056 VARCHAR2(15),
	DIRECCION_CONTACTO_056 VARCHAR2(256),
	ENTIDAD_CONTACTO_056 VARCHAR2(150),
	IND_VISIBLE_056 VARCHAR2(1),
	FECHA_ALTA_056 DATE,
	DNI_ALTA_056 VARCHAR2(10),
	ID_DOC_VERSION_056 NUMBER(20),
	NOMBRE_FICHERO_056 VARCHAR2(250),
	IND_ORIGEN_056 VARCHAR2(1)
);
R_DOCUMENTOS r_reg_documentos;

BEGIN
 

	
	FOR R_EXP_R75 IN C_EXP_R75
    LOOP
    	BEGIN
      	NUM_EXP_ACTUAL := R_EXP_R75.NUM_EXP_051;
     	ANYO_ACTUAL:= R_EXP_R75.ANYO_051;
    	ID_BITACORA:= 1;
    	ORDEN_TAREA:=1;
    	-- BORRAMOS, SI ES QUE EXISTE, EL EXPEDIENTE QUE COINCIDA EN NUMERO y ANYO
    	-- Insertamos los oid de los ficheros de tareas que se van a borrar. No se hace de momento para no eliminar oid original de R75
    	--Insert into AA79BA0T00 (OID_0A0, FECHA_0A0)	SELECT OID_FICHERO_088, sysdate from AA79B92T00, AA79B81T00, AA79B88T00 WHERE ID_TAREA_081 = ID_TAREA_092 AND NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ANYO_081 =  R_EXP_R75.ANYO_051 AND ID_FICHERO_FINAL_092 = ID_FICHERO_088;
    	--Insert into AA79BA0T00 (OID_0A0, FECHA_0A0)	SELECT OID_FICHERO_088, sysdate from AA79B87T00, AA79B81T00, AA79B88T00  WHERE ID_TAREA_081 = ID_TAREA_087 AND NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ANYO_081 =  R_EXP_R75.ANYO_051 AND ID_FICHERO_TRADUCIDO_087 = ID_FICHERO_088;
    	--Insert into AA79BA0T00 (OID_0A0, FECHA_0A0)	SELECT OID_FICHERO_088, sysdate from AA79B93T00, AA79B81T00, AA79B88T00 WHERE ID_TAREA_081 = ID_TAREA_093 AND NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ANYO_081 =  R_EXP_R75.ANYO_051 AND ID_FICHERO_JUSTIFICANTE_093 = ID_FICHERO_088;
    	--Insert into AA79BA0T00 (OID_0A0, FECHA_0A0)	SELECT OID_FICHERO_088, sysdate from AA79B96T00, AA79B81T00, AA79B88T00 WHERE ID_TAREA_081 = ID_TAREA_096 AND NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ANYO_081 =  R_EXP_R75.ANYO_051 AND ID_FICHERO_XLIFF_096 = ID_FICHERO_088;
    	--Insert into AA79BA0T00 (OID_0A0, FECHA_0A0)	SELECT OID_FICHERO_088, sysdate from AA79BB1T00, AA79B81T00, AA79B88T00 WHERE ID_TAREA_081 = ID_TAREA_0B1 AND NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ANYO_081 =  R_EXP_R75.ANYO_051 AND ID_FICHERO_0B1 = ID_FICHERO_088;
    	--Insert into AA79BA0T00 (OID_0A0, FECHA_0A0)	SELECT OID_FICHERO_088, sysdate from AA79B86T00, AA79B81T00, AA79B88T00 WHERE ID_TAREA_086 = ID_TAREA_0B1 AND NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ANYO_081 =  R_EXP_R75.ANYO_051 AND ID_FICHERO_INFORME_086 = ID_FICHERO_088;
    	--Insert into AA79BA0T00 (OID_0A0, FECHA_0A0)	SELECT OID_FICHERO_088, sysdate from AA79B86T00, AA79B81T00, AA79B88T00 WHERE ID_TAREA_086 = ID_TAREA_0B1 AND NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ANYO_081 =  R_EXP_R75.ANYO_051 AND ID_FICHERO_DOC_086 = ID_FICHERO_088;
    	--Insert into AA79BA0T00 (OID_0A0, FECHA_0A0)	SELECT OID_FICHERO_088, sysdate from AA79B90T00, AA79B81T00, AA79B88T00 WHERE ID_TAREA_090 = ID_TAREA_0B1 AND NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ANYO_081 =  R_EXP_R75.ANYO_051 AND ID_FICHERO_TRADOS_090 = ID_FICHERO_088;
    	-- Borramos ficheros
    	delete aa79b88t00 WHERE id_fichero_088 in (Select ID_FICHERO_FINAL_092 from AA79B92T00, AA79B81T00 WHERE ID_TAREA_081 = ID_TAREA_092 AND NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ANYO_081 =  R_EXP_R75.ANYO_051);
    	delete aa79b88t00 WHERE id_fichero_088 in (Select ID_FICHERO_TRADUCIDO_087 from AA79B87T00, AA79B81T00 WHERE ID_TAREA_081 = ID_TAREA_087 AND NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ANYO_081 =  R_EXP_R75.ANYO_051);
    	delete aa79b88t00 WHERE id_fichero_088 in (Select ID_FICHERO_JUSTIFICANTE_093 from AA79B93T00, AA79B81T00 WHERE ID_TAREA_081 = ID_TAREA_093 AND NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ANYO_081 =  R_EXP_R75.ANYO_051);
    	delete aa79b88t00 WHERE id_fichero_088 in (Select ID_FICHERO_XLIFF_096 from AA79B96T00, AA79B81T00 WHERE ID_TAREA_081 = ID_TAREA_096 AND NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ANYO_081 =  R_EXP_R75.ANYO_051);
    	delete aa79b88t00 WHERE id_fichero_088 in (Select ID_FICHERO_0B1 from AA79BB1T00, AA79B81T00 WHERE ID_TAREA_081 = ID_TAREA_0B1 AND NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ANYO_081 =  R_EXP_R75.ANYO_051);
    	delete aa79b88t00 WHERE id_fichero_088 in (Select ID_FICHERO_INFORME_086 from AA79B86T00, AA79B81T00 WHERE ID_TAREA_081 = ID_TAREA_086 AND NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ANYO_081 =  R_EXP_R75.ANYO_051);
    	delete aa79b88t00 WHERE id_fichero_088 in (Select ID_FICHERO_DOC_086 from AA79B86T00, AA79B81T00 WHERE ID_TAREA_081 = ID_TAREA_086 AND NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ANYO_081 =  R_EXP_R75.ANYO_051);
    	delete aa79b88t00 WHERE id_fichero_088 in (Select ID_FICHERO_TRADOS_090 from AA79B90T00, AA79B81T00 WHERE ID_TAREA_081 = ID_TAREA_090 AND NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ANYO_081 =  R_EXP_R75.ANYO_051);
    	-- Borramos las tareas del expediente
    	delete aa79b81t00 where NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ANYO_081 =  R_EXP_R75.ANYO_051;
    	-- Borramos los requerimientos de un expediente
    	delete AA79B66T00 where ID_066 in (Select ID_REQUERIMIENTO_059 from AA79B59T00 WHERE  NUM_EXP_059 = R_EXP_R75.NUM_EXP_051 AND ANYO_059 =  R_EXP_R75.ANYO_051);
    	delete AA79B65T00 where ID_065 in (Select ID_REQUERIMIENTO_059 from AA79B59T00 WHERE  NUM_EXP_059 = R_EXP_R75.NUM_EXP_051 AND ANYO_059 =  R_EXP_R75.ANYO_051);
    	delete AA79B64T00 where ID_064 in (Select ID_REQUERIMIENTO_059 from AA79B59T00 WHERE  NUM_EXP_059 = R_EXP_R75.NUM_EXP_051 AND ANYO_059 =  R_EXP_R75.ANYO_051);
    	-- borramos un posible rechazo del expediente
    	delete AA79B68T00 where ID_068 in (Select ID_RECHAZO_059 from AA79B59T00 WHERE  NUM_EXP_059 = R_EXP_R75.NUM_EXP_051 AND ANYO_059 =  R_EXP_R75.ANYO_051);
    	delete AA79B67T00 where ID_067 in (Select ID_RECHAZO_059 from AA79B59T00 WHERE  NUM_EXP_059 = R_EXP_R75.NUM_EXP_051 AND ANYO_059 =  R_EXP_R75.ANYO_051);
    	delete AA79BA2T00 where ID_0A2 in (Select ID_ANULACION_059 from AA79B59T00 WHERE  NUM_EXP_059 = R_EXP_R75.NUM_EXP_051 AND ANYO_059 =  R_EXP_R75.ANYO_051);
    	delete AA79BA1T00 where ID_0A1 in (Select ID_ANULACION_059 from AA79B59T00 WHERE  NUM_EXP_059 = R_EXP_R75.NUM_EXP_051 AND ANYO_059 =  R_EXP_R75.ANYO_051);
    	-- borramos el registro de acciones
    	delete AA79B43T00 where NUM_EXP_043 = R_EXP_R75.NUM_EXP_051 AND ANYO_EXP_043 =  R_EXP_R75.ANYO_051;
    	
    	-- borramos bitacoras
    	update aa79b51T00 set ESTADO_BITACORA_051 = null where NUM_EXP_051 = R_EXP_R75.NUM_EXP_051 AND ANYO_051 =  R_EXP_R75.ANYO_051;
    	delete aa79b59t00 where NUM_EXP_059 = R_EXP_R75.NUM_EXP_051 AND ANYO_059 =  R_EXP_R75.ANYO_051;
    	-- borramos bitácora del solicitante
    	delete aa79b79t00 where NUM_EXP_079 = R_EXP_R75.NUM_EXP_051 AND ANYO_079 =  R_EXP_R75.ANYO_051;
    	-- AA79B80T00 LIBRO REGISTRO
    	delete aa79b80t00 where NUM_EXP_080 = R_EXP_R75.NUM_EXP_051 AND ANYO_080 =  R_EXP_R75.ANYO_051;
    	
    	-- insertamos los oids de los docs originales que se van a borrar. No se hace de momento para no eliminar oid original de R75
    	--Insert into AA79BA0T00 (OID_0A0, FECHA_0A0)	SELECT OID_FICHERO_056, sysdate from AA79B56T00 WHERE NUM_EXP_056 = R_EXP_R75.NUM_EXP_051 AND ANYO_056 =  R_EXP_R75.ANYO_051;
    	-- borramos los docs originales del expediente
    	delete aa79b56t00 where NUM_EXP_056 = R_EXP_R75.NUM_EXP_051 AND ANYO_056 =  R_EXP_R75.ANYO_051; 
    	-- 57 expedientes relacionados
    	delete aa79b57T00 where  NUM_EXP_057 = R_EXP_R75.NUM_EXP_051 AND ANYO_057 =  R_EXP_R75.ANYO_051; 
    	
    	-- expedientes a facturar, perviamente borrar los datos de facturación
    	-- Datos Facturacion expedientes traducción
    	delete AA79B97T00 WHERE NUM_EXP_097 = R_EXP_R75.NUM_EXP_051 AND ANYO_097 =  R_EXP_R75.ANYO_051; 
    	DELETE AA79B98T00 WHERE ID_098 IN (SELECT ID_058 FROM aa79b58t00 WHERE NUM_EXP_058 = R_EXP_R75.NUM_EXP_051 AND ANYO_058 =  R_EXP_R75.ANYO_051);
    	-- A3 Datos Facturacion expedientes interpretación
    	delete AA79BA3T00 WHERE NUM_EXP_0A3 = R_EXP_R75.NUM_EXP_051 AND ANYO_0A3 =  R_EXP_R75.ANYO_051; 
    	DELETE AA79BA6T00 WHERE ID_0A6 IN (SELECT ID_058 FROM aa79b58t00 WHERE NUM_EXP_058 = R_EXP_R75.NUM_EXP_051 AND ANYO_058 =  R_EXP_R75.ANYO_051);
    	-- ENTIDADES A FACTURAR
    	DELETE AA79B58T00 WHERE NUM_EXP_058 = R_EXP_R75.NUM_EXP_051 AND ANYO_058 =  R_EXP_R75.ANYO_051;
    	-- AA79B62T00 categorización expediente
    	DELETE AA79B62T00 WHERE NUM_EXP_062 = R_EXP_R75.NUM_EXP_051 AND ANYO_062 =  R_EXP_R75.ANYO_051;
    	-- AA79B63T00 (Receptores autorizados)
    	DELETE AA79B63T00 WHERE NUM_EXP_063 = R_EXP_R75.NUM_EXP_051 AND ANYO_063 =  R_EXP_R75.ANYO_051;
    	-- borramos la solicitud
    	-- solicitudes relacionadas
    	delete aa79b74T00 where  NUM_EXP_074 = R_EXP_R75.NUM_EXP_051 AND ANYO_074 =  R_EXP_R75.ANYO_051; 
    	-- 73 documentos solicitud, pasando oids
    	--Insert into AA79BA0T00 (OID_0A0, FECHA_0A0) SELECT OID_FICHERO_073, sysdate from AA79B73T00 WHERE NUM_EXP_073 = R_EXP_R75.NUM_EXP_051 AND ANYO_073 =  R_EXP_R75.ANYO_051;
    	delete AA79B73T00 where NUM_EXP_073 = R_EXP_R75.NUM_EXP_051 AND ANYO_073 =  R_EXP_R75.ANYO_051; 
    	-- 72 observaciones solicitud (lopd)
    	delete AA79B72T00 where NUM_EXP_072 = R_EXP_R75.NUM_EXP_051 AND ANYO_072 =  R_EXP_R75.ANYO_051; 
    	-- 71 solicitud traduccion revision
    	delete AA79B71T00 where NUM_EXP_071 = R_EXP_R75.NUM_EXP_051 AND ANYO_071 =  R_EXP_R75.ANYO_051; 
    	-- 70 solicitud interpretacion
    	delete AA79B70T00 where NUM_EXP_070 = R_EXP_R75.NUM_EXP_051 AND ANYO_070 =  R_EXP_R75.ANYO_051; 
    	-- 69 SOlicitud expediente
    	delete AA79B69T00 where NUM_EXP_069 = R_EXP_R75.NUM_EXP_051 AND ANYO_069 =  R_EXP_R75.ANYO_051; 
      
      -- 69 SOlicitud expediente
    	delete AA79BA5T00 where NUM_EXP_0A5 = R_EXP_R75.NUM_EXP_051 AND ANYO_0A5 =  R_EXP_R75.ANYO_051; 
    	
    	-- borramos el expediente
    	delete aa79b54t00 where NUM_EXP_054 = R_EXP_R75.NUM_EXP_051 AND ANYO_054 =  R_EXP_R75.ANYO_051; 
		delete aa79b55t00 where NUM_EXP_055 = R_EXP_R75.NUM_EXP_051 AND ANYO_055 =  R_EXP_R75.ANYO_051; 
    	delete aa79b52t00 where NUM_EXP_052 = R_EXP_R75.NUM_EXP_051 AND ANYO_052 =  R_EXP_R75.ANYO_051; 
		delete aa79b53t00 where NUM_EXP_053 = R_EXP_R75.NUM_EXP_051 AND ANYO_053 =  R_EXP_R75.ANYO_051; 
    	delete aa79b57t00 where NUM_EXP_057 = R_EXP_R75.NUM_EXP_051 AND ANYO_057 =  R_EXP_R75.ANYO_051; 
    	delete aa79b57t00 where NUM_EXP_REL_057 = R_EXP_R75.NUM_EXP_051 AND ANYO_EXP_REL_057 =  R_EXP_R75.ANYO_051; 
		delete aa79b51t00 where NUM_EXP_051= R_EXP_R75.NUM_EXP_051 AND ANYO_051 =  R_EXP_R75.ANYO_051; 
    
    -- Empezamos la inserción de expedientes.

		Insert into AA79B51T00 (ANYO_051,NUM_EXP_051,ID_TIPO_EXPEDIENTE_051,ORIGEN_051,FECHA_ALTA_051,TITULO_051,ESTADO_BITACORA_051,DNI_TECNICO_051,DNI_ASIGNADOR_051,IND_PRIORITARIO_051,FECHA_BAJA_051,ESTADO_BAJA_051,OBSV_BAJA_051,OBSV_FACT_051, APLIC_ORIGEN_051, DESC_R75_051) 
		values (R_EXP_R75.ANYO_051,R_EXP_R75.NUM_EXP_051,R_EXP_R75.ID_TIPO_EXPEDIENTE_051,R_EXP_R75.ORIGEN_051,R_EXP_R75.FECHA_ALTA_051,R_EXP_R75.TITULO_051,null,null,null,'N',null,'A',null,null,R_EXP_R75.APLIC_ORIGEN, R_EXP_R75.DESC_R75_051);
		-- Metemos las observaciones para el IZO.
		IF (R_EXP_R75.OBSERVACIONES is not null) THEN
			INSERT INTO AA79B55T00 (ANYO_055, NUM_EXP_055, OBSERVACIONES_055) values (R_EXP_R75.ANYO_051,R_EXP_R75.NUM_EXP_051,R_EXP_R75.OBSERVACIONES);
		END IF;
		IF (R_EXP_R75.ID_TIPO_EXPEDIENTE_051 = 'I') THEN
			-- DIRECCION NORA 
			select AA79B49Q00.nextVal into ID_DIR_NORA from dual;
			INSERT INTO AA79B49S01 (CDIRNORA_049, TIPONORA_049, CODPROV_049, CODMUNI_049, APROX_049)
			select ID_DIR_NORA, '0', LPAD(T31_MUN_PROV,2,'0'), LPAD(T31_MUN_MUNI,3,'0'), T31_LUGAR from r75b.r7531t00 where t31_anyo = R_EXP_R75.ANYO_051 
			and t31_N_EXP= R_EXP_R75.NUM_EXP_051 AND t31_fase= R_EXP_R75.T30_FASE;
			
			-- INSERT EN LA 52
			Insert into AA79B52T00 (ANYO_052,NUM_EXP_052,MODO_INTERPRETACION_052,TIPO_ACTO_052,TIPO_PETICIONARIO_052,IND_PROGRAMADA_052,FECHA_INI_052,FECHA_FIN_052,DIR_NORA_052,
			IND_PRESUPUESTO_052,IND_FACTURABLE_052,
			PERSONA_CONTACTO_052,EMAIL_CONTACTO_052,TELEFONO_CONTACTO_052,IND_OBSERVACIONES_052) 
			select t31_anyo as ANYO_052,t31_N_EXP as NUM_EXP_053, T31_MODO_INTER AS MODO_INTERPRETACION_052, DECODE(T31_TIPO_INTER,5,0,T31_TIPO_INTER) AS TIPO_ACTO_052, DECODE(T31_PETICIONARIO,1, 'P', 'A') AS TIPO_PETICIONARIO_052,
			DECODE(T31_PROGRAMADA,'1','S','N') AS IND_PROGRAMADA_052, T31_FEC_INI_PRE AS FECHA_INI_052, T31_FEC_FIN_PRE AS FECHA_FIN_052, ID_DIR_NORA,
			DECODE(T30_PPTO,'1','S','N') AS IND_PRESUPUESTO_052, DECODE(T30_FACTURABLE,'1','S','N') AS IND_FACTURABLE_052, 
			T31_USU_FINAL AS PERSONA_CONTACTO_052, null as EMAIL_CONTACTO_052, null as TELEFONO_CONTACTO_052,
			DECODE(T30_OBSERV_IZO,null,'N','S') as IND_OBSERVACIONES_053
			from r75b.r7530t00,r75b.r7531t00 where t30_anyo = R_EXP_R75.ANYO_051 and t30_N_EXP= R_EXP_R75.NUM_EXP_051
			and t30_anyo = t31_anyo and t30_N_EXP=t31_N_EXP AND T30_FASE=T31_FASE AND
			t30_fase= R_EXP_R75.t30_FASE  order by 1,2,3 desc;
		ELSE
			-- INSERT EN LA 53
			Insert into AA79B53T00 (ANYO_053,NUM_EXP_053,IND_PUBLICAR_BOPV_053,IND_PREVISTO_BOPV_053,ID_IDIOMA_053,IND_CONFIDENCIAL_053,IND_CORREDACCION_053,TEXTO_053,TIPO_REDACCION_053,PARTICIPANTES_053,REF_TRAMITAGUNE_053,NUM_TOTAL_PAL_IZO_053,
			NUM_TOTAL_PAL_SOLIC_053,FECHA_FINAL_SOLIC_053,FECHA_FINAL_PROP_053,FECHA_FINAL_IZO_053,IND_FACTURABLE_053,ID_RELEVANCIA_053,IND_URGENTE_053,IND_DIFICIL_053,IND_PRESUPUESTO_053,IND_OBSERVACIONES_053,IND_PUBLICADO_BOE_053,URL_BOE_053,FECHA_ENTREGA_REAL_053) 
			select t32_anyo as ANYO_053,t32_N_EXP as NUM_EXP_053,
			DECODE(t32_BOPV,'1','S','N') AS IND_PUBLICAR_BOPV_053,
			DECODE(t32_BOPV,'1','S','N') AS IND_PREVISTO_BOPV_053, 
			DECODE(t32_IDIOMA,'3','1','0','1',t32_IDIOMA) AS ID_IDIOMA_053,'N' as IND_CONFIDENCIAL_053,
 			'N'  as IND_CORREDACCION_053, 
			null as TEXTO_053, 
			null as TIPO_REDACCION_053,
			null as PARTICIPANTES_053, 
			T30_REF_SOLI as REF_TRAMITAGUNE_053, 
			T32_NUM_TOT_PAL AS NUM_TOTAL_PAL_IZO_053, 
			T32_NUM_TOT_PAL AS NUM_TOTAL_PAL_SOLIC_053, 
			T32_FEC_ENTR_SOL AS FECHA_FINAL_SOLIC_053, 
			T32_FEC_ENTR_IVAP AS FECHA_FINAL_PROP_053, 
			T30_FEC_FIN AS FECHA_FINAL_IZO_053, 
			DECODE(T30_FACTURABLE,'1','S','N') AS IND_FACTURABLE_053, 
			'3' AS ID_RELEVANCIA_053, 
			DECODE(T32_URGENCIA,'1','S','N') AS IND_URGENTE_053, 
			DECODE(T32_DIFICULTAD,'1','S','N') AS IND_DIFICIL_053, 
			DECODE(T32_PRESUPUESTO,'1','S','N') AS IND_PRESUPUESTO_053, 
			DECODE(T30_OBSERV_IZO,null,'N','S') as IND_OBSERVACIONES_053, 
			'N' AS IND_PUBLICADO_BOE_053, 
			null as URL_BOE_053, 
			nvl(T32_FEC_ENTR_IVAP, T30_FEC_FIN) AS FECHA_ENTREGA_REAL_053
			from r75b.r7530t00,r75b.r7532t00 where t30_anyo = R_EXP_R75.ANYO_051 and t30_N_EXP= R_EXP_R75.NUM_EXP_051
			and t30_anyo = t32_anyo and t30_N_EXP=t32_N_EXP AND T30_FASE=T32_FASE AND
			t30_fase= R_EXP_R75.t30_FASE  order by 1,2,3 desc;
		END IF;
		
		-- RECUPERAMOS EL GESTOR
		select t30_anyo as anyo_054,t30_n_exp as NUM_EXP_054, 
		decode(t21_dni, null,'00000000',trim(translate(t21_dni,translate(t21_dni, '1234567890', ' '),' '))) as DNI_SOLICITANTE_054,
		trim(translate(substr(t21_dni,0,1), '1234567890', ' ')) as PRE_DNI_SOLICITANTE_054, 
		decode(t21_dni, null, 'T',trim(translate(substr(t21_dni,length(t21_dni),1), '1234567890', ' ')))  as SUF_DNI_SOLICITANTE_054, 
   	 	nvl(TIPO_X54,'B') as TIPO_ENTIDAD_054,
   	 	nvl(ID_X54,570) as ID_ENTIDAD_054,
    	DECODE(t21_vips,'',0,t21_vips) as IND_VIP_054,null as DNI_REPRESENTANTE_054, T21_NOMBRE, T21_APEL1, T21_APEL2 into GESTOR from r75b.r7530t00,r75b.r7521t00,r75b.r7519t00, CODR75X54J  
    	where  t30_cod_solicitante=t21_cod_solicitante and  t21_cod_solicitante=t19_cod_solicitante  
		and T30_COD_CONT_SOLI=T21_COD_CONT_SOLI and t30_fase= R_EXP_R75.t30_FASE and t30_anyo = R_EXP_R75.ANYO_051 AND t30_n_exp =R_EXP_R75.NUM_EXP_051 
		and t30_cod_solicitante = ID_R75 (+);
		
		--INSERTAMOS EL GESTOR
		Select count(1) into contador from AA79B77T00 WHERE DNI_077 = GESTOR.DNI_SOLICITANTE_054;
		IF (CONTADOR = 0) THEN
			Insert into AA79B77T00 (DNI_077,TIPIDEN_077,PREDNI_077,SUFDNI_077,NOMBRE_077,APEL1_077,APEL2_077) 
			values (GESTOR.DNI_SOLICITANTE_054,'1',GESTOR.PRE_DNI_SOLICITANTE_054,GESTOR.SUF_DNI_SOLICITANTE_054,GESTOR.NOMBRE_077,GESTOR.APEL1_077,GESTOR.APEL2_077);
		END IF;
		
		Insert into AA79B54T00 (ANYO_054,NUM_EXP_054,DNI_SOLICITANTE_054,TIPO_ENTIDAD_054,ID_ENTIDAD_054,IND_VIP_054,DNI_REPRESENTANTE_054) 
		values (R_EXP_R75.ANYO_051, R_EXP_R75.NUM_EXP_051, GESTOR.DNI_SOLICITANTE_054, GESTOR.TIPO_ENTIDAD_054, GESTOR.ID_ENTIDAD_054, GESTOR.IND_VIP_054, null);
		
		-- insertamos el contacto de facturación
	        
	    Select AA79B58Q00.nextval into ID_CONT_FACT from dual;
		INSERT INTO AA79B58T00 (ID_058, ANYO_058, NUM_EXP_058, TIPO_ENTIDAD_ASOC_058, ID_ENTIDAD_ASOC_058, DNI_CONTACTO_058, POR_FACTURA_058)
		values (ID_CONT_FACT, R_EXP_R75.ANYO_051, R_EXP_R75.NUM_EXP_051, GESTOR.TIPO_ENTIDAD_054, GESTOR.ID_ENTIDAD_054, GESTOR.DNI_SOLICITANTE_054, 100);
		
		
		
		-- insertamos los documentos
		Select AA79B56Q00.nextval into ID_DOCU_NUEVO from dual;
		
		Insert into AA79B56T00 (ID_DOC_056,ANYO_056,NUM_EXP_056,OID_FICHERO_056,RUTA_PIF_FICHERO_056,EXTENSION_DOC_056,TAMANO_DOC_056,IND_ENCRIPTADO_056,CONTENT_TYPE_056,
		ID_DOC_REL_056,CLASE_DOCUMENTO_056,TIPO_DOCUMENTO_056,TITULO_056,NUM_PAL_SOLIC_056,NUM_PAL_IZO_056,PERSONA_CONTACTO_056,EMAIL_CONTACTO_056,TELEFONO_CONTACTO_056,
		DIRECCION_CONTACTO_056,ENTIDAD_CONTACTO_056,IND_VISIBLE_056,FECHA_ALTA_056,DNI_ALTA_056,ID_DOC_VERSION_056,NOMBRE_FICHERO_056,IND_ORIGEN_056) 
		Select ID_DOCU_NUEVO, ANYO_056, NUM_EXP_056, OID_FICHERO_056, RUTA_PIF_FICHERO_056, EXTENSION_DOC_056, TAMANO_DOC_056, IND_ENCRIPTADO_056,
        CONTENT_TYPE_056, ID_DOC_REL_056, CLASE_DOCUMENTO_056, TIPO_DOCUMENTO_056, TITULO_056, NUM_PAL_SOLIC_056, NUM_PAL_IZO_056, PERSONA_CONTACTO_056, 
		EMAIL_CONTACTO_056, TELEFONO_CONTACTO_056, DIRECCION_CONTACTO_056, ENTIDAD_CONTACTO_056, IND_VISIBLE_056, FECHA_ALTA_056, DNI_ALTA_056,
		ID_DOC_VERSION_056, NOMBRE_FICHERO_056, IND_ORIGEN_056 from(      
		select T39_COD_TIPO_DOCUMENTO AS TIPO_DOCUMENTO_056, t39_anyo AS ANYO_056, t39_N_EXP AS NUM_EXP_056,
		DECODE(INSTR(T38_NOMBRE_DOC,'.',-1),'0','mmm',SUBSTR(T38_NOMBRE_DOC,INSTR(T38_NOMBRE_DOC,'.',-1) +1,length(T38_NOMBRE_DOC))) AS EXTENSION_DOC_056,
		T38_OID AS OID_FICHERO_056, null  AS RUTA_PIF_FICHERO_056, T38_TAMANO AS TAMANO_DOC_056, 'N' AS IND_ENCRIPTADO_056,
		null AS ID_DOC_REL_056, 
		CASE WHEN T30_COD_TIPO_EXP=2 THEN 2
	    ELSE CASE WHEN T30_COD_TIPO_EXP=3 THEN 1
	    ELSE NULL END END AS CLASE_DOCUMENTO_056,
		T38_TIPO AS CONTENT_TYPE_056, DECODE(INSTR(T38_NOMBRE_DOC,'.',-1),0,T38_NOMBRE_DOC,SUBSTR(T38_NOMBRE_DOC,1,INSTR(T38_NOMBRE_DOC,'.',-1)-1))    AS TITULO_056,
		T39_TOT_PAL AS NUM_PAL_SOLIC_056, T39_TOT_PAL AS NUM_PAL_IZO_056,
		null AS PERSONA_CONTACTO_056, null AS EMAIL_CONTACTO_056, null AS TELEFONO_CONTACTO_056, null AS DIRECCION_CONTACTO_056, null AS ENTIDAD_CONTACTO_056,
		'S' AS IND_VISIBLE_056, T38_FECHA AS FECHA_ALTA_056, '16265343' AS DNI_ALTA_056, null AS ID_DOC_VERSION_056, T38_NOMBRE_DOC  AS NOMBRE_FICHERO_056,
		DECODE(t30_VIA_WEB,'1','E','0','I','3','E') AS IND_ORIGEN_056 
		from r75b.r7530t00,r75b.r7532t00,r75b.r7539t00,r75b.r7538t00 where  nvl(t39_COD_DOC1,t39_COD_DOC2)=t38_COD_DOC and
		t30_anyo = t32_anyo and t30_N_EXP=t32_N_EXP AND T30_FASE=T32_FASE /*AND  t39_COD_DOC2 is not null*/ and 
		t30_fase= R_EXP_R75.t30_FASE  and T30_COD_TIPO_EXP in (2,3) and t30_anyo = t39_anyo and t30_N_EXP=t39_N_EXP 
        AND t30_anyo = R_EXP_R75.ANYO_051 AND t30_n_exp =R_EXP_R75.NUM_EXP_051 
        AND t39_anyo||'@'||t39_N_EXP||'@'||t39_FASE  in (select  t39_anyo||'@'||t39_N_EXP||'@'||max(t39_FASE) from r75b.r7539t00
		group by T39_anyo,t39_N_EXP));
		
		-- insertamos la bitácora
		Insert into AA79B59T00 (ANYO_059,NUM_EXP_059,ID_ESTADO_BITACORA_059,ID_ESTADO_EXP_059,ID_FASE_EXPEDIENTE_059,DATO_ADIC_059,INFO_ADIC_059,ID_RECHAZO_059,ID_REQUERIMIENTO_059,ID_ANULACION_059,FECHA_ALTA_059) 
		values (R_EXP_R75.ANYO_051,R_EXP_R75.NUM_EXP_051,ID_BITACORA,'1','1',null,null,null,null,null,R_EXP_R75.FECHA_ALTA_051);
		ID_BITACORA:= ID_BITACORA + 1;
		IF (/*R_EXP_R75.ORIGEN_051 <> 'O' AND */R_EXP_R75.ID_TIPO_EXPEDIENTE_051 <> 'I') THEN
			Insert into AA79B59T00 (ANYO_059,NUM_EXP_059,ID_ESTADO_BITACORA_059,ID_ESTADO_EXP_059,ID_FASE_EXPEDIENTE_059,DATO_ADIC_059,INFO_ADIC_059,ID_RECHAZO_059,ID_REQUERIMIENTO_059,ID_ANULACION_059,FECHA_ALTA_059) 
			values (R_EXP_R75.ANYO_051,R_EXP_R75.NUM_EXP_051,ID_BITACORA,'2','2',null,null,null,null,null,R_EXP_R75.FECHA_ALTA_051);
			
			
			/*Insert into AA79B59T00 (ANYO_059,NUM_EXP_059,ID_ESTADO_BITACORA_059,ID_ESTADO_EXP_059,ID_FASE_EXPEDIENTE_059,DATO_ADIC_059,INFO_ADIC_059,ID_RECHAZO_059,ID_REQUERIMIENTO_059,ID_ANULACION_059,FECHA_ALTA_059) 
			values (R_EXP_R75.ANYO_051,R_EXP_R75.NUM_EXP_051,ID_BITACORA,'2','3',null,null,null,null,null,R_EXP_R75.FECHA_ALTA_051);
			ID_BITACORA:= ID_BITACORA + 1;*/
			
			Insert into AA79B79T00 (ID_079,ANYO_079,NUM_EXP_079,ID_ACCION_BITACORA_079,FECHA_ALTA_079,USUARIO_079) 
			values (AA79B79Q00.nextVal,R_EXP_R75.ANYO_051,R_EXP_R75.NUM_EXP_051,1,R_EXP_R75.FECHA_ALTA_051, nvl(GESTOR.APEL1_077,'') || ' ' ||nvl(GESTOR.APEL1_077,'') || ', ' || GESTOR.NOMBRE_077);
		ELSE
			Insert into AA79B79T00 (ID_079,ANYO_079,NUM_EXP_079,ID_ACCION_BITACORA_079,FECHA_ALTA_079,USUARIO_079) 
			values (AA79B79Q00.nextVal,R_EXP_R75.ANYO_051,R_EXP_R75.NUM_EXP_051,1,R_EXP_R75.FECHA_ALTA_051,'IZO');
			
			Insert into AA79B59T00 (ANYO_059,NUM_EXP_059,ID_ESTADO_BITACORA_059,ID_ESTADO_EXP_059,ID_FASE_EXPEDIENTE_059,DATO_ADIC_059,INFO_ADIC_059,ID_RECHAZO_059,ID_REQUERIMIENTO_059,ID_ANULACION_059,FECHA_ALTA_059) 
			values (R_EXP_R75.ANYO_051,R_EXP_R75.NUM_EXP_051,ID_BITACORA,'3','9',null,null,null,null,null,R_EXP_R75.FECHA_ALTA_051);
			
			
			-- Bitacora solicitante
			Insert into AA79B79T00 (ID_079,ANYO_079,NUM_EXP_079,ID_ACCION_BITACORA_079,FECHA_ALTA_079,USUARIO_079) 
			values (AA79B79Q00.nextVal,R_EXP_R75.ANYO_051,R_EXP_R75.NUM_EXP_051,17,R_EXP_R75.FECHA_ALTA_051,'IZO');
			
		END IF;
		
		
		
    	
    	
    	IF (R_EXP_R75.ORIGEN_051 <> 'O') THEN
    		--copiamos de los expedientes a la solicitud
    		Insert into AA79B69T00 (ANYO_069,NUM_EXP_069,ID_TIPO_EXPEDIENTE_069,FECHA_ALTA_069,TITULO_069) SELECT 
			ANYO_051, NUM_EXP_051,ID_TIPO_EXPEDIENTE_051,FECHA_ALTA_051,TITULO_051 from aa79b51t00 where ANYO_051 = R_EXP_R75.ANYO_051 and NUM_EXP_051= R_EXP_R75.NUM_EXP_051;
	
			-- observaciones en la 72
			Insert into AA79B72T00 (ANYO_072, NUM_EXP_072,  OBSERVACIONES_072)
			SELECT ANYO_055, NUM_EXP_055,  OBSERVACIONES_055 from aa79b55t00 where ANYO_055 = R_EXP_R75.ANYO_051 and NUM_EXP_055= R_EXP_R75.NUM_EXP_051;
			
    		IF (R_EXP_R75.ID_TIPO_EXPEDIENTE_051 = 'I') THEN
    			--en la 70
    			Insert INTO AA79B70T00 (ANYO_070, NUM_EXP_070, MODO_INTERPRETACION_070, TIPO_ACTO_070, TIPO_PETICIONARIO_070, IND_PROGRAMADA_070,
				FECHA_INI_070, FECHA_FIN_070, DIR_NORA_070, IND_PRESUPUESTO_070, PERSONA_CONTACTO_070, EMAIL_CONTACTO_070, TELEFONO_CONTACTO_070, IND_OBSERVACIONES_070)
    			Select ANYO_052, NUM_EXP_052, MODO_INTERPRETACION_052, TIPO_ACTO_052, TIPO_PETICIONARIO_052, IND_PROGRAMADA_052,
				FECHA_INI_052, FECHA_FIN_052, DIR_NORA_052, IND_PRESUPUESTO_052, PERSONA_CONTACTO_052, EMAIL_CONTACTO_052, TELEFONO_CONTACTO_052, IND_OBSERVACIONES_052
				from AA79B52T00 WHERE ANYO_052 = R_EXP_R75.ANYO_051 and NUM_EXP_052= R_EXP_R75.NUM_EXP_051;
			ELSE
    			INSERT INTO AA79B71T00 (ANYO_071,NUM_EXP_071,
				IND_PUBLICAR_BOPV_071,ID_IDIOMA_071,IND_CONFIDENCIAL_071,IND_CORREDACCION_071,TEXTO_071,TIPO_REDACCION_071,PARTICIPANTES_071,REF_TRAMITAGUNE_071,
				NUM_TOTAL_PAL_SOLIC_071,FECHA_FINAL_SOLIC_071,IND_FACTURABLE_071,ID_RELEVANCIA_071,
				IND_URGENTE_071,IND_PRESUPUESTO_071,IND_OBSERVACIONES_071)
				SELECT ANYO_053 as ANYO_071,NUM_EXP_053 as NUM_EXP_071,
				IND_PUBLICAR_BOPV_053 as IND_PUBLICAR_BOPV_071,
				ID_IDIOMA_053 as ID_IDIOMA_071,
				IND_CONFIDENCIAL_053 as IND_CONFIDENCIAL_071,
				IND_CORREDACCION_053 as IND_CORREDACCION_071,
				TEXTO_053 as TEXTO_071,
				TIPO_REDACCION_053 as TIPO_REDACCION_071,
				PARTICIPANTES_053 as PARTICIPANTES_071,
				REF_TRAMITAGUNE_053 as REF_TRAMITAGUNE_071,
				NUM_TOTAL_PAL_SOLIC_053 as NUM_TOTAL_PAL_SOLIC_071,
				FECHA_FINAL_SOLIC_053 as FECHA_FINAL_SOLIC_071,
				IND_FACTURABLE_053 as IND_FACTURABLE_071,
				ID_RELEVANCIA_053 as ID_RELEVANCIA_071,
				IND_URGENTE_053 as IND_URGENTE_071,
				IND_PRESUPUESTO_053 as IND_PRESUPUESTO_071,
				IND_OBSERVACIONES_053 as IND_OBSERVACIONES_071
				from aa79b53t00 where ANYO_053 = R_EXP_R75.ANYO_051 and NUM_EXP_053= R_EXP_R75.NUM_EXP_051;
    		END IF;
    		-- documentos
    		Insert into AA79B73T00 (ANYO_073,CLASE_DOCUMENTO_073,CONTENT_TYPE_073,DIRECCION_CONTACTO_073,EMAIL_CONTACTO_073,ENTIDAD_CONTACTO_073,EXTENSION_DOC_073,FECHA_ALTA_073,ID_DOC_REL_073,	
			ID_DOC_073,IND_ENCRIPTADO_073,NOMBRE_FICHERO_073,NUM_EXP_073,NUM_PAL_SOLIC_073,OID_FICHERO_073,PERSONA_CONTACTO_073,TAMANO_DOC_073,TELEFONO_CONTACTO_073,	
			TIPO_DOCUMENTO_073,TITULO_073) SELECT 
			ANYO_056, CLASE_DOCUMENTO_056,CONTENT_TYPE_056,DIRECCION_CONTACTO_056,EMAIL_CONTACTO_056,ENTIDAD_CONTACTO_056,EXTENSION_DOC_056,FECHA_ALTA_056,ID_DOC_REL_056,	
			ID_DOC_056,IND_ENCRIPTADO_056,NOMBRE_FICHERO_056,NUM_EXP_056,NUM_PAL_SOLIC_056,OID_FICHERO_056,PERSONA_CONTACTO_056,TAMANO_DOC_056,TELEFONO_CONTACTO_056,	
			TIPO_DOCUMENTO_056,TITULO_056 from AA79B56T00 where ANYO_056 = R_EXP_R75.ANYO_051 and NUM_EXP_056= R_EXP_R75.NUM_EXP_051;
    		
    	END IF;
    	
    	-- BITACORA ACTUALIZAR
		
		update AA79B51T00 set ESTADO_BITACORA_051 = ID_BITACORA WHERE NUM_EXP_051 = R_EXP_R75.NUM_EXP_051 AND ANYO_051= R_EXP_R75.ANYO_051 ; 
		-- Bitacora solicitante
		
		DELETE ERRORES_MIG WHERE ANYO_EXP = ANYO_ACTUAL AND NUM_EXP = NUM_EXP_ACTUAL;
		
		COMMIT;
		EXCEPTION  -- exception handlers begin
      	WHEN OTHERS THEN  -- handles all other errors
      	ROLLBACK;
      	error_code := SQLCODE;
      	err_msg := SUBSTR(SQLERRM, 1, 4000);

      	select count(1) into contador from ERRORES_MIG WHERE ANYO_EXP = ANYO_ACTUAL AND NUM_EXP = NUM_EXP_ACTUAL;
      	if (contador > 0) THEN
      		update ERRORES_MIG set ERROR_DET = DBMS_UTILITY.format_error_backtrace || '->' || err_msg, FECHA = sysdate WHERE ANYO_EXP = ANYO_ACTUAL AND NUM_EXP = NUM_EXP_ACTUAL;
      	ELSE
      		insert into ERRORES_MIG (ANYO_EXP, NUM_EXP, ERROR_DET, FECHA) values (ANYO_ACTUAL, NUM_EXP_ACTUAL, DBMS_UTILITY.format_error_backtrace || '->' || err_msg, sysdate);
      	END IF;
      	COMMIT;
      	
       --dbms_output.put_line('ERROR.' || ANYO_ACTUAL || '-' || NUM_EXP_ACTUAL);
       
       
      END;
		
    END LOOP;
    
   EXCEPTION  -- exception handlers begin
      WHEN OTHERS THEN  -- handles all other errors
       --dbms_output.put_line('ERROR.');
       ROLLBACK;
          
    
END;
/

ALTER TABLE AA79B51T00 ADD CONSTRAINT AA79B59T00_51_FK FOREIGN KEY (ANYO_051, NUM_EXP_051, ESTADO_BITACORA_051) REFERENCES AA79B59T00 (ANYO_059, NUM_EXP_059, ID_ESTADO_BITACORA_059);
ALTER TABLE AA79B59T00 ADD CONSTRAINT AA79B64T00_59_FK FOREIGN KEY (ID_REQUERIMIENTO_059) REFERENCES AA79B64T00 (ID_064);
ALTER TABLE AA79B92T00 ADD CONSTRAINT AA79B88T00_92_FK FOREIGN KEY (ID_FICHERO_FINAL_092) REFERENCES AA79B88T00 (ID_FICHERO_088);
ALTER TABLE AA79B90T00 ADD CONSTRAINT AA79B88T00_90_FK FOREIGN KEY (ID_FICHERO_TRADOS_090) REFERENCES AA79B88T00 (ID_FICHERO_088);
ALTER TABLE AA79B87T00 ADD CONSTRAINT AA79B88T00_87_FK FOREIGN KEY (ID_FICHERO_TRADUCIDO_087) REFERENCES AA79B88T00 (ID_FICHERO_088);
ALTER TABLE AA79B96T00 ADD CONSTRAINT AA79B88T00_96_FK FOREIGN KEY (ID_FICHERO_XLIFF_096) REFERENCES AA79B88T00 (ID_FICHERO_088);
ALTER TABLE AA79B93T00 ADD CONSTRAINT AA79B88T00_93_FK FOREIGN KEY (ID_FICHERO_JUSTIFICANTE_093) REFERENCES AA79B88T00 (ID_FICHERO_088);
ALTER TABLE AA79B59T00 ADD CONSTRAINT AA79B67T00_59_FK FOREIGN KEY (ID_RECHAZO_059) REFERENCES AA79B67T00 (ID_067);
/
