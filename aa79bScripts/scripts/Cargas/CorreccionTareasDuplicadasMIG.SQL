ALTER TABLE AA79B51T00 DROP CONSTRAINT AA79B59T00_51_FK;
ALTER TABLE AA79B59T00 DROP CONSTRAINT AA79B64T00_59_FK;
ALTER TABLE AA79B92T00 DROP CONSTRAINT AA79B88T00_92_FK;
ALTER TABLE AA79B90T00 DROP CONSTRAINT AA79B88T00_90_FK;
ALTER TABLE AA79B87T00 DROP CONSTRAINT AA79B88T00_87_FK;
ALTER TABLE AA79B96T00 DROP CONSTRAINT AA79B88T00_96_FK;
ALTER TABLE AA79B93T00 DROP CONSTRAINT AA79B88T00_93_FK;
ALTER TABLE AA79B59T00 DROP CONSTRAINT AA79B67T00_59_FK;
/

DECLARE

ANYO_AUX NUMBER(4):= '&1';
NUM_AUX NUMBER(6):= '&2';

error_code NUMBER;
err_msg VARCHAR2(4000);

CURSOR C_EXP_R75 is(
SELECT t30_anyo                                                                                      AS ANYO_051,
  t30_N_EXP                                                                                          AS NUM_EXP_051,
  DECODE(T30_COD_TIPO_EXP,'2','R','3','T','4','I') AS ID_TIPO_EXPEDIENTE_051,
  DECODE(t30_VIA_WEB,'1','S','0','O','3','W')                AS ORIGEN_051,
  T30_FEC_SOLI                                                                                       AS FECHA_ALTA_051,
  replace(replace(SUBSTR(T30_DESC,1,149),chr(10),''),chr(13),'')                                     AS TITULO_051,
  T30_DESC AS DESC_R75_051,
  T30_PPTO AS IND_PRESUPUESTO,
  T30_FACTURABLE AS IND_FACTURABLE,
  T30_OBSERV_IZO AS OBSERVACIONES,
  T30_FEC_FIN AS FECHA_ENTREGA,
  T30_COD_APLIC_ORIG as APLIC_ORIGEN, 
  T30_NUM_FAC as NUM_FACTURA,
  T30_ANYO_FAC as ANYO_FACTURA
FROM r75b.r7530t00
JOIN r75b.r7521t00 ON
t30_cod_solicitante=t21_cod_solicitante and T30_COD_CONT_SOLI=T21_COD_CONT_SOLI
JOIN r75b.r7519t00 ON 
t21_cod_solicitante=t19_cod_solicitante
LEFT JOIN r75b.r7532t00 ON 
t30_anyo = t32_anyo and t30_N_EXP=t32_N_EXP AND T30_FASE=T32_FASE
LEFT JOIN (select t39_anyo, t39_N_EXP, T39_TOT_PAL, T39_COD_TIPO_DOCUMENTO from r75b.r7539t00 where t39_anyo||'@'||t39_N_EXP||'@'||t39_FASE  in (select  t39_anyo||'@'||t39_N_EXP||'@'||max(t39_FASE) from r75b.r7539t00 group by T39_anyo,t39_N_EXP)) t39 ON
t30_anyo = t39.t39_anyo and t30_N_EXP=t39.t39_N_EXP
WHERE 
t30_fase = 5
and T30_FEC_RENUN IS NULL and T30_ANYO_AA79B is null and T30_N_EXP_AA79B is null
/**
 * Modificar a partir de aqui, para obtener los expedientes deseados
 */
AND ((T30_COD_TIPO_EXP =3 AND T30_ANYO>=2012 AND T30_ANYO <=2018 AND T19_COD_TIPO_SOLICITANTE not in (8, 9)
AND (
	(T30_COD_SOLICITANTE = 1012 AND t39.T39_TOT_PAL >=1000)
	OR (T30_COD_SOLICITANTE = 533 AND T32_BOPV = 0) 
	OR (T30_COD_SOLICITANTE = 3 AND T21_DPTO <> 'Hautaketa' AND t39.T39_COD_TIPO_DOCUMENTO <> 21)
	OR (T30_COD_SOLICITANTE not in (3,533,1012)  AND ( t39.T39_COD_TIPO_DOCUMENTO IN (1,54,44)   OR (t39.T39_COD_TIPO_DOCUMENTO not in (1, 54, 44, 38, 59)  AND t39.T39_TOT_PAL >=1000)))
)
)
OR (T30_COD_TIPO_EXP =4 AND T30_ANYO =2018)
OR (T30_ANYO =2019))
/**
* Para filtrar por un expediente concreto con variables pasadas
*/
AND 
 1 = (
 CASE WHEN ANYO_AUX <> '0' AND T30_ANYO = ANYO_AUX THEN 1  
 ELSE CASE WHEN ANYO_AUX = '0' THEN 1 
 ELSE 0 END END
 )
AND 
1 = (
 CASE WHEN NUM_AUX <> '0' AND t30_N_EXP = NUM_AUX THEN 1  
 ELSE CASE WHEN NUM_AUX = '0' THEN 1 
 ELSE 0 END END
 )
)ORDER BY 1,2,3 DESC;
  
HORAS_INTERPRETACION_ACUM VARCHAR2(150);

ID_BITACORA NUMBER(2):= 0;
ID_DIR_NORA NUMBER(8);
ID_DOCU_NUEVO NUMBER(20);
ID_TAREA_NUEVO NUMBER(20);
ID_TAREA_ANTERIOR NUMBER(20);
ID_NUEVO_FICHERO_FINAL NUMBER(20);
ID_FICHERO_USADO VARCHAR2(1):= 'S';
ID_CONT_FACT NUMBER(10);

NUM_EXP_ACTUAL NUMBER(6);
ANYO_ACTUAL NUMBER(4);
ID_ORDEN NUMBER(4);
CONTADOR NUMBER(1):= 0;
POR_EUSKERA NUMBER(3);
QUERY_DOCUS VARCHAR2(4000);
ORDEN_TAREA NUMBER(2):= 0;

IMPORTE_ENTIDAD        NUMBER(9,2):=0.0;
IMPORTE_BASE_ENTIDAD   NUMBER(8,2):=0.0;
IMPORTE_IVA_ENTIDAD    NUMBER(8,2):=0.0;
IMPORTE_DIFICULTAD_ENT NUMBER(8,2):=0.0;
IMPORTE_URGENCIA_ENT   NUMBER(8,2):=0.0;

-- NUMEROS DE PALABRAS PARA CADA ENTIDAD
NUM_TOTAL_PAL_FACTURAR_ENT NUMBER(6);
NUM_PAL_CONCOR_0_84_ENT    NUMBER(6);
NUM_PAL_CONCOR_85_94_ENT   NUMBER(6);
NUM_PAL_CONCOR_95_100_ENT  NUMBER(6);

REFERENCIA_PAGO VARCHAR2(13);
FECHA_EMISION DATE;
ID_FACTURA NUMBER(10);


BEGIN
	
	FOR R_EXP_R75 IN C_EXP_R75
    LOOP
    	BEGIN
      	NUM_EXP_ACTUAL := R_EXP_R75.NUM_EXP_051;
     	ANYO_ACTUAL:= R_EXP_R75.ANYO_051;
    	ID_BITACORA:= 1;
    	ORDEN_TAREA:=1;
    	
 		SELECT count(1) INTO CONTADOR FROM AA79B51T00 WHERE  ANYO_051 =  R_EXP_R75.ANYO_051 AND NUM_EXP_051 = R_EXP_R75.NUM_EXP_051;
 		IF (CONTADOR > 0) THEN
    	-- CORREGIMOS LAS DUPLICADAS 
	    	IF (R_EXP_R75.ID_TIPO_EXPEDIENTE_051 = 'T') THEN
	    			SELECT count(*) into CONTADOR FROM AA79B81T00 WHERE ANYO_081 =  R_EXP_R75.ANYO_051 AND NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ID_TIPO_TAREA_081 = 11;
	    			IF (CONTADOR = 2) THEN
	    				SELECT ID_TAREA_081 into ID_TAREA_NUEVO FROM AA79B81T00 WHERE ANYO_081 =  R_EXP_R75.ANYO_051 AND NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ID_TIPO_TAREA_081 = 11 
						AND ORDEN_081 = (SELECT MIN(ORDEN_081) FROM AA79B81T00 WHERE ANYO_081 =  R_EXP_R75.ANYO_051 AND NUM_EXP_081 = R_EXP_R75.NUM_EXP_051 AND ID_TIPO_TAREA_081 = 11);
	    			
						UPDATE AA79B81T00 set ID_TIPO_TAREA_081 = 21 WHERE 	ID_TAREA_081 = ID_TAREA_NUEVO;
					END IF;
	    			
	    	END IF;
    	END IF;
    	
		DELETE ERRORES_MIG WHERE ANYO_EXP = ANYO_ACTUAL AND NUM_EXP = NUM_EXP_ACTUAL;
		
		COMMIT;
		EXCEPTION  -- exception handlers begin
      	WHEN OTHERS THEN  -- handles all other errors
      	ROLLBACK;
      	error_code := SQLCODE;
      	err_msg := SUBSTR(SQLERRM, 1, 4000);

      	select count(1) into contador from ERRORES_MIG WHERE ANYO_EXP = ANYO_ACTUAL AND NUM_EXP = NUM_EXP_ACTUAL;
      	if (contador > 0) THEN
      		update ERRORES_MIG set ERROR_DET = DBMS_UTILITY.format_error_backtrace || '->' || err_msg, FECHA = sysdate WHERE ANYO_EXP = ANYO_ACTUAL AND NUM_EXP = NUM_EXP_ACTUAL;
      	ELSE
      		insert into ERRORES_MIG (ANYO_EXP, NUM_EXP, ERROR_DET, FECHA) values (ANYO_ACTUAL, NUM_EXP_ACTUAL, DBMS_UTILITY.format_error_backtrace || '->' || err_msg, sysdate);
      	END IF;
      	COMMIT;
      	
       --dbms_output.put_line('ERROR.' || ANYO_ACTUAL || '-' || NUM_EXP_ACTUAL);
       
       
      END;
		
    END LOOP;
    
   
    
    
    
   EXCEPTION  -- exception handlers begin
      WHEN OTHERS THEN  -- handles all other errors
       --dbms_output.put_line('ERROR.');
       ROLLBACK;
          
    
END;
/

ALTER TABLE AA79B51T00 ADD CONSTRAINT AA79B59T00_51_FK FOREIGN KEY (ANYO_051, NUM_EXP_051, ESTADO_BITACORA_051) REFERENCES AA79B59T00 (ANYO_059, NUM_EXP_059, ID_ESTADO_BITACORA_059);
ALTER TABLE AA79B59T00 ADD CONSTRAINT AA79B64T00_59_FK FOREIGN KEY (ID_REQUERIMIENTO_059) REFERENCES AA79B64T00 (ID_064);
ALTER TABLE AA79B92T00 ADD CONSTRAINT AA79B88T00_92_FK FOREIGN KEY (ID_FICHERO_FINAL_092) REFERENCES AA79B88T00 (ID_FICHERO_088);
ALTER TABLE AA79B90T00 ADD CONSTRAINT AA79B88T00_90_FK FOREIGN KEY (ID_FICHERO_TRADOS_090) REFERENCES AA79B88T00 (ID_FICHERO_088);
ALTER TABLE AA79B87T00 ADD CONSTRAINT AA79B88T00_87_FK FOREIGN KEY (ID_FICHERO_TRADUCIDO_087) REFERENCES AA79B88T00 (ID_FICHERO_088);
ALTER TABLE AA79B96T00 ADD CONSTRAINT AA79B88T00_96_FK FOREIGN KEY (ID_FICHERO_XLIFF_096) REFERENCES AA79B88T00 (ID_FICHERO_088);
ALTER TABLE AA79B93T00 ADD CONSTRAINT AA79B88T00_93_FK FOREIGN KEY (ID_FICHERO_JUSTIFICANTE_093) REFERENCES AA79B88T00 (ID_FICHERO_088);
ALTER TABLE AA79B59T00 ADD CONSTRAINT AA79B67T00_59_FK FOREIGN KEY (ID_RECHAZO_059) REFERENCES AA79B67T00 (ID_067);
/
