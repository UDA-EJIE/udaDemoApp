DECLARE

error_code NUMBER;
err_msg VARCHAR2(4000);

CURSOR C_EXP_R75 is(
SELECT ANYO_EXP AS ANYO_051,
  NUM_EXP AS NUM_EXP_051
FROM CORRECCIONES_MIG
)ORDER BY 1,2 DESC;
  
ID_TAREA_NUEVO NUMBER(20);

NUM_EXP_ACTUAL NUMBER(6);
ANYO_ACTUAL NUMBER(4);
CONTADOR NUMBER(1):= 0;

BEGIN
	
	FOR R_EXP_R75 IN C_EXP_R75
    LOOP
    	BEGIN
      	NUM_EXP_ACTUAL := R_EXP_R75.NUM_EXP_051;
     	ANYO_ACTUAL:= R_EXP_R75.ANYO_051;
    	
 		SELECT count(1) INTO CONTADOR FROM AA79B51T00 WHERE  ANYO_051 =  ANYO_ACTUAL AND NUM_EXP_051 = NUM_EXP_ACTUAL;
 		IF (CONTADOR > 0) THEN
    	-- CORREGIMOS LAS DUPLICADAS 
	    			SELECT count(*) into CONTADOR FROM AA79B81T00 WHERE ANYO_081 =  ANYO_ACTUAL AND NUM_EXP_081 = NUM_EXP_ACTUAL AND ID_TIPO_TAREA_081 = 11;
	    			IF (CONTADOR = 2) THEN
	    				SELECT ID_TAREA_081 into ID_TAREA_NUEVO FROM AA79B81T00 WHERE ANYO_081 =  ANYO_ACTUAL AND NUM_EXP_081 = NUM_EXP_ACTUAL AND ID_TIPO_TAREA_081 = 11 
						AND ORDEN_081 = (SELECT MIN(ORDEN_081) FROM AA79B81T00 WHERE ANYO_081 =  ANYO_ACTUAL AND NUM_EXP_081 = NUM_EXP_ACTUAL AND ID_TIPO_TAREA_081 = 11);
	    			
						UPDATE AA79B81T00 set ID_TIPO_TAREA_081 = 21 WHERE 	ID_TAREA_081 = ID_TAREA_NUEVO;
					END IF;
    	END IF;
    	
		DELETE ERRORES_MIG WHERE ANYO_EXP = ANYO_ACTUAL AND NUM_EXP = NUM_EXP_ACTUAL;
		
		COMMIT;
		EXCEPTION  -- exception handlers begin
      	WHEN OTHERS THEN  -- handles all other errors
      	ROLLBACK;
      	error_code := SQLCODE;
      	err_msg := SUBSTR(SQLERRM, 1, 4000);

      	select count(1) into contador from ERRORES_MIG WHERE ANYO_EXP = ANYO_ACTUAL AND NUM_EXP = NUM_EXP_ACTUAL;
      	if (contador > 0) THEN
      		update ERRORES_MIG set ERROR_DET = DBMS_UTILITY.format_error_backtrace || '->' || err_msg, FECHA = sysdate WHERE ANYO_EXP = ANYO_ACTUAL AND NUM_EXP = NUM_EXP_ACTUAL;
      	ELSE
      		insert into ERRORES_MIG (ANYO_EXP, NUM_EXP, ERROR_DET, FECHA) values (ANYO_ACTUAL, NUM_EXP_ACTUAL, DBMS_UTILITY.format_error_backtrace || '->' || err_msg, sysdate);
      	END IF;
      	COMMIT;
      	
      END;
		
    END LOOP;
 
   EXCEPTION  -- exception handlers begin
      WHEN OTHERS THEN  -- handles all other errors
       --dbms_output.put_line('ERROR.');
       ROLLBACK;   
    
END;
/