-- ELIMINAR TABLA Y SINONIMO DE DOCUMENTOS DE SECCION C5 

CREATE OR REPLACE VIEW INF_SITUACION_TRAD_REV ( 
URTEA, ESPEDIENTEA, ESPEDIENTE_MOTA, HIZKUNTZA_XEDEA, ESKATZAILEA, 
ESKATZAILE_MOTA, ESKATZAILE_HARREMANETARAKO, ESKATZAILE_HARREMANETARAKO_NAN,
ATAZA, NORI_ESLEITUA_ZENBAKIA, NORI_ESLEITUA, ESKAERA_DATA, AMAIERA_DATA, 
HITZ_KOPURUA_BEZEROA, HITZ_KOPURUA_IZO, 
TRADOS_EXPEDIENTE_0_84,
TRADOS_EXPEDIENTE_85_94,
TRADOS_EXPEDIENTE_95_100,
TRADOS_TAREA_0_84,
TRADOS_TAREA_85_94,
TRADOS_TAREA_95_100,
TARIFA_HITZAK, 
AURREKUSITAKO_DATA, EGIKARATZE_DATA, BENETAKO_ENTREGA_DATA, AMAITUTA, ITZULPEN_MOTA, ITZULPEN_MOTA_0, 
DIRU_SARRERA, BEZ, ZENBATEKOA_BEZ_BARNE, ATAZAREN_KODEA, BAZTERTUTA, 
BAZTERTZEKO_ARRAZOIA, EZEZTATUTA, EZEZTATZEKO_ARRAZOIA, KALITATE_PENALIZAZIOA, KALITATE_ZENBATEKOA)
AS 
SELECT 
ANYO_051, NUM_EXP_051, DECODE(ID_TIPO_EXPEDIENTE_051, 'T', 'ITZULPENA', 'BERRIKUSKETA'), DESC_IDIOMA_EU_009, nvl(DESC_EU, DESC_ES), TIPO,
TRIM(t71solici.APEL1_077) || ' ' || TRIM(t71solici.APEL2_077) || ', ' || TRIM(t71solici.NOMBRE_077) ,(t71solici.PREDNI_077 ||t71solici.DNI_077 || t71solici.SUFDNI_077),
DESC_EU_015,
DECODE(TAREA.DNI_RECURSO_081, null, TO_CHAR(ID_LOTE_029), (t71recurso.PREDNI_077 ||t71recurso.DNI_077 || t71recurso.SUFDNI_077)),
DECODE(TAREA.DNI_RECURSO_081, null, DESC_LOTE_EU_029, TRIM(t71recurso.APEL1_077) || ' ' || TRIM(t71recurso.APEL2_077) || ', ' || TRIM(t71recurso.NOMBRE_077)), 
FECHA_ALTA_051, FECHA_FINAL_IZO_053, 
tDocs.NUM_PAL_SOLIC,
tDocs.NUM_PAL_IZO,
NUM_PAL_CONCOR_0_84_090,
NUM_PAL_CONCOR_85_94_090,
NUM_PAL_CONCOR_95_100_090,
tDocs.NUM_PAL_CONCOR_0_84,
tDocs.NUM_PAL_CONCOR_85_94,
tDocs.NUM_PAL_CONCOR_95_100,
TARIFA_PAL_097,
TAREA.FECHA_FIN_081, 
EJECUCION_TAREA.FECHA_EJECUCION_082,
FECHA_ENTREGA_REAL_053,
DECODE(TAREA.ESTADO_EJECUCION_081, 3, 'Bai', 'Ez'),
tDocs.DOCS,
DESC_RELEVANCIA_EU_010,
IMPORTE_BASE_097, POR_IVA_097, IMPORTE_TOTAL_097, TAREA.ID_TAREA_081,
DECODE(ID_RECHAZO_059, null, 'Ez', 'Bai'),
DECODE(ID_RECHAZO_059, null, '-', (DESC_EU_013)),
DECODE(ID_ANULACION_059, null, 'Ez', 'Bai'),
DECODE(ID_ANULACION_059, null, '-', (DESC_EU_012)),
CASE WHEN PAGOPROV.NIVEL_CALIDAD_094 is not null then
'>=' || NVL(CALIDAD.RANGO_INI_CALIDAD_0B5,0) || ' - < ' || NVL(CALIDAD.RANGO_FIN_CALIDAD_0B5,0) || ' Penalizazioa: ' || PAGOPROV.POR_PENAL_CALIDAD_094 || '%'
ELSE null END AS PENALIZACION_CALIDAD, 
IMP_PENAL_CALIDAD_094 AS IMP_PENALIZACION_CALIDAD
FROM AA79B51T00 
LEFT JOIN AA79B81T00 TAREA ON TAREA.ANYO_081 = ANYO_051 AND TAREA.NUM_EXP_081 = NUM_EXP_051
LEFT JOIN AA79B82T00 EJECUCION_TAREA ON EJECUCION_TAREA.ID_TAREA_082 = TAREA.ID_TAREA_081
JOIN AA79B54T00 ON ANYO_051 = ANYO_054 AND NUM_EXP_051 = NUM_EXP_054
JOIN X54JAPI_ENTIDADES_SOLIC ON TIPO =  TIPO_ENTIDAD_054 AND CODIGO = ID_ENTIDAD_054
JOIN AA79B77T00 t71solici ON t71solici.DNI_077 = DNI_SOLICITANTE_054
LEFT JOIN AA79B15T00 ON TAREA.ID_TIPO_TAREA_081 = ID_015
LEFT JOIN AA79B77T00 t71recurso ON t71recurso.DNI_077 = TAREA.DNI_RECURSO_081
LEFT JOIN AA79B29T00 ON ID_LOTE_029 = TAREA.ID_LOTE_081
JOIN AA79B53T00 ON ANYO_051 = ANYO_053 AND NUM_EXP_051 = NUM_EXP_053
LEFT JOIN AA79B97T00 ON ANYO_051 = ANYO_097 AND NUM_EXP_051 = NUM_EXP_097
JOIN AA79B59T00 ON NUM_EXP_051 = NUM_EXP_059 AND ANYO_051 = ANYO_059 AND ESTADO_BITACORA_051 = ID_ESTADO_BITACORA_059
LEFT JOIN AA79B67T00 ON ID_RECHAZO_059 = ID_067
LEFT JOIN AA79B68T00 ON ID_067 = ID_068
LEFT JOIN AA79B13T00 ON ID_MOTIVO_RECHAZO_067 = ID_013
LEFT JOIN AA79BA1T00 ON ID_ANULACION_059 = ID_0A1
LEFT JOIN AA79BA2T00 ON ID_0A1 = ID_0A2
LEFT JOIN AA79B12T00 ON ID_MOTIVO_ANULACION_0A1 = ID_012
LEFT JOIN AA79B09T00 ON ID_IDIOMA_009 = ID_IDIOMA_053
LEFT JOIN 
(SELECT ID_TAREA_083, SUM(NUM_PAL_SOLIC_056) NUM_PAL_SOLIC, 
SUM(NUM_PAL_IZO_056)  AS NUM_PAL_IZO , 
SUM(NUM_PAL_CONCOR_0_84_091) AS NUM_PAL_CONCOR_0_84, SUM(NUM_PAL_CONCOR_85_94_091) AS NUM_PAL_CONCOR_85_94, SUM(NUM_PAL_CONCOR_95_100_091) as NUM_PAL_CONCOR_95_100, 
LISTAGG(DESC_EU_042 , ', ') WITHIN GROUP (ORDER BY DESC_EU_042) AS DOCS
FROM AA79B83T00 
JOIN AA79B56T00 ON ID_DOC_083 = ID_DOC_056 JOIN AA79B42T00 ON TIPO_DOCUMENTO_056 = ID_042
JOIN AA79B81T00 TAREADOCU ON TAREADOCU.ID_TAREA_081 = ID_TAREA_083
LEFT JOIN AA79B81T00 TRADOSTAREA ON TRADOSTAREA.ANYO_081 = TAREADOCU.ANYO_081 AND TRADOSTAREA.NUM_EXP_081 = TAREADOCU.NUM_EXP_081 AND TRADOSTAREA.ID_TIPO_TAREA_081 = 1
LEFT JOIN AA79B91T00 ON TRADOSTAREA.ID_TAREA_081 = ID_TAREA_091 AND ID_DOC_ORIG_091 = ID_DOC_056
 GROUP BY ID_TAREA_083) tDocs ON tDocs.ID_TAREA_083 = TAREA.ID_TAREA_081
LEFT JOIN AA79B10T00 ON ID_TIPO_RELEVANCIA_010 = ID_RELEVANCIA_053
LEFT JOIN AA79B81T00 TRADOS ON TRADOS.ANYO_081 = ANYO_051 AND TRADOS.NUM_EXP_081 = NUM_EXP_051 AND TRADOS.ID_TIPO_TAREA_081 = 1
LEFT JOIN AA79B90T00 ON TRADOS.ID_TAREA_081 = ID_TAREA_090
LEFT JOIN AA79B81T00 TAREAPAGOPROV ON TAREAPAGOPROV.ANYO_081 = ANYO_051 AND TAREAPAGOPROV.NUM_EXP_081 = NUM_EXP_051 AND TAREAPAGOPROV.ID_TIPO_TAREA_081 = 11 
AND TAREAPAGOPROV.id_tarea_rel_081 = TAREA.ID_TAREA_081 AND tareapagoprov.estado_ejecucion_081 = 3
LEFT JOIN AA79B94T00 PAGOPROV ON PAGOPROV.ID_TAREA_094 = TAREAPAGOPROV.ID_TAREA_081
LEFT JOIN AA79BB5T00 CALIDAD ON pagoprov.nivel_calidad_094 = calidad.nivel_0b5 and estado_0b5 = 'A'
WHERE ID_TIPO_EXPEDIENTE_051 in ('T', 'R');
/

--En la tabla AA79B02T00.

ALTER TABLE AA79B02T00 RENAME COLUMN PAL_HORA_CONCOR_95_99_002 TO PAL_HORA_CONCOR_95_100_002; 

ALTER TABLE AA79B02T00 DROP COLUMN PAL_HORA_CONCOR_100_002;

ALTER TABLE AA79B02T00 RENAME COLUMN PAL_SEG_CONCOR_95_99_002 TO PAL_SEG_CONCOR_95_100_002; 

ALTER TABLE AA79B02T00 DROP COLUMN PAL_SEG_CONCOR_100_002;



--En la tabla AA79B45T00.

ALTER TABLE AA79B45T00 RENAME COLUMN PAL_HORA_CONCOR_95_99_045 TO PAL_HORA_CONCOR_95_100_045; 

ALTER TABLE AA79B45T00 DROP COLUMN PAL_HORA_CONCOR_100_045;


ALTER TABLE AA79B45T00 RENAME COLUMN PAL_SEG_CONCOR_95_99_045 TO PAL_SEG_CONCOR_95_100_045; 

ALTER TABLE AA79B45T00 DROP COLUMN PAL_SEG_CONCOR_100_045;

--Tabla AA79B90T00

ALTER TABLE AA79B90T00 DROP COLUMN NUM_PAL_CONCOR_95_99_090;
ALTER TABLE AA79B90T00 DROP COLUMN NUM_PAL_CONCOR_100_090;

--Tabla AA79B91T00

ALTER TABLE AA79B91T00 DROP COLUMN NUM_PAL_CONCOR_95_99_091;
ALTER TABLE AA79B91T00 DROP COLUMN NUM_PAL_CONCOR_100_091;


--Modificar la tabla AA79B56T00 para poder contemplar los nuevos rangos, pero en este caso vamos a mantener los anteriores.

ALTER TABLE AA79B56T00 DROP COLUMN NUM_PAL_CONCOR_95_99_056;
ALTER TABLE AA79B56T00 DROP COLUMN NUM_PAL_CONCOR_100_056;

/

set serveroutput on
create or replace FUNCTION OBTENER_ESTUDIO(
      TIPO_TAREA     IN NUMBER,
      FECHA_INI      IN DATE,
      FECHA_FIN      IN DATE,
      NUM_PALABRAS   IN NUMBER,
      NUM_PAL_0_84   IN NUMBER,
      NUM_PAL_85_94  IN NUMBER,
      NUM_PAL_95_100 IN NUMBER,
      ID_TIPO_RELEVANCIA IN NUMBER,
      NIV_USUARIO IN VARCHAR2)
    RETURN ESTUDIO_TABLE
  IS
    l_estudio ESTUDIO_TABLE := ESTUDIO_TABLE();
    HORARIO_INVIERNO AA79B39S01%ROWTYPE;
    HORARIO_VERANO AA79B39S01%ROWTYPE;
    HORARIO AA79B39S01%ROWTYPE;
    ID_HORARIO NUMBER(2)   :=1;
    HORAS_ACUM NUMBER(12,2):=0;
    DIA_SEL DATE;
    DIA_PROC DATE;
    DIA_FIN DATE;
    DIA_SEMANA_SEL NUMBER(1);
    LIMPALCONFIG_INTERNA AA79B02S02%ROWTYPE;
    CONFIG_INTERNA AA79B02S01%ROWTYPE;
    LIMPALCONFIG_EXTERNA AA79B45S02%ROWTYPE;
    CONFIG_EXTERNA AA79B45S01%ROWTYPE;
    CONTADOR      NUMBER(2)  := 0;
    HORAS_TRABAJO NUMBER(5,2):= 0.0;
    NUM_RECURSOS  NUMBER(3)  := 0;
    DIAS_REALES   NUMBER(5)  := 0;
    TRADUCCION    NUMBER(2)  := 2;
    REVISION      NUMBER(2)  := 4 ;
    -- obtenemos los dias entre 2 fechas y indicando si son en verano o no
  BEGIN
    -- OBTENEMOS LOS HORARIOS DE VERANO Y DE INVIERNO
    SELECT *
    INTO HORARIO_VERANO
    FROM AA79B39S01
    WHERE ID_HORARIO_039=ID_HORARIO
    AND IND_VERANO_039  = 'V';
    SELECT *
    INTO HORARIO_INVIERNO
    FROM AA79B39S01
    WHERE ID_HORARIO_039                                         =ID_HORARIO
    AND IND_VERANO_039                                           = 'I';
    DIA_FIN                                                     := to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD'),'YYYY/MM/DD');
    DIA_PROC                                                    := FECHA_INI;
    HORAS_ACUM                                                  := 0.0;
    WHILE (to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD'),'YYYY/MM/DD') <= to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD'),'YYYY/MM/DD'))
    LOOP
      DIA_SEL        := to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD'),'YYYY/MM/DD');
      DIA_SEMANA_SEL := MOD(TO_CHAR(DIA_PROC, 'J'), 7)+1;
      -- COMPROBAMOS QUE NO SEA FIN DE SEMANA
      IF (DIA_SEMANA_SEL < 6) THEN
        --  COMPROBAMOS QUE NO SEA FESTIVO
        SELECT COUNT(1)
        INTO CONTADOR
        FROM AA79B23S01
        WHERE DIA_CALENDARIO_023 = DIA_SEL;
        IF (CONTADOR             = 0) THEN
          -- COMPROBAMOS SI ES UN DIA DE VERANO O DE INVIERNO.
          SELECT COUNT(1)
          INTO CONTADOR
          FROM AA79B22S01
          WHERE ANYO_CALENDARIO_022 = TO_CHAR(DIA_SEL,'YYYY')
          AND VERANO_DESDE_022     <= DIA_SEL
          AND VERANO_HASTA_022     >= DIA_SEL;
          IF (CONTADOR              = 1) THEN
            -- ES VERANO
            HORARIO:=HORARIO_VERANO;
          ELSE
            HORARIO:=HORARIO_INVIERNO;
          END IF;
          -- RECUPERAMOS LAS HORAS DISPONIBLES EN ESE DIA
          IF (DIA_SEL          = DIA_FIN) THEN
            IF (DIA_SEMANA_SEL = 5) THEN
              -- ES VIERNES
              IF (DIA_PROC       < to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_V_M_039, 'YYYY/MM/DD hh24:mi')) THEN
                IF (FECHA_FIN    < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_V_M_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +0.0;
                  DIAS_REALES   := DIAS_REALES + 1;
              	ELSIF (FECHA_FIN    < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_M_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(FECHA_FIN - to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_V_M_039, 'YYYY/MM/DD hh24:mi'))),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                ELSIF (FECHA_FIN < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_V_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_M_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_V_M_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                ELSIF (FECHA_FIN < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_M_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_V_M_039,'08:00'), 'YYYY/MM/DD hh24:mi')))+(24 *(FECHA_FIN - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                ELSIF (FECHA_FIN > to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_M_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_V_M_039,'08:00'), 'YYYY/MM/DD hh24:mi')))+(24 *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                END IF;
              ELSIF (DIA_PROC    < to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_M_039, 'YYYY/MM/DD hh24:mi')) THEN
                IF (FECHA_FIN    < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_M_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(FECHA_FIN - DIA_PROC)),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                ELSIF (FECHA_FIN < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_V_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_M_039,'08:00'), 'YYYY/MM/DD hh24:mi') - DIA_PROC)),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                ELSIF (FECHA_FIN < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_M_039,'08:00'), 'YYYY/MM/DD hh24:mi') - DIA_PROC))+(24 *(FECHA_FIN - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                ELSIF (FECHA_FIN > to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_M_039,'08:00'), 'YYYY/MM/DD hh24:mi') - DIA_PROC))+(24 *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                END IF;
              ELSIF (DIA_PROC    < to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_V_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                IF (FECHA_FIN    < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_V_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +0.0;
                  DIAS_REALES   := DIAS_REALES + 1;
              	ELSIF (FECHA_FIN    < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(FECHA_FIN - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                ELSIF (FECHA_FIN > to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                END IF;
              ELSIF (DIA_PROC    < to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                IF (FECHA_FIN    < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(FECHA_FIN - DIA_PROC)),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                ELSIF (FECHA_FIN > to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - DIA_PROC)),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                END IF;
              END IF;
            ELSE
              IF (DIA_PROC       < to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_LJ_M_039, 'YYYY/MM/DD hh24:mi')) THEN
                IF (FECHA_FIN    < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_LJ_M_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +0.0;
                  DIAS_REALES   := DIAS_REALES + 1;
              	ELSIF (FECHA_FIN    < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_M_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(FECHA_FIN - to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_LJ_M_039, 'YYYY/MM/DD hh24:mi'))),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                ELSIF (FECHA_FIN < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_LJ_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_M_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_LJ_M_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                ELSIF (FECHA_FIN < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_M_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_LJ_M_039,'08:00'), 'YYYY/MM/DD hh24:mi')))+(24 *(FECHA_FIN - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                ELSIF (FECHA_FIN > to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_M_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_LJ_M_039,'08:00'), 'YYYY/MM/DD hh24:mi')))+(24 *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                END IF;
              ELSIF (DIA_PROC    < to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_M_039, 'YYYY/MM/DD hh24:mi')) THEN
                IF (FECHA_FIN    < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_M_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(FECHA_FIN - DIA_PROC)),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                ELSIF (FECHA_FIN < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_LJ_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_M_039,'08:00'), 'YYYY/MM/DD hh24:mi') - DIA_PROC)),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                ELSIF (FECHA_FIN < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_M_039,'08:00'), 'YYYY/MM/DD hh24:mi') - DIA_PROC))+(24 *(FECHA_FIN - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                ELSIF (FECHA_FIN > to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_M_039,'08:00'), 'YYYY/MM/DD hh24:mi') - DIA_PROC))+(24 *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                END IF;
              ELSIF (DIA_PROC    < to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_LJ_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                IF (FECHA_FIN    < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_LJ_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +0.0;
                  DIAS_REALES   := DIAS_REALES + 1;
              	ELSIF (FECHA_FIN    < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(FECHA_FIN - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                ELSIF (FECHA_FIN > to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                END IF;
              ELSIF (DIA_PROC    < to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                IF (FECHA_FIN    < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(FECHA_FIN - DIA_PROC)),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                ELSIF (FECHA_FIN > to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - DIA_PROC)),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                END IF;
              END IF;
            END IF;
          ELSE
            IF (DIA_SEMANA_SEL = 5) THEN
              -- ES VIERNES
              IF (DIA_PROC    < to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_V_M_039, 'YYYY/MM/DD hh24:mi')) THEN
                HORAS_ACUM   := ROUND((24   *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_M_039, 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||HORARIO.HORA_INI_V_M_039, ' YYYY/MM/DD hh24:mi')))+ (24 *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                DIAS_REALES  := DIAS_REALES + 1;
              ELSIF (DIA_PROC < to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_M_039, 'YYYY/MM/DD hh24:mi')) THEN
                HORAS_ACUM   := ROUND((24   *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_M_039, 'YYYY/MM/DD hh24:mi') - DIA_PROC))+ (24 *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                DIAS_REALES  := DIAS_REALES + 1;
              ELSIF (DIA_PROC < to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_V_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                HORAS_ACUM   := ROUND((24   *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                DIAS_REALES  := DIAS_REALES + 1;
              ELSIF (DIA_PROC < to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                HORAS_ACUM   := HORAS_ACUM  + ROUND((24 *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - DIA_PROC)),2);
                DIAS_REALES  := DIAS_REALES + 1;
              END IF;
            ELSE
              IF (DIA_PROC    < to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_LJ_M_039, 'YYYY/MM/DD hh24:mi')) THEN
                HORAS_ACUM   := ROUND((24   *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_M_039, 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||HORARIO.HORA_INI_LJ_M_039, ' YYYY/MM/DD hh24:mi')))+ (24 *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                DIAS_REALES  := DIAS_REALES + 1;
              ELSIF (DIA_PROC < to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_M_039, 'YYYY/MM/DD hh24:mi')) THEN
                HORAS_ACUM   := ROUND((24   *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_M_039, 'YYYY/MM/DD hh24:mi') - DIA_PROC))+ (24 *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                DIAS_REALES  := DIAS_REALES + 1;
              ELSIF (DIA_PROC < to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_LJ_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                HORAS_ACUM   := ROUND((24   *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                DIAS_REALES  := DIAS_REALES + 1;
              ELSIF (DIA_PROC < to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                HORAS_ACUM   := HORAS_ACUM  + ROUND((24 *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - DIA_PROC)),2);
                DIAS_REALES  := DIAS_REALES + 1;
              END IF;
            END IF;
          END IF;
        END IF;
      END IF;
      DIA_PROC           := DIA_SEL + 1;
    END LOOP;
    -- calculamos las horas necesarias para realizar el trabajo de manera interna o externa
    -- interna
    -- recuperamos de configuración general los datos correspondientes.
    BEGIN
      SELECT * INTO LIMPALCONFIG_INTERNA FROM AA79B02S02 WHERE ID_002 = 0;
      -- nivel usuario y tipo relevancia
      SELECT * INTO CONFIG_INTERNA FROM AA79B02S01 WHERE ID_002 = 0 AND NIVEL_USUARIO_002 = NIV_USUARIO AND ID_TIPO_RELEVANCIA_002  = ID_TIPO_RELEVANCIA;
      IF (TIPO_TAREA        = TRADUCCION) THEN
        IF (NUM_PALABRAS   >= LIMPALCONFIG_INTERNA.LIM_PAL_CONCOR_002) THEN
          HORAS_TRABAJO    := ROUND(NUM_PAL_0_84/CONFIG_INTERNA.PAL_HORA_CONCOR_0_84_002,2) + ROUND(NUM_PAL_85_94/CONFIG_INTERNA.PAL_HORA_CONCOR_85_94_002,2)+ ROUND(NUM_PAL_95_100/CONFIG_INTERNA.PAL_HORA_CONCOR_95_100_002,2);
          IF (HORAS_TRABAJO = 0) THEN
            HORAS_TRABAJO  := ROUND(NUM_PALABRAS/CONFIG_INTERNA.PAL_TRAD_HORA_002,2);
          END IF;
        ELSE
          HORAS_TRABAJO:= ROUND(NUM_PALABRAS/CONFIG_INTERNA.PAL_TRAD_HORA_002,2);
        END IF;
      ELSE
        HORAS_TRABAJO:= ROUND(NUM_PALABRAS/CONFIG_INTERNA.PAL_REV_HORA_002,2);
      END IF;
      NUM_RECURSOS:= CEIL(HORAS_TRABAJO/HORAS_ACUM);
      l_estudio.EXTEND;
      l_estudio(l_estudio.count) := (STRUCT_ESTUDIO('I', NUM_RECURSOS ,FORMAT_HORA_MINUTOS(HORAS_TRABAJO), FORMAT_HORA_MINUTOS(ROUND((HORAS_TRABAJO/DIAS_REALES)/NUM_RECURSOS,2)))) ;
      -- externa
      SELECT * INTO LIMPALCONFIG_EXTERNA FROM AA79B45S02 WHERE ID_045 = 0;
      --nivel de usuario
      SELECT * INTO CONFIG_EXTERNA FROM AA79B45S01 WHERE ID_045 = 0 AND NIVEL_USUARIO_045 = NIV_USUARIO;
      IF (TIPO_TAREA        = TRADUCCION) THEN
        IF (NUM_PALABRAS   >= LIMPALCONFIG_EXTERNA.LIM_PAL_CONCOR_045) THEN
          HORAS_TRABAJO    := ROUND(NUM_PAL_0_84/CONFIG_EXTERNA.PAL_HORA_CONCOR_0_84_045,2) + ROUND(NUM_PAL_85_94/CONFIG_EXTERNA.PAL_HORA_CONCOR_85_94_045,2)+ ROUND(NUM_PAL_95_100/CONFIG_EXTERNA.PAL_HORA_CONCOR_95_100_045,2);
          IF (HORAS_TRABAJO = 0) THEN
            HORAS_TRABAJO  := ROUND(NUM_PALABRAS/CONFIG_EXTERNA.PAL_TRAD_HORA_045,2);
          END IF;
        ELSE
          HORAS_TRABAJO:= ROUND(NUM_PALABRAS/CONFIG_EXTERNA.PAL_TRAD_HORA_045,2);
        END IF;
      ELSE
        HORAS_TRABAJO:= ROUND(NUM_PALABRAS/CONFIG_EXTERNA.PAL_REV_HORA_045,2);
      END IF;
      NUM_RECURSOS:= CEIL(HORAS_TRABAJO/HORAS_ACUM);
      l_estudio.EXTEND;
      l_estudio(l_estudio.count) := (STRUCT_ESTUDIO('E', NUM_RECURSOS ,FORMAT_HORA_MINUTOS(HORAS_TRABAJO), FORMAT_HORA_MINUTOS(ROUND((HORAS_TRABAJO/DIAS_REALES)/NUM_RECURSOS,2)))) ;
    EXCEPTION
    WHEN OTHERS THEN
      l_estudio:= ESTUDIO_TABLE();
      l_estudio.EXTEND;
      l_estudio(l_estudio.count) := (STRUCT_ESTUDIO('I', 0 ,'00:00', '00:00')) ;
      l_estudio.EXTEND;
      l_estudio(l_estudio.count) := (STRUCT_ESTUDIO('E', 0 ,'00:00', '00:00')) ;
    END;
    -- fin
    RETURN l_estudio;
  END;
  /

create or replace FUNCTION CALCULO_HORAS_TRADUCCION( IND_INTERNO IN VARCHAR2, ANYO IN   NUMBER,
   NUM_EXP IN NUMBER, IDS_DOCS IN  VARCHAR2 , ID_TIPO_TAREA IN NUMBER) RETURN VARCHAR IS

RETORNO VARCHAR2(10):='0';

sql_stmt    VARCHAR2(2000);

TYPE r_reg_config IS RECORD (
    PAL_TRAD_HORA NUMBER(4),
    PAL_REV_HORA NUMBER(4),
    PAL_HORA_CONCOR_95_100 NUMBER(4),
    PAL_HORA_CONCOR_85_94 NUMBER(4),
    PAL_HORA_CONCOR_0_84 NUMBER(4)
);
CONFIG r_reg_config;
LIM_PAL_CONCOR NUMBER(4);
LIMPALCONFIG_INTERNA AA79B02S02%ROWTYPE;
LIMPALCONFIG_EXTERNA AA79B45S02%ROWTYPE;

TIPO_EXPEDIENTE VARCHAR2(1);
TIPO_EXP_TRADUCCION VARCHAR2(1):= 'T';
TIPO_EXP_REVISION VARCHAR2(1):= 'R';
--ID_TIPO_RELEVANCIA NUMBER(2);
NIV_USUARIO VARCHAR2(1);
IND_VIP VARCHAR2(1);
IND_TIEMPO_GESTION VARCHAR2(1);

TYPE r_reg_documentos IS RECORD (
  	NUM_TOTAL_PAL_IZO_EXP NUMBER(6),
	NUM_TOTAL_PAL_IZO NUMBER(6),
	NUM_TOTAL_PAL NUMBER(6),
	NUM_PAL_CONCOR_0_84_091 NUMBER(6),
	NUM_PAL_CONCOR_85_94_091 NUMBER(6),
	NUM_PAL_CONCOR_95_100_091 NUMBER(6),
	NUM_PAL_CONCOR_0_84_056 NUMBER(6),
	NUM_PAL_CONCOR_85_94_056 NUMBER(6),
	NUM_PAL_CONCOR_95_100_056 NUMBER(6)
);
DOCUMENTOS r_reg_documentos;

HORAS_TRABAJO NUMBER(9,2):= 0.0;

CLASE_DOC_TRAD NUMBER(1):= 1;
CLASE_DOC_REV NUMBER(1):= 2;
CLASE_DOC_TRABAJO NUMBER(1):= 4;

PRIORIDAD_RELEVANCIA NUMBER(2):=0;

TIPO_TAREA_TRADOS            NUMBER(2) := 1;
TIPO_TAREA_TRADUCCION        NUMBER(2) := 2;
TIPO_TAREA_REVISAR        NUMBER(2) := 2;
TIPO_TAREA_CORREDACCION      NUMBER(2) := 3;
TIPO_TAREA_TRAD_ENTREGA      NUMBER(2) := 22;

TIPO_TAREA_REVISAR_TRAD      NUMBER(2) := 21;

TIPO_TAREA_REV_ENTREGA      NUMBER(2) := 20;
TIPO_TAREA_TRAD_ENTREGA_REV      NUMBER(2) := 19;

HORAS_TIEMPO_EXTRA_GESTION      NUMBER(12,2):=0;
TIEMPO_EXTRA_GESTION			VARCHAR2(10):= '00:00';

-- obtenemos los tipos de relevancia de los documentos del expediente
    CURSOR C_DOCUMENTOS IS
        (SELECT NVL(ID_TIPO_RELEVANCIA_042,ID_RELEVANCIA_053) ID_TIPO_RELEVANCIA, ID_DOC_056
        FROM AA79B56S01,AA79B53S01, AA79B42S01, AA79B10S01 WHERE TIPO_DOCUMENTO_056 =  ID_042 (+)
        AND ID_TIPO_RELEVANCIA_042 =  ID_TIPO_RELEVANCIA_010 (+)
        AND ANYO_056 = ANYO_053 AND NUM_EXP_056 = NUM_EXP_053
        AND ANYO_056 = ANYO AND NUM_EXP_056 = NUM_EXP
        AND CLASE_DOCUMENTO_056 in (CLASE_DOC_TRAD, CLASE_DOC_REV, CLASE_DOC_TRABAJO) AND ID_DOC_VERSION_056 is null AND ID_DOC_REL_056 is null 
        -- ID DOCS (vienen como varchar, tenemos que separar los valores)
        AND ID_DOC_056 IN(SELECT regexp_substr(IDS_DOCS,'[^,]+', 1, LEVEL) FROM dual
                          CONNECT BY regexp_substr(IDS_DOCS, '[^,]+', 1, LEVEL) IS NOT NULL));
BEGIN

-- obtenemos el tipo de expediente
	SELECT ID_TIPO_EXPEDIENTE_051 into TIPO_EXPEDIENTE FROM AA79B51T00 WHERE ANYO_051 = ANYO AND NUM_EXP_051 = NUM_EXP;
-- obtenemos si el usuario es vip o no
    SELECT IND_VIP_054 INTO IND_VIP FROM AA79B54T00 WHERE ANYO_054 = ANYO AND NUM_EXP_054 = NUM_EXP;
    IF( IND_VIP = 'S') THEN
        NIV_USUARIO := 'V';
    ELSE
        NIV_USUARIO := 'N';
    END IF;
-- obtenemos si el tipo de tarea tiene tiempo de gestion extra
    SELECT IND_TIEMPO_GESTION_015 INTO IND_TIEMPO_GESTION FROM AA79B15S01 WHERE ID_015 = ID_TIPO_TAREA;
    SELECT TIEMPO_EXTRA_GESTION_002 INTO TIEMPO_EXTRA_GESTION FROM AA79B02S02 WHERE ID_002 = 0;
    IF( IND_TIEMPO_GESTION = 'S') THEN
        HORAS_TIEMPO_EXTRA_GESTION := PARSE_HORA_MINUTOS(TIEMPO_EXTRA_GESTION);
        HORAS_TRABAJO:= HORAS_TRABAJO + HORAS_TIEMPO_EXTRA_GESTION;
    END IF;


    IF (ID_TIPO_TAREA = TIPO_TAREA_TRADUCCION 
			OR ID_TIPO_TAREA = TIPO_TAREA_CORREDACCION 
			OR ID_TIPO_TAREA = TIPO_TAREA_REVISAR
			OR ID_TIPO_TAREA = TIPO_TAREA_TRAD_ENTREGA 
			OR ID_TIPO_TAREA = TIPO_TAREA_REV_ENTREGA 
			OR ID_TIPO_TAREA = TIPO_TAREA_REVISAR_TRAD 
			OR ID_TIPO_TAREA = TIPO_TAREA_TRAD_ENTREGA_REV) THEN
    
    	-- obtenemos la configuración dependiendo de si es interno o externo 
	    FOR R_DOCUMENTOS IN C_DOCUMENTOS LOOP -- hacer loop con documentos pasados
	        -- obtenemos la configuracion en funcion del tipo de relevancia y nivel usuario del expediente
	        IF (IND_INTERNO = 'I') THEN
	            SELECT PAL_TRAD_HORA_002, PAL_REV_HORA_002, PAL_HORA_CONCOR_95_100_002, PAL_HORA_CONCOR_85_94_002,
	                        PAL_HORA_CONCOR_0_84_002 INTO CONFIG FROM AA79B02T00 WHERE ID_002 = 0 AND NIVEL_USUARIO_002 = NIV_USUARIO AND ID_TIPO_RELEVANCIA_002 = R_DOCUMENTOS.ID_TIPO_RELEVANCIA;
	            SELECT * INTO LIMPALCONFIG_INTERNA FROM AA79B02S02 WHERE ID_002 = 0;
	            LIM_PAL_CONCOR := LIMPALCONFIG_INTERNA.LIM_PAL_CONCOR_002;
	        ELSE   
	
	            SELECT PAL_TRAD_HORA_045, PAL_REV_HORA_045, PAL_HORA_CONCOR_95_100_045, PAL_HORA_CONCOR_85_94_045,
	                        PAL_HORA_CONCOR_0_84_045 INTO CONFIG FROM AA79B45T00 WHERE ID_045 = 0 AND NIVEL_USUARIO_045 = NIV_USUARIO;
	            SELECT * INTO LIMPALCONFIG_EXTERNA FROM AA79B45S02 WHERE ID_045 = 0;
	            LIM_PAL_CONCOR := LIMPALCONFIG_EXTERNA.LIM_PAL_CONCOR_045;
	        END IF;
	        -- obtenemos los datos del documento
	        sql_stmt := 'select NUM_TOTAL_PAL_IZO_053, NUM_PAL_IZO_056, NUM_TOTAL_PAL_091, NUM_PAL_CONCOR_0_84_091, NUM_PAL_CONCOR_85_94_091, 
	            NUM_PAL_CONCOR_95_100_091, NUM_PAL_CONCOR_0_84_056, NUM_PAL_CONCOR_85_94_056, NUM_PAL_CONCOR_95_100_056 from AA79B53T00
	            JOIN AA79B56T00 ON  ANYO_053 = ANYO_056 AND NUM_EXP_053 = NUM_EXP_056 AND ID_DOC_REL_056 is null AND CLASE_DOCUMENTO_056 in (' ||CLASE_DOC_TRAD ||',' ||CLASE_DOC_REV ||',' ||CLASE_DOC_TRABAJO ||')';
	            sql_stmt := sql_stmt ||' AND ID_DOC_056 = ('|| R_DOCUMENTOS.ID_DOC_056 ||')';
	            sql_stmt := sql_stmt ||' LEFT JOIN AA79B81T00 ON ANYO_081 = ANYO_056 AND NUM_EXP_081 = NUM_EXP_056 AND ID_TIPO_TAREA_081 = ('||TIPO_TAREA_TRADOS||')
	            LEFT JOIN AA79B91T00 ON ID_TAREA_081 = ID_TAREA_091 AND ID_DOC_ORIG_091 = ID_DOC_056 
	            WHERE ANYO_053 = '|| ANYO ||' AND NUM_EXP_053 = '||NUM_EXP||' ';
	
	          EXECUTE IMMEDIATE sql_stmt INTO DOCUMENTOS;
	         -- realizamos los calculos correspondientes
	         IF (TIPO_EXPEDIENTE = TIPO_EXP_TRADUCCION) THEN
	            IF (DOCUMENTOS.NUM_TOTAL_PAL_IZO_EXP < LIM_PAL_CONCOR) THEN
	                
	                IF (ID_TIPO_TAREA = TIPO_TAREA_REVISAR_TRAD OR ID_TIPO_TAREA = TIPO_TAREA_TRAD_ENTREGA_REV ) THEN
	                	HORAS_TRABAJO:= HORAS_TRABAJO + round((round(DOCUMENTOS.NUM_TOTAL_PAL_IZO/CONFIG.PAL_TRAD_HORA,2)*50/100),2);
	                ELSE
	                	HORAS_TRABAJO:= HORAS_TRABAJO + round(DOCUMENTOS.NUM_TOTAL_PAL_IZO/CONFIG.PAL_TRAD_HORA,2);
	                END IF;
	            ELSIF (DOCUMENTOS.NUM_TOTAL_PAL IS NULL OR DOCUMENTOS.NUM_TOTAL_PAL = 0) THEN
	                    IF (ID_TIPO_TAREA = TIPO_TAREA_REVISAR_TRAD OR ID_TIPO_TAREA = TIPO_TAREA_TRAD_ENTREGA_REV ) THEN
		                	HORAS_TRABAJO:= HORAS_TRABAJO + round((round(DOCUMENTOS.NUM_TOTAL_PAL_IZO/CONFIG.PAL_TRAD_HORA,2)*50/100),2);
		                ELSE
		                	HORAS_TRABAJO:= HORAS_TRABAJO + round(DOCUMENTOS.NUM_TOTAL_PAL_IZO/CONFIG.PAL_TRAD_HORA,2);
		                END IF;
	            ELSIF(DOCUMENTOS.NUM_PAL_CONCOR_0_84_091 IS NOT NULL AND DOCUMENTOS.NUM_PAL_CONCOR_85_94_091 IS NOT NULL AND DOCUMENTOS.NUM_PAL_CONCOR_95_100_091 IS NOT NULL) THEN
	                    IF (ID_TIPO_TAREA = TIPO_TAREA_REVISAR_TRAD OR ID_TIPO_TAREA = TIPO_TAREA_TRAD_ENTREGA_REV ) THEN
		                	HORAS_TRABAJO:= HORAS_TRABAJO + round(((round(DOCUMENTOS.NUM_PAL_CONCOR_0_84_091/CONFIG.PAL_HORA_CONCOR_0_84,2)
	                                                            + round(DOCUMENTOS.NUM_PAL_CONCOR_85_94_091/CONFIG.PAL_HORA_CONCOR_85_94,2)
	                                                             + round(DOCUMENTOS.NUM_PAL_CONCOR_95_100_091/CONFIG.PAL_HORA_CONCOR_95_100,2))*50/100),2);
		                ELSE
		                	HORAS_TRABAJO:= HORAS_TRABAJO + round(DOCUMENTOS.NUM_PAL_CONCOR_0_84_091/CONFIG.PAL_HORA_CONCOR_0_84,2)
	                                                        + round(DOCUMENTOS.NUM_PAL_CONCOR_85_94_091/CONFIG.PAL_HORA_CONCOR_85_94,2)
	                                                        + round(DOCUMENTOS.NUM_PAL_CONCOR_95_100_091/CONFIG.PAL_HORA_CONCOR_95_100,2);
		                END IF;	
	            ELSIF(DOCUMENTOS.NUM_PAL_CONCOR_0_84_056 IS NOT NULL AND DOCUMENTOS.NUM_PAL_CONCOR_85_94_056 IS NOT NULL AND DOCUMENTOS.NUM_PAL_CONCOR_95_100_056 IS NOT NULL) THEN 
	                	IF (ID_TIPO_TAREA = TIPO_TAREA_REVISAR_TRAD OR ID_TIPO_TAREA = TIPO_TAREA_TRAD_ENTREGA_REV ) THEN
		                	 HORAS_TRABAJO:= HORAS_TRABAJO + round(((round(DOCUMENTOS.NUM_PAL_CONCOR_0_84_056/CONFIG.PAL_HORA_CONCOR_0_84,2)
	                                                                    + round(DOCUMENTOS.NUM_PAL_CONCOR_85_94_056/CONFIG.PAL_HORA_CONCOR_85_94,2)
	                                                                    + round(DOCUMENTOS.NUM_PAL_CONCOR_95_100_056/CONFIG.PAL_HORA_CONCOR_95_100,2))*50/100),2);
		                ELSE
		                	HORAS_TRABAJO:= HORAS_TRABAJO 
	                                            + round(DOCUMENTOS.NUM_PAL_CONCOR_0_84_056/CONFIG.PAL_HORA_CONCOR_0_84,2)
	                                            + round(DOCUMENTOS.NUM_PAL_CONCOR_85_94_056/CONFIG.PAL_HORA_CONCOR_85_94,2)
	                                            + round(DOCUMENTOS.NUM_PAL_CONCOR_95_100_056/CONFIG.PAL_HORA_CONCOR_95_100,2);
		                END IF;	
		        ELSE
	           		IF (ID_TIPO_TAREA = TIPO_TAREA_REVISAR_TRAD OR ID_TIPO_TAREA = TIPO_TAREA_TRAD_ENTREGA_REV ) THEN
	                	HORAS_TRABAJO:= HORAS_TRABAJO + round((round(DOCUMENTOS.NUM_TOTAL_PAL/CONFIG.PAL_TRAD_HORA,2)*50/100),2);
	                ELSE
	                	HORAS_TRABAJO:= HORAS_TRABAJO + round(DOCUMENTOS.NUM_TOTAL_PAL/CONFIG.PAL_TRAD_HORA,2);
	                END IF;
		        END IF;   
	        ELSIF(TIPO_EXPEDIENTE = TIPO_EXP_REVISION) THEN
	            --Izoko baliabideek orduko berrikusten (en función de la dificultad del documento si el recurso asignado es interno)??
	            HORAS_TRABAJO:= HORAS_TRABAJO + round(DOCUMENTOS.NUM_TOTAL_PAL_IZO/CONFIG.PAL_REV_HORA,2);
	        END IF;
	    END LOOP;
    
    ELSE
    	HORAS_TRABAJO:= HORAS_TRABAJO + PARSE_HORA_MINUTOS('00:30');
    END IF;

	RETURN FORMAT_HORA_MINUTOS(HORAS_TRABAJO);

END;
/


exit;