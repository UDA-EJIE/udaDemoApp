DEFINE DIR_SCRIPTS = '/aplic/aa79b/scripts';

ALTER TABLE AA79B98T00 MODIFY NUM_TOTAL_PAL_FACTURAR_098 NUMBER(6);
ALTER TABLE AA79B98T00 MODIFY NUM_PAL_CONCOR_0_84_098 NUMBER(6);
ALTER TABLE AA79B98T00 MODIFY NUM_PAL_CONCOR_85_94_098 NUMBER(6);
ALTER TABLE AA79B98T00 MODIFY NUM_PAL_CONCOR_95_100_098 NUMBER(6);

CREATE OR REPLACE
  FUNCTION CALCULO_PRESUPUESTO_TRADUCCION(
      ANYO     IN NUMBER,
      NUM_EXP  IN NUMBER,
      ID_TAREA IN NUMBER)
    RETURN NUMBER
  IS
    ID_IDIOMA_CAS  NUMBER(2)  := 1;
    ID_IDIOMA_EUS  NUMBER(2)  := 2;
  TYPE r_reg_expediente
IS
  RECORD
  (
    NUM_TOTAL_PAL_IZO     NUMBER(6),
    ID_IDIOMA             NUMBER(2),
    ID_RELEVANCIA         NUMBER(2),
    IND_URGENTE           VARCHAR2(1),
    IND_DIFICIL           VARCHAR2(1),
    IND_PRESUPUESTO       VARCHAR2(1),
    NUM_TOTAL_PAL         NUMBER(6),
    NUM_PAL_CONCOR_0_84   NUMBER(6),
    NUM_PAL_CONCOR_85_94  NUMBER(6),
    NUM_PAL_CONCOR_95_100 NUMBER(6),
    IND_BOPV              VARCHAR2(1),
    IND_BOE 	 VARCHAR2(1));
  EXPEDIENTE r_reg_expediente;
TYPE r_reg_orden
IS
  RECORD
  (
    ID_ORDEN                  NUMBER(4),
    POR_IVA                   NUMBER(3),
    POR_RECARGO_DIF           NUMBER(3),
    POR_RECARGO_URG           NUMBER(3),
    PRECIO_MINIMO             NUMBER(8,2),
    NUM_PALABRAS_TARIF_CONCOR NUMBER(6),
    POR_PALABRA_CONCOR_0_84   NUMBER(3),
    POR_PALABRA_CONCOR_85_94  NUMBER(3),
    POR_PALABRA_CONCOR_95_100 NUMBER(3),
    TARIFA_RELEVANCIA_TRAD    NUMBER(5,4) );
  ORDEN_PRECIOS r_reg_orden;
TYPE r_reg_config_facturacion
IS
  RECORD
  (
    IND_IVA        VARCHAR2(1),
    IND_FACTURABLE VARCHAR2(1) );
  CONFIG_FACTURACION r_reg_config_facturacion;
  IMPORTE_BASE           NUMBER(8,2):=0.0;
  IMPORTE_DIFICULTAD     NUMBER(8,2):=0.0;
  IMPORTE_URGENCIA       NUMBER(8,2):=0.0;
  IMPORTE_IVA            NUMBER(8,2):=0.0;
  IMPORTE                NUMBER(9,2):=0.0;
  IMPORTE_ENTIDAD        NUMBER(9,2):=0.0;
  IMPORTE_BASE_ENTIDAD   NUMBER(8,2):=0.0;
  IMPORTE_IVA_ENTIDAD    NUMBER(8,2):=0.0;
  IMPORTE_DIFICULTAD_ENT NUMBER(8,2):=0.0;
  IMPORTE_URGENCIA_ENT   NUMBER(8,2):=0.0;
  IMPORTE_MINIMO         NUMBER(8,2):=0.0;
  IMPORTE_BASE_MINIMO    NUMBER(8,2):=0.0;
  IMPORTE_IVA_MINIMO     NUMBER(8,2):=0.0;
  NUM_TOTAL_PAL_FACTURAR NUMBER(6);
  NUM_PAL_CONCOR_0_84    NUMBER(6);
  NUM_PAL_CONCOR_85_94   NUMBER(6);
  NUM_PAL_CONCOR_95_100  NUMBER(6);
  -- PARA LAS ACUMULADAS EN EL REPARTO
  NUM_TOTAL_PAL_ACUM         NUMBER(6);
  NUM_PAL_CONCOR_0_84_ACUM   NUMBER(6);
  NUM_PAL_CONCOR_85_94_ACUM  NUMBER(6);
  NUM_PAL_CONCOR_95_100_ACUM NUMBER(6);
  -- NUMEROS DE PALABRAS PARA CADA ENTIDAD
  NUM_TOTAL_PAL_FACTURAR_ENT NUMBER(6);
  NUM_PAL_CONCOR_0_84_ENT    NUMBER(6);
  NUM_PAL_CONCOR_85_94_ENT   NUMBER(6);
  NUM_PAL_CONCOR_95_100_ENT  NUMBER(6);
  CONTADOR                   NUMBER(1):=0;
  NUEVA_DIRNORA NUMBER(8);
  
  -- SELECCIONAMOS LAS ENTIDADES DE FACTURACION DEL EXPEDIENTE;
  CURSOR C_ENTIDADES_FACT
  IS
    (SELECT ID_058,
      TIPO_ENTIDAD_ASOC_058,
      ID_ENTIDAD_ASOC_058,
      DNI_CONTACTO_058,
      POR_FACTURA_058,
      ent.FACTURABLE                 AS FACTURABLE,
      ent.IVA                        AS IVA,
      NVL(sol.CDIRNORA,ent.CDIRNORA) AS DIRNORA,
      DECODE(ID_098, NULL, 'N', 'S') AS TIENE_DATOS
    FROM AA79B58T00,
      X54JAPI_ENTIDADES_SOLIC ent,
      X54JAPI_SOLICITANTES sol,
      AA79B98T00
    WHERE TIPO_ENTIDAD_ASOC_058 = ent.TIPO
    AND ID_ENTIDAD_ASOC_058     = ent.CODIGO
    AND DNI_CONTACTO_058        = sol.DNI (+)
    AND ID_058                  = ID_098 (+)
    AND ANYO_058                = ANYO
    AND NUM_EXP_058             = NUM_EXP
    );
BEGIN
  -- obtenemos datos del numero de palabras del expediente el idioma destino y la relevancia.
  SELECT NUM_TOTAL_PAL_IZO_053,
    ID_IDIOMA_053,
    ID_RELEVANCIA_053,
    IND_URGENTE_053,
    IND_DIFICIL_053,
    IND_PRESUPUESTO_053,
    NUM_TOTAL_PAL_090,
    NUM_PAL_CONCOR_0_84_090,
    NUM_PAL_CONCOR_85_94_090,
    NUM_PAL_CONCOR_95_100_090,
    IND_PUBLICAR_BOPV_053,
    CASE WHEN (TIPO_ENTIDAD_054, ID_ENTIDAD_054) = (SELECT 'B', VALOR_000 FROM AA79B00T00 WHERE ID_000 = 1) THEN
        'S'
    ELSE
        'N'
    END AS IND_PUBLICADO_BOE_053
  INTO EXPEDIENTE
  FROM AA79B53T00, AA79B54T00,
    AA79B81T00,
    AA79B90T00
  WHERE ANYO_053      = ANYO
  AND NUM_EXP_053     = NUM_EXP
  AND ANYO_054    = ANYO_053
  AND NUM_EXP_054 = NUM_EXP_053
  AND ANYO_081 (+)    = ANYO_053
  AND NUM_EXP_081 (+) = NUM_EXP_053
  AND ID_TAREA_081    = ID_TAREA
  AND ID_TAREA_081    = ID_TAREA_090 (+);
  -- obtenemos la información de la orden de precios vigente para los expedientes de traducción
  BEGIN
    SELECT ID_ORDEN_031,
      POR_IVA_031,
      POR_RECARGO_DIF_032,
      POR_RECARGO_URG_032,
      PRECIO_MINIMO_032,
      NUM_PALABRAS_TARIF_CONCOR_032,
      POR_PALABRA_CONCOR_0_84_032,
      POR_PALABRA_CONCOR_85_94_032,
      POR_PALABRA_CONCOR_95_100_032,
      CASE
        WHEN EXPEDIENTE.ID_IDIOMA = ID_IDIOMA_EUS
        THEN TARIFA_ES_EU_033
        ELSE TARIFA_EU_ES_033
      END AS TARIFA_RELEVANCIA_TRAD
    INTO ORDEN_PRECIOS
    FROM AA79B31T00,
      AA79B30T00,
      AA79B32T00,
      AA79B33T00
    WHERE ID_030               = ID_ORDEN_031
    AND IND_VIGOR_030          = 'S'
    AND IND_VIGENTE_031        = 'S'
    AND ID_030                 = ID_ORDEN_032
    AND ID_030                 = ID_ORDEN_033
    AND ID_TIPO_RELEVANCIA_033 = EXPEDIENTE.ID_RELEVANCIA;
    -- obtenemos el numero de palabras a facturar
    IF (EXPEDIENTE.NUM_TOTAL_PAL_IZO < ORDEN_PRECIOS.NUM_PALABRAS_TARIF_CONCOR) THEN
      --IMPORTE_LIMPIO:= round(ORDEN_PRECIOS.TARIFA_RELEVANCIA_TRAD*EXPEDIENTE.NUM_TOTAL_PAL_IZO,2);
      NUM_TOTAL_PAL_FACTURAR := EXPEDIENTE.NUM_TOTAL_PAL_IZO;
    ELSE
      /*IMPORTE_LIMPIO:= round(((ORDEN_PRECIOS.TARIFA_RELEVANCIA_TRAD*EXPEDIENTE.NUM_PAL_CONCOR_0_84*(ORDEN_PRECIOS.POR_PALABRA_CONCOR_0_84/100)) +
      (ORDEN_PRECIOS.TARIFA_RELEVANCIA_TRAD*EXPEDIENTE.NUM_PAL_CONCOR_85_94*(ORDEN_PRECIOS.POR_PALABRA_CONCOR_85_94/100)) +
      (ORDEN_PRECIOS.TARIFA_RELEVANCIA_TRAD*EXPEDIENTE.NUM_PAL_CONCOR_95_100*(ORDEN_PRECIOS.POR_PALABRA_CONCOR_95_100/100))),2);*/
      NUM_TOTAL_PAL_FACTURAR := EXPEDIENTE.NUM_TOTAL_PAL;
      NUM_PAL_CONCOR_0_84    := EXPEDIENTE.NUM_PAL_CONCOR_0_84;
      NUM_PAL_CONCOR_85_94   := EXPEDIENTE.NUM_PAL_CONCOR_85_94;
      NUM_PAL_CONCOR_95_100  := EXPEDIENTE.NUM_PAL_CONCOR_95_100;
    END IF;
    /*PRESUPUESTO:=IMPORTE_LIMPIO;
    IF (EXPEDIENTE.IND_URGENTE = 'S') THEN
    IMPORTE_URGENCIA := round(IMPORTE_LIMPIO * (ORDEN_PRECIOS.POR_RECARGO_URG/100),2);
    PRESUPUESTO:= PRESUPUESTO + IMPORTE_URGENCIA;
    END IF;
    IF (EXPEDIENTE.IND_DIFICIL = 'S') THEN
    IMPORTE_DIFICULTAD:= round(IMPORTE_LIMPIO * (ORDEN_PRECIOS.POR_RECARGO_DIF/100),2);
    PRESUPUESTO:= PRESUPUESTO + IMPORTE_DIFICULTAD;
    END IF;
    IF (PRESUPUESTO < ORDEN_PRECIOS.PRECIO_MINIMO)THEN
    PRESUPUESTO:= ORDEN_PRECIOS.PRECIO_MINIMO;
    END IF;
    IMPORTE_BASE:= PRESUPUESTO * 100 / (100 + ORDEN_PRECIOS.POR_IVA);*/
    FOR R_ENTIDADES_FACT IN C_ENTIDADES_FACT
    LOOP
      IF (EXPEDIENTE.NUM_TOTAL_PAL_IZO < ORDEN_PRECIOS.NUM_PALABRAS_TARIF_CONCOR) THEN
        NUM_TOTAL_PAL_FACTURAR_ENT    := ROUND((NUM_TOTAL_PAL_FACTURAR * R_ENTIDADES_FACT.POR_FACTURA_058)/100,0);
        NUM_TOTAL_PAL_ACUM            := NUM_TOTAL_PAL_ACUM            + NUM_TOTAL_PAL_FACTURAR_ENT;
        IF (NUM_TOTAL_PAL_ACUM         > NUM_TOTAL_PAL_FACTURAR) THEN
          NUM_TOTAL_PAL_FACTURAR_ENT  := NUM_TOTAL_PAL_FACTURAR_ENT -1;
        END IF;
        IMPORTE_ENTIDAD:= ROUND(ORDEN_PRECIOS.TARIFA_RELEVANCIA_TRAD*NUM_TOTAL_PAL_FACTURAR_ENT,2);
      ELSE
        NUM_TOTAL_PAL_FACTURAR_ENT  := ROUND((NUM_TOTAL_PAL_FACTURAR * R_ENTIDADES_FACT.POR_FACTURA_058)/100,0);
        NUM_PAL_CONCOR_0_84_ENT     := ROUND((NUM_PAL_CONCOR_0_84    * R_ENTIDADES_FACT.POR_FACTURA_058)/100,0);
        NUM_PAL_CONCOR_85_94_ENT    := ROUND((NUM_PAL_CONCOR_85_94   * R_ENTIDADES_FACT.POR_FACTURA_058)/100,0);
        NUM_PAL_CONCOR_95_100_ENT   := ROUND((NUM_PAL_CONCOR_95_100  * R_ENTIDADES_FACT.POR_FACTURA_058)/100,0);
        NUM_TOTAL_PAL_ACUM          := NUM_TOTAL_PAL_ACUM            + NUM_TOTAL_PAL_FACTURAR_ENT;
        NUM_PAL_CONCOR_0_84_ACUM    := NUM_PAL_CONCOR_0_84_ACUM      + NUM_PAL_CONCOR_0_84_ENT;
        NUM_PAL_CONCOR_85_94_ACUM   := NUM_PAL_CONCOR_85_94_ACUM     + NUM_PAL_CONCOR_85_94_ENT;
        NUM_PAL_CONCOR_95_100_ACUM  := NUM_PAL_CONCOR_95_100_ACUM    + NUM_PAL_CONCOR_95_100_ENT;
        IF (NUM_TOTAL_PAL_ACUM       > NUM_TOTAL_PAL_FACTURAR) THEN
          NUM_TOTAL_PAL_FACTURAR_ENT:= NUM_TOTAL_PAL_FACTURAR_ENT -1;
        END IF;
        IF (NUM_PAL_CONCOR_0_84_ACUM > NUM_PAL_CONCOR_0_84) THEN
          NUM_PAL_CONCOR_0_84_ENT   := NUM_PAL_CONCOR_0_84_ENT -1;
        END IF;
        IF (NUM_PAL_CONCOR_85_94_ACUM > NUM_PAL_CONCOR_85_94) THEN
          NUM_PAL_CONCOR_85_94_ENT   := NUM_PAL_CONCOR_85_94_ENT -1;
        END IF;
        IF (NUM_PAL_CONCOR_95_100_ACUM > NUM_PAL_CONCOR_95_100) THEN
          NUM_PAL_CONCOR_95_100_ENT   := NUM_PAL_CONCOR_95_100_ENT -1;
        END IF;
        IMPORTE_ENTIDAD:= ROUND(((ORDEN_PRECIOS.TARIFA_RELEVANCIA_TRAD*NUM_PAL_CONCOR_0_84_ENT*(ORDEN_PRECIOS.POR_PALABRA_CONCOR_0_84/100)) + (ORDEN_PRECIOS.TARIFA_RELEVANCIA_TRAD*NUM_PAL_CONCOR_85_94_ENT*(ORDEN_PRECIOS.POR_PALABRA_CONCOR_85_94/100)) + (ORDEN_PRECIOS.TARIFA_RELEVANCIA_TRAD*NUM_PAL_CONCOR_95_100_ENT*(ORDEN_PRECIOS.POR_PALABRA_CONCOR_95_100/100))),2);
      END IF;
      IMPORTE_URGENCIA_ENT      := 0.0;
      IF (EXPEDIENTE.IND_URGENTE = 'S') THEN
        IMPORTE_URGENCIA_ENT    := ROUND(IMPORTE_ENTIDAD * (ORDEN_PRECIOS.POR_RECARGO_URG/100),2);
      END IF;
      IMPORTE_DIFICULTAD_ENT    := 0.0;
      IF (EXPEDIENTE.IND_DIFICIL = 'S') THEN
        IMPORTE_DIFICULTAD_ENT  := ROUND(IMPORTE_ENTIDAD * (ORDEN_PRECIOS.POR_RECARGO_DIF/100),2);
      END IF;
      IMPORTE_ENTIDAD         := IMPORTE_ENTIDAD + IMPORTE_URGENCIA_ENT + IMPORTE_DIFICULTAD_ENT;
      IMPORTE_BASE_ENTIDAD    := IMPORTE_ENTIDAD * 100 / (100 + ORDEN_PRECIOS.POR_IVA);
      IMPORTE_IVA_ENTIDAD     := 0.0;
      IF (R_ENTIDADES_FACT.IVA = 'S') THEN
        IMPORTE_IVA_ENTIDAD   := (IMPORTE_BASE_ENTIDAD * ORDEN_PRECIOS.POR_IVA) / 100;
      END IF;
      IMPORTE_ENTIDAD   := IMPORTE_IVA_ENTIDAD + IMPORTE_BASE_ENTIDAD;
      -- ANYADIMOS A LOS TOTALES
      IMPORTE_BASE      := IMPORTE_BASE        + IMPORTE_BASE_ENTIDAD;
      IMPORTE_IVA       := IMPORTE_IVA         + IMPORTE_IVA_ENTIDAD;
      IMPORTE           := IMPORTE             + IMPORTE_ENTIDAD;
      IMPORTE_DIFICULTAD:= IMPORTE_DIFICULTAD  + IMPORTE_DIFICULTAD_ENT;
      IMPORTE_URGENCIA  := IMPORTE_URGENCIA    + IMPORTE_URGENCIA_ENT;
      -- EN LA 98
      IF (R_ENTIDADES_FACT.TIENE_DATOS = 'S') THEN
        UPDATE AA79B98T00
        SET IND_FACTURABLE_098      = R_ENTIDADES_FACT.FACTURABLE,
          IND_IVA_098               =R_ENTIDADES_FACT.IVA,
          NUM_TOTAL_PAL_FACTURAR_098=NUM_TOTAL_PAL_FACTURAR_ENT ,
          NUM_PAL_CONCOR_0_84_098   =NUM_PAL_CONCOR_0_84_ENT,
          NUM_PAL_CONCOR_85_94_098  =NUM_PAL_CONCOR_85_94_ENT,
          NUM_PAL_CONCOR_95_100_098 =NUM_PAL_CONCOR_95_100_ENT,
          IMPORTE_DIFICULTAD_098    =IMPORTE_DIFICULTAD_ENT,
          IMPORTE_URGENCIA_098      =IMPORTE_URGENCIA_ENT,
          IMPORTE_BASE_098          =IMPORTE_BASE_ENTIDAD,
          IMPORTE_IVA_098           =IMPORTE_IVA_ENTIDAD,
          IMPORTE_TOTAL_098         =IMPORTE_ENTIDAD
        WHERE ID_098                = R_ENTIDADES_FACT.ID_058;
      ELSE
        -- copiamos la dirección NORA a nuestra tabla de direcciones
        SELECT AA79B49Q00.nextVal
        INTO NUEVA_DIRNORA
        FROM dual;
        INSERT
        INTO AA79b49T00
          (
            CDIRNORA_049,
            TIPONORA_049,
            CODNORA_049,
            CODPROV_049,
            CODMUNI_049,
            CODLOCAL_049,
            CODPOST_049,
            ESCALER_049,
            PISO_049,
            MANO_049,
            PUERTA_049,
            APROX_049,
            TXTCALLE_049,
            TXTPORTAL_049,
            CODPAIS_049,
            TXTPROV_049,
            TXTCIUDAD_049,
            TXTDIREC_049
          )
        SELECT NUEVA_DIRNORA,
          TIPONORA,
          CODPORTAL,
          CODPROVINCIA,
          CODMUNICIPIO,
          CODLOCALIDAD,
          CODPOSTAL,
          ESCALERA,
          PISO,
          MANO,
          PUERTA,
          APROX,
          CALLE,
          PORTAL,
          CODPAIS,
          PROVINCIA,
          MUNICIPIO,
          DIRECCION
        FROM X54JNORA
        WHERE CDIRNORA = R_ENTIDADES_FACT.DIRNORA;
        INSERT
        INTO AA79B98T00
          (
            ID_098,
            DIR_NORA_098,
            IND_FACTURABLE_098,
            IND_IVA_098,
            NUM_TOTAL_PAL_FACTURAR_098,
            NUM_PAL_CONCOR_0_84_098,
            NUM_PAL_CONCOR_85_94_098,
            NUM_PAL_CONCOR_95_100_098,
            IMPORTE_DIFICULTAD_098,
            IMPORTE_URGENCIA_098,
            IMPORTE_BASE_098,
            IMPORTE_IVA_098,
            IMPORTE_TOTAL_098
          )
          VALUES
          (
            R_ENTIDADES_FACT.ID_058,
            NUEVA_DIRNORA,
            R_ENTIDADES_FACT.FACTURABLE,
            R_ENTIDADES_FACT.IVA,
            NUM_TOTAL_PAL_FACTURAR_ENT,
            NUM_PAL_CONCOR_0_84_ENT,
            NUM_PAL_CONCOR_85_94_ENT,
            NUM_PAL_CONCOR_95_100_ENT,
            IMPORTE_DIFICULTAD_ENT,
            IMPORTE_URGENCIA_ENT,
            IMPORTE_BASE_ENTIDAD,
            IMPORTE_IVA_ENTIDAD,
            IMPORTE_ENTIDAD
          );
      END IF;
    END LOOP;
    -- OBTENGO EL BASE DEL PRECIO MINIMO  y miro si lo tengo que aplicar
    IMPORTE_MINIMO         := ORDEN_PRECIOS.PRECIO_MINIMO;
    IMPORTE_BASE_MINIMO    := IMPORTE_MINIMO * 100 / (100 + ORDEN_PRECIOS.POR_IVA);
    IF (EXPEDIENTE.IND_BOPV = 'N' AND EXPEDIENTE.IND_BOE = 'N' AND IMPORTE_BASE < IMPORTE_BASE_MINIMO ) THEN
      IMPORTE_BASE         := 0.0;
      IMPORTE_IVA          := 0.0;
      IMPORTE              := 0.0;
      IMPORTE_DIFICULTAD   :=0.0;
      IMPORTE_URGENCIA     :=0.0;
      FOR R_ENTIDADES_FACT IN C_ENTIDADES_FACT
      LOOP
        IMPORTE_DIFICULTAD_ENT  := 0.0;
        IMPORTE_URGENCIA_ENT    := 0.0;
        IMPORTE_BASE_ENTIDAD    := ROUND((IMPORTE_BASE_MINIMO * R_ENTIDADES_FACT.POR_FACTURA_058)/100,2);
        IMPORTE_IVA_ENTIDAD     := 0.0;
        IF (R_ENTIDADES_FACT.IVA = 'S') THEN
          IMPORTE_IVA_ENTIDAD   := (IMPORTE_BASE_ENTIDAD * ORDEN_PRECIOS.POR_IVA) / 100;
        END IF;
        IMPORTE_ENTIDAD   := IMPORTE_IVA_ENTIDAD + IMPORTE_BASE_ENTIDAD;
        
        IMPORTE_BASE      := IMPORTE_BASE       + IMPORTE_BASE_ENTIDAD;
        IMPORTE_IVA       := IMPORTE_IVA        + IMPORTE_IVA_ENTIDAD;
        IMPORTE           := IMPORTE            + IMPORTE_ENTIDAD;
        IMPORTE_DIFICULTAD:= IMPORTE_DIFICULTAD + IMPORTE_DIFICULTAD_ENT;
        IMPORTE_URGENCIA  := IMPORTE_URGENCIA   + IMPORTE_URGENCIA_ENT;
        UPDATE AA79B98T00
        SET IMPORTE_DIFICULTAD_098=IMPORTE_DIFICULTAD_ENT,
          IMPORTE_URGENCIA_098    =IMPORTE_URGENCIA_ENT,
          IMPORTE_BASE_098        =IMPORTE_BASE_ENTIDAD,
          IMPORTE_IVA_098         =IMPORTE_IVA_ENTIDAD,
          IMPORTE_TOTAL_098       =IMPORTE_ENTIDAD
        WHERE ID_098              = R_ENTIDADES_FACT.ID_058;
      END LOOP;
    END IF;
    IF (EXPEDIENTE.IND_PRESUPUESTO = 'S') THEN
      UPDATE AA79B90T00
      SET PRESUPUESTO_090 = IMPORTE,
        IMPORTE_BASE_090  = IMPORTE_BASE,
        IMPORTE_IVA_090   = IMPORTE_IVA,
        POR_IVA_090       = ORDEN_PRECIOS.POR_IVA,
        TARIFA_PAL_090    = ORDEN_PRECIOS.TARIFA_RELEVANCIA_TRAD,
        ID_ORDEN_090      = ORDEN_PRECIOS.ID_ORDEN
      WHERE ID_TAREA_090  = ID_TAREA;
    ELSE
      UPDATE AA79B90T00
      SET PRESUPUESTO_090 = NULL,
        IMPORTE_BASE_090  = NULL,
        IMPORTE_IVA_090   = NULL,
        POR_IVA_090       = ORDEN_PRECIOS.POR_IVA,
        TARIFA_PAL_090    = ORDEN_PRECIOS.TARIFA_RELEVANCIA_TRAD,
        ID_ORDEN_090      = ORDEN_PRECIOS.ID_ORDEN
      WHERE ID_TAREA_090  = ID_TAREA;
    END IF;
    -- ACTUALIZAMOS LOS DATOS DE FACTURACION DEL EXPEDIENTE
    SELECT COUNT(1)
    INTO CONTADOR
    FROM AA79B97S01
    WHERE ANYO_097 =ANYO
    AND NUM_EXP_097=NUM_EXP;
    IF (CONTADOR   > 0) THEN
      UPDATE AA79B97S01
      SET ID_ORDEN_097             = ORDEN_PRECIOS.ID_ORDEN,
        TARIFA_PAL_097             = ORDEN_PRECIOS.TARIFA_RELEVANCIA_TRAD,
        POR_IVA_097                = ORDEN_PRECIOS.POR_IVA,
        IMPORTE_DIFICULTAD_097     = IMPORTE_DIFICULTAD,
        IMPORTE_URGENCIA_097       = IMPORTE_URGENCIA,
        IMPORTE_BASE_097           = IMPORTE_BASE,
        IMPORTE_IVA_097            = IMPORTE_IVA,
        IMPORTE_TOTAL_097          = IMPORTE,
        NUM_TOTAL_PAL_FACTURAR_097 = NUM_TOTAL_PAL_FACTURAR,
        NUM_PAL_CONCOR_0_84_097    = NUM_PAL_CONCOR_0_84,
        NUM_PAL_CONCOR_85_94_097   = NUM_PAL_CONCOR_85_94,
        NUM_PAL_CONCOR_95_100_097  = NUM_PAL_CONCOR_95_100
      WHERE ANYO_097               =ANYO
      AND NUM_EXP_097              =NUM_EXP;
    ELSE
      INSERT
      INTO AA79B97S01
        (
          ID_ORDEN_097,
          TARIFA_PAL_097,
          POR_IVA_097,
          IMPORTE_DIFICULTAD_097,
          IMPORTE_URGENCIA_097,
          IMPORTE_BASE_097,
          IMPORTE_IVA_097,
          IMPORTE_TOTAL_097,
          NUM_TOTAL_PAL_FACTURAR_097,
          NUM_PAL_CONCOR_0_84_097,
          NUM_PAL_CONCOR_85_94_097,
          NUM_PAL_CONCOR_95_100_097,
          ANYO_097,
          NUM_EXP_097
        )
        VALUES
        (
          ORDEN_PRECIOS.ID_ORDEN,
          ORDEN_PRECIOS.TARIFA_RELEVANCIA_TRAD,
          ORDEN_PRECIOS.POR_IVA,
          IMPORTE_DIFICULTAD,
          IMPORTE_URGENCIA,
          IMPORTE_BASE,
          IMPORTE_IVA,
          IMPORTE,
          NUM_TOTAL_PAL_FACTURAR,
          NUM_PAL_CONCOR_0_84,
          NUM_PAL_CONCOR_85_94,
          NUM_PAL_CONCOR_95_100,
          ANYO,
          NUM_EXP
        );
    END IF;
  EXCEPTION
  WHEN NO_DATA_FOUND THEN
    IMPORTE := -1;
  END;
  RETURN IMPORTE;
END;

EXIT;