-- ELIMINAMOS LAS COLUMNAS CREADAS
ALTER TABLE AA79B94T00
DROP COLUMN "NIVEL_CALIDAD_094";

ALTER TABLE AA79B94T00
DROP COLUMN "POR_PENAL_CALIDAD_094";

ALTER TABLE AA79B94T00
DROP COLUMN "IMP_PENAL_CALIDAD_094";

-- ELIMINAMOS SECUENCIA DE TABLA A7
DROP SEQUENCE AA79B.AA79BA7Q00;

-- DEJAMOS DESC EU DE TAREA 6 COMO ESTABA 
UPDATE AA79B15S01 SET DESC_EU_015 = 'Interpretazio-lan bat kudeatzea' WHERE ID_015 = 6

-- ELIMINAMOS LA COLUMNA CREADA EN AA79BA3T00
ALTER TABLE AA79BA3T00
DROP COLUMN "TIPO_FACTURACION_0A3" ;

-- LANZAR PL DE VERSION ANTERIOR CREA_TAREAS_DEFECTO
create or replace PROCEDURE CREAR_TAREAS_DEFECTO (
   ANYO IN   NUMBER,
   NUM_EXP IN NUMBER
)
IS

TIPO_EXPEDIENTE VARCHAR2(1);
IND_CORREDACCION VARCHAR2(1);
NUM_TOTAL_PAL_IZO NUMBER(6):= 0;
ID_DATOS_BASICOS NUMBER(1):= 0;
PAL_PRESUPUESTO_TRADOS NUMBER(6):= 0;
NUM_DOC NUMBER(2):= 0;
TIPO_ENTIDAD VARCHAR2(1);
ID_ENTIDAD NUMBER(8);
ID_ENTIDAD_BOE NUMBER(8);

TIPO_INTERPRETACION VARCHAR2(1):= 'I';
TIPO_TRADUCCION VARCHAR2(1):= 'T';
TIPO_REVISION VARCHAR2(1):= 'R';

GESTION_INTERPRETACION NUMBER(2):= 6;
PREPARAR_INTERPRETACION NUMBER(2):= 7;
INTERPRETAR NUMBER(2):= 8;
IS_GESTION_INTERPRETACION BOOLEAN := FALSE;
IS_PREPARAR_INTERPRETACION BOOLEAN := FALSE;
IS_INTERPRETAR BOOLEAN := FALSE;

REVISAR NUMBER(2):= 4;
ENTREGA_CLIENTE_REVISION NUMBER(2):= 20;
IS_REVISAR BOOLEAN := FALSE;
IS_ENTREGA_CLIENTE_REVISION BOOLEAN := FALSE;

PROYECTO_TRADOS NUMBER(2):= 1;
TRADUCIR NUMBER(2):= 2;
CORREDACTAR NUMBER(2):= 3;
ENTREGA_CLIENTE_TRADUCCION NUMBER(2):= 19;
--ACTUALIZAR_MEMORIAS_TRADUCCION NUMBER(2):= 16;
POST_TRADUCCION_BOE NUMBER(2):= 10;
IS_PROYECTO_TRADOS BOOLEAN := FALSE;
IS_TRADUCIR BOOLEAN := FALSE;
IS_CORREDACTAR BOOLEAN := FALSE;
IS_ENTREGA_CLIENTE_TRADUCCION BOOLEAN := FALSE;
--IS_ACT_MEMORIAS_TRAD BOOLEAN := FALSE;
IS_POST_TRAD_BOE BOOLEAN := FALSE;

ESTADO_ASIGNACION_TAREA NUMBER(1):= 1;
TAREA_PENDIENTE_EJECUCION NUMBER(1):= 1;
ID_TAREA NUMBER(20):= 0;

EXPEDIENTE_EN_CURSO NUMBER(1):= 3;
FASE_EXP_PDTE_PROY_TRADOS NUMBER(1):= 6;
ESTADO_BITACORA NUMBER(3);
FECHA_INICIO DATE;
FECHA_FIN DATE;

ORDEN NUMBER(2);

CURSOR C_TIPOS_TAREA IS
	(SELECT ID_TIPO_TAREA_081
	FROM AA79B81S01 WHERE ANYO_081 = ANYO
	AND NUM_EXP_081 = NUM_EXP);

BEGIN
   	
  SELECT ID_TIPO_EXPEDIENTE_051, TIPO_ENTIDAD_054, ID_ENTIDAD_054 INTO TIPO_EXPEDIENTE,  TIPO_ENTIDAD, ID_ENTIDAD FROM AA79B51S01, AA79B54S01 WHERE ANYO_051 = ANYO AND NUM_EXP_051 = NUM_EXP
  AND ANYO_051 = ANYO_054 AND NUM_EXP_051 = NUM_EXP_054;
  
  FOR R_TIPOS_TAREA IN C_TIPOS_TAREA LOOP
    CASE
         WHEN (TIPO_EXPEDIENTE = TIPO_INTERPRETACION) THEN
            
            IF (R_TIPOS_TAREA.ID_TIPO_TAREA_081 = GESTION_INTERPRETACION) THEN
              IS_GESTION_INTERPRETACION := TRUE;
            END IF;
            IF (R_TIPOS_TAREA.ID_TIPO_TAREA_081 = PREPARAR_INTERPRETACION) THEN
              IS_PREPARAR_INTERPRETACION := TRUE;
            END IF;
            IF (R_TIPOS_TAREA.ID_TIPO_TAREA_081 = INTERPRETAR) THEN
              IS_INTERPRETAR := TRUE;
            END IF;
         
         WHEN (TIPO_EXPEDIENTE = TIPO_REVISION) THEN
            
            IF (R_TIPOS_TAREA.ID_TIPO_TAREA_081 = ENTREGA_CLIENTE_REVISION) THEN
              IS_ENTREGA_CLIENTE_REVISION := TRUE;
            END IF;
         
         WHEN (TIPO_EXPEDIENTE = TIPO_TRADUCCION) THEN
            
            IF (R_TIPOS_TAREA.ID_TIPO_TAREA_081 = PROYECTO_TRADOS) THEN
              IS_PROYECTO_TRADOS := TRUE;
            END IF;
            IF (R_TIPOS_TAREA.ID_TIPO_TAREA_081 = TRADUCIR) THEN
              IS_TRADUCIR := TRUE;
            END IF;
            IF (R_TIPOS_TAREA.ID_TIPO_TAREA_081 = ENTREGA_CLIENTE_TRADUCCION) THEN
              IS_ENTREGA_CLIENTE_TRADUCCION := TRUE;
            END IF;
            /*IF (R_TIPOS_TAREA.ID_TIPO_TAREA_081 = ACTUALIZAR_MEMORIAS_TRADUCCION) THEN
              IS_ACT_MEMORIAS_TRAD := TRUE;
            END IF;*/
            IF (R_TIPOS_TAREA.ID_TIPO_TAREA_081 = CORREDACTAR) THEN
              IS_CORREDACTAR := TRUE;
            END IF;
            IF (R_TIPOS_TAREA.ID_TIPO_TAREA_081 = POST_TRADUCCION_BOE) THEN
              IS_POST_TRAD_BOE := TRUE;
            END IF;
        
    END CASE;
  END LOOP;
 
  CASE
       WHEN (TIPO_EXPEDIENTE = TIPO_INTERPRETACION) THEN
          
          IF (IS_GESTION_INTERPRETACION = FALSE) THEN
            SELECT AA79B81Q00.NEXTVAL INTO ID_TAREA FROM dual;
            INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) VALUES (ANYO,null,ESTADO_ASIGNACION_TAREA,TAREA_PENDIENTE_EJECUCION,null,null,null,null,'',ID_TAREA,null,null,'N','N',null,NUM_EXP,null,0,null,GESTION_INTERPRETACION,null,null,null,null);
            INSERT INTO AA79B82T00 (ID_TAREA_082) values (ID_TAREA);
            
            insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) 
			select ID_TAREA, ID_DOC_056 from AA79B56T00 where ANYO_056 = ANYO  AND 
    		NUM_EXP_056 = NUM_EXP AND ID_DOC_REL_056 is null AND ID_DOC_VERSION_056 is null;
            
          END IF;
          
          IF (IS_PREPARAR_INTERPRETACION = FALSE) THEN
            SELECT AA79B81Q00.NEXTVAL INTO ID_TAREA FROM dual;
            
            UPDATE AA79B81S01 set ORDEN_081 = ORDEN_081 + 1 WHERE ORDEN_081 = 1 AND ANYO_081 = ANYO AND NUM_EXP_081 = NUM_EXP;
            
            INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) 
            VALUES (ANYO,null,ESTADO_ASIGNACION_TAREA,TAREA_PENDIENTE_EJECUCION,null,null,null,null,'',ID_TAREA,null,null,'N','N',null,NUM_EXP,null,1,null,PREPARAR_INTERPRETACION,null,null,null,null);
            INSERT INTO AA79B82T00 (ID_TAREA_082) values (ID_TAREA);
            
            insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) 
			select ID_TAREA, ID_DOC_056 from AA79B56T00 where ANYO_056 = ANYO  AND 
    		NUM_EXP_056 = NUM_EXP AND ID_DOC_REL_056 is null AND ID_DOC_VERSION_056 is null;
    		
          END IF;
          
          IF (IS_INTERPRETAR = FALSE) THEN
            SELECT AA79B81Q00.NEXTVAL INTO ID_TAREA FROM dual;            
            
            -- CALCULAMOS EL ORDEN
            SELECT nvl(MAX(ORDEN_081),0) + 1 into orden FROM AA79B81T00, AA79B15T00  WHERE ANYO_081 = ANYO AND NUM_EXP_081 = NUM_EXP AND ID_TIPO_TAREA_081 = ID_015 AND IND_REQ_CIERRE_015 = 'S';
            
             UPDATE AA79B81S01 set ORDEN_081 = ORDEN_081 + 1 WHERE ORDEN_081 = orden AND ANYO_081 = ANYO AND NUM_EXP_081 = NUM_EXP;
            
            SELECT FECHA_INI_052, FECHA_FIN_052 INTO FECHA_INICIO, FECHA_FIN FROM AA79B52S01 WHERE ANYO_052 = ANYO AND NUM_EXP_052 = NUM_EXP;
            INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) 
            VALUES (ANYO,null,ESTADO_ASIGNACION_TAREA,TAREA_PENDIENTE_EJECUCION,null,null,FECHA_FIN,FECHA_INICIO,'',ID_TAREA,null,null,'N','S',null,NUM_EXP,null,ORDEN,null,INTERPRETAR,null,null,null,null);
            INSERT INTO AA79B82T00 (ID_TAREA_082) values (ID_TAREA);
            
            insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) 
			select ID_TAREA, ID_DOC_056 from AA79B56T00 where ANYO_056 = ANYO  AND 
    		NUM_EXP_056 = NUM_EXP AND ID_DOC_REL_056 is null AND ID_DOC_VERSION_056 is null;
    		
          END IF;
       
       WHEN (TIPO_EXPEDIENTE = TIPO_REVISION) THEN
          
          /*IF (IS_REVISAR = FALSE) THEN
            SELECT AA79B81Q00.NEXTVAL INTO ID_TAREA FROM dual;
            INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) VALUES (ANYO,null,ESTADO_ASIGNACION_TAREA,TAREA_PENDIENTE_EJECUCION,null,null,null,null,'',ID_TAREA,null,null,'N','N',null,NUM_EXP,null,1,null,REVISAR,null,null,null,1);
            INSERT INTO AA79B82T00 (ID_TAREA_082) values (ID_TAREA);
            
            insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) 
			select ID_TAREA, ID_DOC_056 from AA79B56T00 where ANYO_056 = ANYO  AND 
    		NUM_EXP_056 = NUM_EXP AND ID_DOC_REL_056 is null AND ID_DOC_VERSION_056 is null;
          END IF;*/
          
          IF (IS_ENTREGA_CLIENTE_REVISION = FALSE) THEN
            SELECT AA79B81Q00.NEXTVAL INTO ID_TAREA FROM dual;
            -- CALCULAMOS EL ORDEN
            SELECT nvl(MAX(ORDEN_081),0) + 1 into orden FROM AA79B81T00, AA79B15T00  WHERE ANYO_081 = ANYO AND NUM_EXP_081 = NUM_EXP AND ID_TIPO_TAREA_081 = ID_015 AND IND_REQ_CIERRE_015 = 'S';
            
            UPDATE AA79B81S01 set ORDEN_081 = ORDEN_081 + 1 WHERE ORDEN_081 = ORDEN AND ANYO_081 = ANYO AND NUM_EXP_081 = NUM_EXP;
            
            INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) VALUES (ANYO,null,ESTADO_ASIGNACION_TAREA,TAREA_PENDIENTE_EJECUCION,null,null,null,null,'',ID_TAREA,null,null,'N','N',null,NUM_EXP,null,ORDEN,null,ENTREGA_CLIENTE_REVISION,null,null,null,1);
            INSERT INTO AA79B82T00 (ID_TAREA_082) values (ID_TAREA);
            
            insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) 
			select ID_TAREA, ID_DOC_056 from AA79B56T00 where ANYO_056 = ANYO  AND 
    		NUM_EXP_056 = NUM_EXP AND ID_DOC_REL_056 is null AND ID_DOC_VERSION_056 is null
    		AND CLASE_DOCUMENTO_056 <> 4 ;
            
          END IF;
          
       WHEN (TIPO_EXPEDIENTE = TIPO_TRADUCCION) THEN
          -- RECUPERAMOS SI ES CORREDACCION	
       	  Select IND_CORREDACCION_053 into IND_CORREDACCION from AA79B53T00 where ANYO_053 = ANYO AND NUM_EXP_053 = NUM_EXP;
       
       	  SELECT COUNT(1) INTO NUM_DOC FROM AA79B56S01 t1 RIGHT JOIN AA79B42S01 t2 ON t1.TIPO_DOCUMENTO_056 = t2.ID_042 
          WHERE t2.IND_ACTUALIZA_MEMORIAS_042 = 'S' AND t1.ANYO_056 = ANYO AND t1.NUM_EXP_056 = NUM_EXP;
          
          SELECT NUM_TOTAL_PAL_IZO_053 INTO NUM_TOTAL_PAL_IZO FROM AA79B53S01 WHERE ANYO_053 = ANYO AND NUM_EXP_053 = NUM_EXP;
          SELECT PAL_TRADOS_003 INTO PAL_PRESUPUESTO_TRADOS FROM AA79B03S01 WHERE ID_003 = ID_DATOS_BASICOS;
                    
          IF (NUM_TOTAL_PAL_IZO > PAL_PRESUPUESTO_TRADOS AND IS_PROYECTO_TRADOS = FALSE) THEN 
            SELECT AA79B81Q00.NEXTVAL INTO ID_TAREA FROM dual;
            INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) VALUES (ANYO,null,ESTADO_ASIGNACION_TAREA,TAREA_PENDIENTE_EJECUCION,null,null,null,null,'',ID_TAREA,null,null,'N','N',null,NUM_EXP,null,0,null,PROYECTO_TRADOS,null,null,null,null);
            INSERT INTO AA79B82T00 (ID_TAREA_082) values (ID_TAREA);
            
            insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) 
			select ID_TAREA, ID_DOC_056 from AA79B56T00 where ANYO_056 = ANYO  AND 
    		NUM_EXP_056 = NUM_EXP AND ID_DOC_REL_056 is null AND ID_DOC_VERSION_056 is null;
            
            SELECT nvl(max(ID_ESTADO_BITACORA_059),0) + 1 INTO ESTADO_BITACORA FROM AA79B59S01 t1 WHERE NUM_EXP_059 = NUM_EXP AND ANYO_059 = ANYO;
            INSERT INTO AA79B59S01 (ANYO_059, NUM_EXP_059, ID_ESTADO_BITACORA_059, ID_ESTADO_EXP_059, ID_FASE_EXPEDIENTE_059, DATO_ADIC_059, INFO_ADIC_059, ID_RECHAZO_059, ID_REQUERIMIENTO_059, FECHA_ALTA_059) VALUES (ANYO,NUM_EXP,ESTADO_BITACORA,EXPEDIENTE_EN_CURSO,FASE_EXP_PDTE_PROY_TRADOS,null,null,null,null, SYSDATE);
            UPDATE AA79B51S01 SET ESTADO_BITACORA_051= ESTADO_BITACORA WHERE ANYO_051 = ANYO AND NUM_EXP_051 = NUM_EXP;
          END IF;
          
          IF (IND_CORREDACCION = 'N') THEN
          
	          IF (IS_TRADUCIR = FALSE) THEN
	          
	          	UPDATE AA79B81S01 set ORDEN_081 = ORDEN_081 + 1 WHERE ORDEN_081 = 1 AND ANYO_081 = ANYO AND NUM_EXP_081 = NUM_EXP;
	          
	            SELECT AA79B81Q00.NEXTVAL INTO ID_TAREA FROM dual;
	            INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) 
	            VALUES (ANYO,null,ESTADO_ASIGNACION_TAREA,TAREA_PENDIENTE_EJECUCION,null,null,null,null,'',ID_TAREA,null,null,'N','S',null,NUM_EXP,null,1,null,TRADUCIR,null,null,null,null);
	            INSERT INTO AA79B82T00 (ID_TAREA_082) values (ID_TAREA);
	            
	            insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) 
				select ID_TAREA, ID_DOC_056 from AA79B56T00 where ANYO_056 = ANYO  AND 
	    		NUM_EXP_056 = NUM_EXP AND ID_DOC_REL_056 is null AND ID_DOC_VERSION_056 is null;
	          END IF;
	          IF (IS_POST_TRAD_BOE = FALSE) THEN
	            SELECT VALOR_000 INTO ID_ENTIDAD_BOE FROM AA79B00T00 WHERE ID_000 = 1;
	            IF (ID_ENTIDAD_BOE = ID_ENTIDAD AND TIPO_ENTIDAD = 'B') THEN
	          	
	            	UPDATE AA79B81S01 set ORDEN_081 = ORDEN_081 + 1 WHERE ORDEN_081 = 2 AND ANYO_081 = ANYO AND NUM_EXP_081 = NUM_EXP;
	            
		          	SELECT AA79B81Q00.NEXTVAL INTO ID_TAREA FROM dual;
		            INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) 
		            VALUES (ANYO,null,ESTADO_ASIGNACION_TAREA,TAREA_PENDIENTE_EJECUCION,null,null,null,null,'',ID_TAREA,null,null,'N','S',null,NUM_EXP,null,2,null,POST_TRADUCCION_BOE,null,null,null,null);
		            INSERT INTO AA79B82T00 (ID_TAREA_082) values (ID_TAREA);
		            
		            insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) 
					select ID_TAREA, ID_DOC_056 from AA79B56T00 where ANYO_056 = ANYO  AND 
		    		NUM_EXP_056 = NUM_EXP AND ID_DOC_REL_056 is null AND ID_DOC_VERSION_056 is null;
		    	END IF;
	          END IF;
	          IF (IS_ENTREGA_CLIENTE_TRADUCCION = FALSE) THEN
	            SELECT AA79B81Q00.NEXTVAL INTO ID_TAREA FROM dual;
	            
	            -- CALCULAMOS EL ORDEN
            	SELECT nvl(MAX(ORDEN_081),0) + 1 into orden FROM AA79B81T00, AA79B15T00  WHERE ANYO_081 = ANYO AND NUM_EXP_081 = NUM_EXP AND ID_TIPO_TAREA_081 = ID_015 AND IND_REQ_CIERRE_015 = 'S';
	            
            	UPDATE AA79B81S01 set ORDEN_081 = ORDEN_081 + 1 WHERE ORDEN_081 = ORDEN AND ANYO_081 = ANYO AND NUM_EXP_081 = NUM_EXP;
            	
	            INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) VALUES (ANYO,null,ESTADO_ASIGNACION_TAREA,TAREA_PENDIENTE_EJECUCION,null,null,null,null,'',ID_TAREA,null,null,'N','N',null,NUM_EXP,null,ORDEN,null,ENTREGA_CLIENTE_TRADUCCION,null,null,null,null);  
	            INSERT INTO AA79B82T00 (ID_TAREA_082) values (ID_TAREA);
	            
	            insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) 
				select ID_TAREA, ID_DOC_056 from AA79B56T00 where ANYO_056 = ANYO  AND 
	    		NUM_EXP_056 = NUM_EXP AND ID_DOC_REL_056 is null AND ID_DOC_VERSION_056 is null
	    		AND CLASE_DOCUMENTO_056 <> 4 ;
	            
	          END IF;
	          
	          
	     END IF;
	     
	     IF (IND_CORREDACCION = 'S') THEN
	          IF (IS_CORREDACTAR = FALSE) THEN
	          
	          	UPDATE AA79B81S01 set ORDEN_081 = ORDEN_081 + 1 WHERE ORDEN_081 = 1 AND ANYO_081 = ANYO AND NUM_EXP_081 = NUM_EXP;
	          	
	            SELECT AA79B81Q00.NEXTVAL INTO ID_TAREA FROM dual;
	            INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) VALUES (ANYO,null,ESTADO_ASIGNACION_TAREA,TAREA_PENDIENTE_EJECUCION,null,null,null,null,'',ID_TAREA,null,null,'N','N',null,NUM_EXP,null,1,null,CORREDACTAR,null,null,null,null);
	            INSERT INTO AA79B82T00 (ID_TAREA_082) values (ID_TAREA);
	            
	            insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) 
				select ID_TAREA, ID_DOC_056 from AA79B56T00 where ANYO_056 = ANYO  AND 
	    		NUM_EXP_056 = NUM_EXP AND ID_DOC_REL_056 is null AND ID_DOC_VERSION_056 is null;
	          END IF;
	          
	     END IF;
  END CASE;
	
END;
/
-- LANZAR PL DE VERSION ANTERIOR CALCULO_IMPORTES_INTER
CREATE OR REPLACE PROCEDURE CALCULO_IMPORTES_INTER (
   ANYO IN   NUMBER,
   NUM_EXP IN NUMBER
)
IS

IMPORTE NUMBER(9,2):=0.0;
IMPORTE_ENTIDAD NUMBER(9,2):=0.0;
IMPORTE_BASE NUMBER(8,2):=0.0;
IMPORTE_BASE_TOTAL NUMBER(8,2):=0.0;
IMPORTE_BASE_ENTIDAD NUMBER(8,2):=0.0;
IMPORTE_IVA NUMBER(8,2):=0.0;
IMPORTE_IVA_ENTIDAD NUMBER(8,2):=0.0;

TIPO_TAREA_INTERPRETACION NUMBER(2):= 8;

NUM_INTERPRETES NUMBER(2):= 0;
HORAS_INTERPRETACION VARCHAR2(150):='00:00';

HORAS_TOTALES NUMBER(9,2):=0.0;

TYPE r_reg_interpretacion IS RECORD (
      TIPO_ACTO NUMBER(2) NULL, 
      TIPO_FACTURACION VARCHAR2(1) NULL,
      IND_PROGRAMADA VARCHAR2(1) NULL,
      TIPO_PETICIONARIO VARCHAR2(1) NULL,
      IND_CAE VARCHAR2(1) NULL
);
INTERPRETACION r_reg_interpretacion;

TYPE r_reg_orden IS RECORD (
     ID_ORDEN NUMBER(4),
    JORN_COMP_HORAS_DESDE NUMBER(1),
    JORN_COMP_HORAS_HASTA NUMBER(1) ,
    JORN_MEDIA_HORAS_DESDE NUMBER(1) ,
    JORN_MEDIA_HORAS_HASTA NUMBER(1) ,
    PREC_MIN_CAE NUMBER(6,2) ,
    PREC_MIN_NO_CAE NUMBER(6,2) ,
    PREC_HORA_REUNION_CAE NUMBER(5,2) ,
    PREC_HORA_REUNION_NO_CAE NUMBER(5,2) ,
    PREC_JORN_CONGRESO_EU NUMBER(6,2) ,
    PREC_MEDIA_CONGRESO_EU NUMBER(6,2) ,
    PREC_HORA_CONGRESO_EU NUMBER(5,2) ,
    PREC_JORN_CONGRESO_NO_EU NUMBER(6,2) ,
    PREC_MEDIA_CONGRESO_NO_EU NUMBER(6,2) ,
    PREC_HORA_CONGRESO_NO_EU NUMBER(5,2),
    POR_IVA NUMBER(3)
);
ORDEN_PRECIOS r_reg_orden;

TIPO_FACTURACION_INTERPRETE VARCHAR2(1):= 'I';
TIPO_FACTURACION_HORA VARCHAR2(1):= 'H';

N_JORNADAS_COMPLETAS NUMBER(3):= 0;
N_JORNADAS_MEDIAS NUMBER(3):= 0;

HORAS NUMBER(7):=0;
MINUTOS NUMBER(2):=0;

PRECIO_MINIMO NUMBER(6,2);

NUEVA_DIRNORA NUMBER(8);

-- SELECCIONAMOS LAS TAREAS DE INTERPREATCION DEL EXPEDIENTE;
CURSOR C_TAREAS IS
(SELECT ID_TAREA_081, HORAS_TAREA_082 FROM AA79B81S01, AA79B82S01 WHERE ID_TAREA_081 = ID_TAREA_082
AND ID_TIPO_TAREA_081 = TIPO_TAREA_INTERPRETACION 
AND ANYO_081 = ANYO AND NUM_EXP_081 = NUM_EXP AND ESTADO_EJECUCION_081 = 3);

-- SELECCIONAMOS LAS ENTIDADES DE FACTURACION DEL EXPEDIENTE;
CURSOR C_ENTIDADES_FACT IS
(SELECT ID_058, TIPO_ENTIDAD_ASOC_058, ID_ENTIDAD_ASOC_058, DNI_CONTACTO_058, POR_FACTURA_058, ent.FACTURABLE AS FACTURABLE, 
ent.IVA AS IVA, nvl(sol.CDIRNORA,ent.CDIRNORA) AS DIRNORA
FROM AA79B58T00, X54JAPI_ENTIDADES_SOLIC ent, X54JAPI_SOLICITANTES sol
WHERE TIPO_ENTIDAD_ASOC_058 = ent.TIPO AND ID_ENTIDAD_ASOC_058 = ent.CODIGO
AND DNI_CONTACTO_058 = sol.DNI (+)
AND ANYO_058 = ANYO AND NUM_EXP_058 = NUM_EXP);

BEGIN
   	
	-- seleccionamos la orden de precios publicos, lo referente a la interpretación
	select ID_ORDEN_035, JORN_COMP_HORAS_DESDE_035, JORN_COMP_HORAS_HASTA_035, JORN_MEDIA_HORAS_DESDE_035, JORN_MEDIA_HORAS_HASTA_035 ,
    PREC_MIN_CAE_035, PREC_MIN_NO_CAE_035, PREC_HORA_REUNION_CAE_035, PREC_HORA_REUNION_NO_CAE_035, PREC_JORN_CONGRESO_EU_035,
    PREC_MEDIA_CONGRESO_EU_035,  PREC_HORA_CONGRESO_EU_035, PREC_JORN_CONGRESO_NO_EU_035, PREC_MEDIA_CONGRESO_NO_EU_035,
    PREC_HORA_CONGRESO_NO_EU_035, POR_IVA_031 into ORDEN_PRECIOS from AA79B35T00, AA79B30T00, AA79B31T00 
    WHERE ID_030 = ID_ORDEN_031 AND ID_030 = ID_ORDEN_035 (+) AND IND_VIGOR_030 = 'S' AND IND_VIGENTE_031 = 'S';
    
    -- obtenemos el tipo de acto
	SELECT TIPO_ACTO_052, TIPO_FACTURACION_008, IND_PROGRAMADA_052, TIPO_PETICIONARIO_052, DECODE(CODPROV_049,'20','S','48','S','01','S','N')  into INTERPRETACION 
	FROM AA79B52T00, AA79B08T00, AA79B49T00 WHERE ANYO_052 = ANYO AND NUM_EXP_052 = NUM_EXP AND TIPO_ACTO_052 = ID_008 AND DIR_NORA_052 = CDIRNORA_049; 
	
	
	FOR R_TAREAS IN C_TAREAS LOOP
		NUM_INTERPRETES:= NUM_INTERPRETES + 1;
		IF (HORAS_INTERPRETACION = '00:00') THEN
			HORAS_INTERPRETACION:= R_TAREAS.HORAS_TAREA_082;
		ELSE
			HORAS_INTERPRETACION:= HORAS_INTERPRETACION ||', '|| R_TAREAS.HORAS_TAREA_082;
		END IF;
		
		HORAS:= TO_NUMBER(SUBSTR(R_TAREAS.HORAS_TAREA_082, 1, INSTR(R_TAREAS.HORAS_TAREA_082, ':')-1));
		MINUTOS:= TO_NUMBER(SUBSTR(R_TAREAS.HORAS_TAREA_082, INSTR(R_TAREAS.HORAS_TAREA_082, ':')+1));
		IF (MINUTOS > 0 ) THEN
			HORAS:= HORAS + 1;
		END IF;
		
		IF (INTERPRETACION.TIPO_FACTURACION = TIPO_FACTURACION_INTERPRETE) THEN
			-- Miramos cuantas jornadas completas enteras hay según el rango de jornadas completas definido.
			N_JORNADAS_COMPLETAS := TRUNC(HORAS/ORDEN_PRECIOS.JORN_COMP_HORAS_HASTA);
			IF (N_JORNADAS_COMPLETAS = 0) THEN
			 -- comprobamos si son horas dentro del rango de jornada completa
			 IF (HORAS >= ORDEN_PRECIOS.JORN_COMP_HORAS_DESDE AND HORAS <= ORDEN_PRECIOS.JORN_COMP_HORAS_HASTA) THEN
			 	N_JORNADAS_COMPLETAS := 1;	
			 	HORAS:= 0; -- no quedan horas pendientes de tarificar
			 END IF;
			ELSE
				HORAS:= HORAS - (N_JORNADAS_COMPLETAS * ORDEN_PRECIOS.JORN_COMP_HORAS_HASTA);
			END IF;
			-- miramos cuantas medias jornadas hay
			N_JORNADAS_MEDIAS := TRUNC(HORAS/ORDEN_PRECIOS.JORN_MEDIA_HORAS_HASTA);
			IF (N_JORNADAS_MEDIAS = 0) THEN
				-- comprobamos si son horas dentro del rango de jornada media
				IF (HORAS >= ORDEN_PRECIOS.JORN_MEDIA_HORAS_DESDE AND HORAS <= ORDEN_PRECIOS.JORN_MEDIA_HORAS_HASTA) THEN
			 		N_JORNADAS_MEDIAS := 1;	
			 		HORAS:= 0; -- no quedan horas pendientes de tarificar
			 	END IF;
			ELSE
				HORAS:= HORAS - (N_JORNADAS_MEDIAS * ORDEN_PRECIOS.JORN_MEDIA_HORAS_HASTA);
			END IF;
			
			IF (INTERPRETACION.IND_PROGRAMADA = 'S' AND INTERPRETACION.TIPO_PETICIONARIO = 'A') THEN
				IMPORTE:= IMPORTE + ((N_JORNADAS_COMPLETAS*ORDEN_PRECIOS.PREC_JORN_CONGRESO_EU) + (N_JORNADAS_MEDIAS*ORDEN_PRECIOS.PREC_MEDIA_CONGRESO_EU) + (HORAS*ORDEN_PRECIOS.PREC_HORA_CONGRESO_EU));
			ELSE
				IMPORTE:= IMPORTE + ((N_JORNADAS_COMPLETAS*ORDEN_PRECIOS.PREC_JORN_CONGRESO_NO_EU) + (N_JORNADAS_MEDIAS*ORDEN_PRECIOS.PREC_MEDIA_CONGRESO_NO_EU) + (HORAS*ORDEN_PRECIOS.PREC_HORA_CONGRESO_NO_EU));
			END IF;
		ELSE
			IF (INTERPRETACION.IND_CAE = 'S') THEN
				IMPORTE:= IMPORTE + (HORAS*ORDEN_PRECIOS.PREC_HORA_REUNION_CAE);
			ELSE
				IMPORTE:= IMPORTE + (HORAS*ORDEN_PRECIOS.PREC_HORA_REUNION_NO_CAE);
	    	END IF;
		END IF;
	END LOOP;
	
	IF (INTERPRETACION.IND_CAE = 'S') THEN
		IF (IMPORTE < ORDEN_PRECIOS.PREC_MIN_CAE) THEN
			IMPORTE:= ORDEN_PRECIOS.PREC_MIN_CAE;
			PRECIO_MINIMO := ORDEN_PRECIOS.PREC_MIN_CAE;
		END IF;
	ELSE
		IF (IMPORTE < ORDEN_PRECIOS.PREC_MIN_NO_CAE) THEN
			IMPORTE:= ORDEN_PRECIOS.PREC_MIN_NO_CAE;
			PRECIO_MINIMO := ORDEN_PRECIOS.PREC_MIN_NO_CAE;
		END IF;
	END IF;
	
	--if (NUM_INTERPRETES > 0) THEN
	IMPORTE_BASE_TOTAL:= round((IMPORTE * 100 / (100 + ORDEN_PRECIOS.POR_IVA)),3);
	
	--END IF;

	IMPORTE_IVA:= 0;
	IMPORTE:= 0;
	IMPORTE_BASE:= 0;
	
	FOR R_ENTIDADES_FACT IN C_ENTIDADES_FACT LOOP
		
		IMPORTE_BASE_ENTIDAD:= round((IMPORTE_BASE_TOTAL * R_ENTIDADES_FACT.POR_FACTURA_058)/100,2);
		IMPORTE_IVA_ENTIDAD:= 0.0;
		IF (R_ENTIDADES_FACT.IVA = 'S') THEN
			IMPORTE_IVA_ENTIDAD:= (IMPORTE_BASE_ENTIDAD * ORDEN_PRECIOS.POR_IVA) / 100;
		END IF;
		IMPORTE_ENTIDAD:= IMPORTE_IVA_ENTIDAD + IMPORTE_BASE_ENTIDAD;
		
		IMPORTE_BASE      := IMPORTE_BASE       + IMPORTE_BASE_ENTIDAD;
		IMPORTE_IVA:= IMPORTE_IVA + IMPORTE_IVA_ENTIDAD;
		IMPORTE:= IMPORTE + IMPORTE_ENTIDAD;
		
		-- copiamos la dirección NORA a nuestra tabla de direcciones
		SELECT AA79B49Q00.nextVal into NUEVA_DIRNORA from dual;
		INSERT into AA79b49T00 (CDIRNORA_049, TIPONORA_049, CODNORA_049, CODPROV_049, CODMUNI_049, CODLOCAL_049, CODPOST_049,
		ESCALER_049, PISO_049, MANO_049, PUERTA_049, APROX_049, TXTCALLE_049, TXTPORTAL_049, CODPAIS_049, TXTPROV_049, TXTCIUDAD_049,
		TXTDIREC_049) SELECT NUEVA_DIRNORA, TIPONORA, CODPORTAL, CODPROVINCIA, CODMUNICIPIO, CODLOCALIDAD, CODPOSTAL, ESCALERA, PISO, MANO, 
		PUERTA, APROX, CALLE, PORTAL, CODPAIS, PROVINCIA, MUNICIPIO, DIRECCION FROM X54JNORA WHERE CDIRNORA = R_ENTIDADES_FACT.DIRNORA;
    		
		INSERT INTO AA79BA6T00 (ID_0A6, DIR_NORA_0A6, IND_FACTURABLE_0A6, IND_IVA_0A6, IMPORTE_BASE_0A6, IMPORTE_IVA_0A6, IMPORTE_TOTAL_0A6)
		VALUES (R_ENTIDADES_FACT.ID_058, NUEVA_DIRNORA, R_ENTIDADES_FACT.FACTURABLE, R_ENTIDADES_FACT.IVA, IMPORTE_BASE_ENTIDAD, IMPORTE_IVA_ENTIDAD, IMPORTE_ENTIDAD );
	END LOOP;
	
	INSERT INTO AA79BA3T00 (ANYO_0A3, NUM_EXP_0A3, ID_ORDEN_0A3, POR_IVA_0A3, PRECIO_MINIMO_0A3, 
	NUM_INTERPRETES_0A3, HORAS_INTERPRETACION_0A3, IMPORTE_BASE_0A3, IMPORTE_IVA_0A3, IMPORTE_TOTAL_0A3, IND_REVISADO_0A3)
	VALUES(ANYO, NUM_EXP,ORDEN_PRECIOS.ID_ORDEN, ORDEN_PRECIOS.POR_IVA, PRECIO_MINIMO, NUM_INTERPRETES, 
	HORAS_INTERPRETACION, round(IMPORTE_BASE,2), IMPORTE_IVA, IMPORTE, 'S');
	
END;
/

create or replace FUNCTION CREAR_TAREAS_RELACIONADAS (
   IDTAREA IN   NUMBER,
   IP IN VARCHAR2,
   USUARIO IN VARCHAR2
)RETURN NUMBER IS


TYPE r_reg_tarea IS RECORD (
    ID_TIPO_TAREA NUMBER(2),
    IND_FACTURABLE VARCHAR2(1),
	RECURSO_ASIGNACION VARCHAR2(1),
	NUM_EXP NUMBER(6),
	ANYO NUMBER(4),
	ORDEN NUMBER(2),
	FECHA_INICIO_081 DATE,
	FECHA_FIN_081 DATE,
	HORAS_PREVISTAS_081 VARCHAR2(10),
    NUM_TOTAL_PAL_IZO_053 NUMBER(6,0),
    IND_TRAMITACION_RAPIDA_029 VARCHAR2(1),
    IND_NO_CONFORMIDAD_081 VARCHAR2(1)
);
TAREA r_reg_tarea;

INTERPRETAR NUMBER(2):= 8;
REVISAR NUMBER(2):= 4;
TRADUCIR NUMBER(2):= 2;
INTRO_PAGO_PROV_INTER NUMBER(2):= 12 ;
REVISION_PAGO_PROV NUMBER(2):= 11;
REVISION_ENTREGA NUMBER(2):= 19;
REVISION_TRADUCCION NUMBER(2):= 21;
TRADUCCION_ENTREGA_CLIENTE NUMBER(2):= 22;
SI VARCHAR2(1):='S';

RECURSO_EXTERNO VARCHAR2(1):= 'P';
RECURSO_INTERNO VARCHAR2(1):= 'I';

ESTADO_TAREA NUMBER(1);
ESTADO_ASIGNACION_TAREA NUMBER(1):= 1;
ESTADO_PDTE_ACEPTACION_TAREA NUMBER(1):= 2;
ESTADO_ACEPTACION_TAREA NUMBER(1):= 3;
TAREA_PENDIENTE_EJECUCION NUMBER(1):= 1;
NUEVO_ID_TAREA NUMBER(20):= 0;
ORDEN NUMBER(2):=0;

DNI_RECURSO VARCHAR2(10);
FECHA_INI_NUEVA_TAREA DATE;
FECHA_FIN_NUEVA_TAREA DATE;

FECHA_ACEPTACION_TAREA DATE;

CONTADOR NUMBER(2):=0;
CONTADOR_ENTREGA NUMBER(2):=0;
INI_OBSERV VARCHAR2(32):= 'Ataza hauek sortu dira: ' || chr(13) || 'id = ';
INI_OBSERV_ELIMINAR VARCHAR2(32):= 'Ataza hauek ezabatu dira: ' || chr(13) || 'id = ';
OBSERV VARCHAR2(15):= ', Ataza mota = ';
FIN_OBSERV VARCHAR2(2):= chr(13);
OBSERVACIONES VARCHAR2(4000):= '';
ID_ESTADO_BITACORA NUMBER(3):= 0;
DESC_TIPO_TAREA VARCHAR2(150):= '';


--Párametros del envío del mail
ID_PROCESO_EMAIL NUMBER(20):= 0;
NUM_EMAIL NUMBER(2):= 1;
TIPO_AVISO NUMBER(2):= 5;
EMAIL_DESTINATARIO VARCHAR2(256);
ID_TIPO_EXPEDIENTE VARCHAR2(1);
TITULO_EXPEDIENTE VARCHAR2(150);
ORIGEN VARCHAR2(1);
APLIC_ORIGEN VARCHAR2(6);
RETORNO NUMBER(20);
TAREA_ENTREGA NUMBER(20);

LIM_PALABRAS NUMBER(6);

BEGIN

-- obtenemos el limite de palabras IZO  a partir del cual se realiza presupuesto y proyecto trados
select  PAL_PRESUPUESTO_003 into LIM_PALABRAS from AA79B03T00 where ID_003 = 0;

 -- OBTENEMOS LOS DATOS DE LA TAREA
SELECT ID_TIPO_TAREA_081, IND_FACTURABLE_081, RECURSO_ASIGNACION_081, NUM_EXP_081, ANYO_081, ORDEN_081, FECHA_INICIO_081, FECHA_FIN_081, HORAS_PREVISTAS_081,NUM_TOTAL_PAL_IZO_053,IND_TRAMITACION_RAPIDA_029,IND_NO_CONFORMIDAD_081 into TAREA
FROM AA79B81T00 T1 LEFT JOIN AA79B53S01 r1 ON t1.ANYO_081 = r1.ANYO_053 AND t1.NUM_EXP_081 = r1.NUM_EXP_053 
LEFT JOIN AA79B29S01 T29 ON t1.ID_LOTE_081   = T29.ID_LOTE_029 WHERE ID_TAREA_081 = IDTAREA;

SELECT ID_TIPO_EXPEDIENTE_051, ORIGEN_051, APLIC_ORIGEN_051, DNI_TECNICO_051, TITULO_051 into ID_TIPO_EXPEDIENTE, ORIGEN, APLIC_ORIGEN, DNI_RECURSO, 
TITULO_EXPEDIENTE FROM AA79B51T00 WHERE ANYO_051 = TAREA.ANYO AND NUM_EXP_051 = TAREA.NUM_EXP;

BEGIN
    SELECT EMAIL_031 into EMAIL_DESTINATARIO FROM X54JAPI_DATOS_CONTACTO WHERE DNI_031 = DNI_RECURSO;
  EXCEPTION
    WHEN NO_DATA_FOUND THEN
    EMAIL_DESTINATARIO := '';
END;

SELECT MAX(ID_ESTADO_BITACORA_059) INTO ID_ESTADO_BITACORA FROM AA79B59T00 WHERE ANYO_059 = TAREA.ANYO AND NUM_EXP_059 = TAREA.NUM_EXP;
 IF (TAREA.ID_TIPO_TAREA = INTERPRETAR) THEN
 	IF (TAREA.RECURSO_ASIGNACION = RECURSO_EXTERNO)	THEN
	 	IF (TAREA.IND_FACTURABLE = SI) THEN
	 		SELECT COUNT(1) INTO CONTADOR FROM AA79B81T00 WHERE ID_TIPO_TAREA_081 = INTRO_PAGO_PROV_INTER AND ID_TAREA_REL_081 = IDTAREA;
	 		IF (CONTADOR = 0) THEN
	 			-- CREAMOS LA TAREA Y ARRASTRAMOS
	 			SELECT AA79B81Q00.NEXTVAL INTO NUEVO_ID_TAREA FROM dual;
            	ORDEN := TAREA.ORDEN + 1;

            	UPDATE AA79B81S01 set ORDEN_081 = ORDEN_081 + 1 WHERE ORDEN_081 >= ORDEN AND ANYO_081 = TAREA.ANYO AND NUM_EXP_081 = TAREA.NUM_EXP;

	            INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) 
	            VALUES (TAREA.ANYO,null,ESTADO_ASIGNACION_TAREA,TAREA_PENDIENTE_EJECUCION,null,null,null,null,'',NUEVO_ID_TAREA,IDTAREA,null,'N','N',null,TAREA.NUM_EXP,null,ORDEN,null,INTRO_PAGO_PROV_INTER,null,null,null,null);
	            INSERT INTO AA79B82T00 (ID_TAREA_082) values (NUEVO_ID_TAREA);

	            insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) 
				select NUEVO_ID_TAREA, ID_DOC_083 from AA79B83T00 where ID_TAREA_083 = IDTAREA;

				SELECT DESC_EU_015 into DESC_TIPO_TAREA FROM AA79B15S01 WHERE ID_015 = INTRO_PAGO_PROV_INTER;

				OBSERVACIONES:= INI_OBSERV || NUEVO_ID_TAREA || OBSERV || DESC_TIPO_TAREA || FIN_OBSERV;

				INSERT INTO AA79B43S01 (ID_REGISTRO_ACCION_043, ID_PUNTO_MENU_043, ID_ACCION_043, IP_043, FECHA_REGISTRO_043, USUARIO_REGISTRO_043, ANYO_EXP_043, NUM_EXP_043,  OBSERV_043, ID_ESTADO_BITACORA_043) 
				VALUES (AA79B43Q00.NEXTVAL,18,1,IP,SYSDATE,USUARIO,TAREA.ANYO,TAREA.NUM_EXP,OBSERVACIONES,ID_ESTADO_BITACORA);
	 		END IF;
	 	ELSE
	 		BEGIN
	            SELECT DESC_EU_015 into DESC_TIPO_TAREA FROM AA79B15S01 WHERE ID_015 = INTRO_PAGO_PROV_INTER;
		 		SELECT ID_TAREA_081 INTO NUEVO_ID_TAREA FROM AA79B81S01 WHERE ID_TIPO_TAREA_081 = INTRO_PAGO_PROV_INTER AND ID_TAREA_REL_081 = IDTAREA;

				OBSERVACIONES:= INI_OBSERV_ELIMINAR || NUEVO_ID_TAREA || OBSERV || DESC_TIPO_TAREA || FIN_OBSERV;

				INSERT INTO AA79B43S01 (ID_REGISTRO_ACCION_043, ID_PUNTO_MENU_043, ID_ACCION_043, IP_043, FECHA_REGISTRO_043, USUARIO_REGISTRO_043, ANYO_EXP_043, NUM_EXP_043,  OBSERV_043, ID_ESTADO_BITACORA_043) 
				VALUES (AA79B43Q00.NEXTVAL,18,2,IP,SYSDATE,USUARIO,TAREA.ANYO,TAREA.NUM_EXP,OBSERVACIONES,ID_ESTADO_BITACORA);
	        EXCEPTION
	        WHEN NO_DATA_FOUND THEN
	        	NUEVO_ID_TAREA := NULL;
	        END;

	 		--ELIMINAMOS LA TAREA
	 		DELETE AA79B81T00 WHERE ID_TIPO_TAREA_081 = INTRO_PAGO_PROV_INTER AND ID_TAREA_REL_081 = IDTAREA;
	 	END IF;
	ELSE
		BEGIN
            SELECT DESC_EU_015 into DESC_TIPO_TAREA FROM AA79B15S01 WHERE ID_015 = INTRO_PAGO_PROV_INTER;
	 		SELECT ID_TAREA_081 INTO NUEVO_ID_TAREA FROM AA79B81S01 WHERE ID_TIPO_TAREA_081 = INTRO_PAGO_PROV_INTER AND ID_TAREA_REL_081 = IDTAREA;

			OBSERVACIONES:= INI_OBSERV_ELIMINAR || NUEVO_ID_TAREA || OBSERV || DESC_TIPO_TAREA || FIN_OBSERV;

			INSERT INTO AA79B43S01 (ID_REGISTRO_ACCION_043, ID_PUNTO_MENU_043, ID_ACCION_043, IP_043, FECHA_REGISTRO_043, USUARIO_REGISTRO_043, ANYO_EXP_043, NUM_EXP_043,  OBSERV_043, ID_ESTADO_BITACORA_043) 
			VALUES (AA79B43Q00.NEXTVAL,18,2,IP,SYSDATE,USUARIO,TAREA.ANYO,TAREA.NUM_EXP,OBSERVACIONES,ID_ESTADO_BITACORA);
        EXCEPTION
        WHEN NO_DATA_FOUND THEN
        	NUEVO_ID_TAREA := NULL;
        END;

		--ELIMINAMOS LA TAREA
	 	DELETE AA79B81T00 WHERE ID_TIPO_TAREA_081 = INTRO_PAGO_PROV_INTER AND ID_TAREA_REL_081 = IDTAREA;
 	END IF;
 ELSIF (TAREA.ID_TIPO_TAREA = REVISAR) THEN
 	IF (TAREA.RECURSO_ASIGNACION = RECURSO_EXTERNO)	THEN
 		IF (TAREA.IND_FACTURABLE = SI) THEN
	 		SELECT COUNT(1) INTO CONTADOR FROM AA79B81T00 WHERE ID_TIPO_TAREA_081 = REVISION_PAGO_PROV AND ID_TAREA_REL_081 = IDTAREA;
	 		IF (CONTADOR = 0) THEN
	 			-- CREAMOS LA TAREA Y ARRASTRAMOS
	 			SELECT AA79B81Q00.NEXTVAL INTO NUEVO_ID_TAREA FROM dual;

            	ORDEN := TAREA.ORDEN + 1;
            	
            	SELECT NVL(fecha_fin_081, SYSDATE), NVL(fecha_fin_081, SYSDATE) + 30/1440 INTO FECHA_INI_NUEVA_TAREA, FECHA_FIN_NUEVA_TAREA FROM aa79b81t00 WHERE anyo_081 = TAREA.ANYO AND num_exp_081 = TAREA.NUM_EXP AND orden_081 = ORDEN -1 ORDER BY fecha_fin_081 DESC FETCH FIRST ROW ONLY;

            	UPDATE AA79B81S01 set ORDEN_081 = ORDEN_081 + 1 WHERE ORDEN_081 >= ORDEN AND ANYO_081 = TAREA.ANYO AND NUM_EXP_081 = TAREA.NUM_EXP;
    
            	ESTADO_TAREA:= ESTADO_PDTE_ACEPTACION_TAREA;
            	FECHA_ACEPTACION_TAREA := null;
            	IF (DNI_RECURSO = USUARIO) THEN
            		ESTADO_TAREA:= ESTADO_ACEPTACION_TAREA;
            		FECHA_ACEPTACION_TAREA := sysdate;
            	END IF;

	            INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, 
	            FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, 
	            OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) 
	            VALUES (TAREA.ANYO,DNI_RECURSO,ESTADO_TAREA,TAREA_PENDIENTE_EJECUCION,FECHA_ACEPTACION_TAREA,sysdate,FECHA_FIN_NUEVA_TAREA,FECHA_INI_NUEVA_TAREA,'00:30',NUEVO_ID_TAREA,IDTAREA,null,'N','N',null,TAREA.NUM_EXP,null,ORDEN,RECURSO_INTERNO,REVISION_PAGO_PROV,null,null,null,null);

	            INSERT INTO AA79B82T00 (ID_TAREA_082) values (NUEVO_ID_TAREA);

	            insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) 
				select NUEVO_ID_TAREA, ID_DOC_083 from AA79B83T00 where ID_TAREA_083 = IDTAREA;

				SELECT DESC_EU_015 into DESC_TIPO_TAREA FROM AA79B15S01 WHERE ID_015 = REVISION_PAGO_PROV;

                IF (DNI_RECURSO <> USUARIO) THEN
                  IF(ID_PROCESO_EMAIL=0) THEN
                        SELECT AA79BB2Q00.NEXTVAL INTO ID_PROCESO_EMAIL FROM dual;
                  END IF;
               
                  INSERT INTO AA79BB2T00 (ID_PROCESO_EMAIL_0B2, NUM_EMAIL_0B2, ID_TIPO_AVISO_0B2, ANYO_0B2, NUM_EXP_0B2, TITULO_EXP_0B2, ID_TAREA_0B2, ID_TIPO_TAREA_0B2, DESC_TAREA_ES_0B2, DESC_TAREA_EU_0B2, DNI_DESTINATARIO_0B2, EMAIL_DESTINATARIO_0B2)
                  VALUES (ID_PROCESO_EMAIL, NUM_EMAIL, TIPO_AVISO, TAREA.ANYO, TAREA.NUM_EXP, TITULO_EXPEDIENTE, NUEVO_ID_TAREA, TAREA.ID_TIPO_TAREA,DESC_TIPO_TAREA, DESC_TIPO_TAREA, DNI_RECURSO, EMAIL_DESTINATARIO);
            
                  NUM_EMAIL:= NUM_EMAIL + 1;
            
                 RETORNO:= ID_PROCESO_EMAIL;
                ELSE 	     
                    RETORNO:= NULL;
               END IF;
       
				OBSERVACIONES:= INI_OBSERV || NUEVO_ID_TAREA || OBSERV || DESC_TIPO_TAREA || FIN_OBSERV;

				INSERT INTO AA79B43S01 (ID_REGISTRO_ACCION_043, ID_PUNTO_MENU_043, ID_ACCION_043, IP_043, FECHA_REGISTRO_043, USUARIO_REGISTRO_043, ANYO_EXP_043, NUM_EXP_043,  OBSERV_043, ID_ESTADO_BITACORA_043) 
				VALUES (AA79B43Q00.NEXTVAL,18,1,IP,SYSDATE,USUARIO,TAREA.ANYO,TAREA.NUM_EXP,OBSERVACIONES,ID_ESTADO_BITACORA);
	 		END IF;
	 	ELSE
	 		BEGIN
	            SELECT DESC_EU_015 into DESC_TIPO_TAREA FROM AA79B15S01 WHERE ID_015 = REVISION_PAGO_PROV;
		 		SELECT ID_TAREA_081 INTO NUEVO_ID_TAREA FROM AA79B81S01 WHERE ID_TIPO_TAREA_081 = REVISION_PAGO_PROV AND ID_TAREA_REL_081 = IDTAREA;

				OBSERVACIONES:= INI_OBSERV_ELIMINAR || NUEVO_ID_TAREA || OBSERV || DESC_TIPO_TAREA || FIN_OBSERV;

				INSERT INTO AA79B43S01 (ID_REGISTRO_ACCION_043, ID_PUNTO_MENU_043, ID_ACCION_043, IP_043, FECHA_REGISTRO_043, USUARIO_REGISTRO_043, ANYO_EXP_043, NUM_EXP_043,  OBSERV_043, ID_ESTADO_BITACORA_043) 
				VALUES (AA79B43Q00.NEXTVAL,18,2,IP,SYSDATE,USUARIO,TAREA.ANYO,TAREA.NUM_EXP,OBSERVACIONES,ID_ESTADO_BITACORA);
	        EXCEPTION
	        WHEN NO_DATA_FOUND THEN
	        	NUEVO_ID_TAREA := NULL;
	        END;

	 		--ELIMINAMOS LA TAREA
	 		DELETE AA79B81T00 WHERE ID_TIPO_TAREA_081 = REVISION_PAGO_PROV AND ID_TAREA_REL_081 = IDTAREA;
	 	END IF;
	ELSE
		BEGIN
            SELECT DESC_EU_015 into DESC_TIPO_TAREA FROM AA79B15S01 WHERE ID_015 = REVISION_PAGO_PROV;
	 		SELECT ID_TAREA_081 INTO NUEVO_ID_TAREA FROM AA79B81S01 WHERE ID_TIPO_TAREA_081 = REVISION_PAGO_PROV AND ID_TAREA_REL_081 = IDTAREA;

			OBSERVACIONES:= INI_OBSERV_ELIMINAR || NUEVO_ID_TAREA || OBSERV || DESC_TIPO_TAREA || FIN_OBSERV;

			INSERT INTO AA79B43S01 (ID_REGISTRO_ACCION_043, ID_PUNTO_MENU_043, ID_ACCION_043, IP_043, FECHA_REGISTRO_043, USUARIO_REGISTRO_043, ANYO_EXP_043, NUM_EXP_043,  OBSERV_043, ID_ESTADO_BITACORA_043) 
			VALUES (AA79B43Q00.NEXTVAL,18,2,IP,SYSDATE,USUARIO,TAREA.ANYO,TAREA.NUM_EXP,OBSERVACIONES,ID_ESTADO_BITACORA);
        EXCEPTION
        WHEN NO_DATA_FOUND THEN
        	NUEVO_ID_TAREA := NULL;
        END;

		--ELIMINAMOS LA TAREA
	 	DELETE AA79B81T00 WHERE ID_TIPO_TAREA_081 = REVISION_PAGO_PROV AND ID_TAREA_REL_081 = IDTAREA;
 	END IF;

 ELSIF (TAREA.ID_TIPO_TAREA = TRADUCIR) THEN
 IF (TAREA.RECURSO_ASIGNACION = RECURSO_EXTERNO)	THEN
 	SELECT COUNT(1) INTO CONTADOR FROM AA79B81T00 WHERE ID_TIPO_TAREA_081 = REVISION_TRADUCCION AND ID_TAREA_REL_081 = IDTAREA;
    SELECT COUNT(1) INTO CONTADOR_ENTREGA FROM AA79B81T00 WHERE ID_TIPO_TAREA_081 IN (REVISION_ENTREGA,TRADUCCION_ENTREGA_CLIENTE) AND ANYO_081 = TAREA.ANYO AND NUM_EXP_081 = TAREA.NUM_EXP AND IND_NO_CONFORMIDAD_081 = 'N';
 	IF (CONTADOR = 0) THEN
 		-- CREAMOS LA TAREA Y ARRASTRAMOS
 		SELECT AA79B81Q00.NEXTVAL INTO NUEVO_ID_TAREA FROM dual;
	    ORDEN := TAREA.ORDEN + 1;
	    
	    SELECT NVL(fecha_fin_081, SYSDATE), NVL(fecha_fin_081, SYSDATE) + 30/1440 INTO FECHA_INI_NUEVA_TAREA, FECHA_FIN_NUEVA_TAREA FROM aa79b81t00 WHERE anyo_081 = TAREA.ANYO AND num_exp_081 = TAREA.NUM_EXP AND orden_081 = ORDEN -1 ORDER BY fecha_fin_081 DESC FETCH FIRST ROW ONLY;
	    
	    UPDATE AA79B81S01 set ORDEN_081 = ORDEN_081 + 1 WHERE ORDEN_081 >= ORDEN AND ANYO_081 = TAREA.ANYO AND NUM_EXP_081 = TAREA.NUM_EXP;

        IF(TAREA.NUM_TOTAL_PAL_IZO_053 <= LIM_PALABRAS AND TAREA.IND_TRAMITACION_RAPIDA_029 = 'S') THEN 
             ESTADO_TAREA:= ESTADO_PDTE_ACEPTACION_TAREA;
             FECHA_ACEPTACION_TAREA := null;
            	IF (DNI_RECURSO = USUARIO) THEN
            		ESTADO_TAREA:= ESTADO_ACEPTACION_TAREA;
            		FECHA_ACEPTACION_TAREA := sysdate;
            	END IF;
            	
            INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) 
            VALUES (TAREA.ANYO,DNI_RECURSO,ESTADO_TAREA,TAREA_PENDIENTE_EJECUCION,FECHA_ACEPTACION_TAREA,sysdate,FECHA_FIN_NUEVA_TAREA,FECHA_INI_NUEVA_TAREA,'00:30',NUEVO_ID_TAREA,IDTAREA,null,'N','N',null,TAREA.NUM_EXP,null,ORDEN,RECURSO_INTERNO,REVISION_TRADUCCION,null,null,null,null);
        ELSE
            INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) 
            VALUES (TAREA.ANYO,NULL,ESTADO_ASIGNACION_TAREA,TAREA_PENDIENTE_EJECUCION,null,null,null,null,'',NUEVO_ID_TAREA,IDTAREA,null,'N','N',null,TAREA.NUM_EXP,null,ORDEN,null,REVISION_TRADUCCION,null,null,null,null);        
        END IF;
       
        INSERT INTO AA79B82T00 (ID_TAREA_082) values (NUEVO_ID_TAREA);
	    insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) 
	    select NUEVO_ID_TAREA, ID_DOC_083 from AA79B83T00 where ID_TAREA_083 = IDTAREA;

	    SELECT DESC_EU_015 into DESC_TIPO_TAREA FROM AA79B15S01 WHERE ID_015 = REVISION_TRADUCCION;

        IF (DNI_RECURSO <> USUARIO) THEN
          IF(ID_PROCESO_EMAIL=0) THEN
            SELECT AA79BB2Q00.NEXTVAL INTO ID_PROCESO_EMAIL FROM dual;
          END IF;
          INSERT INTO AA79BB2T00 (ID_PROCESO_EMAIL_0B2, NUM_EMAIL_0B2, ID_TIPO_AVISO_0B2, ANYO_0B2, NUM_EXP_0B2, TITULO_EXP_0B2, ID_TAREA_0B2, ID_TIPO_TAREA_0B2, DESC_TAREA_ES_0B2, DESC_TAREA_EU_0B2, DNI_DESTINATARIO_0B2, EMAIL_DESTINATARIO_0B2)
          VALUES (ID_PROCESO_EMAIL, NUM_EMAIL, TIPO_AVISO, TAREA.ANYO, TAREA.NUM_EXP, TITULO_EXPEDIENTE, NUEVO_ID_TAREA, TAREA.ID_TIPO_TAREA,DESC_TIPO_TAREA, DESC_TIPO_TAREA, DNI_RECURSO, EMAIL_DESTINATARIO);
    
          NUM_EMAIL:= NUM_EMAIL + 1;
    
         RETORNO:= ID_PROCESO_EMAIL;
        ELSE 	     
            RETORNO:= NULL;
       END IF;


		OBSERVACIONES:= INI_OBSERV || NUEVO_ID_TAREA || OBSERV || DESC_TIPO_TAREA || FIN_OBSERV;

	    INSERT INTO AA79B43S01 (ID_REGISTRO_ACCION_043, ID_PUNTO_MENU_043, ID_ACCION_043, IP_043, FECHA_REGISTRO_043, USUARIO_REGISTRO_043, ANYO_EXP_043, NUM_EXP_043,  OBSERV_043, ID_ESTADO_BITACORA_043) 
		VALUES (AA79B43Q00.NEXTVAL,18,1,IP,SYSDATE,USUARIO,TAREA.ANYO,TAREA.NUM_EXP,OBSERVACIONES,ID_ESTADO_BITACORA);

	ELSIF (TAREA.ID_TIPO_TAREA = REVISION_PAGO_PROV OR TAREA.ID_TIPO_TAREA = REVISION_TRADUCCION) THEN

		SELECT t1.ID_TAREA_081 INTO TAREA_ENTREGA FROM AA79B81T00 t1 JOIN AA79B81T00 t2 ON t2.NUM_EXP_081 = t1.NUM_EXP_081 AND t2.ANYO_081 = t1.ANYO_081 AND t2.ORDEN_081 < t1.ORDEN_081 AND t2.ID_TAREA_081 = IDTAREA WHERE t1.ID_TIPO_TAREA_081 in (REVISION_ENTREGA,TRADUCCION_ENTREGA_CLIENTE) ORDER BY t1.ORDEN_081 ASC FETCH FIRST ROW ONLY;
		
		SELECT COUNT(1) INTO CONTADOR FROM AA79B81T00 WHERE ID_TIPO_TAREA_081 = REVISION_PAGO_PROV AND ANYO_081 = TAREA.ANYO AND NUM_EXP_081 = TAREA.NUM_EXP;
	 		
		IF (CONTADOR = 0) THEN
	 		
			SELECT RECURSO_ASIGNACION_081, DNI_RECURSO_081, NVL(fecha_fin_081, SYSDATE), NVL(fecha_fin_081, SYSDATE) + 30/1440 INTO RECURSO_INTERNO, DNI_RECURSO, FECHA_INI_NUEVA_TAREA, FECHA_FIN_NUEVA_TAREA FROM AA79B81T00 WHERE ID_TIPO_TAREA_081 = REVISION_TRADUCCION AND ANYO_081 = TAREA.ANYO AND NUM_EXP_081 = TAREA.NUM_EXP;

		ELSE
		
			SELECT RECURSO_ASIGNACION_081, DNI_RECURSO_081 INTO RECURSO_INTERNO, DNI_RECURSO FROM AA79B81T00 WHERE ID_TIPO_TAREA_081 = REVISION_TRADUCCION AND ANYO_081 = TAREA.ANYO AND NUM_EXP_081 = TAREA.NUM_EXP;
			
			SELECT NVL(fecha_fin_081, SYSDATE), NVL(fecha_fin_081, SYSDATE) + 30/1440 INTO FECHA_INI_NUEVA_TAREA, FECHA_FIN_NUEVA_TAREA FROM AA79B81T00 WHERE ID_TIPO_TAREA_081 = REVISION_PAGO_PROV AND ANYO_081 = TAREA.ANYO AND NUM_EXP_081 = TAREA.NUM_EXP;
		
		END IF;
		
		ESTADO_TAREA:= ESTADO_PDTE_ACEPTACION_TAREA;
        FECHA_ACEPTACION_TAREA := null;
    	IF (DNI_RECURSO = USUARIO) THEN
    		ESTADO_TAREA:= ESTADO_ACEPTACION_TAREA;
    		FECHA_ACEPTACION_TAREA := sysdate;
    	END IF;
		
		UPDATE AA79B81T00 set RECURSO_ASIGNACION_081 = RECURSO_INTERNO, DNI_RECURSO_081 = DNI_RECURSO, ESTADO_ASIGNACION_081 = ESTADO_TAREA, FECHA_ACEPTACION_081 = FECHA_ACEPTACION_TAREA, 
	    FECHA_ASIGNACION_081=sysdate, FECHA_FIN_081 = FECHA_FIN_NUEVA_TAREA, FECHA_INICIO_081 = FECHA_INI_NUEVA_TAREA, HORAS_PREVISTAS_081= '00:30'
	   	WHERE ID_TAREA_081 = TAREA_ENTREGA;
		
	ELSE
		-- RECUPERO SU ORDEN PARA ASIGNAR LUEGO EL MISMO
		SELECT ORDEN_081 INTO ORDEN FROM AA79B81T00 WHERE ID_TIPO_TAREA_081 = REVISION_TRADUCCION AND ID_TAREA_REL_081 = IDTAREA;
	END IF;
 		IF (TAREA.IND_FACTURABLE = SI) THEN
	 		SELECT COUNT(1) INTO CONTADOR FROM AA79B81T00 WHERE ID_TIPO_TAREA_081 = REVISION_PAGO_PROV AND ID_TAREA_REL_081 = IDTAREA;
	 		IF (CONTADOR = 0) THEN
	 			-- CREAMOS LA TAREA Y ARRASTRAMOS
	 			SELECT AA79B81Q00.NEXTVAL INTO NUEVO_ID_TAREA FROM dual;
                ORDEN := ORDEN + 1;

                SELECT NVL(fecha_fin_081, SYSDATE), NVL(fecha_fin_081, SYSDATE) + 30/1440 INTO FECHA_INI_NUEVA_TAREA, FECHA_FIN_NUEVA_TAREA FROM aa79b81t00 WHERE anyo_081 = TAREA.ANYO AND num_exp_081 = TAREA.NUM_EXP AND orden_081 = ORDEN -1 ORDER BY fecha_fin_081 DESC FETCH FIRST ROW ONLY;
	 		
	    		UPDATE AA79B81S01 set ORDEN_081 = ORDEN_081 + 1 WHERE ORDEN_081 >= ORDEN AND ANYO_081 = TAREA.ANYO AND NUM_EXP_081 = TAREA.NUM_EXP;
                                
                ESTADO_TAREA:= ESTADO_PDTE_ACEPTACION_TAREA;
                FECHA_ACEPTACION_TAREA := null;
            	IF (DNI_RECURSO = USUARIO) THEN
            		ESTADO_TAREA:= ESTADO_ACEPTACION_TAREA;
            		FECHA_ACEPTACION_TAREA := sysdate;
            	END IF;
            	
	            INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) 
	            VALUES (TAREA.ANYO,DNI_RECURSO,ESTADO_TAREA,TAREA_PENDIENTE_EJECUCION,FECHA_ACEPTACION_TAREA,sysdate,FECHA_FIN_NUEVA_TAREA,FECHA_INI_NUEVA_TAREA,'00:30',NUEVO_ID_TAREA,IDTAREA,null,'N','N',null,TAREA.NUM_EXP,null,ORDEN,RECURSO_INTERNO,REVISION_PAGO_PROV,null,null,null,null);
	            INSERT INTO AA79B82T00 (ID_TAREA_082) values (NUEVO_ID_TAREA);

	            insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) 
				select NUEVO_ID_TAREA, ID_DOC_083 from AA79B83T00 where ID_TAREA_083 = IDTAREA;

				SELECT DESC_EU_015 into DESC_TIPO_TAREA FROM AA79B15S01 WHERE ID_015 = REVISION_PAGO_PROV;

         
                IF (DNI_RECURSO <> USUARIO) THEN
                IF(ID_PROCESO_EMAIL=0) THEN
                      SELECT AA79BB2Q00.NEXTVAL INTO ID_PROCESO_EMAIL FROM dual;
                  END IF;    
                  INSERT INTO AA79BB2T00 (ID_PROCESO_EMAIL_0B2, NUM_EMAIL_0B2, ID_TIPO_AVISO_0B2, ANYO_0B2, NUM_EXP_0B2, TITULO_EXP_0B2, ID_TAREA_0B2, ID_TIPO_TAREA_0B2, DESC_TAREA_ES_0B2, DESC_TAREA_EU_0B2, DNI_DESTINATARIO_0B2, EMAIL_DESTINATARIO_0B2)
                  VALUES (ID_PROCESO_EMAIL, NUM_EMAIL, TIPO_AVISO, TAREA.ANYO, TAREA.NUM_EXP, TITULO_EXPEDIENTE, NUEVO_ID_TAREA, TAREA.ID_TIPO_TAREA,DESC_TIPO_TAREA, DESC_TIPO_TAREA, DNI_RECURSO, EMAIL_DESTINATARIO);
	        
                  NUM_EMAIL:= NUM_EMAIL + 1;
	        
                 RETORNO:= ID_PROCESO_EMAIL;
                ELSE 	     
                    RETORNO:= NULL;
               END IF;

				OBSERVACIONES:= INI_OBSERV || NUEVO_ID_TAREA || OBSERV || DESC_TIPO_TAREA || FIN_OBSERV;

				INSERT INTO AA79B43S01 (ID_REGISTRO_ACCION_043, ID_PUNTO_MENU_043, ID_ACCION_043, IP_043, FECHA_REGISTRO_043, USUARIO_REGISTRO_043, ANYO_EXP_043, NUM_EXP_043,  OBSERV_043, ID_ESTADO_BITACORA_043) 
				VALUES (AA79B43Q00.NEXTVAL,18,1,IP,SYSDATE,USUARIO,TAREA.ANYO,TAREA.NUM_EXP,OBSERVACIONES,ID_ESTADO_BITACORA);
	 		END IF;
	 	ELSE
	 		BEGIN
	            SELECT DESC_EU_015 into DESC_TIPO_TAREA FROM AA79B15S01 WHERE ID_015 = REVISION_PAGO_PROV;
		 		SELECT ID_TAREA_081 INTO NUEVO_ID_TAREA FROM AA79B81S01 WHERE ID_TIPO_TAREA_081 = REVISION_PAGO_PROV AND ID_TAREA_REL_081 = IDTAREA;

				OBSERVACIONES:= INI_OBSERV_ELIMINAR || NUEVO_ID_TAREA || OBSERV || DESC_TIPO_TAREA || FIN_OBSERV;

				INSERT INTO AA79B43S01 (ID_REGISTRO_ACCION_043, ID_PUNTO_MENU_043, ID_ACCION_043, IP_043, FECHA_REGISTRO_043, USUARIO_REGISTRO_043, ANYO_EXP_043, NUM_EXP_043,  OBSERV_043, ID_ESTADO_BITACORA_043) 
				VALUES (AA79B43Q00.NEXTVAL,18,2,IP,SYSDATE,USUARIO,TAREA.ANYO,TAREA.NUM_EXP,OBSERVACIONES,ID_ESTADO_BITACORA);
	        EXCEPTION
	        WHEN NO_DATA_FOUND THEN
	        	NUEVO_ID_TAREA := NULL;
	        END;	

	 		--ELIMINAMOS LA TAREA
	 		DELETE AA79B81T00 WHERE ID_TIPO_TAREA_081 = REVISION_PAGO_PROV AND ID_TAREA_REL_081 = IDTAREA;
	 	END IF;
	 	
	 IF (TAREA.NUM_TOTAL_PAL_IZO_053 < LIM_PALABRAS AND TAREA.IND_TRAMITACION_RAPIDA_029 = 'S') THEN	
     	IF (CONTADOR_ENTREGA = 0)   THEN
	 		-- CREAMOS LA TAREA Y ARRASTRAMOS
	 		SELECT AA79B81Q00.NEXTVAL INTO NUEVO_ID_TAREA FROM dual;
		    ORDEN := ORDEN + 1;
	
		    SELECT NVL(fecha_fin_081, SYSDATE), NVL(fecha_fin_081, SYSDATE) + 30/1440 INTO FECHA_INI_NUEVA_TAREA, FECHA_FIN_NUEVA_TAREA FROM aa79b81t00 WHERE anyo_081 = TAREA.ANYO AND num_exp_081 = TAREA.NUM_EXP AND orden_081 = ORDEN -1 ORDER BY fecha_fin_081 DESC FETCH FIRST ROW ONLY;
		    
		    UPDATE AA79B81S01 set ORDEN_081 = ORDEN_081 + 1 WHERE ORDEN_081 >= ORDEN AND ANYO_081 = TAREA.ANYO AND NUM_EXP_081 = TAREA.NUM_EXP;
	
	        ESTADO_TAREA:= ESTADO_PDTE_ACEPTACION_TAREA;
	        FECHA_ACEPTACION_TAREA := null;
	    	IF (DNI_RECURSO = USUARIO) THEN
	    		ESTADO_TAREA:= ESTADO_ACEPTACION_TAREA;
	    		FECHA_ACEPTACION_TAREA := sysdate;
	    	END IF;
	            	
	        INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) 
	         VALUES (TAREA.ANYO,DNI_RECURSO,ESTADO_TAREA,TAREA_PENDIENTE_EJECUCION,FECHA_ACEPTACION_TAREA,sysdate,FECHA_FIN_NUEVA_TAREA,FECHA_INI_NUEVA_TAREA,'00:30',NUEVO_ID_TAREA,null,null,'N','N',null,TAREA.NUM_EXP,null,ORDEN,RECURSO_INTERNO,REVISION_ENTREGA,null,null,null,null);
	    
	        INSERT INTO AA79B82T00 (ID_TAREA_082) values (NUEVO_ID_TAREA);
		    insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) 
		    select NUEVO_ID_TAREA, ID_DOC_083 from AA79B83T00 where ID_TAREA_083 = IDTAREA;
	
		    SELECT DESC_EU_015 into DESC_TIPO_TAREA FROM AA79B15S01 WHERE ID_015 = REVISION_ENTREGA;
	
			OBSERVACIONES:= INI_OBSERV || NUEVO_ID_TAREA || OBSERV || DESC_TIPO_TAREA || FIN_OBSERV;
	
	        IF (DNI_RECURSO <> USUARIO) THEN
	          IF(ID_PROCESO_EMAIL=0) THEN
	            SELECT AA79BB2Q00.NEXTVAL INTO ID_PROCESO_EMAIL FROM dual;
	          END IF;          
	          INSERT INTO AA79BB2T00 (ID_PROCESO_EMAIL_0B2, NUM_EMAIL_0B2, ID_TIPO_AVISO_0B2, ANYO_0B2, NUM_EXP_0B2, TITULO_EXP_0B2, ID_TAREA_0B2, ID_TIPO_TAREA_0B2, DESC_TAREA_ES_0B2, DESC_TAREA_EU_0B2, DNI_DESTINATARIO_0B2, EMAIL_DESTINATARIO_0B2)
	          VALUES (ID_PROCESO_EMAIL, NUM_EMAIL, TIPO_AVISO, TAREA.ANYO, TAREA.NUM_EXP, TITULO_EXPEDIENTE, NUEVO_ID_TAREA, TAREA.ID_TIPO_TAREA,DESC_TIPO_TAREA, DESC_TIPO_TAREA, DNI_RECURSO, EMAIL_DESTINATARIO);
	    
	          NUM_EMAIL:= NUM_EMAIL + 1;
	    
	         RETORNO:= ID_PROCESO_EMAIL;
	        ELSE 	     
	            RETORNO:= NULL;
	       END IF;
		    INSERT INTO AA79B43S01 (ID_REGISTRO_ACCION_043, ID_PUNTO_MENU_043, ID_ACCION_043, IP_043, FECHA_REGISTRO_043, USUARIO_REGISTRO_043, ANYO_EXP_043, NUM_EXP_043,  OBSERV_043, ID_ESTADO_BITACORA_043) 
			VALUES (AA79B43Q00.NEXTVAL,18,1,IP,SYSDATE,USUARIO,TAREA.ANYO,TAREA.NUM_EXP,OBSERVACIONES,ID_ESTADO_BITACORA);
	
		ELSE
			-- LA TAREA EXISTE PERO LA ASIGNAMOS.
			SELECT ID_TAREA_081, ORDEN_081 INTO NUEVO_ID_TAREA, ORDEN FROM AA79B81T00 WHERE ID_TIPO_TAREA_081 IN (REVISION_ENTREGA,TRADUCCION_ENTREGA_CLIENTE) AND ANYO_081 = TAREA.ANYO AND NUM_EXP_081 = TAREA.NUM_EXP AND TAREA.IND_NO_CONFORMIDAD_081 = 'N';	
	
		    SELECT NVL(fecha_fin_081, SYSDATE), NVL(fecha_fin_081, SYSDATE) + 30/1440 INTO FECHA_INI_NUEVA_TAREA, FECHA_FIN_NUEVA_TAREA FROM aa79b81t00 WHERE anyo_081 = TAREA.ANYO AND num_exp_081 = TAREA.NUM_EXP AND orden_081 = ORDEN -1 ORDER BY fecha_fin_081 DESC FETCH FIRST ROW ONLY;
			
			
			
			SELECT NVL(fecha_fin_081, SYSDATE), NVL(fecha_fin_081, SYSDATE) + 30/1440 INTO FECHA_INI_NUEVA_TAREA, FECHA_FIN_NUEVA_TAREA FROM aa79b81t00 WHERE anyo_081 = TAREA.ANYO AND num_exp_081 = TAREA.NUM_EXP AND orden_081 = ORDEN -1 ORDER BY fecha_fin_081 DESC FETCH FIRST ROW ONLY;
	    	
	    	ESTADO_TAREA:= ESTADO_PDTE_ACEPTACION_TAREA;
	        FECHA_ACEPTACION_TAREA := null;
	    	IF (DNI_RECURSO = USUARIO) THEN
	    		ESTADO_TAREA:= ESTADO_ACEPTACION_TAREA;
	    		FECHA_ACEPTACION_TAREA := sysdate;
	    	END IF;
	    	
	        UPDATE AA79B81T00 set ESTADO_ASIGNACION_081 = ESTADO_TAREA, ESTADO_EJECUCION_081 = TAREA_PENDIENTE_EJECUCION, FECHA_ACEPTACION_081 = FECHA_ACEPTACION_TAREA, 
	        FECHA_ASIGNACION_081=sysdate, FECHA_FIN_081 = FECHA_FIN_NUEVA_TAREA, FECHA_INICIO_081 = FECHA_INI_NUEVA_TAREA, HORAS_PREVISTAS_081= '00:30',
	        DNI_RECURSO_081 = DNI_RECURSO, RECURSO_ASIGNACION_081 = RECURSO_INTERNO, ID_TIPO_TAREA_081 = REVISION_ENTREGA
	    	WHERE ID_TAREA_081 = NUEVO_ID_TAREA;
	    	
	    	SELECT DESC_EU_015 into DESC_TIPO_TAREA FROM AA79B15S01 WHERE ID_015 = REVISION_ENTREGA;
	
			OBSERVACIONES:= INI_OBSERV || NUEVO_ID_TAREA || OBSERV || DESC_TIPO_TAREA || FIN_OBSERV;
	
	        IF (DNI_RECURSO <> USUARIO) THEN
	          IF(ID_PROCESO_EMAIL=0) THEN
	            SELECT AA79BB2Q00.NEXTVAL INTO ID_PROCESO_EMAIL FROM dual;  
	          END IF;          
	          INSERT INTO AA79BB2T00 (ID_PROCESO_EMAIL_0B2, NUM_EMAIL_0B2, ID_TIPO_AVISO_0B2, ANYO_0B2, NUM_EXP_0B2, TITULO_EXP_0B2, ID_TAREA_0B2, ID_TIPO_TAREA_0B2, DESC_TAREA_ES_0B2, DESC_TAREA_EU_0B2, DNI_DESTINATARIO_0B2, EMAIL_DESTINATARIO_0B2)
	          VALUES (ID_PROCESO_EMAIL, NUM_EMAIL, TIPO_AVISO, TAREA.ANYO, TAREA.NUM_EXP, TITULO_EXPEDIENTE, NUEVO_ID_TAREA, TAREA.ID_TIPO_TAREA,DESC_TIPO_TAREA, DESC_TIPO_TAREA, DNI_RECURSO, EMAIL_DESTINATARIO);
	    
	          NUM_EMAIL:= NUM_EMAIL + 1;
	    
	         RETORNO:= ID_PROCESO_EMAIL;
	        ELSE 	     
	            RETORNO:= NULL;
	       END IF;
		    INSERT INTO AA79B43S01 (ID_REGISTRO_ACCION_043, ID_PUNTO_MENU_043, ID_ACCION_043, IP_043, FECHA_REGISTRO_043, USUARIO_REGISTRO_043, ANYO_EXP_043, NUM_EXP_043,  OBSERV_043, ID_ESTADO_BITACORA_043) 
			VALUES (AA79B43Q00.NEXTVAL,18,1,IP,SYSDATE,USUARIO,TAREA.ANYO,TAREA.NUM_EXP,OBSERVACIONES,ID_ESTADO_BITACORA);
	    	
	    	
			
		END IF;
	END IF;
	ELSE
		BEGIN
            SELECT DESC_EU_015 into DESC_TIPO_TAREA FROM AA79B15S01 WHERE ID_015 = REVISION_TRADUCCION;
            SELECT ID_TAREA_081 INTO NUEVO_ID_TAREA FROM AA79B81S01 WHERE ID_TIPO_TAREA_081 = REVISION_TRADUCCION AND ID_TAREA_REL_081 = IDTAREA;

            OBSERVACIONES:= INI_OBSERV_ELIMINAR || NUEVO_ID_TAREA || OBSERV || DESC_TIPO_TAREA || FIN_OBSERV;

			INSERT INTO AA79B43S01 (ID_REGISTRO_ACCION_043, ID_PUNTO_MENU_043, ID_ACCION_043, IP_043, FECHA_REGISTRO_043, USUARIO_REGISTRO_043, ANYO_EXP_043, NUM_EXP_043,  OBSERV_043, ID_ESTADO_BITACORA_043) 
			VALUES (AA79B43Q00.NEXTVAL,18,2,IP,SYSDATE,USUARIO,TAREA.ANYO,TAREA.NUM_EXP,OBSERVACIONES,ID_ESTADO_BITACORA);

			SELECT DESC_EU_015 into DESC_TIPO_TAREA FROM AA79B15S01 WHERE ID_015 = REVISION_PAGO_PROV;
	 		SELECT ID_TAREA_081 INTO NUEVO_ID_TAREA FROM AA79B81S01 WHERE ID_TIPO_TAREA_081 = REVISION_PAGO_PROV AND ID_TAREA_REL_081 = IDTAREA;

			OBSERVACIONES:= INI_OBSERV_ELIMINAR || NUEVO_ID_TAREA || OBSERV || DESC_TIPO_TAREA || FIN_OBSERV;

			INSERT INTO AA79B43S01 (ID_REGISTRO_ACCION_043, ID_PUNTO_MENU_043, ID_ACCION_043, IP_043, FECHA_REGISTRO_043, USUARIO_REGISTRO_043, ANYO_EXP_043, NUM_EXP_043,  OBSERV_043, ID_ESTADO_BITACORA_043) 
			VALUES (AA79B43Q00.NEXTVAL,18,2,IP,SYSDATE,USUARIO,TAREA.ANYO,TAREA.NUM_EXP,OBSERVACIONES,ID_ESTADO_BITACORA);
        EXCEPTION
        WHEN NO_DATA_FOUND THEN
        	NUEVO_ID_TAREA := NULL;
        END;

		--ELIMINAMOS LA TAREA
	 	DELETE AA79B81T00 WHERE ID_TIPO_TAREA_081 = REVISION_TRADUCCION AND ID_TAREA_REL_081 = IDTAREA;
	 	DELETE AA79B81T00 WHERE ID_TIPO_TAREA_081 = REVISION_PAGO_PROV AND ID_TAREA_REL_081 = IDTAREA;  
 	END IF; 	
END IF;

RETURN RETORNO;

 EXCEPTION
        WHEN NO_DATA_FOUND THEN
        	RETURN NULL;
END;
/

exit;