CREATE OR REPLACE VIEW INF_SITUACION_TRAD_REV ( 
URTEA, ESPEDIENTEA, ESPEDIENTE_MOTA, HIZKUNTZA_XEDEA, ESKATZAILEA, 
ESKATZAILE_MOTA, ESKATZAILE_HARREMANETARAKO, ESKATZAILE_HARREMANETARAKO_NAN,
ATAZA, NORI_ESLEITUA_ZENBAKIA, NORI_ESLEITUA, ESKAERA_DATA, AMAIERA_DATA, 
HITZ_KOPURUA_BEZEROA, HITZ_KOPURUA_IZO, 
TRADOS_EXPEDIENTE_0_84,
TRADOS_EXPEDIENTE_85_94,
TRADOS_EXPEDIENTE_95_100,
TRADOS_EXPEDIENTE_95_99,
TRADOS_EXPEDIENTE_100,
TRADOS_TAREA_0_84,
TRADOS_TAREA_85_94,
TRADOS_TAREA_95_100,
TRADOS_TAREA_95_99,
TRADOS_TAREA_100,
TARIFA_HITZAK, 
AURREKUSITAKO_DATA, EGIKARATZE_DATA, BENETAKO_ENTREGA_DATA, AMAITUTA, ITZULPEN_MOTA, ITZULPEN_MOTA_0, 
DIRU_SARRERA, BEZ, ZENBATEKOA_BEZ_BARNE, ATAZAREN_KODEA, BAZTERTUTA, 
BAZTERTZEKO_ARRAZOIA, EZEZTATUTA, EZEZTATZEKO_ARRAZOIA, KALITATE_PENALIZAZIOA, KALITATE_ZENBATEKOA)
AS 
SELECT 
ANYO_051, NUM_EXP_051, DECODE(ID_TIPO_EXPEDIENTE_051, 'T', 'ITZULPENA', 'BERRIKUSKETA'), DESC_IDIOMA_EU_009, nvl(DESC_EU, DESC_ES), TIPO,
TRIM(t71solici.APEL1_077) || ' ' || TRIM(t71solici.APEL2_077) || ', ' || TRIM(t71solici.NOMBRE_077) ,(t71solici.PREDNI_077 ||t71solici.DNI_077 || t71solici.SUFDNI_077),
DESC_EU_015,
DECODE(TAREA.DNI_RECURSO_081, null, TO_CHAR(ID_LOTE_029), (t71recurso.PREDNI_077 ||t71recurso.DNI_077 || t71recurso.SUFDNI_077)),
DECODE(TAREA.DNI_RECURSO_081, null, NOMBRE_LOTE_029, TRIM(t71recurso.APEL1_077) || ' ' || TRIM(t71recurso.APEL2_077) || ', ' || TRIM(t71recurso.NOMBRE_077)), 
FECHA_ALTA_051, FECHA_FINAL_IZO_053, 
tDocs.NUM_PAL_SOLIC,
tDocs.NUM_PAL_IZO,
NUM_PAL_CONCOR_0_84_090,
NUM_PAL_CONCOR_85_94_090,
NUM_PAL_CONCOR_95_100_090,
NUM_PAL_CONCOR_95_99_090,
NUM_PAL_CONCOR_100_090,
tDocs.NUM_PAL_CONCOR_0_84,
tDocs.NUM_PAL_CONCOR_85_94,
tDocs.NUM_PAL_CONCOR_95_100,
tDocs.NUM_PAL_CONCOR_95_99,
tDocs.NUM_PAL_CONCOR_100,
TARIFA_PAL_097,
TAREA.FECHA_FIN_081, 
EJECUCION_TAREA.FECHA_EJECUCION_082,
FECHA_ENTREGA_REAL_053,
DECODE(TAREA.ESTADO_EJECUCION_081, 3, 'Bai', 'Ez'),
tDocs.DOCS,
DESC_RELEVANCIA_EU_010,
IMPORTE_BASE_097, POR_IVA_097, IMPORTE_TOTAL_097, TAREA.ID_TAREA_081,
DECODE(ID_RECHAZO_059, null, 'Ez', 'Bai'),
DECODE(ID_RECHAZO_059, null, '-', (DESC_EU_013)),
DECODE(ID_ANULACION_059, null, 'Ez', 'Bai'),
DECODE(ID_ANULACION_059, null, '-', (DESC_EU_012)),
CASE WHEN PAGOPROV.NIVEL_CALIDAD_094 is not null then
'>=' || NVL(CALIDAD.RANGO_INI_CALIDAD_0B5,0) || ' - < ' || NVL(CALIDAD.RANGO_FIN_CALIDAD_0B5,0) || ' Penalizazioa: ' || PAGOPROV.POR_PENAL_CALIDAD_094 || '%'
ELSE null END AS PENALIZACION_CALIDAD, 
IMP_PENAL_CALIDAD_094 AS IMP_PENALIZACION_CALIDAD
FROM AA79B51T00 
LEFT JOIN AA79B81T00 TAREA ON TAREA.ANYO_081 = ANYO_051 AND TAREA.NUM_EXP_081 = NUM_EXP_051
LEFT JOIN AA79B82T00 EJECUCION_TAREA ON EJECUCION_TAREA.ID_TAREA_082 = TAREA.ID_TAREA_081
JOIN AA79B54T00 ON ANYO_051 = ANYO_054 AND NUM_EXP_051 = NUM_EXP_054
JOIN X54JAPI_ENTIDADES_SOLIC ON TIPO =  TIPO_ENTIDAD_054 AND CODIGO = ID_ENTIDAD_054
JOIN AA79B77T00 t71solici ON t71solici.DNI_077 = DNI_SOLICITANTE_054
LEFT JOIN AA79B15T00 ON TAREA.ID_TIPO_TAREA_081 = ID_015
LEFT JOIN AA79B77T00 t71recurso ON t71recurso.DNI_077 = TAREA.DNI_RECURSO_081
LEFT JOIN AA79B29T00 ON ID_LOTE_029 = TAREA.ID_LOTE_081
JOIN AA79B53T00 ON ANYO_051 = ANYO_053 AND NUM_EXP_051 = NUM_EXP_053
LEFT JOIN AA79B97T00 ON ANYO_051 = ANYO_097 AND NUM_EXP_051 = NUM_EXP_097
JOIN AA79B59T00 ON NUM_EXP_051 = NUM_EXP_059 AND ANYO_051 = ANYO_059 AND ESTADO_BITACORA_051 = ID_ESTADO_BITACORA_059
LEFT JOIN AA79B67T00 ON ID_RECHAZO_059 = ID_067
LEFT JOIN AA79B68T00 ON ID_067 = ID_068
LEFT JOIN AA79B13T00 ON ID_MOTIVO_RECHAZO_067 = ID_013
LEFT JOIN AA79BA1T00 ON ID_ANULACION_059 = ID_0A1
LEFT JOIN AA79BA2T00 ON ID_0A1 = ID_0A2
LEFT JOIN AA79B12T00 ON ID_MOTIVO_ANULACION_0A1 = ID_012
LEFT JOIN AA79B09T00 ON ID_IDIOMA_009 = ID_IDIOMA_053
LEFT JOIN 
(SELECT ID_TAREA_083, SUM(NUM_PAL_SOLIC_056) NUM_PAL_SOLIC, 
SUM(NUM_PAL_IZO_056)  AS NUM_PAL_IZO , 
SUM(NUM_PAL_CONCOR_0_84_091) AS NUM_PAL_CONCOR_0_84, SUM(NUM_PAL_CONCOR_85_94_091) AS NUM_PAL_CONCOR_85_94, SUM(NUM_PAL_CONCOR_95_100_091) as NUM_PAL_CONCOR_95_100, 
SUM(NUM_PAL_CONCOR_95_99_091) as NUM_PAL_CONCOR_95_99, SUM(NUM_PAL_CONCOR_100_091) as NUM_PAL_CONCOR_100,
LISTAGG(DESC_EU_042 , ', ') WITHIN GROUP (ORDER BY DESC_EU_042) AS DOCS
FROM AA79B83T00 
JOIN AA79B56T00 ON ID_DOC_083 = ID_DOC_056 JOIN AA79B42T00 ON TIPO_DOCUMENTO_056 = ID_042
JOIN AA79B81T00 TAREADOCU ON TAREADOCU.ID_TAREA_081 = ID_TAREA_083
LEFT JOIN AA79B81T00 TRADOSTAREA ON TRADOSTAREA.ANYO_081 = TAREADOCU.ANYO_081 AND TRADOSTAREA.NUM_EXP_081 = TAREADOCU.NUM_EXP_081 AND TRADOSTAREA.ID_TIPO_TAREA_081 = 1
LEFT JOIN AA79B91T00 ON TRADOSTAREA.ID_TAREA_081 = ID_TAREA_091 AND ID_DOC_ORIG_091 = ID_DOC_056
 GROUP BY ID_TAREA_083) tDocs ON tDocs.ID_TAREA_083 = TAREA.ID_TAREA_081
LEFT JOIN AA79B10T00 ON ID_TIPO_RELEVANCIA_010 = ID_RELEVANCIA_053
LEFT JOIN AA79B81T00 TRADOS ON TRADOS.ANYO_081 = ANYO_051 AND TRADOS.NUM_EXP_081 = NUM_EXP_051 AND TRADOS.ID_TIPO_TAREA_081 = 1
LEFT JOIN AA79B90T00 ON TRADOS.ID_TAREA_081 = ID_TAREA_090
LEFT JOIN AA79B81T00 TAREAPAGOPROV ON TAREAPAGOPROV.ANYO_081 = ANYO_051 AND TAREAPAGOPROV.NUM_EXP_081 = NUM_EXP_051 AND TAREAPAGOPROV.ID_TIPO_TAREA_081 = 11 
AND TAREAPAGOPROV.id_tarea_rel_081 = TAREA.ID_TAREA_081 AND tareapagoprov.estado_ejecucion_081 = 3
LEFT JOIN AA79B94T00 PAGOPROV ON PAGOPROV.ID_TAREA_094 = TAREAPAGOPROV.ID_TAREA_081
LEFT JOIN AA79BB5T00 CALIDAD ON pagoprov.nivel_calidad_094 = calidad.nivel_0b5 and estado_0b5 = 'A'
WHERE ID_TIPO_EXPEDIENTE_051 in ('T', 'R');
/