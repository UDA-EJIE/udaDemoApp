CREATE OR REPLACE VIEW AA79O81V00 AS
SELECT DISTINCT ID_TAREA_081 ID_TAREA
, ANYO_081 ANYO
, NUM_EXP_081 NUM_EXP
, EXTRACT(month FROM fecha_ejecucion_082) MES
, CASE WHEN EXTRACT(day FROM fecha_ejecucion_082) <= 15 THEN 1 ELSE 2 END QUINCENA
, MOD(TO_CHAR(fecha_ejecucion_082, 'J'), 7)+1 DIA
, ID_TIPO_TAREA_081 TIPO_TAREA
, ID_TIPO_EXPEDIENTE_051 TIPO_EXPEDIENTE
, CASE WHEN fecha_ejecucion_082 is not null and FECHA_FIN_081 = fecha_ejecucion_082 THEN 1 
       WHEN fecha_ejecucion_082 is not null and FECHA_FIN_081 < fecha_ejecucion_082 THEN 2
       WHEN fecha_ejecucion_082 is not null and FECHA_FIN_081 > fecha_ejecucion_082 THEN 3 
       ELSE null
  END PLAZO
, CASE WHEN (SUM(NUM_PAL_IZO_056) OVER (PARTITION BY id_tarea_081)) > (SELECT pal_trados_003 FROM aa79b03t00 WHERE id_003 = 0) THEN 1 ELSE 0 END TIPO_PROYECTO
, CASE WHEN ID_TIPO_EXPEDIENTE_051 <> 'I' THEN DECODE(RECURSO_ASIGNACION_081, 'I',1,'P',2,null) ELSE null END TIPO_TRADUCTOR
, CASE WHEN ID_TIPO_EXPEDIENTE_051 = 'I' THEN DECODE(RECURSO_ASIGNACION_081, 'I',1,'P',2,null) ELSE null END TIPO_INTERPRETE
, NVL(DNI_RECURSO_081, TPROV.CIF) ASIGNACION
, CASE WHEN (SELECT tareaAnterior.FECHA_FIN_081 From AA79B81T00 tareaAnterior  WHERE tareaAnterior.Anyo_081 = ANYO_051 AND tareaAnterior.Num_Exp_081 = tareaAnterior.NUM_EXP_081 AND tareaAnterior.ORDEN_081 = ORDEN_081 -1) is null
    THEN DIAS_ENTRE_FECHAS_CALENDAR(FECHA_ASIGNACION_081, fecha_ejecucion_082 )
    ELSE DIAS_ENTRE_FECHAS_CALENDAR((SELECT tareaAnterior.FECHA_FIN_081 From AA79B81T00 tareaAnterior  WHERE tareaAnterior.Anyo_081 = ANYO_051 AND tareaAnterior.Num_Exp_081 = tareaAnterior.NUM_EXP_081 AND tareaAnterior.ORDEN_081 = ORDEN_081 -1), fecha_ejecucion_082 )
    END DIAS_TRABAJO
, CASE WHEN (SELECT tareaAnterior.FECHA_FIN_081 From AA79B81T00 tareaAnterior  WHERE tareaAnterior.Anyo_081 = ANYO_051 AND tareaAnterior.Num_Exp_081 = tareaAnterior.NUM_EXP_081 AND tareaAnterior.ORDEN_081 = ORDEN_081 -1) is null
    THEN PARSE_HORA_MINUTOS(HORAS_ENTRE_FECHAS_CALENDAR(FECHA_ASIGNACION_081, fecha_ejecucion_082))
    ELSE PARSE_HORA_MINUTOS(HORAS_ENTRE_FECHAS_CALENDAR((SELECT tareaAnterior.FECHA_FIN_081 From AA79B81T00 tareaAnterior  WHERE tareaAnterior.Anyo_081 = ANYO_051 AND tareaAnterior.Num_Exp_081 = tareaAnterior.NUM_EXP_081 AND tareaAnterior.ORDEN_081 = ORDEN_081 -1), fecha_ejecucion_082 ))
    END HORAS_TRABAJO
, PARSE_HORA_MINUTOS(HORAS_PREVISTAS_081) TIEMPO_PREVISTO
, NULL TIEMPO_REALIZACION
, CASE WHEN fecha_ejecucion_082 is not null AND FECHA_FIN_081 < fecha_ejecucion_082 THEN DIAS_ENTRE_FECHAS_CALENDAR (FECHA_FIN_081, fecha_ejecucion_082)
    ELSE null END DIAS_RETRASO
, NULL DIAS_DURACION
, PARSE_HORA_MINUTOS(HORAS_TAREA_082) HORAS_DURACION
/*
, FECHA_ASIGNACION_081
, FECHA_FIN_081
, FECHA_EJECUCION_082
,  DIAS_RETRASO_081
,  TIEMPO_PREVISTO_081
,  HORAS_REALIZACION_081 -- se obtendrá otro tiempo de realización en días, por lo que hará falta otra versión del pl que acumule días en vez de horas atendiendo al calendario del servicio.
,  DIAS_REALIZACION_081
,  DURACION_081
, POR_USO_EUSKERA_082 POR_EUSKERA_051
*/
FROM AA79B81T00
JOIN AA79B82T00 ON ID_TAREA_082 = ID_TAREA_081
JOIN AA79B51T00 ON ANYO_051 = ANYO_081 AND NUM_EXP_051 = NUM_EXP_081 AND ANYO_051 >= 2019
JOIN AA79B59T00 ON ANYO_059 = ANYO_051 AND NUM_EXP_059 = NUM_EXP_051 AND id_estado_bitacora_059 = estado_bitacora_051 
LEFT JOIN AA79B83T00 ON ID_TAREA_081 = ID_TAREA_083
LEFT JOIN AA79B56T00 ON ANYO_056 = ANYO_081 AND NUM_EXP_056 = NUM_EXP_081 AND ID_DOC_083 = ID_DOC_056
LEFT JOIN AA79B77T00 ON DNI_RECURSO_081 = DNI_077
LEFT JOIN AA79B29T00 ON ID_LOTE_081 = ID_LOTE_029
LEFT JOIN X54JAPI_EMPRESAS_PROV TPROV ON ID_EMPRESA_PROV_029 = TPROV.CODIGO AND TIPO_ENTIDAD_029 = TPROV.TIPO
WHERE ID_ESTADO_EXP_059 in (4,5,6,7);
