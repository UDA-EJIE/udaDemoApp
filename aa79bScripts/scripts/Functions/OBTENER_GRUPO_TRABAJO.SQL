create or replace
FUNCTION OBTENER_GRUPO_TRABAJO( ANYO IN NUMBER,
  NUM_EXP IN NUMBER) RETURN NUMBER IS

ID_GRUPO_TRABAJO NUMBER(3):= NULL;
ID_GRUPO_GAINERAKO NUMBER(3):= 0;

TIPO_EXP_INTERPRETACION  VARCHAR2(1):= 'I';
TIPO_GRUPO_INTERPRETACION  NUMBER(1):= 0;
TIPO_GRUPO_TRADREV  NUMBER(1):= 1;


TYPE r_reg_expediente IS RECORD (
   ID_TIPO_EXPEDIENTE VARCHAR2(1),
   IND_PUBLICAR_BOPV VARCHAR2(1),
   IND_PREVISTO_BOPV VARCHAR2(1),
   TIPO_ENTIDAD VARCHAR2(1),
   ID_ENTIDAD NUMBER(8)
);
EXPEDIENTE r_reg_expediente;

BEGIN
    -- obtenemos los datos del expediente
    SELECT ID_TIPO_EXPEDIENTE_051, IND_PUBLICAR_BOPV_053, IND_PREVISTO_BOPV_053, TIPO_ENTIDAD_054, ID_ENTIDAD_054 into EXPEDIENTE
    FROM AA79B51S01 
    JOIN AA79B54S01 ON ANYO_054 = ANYO_051 AND NUM_EXP_054 = NUM_EXP_051
    LEFT JOIN AA79B53S01 ON ANYO_053 = ANYO_051 AND NUM_EXP_053 = NUM_EXP_051
    WHERE ANYO_051 = ANYO AND NUM_EXP_051 = NUM_EXP;
    
    IF (EXPEDIENTE.ID_TIPO_EXPEDIENTE = TIPO_EXP_INTERPRETACION) THEN
    	BEGIN
    		SELECT ID_026 into ID_GRUPO_TRABAJO FROM AA79B26T00 WHERE ID_TIPO_EXPEDIENTE_026 = TIPO_GRUPO_INTERPRETACION
    		AND ESTADO_026 = 'A';
    	EXCEPTION
          WHEN NO_DATA_FOUND THEN
		        ID_GRUPO_TRABAJO:= NULL;
          END;
    ELSE
    	IF (ID_GRUPO_TRABAJO is NULL) THEN
    		BEGIN
	    		SELECT ID_026 into ID_GRUPO_TRABAJO FROM AA79B26S01
	    		JOIN AA79B27S01 ON ID_026 = ID_GRUPO_027
	    		WHERE ID_TIPO_EXPEDIENTE_026 = TIPO_GRUPO_TRADREV
	    		AND ESTADO_026 = 'A' 
	    		AND TIPO_ENTIDAD_027 = EXPEDIENTE.TIPO_ENTIDAD
	    		AND ID_ENTIDAD_027 = EXPEDIENTE.ID_ENTIDAD;
	    	EXCEPTION
	          WHEN NO_DATA_FOUND THEN
			        ID_GRUPO_TRABAJO:= ID_GRUPO_GAINERAKO;
	        END;
    	END IF;
    END IF;
	
    RETURN ID_GRUPO_TRABAJO;
    
	
END;
/