create or replace FUNCTION CALCULAR_FECHA_FIN_TAREA(DIA_INICIO_TAREA IN DATE,
                                                    HORAS_PREVISTAS IN VARCHAR) RETURN DATE IS 
  HORARIO_VERANO AA79B39S01%ROWTYPE;
  HORARIO_INVIERNO AA79B39S01%ROWTYPE;
  HORARIO AA79B39S01%ROWTYPE;
  ID_HORARIO_NORMAL       NUMBER(2):= 1;
  HORAS_DIA            NUMBER(12,2):=0;
  HORAS_RESTANTES      NUMBER(12,2):=0;
  HORAS_MANANA         NUMBER(12,2):=0;
  CONTADOR             NUMBER(1)   := 0;
  DIA_INI DATE;
  DIA_SEL DATE;
  DIA_SEMANA_SEL NUMBER(1); 
  DIA_DEFINITIVO DATE:= sysdate;                                                 
BEGIN
    DIA_INI := DIA_INICIO_TAREA;
    HORAS_RESTANTES := PARSE_HORA_MINUTOS(HORAS_PREVISTAS);
     -- OBTENEMOS LOS HORARIOS DE VERANO Y DE INVIERNO
    SELECT *
    INTO HORARIO_VERANO
    FROM AA79B39S01
    WHERE ID_HORARIO_039=ID_HORARIO_NORMAL
    AND IND_VERANO_039  = 'V';
    SELECT *
    INTO HORARIO_INVIERNO
    FROM AA79B39S01
    WHERE ID_HORARIO_039=ID_HORARIO_NORMAL
    AND IND_VERANO_039  = 'I';
    
    WHILE HORAS_RESTANTES > 0
    LOOP
    DIA_SEL := to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD'),'YYYY/MM/DD');
    HORAS_DIA      := 0.0;
    DIA_SEMANA_SEL := MOD(TO_CHAR(DIA_INI, 'J'), 7)+1;
    -- COMPROBAMOS QUE NO SEA FIN DE SEMANA
    IF (DIA_SEMANA_SEL < 6) THEN
      --  COMPROBAMOS QUE NO SEA FESTIVO
      SELECT COUNT(1)
      INTO CONTADOR
      FROM AA79B23S01
      WHERE DIA_CALENDARIO_023 = DIA_SEL;
      IF (CONTADOR             = 0) THEN
        -- COMPROBAMOS SI ES UN DIA DE VERANO O DE INVIERNO.
      	SELECT COUNT(1)
        INTO CONTADOR
        FROM AA79B22S01
        WHERE ANYO_CALENDARIO_022 = TO_CHAR(DIA_SEL,'YYYY')
        AND VERANO_DESDE_022      <= DIA_SEL
        AND VERANO_HASTA_022      >= DIA_SEL;
        IF (CONTADOR              = 1) THEN
          -- ES VERANO
          HORARIO:=HORARIO_VERANO;
        ELSE
          HORARIO:=HORARIO_INVIERNO;
        END IF;
        -- RECUPERAMOS LAS HORAS DISPONIBLES EN ESE DIA
        IF (DIA_SEMANA_SEL = 5) THEN
          -- ES VIERNES
          IF (DIA_INI    <= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_V_M_039, 'YYYY/MM/DD hh24:mi')) THEN
            HORAS_DIA   := ROUND((24 *(to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_M_039, 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||HORARIO.HORA_INI_V_M_039, ' YYYY/MM/DD hh24:mi')))+ (24 *(to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
          ELSIF (DIA_INI <= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_M_039, 'YYYY/MM/DD hh24:mi')) THEN
            HORAS_DIA   := ROUND((24 *(to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_M_039, 'YYYY/MM/DD hh24:mi') - DIA_INI))+ (24 *(to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
          ELSIF (DIA_INI <= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_V_T_039, 'YYYY/MM/DD hh24:mi')) THEN
            HORAS_DIA   := ROUND((24 *(to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
          ELSIF (DIA_INI <= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_T_039, 'YYYY/MM/DD hh24:mi')) THEN
            HORAS_DIA   := HORAS_DIA + ROUND((24 *(to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - DIA_INI)),2);
          END IF;
        ELSE
          IF (DIA_INI    <= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_LJ_M_039, 'YYYY/MM/DD hh24:mi')) THEN
            HORAS_DIA   := ROUND((24 *(to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_M_039, 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||HORARIO.HORA_INI_LJ_M_039, ' YYYY/MM/DD hh24:mi')))+ (24 *(to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
          ELSIF (DIA_INI <= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_M_039, 'YYYY/MM/DD hh24:mi')) THEN
            HORAS_DIA   := ROUND((24 *(to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_M_039, 'YYYY/MM/DD hh24:mi') - DIA_INI))+ (24 *(to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
          ELSIF (DIA_INI <= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_LJ_T_039, 'YYYY/MM/DD hh24:mi')) THEN
            HORAS_DIA   := ROUND((24 *(to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
          ELSIF (DIA_INI <= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_T_039, 'YYYY/MM/DD hh24:mi')) THEN
            HORAS_DIA   := HORAS_DIA + ROUND((24 *(to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - DIA_INI)),2);
          END IF;
        END IF;
        IF (HORAS_RESTANTES <= HORAS_DIA) THEN
          -- HEMOS ENCONTRADO EL DIA TENEMOS QUE BUSCAR LA HORA CONCRETA TENIENDO EN CUENTA QUE EL HORARIO ESTA PARTIDO.
          IF (DIA_SEMANA_SEL = 5) THEN
            -- ES VIERNES
            IF (DIA_INI        <= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_V_M_039, 'YYYY/MM/DD hh24:mi')) THEN
              HORAS_MANANA    := ROUND((24 *(to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_M_039, 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||HORARIO.HORA_INI_V_M_039, ' YYYY/MM/DD hh24:mi'))),2);
              IF (HORAS_MANANA > HORAS_RESTANTES) THEN
                DIA_DEFINITIVO:= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_V_M_039, 'YYYY/MM/DD hh24:mi') + (HORAS_RESTANTES)/24;
              ELSE
                DIA_DEFINITIVO:= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_V_T_039, 'YYYY/MM/DD hh24:mi') + (HORAS_RESTANTES-HORAS_MANANA)/24;
              END IF;
            ELSIF (DIA_INI     <= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_M_039, 'YYYY/MM/DD hh24:mi')) THEN
              HORAS_MANANA    := ROUND((24 *(to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_M_039, 'YYYY/MM/DD hh24:mi') - DIA_INI)),2);
              IF (HORAS_MANANA > HORAS_RESTANTES) THEN
                DIA_DEFINITIVO:= DIA_INI + (HORAS_RESTANTES)/24;
              ELSE
                DIA_DEFINITIVO:= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_V_T_039, 'YYYY/MM/DD hh24:mi') + (HORAS_RESTANTES-HORAS_MANANA)/24;
              END IF;
            ELSIF (DIA_INI   <= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_V_T_039, 'YYYY/MM/DD hh24:mi')) THEN
              DIA_DEFINITIVO:= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_V_T_039, 'YYYY/MM/DD hh24:mi') + (HORAS_RESTANTES)/24;
            ELSIF (DIA_INI   <= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_T_039, 'YYYY/MM/DD hh24:mi')) THEN
              DIA_DEFINITIVO:= DIA_INI + (HORAS_RESTANTES)/24;
            END IF;
          ELSE
            IF (DIA_INI        <= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_LJ_M_039, 'YYYY/MM/DD hh24:mi')) THEN
              HORAS_MANANA    := ROUND((24 *(to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_M_039, 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||HORARIO.HORA_INI_LJ_M_039, ' YYYY/MM/DD hh24:mi'))),2);
              IF (HORAS_MANANA > HORAS_RESTANTES) THEN
                DIA_DEFINITIVO:= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_LJ_M_039, 'YYYY/MM/DD hh24:mi') + (HORAS_RESTANTES)/24;
              ELSE
                DIA_DEFINITIVO:= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_LJ_T_039, 'YYYY/MM/DD hh24:mi') + (HORAS_RESTANTES-HORAS_MANANA)/24;
              END IF;
            ELSIF (DIA_INI     <= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_M_039, 'YYYY/MM/DD hh24:mi')) THEN
              HORAS_MANANA    := ROUND((24 *(to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_M_039, 'YYYY/MM/DD hh24:mi') - DIA_INI)),2);
              IF (HORAS_MANANA > HORAS_RESTANTES) THEN
                DIA_DEFINITIVO:= DIA_INI + (HORAS_RESTANTES)/24;
              ELSE
                DIA_DEFINITIVO:= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_LJ_T_039, 'YYYY/MM/DD hh24:mi') + (HORAS_RESTANTES-HORAS_MANANA)/24;
              END IF;
            ELSIF (DIA_INI   <= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_LJ_T_039, 'YYYY/MM/DD hh24:mi')) THEN
              DIA_DEFINITIVO:= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_LJ_T_039, 'YYYY/MM/DD hh24:mi') + (HORAS_RESTANTES)/24;
            ELSIF (DIA_INI   <= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_T_039, 'YYYY/MM/DD hh24:mi')) THEN
              DIA_DEFINITIVO:= DIA_INI + (HORAS_RESTANTES)/24;
            END IF;
          END IF;
          HORAS_RESTANTES := 0;
        ELSE
          HORAS_RESTANTES := HORAS_RESTANTES - HORAS_DIA;
          DIA_INI         := DIA_SEL         + 1;
        END IF;
      ELSE
        DIA_INI:= DIA_SEL + 1;
      END IF;
    ELSE
      DIA_INI:= DIA_SEL + 1;
    END IF;
  END LOOP;
  RETURN DIA_DEFINITIVO;
END;
/