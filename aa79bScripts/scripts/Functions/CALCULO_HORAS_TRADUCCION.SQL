create or replace FUNCTION CALCULO_HORAS_TRADUCCION( IND_INTERNO IN VARCHAR2, ANYO IN   NUMBER,
   NUM_EXP IN NUMBER, IDS_DOCS IN  VARCHAR2 , ID_TIPO_TAREA IN NUMBER, ID_TIPO_REVISION IN NUMBER) RETURN VARCHAR IS

RETORNO VARCHAR2(10):='0';

sql_stmt    VARCHAR2(2000);

TYPE r_reg_config IS RECORD (
    PAL_TRAD_HORA NUMBER(4),
    PAL_REV_HORA NUMBER(4),
    PAL_HORA_CONCOR_85_94 NUMBER(4),
    PAL_HORA_CONCOR_0_84 NUMBER(4),
    PAL_HORA_CONCOR_95_99 NUMBER(4),
    PAL_HORA_CONCOR_100 NUMBER(4)
);
CONFIG r_reg_config;
LIM_PAL_CONCOR NUMBER(4);
LIMPALCONFIG_INTERNA AA79B02S02%ROWTYPE;
LIMPALCONFIG_EXTERNA AA79B45S02%ROWTYPE;

TIPO_EXPEDIENTE VARCHAR2(1);
TIPO_EXP_TRADUCCION VARCHAR2(1):= 'T';
TIPO_EXP_REVISION VARCHAR2(1):= 'R';
--ID_TIPO_RELEVANCIA NUMBER(2);
NIV_USUARIO VARCHAR2(1);
IND_VIP VARCHAR2(1);
IND_TIEMPO_GESTION VARCHAR2(1);

TYPE r_reg_documentos IS RECORD (
  	NUM_TOTAL_PAL_IZO_EXP NUMBER(6),
	NUM_TOTAL_PAL_IZO NUMBER(6),
	NUM_TOTAL_PAL NUMBER(6),
	NUM_PAL_CONCOR_0_84_091 NUMBER(6),
	NUM_PAL_CONCOR_85_94_091 NUMBER(6),
	NUM_PAL_CONCOR_95_100_091 NUMBER(6),
	NUM_PAL_CONCOR_95_99_091 NUMBER(6),
	NUM_PAL_CONCOR_100_091 NUMBER(6),
	NUM_PAL_CONCOR_0_84_056 NUMBER(6),
	NUM_PAL_CONCOR_85_94_056 NUMBER(6),
	NUM_PAL_CONCOR_95_100_056 NUMBER(6),
	NUM_PAL_CONCOR_95_99_056 NUMBER(6),
	NUM_PAL_CONCOR_100_056 NUMBER(6)
);
DOCUMENTOS r_reg_documentos;

HORAS_TRABAJO NUMBER(9,2):= 0.0;

CLASE_DOC_TRAD NUMBER(1):= 1;
CLASE_DOC_REV NUMBER(1):= 2;
CLASE_DOC_TRABAJO NUMBER(1):= 4;

PRIORIDAD_RELEVANCIA NUMBER(2):=0;

TIPO_TAREA_TRADOS            NUMBER(2) := 1;
TIPO_TAREA_TRADUCCION        NUMBER(2) := 2;
TIPO_TAREA_REVISAR        NUMBER(2) := 2;
TIPO_TAREA_CORREDACCION      NUMBER(2) := 3;
TIPO_TAREA_TRAD_ENTREGA      NUMBER(2) := 22;

TIPO_TAREA_REVISAR_TRAD      NUMBER(2) := 21;

TIPO_TAREA_REV_ENTREGA      NUMBER(2) := 20;
TIPO_TAREA_TRAD_ENTREGA_REV      NUMBER(2) := 19;
TIPO_TAREA_REV_TRAD_INT      NUMBER(2) := 24;

HORAS_TIEMPO_EXTRA_GESTION      NUMBER(12,2):=0;
TIEMPO_EXTRA_GESTION			VARCHAR2(10):= '00:00';
POR_APLIC_TRAD NUMBER(3):= 50;
-- obtenemos los tipos de relevancia de los documentos del expediente
    CURSOR C_DOCUMENTOS IS
        (SELECT NVL(ID_TIPO_RELEVANCIA_042,ID_RELEVANCIA_053) ID_TIPO_RELEVANCIA, ID_DOC_056
        FROM AA79B56S01,AA79B53S01, AA79B42S01, AA79B10S01 WHERE TIPO_DOCUMENTO_056 =  ID_042 (+)
        AND ID_TIPO_RELEVANCIA_042 =  ID_TIPO_RELEVANCIA_010 (+)
        AND ANYO_056 = ANYO_053 AND NUM_EXP_056 = NUM_EXP_053
        AND ANYO_056 = ANYO AND NUM_EXP_056 = NUM_EXP
        AND CLASE_DOCUMENTO_056 in (CLASE_DOC_TRAD, CLASE_DOC_REV, CLASE_DOC_TRABAJO) AND ID_DOC_VERSION_056 is null AND ID_DOC_REL_056 is null
        -- ID DOCS (vienen como varchar, tenemos que separar los valores)
        AND ID_DOC_056 IN(SELECT regexp_substr(IDS_DOCS,'[^,]+', 1, LEVEL) FROM dual
                          CONNECT BY regexp_substr(IDS_DOCS, '[^,]+', 1, LEVEL) IS NOT NULL));
BEGIN

-- obtenemos el tipo de expediente
	SELECT ID_TIPO_EXPEDIENTE_051 into TIPO_EXPEDIENTE FROM AA79B51T00 WHERE ANYO_051 = ANYO AND NUM_EXP_051 = NUM_EXP;
-- obtenemos si el usuario es vip o no
    SELECT IND_VIP_054 INTO IND_VIP FROM AA79B54T00 WHERE ANYO_054 = ANYO AND NUM_EXP_054 = NUM_EXP;
    IF( IND_VIP = 'S') THEN
        NIV_USUARIO := 'V';
    ELSE
        NIV_USUARIO := 'N';
    END IF;
-- obtenemos si el tipo de tarea tiene tiempo de gestion extra
    SELECT IND_TIEMPO_GESTION_015 INTO IND_TIEMPO_GESTION FROM AA79B15S01 WHERE ID_015 = ID_TIPO_TAREA;
    SELECT TIEMPO_EXTRA_GESTION_002 INTO TIEMPO_EXTRA_GESTION FROM AA79B02S02 WHERE ID_002 = 0;
    IF( IND_TIEMPO_GESTION = 'S') THEN
        HORAS_TIEMPO_EXTRA_GESTION := PARSE_HORA_MINUTOS(TIEMPO_EXTRA_GESTION);
        HORAS_TRABAJO:= HORAS_TRABAJO + HORAS_TIEMPO_EXTRA_GESTION;
    END IF;


    IF (ID_TIPO_TAREA = TIPO_TAREA_TRADUCCION
			OR ID_TIPO_TAREA = TIPO_TAREA_CORREDACCION
			OR ID_TIPO_TAREA = TIPO_TAREA_REVISAR
			OR ID_TIPO_TAREA = TIPO_TAREA_TRAD_ENTREGA
			OR ID_TIPO_TAREA = TIPO_TAREA_REV_ENTREGA
			OR ID_TIPO_TAREA = TIPO_TAREA_REVISAR_TRAD
			OR ID_TIPO_TAREA = TIPO_TAREA_TRAD_ENTREGA_REV
            OR ID_TIPO_TAREA = TIPO_TAREA_REV_TRAD_INT) THEN
        -- si es tarea revision tenemos en cuenta el porcentaje de relacion entre tiempos de tarea de traduccion y revision
        -- para ello obtenemos el porcentaje del tipo de revision seleccionado
        IF ((ID_TIPO_TAREA = TIPO_TAREA_REVISAR_TRAD
            OR ID_TIPO_TAREA = TIPO_TAREA_TRAD_ENTREGA_REV
            OR ID_TIPO_TAREA = TIPO_TAREA_REV_TRAD_INT) AND ID_TIPO_REVISION > 0) THEN
            SELECT POR_REL_REV_TRAD_018 INTO POR_APLIC_TRAD FROM AA79B18S01 WHERE ID_018 = ID_TIPO_REVISION;
        END IF;
    	-- obtenemos la configuración dependiendo de si es interno o externo
	    FOR R_DOCUMENTOS IN C_DOCUMENTOS LOOP -- hacer loop con documentos pasados
	        -- obtenemos la configuracion en funcion del tipo de relevancia y nivel usuario del expediente
	        IF (IND_INTERNO = 'I') THEN
	            SELECT PAL_TRAD_HORA_002, PAL_REV_HORA_002, PAL_HORA_CONCOR_85_94_002,
	                        PAL_HORA_CONCOR_0_84_002, PAL_HORA_CONCOR_95_99_002, PAL_HORA_CONCOR_100_002 INTO CONFIG FROM AA79B02T00 WHERE ID_002 = 0 AND NIVEL_USUARIO_002 = NIV_USUARIO AND ID_TIPO_RELEVANCIA_002 = R_DOCUMENTOS.ID_TIPO_RELEVANCIA;
	            SELECT * INTO LIMPALCONFIG_INTERNA FROM AA79B02S02 WHERE ID_002 = 0;
	            LIM_PAL_CONCOR := LIMPALCONFIG_INTERNA.LIM_PAL_CONCOR_002;
	        ELSE

	            SELECT PAL_TRAD_HORA_045, PAL_REV_HORA_045, PAL_HORA_CONCOR_85_94_045,
	                        PAL_HORA_CONCOR_0_84_045, PAL_HORA_CONCOR_95_99_045, PAL_HORA_CONCOR_100_045 INTO CONFIG FROM AA79B45T00 WHERE ID_045 = 0 AND NIVEL_USUARIO_045 = NIV_USUARIO;
	            SELECT * INTO LIMPALCONFIG_EXTERNA FROM AA79B45S02 WHERE ID_045 = 0;
	            LIM_PAL_CONCOR := LIMPALCONFIG_EXTERNA.LIM_PAL_CONCOR_045;
	        END IF;
	        -- obtenemos los datos del documento
	        sql_stmt := 'select NUM_TOTAL_PAL_IZO_053, NUM_PAL_IZO_056, NUM_TOTAL_PAL_091, NUM_PAL_CONCOR_0_84_091, NUM_PAL_CONCOR_85_94_091,
	            NUM_PAL_CONCOR_95_100_091, NUM_PAL_CONCOR_95_99_091, NUM_PAL_CONCOR_100_091,NUM_PAL_CONCOR_0_84_056, NUM_PAL_CONCOR_85_94_056, NUM_PAL_CONCOR_95_100_056, NUM_PAL_CONCOR_95_99_056, NUM_PAL_CONCOR_100_056 from AA79B53T00
	            JOIN AA79B56T00 ON  ANYO_053 = ANYO_056 AND NUM_EXP_053 = NUM_EXP_056 AND ID_DOC_REL_056 is null AND CLASE_DOCUMENTO_056 in (' ||CLASE_DOC_TRAD ||',' ||CLASE_DOC_REV ||',' ||CLASE_DOC_TRABAJO ||')';
	            sql_stmt := sql_stmt ||' AND ID_DOC_056 = ('|| R_DOCUMENTOS.ID_DOC_056 ||')';
	            sql_stmt := sql_stmt ||' LEFT JOIN AA79B81T00 ON ANYO_081 = ANYO_056 AND NUM_EXP_081 = NUM_EXP_056 AND ID_TIPO_TAREA_081 = ('||TIPO_TAREA_TRADOS||')
	            LEFT JOIN AA79B91T00 ON ID_TAREA_081 = ID_TAREA_091 AND ID_DOC_ORIG_091 = ID_DOC_056
	            WHERE ANYO_053 = '|| ANYO ||' AND NUM_EXP_053 = '||NUM_EXP||' ';
	          EXECUTE IMMEDIATE sql_stmt INTO DOCUMENTOS;
	         -- realizamos los calculos correspondientes
	         IF (TIPO_EXPEDIENTE = TIPO_EXP_TRADUCCION) THEN
	            IF (DOCUMENTOS.NUM_TOTAL_PAL_IZO_EXP < LIM_PAL_CONCOR) THEN
	                IF (ID_TIPO_TAREA = TIPO_TAREA_REVISAR_TRAD OR ID_TIPO_TAREA = TIPO_TAREA_TRAD_ENTREGA_REV OR ID_TIPO_TAREA = TIPO_TAREA_REV_TRAD_INT) THEN
	                	HORAS_TRABAJO:= HORAS_TRABAJO + round((round(DOCUMENTOS.NUM_TOTAL_PAL_IZO/CONFIG.PAL_TRAD_HORA,2)*POR_APLIC_TRAD/100),2);
	                ELSE
	                	HORAS_TRABAJO:= HORAS_TRABAJO + round(DOCUMENTOS.NUM_TOTAL_PAL_IZO/CONFIG.PAL_TRAD_HORA,2);
	                END IF;
	            ELSIF (DOCUMENTOS.NUM_TOTAL_PAL IS NULL OR DOCUMENTOS.NUM_TOTAL_PAL = 0) THEN
	                    IF (ID_TIPO_TAREA = TIPO_TAREA_REVISAR_TRAD OR ID_TIPO_TAREA = TIPO_TAREA_TRAD_ENTREGA_REV OR ID_TIPO_TAREA = TIPO_TAREA_REV_TRAD_INT) THEN
		                	HORAS_TRABAJO:= HORAS_TRABAJO + round((round(DOCUMENTOS.NUM_TOTAL_PAL_IZO/CONFIG.PAL_TRAD_HORA,2)*POR_APLIC_TRAD/100),2);
		                ELSE
		                	HORAS_TRABAJO:= HORAS_TRABAJO + round(DOCUMENTOS.NUM_TOTAL_PAL_IZO/CONFIG.PAL_TRAD_HORA,2);
		                END IF;
	            ELSIF(DOCUMENTOS.NUM_PAL_CONCOR_0_84_091 IS NOT NULL AND DOCUMENTOS.NUM_PAL_CONCOR_85_94_091 IS NOT NULL AND DOCUMENTOS.NUM_PAL_CONCOR_95_99_091 IS NOT NULL AND DOCUMENTOS.NUM_PAL_CONCOR_100_091 IS NOT NULL) THEN
                        IF (ID_TIPO_TAREA = TIPO_TAREA_REVISAR_TRAD OR ID_TIPO_TAREA = TIPO_TAREA_TRAD_ENTREGA_REV OR ID_TIPO_TAREA = TIPO_TAREA_REV_TRAD_INT) THEN
		                	HORAS_TRABAJO:= HORAS_TRABAJO + round(((round(DOCUMENTOS.NUM_PAL_CONCOR_0_84_091/CONFIG.PAL_HORA_CONCOR_0_84,2)
	                                                            + round(DOCUMENTOS.NUM_PAL_CONCOR_85_94_091/CONFIG.PAL_HORA_CONCOR_85_94,2)
	                                                            + round(DOCUMENTOS.NUM_PAL_CONCOR_95_99_091/CONFIG.PAL_HORA_CONCOR_95_99,2)
	                                                             + round(DOCUMENTOS.NUM_PAL_CONCOR_100_091/CONFIG.PAL_HORA_CONCOR_100,2))*POR_APLIC_TRAD/100),2);
		                ELSE
		                	HORAS_TRABAJO:= HORAS_TRABAJO + round(DOCUMENTOS.NUM_PAL_CONCOR_0_84_091/CONFIG.PAL_HORA_CONCOR_0_84,2)
	                                                        + round(DOCUMENTOS.NUM_PAL_CONCOR_85_94_091/CONFIG.PAL_HORA_CONCOR_85_94,2)
	                                                        + round(DOCUMENTOS.NUM_PAL_CONCOR_95_99_091/CONFIG.PAL_HORA_CONCOR_95_99,2)
	                                                        + round(DOCUMENTOS.NUM_PAL_CONCOR_100_091/CONFIG.PAL_HORA_CONCOR_100,2);
		                END IF;
	            ELSIF(DOCUMENTOS.NUM_PAL_CONCOR_0_84_056 IS NOT NULL AND DOCUMENTOS.NUM_PAL_CONCOR_85_94_056 IS NOT NULL AND DOCUMENTOS.NUM_PAL_CONCOR_95_99_056 IS NOT NULL AND DOCUMENTOS.NUM_PAL_CONCOR_100_056 IS NOT NULL) THEN
	                	IF (ID_TIPO_TAREA = TIPO_TAREA_REVISAR_TRAD OR ID_TIPO_TAREA = TIPO_TAREA_TRAD_ENTREGA_REV OR ID_TIPO_TAREA = TIPO_TAREA_REV_TRAD_INT) THEN
		                	 HORAS_TRABAJO:= HORAS_TRABAJO + round(((round(DOCUMENTOS.NUM_PAL_CONCOR_0_84_056/CONFIG.PAL_HORA_CONCOR_0_84,2)
	                                                                    + round(DOCUMENTOS.NUM_PAL_CONCOR_85_94_056/CONFIG.PAL_HORA_CONCOR_85_94,2)
	                                                                    + round(DOCUMENTOS.NUM_PAL_CONCOR_95_99_056/CONFIG.PAL_HORA_CONCOR_95_99,2)
	                                                                    + round(DOCUMENTOS.NUM_PAL_CONCOR_100_056/CONFIG.PAL_HORA_CONCOR_100,2))*POR_APLIC_TRAD/100),2);
		                ELSE
		                	HORAS_TRABAJO:= HORAS_TRABAJO
	                                            + round(DOCUMENTOS.NUM_PAL_CONCOR_0_84_056/CONFIG.PAL_HORA_CONCOR_0_84,2)
	                                            + round(DOCUMENTOS.NUM_PAL_CONCOR_85_94_056/CONFIG.PAL_HORA_CONCOR_85_94,2)
	                                             + round(DOCUMENTOS.NUM_PAL_CONCOR_95_99_056/CONFIG.PAL_HORA_CONCOR_95_99,2)
	                                            + round(DOCUMENTOS.NUM_PAL_CONCOR_100_056/CONFIG.PAL_HORA_CONCOR_100,2);
		                END IF;
		        ELSE
	           		IF (ID_TIPO_TAREA = TIPO_TAREA_REVISAR_TRAD OR ID_TIPO_TAREA = TIPO_TAREA_TRAD_ENTREGA_REV OR ID_TIPO_TAREA = TIPO_TAREA_REV_TRAD_INT) THEN
	                	HORAS_TRABAJO:= HORAS_TRABAJO + round((round(DOCUMENTOS.NUM_TOTAL_PAL/CONFIG.PAL_TRAD_HORA,2)*POR_APLIC_TRAD/100),2);
	                ELSE
	                	HORAS_TRABAJO:= HORAS_TRABAJO + round(DOCUMENTOS.NUM_TOTAL_PAL/CONFIG.PAL_TRAD_HORA,2);
	                END IF;
		        END IF;
	        ELSIF(TIPO_EXPEDIENTE = TIPO_EXP_REVISION) THEN
	            --Izoko baliabideek orduko berrikusten (en función de la dificultad del documento si el recurso asignado es interno)??
	            HORAS_TRABAJO:= HORAS_TRABAJO + round(DOCUMENTOS.NUM_TOTAL_PAL_IZO/CONFIG.PAL_REV_HORA,2);
	        END IF;
	    END LOOP;

    ELSE
    	HORAS_TRABAJO:= HORAS_TRABAJO + PARSE_HORA_MINUTOS('00:30');
    END IF;

	RETURN FORMAT_HORA_MINUTOS(HORAS_TRABAJO);

END;
/