CREATE OR REPLACE FUNCTION COMPROBAR_FINALIZACION_ESTUDIO ( ANYO IN   NUMBER,
   CORR_EXP IN NUMBER) RETURN NUMBER IS

SIN_NUMERO_PALABRAS_IZO NUMBER(1):= 3;
DOCS_SIN_NUMERO_PALABRAS_IZO NUMBER(1):= 2;
NO_DOC_OBLIGATORIA NUMBER(1):= 1;
DOCUMENTACION_OK NUMBER(1):= 0;  
NO_FECHA_FIN NUMBER(1):= 4; 
DOC_ENCRIPTADOS NUMBER(1):= 5;  
NO_DOC_ENCRIPTADOS NUMBER(1):= 6;
   
RETORNO NUMBER(1):=DOCUMENTACION_OK;
CONTADOR NUMBER(2):= 0;
TIPO_EXPEDIENTE VARCHAR2(1);
IND_CORREDACCION VARCHAR2(1):= null;
IND_CONFIDENCIAL VARCHAR2(1):= null;
ID_RELEVANCIA NUMBER(2):= null;
NUM_PALABRAS NUMBER(6):= null;
FECHA_FIN_IZO DATE:= null;

TIPO_INTERPRETACION VARCHAR2(1):= 'I';
TIPO_TRADUCCION VARCHAR2(1):= 'T';
TIPO_REVISION VARCHAR2(1):= 'R';

CLASE_TRADUCCION NUMBER(2):= 1;
CLASE_REVISION NUMBER(2):= 2;
CLASE_TRABAJO NUMBER(2):= 4;



BEGIN
	SELECT ID_TIPO_EXPEDIENTE_051 INTO TIPO_EXPEDIENTE FROM AA79B51T00 WHERE ANYO_051 = ANYO AND NUM_EXP_051 = CORR_EXP;
	IF (TIPO_EXPEDIENTE = TIPO_TRADUCCION) THEN
		SELECT IND_CORREDACCION_053, NUM_TOTAL_PAL_IZO_053, FECHA_FINAL_IZO_053, IND_CONFIDENCIAL_053, ID_RELEVANCIA_053 INTO IND_CORREDACCION, NUM_PALABRAS, FECHA_FIN_IZO, IND_CONFIDENCIAL, ID_RELEVANCIA FROM AA79B53T00 WHERE ANYO_053 = ANYO AND NUM_EXP_053 = CORR_EXP;
		IF (FECHA_FIN_IZO is null) THEN
			RETORNO:=NO_FECHA_FIN;
		ELSIF (IND_CORREDACCION = 'N') THEN
			SELECT COUNT(1) INTO CONTADOR FROM AA79B56T00 WHERE ANYO_056 = ANYO AND NUM_EXP_056 = CORR_EXP 
			AND CLASE_DOCUMENTO_056 =  CLASE_TRADUCCION AND ID_DOC_VERSION_056 is null AND nvl(ID_DOC_REL_056,0) = 0;
			IF (CONTADOR = 0) THEN
				RETORNO:=NO_DOC_OBLIGATORIA;
			ELSE
				SELECT COUNT(1) INTO CONTADOR FROM AA79B56T00 WHERE ANYO_056 = ANYO AND NUM_EXP_056 = CORR_EXP 
				AND CLASE_DOCUMENTO_056 =  CLASE_TRADUCCION AND ID_DOC_VERSION_056 is null AND nvl(ID_DOC_REL_056,0) = 0
				AND NUM_PAL_IZO_056 is null;
				IF (CONTADOR > 0) THEN
					RETORNO:=DOCS_SIN_NUMERO_PALABRAS_IZO;
				ELSE
					IF (NUM_PALABRAS is null OR NUM_PALABRAS = 0) THEN
						RETORNO:= SIN_NUMERO_PALABRAS_IZO;
					ELSE
						-- COMPROBAMOS SI LOS DOCS ESTAN ENCRIPTADOS O NO
						IF (IND_CONFIDENCIAL = 'S') THEN
							SELECT COUNT(1) INTO CONTADOR FROM AA79B56T00 WHERE ANYO_056 = ANYO AND NUM_EXP_056 = CORR_EXP 
							AND IND_ENCRIPTADO_056 = 'N';
							IF (CONTADOR > 0) THEN
								RETORNO:=NO_DOC_ENCRIPTADOS;
							END IF;
						ELSE
							SELECT COUNT(1) INTO CONTADOR FROM AA79B56T00 WHERE ANYO_056 = ANYO AND NUM_EXP_056 = CORR_EXP 
							AND IND_ENCRIPTADO_056 = 'S';
							IF (CONTADOR > 0) THEN
								RETORNO:=DOC_ENCRIPTADOS;
							END IF;
						END IF;
					END IF;
				END IF;
			END IF;
		END IF;
	ELSE IF (TIPO_EXPEDIENTE = TIPO_REVISION) THEN
			SELECT NUM_TOTAL_PAL_IZO_053, FECHA_FINAL_IZO_053, IND_CONFIDENCIAL_053, ID_RELEVANCIA_053 INTO NUM_PALABRAS, FECHA_FIN_IZO, IND_CONFIDENCIAL, ID_RELEVANCIA FROM AA79B53T00 WHERE ANYO_053 = ANYO AND NUM_EXP_053 = CORR_EXP;
			IF (FECHA_FIN_IZO is null) THEN
				RETORNO:=NO_FECHA_FIN;
			ELSE
				SELECT COUNT(1) INTO CONTADOR FROM AA79B56T00 WHERE ANYO_056 = ANYO AND NUM_EXP_056 = CORR_EXP 
				AND CLASE_DOCUMENTO_056 =  CLASE_REVISION AND ID_DOC_VERSION_056 is null AND nvl(ID_DOC_REL_056,0) = 0;
				IF (CONTADOR = 0) THEN
					RETORNO:=NO_DOC_OBLIGATORIA;
				ELSE
					SELECT COUNT(1) INTO CONTADOR FROM AA79B56T00 WHERE ANYO_056 = ANYO AND NUM_EXP_056 = CORR_EXP 
					AND CLASE_DOCUMENTO_056 =  CLASE_REVISION AND ID_DOC_VERSION_056 is null AND nvl(ID_DOC_REL_056,0) = 0
					AND NUM_PAL_IZO_056 is null;
					IF (CONTADOR > 0) THEN
						RETORNO:=DOCS_SIN_NUMERO_PALABRAS_IZO;
					ELSE
						IF (NUM_PALABRAS is null OR NUM_PALABRAS = 0) THEN
							RETORNO:=SIN_NUMERO_PALABRAS_IZO;
						ELSE
							-- COMPROBAMOS SI LOS DOCS ESTAN ENCRIPTADOS O NO
							IF (IND_CONFIDENCIAL = 'S') THEN
								SELECT COUNT(1) INTO CONTADOR FROM AA79B56T00 WHERE ANYO_056 = ANYO AND NUM_EXP_056 = CORR_EXP 
								AND IND_ENCRIPTADO_056 = 'N';
								IF (CONTADOR > 0) THEN
									RETORNO:=NO_DOC_ENCRIPTADOS;
								END IF;
							ELSE
								SELECT COUNT(1) INTO CONTADOR FROM AA79B56T00 WHERE ANYO_056 = ANYO AND NUM_EXP_056 = CORR_EXP 
								AND IND_ENCRIPTADO_056 = 'S';
								IF (CONTADOR > 0) THEN
									RETORNO:=DOC_ENCRIPTADOS;
								END IF;
							END IF;
						END IF;
					END IF;
				END IF;
			END IF;
		END IF;
	END IF;
	RETURN RETORNO;
END;
/


