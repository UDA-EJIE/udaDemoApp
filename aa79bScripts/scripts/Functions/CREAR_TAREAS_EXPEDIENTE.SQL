create or replace FUNCTION CREAR_TAREAS_EXPEDIENTE(
		   ANYO IN   NUMBER,
		   NUM_EXP IN NUMBER,
		   USUARIO IN VARCHAR2 )
		RETURN NUMBER
	IS

		ID_GRUPO_TRABAJO NUMBER(3);
		DNI_RESPONSABLE VARCHAR2(10);
		NUM_TOTAL_PAL_IZO NUMBER(6);

		ESTADO_TAREA NUMBER(1);
		ESTADO_ASIGNACION_TAREA NUMBER(1):= 1;
		ESTADO_PDTE_ACEPTACION_TAREA NUMBER(1):= 2;
		ESTADO_ACEPTACION_TAREA NUMBER(1):= 3;
		TAREA_PENDIENTE_EJECUCION NUMBER(1):= 1;
		PROYECTO_TRADOS NUMBER(2):= 1;
		ID_TAREA NUMBER(20):= 0;
		DESC_TAREA_ES VARCHAR2(150);
		DESC_TAREA_EU VARCHAR2(150);

		ESTADO_BITACORA NUMBER(3);
		EXPEDIENTE_EN_CURSO NUMBER(1):= 3;
		FASE_EXP_PDTE_PROY_TRADOS NUMBER(1):= 6;

		ID_PROCESO_EMAIL NUMBER(20):= 0;
		NUM_EMAIL NUMBER(2):= 1;
		TIPO_AVISO NUMBER(2):= 5;

		EMAIL_DESTINATARIO VARCHAR2(256);
		TIPO_REVISION VARCHAR2(1):= 'R';
		TIPO_TRADUCCION VARCHAR2(1):= 'T';
		ID_TIPO_EXPEDIENTE VARCHAR2(1);
		DNI_TECNICO VARCHAR2(10);
		TITULO_EXPEDIENTE VARCHAR2(150);
		ORIGEN VARCHAR2(1);
		APLIC_ORIGEN VARCHAR2(6);
		ENTREGA_CLIENTE_REVISION NUMBER(2):= 20;

		OSAKIDETZA VARCHAR2(50);
		UPV VARCHAR2(50);
		TIPO_ENTIDAD VARCHAR2(1);
    	ID_ENTIDAD NUMBER(8);
        
        TIENETAREAS NUMBER(4);

		RETORNO NUMBER(20);
		FECHA_INICIO DATE;
		FECHA_FIN DATE;

		CONTADOR NUMBER(2):=0;
		CONTADORTRADOS NUMBER(2):=0;

		LIM_PALABRAS NUMBER(6);
		
		tiempoPrevistoTarea				VARCHAR2(10):= '00:00';
		horasPrevistasTarea              NUMBER(12,2):=0;
	    HORAS_TIEMPO_EXTRA_GESTION      NUMBER(12,2):=0;
		TIEMPO_EXTRA_GESTION			VARCHAR2(10):= '00:00';
		IND_TIEMPO_GESTION              VARCHAR2(1);

		ORDEN                          NUMBER(2) := 0;
	BEGIN

		-- obtenemos el limite de palabras IZO  a partir del cual se realiza presupuesto y proyecto trados
		select PAL_TRADOS_003 into LIM_PALABRAS from AA79B03T00 where ID_003 = 0;

		-- OBtenemos el tiempo de gestión extra
    	SELECT TIEMPO_EXTRA_GESTION_002 INTO TIEMPO_EXTRA_GESTION FROM AA79B02S02 WHERE ID_002 = 0;
		
		SELECT ID_TIPO_EXPEDIENTE_051, ORIGEN_051, APLIC_ORIGEN_051, DNI_TECNICO_051, TITULO_051 into ID_TIPO_EXPEDIENTE, ORIGEN, APLIC_ORIGEN, DNI_TECNICO, TITULO_EXPEDIENTE FROM AA79B51T00 WHERE ANYO_051 = ANYO AND NUM_EXP_051 = NUM_EXP;
        
        SELECT  COUNT(1) into TIENETAREAS FROM AA79B81T00 WHERE ANYO_081 =  ANYO AND NUM_EXP_081 = NUM_EXP;
        
		IF (ID_TIPO_EXPEDIENTE = TIPO_TRADUCCION AND TIENETAREAS = 0) THEN

			ID_GRUPO_TRABAJO:= OBTENER_GRUPO_TRABAJO(ANYO,NUM_EXP);

			SELECT DNI_RESPONSABLE_026 into DNI_RESPONSABLE FROM AA79B26T00 WHERE ID_026 = ID_GRUPO_TRABAJO;

			SELECT NUM_TOTAL_PAL_IZO_053 into NUM_TOTAL_PAL_IZO FROM AA79B53T00 WHERE ANYO_053 = ANYO AND NUM_EXP_053 = NUM_EXP;

			IF (NUM_TOTAL_PAL_IZO >= LIM_PALABRAS) THEN


				SELECT COUNT(1) INTO CONTADORTRADOS FROM AA79B81T00 WHERE ID_TIPO_TAREA_081 = PROYECTO_TRADOS AND ANYO_081 = ANYO AND NUM_EXP_081 = NUM_EXP;
			 	IF (CONTADORTRADOS = 0) THEN

					SELECT AA79B81Q00.NEXTVAL INTO ID_TAREA FROM dual;

					ESTADO_TAREA:= ESTADO_PDTE_ACEPTACION_TAREA;
			    	IF (DNI_RESPONSABLE = USUARIO) THEN
			    		ESTADO_TAREA:= ESTADO_ACEPTACION_TAREA;
			    	END IF;

			    	tiempoPrevistoTarea:= '00:30';
		   			horasPrevistasTarea:=  PARSE_HORA_MINUTOS(tiempoPrevistoTarea);
					-- comprobamos si hay que aplicar un tiempo extra de gestión
					SELECT IND_TIEMPO_GESTION_015 INTO IND_TIEMPO_GESTION FROM AA79B15S01 WHERE ID_015 = PROYECTO_TRADOS;
				    IF( IND_TIEMPO_GESTION = 'S') THEN
				        HORAS_TIEMPO_EXTRA_GESTION := PARSE_HORA_MINUTOS(TIEMPO_EXTRA_GESTION);
				        horasPrevistasTarea:= horasPrevistasTarea + HORAS_TIEMPO_EXTRA_GESTION;
				        tiempoPrevistoTarea:= FORMAT_HORA_MINUTOS(horasPrevistasTarea);
				    END IF;
			    	
				    FECHA_INICIO:= sysdate;
				    FECHA_FIN:= CALCULAR_FECHA_FIN_TAREA(FECHA_INICIO, tiempoPrevistoTarea );
				    
			        INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) 
			        VALUES (ANYO,DNI_RESPONSABLE,ESTADO_TAREA,TAREA_PENDIENTE_EJECUCION,null,null,FECHA_FIN,FECHA_INICIO,tiempoPrevistoTarea,ID_TAREA,null,null,'N','N',null,NUM_EXP,null,ORDEN,'I',PROYECTO_TRADOS,null,null,null,null);

			        INSERT INTO AA79B82T00 (ID_TAREA_082) values (ID_TAREA);

			        insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083)
					select ID_TAREA, ID_DOC_056 from AA79B56T00 where ANYO_056 = ANYO  AND
					NUM_EXP_056 = NUM_EXP AND ID_DOC_REL_056 is null AND ID_DOC_VERSION_056 is null;

					SELECT nvl(max(ID_ESTADO_BITACORA_059),0) + 1 INTO ESTADO_BITACORA FROM AA79B59S01 t1 WHERE NUM_EXP_059 = NUM_EXP AND ANYO_059 = ANYO;

			        INSERT INTO AA79B59S01 (ANYO_059, NUM_EXP_059, ID_ESTADO_BITACORA_059, ID_ESTADO_EXP_059, ID_FASE_EXPEDIENTE_059, DATO_ADIC_059, INFO_ADIC_059, ID_RECHAZO_059, ID_REQUERIMIENTO_059, FECHA_ALTA_059) VALUES (ANYO,NUM_EXP,ESTADO_BITACORA,EXPEDIENTE_EN_CURSO,FASE_EXP_PDTE_PROY_TRADOS,null,null,null,null, SYSDATE);

			        UPDATE AA79B51S01 SET ESTADO_BITACORA_051= ESTADO_BITACORA WHERE ANYO_051 = ANYO AND NUM_EXP_051 = NUM_EXP;

			        IF (DNI_RESPONSABLE != USUARIO) THEN

				        SELECT AA79BB2Q00.NEXTVAL INTO ID_PROCESO_EMAIL FROM dual;

				        SELECT DESC_ES_015, DESC_EU_015 into DESC_TAREA_ES, DESC_TAREA_EU FROM AA79B15T00 WHERE ID_015 = PROYECTO_TRADOS;

				        SELECT EMAIL_031 into EMAIL_DESTINATARIO FROM X54JAPI_DATOS_CONTACTO WHERE DNI_031 = DNI_RESPONSABLE;

				        INSERT INTO AA79BB2T00 (ID_PROCESO_EMAIL_0B2, NUM_EMAIL_0B2, ID_TIPO_AVISO_0B2, ANYO_0B2, NUM_EXP_0B2, TITULO_EXP_0B2, ID_TAREA_0B2, ID_TIPO_TAREA_0B2, DESC_TAREA_ES_0B2, DESC_TAREA_EU_0B2, DNI_DESTINATARIO_0B2, EMAIL_DESTINATARIO_0B2) VALUES (ID_PROCESO_EMAIL, NUM_EMAIL, TIPO_AVISO, ANYO, NUM_EXP, TITULO_EXPEDIENTE, ID_TAREA, PROYECTO_TRADOS, DESC_TAREA_ES, DESC_TAREA_EU, DNI_RESPONSABLE, EMAIL_DESTINATARIO);

				        NUM_EMAIL:= NUM_EMAIL + 1;

				        RETORNO:= ID_PROCESO_EMAIL;

				    ELSE

				     	RETORNO:= NULL;

				    END IF;
				END IF;

		    ELSE

		    	RETORNO:= NULL;

			END IF;
		END IF;



	SELECT VALOR_000 into OSAKIDETZA FROM AA79B00T00 WHERE ID_000 = 4;
	SELECT VALOR_000 into UPV FROM AA79B00T00 WHERE ID_000 = 5;
	SELECT TIPO_ENTIDAD_054, ID_ENTIDAD_054 into TIPO_ENTIDAD, ID_ENTIDAD FROM AA79B54T00 WHERE ANYO_054 = ANYO AND NUM_EXP_054 = NUM_EXP;

	IF ((ID_TIPO_EXPEDIENTE = TIPO_REVISION AND ORIGEN = 'W' AND APLIC_ORIGEN = 'P43' AND  TIPO_ENTIDAD = 'B' AND (ID_ENTIDAD = OSAKIDETZA OR ID_ENTIDAD = UPV)) AND TIENETAREAS = 0) THEN


		SELECT COUNT(1) INTO CONTADOR FROM AA79B81T00 WHERE ID_TIPO_TAREA_081 = ENTREGA_CLIENTE_REVISION AND ANYO_081 = ANYO AND NUM_EXP_081 = NUM_EXP;
	 	IF (CONTADOR = 0) THEN
			SELECT AA79B81Q00.NEXTVAL INTO ID_TAREA FROM dual;

	 		ESTADO_TAREA:= ESTADO_PDTE_ACEPTACION_TAREA;
	    	IF (DNI_TECNICO = USUARIO) THEN
	    		ESTADO_TAREA:= ESTADO_ACEPTACION_TAREA;
	    	END IF;

	    	tiempoPrevistoTarea:= '00:30';
   			horasPrevistasTarea:=  PARSE_HORA_MINUTOS(tiempoPrevistoTarea);
   			
    		FECHA_INICIO:= SYSDATE;
    		FECHA_FIN:= CALCULAR_FECHA_FIN_TAREA(FECHA_INICIO, tiempoPrevistoTarea );
	    	
			INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) 
			VALUES (ANYO,DNI_TECNICO,ESTADO_TAREA,TAREA_PENDIENTE_EJECUCION,null,null,FECHA_FIN,FECHA_INICIO,tiempoPrevistoTarea,ID_TAREA,null,null,'N','N',null,NUM_EXP,null,1,'I',ENTREGA_CLIENTE_REVISION,null,null,null,1);
		    INSERT INTO AA79B82T00 (ID_TAREA_082) values (ID_TAREA);

		    insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083)
			select ID_TAREA, ID_DOC_056 from AA79B56T00 where ANYO_056 = ANYO  AND
			NUM_EXP_056 = NUM_EXP AND ID_DOC_REL_056 is null AND ID_DOC_VERSION_056 is null;
		 END IF;

	END IF;



	RETURN RETORNO;

END;
 /