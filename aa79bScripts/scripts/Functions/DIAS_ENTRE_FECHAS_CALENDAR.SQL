CREATE OR REPLACE FUNCTION DIAS_ENTRE_FECHAS_CALENDAR(FECHA_INI IN DATE, FECHA_FIN IN DATE) RETURN NUMBER IS

RETORNO NUMBER:=0;

BEGIN

WITH FECHAS AS
    (SELECT DIA, MOD(TO_CHAR(DIA, 'J'), 7)+1 AS DIA_SEMANA
    , CASE WHEN DIA BETWEEN VERANO_DESDE_022 AND VERANO_HASTA_022 THEN 'V' ELSE 'I' END HORARIO
    FROM (SELECT TRUNC(FECHA_INI) + level - 1 AS DIA
    FROM
      DUAL
    CONNECT BY LEVEL <= (TRUNC(FECHA_FIN) - TRUNC(FECHA_INI) + 1))
    LEFT JOIN AA79B23S01 ON DIA = DIA_CALENDARIO_023
    LEFT JOIN AA79B22S01 ON TO_CHAR(DIA, 'YYYY') = ANYO_CALENDARIO_022
    WHERE MOD(TO_CHAR(DIA, 'J'), 7)+1 NOT IN (6, 7)
    AND DIA_CALENDARIO_023 IS NULL
    )
, HORARIOS AS
    (SELECT DIA_SEMANA, IND_VERANO_039 AS HORARIO, TIPO
    , CASE WHEN TIPO = 'M' THEN DECODE(DIA_SEMANA, 5, HORA_INI_V_M_039, HORA_INI_LJ_M_039) ELSE DECODE(DIA_SEMANA, 5, HORA_INI_V_T_039, HORA_INI_LJ_T_039) END AS HORA_INI
    , CASE WHEN TIPO = 'M' THEN DECODE(DIA_SEMANA, 5, HORA_FIN_V_M_039, HORA_FIN_LJ_M_039) ELSE DECODE(DIA_SEMANA, 5, HORA_FIN_V_T_039, HORA_FIN_LJ_T_039) END AS HORA_FIN
    FROM AA79B39S01
    , (SELECT ROWNUM DIA_SEMANA FROM DUAL CONNECT BY ROWNUM <= 5)
    , (SELECT REGEXP_SUBSTR('M,T', '[^,]+', 1, LEVEL) TIPO FROM DUAL CONNECT BY REGEXP_SUBSTR('M,T', '[^,]+', 1, LEVEL) IS NOT NULL)
    WHERE ID_HORARIO_039  =1
    )
, CALENDARIO AS
    (SELECT F.DIA, F.DIA_SEMANA, F.HORARIO
    , GREATEST(TO_DATE(TO_CHAR(F.DIA, 'DD/MM/YYYY') || HORA_INI, 'DD/MM/YYYYHH24:MI'), FECHA_INI) INICIO
    , LEAST(TO_DATE(TO_CHAR(F.DIA, 'DD/MM/YYYY') || HORA_FIN, 'DD/MM/YYYYHH24:MI'), FECHA_FIN) FIN
    FROM FECHAS F
    JOIN HORARIOS H ON F.DIA_SEMANA = H.DIA_SEMANA AND F.HORARIO = H.HORARIO
    ORDER BY DIA)
SELECT COUNT(DISTINCT DIA)
INTO RETORNO
FROM CALENDARIO
WHERE FIN >= FECHA_INI AND INICIO <= FECHA_FIN
ORDER BY INICIO;

RETURN RETORNO;

END;
/