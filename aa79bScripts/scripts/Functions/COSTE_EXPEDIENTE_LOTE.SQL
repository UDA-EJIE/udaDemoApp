create or replace FUNCTION COSTE_EXPEDIENTE_LOTE( ANYO IN   NUMBER,
   NUM_EXP IN NUMBER, ID_LOTE IN NUMBER, IDS_DOCS IN  VARCHAR2  ) RETURN NUMBER IS

 RETORNO NUMBER(8,2):= 0.0;

 sql_stmt    VARCHAR2(2000);

 LIM_PALABRAS NUMBER(6);

 TYPE r_reg_documentos IS RECORD (
    NUM_TOTAL_PAL_IZO NUMBER(6),
	NUM_TOTAL_PAL NUMBER(6),
	NUM_PAL_CONCOR_0_84 NUMBER(6),
	NUM_PAL_CONCOR_85_94 NUMBER(6),
	NUM_PAL_CONCOR_95_100 NUMBER(6)
);
DOCUMENTOS r_reg_documentos;

TYPE r_reg_lote IS RECORD (
        IMPORTE_PALABRA NUMBER(6,5),
        POR_PAGO_PAL_CONCOR_85_94 NUMBER(3),
        POR_PAGO_PAL_CONCOR_95_100 NUMBER(3),
        POR_REVISION_029 NUMBER(3)
);
LOTE r_reg_lote;

BEGIN
	-- obtenemos el limite de palabras IZO  a partir del cual se realiza presupuesto y proyecto trados
	select  PAL_PRESUPUESTO_003 into LIM_PALABRAS from AA79B03T00 where ID_003 = 0;
	
	sql_stmt := 'select SUM(NUM_PAL_IZO_056), SUM(NUM_TOTAL_PAL_091), SUM(NUM_PAL_CONCOR_0_84_091), SUM(NUM_PAL_CONCOR_85_94_091), 
	SUM(NUM_PAL_CONCOR_95_100_091) from AA79B56T00 
	LEFT JOIN AA79B81T00 ON ANYO_081 = ANYO_056 AND NUM_EXP_081 = NUM_EXP_056 AND ID_TIPO_TAREA_081 = 1
	LEFT JOIN AA79B91T00 ON ID_TAREA_081 = ID_TAREA_091 AND ID_DOC_ORIG_091 = ID_DOC_056 
	WHERE ANYO_056 = '|| ANYO ||' AND NUM_EXP_056 = '||NUM_EXP||' AND ID_DOC_REL_056 is null';
	IF (IDS_DOCS is not null AND IDS_DOCS <> '') THEN
	  sql_stmt := sql_stmt ||' AND ID_DOC_056 in ('|| IDS_DOCS ||')';
	END IF;
	EXECUTE IMMEDIATE sql_stmt INTO DOCUMENTOS;
			
	-- obtenemos los datos del lote
	Select IMPORTE_PALABRA_029, POR_PAGO_PAL_CONCOR_85_94_029, POR_PAGO_PAL_CONCOR_95_100_029, POR_REVISION_029 into LOTE
	FROM AA79B29T00 WHERE ID_LOTE_029 = ID_LOTE;
	
	IF (DOCUMENTOS.NUM_TOTAL_PAL_IZO < LIM_PALABRAS OR DOCUMENTOS.NUM_TOTAL_PAL is null) THEN
		RETORNO:= round(LOTE.IMPORTE_PALABRA*DOCUMENTOS.NUM_TOTAL_PAL_IZO,2);
	ELSE
		-- realizamos el cálculo con lo obtenido de trados.
		RETORNO:= round(((LOTE.IMPORTE_PALABRA*DOCUMENTOS.NUM_PAL_CONCOR_0_84) + 
     				(LOTE.IMPORTE_PALABRA*DOCUMENTOS.NUM_PAL_CONCOR_85_94*(LOTE.POR_PAGO_PAL_CONCOR_85_94/100)) + 
     				(LOTE.IMPORTE_PALABRA*DOCUMENTOS.NUM_PAL_CONCOR_95_100*(LOTE.POR_PAGO_PAL_CONCOR_95_100/100))),2);
	END IF;
	
	RETURN RETORNO;
END;
/