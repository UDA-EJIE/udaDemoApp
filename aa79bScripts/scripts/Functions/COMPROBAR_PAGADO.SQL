CREATE OR REPLACE FUNCTION COMPROBAR_PAGADO ( ANYO IN   NUMBER,
   NUM_EXP IN NUMBER) RETURN VARCHAR IS

RETORNO VARCHAR2(1):='N';
CONTADOR NUMBER(2):=0;

ESTADO_FACTURA_ANULADO NUMBER(2):= 4;
ESTADO_FACTURA_PAGADO  NUMBER(2):=2;

BEGIN	
	  select 
  count(1) - SUM(CASE WHEN ID_TIPO_EXPEDIENTE_051 = 'I' THEN
    (Select count(1) from AA79BA6T00 
    LEFT JOIN AA79BA5T00 ON ANYO_0A5  = ANYO_058 AND NUM_EXP_0A5 = NUM_EXP_058
    LEFT JOIN AA79BA4T00 ON ID_FACTURA_0A4 = ID_FACTURA_0A5 AND TIPO_ENTIDAD_ASOC_0A4 = TIPO_ENTIDAD_ASOC_058 
    AND ID_ENTIDAD_ASOC_0A4 = ID_ENTIDAD_ASOC_058
    AND nvl(DNI_CONTACTO_0A4,-1) = nvl(DNI_CONTACTO_058,-1)
    LEFT JOIN W0512S01 ON ID_LIQUIDACION_0A4 = T12_REFERENCIA AND T00_ESTADO_ID <> ESTADO_FACTURA_ANULADO
    WHERE ID_058 = ID_0A6 AND (T00_ESTADO_ID = ESTADO_FACTURA_PAGADO OR IND_FACTURABLE_0A6 = 'N'))
  ELSE
    (Select count(1) from AA79B98T00 
    LEFT JOIN AA79BA5T00 ON ANYO_0A5  = ANYO_058 AND NUM_EXP_0A5 = NUM_EXP_058
    LEFT JOIN AA79BA4T00 ON ID_FACTURA_0A4 = ID_FACTURA_0A5 AND TIPO_ENTIDAD_ASOC_0A4 = TIPO_ENTIDAD_ASOC_058 
    AND ID_ENTIDAD_ASOC_0A4 = ID_ENTIDAD_ASOC_058
    AND nvl(DNI_CONTACTO_0A4,-1) = nvl(DNI_CONTACTO_058,-1)
    LEFT JOIN W0512S01 ON ID_LIQUIDACION_0A4 = T12_REFERENCIA AND T00_ESTADO_ID <> ESTADO_FACTURA_ANULADO
    WHERE ID_058 = ID_098 AND (T00_ESTADO_ID = ESTADO_FACTURA_PAGADO OR IND_FACTURABLE_098 = 'N'))
  END) AS TOTAL into contador
  from AA79B51T00
  JOIN AA79B58T00 ON ANYO_051 = ANYO_058 AND NUM_EXP_051 = NUM_EXP_058
  WHERE ANYO_051 = ANYO AND NUM_EXP_051 = NUM_EXP;
	IF (CONTADOR = 0) THEN
		RETORNO := 'S';
	END IF;
	
	RETURN RETORNO;
END;
/
