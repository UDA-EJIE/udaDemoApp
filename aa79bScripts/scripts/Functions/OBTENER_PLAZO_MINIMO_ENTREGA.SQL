create or replace
FUNCTION OBTENER_PLAZO_MINIMO_ENTREGA ( TIPO_EXPEDIENTE IN   VARCHAR, NUM_PALABRAS IN NUMBER, IND_PRESUPUESTO IN VARCHAR, IND_VIP IN VARCHAR) RETURN DATE IS

  CONFIGURACION AA79B01S01%ROWTYPE;
  HORARIO_VERANO AA79B21S01%ROWTYPE;
  HORARIO_INVIERNO AA79B21S01%ROWTYPE;
  HORARIO AA79B21S01%ROWTYPE;
  TIPO_INTERPRETACION  VARCHAR2(1):= 'I';
  TIPO_TRADUCCION      VARCHAR2(1):= 'T';
  TIPO_REVISION        VARCHAR2(1):= 'R';
  ID_HORARIO           NUMBER(2);
  HORARIO_VIP          NUMBER(2):= 2;
  HORARIO_NORMAL       NUMBER(2):= 1;
  NUM_PALABRAS_CONFIG  NUMBER(6);
  HORAS_GESTION_CONFIG NUMBER(3);
  HORAS_TOTALES        NUMBER(12,2):=0;
  HORAS_DIA            NUMBER(12,2):=0;
  HORAS_RESTANTES      NUMBER(12,2):=0;
  HORAS_MANANA         NUMBER(12,2):=0;
  HORAS_TARDE          NUMBER(12,2):=0;
  CONTADOR             NUMBER(1)   := 0;
  DIA_INI DATE;
  DIA_SEL DATE;
  DIA_SEMANA_SEL NUMBER(1);
  DIA_DEFINITIVO DATE:= sysdate;
BEGIN
  IF (IND_VIP = 'S') THEN
    SELECT *
    INTO CONFIGURACION
    FROM AA79B01S01
    WHERE ID_001          = 0
    AND NIVEL_USUARIO_001 = 'V';
    ID_HORARIO           := HORARIO_VIP;
  ELSE
    SELECT *
    INTO CONFIGURACION
    FROM AA79B01S01
    WHERE ID_001          = 0
    AND NIVEL_USUARIO_001 = 'N';
    ID_HORARIO           := HORARIO_NORMAL;
  END IF;
  -- OBTENEMOS LOS HORARIOS DE VERANO Y DE INVIERNO
  SELECT *
  INTO HORARIO_VERANO
  FROM AA79B21S01
  WHERE ID_HORARIO_021=ID_HORARIO
  AND IND_VERANO_021  = 'V';
  SELECT *
  INTO HORARIO_INVIERNO
  FROM AA79B21S01
  WHERE ID_HORARIO_021=ID_HORARIO
  AND IND_VERANO_021  = 'I';
  -- MIRAMOS SI HAY QUE REDONDEAR EL NUMERO DE PALABRAS PARA EL CALCULO DE HORAS
  IF (TIPO_EXPEDIENTE    = TIPO_TRADUCCION) THEN
    NUM_PALABRAS_CONFIG := CONFIGURACION.PALABRAS_TRAD_HORA_001;
    HORAS_GESTION_CONFIG:= CONFIGURACION.HORAS_GESTION_TRAD_001;
  ELSE
    NUM_PALABRAS_CONFIG := CONFIGURACION.PALABRAS_REV_HORA_001;
    HORAS_GESTION_CONFIG:= CONFIGURACION.HORAS_GESTION_REV_001;
  END IF;
  -- SUMAMOS LAS HORAS DE GESTION
  HORAS_TOTALES := HORAS_TOTALES + HORAS_GESTION_CONFIG;
  -- SUMAMOS LAS HORAS CORRESPONDIENTES A LAS PALABRAS
  IF (NUM_PALABRAS <= NUM_PALABRAS_CONFIG) THEN
    --NUM_PALABRAS := NUM_PALABRAS_CONFIG;
    HORAS_TOTALES := HORAS_TOTALES + 1;
  ELSE
    --NUM_PALABRAS:=  ceil(NUM_PALABRAS/NUM_PALABRAS_CONFIG)* NUM_PALABRAS_CONFIG from dual;
    HORAS_TOTALES := HORAS_TOTALES + ceil(NUM_PALABRAS/NUM_PALABRAS_CONFIG);
  END IF;
  -- SI ES TRADUCCION TAMBIEN SE SUMAN HORAS POR REVISION
  IF (TIPO_EXPEDIENTE = TIPO_TRADUCCION) THEN
    IF (NUM_PALABRAS <= CONFIGURACION.PALABRAS_REV_HORA_001) THEN
      HORAS_TOTALES  := HORAS_TOTALES + 1;
    ELSE
      HORAS_TOTALES := HORAS_TOTALES + ceil(NUM_PALABRAS/CONFIGURACION.PALABRAS_REV_HORA_001);
    END IF;
  END IF;
  -- MIRAMOS SI SE HA SOLICITADO PRESUPUESTO
  IF (IND_PRESUPUESTO = 'S') THEN
    HORAS_TOTALES    := HORAS_TOTALES + CONFIGURACION.HORAS_EMISION_PRESUPUESTO_001 + CONFIGURACION.HORAS_ACEPT_PRESUPUESTO_001;
  END IF;
  -- HASTA AQUI HEMOS CALCULADO LAS HORAS NECESARIAS PARA REALIZAR EL TRABAJO.
  HORAS_RESTANTES := HORAS_TOTALES;
  DIA_INI              := SYSDATE;
  WHILE HORAS_RESTANTES > 0
  LOOP
    DIA_SEL := to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD'),'YYYY/MM/DD');
    HORAS_DIA      := 0.0;
    DIA_SEMANA_SEL := MOD(TO_CHAR(DIA_INI, 'J'), 7)+1;
    -- COMPROBAMOS QUE NO SEA FIN DE SEMANA
    IF (DIA_SEMANA_SEL < 6) THEN
      --  COMPROBAMOS QUE NO SEA FESTIVO
      SELECT COUNT(1)
      INTO CONTADOR
      FROM AA79B23S01
      WHERE DIA_CALENDARIO_023 = DIA_SEL;
      IF (CONTADOR             = 0) THEN
        -- COMPROBAMOS SI ES UN DIA DE VERANO O DE INVIERNO.
        SELECT COUNT(1)
        INTO CONTADOR
        FROM AA79B22S01
        WHERE ANYO_CALENDARIO_022 = TO_CHAR(DIA_SEL,'YYYY')
        AND VERANO_DESDE_022      <= DIA_SEL
        AND VERANO_HASTA_022      >= DIA_SEL;
        IF (CONTADOR              = 1) THEN
          -- ES VERANO
          HORARIO:=HORARIO_VERANO;
        ELSE
          HORARIO:=HORARIO_INVIERNO;
        END IF;
        -- RECUPERAMOS LAS HORAS DISPONIBLES EN ESE DIA
        IF (DIA_SEMANA_SEL = 5) THEN
          -- ES VIERNES
          IF (DIA_INI    <= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_V_M_021, 'YYYY/MM/DD hh24:mi')) THEN
            HORAS_DIA   := HORAS_DIA + ROUND((24 *(to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_M_021, 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||HORARIO.HORA_INI_V_M_021, ' YYYY/MM/DD hh24:mi')))+ (24 *(to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_T_021,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_V_T_021,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
          ELSIF (DIA_INI <= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_M_021, 'YYYY/MM/DD hh24:mi')) THEN
            HORAS_DIA   := HORAS_DIA + ROUND((24 *(to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_M_021, 'YYYY/MM/DD hh24:mi') - DIA_INI))+ (24 *(to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_T_021,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_V_T_021,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
          ELSIF (DIA_INI <= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_V_T_021, 'YYYY/MM/DD hh24:mi')) THEN
            HORAS_DIA   := HORAS_DIA + ROUND((24 *(to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_T_021,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_V_T_021,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
          ELSIF (DIA_INI <= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_T_021, 'YYYY/MM/DD hh24:mi')) THEN
            HORAS_DIA   := HORAS_DIA + ROUND((24 *(to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_T_021,'08:00'), 'YYYY/MM/DD hh24:mi') - DIA_INI)),2);
          END IF;
        ELSE
          IF (DIA_INI    <= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_LJ_M_021, 'YYYY/MM/DD hh24:mi')) THEN
            HORAS_DIA   := HORAS_DIA + ROUND((24 *(to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_M_021, 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||HORARIO.HORA_INI_LJ_M_021, ' YYYY/MM/DD hh24:mi')))+ (24 *(to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_T_021,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_LJ_T_021,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
          ELSIF (DIA_INI <= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_M_021, 'YYYY/MM/DD hh24:mi')) THEN
            HORAS_DIA   := HORAS_DIA + ROUND((24 *(to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_M_021, 'YYYY/MM/DD hh24:mi') - DIA_INI))+ (24 *(to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_T_021,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_LJ_T_021,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
          ELSIF (DIA_INI <= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_LJ_T_021, 'YYYY/MM/DD hh24:mi')) THEN
            HORAS_DIA   := HORAS_DIA + ROUND((24 *(to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_T_021,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_LJ_T_021,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
          ELSIF (DIA_INI <= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_T_021, 'YYYY/MM/DD hh24:mi')) THEN
            HORAS_DIA   := HORAS_DIA + ROUND((24 *(to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_T_021,'08:00'), 'YYYY/MM/DD hh24:mi') - DIA_INI)),2);
          END IF;
        END IF;
        IF (HORAS_RESTANTES <= HORAS_DIA) THEN
          -- HEMOS ENCONTRADO EL DIA TENEMOS QUE BUSCAR LA HORA CONCRETA TENIENDO EN CUENTA QUE EL HORARIO ESTA PARTIDO.
          IF (DIA_SEMANA_SEL = 5) THEN
            -- ES VIERNES
            IF (DIA_INI        <= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_V_M_021, 'YYYY/MM/DD hh24:mi')) THEN
              HORAS_MANANA    := ROUND((24 *(to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_M_021, 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||HORARIO.HORA_INI_V_M_021, ' YYYY/MM/DD hh24:mi'))),2);
              IF (HORAS_MANANA > HORAS_RESTANTES) THEN
                DIA_DEFINITIVO:= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_V_M_021, 'YYYY/MM/DD hh24:mi') + (HORAS_RESTANTES)/24;
              ELSE
                DIA_DEFINITIVO:= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_V_T_021, 'YYYY/MM/DD hh24:mi') + (HORAS_RESTANTES-HORAS_MANANA)/24;
              END IF;
            ELSIF (DIA_INI     <= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_M_021, 'YYYY/MM/DD hh24:mi')) THEN
              HORAS_MANANA    := ROUND((24 *(to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_M_021, 'YYYY/MM/DD hh24:mi') - DIA_INI)),2);
              IF (HORAS_MANANA > HORAS_RESTANTES) THEN
                DIA_DEFINITIVO:= DIA_INI + (HORAS_RESTANTES)/24;
              ELSE
                DIA_DEFINITIVO:= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_V_T_021, 'YYYY/MM/DD hh24:mi') + (HORAS_RESTANTES-HORAS_MANANA)/24;
              END IF;
            ELSIF (DIA_INI   <= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_V_T_021, 'YYYY/MM/DD hh24:mi')) THEN
              DIA_DEFINITIVO:= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_V_T_021, 'YYYY/MM/DD hh24:mi') + (HORAS_RESTANTES)/24;
            ELSIF (DIA_INI   <= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_T_021, 'YYYY/MM/DD hh24:mi')) THEN
              DIA_DEFINITIVO:= DIA_INI + (HORAS_RESTANTES)/24;
            END IF;
          ELSE
            IF (DIA_INI        <= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_LJ_M_021, 'YYYY/MM/DD hh24:mi')) THEN
              HORAS_MANANA    := ROUND((24 *(to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_M_021, 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' ||HORARIO.HORA_INI_LJ_M_021, ' YYYY/MM/DD hh24:mi'))),2);
              IF (HORAS_MANANA > HORAS_RESTANTES) THEN
                DIA_DEFINITIVO:= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_LJ_M_021, 'YYYY/MM/DD hh24:mi') + (HORAS_RESTANTES)/24;
              ELSE
                DIA_DEFINITIVO:= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_LJ_T_021, 'YYYY/MM/DD hh24:mi') + (HORAS_RESTANTES-HORAS_MANANA)/24;
              END IF;
            ELSIF (DIA_INI     <= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_M_021, 'YYYY/MM/DD hh24:mi')) THEN
              HORAS_MANANA    := ROUND((24 *(to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_M_021, 'YYYY/MM/DD hh24:mi') - DIA_INI)),2);
              IF (HORAS_MANANA > HORAS_RESTANTES) THEN
                DIA_DEFINITIVO:= DIA_INI + (HORAS_RESTANTES)/24;
              ELSE
                DIA_DEFINITIVO:= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_LJ_T_021, 'YYYY/MM/DD hh24:mi') + (HORAS_RESTANTES-HORAS_MANANA)/24;
              END IF;
            ELSIF (DIA_INI   <= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_LJ_T_021, 'YYYY/MM/DD hh24:mi')) THEN
              DIA_DEFINITIVO:= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_LJ_T_021, 'YYYY/MM/DD hh24:mi') + (HORAS_RESTANTES)/24;
            ELSIF (DIA_INI   <= to_date(TO_CHAR(DIA_INI,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_T_021, 'YYYY/MM/DD hh24:mi')) THEN
              DIA_DEFINITIVO:= DIA_INI + (HORAS_RESTANTES)/24;
            END IF;
          END IF;
          HORAS_RESTANTES := 0;
        ELSE
          HORAS_RESTANTES := HORAS_RESTANTES - HORAS_DIA;
          DIA_INI         := DIA_SEL         + 1;
        END IF;
      ELSE
        DIA_INI:= DIA_SEL + 1;
      END IF;
    ELSE
      DIA_INI:= DIA_SEL + 1;
    END IF;
  END LOOP;
  RETURN DIA_DEFINITIVO;
END;
/