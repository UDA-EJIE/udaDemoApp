CREATE OR REPLACE FUNCTION CLONAR_TRABAJO (
   IDTRABAJO IN NUMBER
) RETURN NUMBER IS

	DESC_TRABAJO VARCHAR2(250);
	
	TEXTO_COPIA VARCHAR2(6):= '-KOPIA';
	
	ID_TRABAJO_AUX NUMBER(20);
	ID_TAREA_AUX NUMBER(20);

    CURSOR TAREAS IS (
        SELECT ID_TAREA_0C7, ID_TIPO_TAREA_0C7, ORDEN_0C7
        FROM AA79BC7S01
        WHERE ID_TRABAJO_0C7 = IDTRABAJO
    );

BEGIN

    SELECT DESC_TRABAJO_0C6 into DESC_TRABAJO from AA79BC6S01 WHERE ID_TRABAJO_0C6 = IDTRABAJO;
    IF (LENGTH(DESC_TRABAJO) > 244) THEN
    	DESC_TRABAJO := SUBSTR(DESC_TRABAJO, 0, 244);
    END IF;
    DESC_TRABAJO := DESC_TRABAJO || TEXTO_COPIA;
    
    select AA79BC6Q00.nextVal into ID_TRABAJO_AUX from dual;
    
    INSERT INTO AA79BC6S01 (ID_TRABAJO_0C6, DESC_TRABAJO_0C6, FECHA_INICIO_0C6) 
    VALUES (ID_TRABAJO_AUX, DESC_TRABAJO, sysdate);
    
	 FOR S_TAREAS IN TAREAS LOOP

	 		select AA79BC7Q00.nextVal into ID_TAREA_AUX from dual;
	 
            INSERT INTO AA79BC7S01 (ID_TAREA_0C7, ID_TIPO_TAREA_0C7, ID_TRABAJO_0C7, ORDEN_0C7)
            VALUES (ID_TAREA_AUX, S_TAREAS.ID_TIPO_TAREA_0C7,ID_TRABAJO_AUX, S_TAREAS.ORDEN_0C7);

    END LOOP;
    
    RETURN 1;
END;
/