DEFINE DIR_SCRIPTS = '/aplic/aa79b/scripts';

-- ELIMINAMOS LAS FILAS DE LA TABLA 03 PARA ANYADIR UNA COLUMNA
DELETE FROM AA79B03T00;
-- RENOMBRAR LA COLUMNA PAL_PRESUPUESTO_003 A PAL_PRESUPUESTO_TRADOS_003
ALTER TABLE AA79B03T00
RENAME COLUMN "PAL_PRESUPUESTO_003" TO "PAL_PRESUPUESTO_TRADOS_003";
COMMENT ON COLUMN AA79B03T00.PAL_PRESUPUESTO_TRADOS_003 IS 'Número palabras para solicitar presupuesto y requerir proyecto Trados';
-- ELIMINAMOS LA COLUMNA CREADA
ALTER TABLE AA79B03T00
DROP COLUMN "PAL_TRADOS_003" ;
-- CARGAMOS LA TABLA 03 CON SU VALOR INICIAL
INSERT INTO AA79B03T00 (ID_003, PAL_PRESUPUESTO_TRADOS_003, POR_DESVIACION_PAL_003) 
VALUES (0,1000,10);

-- ELIMINAMOS DATOS DE LA TABLA
DELETE FROM AA79B02T00;
-- VOLVEMOS A PONER LA PK SOLO A ID
ALTER TABLE  AA79B02T00
DROP PRIMARY KEY;
ALTER TABLE AA79B02T00
ADD CONSTRAINT PK_AA79B02T00 PRIMARY KEY (ID_002);
ALTER TABLE AA79B02T00
DROP (PAL_SEG_CONCOR_95_100_002,
     PAL_SEG_CONCOR_85_94_002,
     PAL_SEG_CONCOR_0_84_002,
     PAL_TRAD_SEG_002,
     PAL_REV_SEG_002,
     NIVEL_USUARIO_002,
     ID_TIPO_RELEVANCIA_002);
-- DEJAMOS LAS COLUMNAS COMO ESTABAN
ALTER TABLE AA79B02T00 MODIFY PAL_TRAD_HORA_002 NUMBER(4,0);
ALTER TABLE AA79B02T00 MODIFY PAL_HORA_CONCOR_95_100_002 NUMBER(4,0);
ALTER TABLE AA79B02T00 MODIFY PAL_HORA_CONCOR_85_94_002 NUMBER(4,0);
ALTER TABLE AA79B02T00 MODIFY PAL_HORA_CONCOR_0_84_002 NUMBER(4,0);
ALTER TABLE AA79B02T00 MODIFY PAL_REV_HORA_002 NUMBER(4,0);
-- ANYADIMOS LA COLUMNA
ALTER TABLE AA79B02T00 
ADD LIM_PAL_CONCOR_002 NUMBER(6) NOT NULL;
-- BORRAMOS LOS DATOS DE LA TABLA AA79B02T01
DELETE FROM AA79B02T01;
-- ELIMINAMOS LA TABLA
DROP TABLE AA79B02T01;
-- ELIMINAMOS SU SINONIMO
DROP SYNONYM AA79B02S02;
-- HACEMOS UNA CARGA INICIAL CON LOS VALORES ANTERIORES DE AA79B02T00
INSERT INTO AA79B02T00 (ID_002, PAL_TRAD_HORA_002, LIM_PAL_CONCOR_002, PAL_HORA_CONCOR_95_100_002,
    PAL_HORA_CONCOR_85_94_002, PAL_HORA_CONCOR_0_84_002, PAL_REV_HORA_002) 
VALUES (0, 100,1000,100,100,100,100);

-- ELIMINAMOS DATOS DE LA TABLA
DELETE FROM AA79B45T00;
-- VOLVEMOS A PONER LA PK SOLO A ID
ALTER TABLE  AA79B45T00
DROP PRIMARY KEY;
ALTER TABLE AA79B45T00
ADD CONSTRAINT PK_AA79B45T00 PRIMARY KEY (ID_045);
-- ELIMINAMOS LAS COLUMNAS CREADAS
ALTER TABLE AA79B45T00
DROP (PAL_SEG_CONCOR_95_100_045,
     PAL_SEG_CONCOR_85_94_045,
     PAL_SEG_CONCOR_0_84_045 ,
     PAL_TRAD_SEG_045,
       PAL_REV_SEG_045,
       NIVEL_USUARIO_045);
-- DEJAMOS LAS COLUMNAS COMO ESTABAN
ALTER TABLE AA79B45T00 MODIFY PAL_TRAD_HORA_045 NUMBER(4,0);
ALTER TABLE AA79B45T00 MODIFY PAL_HORA_CONCOR_95_100_045 NUMBER(4,0);
ALTER TABLE AA79B45T00 MODIFY PAL_HORA_CONCOR_85_94_045 NUMBER(4,0);
ALTER TABLE AA79B45T00 MODIFY PAL_HORA_CONCOR_0_84_045 NUMBER(4,0);
ALTER TABLE AA79B45T00 MODIFY PAL_REV_HORA_045 NUMBER(4,0);
-- ANYADIMOS LA COLUMNA
ALTER TABLE AA79B45T00 
ADD LIM_PAL_CONCOR_045 NUMBER(6) NOT NULL;
-- BORRAMOS LOS DATOS DE LA TABLA AA79B45T01
DELETE FROM AA79B45T01;
-- ELIMINAMOS LA TABLA
DROP TABLE AA79B45T01;
-- ELIMINAMOS SU SINONIMO
DROP SYNONYM AA79B45S02;
-- HACEMOS UNA CARGA INICIAL CON LOS VALORES ANTERIORES DE AA79B45T00
INSERT INTO AA79B45T00 (ID_045, PAL_TRAD_HORA_045, LIM_PAL_CONCOR_045, PAL_HORA_CONCOR_95_100_045,
    PAL_HORA_CONCOR_85_94_045, PAL_HORA_CONCOR_0_84_045, PAL_REV_HORA_045) 
VALUES (0, 100,1000,100,100,100,100);

-- ELIMINAMOS LAS COLUMNAS CREADAS EN AA79B56T00
ALTER TABLE AA79B56T00
DROP (NUM_PAL_CONCOR_0_84_056,
	  NUM_PAL_CONCOR_85_94_056,
	  NUM_PAL_CONCOR_95_100_056);

-- LANZAR EL PL DE VERSION ANTERIOR
CREATE OR REPLACE FUNCTION CREAR_TAREAS_EXPEDIENTE( 
		   ANYO IN   NUMBER,
		   NUM_EXP IN NUMBER,
		   USUARIO IN VARCHAR2 ) 
		RETURN NUMBER 
	IS

		ID_GRUPO_TRABAJO NUMBER(3);
		DNI_RESPONSABLE VARCHAR2(10);
		NUM_TOTAL_PAL_IZO NUMBER(6);
		
		ESTADO_TAREA NUMBER(1);
		ESTADO_ASIGNACION_TAREA NUMBER(1):= 1;
		ESTADO_PDTE_ACEPTACION_TAREA NUMBER(1):= 2;
		ESTADO_ACEPTACION_TAREA NUMBER(1):= 3;
		TAREA_PENDIENTE_EJECUCION NUMBER(1):= 1;
		PROYECTO_TRADOS NUMBER(2):= 1;
		ID_TAREA NUMBER(20):= 0;
		DESC_TAREA_ES VARCHAR2(150);
		DESC_TAREA_EU VARCHAR2(150);
		
		ESTADO_BITACORA NUMBER(3);
		EXPEDIENTE_EN_CURSO NUMBER(1):= 3;
		FASE_EXP_PDTE_PROY_TRADOS NUMBER(1):= 6;
		
		ID_PROCESO_EMAIL NUMBER(20):= 0;
		NUM_EMAIL NUMBER(2):= 1;
		TIPO_AVISO NUMBER(2):= 5;
		
		EMAIL_DESTINATARIO VARCHAR2(256);
		TIPO_REVISION VARCHAR2(1):= 'R';
		TIPO_TRADUCCION VARCHAR2(1):= 'T';
		ID_TIPO_EXPEDIENTE VARCHAR2(1);
		DNI_TECNICO VARCHAR2(10);
		TITULO_EXPEDIENTE VARCHAR2(150);
		ORIGEN VARCHAR2(1);
		APLIC_ORIGEN VARCHAR2(6);
		ENTREGA_CLIENTE_REVISION NUMBER(2):= 20;
		ORDEN NUMBER(2):= 1;
		
		OSAKIDETZA VARCHAR2(50);
		UPV VARCHAR2(50);
		TIPO_ENTIDAD VARCHAR2(1);
    	ID_ENTIDAD NUMBER(8);
		
		RETORNO NUMBER(20);
		FECHA_INICIO DATE;
		FECHA_FIN DATE;
		
		CONTADOR NUMBER(2):=0;
		CONTADORTRADOS NUMBER(2):=0;
		
		LIM_PALABRAS NUMBER(6);

	BEGIN
		
		-- obtenemos el limite de palabras IZO  a partir del cual se realiza presupuesto y proyecto trados
		select  PAL_PRESUPUESTO_TRADOS_003 into LIM_PALABRAS from AA79B03T00 where ID_003 = 0;
		
		SELECT ID_TIPO_EXPEDIENTE_051, ORIGEN_051, APLIC_ORIGEN_051, DNI_TECNICO_051, TITULO_051 into ID_TIPO_EXPEDIENTE, ORIGEN, APLIC_ORIGEN, DNI_TECNICO, TITULO_EXPEDIENTE FROM AA79B51T00 WHERE ANYO_051 = ANYO AND NUM_EXP_051 = NUM_EXP;
		IF (ID_TIPO_EXPEDIENTE = TIPO_TRADUCCION) THEN
		
			ID_GRUPO_TRABAJO:= OBTENER_GRUPO_TRABAJO(ANYO,NUM_EXP);
	
			SELECT DNI_RESPONSABLE_026 into DNI_RESPONSABLE FROM AA79B26T00 WHERE ID_026 = ID_GRUPO_TRABAJO;
	
			SELECT NUM_TOTAL_PAL_IZO_053 into NUM_TOTAL_PAL_IZO FROM AA79B53T00 WHERE ANYO_053 = ANYO AND NUM_EXP_053 = NUM_EXP;
	
			IF (NUM_TOTAL_PAL_IZO > LIM_PALABRAS) THEN
	
	
				SELECT COUNT(1) INTO CONTADORTRADOS FROM AA79B81T00 WHERE ID_TIPO_TAREA_081 = PROYECTO_TRADOS AND ANYO_081 = ANYO AND NUM_EXP_081 = NUM_EXP;
			 	IF (CONTADORTRADOS = 0) THEN
	
					SELECT AA79B81Q00.NEXTVAL INTO ID_TAREA FROM dual;
		
					ESTADO_TAREA:= ESTADO_PDTE_ACEPTACION_TAREA;
			    	IF (DNI_RESPONSABLE = USUARIO) THEN
			    		ESTADO_TAREA:= ESTADO_ACEPTACION_TAREA;
			    	END IF;
		
			        INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) VALUES (ANYO,DNI_RESPONSABLE,ESTADO_TAREA,TAREA_PENDIENTE_EJECUCION,null,null,SYSDATE + 30 / (24*60),SYSDATE,'00:30',ID_TAREA,null,null,'N','N',null,NUM_EXP,null,0,'I',PROYECTO_TRADOS,null,null,null,null);
			        
			        INSERT INTO AA79B82T00 (ID_TAREA_082) values (ID_TAREA);
			        
			        insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) 
					select ID_TAREA, ID_DOC_056 from AA79B56T00 where ANYO_056 = ANYO  AND 
					NUM_EXP_056 = NUM_EXP AND ID_DOC_REL_056 is null AND ID_DOC_VERSION_056 is null;
			
					SELECT nvl(max(ID_ESTADO_BITACORA_059),0) + 1 INTO ESTADO_BITACORA FROM AA79B59S01 t1 WHERE NUM_EXP_059 = NUM_EXP AND ANYO_059 = ANYO;
				
			        INSERT INTO AA79B59S01 (ANYO_059, NUM_EXP_059, ID_ESTADO_BITACORA_059, ID_ESTADO_EXP_059, ID_FASE_EXPEDIENTE_059, DATO_ADIC_059, INFO_ADIC_059, ID_RECHAZO_059, ID_REQUERIMIENTO_059, FECHA_ALTA_059) VALUES (ANYO,NUM_EXP,ESTADO_BITACORA,EXPEDIENTE_EN_CURSO,FASE_EXP_PDTE_PROY_TRADOS,null,null,null,null, SYSDATE);
			        
			        UPDATE AA79B51S01 SET ESTADO_BITACORA_051= ESTADO_BITACORA WHERE ANYO_051 = ANYO AND NUM_EXP_051 = NUM_EXP;
        
			        IF (DNI_RESPONSABLE != USUARIO) THEN
			        
				        SELECT AA79BB2Q00.NEXTVAL INTO ID_PROCESO_EMAIL FROM dual;
				        
				        SELECT DESC_ES_015, DESC_EU_015 into DESC_TAREA_ES, DESC_TAREA_EU FROM AA79B15T00 WHERE ID_015 = PROYECTO_TRADOS;
				        
				        SELECT EMAIL_031 into EMAIL_DESTINATARIO FROM X54JAPI_DATOS_CONTACTO WHERE DNI_031 = DNI_RESPONSABLE;
				        
				        INSERT INTO AA79BB2T00 (ID_PROCESO_EMAIL_0B2, NUM_EMAIL_0B2, ID_TIPO_AVISO_0B2, ANYO_0B2, NUM_EXP_0B2, TITULO_EXP_0B2, ID_TAREA_0B2, ID_TIPO_TAREA_0B2, DESC_TAREA_ES_0B2, DESC_TAREA_EU_0B2, DNI_DESTINATARIO_0B2, EMAIL_DESTINATARIO_0B2) VALUES (ID_PROCESO_EMAIL, NUM_EMAIL, TIPO_AVISO, ANYO, NUM_EXP, TITULO_EXPEDIENTE, ID_TAREA, PROYECTO_TRADOS, DESC_TAREA_ES, DESC_TAREA_EU, DNI_RESPONSABLE, EMAIL_DESTINATARIO);
				        
				        NUM_EMAIL:= NUM_EMAIL + 1;
				        
				        RETORNO:= ID_PROCESO_EMAIL;
				        
				    ELSE 
				     
				     	RETORNO:= NULL;
				    
				    END IF;
				END IF;
        
		    ELSE
		    
		    	RETORNO:= NULL;
			
			END IF;
		END IF;
		
	
	
	SELECT VALOR_000 into OSAKIDETZA FROM AA79B00T00 WHERE ID_000 = 4;
	SELECT VALOR_000 into UPV FROM AA79B00T00 WHERE ID_000 = 5;
	SELECT TIPO_ENTIDAD_054, ID_ENTIDAD_054 into TIPO_ENTIDAD, ID_ENTIDAD FROM AA79B54T00 WHERE ANYO_054 = ANYO AND NUM_EXP_054 = NUM_EXP;
	
	IF (ORIGEN = 'W' AND APLIC_ORIGEN = 'P43' AND ID_TIPO_EXPEDIENTE = TIPO_REVISION AND TIPO_ENTIDAD = 'B' AND (ID_ENTIDAD = OSAKIDETZA OR ID_ENTIDAD = UPV)) THEN
	
	
		SELECT COUNT(1) INTO CONTADOR FROM AA79B81T00 WHERE ID_TIPO_TAREA_081 = ENTREGA_CLIENTE_REVISION AND ANYO_081 = ANYO AND NUM_EXP_081 = NUM_EXP;
	 	IF (CONTADOR = 0) THEN
			SELECT AA79B81Q00.NEXTVAL INTO ID_TAREA FROM dual;	
	 	
	 		ESTADO_TAREA:= ESTADO_PDTE_ACEPTACION_TAREA;
	    	IF (DNI_TECNICO = USUARIO) THEN
	    		ESTADO_TAREA:= ESTADO_ACEPTACION_TAREA;
	    	END IF;
	    	
	    	IF (CONTADORTRADOS = 0 AND NUM_TOTAL_PAL_IZO > LIM_PALABRAS) THEN
	    		FECHA_INICIO:= SYSDATE + 30 / (24*60);
	    		FECHA_FIN:= SYSDATE + 60 / (24*60);
	    	ELSE
	    		FECHA_INICIO:= SYSDATE;
	    		FECHA_FIN:= SYSDATE + 30 / (24*60);
	    	END IF;
	    	
			INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) VALUES (ANYO,DNI_TECNICO,ESTADO_TAREA,TAREA_PENDIENTE_EJECUCION,null,null,FECHA_FIN,FECHA_INICIO,'00:30',ID_TAREA,null,null,'N','N',null,NUM_EXP,null,1,'I',ENTREGA_CLIENTE_REVISION,null,null,null,1);
		    INSERT INTO AA79B82T00 (ID_TAREA_082) values (ID_TAREA);
		    
		    insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) 
			select ID_TAREA, ID_DOC_056 from AA79B56T00 where ANYO_056 = ANYO  AND 
			NUM_EXP_056 = NUM_EXP AND ID_DOC_REL_056 is null AND ID_DOC_VERSION_056 is null;
		 END IF;
	
	END IF;	
	
	
	
	RETURN RETORNO;
	
END;
/


create or replace
FUNCTION OBTENER_GRUPO_TRABAJO( ANYO IN NUMBER,
  NUM_EXP IN NUMBER) RETURN NUMBER IS

ID_GRUPO_TRABAJO NUMBER(3):= NULL;
ID_GRUPO_GAINERAKO NUMBER(3):= 0;

TIPO_EXP_INTERPRETACION  VARCHAR2(1):= 'I';
TIPO_GRUPO_INTERPRETACION  NUMBER(1):= 0;
TIPO_GRUPO_TRADREV  NUMBER(1):= 1;


TYPE r_reg_expediente IS RECORD (
   ID_TIPO_EXPEDIENTE VARCHAR2(1),
   IND_PUBLICAR_BOPV VARCHAR2(1),
   IND_PREVISTO_BOPV VARCHAR2(1),
   TIPO_ENTIDAD VARCHAR2(1),
   ID_ENTIDAD NUMBER(8)
);
EXPEDIENTE r_reg_expediente;

BEGIN
    -- obtenemos los datos del expediente
    SELECT ID_TIPO_EXPEDIENTE_051, IND_PUBLICAR_BOPV_053, IND_PREVISTO_BOPV_053, TIPO_ENTIDAD_054, ID_ENTIDAD_054 into EXPEDIENTE
    FROM AA79B51S01 
    JOIN AA79B54S01 ON ANYO_054 = ANYO_051 AND NUM_EXP_054 = NUM_EXP_051
    LEFT JOIN AA79B53S01 ON ANYO_053 = ANYO_051 AND NUM_EXP_053 = NUM_EXP_051
    WHERE ANYO_051 = ANYO AND NUM_EXP_051 = NUM_EXP;
    
    IF (EXPEDIENTE.ID_TIPO_EXPEDIENTE = TIPO_EXP_INTERPRETACION) THEN
    	BEGIN
    		SELECT ID_026 into ID_GRUPO_TRABAJO FROM AA79B26T00 WHERE ID_TIPO_EXPEDIENTE_026 = TIPO_GRUPO_INTERPRETACION
    		AND ESTADO_026 = 'A';
    	EXCEPTION
          WHEN NO_DATA_FOUND THEN
		        ID_GRUPO_TRABAJO:= NULL;
          END;
    ELSE
    	IF (EXPEDIENTE.IND_PUBLICAR_BOPV = 'S' OR EXPEDIENTE.IND_PREVISTO_BOPV = 'S') THEN
    		BEGIN
	    		SELECT ID_026 into ID_GRUPO_TRABAJO FROM AA79B26S01 WHERE ID_TIPO_EXPEDIENTE_026 = TIPO_GRUPO_TRADREV
	    		AND ESTADO_026 = 'A' AND IND_BOPV_026 = 'S';
	    	EXCEPTION
	          WHEN NO_DATA_FOUND THEN
			        ID_GRUPO_TRABAJO:= NULL;
	        END;
	    END IF;
	    IF (ID_GRUPO_TRABAJO is NULL) THEN
    		BEGIN
	    		SELECT ID_026 into ID_GRUPO_TRABAJO FROM AA79B26S01
	    		JOIN AA79B27S01 ON ID_026 = ID_GRUPO_027
	    		WHERE ID_TIPO_EXPEDIENTE_026 = TIPO_GRUPO_TRADREV
	    		AND ESTADO_026 = 'A' 
	    		AND TIPO_ENTIDAD_027 = EXPEDIENTE.TIPO_ENTIDAD
	    		AND ID_ENTIDAD_027 = EXPEDIENTE.ID_ENTIDAD;
	    	EXCEPTION
	          WHEN NO_DATA_FOUND THEN
			        ID_GRUPO_TRABAJO:= ID_GRUPO_GAINERAKO;
	        END;
    	END IF;
    END IF;
	
    RETURN ID_GRUPO_TRABAJO;
    
	
END;
/

CREATE OR REPLACE
  FUNCTION OBTENER_ESTUDIO(
      TIPO_TAREA     IN NUMBER,
      FECHA_INI      IN DATE,
      FECHA_FIN      IN DATE,
      NUM_PALABRAS   IN NUMBER,
      NUM_PAL_0_84   IN NUMBER,
      NUM_PAL_85_94  IN NUMBER,
      NUM_PAL_95_100 IN NUMBER)
    RETURN ESTUDIO_TABLE
  IS
    l_estudio ESTUDIO_TABLE := ESTUDIO_TABLE();
    HORARIO_INVIERNO AA79B39S01%ROWTYPE;
    HORARIO_VERANO AA79B39S01%ROWTYPE;
    HORARIO AA79B39S01%ROWTYPE;
    ID_HORARIO NUMBER(2)   :=1;
    HORAS_ACUM NUMBER(12,2):=0;
    DIA_SEL DATE;
    DIA_PROC DATE;
    DIA_FIN DATE;
    DIA_SEMANA_SEL NUMBER(1);
    CONFIG_INTERNA AA79B02S01%ROWTYPE;
    CONFIG_EXTERNA AA79B45S01%ROWTYPE;
    CONTADOR      NUMBER(2)  := 0;
    HORAS_TRABAJO NUMBER(5,2):= 0.0;
    NUM_RECURSOS  NUMBER(3)  := 0;
    DIAS_REALES   NUMBER(5)  := 0;
    TRADUCCION    NUMBER(2)  := 2;
    REVISION      NUMBER(2)  := 4 ;
    -- obtenemos los dias entre 2 fechas y indicando si son en verano o no
  BEGIN
    -- OBTENEMOS LOS HORARIOS DE VERANO Y DE INVIERNO
    SELECT *
    INTO HORARIO_VERANO
    FROM AA79B39S01
    WHERE ID_HORARIO_039=ID_HORARIO
    AND IND_VERANO_039  = 'V';
    SELECT *
    INTO HORARIO_INVIERNO
    FROM AA79B39S01
    WHERE ID_HORARIO_039                                         =ID_HORARIO
    AND IND_VERANO_039                                           = 'I';
    DIA_FIN                                                     := to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD'),'YYYY/MM/DD');
    DIA_PROC                                                    := FECHA_INI;
    HORAS_ACUM                                                  := 0.0;
    WHILE (to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD'),'YYYY/MM/DD') <= to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD'),'YYYY/MM/DD'))
    LOOP
      DIA_SEL        := to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD'),'YYYY/MM/DD');
      DIA_SEMANA_SEL := MOD(TO_CHAR(DIA_PROC, 'J'), 7)+1;
      -- COMPROBAMOS QUE NO SEA FIN DE SEMANA
      IF (DIA_SEMANA_SEL < 6) THEN
        --  COMPROBAMOS QUE NO SEA FESTIVO
        SELECT COUNT(1)
        INTO CONTADOR
        FROM AA79B23S01
        WHERE DIA_CALENDARIO_023 = DIA_SEL;
        IF (CONTADOR             = 0) THEN
          -- COMPROBAMOS SI ES UN DIA DE VERANO O DE INVIERNO.
          SELECT COUNT(1)
          INTO CONTADOR
          FROM AA79B22S01
          WHERE ANYO_CALENDARIO_022 = TO_CHAR(DIA_SEL,'YYYY')
          AND VERANO_DESDE_022     <= DIA_SEL
          AND VERANO_HASTA_022     >= DIA_SEL;
          IF (CONTADOR              = 1) THEN
            -- ES VERANO
            HORARIO:=HORARIO_VERANO;
          ELSE
            HORARIO:=HORARIO_INVIERNO;
          END IF;
          -- RECUPERAMOS LAS HORAS DISPONIBLES EN ESE DIA
          IF (DIA_SEL          = DIA_FIN) THEN
            IF (DIA_SEMANA_SEL = 5) THEN
              -- ES VIERNES
              IF (DIA_PROC       < to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_V_M_039, 'YYYY/MM/DD hh24:mi')) THEN
                IF (FECHA_FIN    < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_V_M_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +0.0;
                  --DIAS_REALES   := DIAS_REALES + 1;
              	ELSIF (FECHA_FIN    < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_M_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(FECHA_FIN - to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_V_M_039, 'YYYY/MM/DD hh24:mi'))),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                ELSIF (FECHA_FIN < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_V_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_M_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_V_M_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                ELSIF (FECHA_FIN < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_M_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_V_M_039,'08:00'), 'YYYY/MM/DD hh24:mi')))+(24 *(FECHA_FIN - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                ELSIF (FECHA_FIN > to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_M_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_V_M_039,'08:00'), 'YYYY/MM/DD hh24:mi')))+(24 *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                END IF;
              ELSIF (DIA_PROC    < to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_M_039, 'YYYY/MM/DD hh24:mi')) THEN
                IF (FECHA_FIN    < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_M_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(FECHA_FIN - DIA_PROC)),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                ELSIF (FECHA_FIN < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_V_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_M_039,'08:00'), 'YYYY/MM/DD hh24:mi') - DIA_PROC)),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                ELSIF (FECHA_FIN < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_M_039,'08:00'), 'YYYY/MM/DD hh24:mi') - DIA_PROC))+(24 *(FECHA_FIN - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                ELSIF (FECHA_FIN > to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_M_039,'08:00'), 'YYYY/MM/DD hh24:mi') - DIA_PROC))+(24 *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                END IF;
              ELSIF (DIA_PROC    < to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_V_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                IF (FECHA_FIN    < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_V_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +0.0;
                  --DIAS_REALES   := DIAS_REALES + 1;
              	ELSIF (FECHA_FIN    < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(FECHA_FIN - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                ELSIF (FECHA_FIN > to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                END IF;
              ELSIF (DIA_PROC    < to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                IF (FECHA_FIN    < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(FECHA_FIN - DIA_PROC)),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                ELSIF (FECHA_FIN > to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - DIA_PROC)),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                END IF;
              END IF;
            ELSE
              IF (DIA_PROC       < to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_LJ_M_039, 'YYYY/MM/DD hh24:mi')) THEN
                IF (FECHA_FIN    < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_LJ_M_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +0.0;
                  --DIAS_REALES   := DIAS_REALES + 1;
              	ELSIF (FECHA_FIN    < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_M_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(FECHA_FIN - to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_LJ_M_039, 'YYYY/MM/DD hh24:mi'))),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                ELSIF (FECHA_FIN < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_LJ_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_M_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_LJ_M_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                ELSIF (FECHA_FIN < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_M_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_LJ_M_039,'08:00'), 'YYYY/MM/DD hh24:mi')))+(24 *(FECHA_FIN - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                ELSIF (FECHA_FIN > to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_M_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_LJ_M_039,'08:00'), 'YYYY/MM/DD hh24:mi')))+(24 *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                END IF;
              ELSIF (DIA_PROC    < to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_M_039, 'YYYY/MM/DD hh24:mi')) THEN
                IF (FECHA_FIN    < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_M_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(FECHA_FIN - DIA_PROC)),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                ELSIF (FECHA_FIN < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_LJ_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_M_039,'08:00'), 'YYYY/MM/DD hh24:mi') - DIA_PROC)),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                ELSIF (FECHA_FIN < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_M_039,'08:00'), 'YYYY/MM/DD hh24:mi') - DIA_PROC))+(24 *(FECHA_FIN - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                ELSIF (FECHA_FIN > to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_M_039,'08:00'), 'YYYY/MM/DD hh24:mi') - DIA_PROC))+(24 *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                END IF;
              ELSIF (DIA_PROC    < to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_LJ_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                IF (FECHA_FIN    < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_LJ_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +0.0;
                  --DIAS_REALES   := DIAS_REALES + 1;
              	ELSIF (FECHA_FIN    < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(FECHA_FIN - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                ELSIF (FECHA_FIN > to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                END IF;
              ELSIF (DIA_PROC    < to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                IF (FECHA_FIN    < to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(FECHA_FIN - DIA_PROC)),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                ELSIF (FECHA_FIN > to_date(TO_CHAR(FECHA_FIN,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                  HORAS_ACUM    := HORAS_ACUM  +ROUND((24 *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - DIA_PROC)),2);
                  DIAS_REALES   := DIAS_REALES + 1;
                END IF;
              END IF;
            END IF;
          ELSE
            IF (DIA_SEMANA_SEL = 5) THEN
              -- ES VIERNES
              IF (DIA_PROC    < to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_V_M_039, 'YYYY/MM/DD hh24:mi')) THEN
                HORAS_ACUM   := ROUND((24   *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_M_039, 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||HORARIO.HORA_INI_V_M_039, ' YYYY/MM/DD hh24:mi')))+ (24 *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                DIAS_REALES  := DIAS_REALES + 1;
              ELSIF (DIA_PROC < to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_M_039, 'YYYY/MM/DD hh24:mi')) THEN
                HORAS_ACUM   := ROUND((24   *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_M_039, 'YYYY/MM/DD hh24:mi') - DIA_PROC))+ (24 *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                DIAS_REALES  := DIAS_REALES + 1;
              ELSIF (DIA_PROC < to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_V_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                HORAS_ACUM   := ROUND((24   *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                DIAS_REALES  := DIAS_REALES + 1;
              ELSIF (DIA_PROC < to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_V_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                HORAS_ACUM   := HORAS_ACUM  + ROUND((24 *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_V_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - DIA_PROC)),2);
                DIAS_REALES  := DIAS_REALES + 1;
              END IF;
            ELSE
              IF (DIA_PROC    < to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_LJ_M_039, 'YYYY/MM/DD hh24:mi')) THEN
                HORAS_ACUM   := ROUND((24   *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_M_039, 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||HORARIO.HORA_INI_LJ_M_039, ' YYYY/MM/DD hh24:mi')))+ (24 *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                DIAS_REALES  := DIAS_REALES + 1;
              ELSIF (DIA_PROC < to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_M_039, 'YYYY/MM/DD hh24:mi')) THEN
                HORAS_ACUM   := ROUND((24   *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_M_039, 'YYYY/MM/DD hh24:mi') - DIA_PROC))+ (24 *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                DIAS_REALES  := DIAS_REALES + 1;
              ELSIF (DIA_PROC < to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_INI_LJ_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                HORAS_ACUM   := ROUND((24   *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_INI_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi'))),2);
                DIAS_REALES  := DIAS_REALES + 1;
              ELSIF (DIA_PROC < to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' || HORARIO.HORA_FIN_LJ_T_039, 'YYYY/MM/DD hh24:mi')) THEN
                HORAS_ACUM   := HORAS_ACUM  + ROUND((24 *(to_date(TO_CHAR(DIA_PROC,'YYYY/MM/DD') || ' ' ||NVL(HORARIO.HORA_FIN_LJ_T_039,'08:00'), 'YYYY/MM/DD hh24:mi') - DIA_PROC)),2);
                DIAS_REALES  := DIAS_REALES + 1;
              END IF;
            END IF;
          END IF;
        END IF;
      END IF;
      DIA_PROC           := DIA_SEL + 1;
    END LOOP;
    -- calculamos las horas necesarias para realizar el trabajo de manera interna o externa
    -- interna
    -- recuperamos de configuración general los datos correspondientes.
    BEGIN
      SELECT * INTO CONFIG_INTERNA FROM AA79B02S01 WHERE ID_002 = 0;
      IF (TIPO_TAREA        = TRADUCCION) THEN
        IF (NUM_PALABRAS   >= CONFIG_INTERNA.LIM_PAL_CONCOR_002) THEN
          HORAS_TRABAJO    := ROUND(NUM_PAL_0_84/CONFIG_INTERNA.PAL_HORA_CONCOR_0_84_002,2) + ROUND(NUM_PAL_85_94/CONFIG_INTERNA.PAL_HORA_CONCOR_85_94_002,2)+ ROUND(NUM_PAL_95_100/CONFIG_INTERNA.PAL_HORA_CONCOR_95_100_002,2);
          IF (HORAS_TRABAJO = 0) THEN
            HORAS_TRABAJO  := ROUND(NUM_PALABRAS/CONFIG_INTERNA.PAL_TRAD_HORA_002,2);
          END IF;
        ELSE
          HORAS_TRABAJO:= ROUND(NUM_PALABRAS/CONFIG_INTERNA.PAL_TRAD_HORA_002,2);
        END IF;
      ELSE
        HORAS_TRABAJO:= ROUND(NUM_PALABRAS/CONFIG_INTERNA.PAL_REV_HORA_002,2);
      END IF;
      NUM_RECURSOS:= CEIL(HORAS_TRABAJO/HORAS_ACUM);
      l_estudio.EXTEND;
      l_estudio(l_estudio.count) := (STRUCT_ESTUDIO('I', NUM_RECURSOS ,FORMAT_HORA_MINUTOS(HORAS_TRABAJO), FORMAT_HORA_MINUTOS(ROUND((HORAS_TRABAJO/DIAS_REALES)/NUM_RECURSOS,2)))) ;
      -- externa
      SELECT * INTO CONFIG_EXTERNA FROM AA79B45S01 WHERE ID_045 = 0;
      IF (TIPO_TAREA        = TRADUCCION) THEN
        IF (NUM_PALABRAS   >= CONFIG_EXTERNA.LIM_PAL_CONCOR_045) THEN
          HORAS_TRABAJO    := ROUND(NUM_PAL_0_84/CONFIG_EXTERNA.PAL_HORA_CONCOR_0_84_045,2) + ROUND(NUM_PAL_85_94/CONFIG_EXTERNA.PAL_HORA_CONCOR_85_94_045,2)+ ROUND(NUM_PAL_95_100/CONFIG_EXTERNA.PAL_HORA_CONCOR_95_100_045,2);
          IF (HORAS_TRABAJO = 0) THEN
            HORAS_TRABAJO  := ROUND(NUM_PALABRAS/CONFIG_EXTERNA.PAL_TRAD_HORA_045,2);
          END IF;
        ELSE
          HORAS_TRABAJO:= ROUND(NUM_PALABRAS/CONFIG_EXTERNA.PAL_TRAD_HORA_045,2);
        END IF;
      ELSE
        HORAS_TRABAJO:= ROUND(NUM_PALABRAS/CONFIG_EXTERNA.PAL_REV_HORA_045,2);
      END IF;
      NUM_RECURSOS:= CEIL(HORAS_TRABAJO/HORAS_ACUM);
      l_estudio.EXTEND;
      l_estudio(l_estudio.count) := (STRUCT_ESTUDIO('E', NUM_RECURSOS ,FORMAT_HORA_MINUTOS(HORAS_TRABAJO), FORMAT_HORA_MINUTOS(ROUND((HORAS_TRABAJO/DIAS_REALES)/NUM_RECURSOS,2)))) ;
    EXCEPTION
    WHEN OTHERS THEN
      l_estudio:= ESTUDIO_TABLE();
      l_estudio.EXTEND;
      l_estudio(l_estudio.count) := (STRUCT_ESTUDIO('I', 0 ,'00:00', '00:00')) ;
      l_estudio.EXTEND;
      l_estudio(l_estudio.count) := (STRUCT_ESTUDIO('E', 0 ,'00:00', '00:00')) ;
    END;
    -- fin
    RETURN l_estudio;
  END;
  /
  
CREATE OR REPLACE FUNCTION COSTE_EXPEDIENTE_LOTE( ANYO IN   NUMBER,
   NUM_EXP IN NUMBER, ID_LOTE IN NUMBER, IDS_DOCS IN  VARCHAR2  ) RETURN NUMBER IS

 RETORNO NUMBER(8,2):= 0.0;

 sql_stmt    VARCHAR2(2000);

 LIM_PALABRAS NUMBER(6);

 TYPE r_reg_documentos IS RECORD (
    NUM_TOTAL_PAL_IZO NUMBER(6),
	NUM_TOTAL_PAL NUMBER(6),
	NUM_PAL_CONCOR_0_84 NUMBER(6),
	NUM_PAL_CONCOR_85_94 NUMBER(6),
	NUM_PAL_CONCOR_95_100 NUMBER(6)
);
DOCUMENTOS r_reg_documentos;

TYPE r_reg_lote IS RECORD (
        IMPORTE_PALABRA NUMBER(6,5),
        POR_PAGO_PAL_CONCOR_85_94 NUMBER(3),
        POR_PAGO_PAL_CONCOR_95_100 NUMBER(3),
        POR_REVISION_029 NUMBER(3)
);
LOTE r_reg_lote;




BEGIN
	-- obtenemos el limite de palabras IZO  a partir del cual se realiza presupuesto y proyecto trados
	select  PAL_PRESUPUESTO_TRADOS_003 into LIM_PALABRAS from AA79B03T00 where ID_003 = 0;
	
	sql_stmt := 'select SUM(NUM_PAL_IZO_056), SUM(NUM_TOTAL_PAL_091), SUM(NUM_PAL_CONCOR_0_84_091), SUM(NUM_PAL_CONCOR_85_94_091), 
	SUM(NUM_PAL_CONCOR_95_100_091) from AA79B56T00 
	LEFT JOIN AA79B81T00 ON ANYO_081 = ANYO_056 AND NUM_EXP_081 = NUM_EXP_056 AND ID_TIPO_TAREA_081 = 1
	LEFT JOIN AA79B91T00 ON ID_TAREA_081 = ID_TAREA_091 AND ID_DOC_ORIG_091 = ID_DOC_056 
	WHERE ANYO_056 = '|| ANYO ||' AND NUM_EXP_056 = '||NUM_EXP||' AND ID_DOC_REL_056 is null';
	IF (IDS_DOCS is not null AND IDS_DOCS <> '') THEN
	  sql_stmt := sql_stmt ||' AND ID_DOC_056 in ('|| IDS_DOCS ||')';
	END IF;
	EXECUTE IMMEDIATE sql_stmt INTO DOCUMENTOS;
			
	-- obtenemos los datos del lote
	Select IMPORTE_PALABRA_029, POR_PAGO_PAL_CONCOR_85_94_029, POR_PAGO_PAL_CONCOR_95_100_029, POR_REVISION_029 into LOTE
	FROM AA79B29T00 WHERE ID_LOTE_029 = ID_LOTE;
	
	IF (DOCUMENTOS.NUM_TOTAL_PAL_IZO < LIM_PALABRAS OR DOCUMENTOS.NUM_TOTAL_PAL is null) THEN
		RETORNO:= round(LOTE.IMPORTE_PALABRA*DOCUMENTOS.NUM_TOTAL_PAL_IZO,2);
	ELSE
		-- realizamos el cálculo con lo obtenido de trados.
		RETORNO:= round(((LOTE.IMPORTE_PALABRA*DOCUMENTOS.NUM_PAL_CONCOR_0_84) + 
     				(LOTE.IMPORTE_PALABRA*DOCUMENTOS.NUM_PAL_CONCOR_85_94*(LOTE.POR_PAGO_PAL_CONCOR_85_94/100)) + 
     				(LOTE.IMPORTE_PALABRA*DOCUMENTOS.NUM_PAL_CONCOR_0_84*(LOTE.POR_PAGO_PAL_CONCOR_95_100/100))),2);
	END IF;
	
	RETURN RETORNO;
END;
/

CREATE OR REPLACE FUNCTION IMPORTE_PREVISTO_LOTE(ID_LOTE IN NUMBER, ID_TAREA IN NUMBER) RETURN NUMBER IS

--
  -- OBTIENE EL IMPORTE PREVISTO PARA EL LOTE, esto es, el facturado no pagado y el sin facturar.
  -- El id de tarea se corresponde con el id de tarea de revision de los datos de pago del proveedor que se pudiera estar tratando, 
  -- para descartar esa tarea en el cálculo ya que se le sumará en pantalla según los datos introducidos
  -- Se comprobará el importe previsto de las tarea de traducción o revisión externas que han generado 
  -- tareas de revisión de datos de pago a proveedores y todavía no han sido pagadas. 
  -- Tendremos tareas en las que ya se han revisado los datos de pago al proveedor (ESTADO_EJECUCCION = 'S') 
  -- y otras en las que todavía no en las que se calculará el importe previsto según los documentos asociados a la tarea.
  
	RETORNO NUMBER(9,2):= 0.0;
	TIPO_TAREA_REV_PAGO NUMBER(2):= 11;


BEGIN
	SELECT nvl(SUM(ROUND(CASE 
WHEN IMPORTE_TOTAL_094 IS NOT NULL THEN IMPORTE_TOTAL_094
WHEN NUM_PAL_IZO_056 < PAL_PRESUPUESTO_TRADOS_003 OR NUM_TOTAL_PAL_091 IS NULL THEN IMPORTE_PALABRA_029 * NUM_PAL_IZO_056
ELSE (IMPORTE_PALABRA_029 * NUM_PAL_CONCOR_0_84_091) 
+ (IMPORTE_PALABRA_029 * NUM_PAL_CONCOR_85_94_091 * POR_PAGO_PAL_CONCOR_85_94_029 / 100)
+ (IMPORTE_PALABRA_029 * NUM_PAL_CONCOR_95_100_091 * POR_PAGO_PAL_CONCOR_95_100_029 / 100)
END, 2)),0) AS TOTAL into RETORNO
	FROM AA79B29T00
    JOIN AA79B03T00 ON ID_003 = 0
    JOIN AA79B81T00 TRADREV ON ID_LOTE_029 = TRADREV.ID_LOTE_081
   LEFT JOIN AA79B81T00 REVPAGO ON  TRADREV.ID_TAREA_081 = REVPAGO.ID_TAREA_REL_081
   LEFT JOIN AA79B94T00 ON REVPAGO.ID_TAREA_081 = ID_TAREA_094 AND REVPAGO.ESTADO_EJECUCION_081 = 3 AND IND_PAGADO_094 = 'N'
   LEFT JOIN (SELECT ID_TAREA_083, SUM(nvl(NUM_PAL_IZO_056,0)) NUM_PAL_IZO_056, SUM(nvl(NUM_TOTAL_PAL_091,0)) NUM_TOTAL_PAL_091, SUM(nvl(NUM_PAL_CONCOR_0_84_091,0)) NUM_PAL_CONCOR_0_84_091
        , SUM(nvl(NUM_PAL_CONCOR_85_94_091,0)) NUM_PAL_CONCOR_85_94_091, 
			SUM(nvl(NUM_PAL_CONCOR_95_100_091,0))  NUM_PAL_CONCOR_95_100_091
            FROM AA79B56T00
            JOIN AA79B83T00 ON ID_DOC_083 = ID_DOC_056
            LEFT JOIN AA79B91T00 ON id_doc_083 = ID_DOC_ORIG_091
            GROUP BY ID_TAREA_083) ON ID_TAREA_083 = TRADREV.ID_TAREA_081
    WHERE ID_LOTE_029 = ID_LOTE
   AND IND_PAGADO_094 = 'N'
   AND REVPAGO.ID_TIPO_TAREA_081 = TIPO_TAREA_REV_PAGO
   AND TRADREV.ID_TIPO_TAREA_081 IN (2, 4)
   AND TRADREV.ID_TAREA_081 <> NVL(ID_TAREA, 0)
   AND REVPAGO.ID_TAREA_081 <> NVL(ID_TAREA, 0);

	RETURN RETORNO;
	
END;
/

create or replace FUNCTION CREAR_TAREAS_RELACIONADAS (
   IDTAREA IN   NUMBER,
   IP IN VARCHAR2,
   USUARIO IN VARCHAR2
)RETURN NUMBER IS


TYPE r_reg_tarea IS RECORD (
    ID_TIPO_TAREA NUMBER(2),
    IND_FACTURABLE VARCHAR2(1),
	RECURSO_ASIGNACION VARCHAR2(1),
	NUM_EXP NUMBER(6),
	ANYO NUMBER(4),
	ORDEN NUMBER(2),
	FECHA_INICIO_081 DATE,
	FECHA_FIN_081 DATE,
	HORAS_PREVISTAS_081 VARCHAR2(10),
    NUM_TOTAL_PAL_IZO_053 NUMBER(6,0),
    IND_TRAMITACION_RAPIDA_029 VARCHAR2(1),
    IND_NO_CONFORMIDAD_081 VARCHAR2(1),
    ID_TAREA_REL_081 NUMBER(20)
);
TAREA r_reg_tarea;

INTERPRETAR NUMBER(2):= 8;
REVISAR NUMBER(2):= 4;
TRADUCIR NUMBER(2):= 2;
INTRO_PAGO_PROV_INTER NUMBER(2):= 12 ;
REVISION_PAGO_PROV NUMBER(2):= 11;
TRADUCCION_REVISION_ENTREGA NUMBER(2):= 19;
REVISION_TRADUCCION NUMBER(2):= 21;
TRADUCCION_ENTREGA_CLIENTE NUMBER(2):= 22;
SI VARCHAR2(1):='S';
TIPO_EXP_TRADUCCION VARCHAR2(1):='T';

RECURSO_EXTERNO VARCHAR2(1):= 'P';
RECURSO_INTERNO VARCHAR2(1):= 'I';

ESTADO_TAREA NUMBER(1);
ESTADO_ASIGNACION_TAREA NUMBER(1):= 1;
ESTADO_PDTE_ACEPTACION_TAREA NUMBER(1):= 2;
ESTADO_ACEPTACION_TAREA NUMBER(1):= 3;
TAREA_PENDIENTE_EJECUCION NUMBER(1):= 1;
NUEVO_ID_TAREA NUMBER(20):= 0;
ORDEN NUMBER(2):=0;

DNI_RECURSO VARCHAR2(10);
FECHA_INI_NUEVA_TAREA DATE;
FECHA_FIN_NUEVA_TAREA DATE;

FECHA_ACEPTACION_TAREA DATE;
FECHA_FINAL_EXP DATE;

CONTADOR NUMBER(2):=0;
CONTADOR_ENTREGA NUMBER(2):=0;
INI_OBSERV VARCHAR2(32):= 'Ataza hauek sortu dira: ' || chr(13) || 'id = ';
INI_OBSERV_ELIMINAR VARCHAR2(32):= 'Ataza hauek ezabatu dira: ' || chr(13) || 'id = ';
OBSERV VARCHAR2(15):= ', Ataza mota = ';
FIN_OBSERV VARCHAR2(2):= chr(13);
OBSERVACIONES VARCHAR2(4000):= '';
ID_ESTADO_BITACORA NUMBER(3):= 0;
DESC_TIPO_TAREA VARCHAR2(150):= '';


--Párametros del envío del mail
ID_PROCESO_EMAIL NUMBER(20):= 0;
NUM_EMAIL NUMBER(2):= 1;
TIPO_AVISO NUMBER(2):= 5;
EMAIL_DESTINATARIO VARCHAR2(256);
ID_TIPO_EXPEDIENTE VARCHAR2(1);
TITULO_EXPEDIENTE VARCHAR2(150);
ORIGEN VARCHAR2(1);
APLIC_ORIGEN VARCHAR2(6);
RETORNO NUMBER(20);
TAREA_ENTREGA NUMBER(20);

LIM_PALABRAS NUMBER(6);

BEGIN

-- obtenemos el limite de palabras IZO  a partir del cual se realiza presupuesto y proyecto trados
select  PAL_PRESUPUESTO_TRADOS_003 into LIM_PALABRAS from AA79B03T00 where ID_003 = 0;

 -- OBTENEMOS LOS DATOS DE LA TAREA
SELECT ID_TIPO_TAREA_081, IND_FACTURABLE_081, RECURSO_ASIGNACION_081, NUM_EXP_081, ANYO_081, ORDEN_081, FECHA_INICIO_081, FECHA_FIN_081, HORAS_PREVISTAS_081,NUM_TOTAL_PAL_IZO_053,IND_TRAMITACION_RAPIDA_029,IND_NO_CONFORMIDAD_081, ID_TAREA_REL_081 into TAREA
FROM AA79B81T00 T1 LEFT JOIN AA79B53S01 r1 ON t1.ANYO_081 = r1.ANYO_053 AND t1.NUM_EXP_081 = r1.NUM_EXP_053 
LEFT JOIN AA79B29S01 T29 ON t1.ID_LOTE_081   = T29.ID_LOTE_029 WHERE ID_TAREA_081 = IDTAREA;

SELECT ID_TIPO_EXPEDIENTE_051, ORIGEN_051, APLIC_ORIGEN_051, DNI_TECNICO_051, TITULO_051 into ID_TIPO_EXPEDIENTE, ORIGEN, APLIC_ORIGEN, DNI_RECURSO, 
TITULO_EXPEDIENTE FROM AA79B51T00 WHERE ANYO_051 = TAREA.ANYO AND NUM_EXP_051 = TAREA.NUM_EXP;

BEGIN
    SELECT EMAIL_031 into EMAIL_DESTINATARIO FROM X54JAPI_DATOS_CONTACTO WHERE DNI_031 = DNI_RECURSO;
  EXCEPTION
    WHEN NO_DATA_FOUND THEN
    EMAIL_DESTINATARIO := '';
END;

SELECT MAX(ID_ESTADO_BITACORA_059) INTO ID_ESTADO_BITACORA FROM AA79B59T00 WHERE ANYO_059 = TAREA.ANYO AND NUM_EXP_059 = TAREA.NUM_EXP;
 IF (TAREA.ID_TIPO_TAREA = INTERPRETAR) THEN
 	IF (TAREA.RECURSO_ASIGNACION = RECURSO_EXTERNO)	THEN
	 	IF (TAREA.IND_FACTURABLE = SI) THEN
	 		SELECT COUNT(1) INTO CONTADOR FROM AA79B81T00 WHERE ID_TIPO_TAREA_081 = INTRO_PAGO_PROV_INTER AND ID_TAREA_REL_081 = IDTAREA;
	 		IF (CONTADOR = 0) THEN
	 			-- CREAMOS LA TAREA Y ARRASTRAMOS
	 			SELECT AA79B81Q00.NEXTVAL INTO NUEVO_ID_TAREA FROM dual;
            	ORDEN := TAREA.ORDEN + 1;

            	UPDATE AA79B81S01 set ORDEN_081 = ORDEN_081 + 1 WHERE ORDEN_081 >= ORDEN AND ANYO_081 = TAREA.ANYO AND NUM_EXP_081 = TAREA.NUM_EXP;

	            INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) 
	            VALUES (TAREA.ANYO,null,ESTADO_ASIGNACION_TAREA,TAREA_PENDIENTE_EJECUCION,null,null,null,null,'',NUEVO_ID_TAREA,IDTAREA,null,'N','N',null,TAREA.NUM_EXP,null,ORDEN,null,INTRO_PAGO_PROV_INTER,null,null,null,null);
	            INSERT INTO AA79B82T00 (ID_TAREA_082) values (NUEVO_ID_TAREA);

	            insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) 
				select NUEVO_ID_TAREA, ID_DOC_083 from AA79B83T00 where ID_TAREA_083 = IDTAREA;

				SELECT DESC_EU_015 into DESC_TIPO_TAREA FROM AA79B15S01 WHERE ID_015 = INTRO_PAGO_PROV_INTER;

				OBSERVACIONES:= INI_OBSERV || NUEVO_ID_TAREA || OBSERV || DESC_TIPO_TAREA || FIN_OBSERV;

				INSERT INTO AA79B43S01 (ID_REGISTRO_ACCION_043, ID_PUNTO_MENU_043, ID_ACCION_043, IP_043, FECHA_REGISTRO_043, USUARIO_REGISTRO_043, ANYO_EXP_043, NUM_EXP_043,  OBSERV_043, ID_ESTADO_BITACORA_043) 
				VALUES (AA79B43Q00.NEXTVAL,18,1,IP,SYSDATE,USUARIO,TAREA.ANYO,TAREA.NUM_EXP,OBSERVACIONES,ID_ESTADO_BITACORA);
	 		END IF;
	 	ELSE
	 		BEGIN
	            SELECT DESC_EU_015 into DESC_TIPO_TAREA FROM AA79B15S01 WHERE ID_015 = INTRO_PAGO_PROV_INTER;
		 		SELECT ID_TAREA_081 INTO NUEVO_ID_TAREA FROM AA79B81S01 WHERE ID_TIPO_TAREA_081 = INTRO_PAGO_PROV_INTER AND ID_TAREA_REL_081 = IDTAREA;

				OBSERVACIONES:= INI_OBSERV_ELIMINAR || NUEVO_ID_TAREA || OBSERV || DESC_TIPO_TAREA || FIN_OBSERV;

				INSERT INTO AA79B43S01 (ID_REGISTRO_ACCION_043, ID_PUNTO_MENU_043, ID_ACCION_043, IP_043, FECHA_REGISTRO_043, USUARIO_REGISTRO_043, ANYO_EXP_043, NUM_EXP_043,  OBSERV_043, ID_ESTADO_BITACORA_043) 
				VALUES (AA79B43Q00.NEXTVAL,18,2,IP,SYSDATE,USUARIO,TAREA.ANYO,TAREA.NUM_EXP,OBSERVACIONES,ID_ESTADO_BITACORA);
	        EXCEPTION
	        WHEN NO_DATA_FOUND THEN
	        	NUEVO_ID_TAREA := NULL;
	        END;

	 		--ELIMINAMOS LA TAREA
	 		DELETE AA79B81T00 WHERE ID_TIPO_TAREA_081 = INTRO_PAGO_PROV_INTER AND ID_TAREA_REL_081 = IDTAREA;
	 	END IF;
	ELSE
		BEGIN
            SELECT DESC_EU_015 into DESC_TIPO_TAREA FROM AA79B15S01 WHERE ID_015 = INTRO_PAGO_PROV_INTER;
	 		SELECT ID_TAREA_081 INTO NUEVO_ID_TAREA FROM AA79B81S01 WHERE ID_TIPO_TAREA_081 = INTRO_PAGO_PROV_INTER AND ID_TAREA_REL_081 = IDTAREA;

			OBSERVACIONES:= INI_OBSERV_ELIMINAR || NUEVO_ID_TAREA || OBSERV || DESC_TIPO_TAREA || FIN_OBSERV;

			INSERT INTO AA79B43S01 (ID_REGISTRO_ACCION_043, ID_PUNTO_MENU_043, ID_ACCION_043, IP_043, FECHA_REGISTRO_043, USUARIO_REGISTRO_043, ANYO_EXP_043, NUM_EXP_043,  OBSERV_043, ID_ESTADO_BITACORA_043) 
			VALUES (AA79B43Q00.NEXTVAL,18,2,IP,SYSDATE,USUARIO,TAREA.ANYO,TAREA.NUM_EXP,OBSERVACIONES,ID_ESTADO_BITACORA);
        EXCEPTION
        WHEN NO_DATA_FOUND THEN
        	NUEVO_ID_TAREA := NULL;
        END;

		--ELIMINAMOS LA TAREA
	 	DELETE AA79B81T00 WHERE ID_TIPO_TAREA_081 = INTRO_PAGO_PROV_INTER AND ID_TAREA_REL_081 = IDTAREA;
 	END IF;
 ELSIF (TAREA.ID_TIPO_TAREA = REVISAR) THEN
 	IF (TAREA.RECURSO_ASIGNACION = RECURSO_EXTERNO)	THEN
 		IF (TAREA.IND_FACTURABLE = SI) THEN
	 		SELECT COUNT(1) INTO CONTADOR FROM AA79B81T00 WHERE ID_TIPO_TAREA_081 = REVISION_PAGO_PROV AND ID_TAREA_REL_081 = IDTAREA;
	 		IF (CONTADOR = 0) THEN
	 			-- CREAMOS LA TAREA Y ARRASTRAMOS
	 			SELECT AA79B81Q00.NEXTVAL INTO NUEVO_ID_TAREA FROM dual;

            	ORDEN := TAREA.ORDEN + 1;
            	
            	SELECT NVL(fecha_fin_081, SYSDATE), NVL(fecha_fin_081, SYSDATE) + 30/1440 INTO FECHA_INI_NUEVA_TAREA, FECHA_FIN_NUEVA_TAREA FROM aa79b81t00 WHERE anyo_081 = TAREA.ANYO AND num_exp_081 = TAREA.NUM_EXP AND orden_081 = ORDEN -1 ORDER BY fecha_fin_081 DESC FETCH FIRST ROW ONLY;

            	UPDATE AA79B81S01 set ORDEN_081 = ORDEN_081 + 1 WHERE ORDEN_081 >= ORDEN AND ANYO_081 = TAREA.ANYO AND NUM_EXP_081 = TAREA.NUM_EXP;
    
            	ESTADO_TAREA:= ESTADO_PDTE_ACEPTACION_TAREA;
            	FECHA_ACEPTACION_TAREA := null;
            	IF (DNI_RECURSO = USUARIO) THEN
            		ESTADO_TAREA:= ESTADO_ACEPTACION_TAREA;
            		FECHA_ACEPTACION_TAREA := sysdate;
            	END IF;

	            INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, 
	            FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, 
	            OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) 
	            VALUES (TAREA.ANYO,DNI_RECURSO,ESTADO_TAREA,TAREA_PENDIENTE_EJECUCION,FECHA_ACEPTACION_TAREA,sysdate,FECHA_FIN_NUEVA_TAREA,FECHA_INI_NUEVA_TAREA,'00:30',NUEVO_ID_TAREA,IDTAREA,null,'N','N',null,TAREA.NUM_EXP,null,ORDEN,RECURSO_INTERNO,REVISION_PAGO_PROV,null,null,null,null);

	            INSERT INTO AA79B82T00 (ID_TAREA_082) values (NUEVO_ID_TAREA);

	            insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) 
				select NUEVO_ID_TAREA, ID_DOC_083 from AA79B83T00 where ID_TAREA_083 = IDTAREA;

				SELECT DESC_EU_015 into DESC_TIPO_TAREA FROM AA79B15S01 WHERE ID_015 = REVISION_PAGO_PROV;

                IF (DNI_RECURSO <> USUARIO) THEN
                  IF(ID_PROCESO_EMAIL=0) THEN
                        SELECT AA79BB2Q00.NEXTVAL INTO ID_PROCESO_EMAIL FROM dual;
                  END IF;
               
                  INSERT INTO AA79BB2T00 (ID_PROCESO_EMAIL_0B2, NUM_EMAIL_0B2, ID_TIPO_AVISO_0B2, ANYO_0B2, NUM_EXP_0B2, TITULO_EXP_0B2, ID_TAREA_0B2, ID_TIPO_TAREA_0B2, DESC_TAREA_ES_0B2, DESC_TAREA_EU_0B2, DNI_DESTINATARIO_0B2, EMAIL_DESTINATARIO_0B2)
                  VALUES (ID_PROCESO_EMAIL, NUM_EMAIL, TIPO_AVISO, TAREA.ANYO, TAREA.NUM_EXP, TITULO_EXPEDIENTE, NUEVO_ID_TAREA, TAREA.ID_TIPO_TAREA,DESC_TIPO_TAREA, DESC_TIPO_TAREA, DNI_RECURSO, EMAIL_DESTINATARIO);
            
                  NUM_EMAIL:= NUM_EMAIL + 1;
            
                 RETORNO:= ID_PROCESO_EMAIL;
                ELSE 	     
                    RETORNO:= NULL;
               END IF;
       
				OBSERVACIONES:= INI_OBSERV || NUEVO_ID_TAREA || OBSERV || DESC_TIPO_TAREA || FIN_OBSERV;

				INSERT INTO AA79B43S01 (ID_REGISTRO_ACCION_043, ID_PUNTO_MENU_043, ID_ACCION_043, IP_043, FECHA_REGISTRO_043, USUARIO_REGISTRO_043, ANYO_EXP_043, NUM_EXP_043,  OBSERV_043, ID_ESTADO_BITACORA_043) 
				VALUES (AA79B43Q00.NEXTVAL,18,1,IP,SYSDATE,USUARIO,TAREA.ANYO,TAREA.NUM_EXP,OBSERVACIONES,ID_ESTADO_BITACORA);
	 		END IF;
	 	ELSE
	 		BEGIN
	            SELECT DESC_EU_015 into DESC_TIPO_TAREA FROM AA79B15S01 WHERE ID_015 = REVISION_PAGO_PROV;
		 		SELECT ID_TAREA_081 INTO NUEVO_ID_TAREA FROM AA79B81S01 WHERE ID_TIPO_TAREA_081 = REVISION_PAGO_PROV AND ID_TAREA_REL_081 = IDTAREA;

				OBSERVACIONES:= INI_OBSERV_ELIMINAR || NUEVO_ID_TAREA || OBSERV || DESC_TIPO_TAREA || FIN_OBSERV;

				INSERT INTO AA79B43S01 (ID_REGISTRO_ACCION_043, ID_PUNTO_MENU_043, ID_ACCION_043, IP_043, FECHA_REGISTRO_043, USUARIO_REGISTRO_043, ANYO_EXP_043, NUM_EXP_043,  OBSERV_043, ID_ESTADO_BITACORA_043) 
				VALUES (AA79B43Q00.NEXTVAL,18,2,IP,SYSDATE,USUARIO,TAREA.ANYO,TAREA.NUM_EXP,OBSERVACIONES,ID_ESTADO_BITACORA);
	        EXCEPTION
	        WHEN NO_DATA_FOUND THEN
	        	NUEVO_ID_TAREA := NULL;
	        END;

	 		--ELIMINAMOS LA TAREA
	 		DELETE AA79B81T00 WHERE ID_TIPO_TAREA_081 = REVISION_PAGO_PROV AND ID_TAREA_REL_081 = IDTAREA;
	 	END IF;
	ELSE
		BEGIN
            SELECT DESC_EU_015 into DESC_TIPO_TAREA FROM AA79B15S01 WHERE ID_015 = REVISION_PAGO_PROV;
	 		SELECT ID_TAREA_081 INTO NUEVO_ID_TAREA FROM AA79B81S01 WHERE ID_TIPO_TAREA_081 = REVISION_PAGO_PROV AND ID_TAREA_REL_081 = IDTAREA;

			OBSERVACIONES:= INI_OBSERV_ELIMINAR || NUEVO_ID_TAREA || OBSERV || DESC_TIPO_TAREA || FIN_OBSERV;

			INSERT INTO AA79B43S01 (ID_REGISTRO_ACCION_043, ID_PUNTO_MENU_043, ID_ACCION_043, IP_043, FECHA_REGISTRO_043, USUARIO_REGISTRO_043, ANYO_EXP_043, NUM_EXP_043,  OBSERV_043, ID_ESTADO_BITACORA_043) 
			VALUES (AA79B43Q00.NEXTVAL,18,2,IP,SYSDATE,USUARIO,TAREA.ANYO,TAREA.NUM_EXP,OBSERVACIONES,ID_ESTADO_BITACORA);
        EXCEPTION
        WHEN NO_DATA_FOUND THEN
        	NUEVO_ID_TAREA := NULL;
        END;

		--ELIMINAMOS LA TAREA
	 	DELETE AA79B81T00 WHERE ID_TIPO_TAREA_081 = REVISION_PAGO_PROV AND ID_TAREA_REL_081 = IDTAREA;
 	END IF;

 ELSIF (TAREA.ID_TIPO_TAREA = TRADUCIR) THEN
 IF (TAREA.RECURSO_ASIGNACION = RECURSO_EXTERNO)	THEN
 	SELECT COUNT(1) INTO CONTADOR FROM AA79B81T00 WHERE ID_TIPO_TAREA_081 = REVISION_TRADUCCION AND ID_TAREA_REL_081 = IDTAREA;
    SELECT COUNT(1) INTO CONTADOR_ENTREGA FROM AA79B81T00 WHERE ID_TIPO_TAREA_081 IN (TRADUCCION_REVISION_ENTREGA,TRADUCCION_ENTREGA_CLIENTE) AND ANYO_081 = TAREA.ANYO AND NUM_EXP_081 = TAREA.NUM_EXP AND IND_NO_CONFORMIDAD_081 = 'N';
 	IF (CONTADOR = 0) THEN
 		-- CREAMOS LA TAREA Y ARRASTRAMOS
 		SELECT AA79B81Q00.NEXTVAL INTO NUEVO_ID_TAREA FROM dual;
	    ORDEN := TAREA.ORDEN + 1;
	    
	    SELECT NVL(fecha_fin_081, SYSDATE), NVL(fecha_fin_081, SYSDATE) + 30/1440 INTO FECHA_INI_NUEVA_TAREA, FECHA_FIN_NUEVA_TAREA FROM aa79b81t00 WHERE anyo_081 = TAREA.ANYO AND num_exp_081 = TAREA.NUM_EXP AND orden_081 = ORDEN -1 ORDER BY fecha_fin_081 DESC FETCH FIRST ROW ONLY;
	    
	    UPDATE AA79B81S01 set ORDEN_081 = ORDEN_081 + 1 WHERE ORDEN_081 >= ORDEN AND ANYO_081 = TAREA.ANYO AND NUM_EXP_081 = TAREA.NUM_EXP;

        IF(TAREA.NUM_TOTAL_PAL_IZO_053 <= LIM_PALABRAS AND TAREA.IND_TRAMITACION_RAPIDA_029 = 'S') THEN 
             ESTADO_TAREA:= ESTADO_PDTE_ACEPTACION_TAREA;
             FECHA_ACEPTACION_TAREA := null;
            	IF (DNI_RECURSO = USUARIO) THEN
            		ESTADO_TAREA:= ESTADO_ACEPTACION_TAREA;
            		FECHA_ACEPTACION_TAREA := sysdate;
            	END IF;
            	
            INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) 
            VALUES (TAREA.ANYO,DNI_RECURSO,ESTADO_TAREA,TAREA_PENDIENTE_EJECUCION,FECHA_ACEPTACION_TAREA,sysdate,FECHA_FIN_NUEVA_TAREA,FECHA_INI_NUEVA_TAREA,'00:30',NUEVO_ID_TAREA,IDTAREA,null,'N','N',null,TAREA.NUM_EXP,null,ORDEN,RECURSO_INTERNO,REVISION_TRADUCCION,null,null,null,null);
        ELSE
            INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) 
            VALUES (TAREA.ANYO,NULL,ESTADO_ASIGNACION_TAREA,TAREA_PENDIENTE_EJECUCION,null,null,null,null,'',NUEVO_ID_TAREA,IDTAREA,null,'N','N',null,TAREA.NUM_EXP,null,ORDEN,null,REVISION_TRADUCCION,null,null,null,null);        
        END IF;
       
        INSERT INTO AA79B82T00 (ID_TAREA_082) values (NUEVO_ID_TAREA);
	    insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) 
	    select NUEVO_ID_TAREA, ID_DOC_083 from AA79B83T00 where ID_TAREA_083 = IDTAREA;

	    SELECT DESC_EU_015 into DESC_TIPO_TAREA FROM AA79B15S01 WHERE ID_015 = REVISION_TRADUCCION;

        IF (DNI_RECURSO <> USUARIO) THEN
          IF(ID_PROCESO_EMAIL=0) THEN
            SELECT AA79BB2Q00.NEXTVAL INTO ID_PROCESO_EMAIL FROM dual;
          END IF;
          INSERT INTO AA79BB2T00 (ID_PROCESO_EMAIL_0B2, NUM_EMAIL_0B2, ID_TIPO_AVISO_0B2, ANYO_0B2, NUM_EXP_0B2, TITULO_EXP_0B2, ID_TAREA_0B2, ID_TIPO_TAREA_0B2, DESC_TAREA_ES_0B2, DESC_TAREA_EU_0B2, DNI_DESTINATARIO_0B2, EMAIL_DESTINATARIO_0B2)
          VALUES (ID_PROCESO_EMAIL, NUM_EMAIL, TIPO_AVISO, TAREA.ANYO, TAREA.NUM_EXP, TITULO_EXPEDIENTE, NUEVO_ID_TAREA, TAREA.ID_TIPO_TAREA,DESC_TIPO_TAREA, DESC_TIPO_TAREA, DNI_RECURSO, EMAIL_DESTINATARIO);
    
          NUM_EMAIL:= NUM_EMAIL + 1;
    
         RETORNO:= ID_PROCESO_EMAIL;
        ELSE 	     
            RETORNO:= NULL;
       END IF;


		OBSERVACIONES:= INI_OBSERV || NUEVO_ID_TAREA || OBSERV || DESC_TIPO_TAREA || FIN_OBSERV;

	    INSERT INTO AA79B43S01 (ID_REGISTRO_ACCION_043, ID_PUNTO_MENU_043, ID_ACCION_043, IP_043, FECHA_REGISTRO_043, USUARIO_REGISTRO_043, ANYO_EXP_043, NUM_EXP_043,  OBSERV_043, ID_ESTADO_BITACORA_043) 
		VALUES (AA79B43Q00.NEXTVAL,18,1,IP,SYSDATE,USUARIO,TAREA.ANYO,TAREA.NUM_EXP,OBSERVACIONES,ID_ESTADO_BITACORA);

	ELSE
		-- RECUPERO SU ORDEN PARA ASIGNAR LUEGO EL MISMO
		SELECT ORDEN_081 INTO ORDEN FROM AA79B81T00 WHERE ID_TIPO_TAREA_081 = REVISION_TRADUCCION AND ID_TAREA_REL_081 = IDTAREA;
	END IF;
 		IF (TAREA.IND_FACTURABLE = SI) THEN
	 		SELECT COUNT(1) INTO CONTADOR FROM AA79B81T00 WHERE ID_TIPO_TAREA_081 = REVISION_PAGO_PROV AND ID_TAREA_REL_081 = IDTAREA;
	 		IF (CONTADOR = 0) THEN
	 			-- CREAMOS LA TAREA Y ARRASTRAMOS
	 			SELECT AA79B81Q00.NEXTVAL INTO NUEVO_ID_TAREA FROM dual;
                ORDEN := ORDEN + 1;

                SELECT NVL(fecha_fin_081, SYSDATE), NVL(fecha_fin_081, SYSDATE) + 30/1440 INTO FECHA_INI_NUEVA_TAREA, FECHA_FIN_NUEVA_TAREA FROM aa79b81t00 WHERE anyo_081 = TAREA.ANYO AND num_exp_081 = TAREA.NUM_EXP AND orden_081 = ORDEN -1 ORDER BY fecha_fin_081 DESC FETCH FIRST ROW ONLY;
	 		
	    		UPDATE AA79B81S01 set ORDEN_081 = ORDEN_081 + 1 WHERE ORDEN_081 >= ORDEN AND ANYO_081 = TAREA.ANYO AND NUM_EXP_081 = TAREA.NUM_EXP;
                                
                ESTADO_TAREA:= ESTADO_PDTE_ACEPTACION_TAREA;
                FECHA_ACEPTACION_TAREA := null;
            	IF (DNI_RECURSO = USUARIO) THEN
            		ESTADO_TAREA:= ESTADO_ACEPTACION_TAREA;
            		FECHA_ACEPTACION_TAREA := sysdate;
            	END IF;
            	
	            INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) 
	            VALUES (TAREA.ANYO,DNI_RECURSO,ESTADO_TAREA,TAREA_PENDIENTE_EJECUCION,FECHA_ACEPTACION_TAREA,sysdate,FECHA_FIN_NUEVA_TAREA,FECHA_INI_NUEVA_TAREA,'00:30',NUEVO_ID_TAREA,IDTAREA,null,'N','N',null,TAREA.NUM_EXP,null,ORDEN,RECURSO_INTERNO,REVISION_PAGO_PROV,null,null,null,null);
	            INSERT INTO AA79B82T00 (ID_TAREA_082) values (NUEVO_ID_TAREA);

	            insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) 
				select NUEVO_ID_TAREA, ID_DOC_083 from AA79B83T00 where ID_TAREA_083 = IDTAREA;

				SELECT DESC_EU_015 into DESC_TIPO_TAREA FROM AA79B15S01 WHERE ID_015 = REVISION_PAGO_PROV;

         
                IF (DNI_RECURSO <> USUARIO) THEN
                IF(ID_PROCESO_EMAIL=0) THEN
                      SELECT AA79BB2Q00.NEXTVAL INTO ID_PROCESO_EMAIL FROM dual;
                  END IF;    
                  INSERT INTO AA79BB2T00 (ID_PROCESO_EMAIL_0B2, NUM_EMAIL_0B2, ID_TIPO_AVISO_0B2, ANYO_0B2, NUM_EXP_0B2, TITULO_EXP_0B2, ID_TAREA_0B2, ID_TIPO_TAREA_0B2, DESC_TAREA_ES_0B2, DESC_TAREA_EU_0B2, DNI_DESTINATARIO_0B2, EMAIL_DESTINATARIO_0B2)
                  VALUES (ID_PROCESO_EMAIL, NUM_EMAIL, TIPO_AVISO, TAREA.ANYO, TAREA.NUM_EXP, TITULO_EXPEDIENTE, NUEVO_ID_TAREA, TAREA.ID_TIPO_TAREA,DESC_TIPO_TAREA, DESC_TIPO_TAREA, DNI_RECURSO, EMAIL_DESTINATARIO);
	        
                  NUM_EMAIL:= NUM_EMAIL + 1;
	        
                 RETORNO:= ID_PROCESO_EMAIL;
                ELSE 	     
                    RETORNO:= NULL;
               END IF;

				OBSERVACIONES:= INI_OBSERV || NUEVO_ID_TAREA || OBSERV || DESC_TIPO_TAREA || FIN_OBSERV;

				INSERT INTO AA79B43S01 (ID_REGISTRO_ACCION_043, ID_PUNTO_MENU_043, ID_ACCION_043, IP_043, FECHA_REGISTRO_043, USUARIO_REGISTRO_043, ANYO_EXP_043, NUM_EXP_043,  OBSERV_043, ID_ESTADO_BITACORA_043) 
				VALUES (AA79B43Q00.NEXTVAL,18,1,IP,SYSDATE,USUARIO,TAREA.ANYO,TAREA.NUM_EXP,OBSERVACIONES,ID_ESTADO_BITACORA);
	 		END IF;
	 	ELSE
	 		BEGIN
	            SELECT DESC_EU_015 into DESC_TIPO_TAREA FROM AA79B15S01 WHERE ID_015 = REVISION_PAGO_PROV;
		 		SELECT ID_TAREA_081 INTO NUEVO_ID_TAREA FROM AA79B81S01 WHERE ID_TIPO_TAREA_081 = REVISION_PAGO_PROV AND ID_TAREA_REL_081 = IDTAREA;

				OBSERVACIONES:= INI_OBSERV_ELIMINAR || NUEVO_ID_TAREA || OBSERV || DESC_TIPO_TAREA || FIN_OBSERV;

				INSERT INTO AA79B43S01 (ID_REGISTRO_ACCION_043, ID_PUNTO_MENU_043, ID_ACCION_043, IP_043, FECHA_REGISTRO_043, USUARIO_REGISTRO_043, ANYO_EXP_043, NUM_EXP_043,  OBSERV_043, ID_ESTADO_BITACORA_043) 
				VALUES (AA79B43Q00.NEXTVAL,18,2,IP,SYSDATE,USUARIO,TAREA.ANYO,TAREA.NUM_EXP,OBSERVACIONES,ID_ESTADO_BITACORA);
	        EXCEPTION
	        WHEN NO_DATA_FOUND THEN
	        	NUEVO_ID_TAREA := NULL;
	        END;	

	 		--ELIMINAMOS LA TAREA
	 		DELETE AA79B81T00 WHERE ID_TIPO_TAREA_081 = REVISION_PAGO_PROV AND ID_TAREA_REL_081 = IDTAREA;
	 	END IF;
	 	
	 IF (TAREA.NUM_TOTAL_PAL_IZO_053 < LIM_PALABRAS AND TAREA.IND_TRAMITACION_RAPIDA_029 = 'S') THEN	
     	IF (CONTADOR_ENTREGA = 0)   THEN
	 		-- CREAMOS LA TAREA Y ARRASTRAMOS
	 		SELECT AA79B81Q00.NEXTVAL INTO NUEVO_ID_TAREA FROM dual;
		    ORDEN := ORDEN + 1;
	
		    SELECT NVL(fecha_fin_081, SYSDATE), NVL(fecha_fin_081, SYSDATE) + 30/1440 INTO FECHA_INI_NUEVA_TAREA, FECHA_FIN_NUEVA_TAREA FROM aa79b81t00 WHERE anyo_081 = TAREA.ANYO AND num_exp_081 = TAREA.NUM_EXP AND orden_081 = ORDEN -1 ORDER BY fecha_fin_081 DESC FETCH FIRST ROW ONLY;
		    
		    UPDATE AA79B81S01 set ORDEN_081 = ORDEN_081 + 1 WHERE ORDEN_081 >= ORDEN AND ANYO_081 = TAREA.ANYO AND NUM_EXP_081 = TAREA.NUM_EXP;
	
	        ESTADO_TAREA:= ESTADO_PDTE_ACEPTACION_TAREA;
	        FECHA_ACEPTACION_TAREA := null;
	    	IF (DNI_RECURSO = USUARIO) THEN
	    		ESTADO_TAREA:= ESTADO_ACEPTACION_TAREA;
	    		FECHA_ACEPTACION_TAREA := sysdate;
	    	END IF;
	            	
	        INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) 
	         VALUES (TAREA.ANYO,DNI_RECURSO,ESTADO_TAREA,TAREA_PENDIENTE_EJECUCION,FECHA_ACEPTACION_TAREA,sysdate,FECHA_FIN_NUEVA_TAREA,FECHA_INI_NUEVA_TAREA,'00:30',NUEVO_ID_TAREA,null,null,'N','N',null,TAREA.NUM_EXP,null,ORDEN,RECURSO_INTERNO,TRADUCCION_REVISION_ENTREGA,null,null,null,null);
	    
	        INSERT INTO AA79B82T00 (ID_TAREA_082) values (NUEVO_ID_TAREA);
		    insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) 
		    select NUEVO_ID_TAREA, ID_DOC_083 from AA79B83T00 where ID_TAREA_083 = IDTAREA;
	
		    SELECT DESC_EU_015 into DESC_TIPO_TAREA FROM AA79B15S01 WHERE ID_015 = TRADUCCION_REVISION_ENTREGA;
	
			OBSERVACIONES:= INI_OBSERV || NUEVO_ID_TAREA || OBSERV || DESC_TIPO_TAREA || FIN_OBSERV;
	
	        IF (DNI_RECURSO <> USUARIO) THEN
	          IF(ID_PROCESO_EMAIL=0) THEN
	            SELECT AA79BB2Q00.NEXTVAL INTO ID_PROCESO_EMAIL FROM dual;
	          END IF;          
	          INSERT INTO AA79BB2T00 (ID_PROCESO_EMAIL_0B2, NUM_EMAIL_0B2, ID_TIPO_AVISO_0B2, ANYO_0B2, NUM_EXP_0B2, TITULO_EXP_0B2, ID_TAREA_0B2, ID_TIPO_TAREA_0B2, DESC_TAREA_ES_0B2, DESC_TAREA_EU_0B2, DNI_DESTINATARIO_0B2, EMAIL_DESTINATARIO_0B2)
	          VALUES (ID_PROCESO_EMAIL, NUM_EMAIL, TIPO_AVISO, TAREA.ANYO, TAREA.NUM_EXP, TITULO_EXPEDIENTE, NUEVO_ID_TAREA, TAREA.ID_TIPO_TAREA,DESC_TIPO_TAREA, DESC_TIPO_TAREA, DNI_RECURSO, EMAIL_DESTINATARIO);
	    
	          NUM_EMAIL:= NUM_EMAIL + 1;
	    
	         RETORNO:= ID_PROCESO_EMAIL;
	        ELSE 	     
	            RETORNO:= NULL;
	       END IF;
		    INSERT INTO AA79B43S01 (ID_REGISTRO_ACCION_043, ID_PUNTO_MENU_043, ID_ACCION_043, IP_043, FECHA_REGISTRO_043, USUARIO_REGISTRO_043, ANYO_EXP_043, NUM_EXP_043,  OBSERV_043, ID_ESTADO_BITACORA_043) 
			VALUES (AA79B43Q00.NEXTVAL,18,1,IP,SYSDATE,USUARIO,TAREA.ANYO,TAREA.NUM_EXP,OBSERVACIONES,ID_ESTADO_BITACORA);
	
		ELSE
			-- LA TAREA EXISTE PERO LA ASIGNAMOS.
			SELECT ID_TAREA_081, ORDEN_081 INTO NUEVO_ID_TAREA, ORDEN FROM AA79B81T00 WHERE ID_TIPO_TAREA_081 IN (TRADUCCION_REVISION_ENTREGA,TRADUCCION_ENTREGA_CLIENTE) AND ANYO_081 = TAREA.ANYO AND NUM_EXP_081 = TAREA.NUM_EXP AND TAREA.IND_NO_CONFORMIDAD_081 = 'N';	
	
		    SELECT NVL(fecha_fin_081, SYSDATE), NVL(fecha_fin_081, SYSDATE) + 30/1440 INTO FECHA_INI_NUEVA_TAREA, FECHA_FIN_NUEVA_TAREA FROM aa79b81t00 WHERE anyo_081 = TAREA.ANYO AND num_exp_081 = TAREA.NUM_EXP AND orden_081 = ORDEN -1 ORDER BY fecha_fin_081 DESC FETCH FIRST ROW ONLY;
			
			
			
			SELECT NVL(fecha_fin_081, SYSDATE), NVL(fecha_fin_081, SYSDATE) + 30/1440 INTO FECHA_INI_NUEVA_TAREA, FECHA_FIN_NUEVA_TAREA FROM aa79b81t00 WHERE anyo_081 = TAREA.ANYO AND num_exp_081 = TAREA.NUM_EXP AND orden_081 = ORDEN -1 ORDER BY fecha_fin_081 DESC FETCH FIRST ROW ONLY;
	    	
	    	ESTADO_TAREA:= ESTADO_PDTE_ACEPTACION_TAREA;
	        FECHA_ACEPTACION_TAREA := null;
	    	IF (DNI_RECURSO = USUARIO) THEN
	    		ESTADO_TAREA:= ESTADO_ACEPTACION_TAREA;
	    		FECHA_ACEPTACION_TAREA := sysdate;
	    	END IF;
	    	
	        UPDATE AA79B81T00 set ESTADO_ASIGNACION_081 = ESTADO_TAREA, ESTADO_EJECUCION_081 = TAREA_PENDIENTE_EJECUCION, FECHA_ACEPTACION_081 = FECHA_ACEPTACION_TAREA, 
	        FECHA_ASIGNACION_081=sysdate, FECHA_FIN_081 = FECHA_FIN_NUEVA_TAREA, FECHA_INICIO_081 = FECHA_INI_NUEVA_TAREA, HORAS_PREVISTAS_081= '00:30',
	        DNI_RECURSO_081 = DNI_RECURSO, RECURSO_ASIGNACION_081 = RECURSO_INTERNO, ID_TIPO_TAREA_081 = TRADUCCION_REVISION_ENTREGA
	    	WHERE ID_TAREA_081 = NUEVO_ID_TAREA;
	    	
	    	SELECT DESC_EU_015 into DESC_TIPO_TAREA FROM AA79B15S01 WHERE ID_015 = TRADUCCION_REVISION_ENTREGA;
	
			OBSERVACIONES:= INI_OBSERV || NUEVO_ID_TAREA || OBSERV || DESC_TIPO_TAREA || FIN_OBSERV;
	
	        IF (DNI_RECURSO <> USUARIO) THEN
	          IF(ID_PROCESO_EMAIL=0) THEN
	            SELECT AA79BB2Q00.NEXTVAL INTO ID_PROCESO_EMAIL FROM dual;  
	          END IF;          
	          INSERT INTO AA79BB2T00 (ID_PROCESO_EMAIL_0B2, NUM_EMAIL_0B2, ID_TIPO_AVISO_0B2, ANYO_0B2, NUM_EXP_0B2, TITULO_EXP_0B2, ID_TAREA_0B2, ID_TIPO_TAREA_0B2, DESC_TAREA_ES_0B2, DESC_TAREA_EU_0B2, DNI_DESTINATARIO_0B2, EMAIL_DESTINATARIO_0B2)
	          VALUES (ID_PROCESO_EMAIL, NUM_EMAIL, TIPO_AVISO, TAREA.ANYO, TAREA.NUM_EXP, TITULO_EXPEDIENTE, NUEVO_ID_TAREA, TAREA.ID_TIPO_TAREA,DESC_TIPO_TAREA, DESC_TIPO_TAREA, DNI_RECURSO, EMAIL_DESTINATARIO);
	    
	          NUM_EMAIL:= NUM_EMAIL + 1;
	    
	         RETORNO:= ID_PROCESO_EMAIL;
	        ELSE 	     
	            RETORNO:= NULL;
	       END IF;
		    INSERT INTO AA79B43S01 (ID_REGISTRO_ACCION_043, ID_PUNTO_MENU_043, ID_ACCION_043, IP_043, FECHA_REGISTRO_043, USUARIO_REGISTRO_043, ANYO_EXP_043, NUM_EXP_043,  OBSERV_043, ID_ESTADO_BITACORA_043) 
			VALUES (AA79B43Q00.NEXTVAL,18,1,IP,SYSDATE,USUARIO,TAREA.ANYO,TAREA.NUM_EXP,OBSERVACIONES,ID_ESTADO_BITACORA);
	    	
	    	
			
		END IF;
	END IF;
	ELSE
		BEGIN
            SELECT DESC_EU_015 into DESC_TIPO_TAREA FROM AA79B15S01 WHERE ID_015 = REVISION_TRADUCCION;
            SELECT ID_TAREA_081 INTO NUEVO_ID_TAREA FROM AA79B81S01 WHERE ID_TIPO_TAREA_081 = REVISION_TRADUCCION AND ID_TAREA_REL_081 = IDTAREA;

            OBSERVACIONES:= INI_OBSERV_ELIMINAR || NUEVO_ID_TAREA || OBSERV || DESC_TIPO_TAREA || FIN_OBSERV;

			INSERT INTO AA79B43S01 (ID_REGISTRO_ACCION_043, ID_PUNTO_MENU_043, ID_ACCION_043, IP_043, FECHA_REGISTRO_043, USUARIO_REGISTRO_043, ANYO_EXP_043, NUM_EXP_043,  OBSERV_043, ID_ESTADO_BITACORA_043) 
			VALUES (AA79B43Q00.NEXTVAL,18,2,IP,SYSDATE,USUARIO,TAREA.ANYO,TAREA.NUM_EXP,OBSERVACIONES,ID_ESTADO_BITACORA);

			SELECT DESC_EU_015 into DESC_TIPO_TAREA FROM AA79B15S01 WHERE ID_015 = REVISION_PAGO_PROV;
	 		SELECT ID_TAREA_081 INTO NUEVO_ID_TAREA FROM AA79B81S01 WHERE ID_TIPO_TAREA_081 = REVISION_PAGO_PROV AND ID_TAREA_REL_081 = IDTAREA;

			OBSERVACIONES:= INI_OBSERV_ELIMINAR || NUEVO_ID_TAREA || OBSERV || DESC_TIPO_TAREA || FIN_OBSERV;

			INSERT INTO AA79B43S01 (ID_REGISTRO_ACCION_043, ID_PUNTO_MENU_043, ID_ACCION_043, IP_043, FECHA_REGISTRO_043, USUARIO_REGISTRO_043, ANYO_EXP_043, NUM_EXP_043,  OBSERV_043, ID_ESTADO_BITACORA_043) 
			VALUES (AA79B43Q00.NEXTVAL,18,2,IP,SYSDATE,USUARIO,TAREA.ANYO,TAREA.NUM_EXP,OBSERVACIONES,ID_ESTADO_BITACORA);
        EXCEPTION
        WHEN NO_DATA_FOUND THEN
        	NUEVO_ID_TAREA := NULL;
        END;

		--ELIMINAMOS LA TAREA
	 	DELETE AA79B81T00 WHERE ID_TIPO_TAREA_081 = REVISION_TRADUCCION AND ID_TAREA_REL_081 = IDTAREA;
	 	DELETE AA79B81T00 WHERE ID_TIPO_TAREA_081 = REVISION_PAGO_PROV AND ID_TAREA_REL_081 = IDTAREA;  
 	END IF; 	

ELSIF (TAREA.ID_TIPO_TAREA = REVISION_PAGO_PROV OR TAREA.ID_TIPO_TAREA = REVISION_TRADUCCION AND ID_TIPO_EXPEDIENTE = TIPO_EXP_TRADUCCION) THEN

		BEGIN
			SELECT t1.ID_TAREA_081 INTO TAREA_ENTREGA FROM AA79B81T00 t1 JOIN AA79B81T00 t2 ON t2.NUM_EXP_081 = t1.NUM_EXP_081 AND t2.ANYO_081 = t1.ANYO_081 AND t2.ORDEN_081 < t1.ORDEN_081 AND t2.ID_TAREA_081 = IDTAREA WHERE t1.ID_TIPO_TAREA_081 in (TRADUCCION_REVISION_ENTREGA,TRADUCCION_ENTREGA_CLIENTE) ORDER BY t1.ORDEN_081 ASC FETCH FIRST ROW ONLY;
			
			SELECT COUNT(1) INTO CONTADOR FROM AA79B81T00 WHERE ID_TIPO_TAREA_081 = REVISION_PAGO_PROV AND ANYO_081 = TAREA.ANYO AND NUM_EXP_081 = TAREA.NUM_EXP AND ID_TAREA_REL_081 = TAREA.ID_TAREA_REL_081;
		 		
			IF (CONTADOR = 0) THEN
		 		
				SELECT RECURSO_ASIGNACION_081, DNI_RECURSO_081, NVL(fecha_fin_081, SYSDATE), NVL(fecha_fin_081, SYSDATE) + 30/1440 INTO RECURSO_INTERNO, DNI_RECURSO, FECHA_INI_NUEVA_TAREA, FECHA_FIN_NUEVA_TAREA FROM AA79B81T00 WHERE ID_TIPO_TAREA_081 = REVISION_TRADUCCION AND ANYO_081 = TAREA.ANYO AND NUM_EXP_081 = TAREA.NUM_EXP AND ID_TAREA_REL_081 = TAREA.ID_TAREA_REL_081;
	
			ELSE
			
				SELECT RECURSO_ASIGNACION_081, DNI_RECURSO_081 INTO RECURSO_INTERNO, DNI_RECURSO FROM AA79B81T00 WHERE ID_TIPO_TAREA_081 = REVISION_TRADUCCION AND ANYO_081 = TAREA.ANYO AND NUM_EXP_081 = TAREA.NUM_EXP AND ID_TAREA_REL_081 = TAREA.ID_TAREA_REL_081;
				
				SELECT NVL(fecha_fin_081, SYSDATE), NVL(fecha_fin_081, SYSDATE) + 30/1440 INTO FECHA_INI_NUEVA_TAREA, FECHA_FIN_NUEVA_TAREA FROM AA79B81T00 WHERE ID_TIPO_TAREA_081 = REVISION_PAGO_PROV AND ANYO_081 = TAREA.ANYO AND NUM_EXP_081 = TAREA.NUM_EXP AND ID_TAREA_REL_081 = TAREA.ID_TAREA_REL_081;
			
			END IF;
			
			SELECT FECHA_FINAL_IZO_053 INTO FECHA_FINAL_EXP FROM AA79B53T00 WHERE NUM_EXP_053 = TAREA.NUM_EXP AND ANYO_053 = TAREA.ANYO;
			
			IF (FECHA_FIN_NUEVA_TAREA > FECHA_FINAL_EXP) THEN
				FECHA_FIN_NUEVA_TAREA:= FECHA_FINAL_EXP;
			END IF;
			
			ESTADO_TAREA:= ESTADO_PDTE_ACEPTACION_TAREA;
	        FECHA_ACEPTACION_TAREA := null;
	    	IF (DNI_RECURSO = USUARIO) THEN
	    		ESTADO_TAREA:= ESTADO_ACEPTACION_TAREA;
	    		FECHA_ACEPTACION_TAREA := sysdate;
	    	END IF;
			
			UPDATE AA79B81T00 set RECURSO_ASIGNACION_081 = RECURSO_INTERNO, DNI_RECURSO_081 = DNI_RECURSO, ESTADO_ASIGNACION_081 = ESTADO_TAREA, FECHA_ACEPTACION_081 = FECHA_ACEPTACION_TAREA, 
		    FECHA_ASIGNACION_081=sysdate, FECHA_FIN_081 = FECHA_FIN_NUEVA_TAREA, FECHA_INICIO_081 = FECHA_INI_NUEVA_TAREA, HORAS_PREVISTAS_081= '00:30'
		   	WHERE ID_TAREA_081 = TAREA_ENTREGA;
		EXCEPTION
        WHEN NO_DATA_FOUND THEN
        	NUEVO_ID_TAREA := NULL;
        END;
END IF;



RETURN RETORNO;

 EXCEPTION
        WHEN NO_DATA_FOUND THEN
        	RETURN NULL;
END;
/

CREATE OR REPLACE PROCEDURE CREAR_TAREAS_DEFECTO (
   ANYO IN   NUMBER,
   NUM_EXP IN NUMBER
)
IS

TIPO_EXPEDIENTE VARCHAR2(1);
IND_CORREDACCION VARCHAR2(1);
NUM_TOTAL_PAL_IZO NUMBER(6):= 0;
ID_DATOS_BASICOS NUMBER(1):= 0;
PAL_PRESUPUESTO_TRADOS NUMBER(6):= 0;
NUM_DOC NUMBER(2):= 0;
TIPO_ENTIDAD VARCHAR2(1);
ID_ENTIDAD NUMBER(8);
ID_ENTIDAD_BOE NUMBER(8);

TIPO_INTERPRETACION VARCHAR2(1):= 'I';
TIPO_TRADUCCION VARCHAR2(1):= 'T';
TIPO_REVISION VARCHAR2(1):= 'R';

GESTION_INTERPRETACION NUMBER(2):= 6;
PREPARAR_INTERPRETACION NUMBER(2):= 7;
INTERPRETAR NUMBER(2):= 8;
IS_GESTION_INTERPRETACION BOOLEAN := FALSE;
IS_PREPARAR_INTERPRETACION BOOLEAN := FALSE;
IS_INTERPRETAR BOOLEAN := FALSE;

REVISAR NUMBER(2):= 4;
ENTREGA_CLIENTE_REVISION NUMBER(2):= 20;
IS_REVISAR BOOLEAN := FALSE;
IS_ENTREGA_CLIENTE_REVISION BOOLEAN := FALSE;

PROYECTO_TRADOS NUMBER(2):= 1;
TRADUCIR NUMBER(2):= 2;
CORREDACTAR NUMBER(2):= 3;
ENTREGA_CLIENTE_TRADUCCION NUMBER(2):= 19;
--ACTUALIZAR_MEMORIAS_TRADUCCION NUMBER(2):= 16;
POST_TRADUCCION_BOE NUMBER(2):= 10;
IS_PROYECTO_TRADOS BOOLEAN := FALSE;
IS_TRADUCIR BOOLEAN := FALSE;
IS_CORREDACTAR BOOLEAN := FALSE;
IS_ENTREGA_CLIENTE_TRADUCCION BOOLEAN := FALSE;
--IS_ACT_MEMORIAS_TRAD BOOLEAN := FALSE;
IS_POST_TRAD_BOE BOOLEAN := FALSE;

ESTADO_ASIGNACION_TAREA NUMBER(1):= 1;
TAREA_PENDIENTE_EJECUCION NUMBER(1):= 1;
ID_TAREA NUMBER(20):= 0;

EXPEDIENTE_EN_CURSO NUMBER(1):= 3;
FASE_EXP_PDTE_PROY_TRADOS NUMBER(1):= 6;
ESTADO_BITACORA NUMBER(3);
FECHA_INICIO DATE;
FECHA_FIN DATE;

ORDEN NUMBER(2);

CURSOR C_TIPOS_TAREA IS
	(SELECT ID_TIPO_TAREA_081
	FROM AA79B81S01 WHERE ANYO_081 = ANYO
	AND NUM_EXP_081 = NUM_EXP);

BEGIN
   	
  SELECT ID_TIPO_EXPEDIENTE_051, TIPO_ENTIDAD_054, ID_ENTIDAD_054 INTO TIPO_EXPEDIENTE,  TIPO_ENTIDAD, ID_ENTIDAD FROM AA79B51S01, AA79B54S01 WHERE ANYO_051 = ANYO AND NUM_EXP_051 = NUM_EXP
  AND ANYO_051 = ANYO_054 AND NUM_EXP_051 = NUM_EXP_054;
  
  FOR R_TIPOS_TAREA IN C_TIPOS_TAREA LOOP
    CASE
         WHEN (TIPO_EXPEDIENTE = TIPO_INTERPRETACION) THEN
            
            IF (R_TIPOS_TAREA.ID_TIPO_TAREA_081 = GESTION_INTERPRETACION) THEN
              IS_GESTION_INTERPRETACION := TRUE;
            END IF;
            IF (R_TIPOS_TAREA.ID_TIPO_TAREA_081 = PREPARAR_INTERPRETACION) THEN
              IS_PREPARAR_INTERPRETACION := TRUE;
            END IF;
            IF (R_TIPOS_TAREA.ID_TIPO_TAREA_081 = INTERPRETAR) THEN
              IS_INTERPRETAR := TRUE;
            END IF;
         
         WHEN (TIPO_EXPEDIENTE = TIPO_REVISION) THEN
            
            IF (R_TIPOS_TAREA.ID_TIPO_TAREA_081 = ENTREGA_CLIENTE_REVISION) THEN
              IS_ENTREGA_CLIENTE_REVISION := TRUE;
            END IF;
         
         WHEN (TIPO_EXPEDIENTE = TIPO_TRADUCCION) THEN
            
            IF (R_TIPOS_TAREA.ID_TIPO_TAREA_081 = PROYECTO_TRADOS) THEN
              IS_PROYECTO_TRADOS := TRUE;
            END IF;
            IF (R_TIPOS_TAREA.ID_TIPO_TAREA_081 = TRADUCIR) THEN
              IS_TRADUCIR := TRUE;
            END IF;
            IF (R_TIPOS_TAREA.ID_TIPO_TAREA_081 = ENTREGA_CLIENTE_TRADUCCION) THEN
              IS_ENTREGA_CLIENTE_TRADUCCION := TRUE;
            END IF;
            /*IF (R_TIPOS_TAREA.ID_TIPO_TAREA_081 = ACTUALIZAR_MEMORIAS_TRADUCCION) THEN
              IS_ACT_MEMORIAS_TRAD := TRUE;
            END IF;*/
            IF (R_TIPOS_TAREA.ID_TIPO_TAREA_081 = CORREDACTAR) THEN
              IS_CORREDACTAR := TRUE;
            END IF;
            IF (R_TIPOS_TAREA.ID_TIPO_TAREA_081 = POST_TRADUCCION_BOE) THEN
              IS_POST_TRAD_BOE := TRUE;
            END IF;
        
    END CASE;
  END LOOP;
 
  CASE
       WHEN (TIPO_EXPEDIENTE = TIPO_INTERPRETACION) THEN
          
          IF (IS_GESTION_INTERPRETACION = FALSE) THEN
            SELECT AA79B81Q00.NEXTVAL INTO ID_TAREA FROM dual;
            INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) VALUES (ANYO,null,ESTADO_ASIGNACION_TAREA,TAREA_PENDIENTE_EJECUCION,null,null,null,null,'',ID_TAREA,null,null,'N','N',null,NUM_EXP,null,0,null,GESTION_INTERPRETACION,null,null,null,null);
            INSERT INTO AA79B82T00 (ID_TAREA_082) values (ID_TAREA);
            
            insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) 
			select ID_TAREA, ID_DOC_056 from AA79B56T00 where ANYO_056 = ANYO  AND 
    		NUM_EXP_056 = NUM_EXP AND ID_DOC_REL_056 is null AND ID_DOC_VERSION_056 is null;
            
          END IF;
          
          IF (IS_PREPARAR_INTERPRETACION = FALSE) THEN
            SELECT AA79B81Q00.NEXTVAL INTO ID_TAREA FROM dual;
            
            UPDATE AA79B81S01 set ORDEN_081 = ORDEN_081 + 1 WHERE ORDEN_081 = 1 AND ANYO_081 = ANYO AND NUM_EXP_081 = NUM_EXP;
            
            INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) 
            VALUES (ANYO,null,ESTADO_ASIGNACION_TAREA,TAREA_PENDIENTE_EJECUCION,null,null,null,null,'',ID_TAREA,null,null,'N','N',null,NUM_EXP,null,1,null,PREPARAR_INTERPRETACION,null,null,null,null);
            INSERT INTO AA79B82T00 (ID_TAREA_082) values (ID_TAREA);
            
            insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) 
			select ID_TAREA, ID_DOC_056 from AA79B56T00 where ANYO_056 = ANYO  AND 
    		NUM_EXP_056 = NUM_EXP AND ID_DOC_REL_056 is null AND ID_DOC_VERSION_056 is null;
    		
          END IF;
          
          IF (IS_INTERPRETAR = FALSE) THEN
            SELECT AA79B81Q00.NEXTVAL INTO ID_TAREA FROM dual;            
            
            -- CALCULAMOS EL ORDEN
            SELECT nvl(MAX(ORDEN_081),0) + 1 into orden FROM AA79B81T00, AA79B15T00  WHERE ANYO_081 = ANYO AND NUM_EXP_081 = NUM_EXP AND ID_TIPO_TAREA_081 = ID_015 AND IND_REQ_CIERRE_015 = 'S';
            
             UPDATE AA79B81S01 set ORDEN_081 = ORDEN_081 + 1 WHERE ORDEN_081 = orden AND ANYO_081 = ANYO AND NUM_EXP_081 = NUM_EXP;
            
            SELECT FECHA_INI_052, FECHA_FIN_052 INTO FECHA_INICIO, FECHA_FIN FROM AA79B52S01 WHERE ANYO_052 = ANYO AND NUM_EXP_052 = NUM_EXP;
            INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) 
            VALUES (ANYO,null,ESTADO_ASIGNACION_TAREA,TAREA_PENDIENTE_EJECUCION,null,null,FECHA_FIN,FECHA_INICIO,'',ID_TAREA,null,null,'N','S',null,NUM_EXP,null,ORDEN,null,INTERPRETAR,null,null,null,null);
            INSERT INTO AA79B82T00 (ID_TAREA_082) values (ID_TAREA);
            
            insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) 
			select ID_TAREA, ID_DOC_056 from AA79B56T00 where ANYO_056 = ANYO  AND 
    		NUM_EXP_056 = NUM_EXP AND ID_DOC_REL_056 is null AND ID_DOC_VERSION_056 is null;
    		
          END IF;
       
       WHEN (TIPO_EXPEDIENTE = TIPO_REVISION) THEN
          
          /*IF (IS_REVISAR = FALSE) THEN
            SELECT AA79B81Q00.NEXTVAL INTO ID_TAREA FROM dual;
            INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) VALUES (ANYO,null,ESTADO_ASIGNACION_TAREA,TAREA_PENDIENTE_EJECUCION,null,null,null,null,'',ID_TAREA,null,null,'N','N',null,NUM_EXP,null,1,null,REVISAR,null,null,null,1);
            INSERT INTO AA79B82T00 (ID_TAREA_082) values (ID_TAREA);
            
            insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) 
			select ID_TAREA, ID_DOC_056 from AA79B56T00 where ANYO_056 = ANYO  AND 
    		NUM_EXP_056 = NUM_EXP AND ID_DOC_REL_056 is null AND ID_DOC_VERSION_056 is null;
          END IF;*/
          
          IF (IS_ENTREGA_CLIENTE_REVISION = FALSE) THEN
            SELECT AA79B81Q00.NEXTVAL INTO ID_TAREA FROM dual;
            -- CALCULAMOS EL ORDEN
            SELECT nvl(MAX(ORDEN_081),0) + 1 into orden FROM AA79B81T00, AA79B15T00  WHERE ANYO_081 = ANYO AND NUM_EXP_081 = NUM_EXP AND ID_TIPO_TAREA_081 = ID_015 AND IND_REQ_CIERRE_015 = 'S';
            
            UPDATE AA79B81S01 set ORDEN_081 = ORDEN_081 + 1 WHERE ORDEN_081 = ORDEN AND ANYO_081 = ANYO AND NUM_EXP_081 = NUM_EXP;
            
            INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) VALUES (ANYO,null,ESTADO_ASIGNACION_TAREA,TAREA_PENDIENTE_EJECUCION,null,null,null,null,'',ID_TAREA,null,null,'N','N',null,NUM_EXP,null,ORDEN,null,ENTREGA_CLIENTE_REVISION,null,null,null,1);
            INSERT INTO AA79B82T00 (ID_TAREA_082) values (ID_TAREA);
            
            insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) 
			select ID_TAREA, ID_DOC_056 from AA79B56T00 where ANYO_056 = ANYO  AND 
    		NUM_EXP_056 = NUM_EXP AND ID_DOC_REL_056 is null AND ID_DOC_VERSION_056 is null
    		AND CLASE_DOCUMENTO_056 <> 4 ;
            
          END IF;
          
       WHEN (TIPO_EXPEDIENTE = TIPO_TRADUCCION) THEN
          -- RECUPERAMOS SI ES CORREDACCION	
       	  Select IND_CORREDACCION_053 into IND_CORREDACCION from AA79B53T00 where ANYO_053 = ANYO AND NUM_EXP_053 = NUM_EXP;
       
       	  SELECT COUNT(1) INTO NUM_DOC FROM AA79B56S01 t1 RIGHT JOIN AA79B42S01 t2 ON t1.TIPO_DOCUMENTO_056 = t2.ID_042 
          WHERE t2.IND_ACTUALIZA_MEMORIAS_042 = 'S' AND t1.ANYO_056 = ANYO AND t1.NUM_EXP_056 = NUM_EXP;
          
          SELECT NUM_TOTAL_PAL_IZO_053 INTO NUM_TOTAL_PAL_IZO FROM AA79B53S01 WHERE ANYO_053 = ANYO AND NUM_EXP_053 = NUM_EXP;
          SELECT PAL_PRESUPUESTO_TRADOS_003 INTO PAL_PRESUPUESTO_TRADOS FROM AA79B03S01 WHERE ID_003 = ID_DATOS_BASICOS;
                    
          IF (NUM_TOTAL_PAL_IZO > PAL_PRESUPUESTO_TRADOS AND IS_PROYECTO_TRADOS = FALSE) THEN 
            SELECT AA79B81Q00.NEXTVAL INTO ID_TAREA FROM dual;
            INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) VALUES (ANYO,null,ESTADO_ASIGNACION_TAREA,TAREA_PENDIENTE_EJECUCION,null,null,null,null,'',ID_TAREA,null,null,'N','N',null,NUM_EXP,null,0,null,PROYECTO_TRADOS,null,null,null,null);
            INSERT INTO AA79B82T00 (ID_TAREA_082) values (ID_TAREA);
            
            insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) 
			select ID_TAREA, ID_DOC_056 from AA79B56T00 where ANYO_056 = ANYO  AND 
    		NUM_EXP_056 = NUM_EXP AND ID_DOC_REL_056 is null AND ID_DOC_VERSION_056 is null;
            
            SELECT nvl(max(ID_ESTADO_BITACORA_059),0) + 1 INTO ESTADO_BITACORA FROM AA79B59S01 t1 WHERE NUM_EXP_059 = NUM_EXP AND ANYO_059 = ANYO;
            INSERT INTO AA79B59S01 (ANYO_059, NUM_EXP_059, ID_ESTADO_BITACORA_059, ID_ESTADO_EXP_059, ID_FASE_EXPEDIENTE_059, DATO_ADIC_059, INFO_ADIC_059, ID_RECHAZO_059, ID_REQUERIMIENTO_059, FECHA_ALTA_059) VALUES (ANYO,NUM_EXP,ESTADO_BITACORA,EXPEDIENTE_EN_CURSO,FASE_EXP_PDTE_PROY_TRADOS,null,null,null,null, SYSDATE);
            UPDATE AA79B51S01 SET ESTADO_BITACORA_051= ESTADO_BITACORA WHERE ANYO_051 = ANYO AND NUM_EXP_051 = NUM_EXP;
          END IF;
          
          IF (IND_CORREDACCION = 'N') THEN
          
	          IF (IS_TRADUCIR = FALSE) THEN
	          
	          	UPDATE AA79B81S01 set ORDEN_081 = ORDEN_081 + 1 WHERE ORDEN_081 = 1 AND ANYO_081 = ANYO AND NUM_EXP_081 = NUM_EXP;
	          
	            SELECT AA79B81Q00.NEXTVAL INTO ID_TAREA FROM dual;
	            INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) 
	            VALUES (ANYO,null,ESTADO_ASIGNACION_TAREA,TAREA_PENDIENTE_EJECUCION,null,null,null,null,'',ID_TAREA,null,null,'N','S',null,NUM_EXP,null,1,null,TRADUCIR,null,null,null,null);
	            INSERT INTO AA79B82T00 (ID_TAREA_082) values (ID_TAREA);
	            
	            insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) 
				select ID_TAREA, ID_DOC_056 from AA79B56T00 where ANYO_056 = ANYO  AND 
	    		NUM_EXP_056 = NUM_EXP AND ID_DOC_REL_056 is null AND ID_DOC_VERSION_056 is null;
	          END IF;
	          IF (IS_POST_TRAD_BOE = FALSE) THEN
	            SELECT VALOR_000 INTO ID_ENTIDAD_BOE FROM AA79B00T00 WHERE ID_000 = 1;
	            IF (ID_ENTIDAD_BOE = ID_ENTIDAD AND TIPO_ENTIDAD = 'B') THEN
	          	
	            	UPDATE AA79B81S01 set ORDEN_081 = ORDEN_081 + 1 WHERE ORDEN_081 = 2 AND ANYO_081 = ANYO AND NUM_EXP_081 = NUM_EXP;
	            
		          	SELECT AA79B81Q00.NEXTVAL INTO ID_TAREA FROM dual;
		            INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) 
		            VALUES (ANYO,null,ESTADO_ASIGNACION_TAREA,TAREA_PENDIENTE_EJECUCION,null,null,null,null,'',ID_TAREA,null,null,'N','S',null,NUM_EXP,null,2,null,POST_TRADUCCION_BOE,null,null,null,null);
		            INSERT INTO AA79B82T00 (ID_TAREA_082) values (ID_TAREA);
		            
		            insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) 
					select ID_TAREA, ID_DOC_056 from AA79B56T00 where ANYO_056 = ANYO  AND 
		    		NUM_EXP_056 = NUM_EXP AND ID_DOC_REL_056 is null AND ID_DOC_VERSION_056 is null;
		    	END IF;
	          END IF;
	          IF (IS_ENTREGA_CLIENTE_TRADUCCION = FALSE) THEN
	            SELECT AA79B81Q00.NEXTVAL INTO ID_TAREA FROM dual;
	            
	            -- CALCULAMOS EL ORDEN
            	SELECT nvl(MAX(ORDEN_081),0) + 1 into orden FROM AA79B81T00, AA79B15T00  WHERE ANYO_081 = ANYO AND NUM_EXP_081 = NUM_EXP AND ID_TIPO_TAREA_081 = ID_015 AND IND_REQ_CIERRE_015 = 'S';
	            
            	UPDATE AA79B81S01 set ORDEN_081 = ORDEN_081 + 1 WHERE ORDEN_081 = ORDEN AND ANYO_081 = ANYO AND NUM_EXP_081 = NUM_EXP;
            	
	            INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) VALUES (ANYO,null,ESTADO_ASIGNACION_TAREA,TAREA_PENDIENTE_EJECUCION,null,null,null,null,'',ID_TAREA,null,null,'N','N',null,NUM_EXP,null,ORDEN,null,ENTREGA_CLIENTE_TRADUCCION,null,null,null,null);  
	            INSERT INTO AA79B82T00 (ID_TAREA_082) values (ID_TAREA);
	            
	            insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) 
				select ID_TAREA, ID_DOC_056 from AA79B56T00 where ANYO_056 = ANYO  AND 
	    		NUM_EXP_056 = NUM_EXP AND ID_DOC_REL_056 is null AND ID_DOC_VERSION_056 is null
	    		AND CLASE_DOCUMENTO_056 <> 4 ;
	            
	          END IF;
	          
	          
	     END IF;
	     
	     IF (IND_CORREDACCION = 'S') THEN
	          IF (IS_CORREDACTAR = FALSE) THEN
	          
	          	UPDATE AA79B81S01 set ORDEN_081 = ORDEN_081 + 1 WHERE ORDEN_081 = 1 AND ANYO_081 = ANYO AND NUM_EXP_081 = NUM_EXP;
	          	
	            SELECT AA79B81Q00.NEXTVAL INTO ID_TAREA FROM dual;
	            INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) VALUES (ANYO,null,ESTADO_ASIGNACION_TAREA,TAREA_PENDIENTE_EJECUCION,null,null,null,null,'',ID_TAREA,null,null,'N','N',null,NUM_EXP,null,1,null,CORREDACTAR,null,null,null,null);
	            INSERT INTO AA79B82T00 (ID_TAREA_082) values (ID_TAREA);
	            
	            insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) 
				select ID_TAREA, ID_DOC_056 from AA79B56T00 where ANYO_056 = ANYO  AND 
	    		NUM_EXP_056 = NUM_EXP AND ID_DOC_REL_056 is null AND ID_DOC_VERSION_056 is null;
	          END IF;
	          
	     END IF;
	     /*IF (NUM_TOTAL_PAL_IZO > PAL_PRESUPUESTO_TRADOS AND NUM_DOC > 0 AND IS_ACT_MEMORIAS_TRAD = FALSE) THEN 
	            
	     		 -- CALCULAMOS EL ORDEN
            	SELECT nvl(MAX(ORDEN_081),0) + 1 into orden FROM AA79B81T00, AA79B15T00  WHERE ANYO_081 = ANYO AND NUM_EXP_081 = NUM_EXP AND ID_TIPO_TAREA_081 = ID_015 AND IND_REQ_CIERRE_015 = 'S';
	            
            	UPDATE AA79B81S01 set ORDEN_081 = ORDEN_081 + 1 WHERE ORDEN_081 = ORDEN AND ANYO_081 = ANYO AND NUM_EXP_081 = NUM_EXP;
	     
	     		SELECT AA79B81Q00.NEXTVAL INTO ID_TAREA FROM dual;
	            INSERT INTO AA79B81S01 (ANYO_081, DNI_RECURSO_081, ESTADO_ASIGNACION_081, ESTADO_EJECUCION_081, FECHA_ACEPTACION_081, FECHA_ASIGNACION_081, FECHA_FIN_081, FECHA_INICIO_081, HORAS_PREVISTAS_081, ID_TAREA_081, ID_TAREA_REL_081, ID_REQUERIMIENTO_081, IND_NO_CONFORMIDAD_081, IND_FACTURABLE_081, ID_LOTE_081, NUM_EXP_081, OBSERV_081, ORDEN_081, RECURSO_ASIGNACION_081, ID_TIPO_TAREA_081, TIPO_ENTIDAD_081, ID_ENTIDAD_081, DNI_ASIGNADOR_081, ID_TIPO_REVISION_081) VALUES (ANYO,null,ESTADO_ASIGNACION_TAREA,TAREA_PENDIENTE_EJECUCION,null,null,null,null,'',ID_TAREA,null,null,'N','N',null,NUM_EXP,null,ORDEN,null,ACTUALIZAR_MEMORIAS_TRADUCCION,null,null,null,null);
	            INSERT INTO AA79B82T00 (ID_TAREA_082) values (ID_TAREA);
	            
	            insert into AA79B83T00 (ID_TAREA_083, ID_DOC_083) 
				select ID_TAREA, ID_DOC_056 from AA79B56T00 where ANYO_056 = ANYO  AND 
    			NUM_EXP_056 = NUM_EXP AND ID_DOC_REL_056 is null AND ID_DOC_VERSION_056 is null;
	        END IF;*/
  END CASE;
	
END;
/
-- ELIMINAR LA FUNCION CREADA  CALCULAR_FECHA_FIN_TAREA
DROP FUNCTION CALCULAR_FECHA_FIN_TAREA;

-- AA79BB5T00
DROP TABLE AA79BB5T00;
DROP SEQUENCE AA79B.AA79BB5Q00;
-- ELIMINAMOS SU SINONIMO
DROP SYNONYM AA79BB5S01;

exit;