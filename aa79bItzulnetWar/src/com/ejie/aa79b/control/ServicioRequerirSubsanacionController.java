package com.ejie.aa79b.control;

import java.util.Locale;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.ResponseBody;

import com.ejie.aa79b.model.BitacoraExpediente;
import com.ejie.aa79b.model.DocumentosExpediente;
import com.ejie.aa79b.model.EstadosExpediente;
import com.ejie.aa79b.model.Expediente;
import com.ejie.aa79b.model.ExpedienteTradRev;
import com.ejie.aa79b.model.GestorExpediente;
import com.ejie.aa79b.model.PersonalIZO;
import com.ejie.aa79b.model.SubsanacionExpediente;
import com.ejie.aa79b.model.Tareas;
import com.ejie.aa79b.model.enums.EstadoExpedienteEnum;
import com.ejie.aa79b.security.Usuario;
import com.ejie.aa79b.service.DatosGeneralesExpedienteService;
import com.ejie.aa79b.service.ExpedienteService;
import com.ejie.aa79b.service.SubsanacionService;
import com.ejie.aa79b.utils.SubsanacionUtils;
import com.ejie.x38.control.bind.annotation.RequestJsonBody;
import com.ejie.x38.dto.JQGridRequestDto;
import com.ejie.x38.dto.JQGridResponseDto;

/**
 * ExpedienteAltaController generated by UDA, 31-ene-2018 15:08:53.
 * 
 * @author UDA
 */

@Controller
@RequestMapping(value = "/servicios/requerirsubsanacionexpedientes")

public class ServicioRequerirSubsanacionController {

	@Autowired()
	private ExpedienteService expedienteService;
	@Autowired()
	private SubsanacionService subsanacionService;
	@Autowired
	private DatosGeneralesExpedienteService datosGeneralesExpedienteService;

	private static final Logger LOGGER = LoggerFactory.getLogger(ServicioRequerirSubsanacionController.class);

	/**
	 * Metodo de presentacion del RUP_TABLE.
	 * 
	 * @param model
	 *            Model
	 * @return String
	 */
	@RequestMapping(value = "/maint", method = RequestMethod.GET)
	public String getAlta() {
		ServicioRequerirSubsanacionController.LOGGER.info("[GET - View] : expedientealta");
		return "servicioRequerirSubsanacion";
	}

	@RequestMapping(value = "/requerirSubsanacion/filter", method = RequestMethod.POST)
	public @ResponseBody JQGridResponseDto<Expediente> getFilterTareaDependiente(
			@RequestJsonBody(param = "filter") Expediente expedienteFilter,
			@RequestJsonBody JQGridRequestDto jqGridRequestDto) {
		ServicioRequerirSubsanacionController.LOGGER.info("[POST - filter] : Obtener expedientes");
		BitacoraExpediente bitacoraExpediente = new BitacoraExpediente();
		EstadosExpediente estadoExp = new EstadosExpediente();
		estadoExp.setId(new Long(EstadoExpedienteEnum.EN_CURSO.getValue()));
		bitacoraExpediente.setEstadoExp(estadoExp);
		expedienteFilter.setBitacoraExpediente(bitacoraExpediente);
		return this.expedienteService.filtroExpedienteEstadoEnCurso(expedienteFilter, jqGridRequestDto, false);
	}

	@RequestMapping(value = "/requerirSubsanacionDetalle/maint/{anyo}/{numExp}", method = RequestMethod.GET)
	public String irCargaTrabajoDetalleTarea(Model model, @PathVariable Long anyo, @PathVariable Integer numExp) {
		ServicioRequerirSubsanacionController.LOGGER.info("[GET - View] : requerirSubsanacionDetalle");
		Expediente expedienteFilter = new Expediente();
		expedienteFilter.setAnyo(anyo);
		expedienteFilter.setNumExp(numExp);
		ExpedienteTradRev expedienteTradRev = this.expedienteService.getFechaFinalIzo(expedienteFilter);
		model.addAttribute("fechaHoraFinIzo", expedienteTradRev.getFechaHoraFinalIZO());
		return "requerirSubsanacionDetalle";
	}

	@RequestMapping(value = "/requerirSubsanacionDetalle/comprobarSiTieneZIP/{anyo}/{numExp}", method = RequestMethod.POST)
	public @ResponseBody Integer comprobarSiTieneZIP(@PathVariable Long anyo, @PathVariable Integer numExp) {
		ServicioRequerirSubsanacionController.LOGGER.info("[POST - filter] : comprobarSiTieneZIP");
		DocumentosExpediente documentosExpediente = new DocumentosExpediente();
		documentosExpediente.setAnyo(anyo);
		documentosExpediente.setNumExp(numExp);
		return this.subsanacionService.comprobarSiTieneZIP(documentosExpediente);
	}

	@RequestMapping(value = "/requerirSubsanacionDetalle/guardar", method = RequestMethod.POST)
	public @ResponseBody String guardarRequerirSubsanacion(
			@RequestJsonBody(required = false, param = "expediente") Expediente expedientes,
			@RequestJsonBody(required = false, param = "camposSelectSub") String camposSelecSub,
			@RequestJsonBody(required = false, param = "docuSelecSub") String docuSelecSub,
			@RequestJsonBody(required = false, param = "subsanacionExp") SubsanacionExpediente subsanacionExpediente,
			@RequestJsonBody(required = false, param = "tareas") Tareas tareas, Locale locale) {
		ServicioRequerirSubsanacionController.LOGGER.info("[GET - View] : requerirSubsanacionDetalle");
		Usuario credentials = (Usuario) SecurityContextHolder.getContext().getAuthentication().getCredentials();
		PersonalIZO personaAsignada = new PersonalIZO();
		personaAsignada.setDni(credentials.getNif());
		tareas.setPersonaAsignada(personaAsignada);
		this.expedienteService.registrarSubsanacionTarea(subsanacionExpediente, camposSelecSub, docuSelecSub,
				expedientes, tareas, locale);

		// llamar libro de registro salida
		expedientes.setLblRegPresencial("label.subsanacionRequerida");
		this.datosGeneralesExpedienteService.anotarLibroRegistroSalida(expedientes);

		GestorExpediente gestor = this.expedienteService.getDatosContacto(expedientes);

		SubsanacionUtils subsanacionUtils = new SubsanacionUtils();
		subsanacionUtils.enviarEmailRequerirSubsanacion(expedientes, subsanacionExpediente, gestor);
		return "requerirSubsanacionDetalle";
	}
}
