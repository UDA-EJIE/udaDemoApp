package com.ejie.aa79b.control;

import java.math.BigDecimal;
import java.util.List;
import java.util.Locale;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.support.ReloadableResourceBundleMessageSource;
import org.springframework.http.HttpStatus;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.ResponseStatus;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.model.DatosPersona;
import com.ejie.aa79b.model.OtrosTrabajos;
import com.ejie.aa79b.model.Persona;
import com.ejie.aa79b.model.PersonalIZO;
import com.ejie.aa79b.model.TareasTrabajo;
import com.ejie.aa79b.model.excel.ExcelModel;
import com.ejie.aa79b.security.Usuario;
import com.ejie.aa79b.service.DatosPersonaService;
import com.ejie.aa79b.service.ExcelReportService;
import com.ejie.aa79b.service.OtrosTrabajosService;
import com.ejie.aa79b.service.PersonalIZOService;
import com.ejie.aa79b.service.TareasTrabajoService;
import com.ejie.x38.control.bind.annotation.RequestJsonBody;
import com.ejie.x38.dto.JQGridRequestDto;
import com.ejie.x38.dto.JQGridResponseDto;

/**
 * MotivosrechazoController generated by UDA, 16-nov-2017 12:15:14.
 *
 * @author UDA
 */

@Controller
@RequestMapping(value = "/tramitacionexpedientes/otrostrabajos")

public class OtrosTrabajosController {

    private static final Logger LOGGER = LoggerFactory.getLogger(OtrosTrabajosController.class);

    @Autowired
    private OtrosTrabajosService otrosTrabajosService;

    @Autowired
    private TareasTrabajoService tareasTrabajoService;

    @Autowired()
	private DatosPersonaService datosPersonaService;

    @Autowired()
	private PersonalIZOService personalIZOService;

    @Autowired
	private ReloadableResourceBundleMessageSource appMessageSource;

    @Autowired
	private ExcelReportService excelReportService;

    /*
     * OPERACIONES CRUD (Create, Read, Update, Delete)
     *
     */

    /**
     * Operacion CRUD Read. Devuelve el bean correspondiente al identificador
     * indicado.
     *
     * @param id013
     *            Long
     * @return Motivosrechazo Objeto correspondiente al identificador indicado.
     */
    @RequestMapping(value = "/{idTrabajo}", method = RequestMethod.GET)
    public @ResponseBody OtrosTrabajos get(@PathVariable BigDecimal idTrabajo) {
    	OtrosTrabajos trabajo = new OtrosTrabajos();
    	trabajo.setIdTrabajo(idTrabajo);
//    	trabajo = this.otrosTrabajosService.find(trabajo);
    	trabajo = this.otrosTrabajosService.buscarTrabajo(trabajo);
        OtrosTrabajosController.LOGGER.info("[GET - findBy_PK] : Obtener otros trabajos por PK");
        return trabajo;
    }

    /**
     * Operacion CRUD Edit. Modificacion del bean indicado.
     *
     * @param motivosrechazo
     *            Motivosrechazo Bean que contiene la informacion a modificar.
     * @return Motivosrechazo Bean resultante de la modificacion.
     */
    @RequestMapping(method = RequestMethod.PUT)
    public @ResponseBody OtrosTrabajos edit(@RequestBody OtrosTrabajos otrosTrabajos) {
    	OtrosTrabajos otrosTrabajosAux = this.otrosTrabajosService.update(otrosTrabajos);
        OtrosTrabajosController.LOGGER.info("[PUT] : OtrosTrabajos actualizado correctamente");
        return otrosTrabajosAux;
    }

    /**
     * Operacion CRUD Create. Creacion de un nuevo registro a partir del bean
     * indicado.
     *
     * @param motivosrechazo
     *            Motivosrechazo Bean que contiene la informacion con la que se
     *            va a crear el nuevo registro.
     * @return Motivosrechazo Bean resultante del proceso de creacion.
     */
    @RequestMapping(method = RequestMethod.POST)
    public @ResponseBody OtrosTrabajos add(@RequestBody OtrosTrabajos otrosTrabajos) {
    	OtrosTrabajos otrosTrabajosAux = this.otrosTrabajosService.add(otrosTrabajos);
        OtrosTrabajosController.LOGGER.info("[POST] : OtrosTrabajos insertado correctamente");
        return otrosTrabajosAux;
    }

    /**
	 * Se comprueba si el trabajo tiene tareas asociadas
	 *
	 * @param idTrabajo
	 *            BigDecimal
	 * @return Tareas
	 */
	@RequestMapping(value = "/tieneTareas/{idTrabajo}", method = RequestMethod.GET)
	public @ResponseBody Boolean comprobarContieneTareas(@PathVariable BigDecimal idTrabajo) {
		OtrosTrabajos trabajo = new OtrosTrabajos();
    	trabajo.setIdTrabajo(idTrabajo);
    	Integer tiene = this.otrosTrabajosService.comprobarTieneTareasAsociadas(trabajo);
    	Boolean bResul = false;
    	if(tiene>Constants.CERO){
			bResul = true;
		}
		return bResul;
	}




    /**
     * Operacion CRUD Delete. Borrado del registro correspondiente al
     * identificador especificado.
     *
     * @param id013
     *            Long Identificador del objeto que se desea eliminar.
     * @return Motivosrechazo Bean eliminado.
     */
    @RequestMapping(value = "/{idTrabajo}", method = RequestMethod.DELETE)
    @ResponseStatus(value = HttpStatus.OK)
    public @ResponseBody OtrosTrabajos remove(@PathVariable BigDecimal idTrabajo) {
    	OtrosTrabajos otrosTrabajos = new OtrosTrabajos();
    	otrosTrabajos.setIdTrabajo(idTrabajo);
        this.otrosTrabajosService.remove(otrosTrabajos);
        OtrosTrabajosController.LOGGER.info("[DELETE] : Motivosrechazo borrado correctamente");
        return otrosTrabajos;
    }

    /*
     * METODOS COMPONENTE RUP_TABLE
     *
     */

    /**
     * Metodo de presentacion del RUP_TABLE.
     *
     * @param model
     *            Model
     * @return String
     */
    @RequestMapping(value = "/maint", method = RequestMethod.GET)
    public String getFormTrabajos(Model model) {
        OtrosTrabajosController.LOGGER.info("[GET - View] : otrostrabajos");
        return "otrosTrabajos";
    }

    /**
     * Operacion de filtrado del componente RUP_TABLE.
     *
     * @param filterMotivosrechazo
     *            Motivosrechazo Bean que contiene los parametros de filtrado a
     *            emplear.
     * @param jqGridRequestDto
     *            Dto que contiene los parametros de configuracion propios del
     *            RUP_TABLE a aplicar en el filtrado.
     * @return JQGridResponseDto<Motivosrechazo> Dto que contiene el resultado
     *         del filtrado realizado por el componente RUP_TABLE.
     */
    @RequestMapping(value = "/filter", method = RequestMethod.POST)
    public @ResponseBody JQGridResponseDto<OtrosTrabajos> filter(
            @RequestJsonBody(param = "filter") OtrosTrabajos filterOtrosTrabajos,
            @RequestJsonBody JQGridRequestDto jqGridRequestDto) {
        OtrosTrabajosController.LOGGER.info("[POST - filter] : Obtener Motivosrechazos");
        return this.otrosTrabajosService.filter(filterOtrosTrabajos, jqGridRequestDto, false);
    }


    @RequestMapping(value = "/clonarTrabajo", method = RequestMethod.POST)
	public @ResponseBody Boolean clonarTrabajo(
			@RequestJsonBody(required = false, param = "otrosTrabajos") OtrosTrabajos otrosTrabajos, HttpServletRequest request) {
    	OtrosTrabajosController.LOGGER.info("[POST ] : clonarTrabajo");
    	Integer ok =this.otrosTrabajosService.clonarTrabajo(otrosTrabajos);
    	Boolean bResul = false;
    	if(ok>Constants.CERO){
			bResul = true;
		}
		return bResul;
	}

    //Tareas trabajo
    /**
     * Metodo de presentacion del RUP_TABLE.
     *
     * @param model
     *            Model
     * @return String
     */
    @RequestMapping(value = "/tareastrabajo/maint", method = RequestMethod.GET)
    public String getFormTareasTrabajos(Model model) {
        OtrosTrabajosController.LOGGER.info("[GET - View] : otrostrabajos/tareastrabajo");
        return "tareasTrabajo";
    }

    @RequestMapping(value = "/tareastrabajo/filter", method = RequestMethod.POST)
	public @ResponseBody JQGridResponseDto<TareasTrabajo> getTareasTrabajoFilter(
			@RequestJsonBody(param = "filter") TareasTrabajo filter, @RequestJsonBody JQGridRequestDto jqGridRequestDto) {
    	OtrosTrabajosController.LOGGER.info("[POST - filter] : Obtener tareas del expediente");
		if (jqGridRequestDto != null) {
			jqGridRequestDto.setSidx("ORDEN,IDTAREA");
			jqGridRequestDto.setSord("ASC");
		}
		return this.tareasTrabajoService.filter(filter, jqGridRequestDto, false);
	}

    /**
	 *
	 * @return String
	 */
	@RequestMapping(value = "/tareastrabajo/crearconftareas/maint", method = RequestMethod.GET)
	public String crearconfigurartareas() {
		OtrosTrabajosController.LOGGER.info("[GET - View] : crearConfigurarTareas");
		return "crearconftareastrabajos";
	}

	/**
	 * Devuelve los datos del usuario conectado para poder autoasignar tareas
	 *
	 * @return Persona
	 */
	@RequestMapping(value = "/tareastrabajo/autoasignartareas", method = RequestMethod.GET)
	public @ResponseBody() Persona getAutoasignarTareas() {
		OtrosTrabajosController.LOGGER.info("[GET - View] : Autoasignar tareas");

		Usuario credentials = (Usuario) SecurityContextHolder.getContext().getAuthentication().getCredentials();
		Persona persona = new Persona();
		persona.setDni(credentials.getNif());
		persona.setNombre(credentials.getFullName());

		// actualizar
		boolean esta = this.datosPersonaService.comprobarPersona(persona.getDni());
		if (!esta) {
			PersonalIZO personalIZO = new PersonalIZO();
			personalIZO.setDni(persona.getDni());
			PersonalIZO personalAInsertar = this.personalIZOService.find(personalIZO);
			DatosPersona personaFoto = new DatosPersona();
			personaFoto.setDni(persona.getDni());
			personaFoto.setSufDni(personalAInsertar.getSufDni());
			personaFoto.setPreDni(personalAInsertar.getPreDni());
			personaFoto.setTipIden(personalAInsertar.getTipIden());
			personaFoto.setNombre(personalAInsertar.getNombre());
			personaFoto.setApellido1(personalAInsertar.getApellido1());
			personaFoto.setApellido2(personalAInsertar.getApellido2());
			this.datosPersonaService.add(personaFoto);
		}

		return persona;
	}

	/**
	 * Operacion CRUD Create. Creacion de un nuevo registro a partir del bean
	 * indicado.
	 *
	 * @param tarea
	 *            Tareas Bean que contiene la informacion con la que se va a
	 *            crear el nuevo registro.
	 * @param documentosSelect
	 *            String
	 * @return int, Devuelve (0/1): 0 - Si la tarea se ha creado/actualizado
	 *         correctamente; 1 - Si el expediente está en curso y pendiente de
	 *         ejecución de la tarea proyecto trados
	 */
	@RequestMapping(value = "/tareastrabajo/addTarea", method = RequestMethod.POST)
	public @ResponseBody int add(@RequestJsonBody(required = false, param = "tarea") TareasTrabajo tarea) {
		return this.tareasTrabajoService.crearTarea(tarea);
	}

	/**
	 * Comprueba si existen tareas automáticas entre las tareas seleccionadas o
	 * tareas que no se puedan eliminar
	 *
	 * @param listSelectedIds
	 *            List<String>
	 * @param tipoExpediente
	 *            String
	 * @return int, Devuelve (0/1/2): 0 - Si no existen tareas automáticas; 1 -
	 *         si existen tareas automáticas; 2 - Si existen tareas que no se
	 *         puedan eliminar
	 */
	@RequestMapping(value = "/tareastrabajo/comprobarTareaAEliminar", method = RequestMethod.POST)
	public @ResponseBody() int comprobarTareasAEliminar(@RequestParam(value = "idTarea") BigDecimal idTarea) {
		OtrosTrabajosController.LOGGER.info("[POST] : Comprobar tareas eliminar");
		int rst = 0;
		if (this.tareasTrabajoService.comprobarTareaAEliminar(idTarea) > 0) {
			rst = 1;
		}
		return rst;

	}

	/**
     * Operacion CRUD Delete. Borrado del registro correspondiente al
     * identificador especificado.
     *
     * @param id013
     *            Long Identificador del objeto que se desea eliminar.
     * @return Motivosrechazo Bean eliminado.
     */
    @RequestMapping(value = "/tareastrabajo/{idTarea}", method = RequestMethod.DELETE)
    @ResponseStatus(value = HttpStatus.OK)
    public @ResponseBody TareasTrabajo removeTarea(@PathVariable BigDecimal idTarea) {
    	// obtenemos datos de la tarea
    	TareasTrabajo tarea = new TareasTrabajo();
    	tarea.setIdTarea(idTarea);
    	tarea = this.tareasTrabajoService.find(tarea);
    	// obtenemos datos del trabajo
    	OtrosTrabajos trabajo = new OtrosTrabajos();
    	trabajo.setIdTrabajo(tarea.getTrabajo().getIdTrabajo());
    	trabajo = this.otrosTrabajosService.find(trabajo);
    	tarea.setTrabajo(trabajo);
    	// enviar email de eliminacion de tarea
        this.tareasTrabajoService.enviarEmailEliminacionTareas(tarea);
        // eliminar tarea
        this.tareasTrabajoService.remove(tarea);

        OtrosTrabajosController.LOGGER.info("[DELETE] : tarea borrado correctamente");
        return tarea;
    }

    /**
	 * Se obtienen los datos de la tarea seleccionada
	 *
	 * @param idTarea
	 *            BigDecimal
	 * @return Tareas
	 */
	@RequestMapping(value = "/tareastrabajo/findConfTarea/{idTarea}", method = RequestMethod.GET)
	public @ResponseBody() TareasTrabajo findConfTarea(@PathVariable BigDecimal idTarea) {
		TareasTrabajo tarea = new TareasTrabajo();
    	tarea.setIdTarea(idTarea);
		return this.tareasTrabajoService.findConfTarea(tarea);
	}

	/**
	 * Reabre la tarea indicada
	 *
	 * @param idTarea
	 *            BigDecimal
	 */
	@RequestMapping(value = "/tareastrabajo/reabrirTarea/{idTarea}", method = RequestMethod.POST)
	public @ResponseBody int reabrirTarea(@PathVariable BigDecimal idTarea) {
		OtrosTrabajosController.LOGGER.info("[POST - reabrirTarea] : Reabre la tarea seleccionada");
		return this.tareasTrabajoService.reabrirTarea(idTarea);
	}

	/**
	 * Generacion de excel del detalle de albarán
	 *
	 * @param columns
	 * @param criterios
	 * @param jqGridRequestDto
	 * @param filterDatosPagoProveedores
	 * @param response
	 * @param locale
	 */
	@RequestMapping(value = "/excelReportTrabajosTareas", method = RequestMethod.POST)
	public void xlsxTablaDetalle(@RequestParam(value = "columns", required = false) String columns,
			@RequestParam(value = "criterios", required = false) String criterios,
			@ModelAttribute() JQGridRequestDto jqGridRequestDto, @ModelAttribute() OtrosTrabajos otrosTrabajos,
			HttpServletResponse response, Locale locale) {

		List<OtrosTrabajos> trabajos = this.otrosTrabajosService.getTrabajosExcelDetalle(otrosTrabajos);

		List<TareasTrabajo> tareas = this.tareasTrabajoService.getTareasTrabajosExcelDetalle(otrosTrabajos);

		String nombreFichero = "";
//
		StringBuilder columnsTareas = new StringBuilder("[[\"trabajo.idTrabajo\",\"label.idTrabajo\",60,\"right\"],"
				+ "[\"trabajo.descTrabajo\",\"label.titulo\",150,\"\"]," + "[\"orden\",\"label.orden\",30,\"right\"],"
				+ "[\"tipoTarea.descEu015\",\"aa79b.tabla.tipoTarea\",100,\"left\"],"
				+ "[\"observaciones\",\"label.observaciones\",150,\"left\"],"
				+ "[\"personaAsignada.nombreCompleto\",\"label.recursoAsignado\",90,\"left\"],"
				+ "[\"estadoAsignadoDesc\",\"label.estadoAceptacion\",70,\"\"]," + "[\"estadoEjecucionDesc\",\"label.estadoEjecucion\",150,\"center\"],"
				+ "[\"fechaHoraInicio\",\"comun.fechaHoraInicio\",80,\"center\",false,true],"
				+ "[\"fechaHoraFin\",\"label.fechaHoraFinPrevista\",80,\"center\",false,true]]");


		if (!trabajos.isEmpty()) {
				nombreFichero = this.appMessageSource.getMessage("label.otrosTrabajos", null, locale);
		}
		JQGridRequestDto jqGridRequestDtoReport = new JQGridRequestDto(null, null, jqGridRequestDto.getSidx(),
				jqGridRequestDto.getSord());

		JQGridResponseDto<OtrosTrabajos> respuestaTrabajos = new JQGridResponseDto<OtrosTrabajos>(jqGridRequestDtoReport, (long) trabajos.size(), trabajos);
		ExcelModel libroTrabajos = this.excelReportService.getExcelModel(null, columns.toString(), respuestaTrabajos.getRows(), locale, this.appMessageSource.getMessage("label.otrosTrabajos", null, locale).toUpperCase(), nombreFichero);

		JQGridResponseDto<TareasTrabajo> respuestaTarea = new JQGridResponseDto<TareasTrabajo>(jqGridRequestDtoReport, (long) tareas.size(), tareas);
		ExcelModel libroTareas = this.excelReportService.getExcelModel(null, columnsTareas.toString(), respuestaTarea.getRows(), locale, this.appMessageSource.getMessage("label.tareas", null, locale).toUpperCase(), nombreFichero);

		libroTrabajos.getListaHojas().add(libroTareas.getListaHojas().get(0));


		this.excelReportService.generarExcel("printExcel", libroTrabajos, response);
	}




}
