package com.ejie.aa79b.control;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Locale;
import java.util.Properties;

import javax.servlet.http.HttpServletRequest;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.i18n.LocaleContextHolder;
import org.springframework.context.support.ReloadableResourceBundleMessageSource;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Controller;
import org.springframework.ui.ModelMap;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.ResponseStatus;
import org.springframework.web.servlet.ModelAndView;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.model.EntidadesLote;
import com.ejie.aa79b.model.Expediente;
import com.ejie.aa79b.model.Lotes;
import com.ejie.aa79b.service.LotesService;
import com.ejie.x38.control.bind.annotation.RequestJsonBody;
import com.ejie.x38.dto.JQGridRequestDto;
import com.ejie.x38.dto.JQGridResponseDto;

/**
 * LotesController generated by UDA, 27-nov-2017 12:26:24.
 *
 * @author UDA
 */

@Controller()
@RequestMapping(value = "/lotes")

public class LotesController {

	private static final Logger LOGGER = LoggerFactory.getLogger(LotesController.class);

	@Autowired()
	private Properties appConfiguration;

	@Autowired()
	private LotesService lotesService;

	@Autowired()
	private ReloadableResourceBundleMessageSource appMessageSource;

	/*
	 * OPERACIONES CRUD (Create, Read, Update, Delete)
	 *
	 */

	/**
	 * Operacion CRUD Read. Devuelve el bean correspondiente al identificador
	 * indicado.
	 *
	 * @param idLote
	 *            Integer
	 * @return Lotes Objeto correspondiente al identificador indicado.
	 */
	@RequestMapping(value = "/{idLote}", method = RequestMethod.GET)
	public @ResponseBody() Lotes get(@PathVariable() Integer idLote) {
		Lotes lotes = new Lotes();
		lotes.setIdLote(idLote);
		lotes = this.lotesService.find(lotes);
		LotesController.LOGGER.info("[GET - findBy_PK] : Obtener Lotes por PK");
		return lotes;
	}

	/**
	 * Devuelve una lista de beans correspondientes a los valores de filtrados
	 * indicados en el objeto pasado como parametro.
	 *
	 * @param filterLotes
	 *            Lotes Objeto que contiene los parametros de filtrado
	 *            utilizados en la busqueda.
	 * @return List<Lotes> Lista de objetos correspondientes a la busqueda
	 *         realizada.
	 */
	@RequestMapping(method = RequestMethod.GET)
	public @ResponseBody() List<Lotes> getAll(@ModelAttribute() Lotes filterLotes) {
		LotesController.LOGGER.info("[GET - find_ALL] : Obtener Lotes por filtro");
		return this.lotesService.findAll(filterLotes, null);
	}

	/**
	 * Operacion CRUD Edit. Modificacion del bean indicado.
	 *
	 * @param lotes
	 *            Lotes Bean que contiene la informacion a modificar.
	 * @return Lotes Bean resultante de la modificacion.
	 */
	@RequestMapping(method = RequestMethod.PUT)
	public @ResponseBody() Lotes edit(@RequestBody() Lotes lotes) {
		Lotes lotesAux = this.lotesService.update(lotes);
		LotesController.LOGGER.info("[PUT] : Lotes actualizado correctamente");
		return lotesAux;
	}

	/**
	 * Operacion CRUD Create. Creacion de un nuevo registro a partir del bean
	 * indicado.
	 *
	 * @param lotes
	 *            Lotes Bean que contiene la informacion con la que se va a
	 *            crear el nuevo registro.
	 * @return Lotes Bean resultante del proceso de creacion.
	 */
	@RequestMapping(method = RequestMethod.POST)
	public @ResponseBody() Lotes add(@RequestBody() Lotes lotes) {
		Lotes lotesAux;
		if (lotes.getIdLote() != null) {
			lotesAux = this.lotesService.update(lotes);
			LotesController.LOGGER.info("[POST] : Lotes actualizado correctamente");
		} else {
			lotesAux = this.lotesService.add(lotes);
			LotesController.LOGGER.info("[POST] : Lotes insertado correctamente");
		}
		return lotesAux;
	}

	/**
	 * Operacion CRUD Delete. Borrado del registro correspondiente al
	 * identificador especificado.
	 *
	 * @param idLote
	 *            Integer Identificador del objeto que se desea eliminar.
	 * @return Lotes Bean eliminado.
	 */
	@RequestMapping(value = "/{idLote}", method = RequestMethod.DELETE)
	@ResponseStatus(value = HttpStatus.OK)
	public @ResponseBody() Lotes remove(@PathVariable() Integer idLote) {
		Lotes lotes = new Lotes();
		lotes.setIdLote(idLote);
		this.lotesService.remove(lotes);
		LotesController.LOGGER.info("[DELETE] : Lotes borrado correctamente");
		return lotes;
	}

	/*
	 * METODOS COMPONENTE RUP_TABLE
	 *
	 */

	/**
	 * Operacion de filtrado del componente RUP_TABLE.
	 *
	 * @param filterLotes
	 *            Lotes Bean que contiene los parametros de filtrado a emplear.
	 * @param jqGridRequestDto
	 *            Dto que contiene los parametros de configuracion propios del
	 *            RUP_TABLE a aplicar en el filtrado.
	 * @return JQGridResponseDto<Lotes> Dto que contiene el resultado del
	 *         filtrado realizado por el componente RUP_TABLE.
	 */
	@RequestMapping(value = "/filter", method = RequestMethod.POST)
	public @ResponseBody() JQGridResponseDto<Lotes> filter(@RequestJsonBody(param = "filter") Lotes filterLotes,
			@RequestJsonBody JQGridRequestDto jqGridRequestDto) {
		LotesController.LOGGER.info("[POST - filter] : Obtener Lotes");
		return this.lotesService.filter(filterLotes, jqGridRequestDto, false);
	}

	/**
	 * Operación de X38 para la obtención de un informe de tipo pdf
	 *
	 * @param idLote
	 *            El id del lote seleccionado
	 * @param modelMap
	 *            El modelo
	 * @param locale
	 *            La locale
	 * @param request
	 *            La request
	 * @return La vista configurada en reports-config.xml y el modelo
	 *         actualizado
	 */
	@RequestMapping(value = "generarPdf/{idLote}")
	public ModelAndView generarPDFJasperReport(@PathVariable Integer idLote, ModelMap modelMap, Locale locale,
			HttpServletRequest request) {

		Lotes lotes = new Lotes();
		lotes.setIdLote(idLote);
		lotes = this.lotesService.generarPdf(lotes, locale);
		List<Lotes> lDatos = new ArrayList<Lotes>();

		// Nombre del fichero
		modelMap.put("fileName", this.appMessageSource.getMessage("menu.lotes", null, locale));
		modelMap.put("STATICS", this.appConfiguration.getProperty("datos.path"));
		modelMap.put("REPORT_LOCALE", new Locale(Constants.LANG_CASTELLANO, (Constants.LANG_CASTELLANO).toUpperCase()));
		// Cabecera y títulos comunes
		modelMap.put("TITULO", this.appMessageSource.getMessage("menu.lotes", null, locale));

		modelMap.put("EMPRESA_FIELDSET", this.appMessageSource.getMessage("label.empresa", null, locale));
		modelMap.put("EMPRESA_CIF", this.appMessageSource.getMessage("label.cif", null, locale));
		modelMap.put("EMPRESA_EMPRESA", this.appMessageSource.getMessage("label.empresa", null, locale));

		modelMap.put("LOTE_FIELDSET", this.appMessageSource.getMessage("label.lote", null, locale));
		modelMap.put("LOTE_NOMBRE", this.appMessageSource.getMessage("label.nombre", null, locale));
		modelMap.put("LOTE_DESCRIPCIONEUS", this.appMessageSource.getMessage("comun.descripcionEus", null, locale));
		modelMap.put("LOTE_DESCRIPCIONES", this.appMessageSource.getMessage("comun.descripcionEs", null, locale));
		modelMap.put("LOTE_VIGENCIA", this.appMessageSource.getMessage("label.vigencia", null, locale));
		modelMap.put("LOTE_DESDE", this.appMessageSource.getMessage("label.desde", null, locale));
		modelMap.put("LOTE_HASTA", this.appMessageSource.getMessage("label.hasta", null, locale));
		modelMap.put("LOTE_CONTACTO", this.appMessageSource.getMessage("label.contacto", null, locale));
		modelMap.put("LOTE_IMPORTEASIGNADO", this.appMessageSource.getMessage("label.importeAsignado", null, locale));
		modelMap.put("LOTE_IMPORTECONSUMIDO", this.appMessageSource.getMessage("label.importeConsumido", null, locale));
		modelMap.put("LOTE_IMPORTEPREVISTO", this.appMessageSource.getMessage("label.importePrevisto", null, locale));
		modelMap.put("LOTE_IMPORTERESTANTE",
				this.appMessageSource.getMessage("label.importeTotalRestante", null, locale));
		modelMap.put("LOTE_IMPORTEDISPONIBLE",
				this.appMessageSource.getMessage("label.importeDisponible", null, locale));
		modelMap.put("LOTE_IDIOMADESTINO", this.appMessageSource.getMessage("label.idiomaDestino", null, locale));
		modelMap.put("LOTE_IMPORTEPALABRA", this.appMessageSource.getMessage("label.importePalabra", null, locale));
		modelMap.put("LOTE_PORCENTAJEPALABRA",
				this.appMessageSource.getMessage("label.porcentajePalabra", null, locale));
		modelMap.put("LOTE_PORCENTAJE8594", this.appMessageSource.getMessage("label.8594por", null, locale));
		modelMap.put("LOTE_PORCENTAJE95100", this.appMessageSource.getMessage("label.95100por", null, locale));
		modelMap.put("LOTE_PORCENTAJETAREAREV", this.appMessageSource.getMessage("label.porTarea", null, locale));
		modelMap.put("LOTE_RECARGOFORMATO", this.appMessageSource.getMessage("label.recargoFormato", null, locale));
		modelMap.put("LOTE_RECARGOAPREMIO", this.appMessageSource.getMessage("label.recargoApremio", null, locale));
		modelMap.put("LOTE_PORCENTAJERECARGOAPREMIO",
				this.appMessageSource.getMessage("label.porcentaje", null, locale));
		modelMap.put("LOTE_PENALIZACIONRETRASO",
				this.appMessageSource.getMessage("label.penalizacionRetraso", null, locale));
		modelMap.put("LOTE_PORCENTAJEMAXPENALIZACION",
				this.appMessageSource.getMessage("label.porcentajeMax", null, locale));
		modelMap.put("LOTE_RESOLUCIONEXP", this.appMessageSource.getMessage("label.resolucionExpLote", null, locale));
		modelMap.put("LOTE_IMPORTESIVAINCLUIDO",
				this.appMessageSource.getMessage("label.importesIvaIncluidoPDF", null, locale));

		modelMap.put("SI", this.appMessageSource.getMessage("gestion.si", null, locale));
		modelMap.put("NO", this.appMessageSource.getMessage("gestion.no", null, locale));
		modelMap.put("POR_HORAS", this.appMessageSource.getMessage("label.porHoras", null, locale));
		modelMap.put("POR_JORNADAS", this.appMessageSource.getMessage("label.porJornadas", null, locale));

		// Datos (field)
		lDatos.add(lotes);
		modelMap.put("lDatos", lDatos);

		// Generación del PDF
		return new ModelAndView("pdfConfiguracionLotes", modelMap);
	}

	/**
	 * Lotes con tareas asignadas en expedientes en curso.
	 */

	@RequestMapping(value = "/lotesPorExpedientePlanificacion", method = RequestMethod.GET)
	public @ResponseBody() List<Lotes> getLotesExpedientePlanificacion() {
		LotesController.LOGGER.info("[GET - find_ALL] : Obtener Lotes con tareas asignadas en expedientes en curso.");
		Lotes lotes = new Lotes();
		return this.lotesService.getLotesExpedientePlanificacion(lotes, null);
	}

	/**
	 * Operacion CRUD Read. Devuelve el bean correspondiente al identificador
	 * indicado.
	 *
	 * @param lotes
	 *            Lotes
	 * @return JQGridResponseDto<Lotes> Objeto correspondiente al identificador
	 *         indicado.
	 */
	@RequestMapping(value = "/filterLotesVigentesExp/filter", method = RequestMethod.POST)
	public @ResponseBody JQGridResponseDto<Lotes> filterLotesVigentesExp(
			@RequestJsonBody(param = "filter") Expediente expediente,
			@RequestJsonBody JQGridRequestDto jqGridRequestDto) {
		LotesController.LOGGER.info("[GET - filterLotesVigentes] : Obtener lotes vigentes para un expediente");
		return this.lotesService.filterLotesVigentesExp(expediente, jqGridRequestDto, false);
	}

	@RequestMapping(value = "/getLotesNoPagados", method = RequestMethod.GET)
	public @ResponseBody List<Lotes> getLotes(@RequestParam("codEntidad") Long codEmpresa) {
		return this.lotesService.getLotesNoPagados(codEmpresa, Constants.UNO);
	}

	@RequestMapping(value = "/getLotesEmpresaAgrupadosPorActivo", method = RequestMethod.GET)
	public @ResponseBody List<HashMap<String, List<Lotes>>> getLotesEmpresaAgrupadosPorActivo(
			@RequestParam("codEntidad") Long codEmpresa) {
		//TODO adaptar con tipo e id entidad
		return this.obtenerDatosLotes(codEmpresa);
	}

	@RequestMapping(value = "/getLotesEmpresaAgrupadosPorActivoParamEmpresa/{tipo}/{codigo}", method = RequestMethod.GET)
	public @ResponseBody List<HashMap<String, List<Lotes>>> getLotesEmpresaAgrupadosPorActivoParamEmpresa(
			@PathVariable String tipo, @PathVariable Integer codigo) {
		return this.obtenerDatosLotes(tipo,codigo);
	}

	@RequestMapping(value = "/getLoteDefectoExp/{anyo}/{numExp}", method = RequestMethod.GET)
	public @ResponseBody() EntidadesLote getLoteExpedienteDefecto(@PathVariable Long anyo, @PathVariable Integer numExp) {
		return this.lotesService.getLoteExpedienteDefecto(anyo, numExp);
	}

	/**
	 * obtener lotes por tipo e id de entidad
	 * @param tipo String
	 * @param codigo Integer
	 * @return List<HashMap<String, List<Lotes>>>
	 */
	private List<HashMap<String, List<Lotes>>> obtenerDatosLotes(String tipo, Integer codigo) {
		List<Lotes> lista = this.lotesService.getLotesNoPagados(tipo,codigo, Constants.DOS);

		List<HashMap<String, List<Lotes>>> retorno = new ArrayList<HashMap<String, List<Lotes>>>();

		HashMap<String, List<Lotes>> group1 = new HashMap<String, List<Lotes>>();
		HashMap<String, List<Lotes>> group2 = new HashMap<String, List<Lotes>>();

		List<Lotes> listaLotes1 = new ArrayList<Lotes>();
		List<Lotes> listaLotes2 = new ArrayList<Lotes>();
		for (Lotes lote : lista) {
			if (lote.getActivo() == 1) {
				listaLotes1.add(lote);
			} else {
				listaLotes2.add(lote);
			}
		}

		Locale locale = LocaleContextHolder.getLocale();

		String descActivo = this.appMessageSource.getMessage("label.activo", null, locale);
		String descInactivo = this.appMessageSource.getMessage("label.inactivo", null, locale);

		group1.put(descActivo, listaLotes1);
		group2.put(descInactivo, listaLotes2);

		retorno.add(group1);
		retorno.add(group2);

		return retorno;
	}

	@RequestMapping(value = "/getLotesEntidad", method = RequestMethod.GET)
	public @ResponseBody List<HashMap<String, List<Lotes>>> getLotesEntidad(
			@RequestParam("lotes.empresasProveedoras.codigo") Long codEmpresa) {
		return this.obtenerDatosLotes(codEmpresa);
	}

	/**
	 *
	 * @param codEmpresa
	 * @return
	 */
	private List<HashMap<String, List<Lotes>>> obtenerDatosLotes(Long codEmpresa) {
		List<Lotes> lista = this.lotesService.getLotesNoPagados(codEmpresa, Constants.DOS);

		List<HashMap<String, List<Lotes>>> retorno = new ArrayList<HashMap<String, List<Lotes>>>();

		HashMap<String, List<Lotes>> group1 = new HashMap<String, List<Lotes>>();
		HashMap<String, List<Lotes>> group2 = new HashMap<String, List<Lotes>>();

		List<Lotes> listaLotes1 = new ArrayList<Lotes>();
		List<Lotes> listaLotes2 = new ArrayList<Lotes>();
		for (Lotes lote : lista) {
			if (lote.getActivo() == 1) {
				listaLotes1.add(lote);
			} else {
				listaLotes2.add(lote);
			}
		}

		Locale locale = LocaleContextHolder.getLocale();

		String descActivo = this.appMessageSource.getMessage("label.activo", null, locale);
		String descInactivo = this.appMessageSource.getMessage("label.inactivo", null, locale);

		group1.put(descActivo, listaLotes1);
		group2.put(descInactivo, listaLotes2);

		retorno.add(group1);
		retorno.add(group2);

		return retorno;
	}
}
