package com.ejie.aa79b.control;

import java.math.BigDecimal;
import java.text.NumberFormat;
import java.util.List;
import java.util.Locale;

import javax.servlet.http.HttpServletResponse;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.propertyeditors.CustomNumberEditor;
import org.springframework.context.i18n.LocaleContextHolder;
import org.springframework.context.support.ReloadableResourceBundleMessageSource;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.WebDataBinder;
import org.springframework.web.bind.annotation.InitBinder;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.common.formatter.Aa79BFormatMoneda;
import com.ejie.aa79b.model.Albaran;
import com.ejie.aa79b.model.DatosPagoProveedores;
import com.ejie.aa79b.model.Lotes;
import com.ejie.aa79b.model.Pagamentos;
import com.ejie.aa79b.service.ExcelReportService;
import com.ejie.aa79b.service.LotesService;
import com.ejie.aa79b.service.PagamentosService;
import com.ejie.aa79b.service.PdfReportService;
import com.ejie.x38.control.bind.annotation.RequestJsonBody;
import com.ejie.x38.dto.JQGridRequestDto;
import com.ejie.x38.dto.JQGridResponseDto;

/**
 * PagamentosController generated by UDA, 19/out/2018 10:01:21.
 * 
 * @author UDA
 */

@Controller
@RequestMapping(value = "/tramitacionexpedientes/facturacionypagos/albaranes")

public class AlbaranesConsultaController {

	private static final Logger LOGGER = LoggerFactory.getLogger(AlbaranesConsultaController.class);

	@Autowired
	private PagamentosService pagamentosService;
	@Autowired
	private LotesService lotesService;
	@Autowired
	private ExcelReportService excelReportService;
	@Autowired
	private PdfReportService pdfReportService;
	@Autowired
	private ReloadableResourceBundleMessageSource appMessageSource;

	protected static final String MENU_ALBARANES = "menu.facturacion.albaranes";

	
	
	@InitBinder()
	void initBinder(WebDataBinder binder, Locale locale) {
				
		NumberFormat formatMoneda = new Aa79BFormatMoneda();
		
		CustomNumberEditor cNE = new CustomNumberEditor(Double.class, formatMoneda, true); 
		
		binder.registerCustomEditor(BigDecimal.class, "importeTotal", cNE);
		binder.registerCustomEditor(BigDecimal.class, "importeFactura", cNE);
		binder.registerCustomEditor(BigDecimal.class, "importeAsignado", cNE);
		binder.registerCustomEditor(BigDecimal.class, "importeConsumido", cNE);
		binder.registerCustomEditor(BigDecimal.class, "importePrevisto", cNE);
		binder.registerCustomEditor(BigDecimal.class, "importeDisponible", cNE);
	}
	
	@RequestMapping(value = "/maint", method = RequestMethod.GET)
	public String getFormEdit(Model model) {
		AlbaranesConsultaController.LOGGER.info("[GET - View] : pagamento");
		return "consultaalbaranes";
	}

	@RequestMapping(value = "/filter", method = RequestMethod.POST)
	public @ResponseBody JQGridResponseDto<Pagamentos> filter(
			@RequestJsonBody(param = "filter") Pagamentos filterPagamentos,
			@RequestJsonBody JQGridRequestDto jqGridRequestDto) {
		AlbaranesConsultaController.LOGGER.info("[POST - filter] : Obtener Albaranes");
		return this.pagamentosService.filter(filterPagamentos, jqGridRequestDto, false);
	}

	@RequestMapping(value = "/detalle", method = RequestMethod.POST)
	public String getDetalle(Model model, @RequestJsonBody() Pagamentos fact) {
		Pagamentos pagamentos = null;

		if (fact.getIdAlbaran() != null && Constants.CERO != fact.getIdAlbaran()) {
			pagamentos = this.pagamentosService.find(fact);
		} else {
			pagamentos = new Pagamentos();
			pagamentos.setIdAlbaran(fact.getIdAlbaran());
			pagamentos.setIdLote(fact.getIdLote());
		}
		model.addAttribute("pagamento", pagamentos);

		if (fact.getIdLote() != null) {
			Lotes elLote = new Lotes();
			elLote.setIdLote(fact.getIdLote());
			elLote = this.lotesService.find(elLote);
			model.addAttribute("lote", elLote);
		}

		return "consultaalbaranesdetalle";
	}

	/**
	 * Genera el excel del listado de Pagos a Proveedor...
	 * 
	 * @param columns
	 * @param criterios
	 * @param jqGridRequestDto
	 * @param filterPagamentos
	 * @param response
	 * @param locale
	 */
	@RequestMapping(value = "/xlsxReport", method = RequestMethod.POST)
	public void xlsxTabla(@RequestParam(value = "columns", required = false) String columns,
			@RequestParam(value = "criterios", required = false) String criterios,
			@ModelAttribute() JQGridRequestDto jqGridRequestDto, @ModelAttribute() Pagamentos filterPagamentos,
			HttpServletResponse response, Locale locale) {

		AlbaranesConsultaController.LOGGER.info("[POST - subm]: xlsxTabla ========================================");
		JQGridRequestDto jqGridRequestDtoReport = new JQGridRequestDto(null, null, jqGridRequestDto.getSidx(),
				jqGridRequestDto.getSord());

		JQGridResponseDto<Pagamentos> respuesta = this.pagamentosService.filter(filterPagamentos, jqGridRequestDtoReport,
				false);
		this.excelReportService.generarExcelJson("printExcel", response, criterios, columns, respuesta.getRows(), locale,
				MENU_ALBARANES, this.appMessageSource.getMessage(MENU_ALBARANES, null, locale));
	}

	/**
	 * Generacion de excel del detalle de albar√°n
	 * 
	 * @param columns
	 * @param criterios
	 * @param jqGridRequestDto
	 * @param filterDatosPagoProveedores
	 * @param response
	 * @param locale
	 */
	@RequestMapping(value = "/excelReportTareas", method = RequestMethod.POST)
	public void xlsxTablaDetalle(@RequestParam(value = "columns", required = false) String columns,
			@RequestParam(value = "criterios", required = false) String criterios,
			@ModelAttribute() JQGridRequestDto jqGridRequestDto, @ModelAttribute() Pagamentos filterPagamentos,
			HttpServletResponse response, Locale locale) {
		List<DatosPagoProveedores> tareas = this.pagamentosService.getTareasExcelDetalle(filterPagamentos);

		String nombreFichero = "";
		String criterios2 = "";

		StringBuilder columns2 = new StringBuilder("[[\"anyoNumExpConcatenado\",\"label.numexpediente\",150,\"right\"],"
				+ "[\"descTarea\",\"label.tarea\",150,\"\"]," + "[\"descTipTarea\",\"label.tiptarea\",150,\"left\"],"
				+ "[\"descBOPV\",\"label.bopv\",150,\"left\"],"
				+ "[\"idiomaDestino\",\"label.idiomaDestino\",150,\"left\"],"
				+ "[\"empresaProvedora\",\"label.empproveedora2\",150,\"left\"],"
				+ "[\"albaran.descLote\",\"label.lote\",150,\"\"]," + "[\"importePalAplic\",\"label.tarifaEPorPalabra\",150,\"right\",true,false],"
				+ "[\"importeBase\",\"label.impBase#label.euro\",150,\"right\",true,false],"
				+ "[\"importeTotal\",\"label.total#label.euro\",150,\"right\",true,false],"
				+ "[\"ivaAplic\",\"label.percIVA\",150,\"right\",true,false],"
				+ "[\"numPalConTramos\",\"label.numpalavras\",180,\"right\"],"
				+ "[\"importeRecargoFormato\",\"label.impRecargoFormato#label.euro\",150,\"right\",true,false],"
				+ "[\"importeRecargoApremio\",\"label.impRecargoPremio#label.euro\",150,\"right\",true,false],"
				+ "[\"importePenalizacion\",\"label.impPenalRetraso#label.euro\",100,\"right\",true,false],"
				+ "[\"importePenalCalidad\",\"label.impPenalCalidad#label.euro\",100,\"right\",true,false],"
				+ "[\"descIndAlbaran\",\"label.indalbaran\",150,\"center\"]]");

		if (!tareas.isEmpty()) {
			if (tareas.get(0).getAlbaran().getIdAlbaran() != null) {
				criterios2 = "[[\"label.refalbaran\",\"" + tareas.get(0).getAlbaran().getRefAlbaran()
						+ "\"],[\"label.fecha\",\"" + tareas.get(0).getAlbaran().getFechaAltaFormateada() + "\"]]";
				columns2.append(",[\"albaran.refAlbaran\",\"label.refalbaran\",150,\"left\"],"
						+ "[\"albaran.descEstado\",\"label.estadoAlbaran\",150,\"left\"]]");
				nombreFichero = this.appMessageSource.getMessage("label.detalle.proveedores", null, locale) + "-"
						+ tareas.get(0).getAlbaran().getRefAlbaran();

			} else {
				criterios2 = "[[\"label.refalbaran\",\""
						+ this.appMessageSource.getMessage("label.pendientealbaran", null, locale) + "\"]]";
				columns2.append("]");
				nombreFichero = this.appMessageSource.getMessage("label.pendientealbaran", null, locale);
			}

		}
		JQGridRequestDto jqGridRequestDtoReport = new JQGridRequestDto(null, null, jqGridRequestDto.getSidx(),
				jqGridRequestDto.getSord());
		
		
		JQGridResponseDto<DatosPagoProveedores> respuesta = new JQGridResponseDto<DatosPagoProveedores>(jqGridRequestDtoReport, (long) tareas.size(), tareas);
		this.excelReportService.generarExcelJson("printExcel", response, criterios2, columns2.toString(), respuesta.getRows(), locale,
				this.appMessageSource.getMessage("label.detalle.proveedores", null, locale).toUpperCase(),
				nombreFichero);
	}

	/**
	 * 
	 * @param columns
	 * @param criterios
	 * @param response
	 * @param jqGridRequestDto
	 * @param filterPagamentos
	 */
	@RequestMapping(value = "/pdfReport", method = RequestMethod.POST)
	public void pdfTabla(@RequestParam(value = "columns", required = false) String columns,
			@RequestParam(value = "criterios", required = false) String criterios, HttpServletResponse response,
			@ModelAttribute() JQGridRequestDto jqGridRequestDto, @ModelAttribute() Pagamentos filterPagamentos) {
		AlbaranesConsultaController.LOGGER.info("[POST - subm]: pdfTabla ========================================");
		Locale locale = LocaleContextHolder.getLocale();
		JQGridRequestDto jqGridRequestDtoReport = new JQGridRequestDto(null, null, jqGridRequestDto.getSidx(),
				jqGridRequestDto.getSord());
		JQGridResponseDto<Pagamentos> respuesta = this.pagamentosService.filter(filterPagamentos, jqGridRequestDtoReport,
				false);
		this.pdfReportService.generarPdfJson("defaultPDF", response, criterios, columns, respuesta.getRows(), MENU_ALBARANES, locale,
				this.appMessageSource.getMessage(MENU_ALBARANES, null, locale));
	}

	@RequestMapping(value = "/tareasdetalle/filter", method = RequestMethod.POST)
	public @ResponseBody JQGridResponseDto<DatosPagoProveedores> tareas(
			@RequestJsonBody(param = "filter") Pagamentos filterPagamentos,
			@RequestJsonBody JQGridRequestDto jqGridRequestDto) {
		AlbaranesConsultaController.LOGGER.info("[POST - filter] : Obtener Pagamentoss");
		return this.pagamentosService.getTareasAlbaran(filterPagamentos, jqGridRequestDto, false);

	}

	@RequestMapping(value = "/getAlbaranesLoteNoPagado", method = RequestMethod.GET)
	public @ResponseBody() List<Albaran> getAlbaranesLoteNoPagado(@RequestParam("idLote") Integer idLote) {
		AlbaranesConsultaController.LOGGER.info("/getAlbaranesLoteNoPagado");
		return this.pagamentosService.getAlbaranesLote(idLote, Constants.UNO);
	}

	@RequestMapping(value = "/getAlbaranesLote", method = RequestMethod.GET)
	public @ResponseBody() List<Albaran> getAlbaranesLote(@RequestParam("idLote") Integer idLote) {
		AlbaranesConsultaController.LOGGER.info("/getAlbaranesLote");
		return this.pagamentosService.getAlbaranesLote(idLote, Constants.DOS);
	}

	@RequestMapping(value = "/consulta", method = RequestMethod.GET)
	public String getFormEdit(Model model, @RequestParam("idemp") Integer idEmp,
			@RequestParam("idlote") Integer idLote) {
		AlbaranesConsultaController.LOGGER.info("[GET - View] : consulta");

		model.addAttribute("idEmpConsultaExterna", idEmp);
		model.addAttribute("idLoteConsultaExterna", idLote);
		return "consultaalbaranes";
	}
}
