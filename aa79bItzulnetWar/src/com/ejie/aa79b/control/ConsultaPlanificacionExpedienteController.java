package com.ejie.aa79b.control;

import java.util.ArrayList;
import java.util.List;
import java.util.Locale;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.commons.lang.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.i18n.LocaleContextHolder;
import org.springframework.context.support.ReloadableResourceBundleMessageSource;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.model.Entidad;
import com.ejie.aa79b.model.EstadosExpediente;
import com.ejie.aa79b.model.ExpedientePlanificacion;
import com.ejie.aa79b.model.GestorExpediente;
import com.ejie.aa79b.model.PersonalIZO;
import com.ejie.aa79b.model.Tareas;
import com.ejie.aa79b.model.enums.EstadoExpedienteEnum;
import com.ejie.aa79b.model.enums.TipoExpedienteEnum;
import com.ejie.aa79b.model.enums.TipoRecursoEnum;
import com.ejie.aa79b.service.EstadosExpedienteService;
import com.ejie.aa79b.service.ExcelReportService;
import com.ejie.aa79b.service.ExpedienteService;
import com.ejie.aa79b.service.PdfReportService;
import com.ejie.aa79b.service.TareasGeneralService;
import com.ejie.x38.control.bind.annotation.RequestJsonBody;
import com.ejie.x38.dto.JQGridRequestDto;
import com.ejie.x38.dto.JQGridResponseDto;

/**
 * 
 * RegistroAccionesController generated by UDA, 05-dic-2017 12:40:39.
 * 
 * @author UDA
 */

@Controller
@RequestMapping(value = "/consultaplanificacionexpediente")

public class ConsultaPlanificacionExpedienteController {

	private static final Logger LOGGER = LoggerFactory.getLogger(ConsultaPlanificacionExpedienteController.class);

	@Autowired
	private EstadosExpedienteService estadosExpedienteService;
	@Autowired
	private ExpedienteService expedienteService;
	@Autowired
	private TareasGeneralService tareasGeneralService;
	@Autowired()
	private ReloadableResourceBundleMessageSource appMessageSource;
	@Autowired
	private ExcelReportService aa79bExcelReportService;
	@Autowired()
	private PdfReportService aa79bPdfReportService;

	private static final String LITERAL_LABEL = "menu.consultaPlanificacionExpedientes";

	/*
	 * METODOS COMPONENTE RUP_TABLE
	 * 
	 */

	@RequestMapping(value = "/desglosetareasconsultaplanif/maint", method = RequestMethod.GET)
	public String getDesgloseTareas() {
		ConsultaPlanificacionExpedienteController.LOGGER.info("[GET - View] : desglosetareasconsultaplanif");
		return "desglosetareasconsultaplanif";
	}

	@RequestMapping(value = "/getEstadosExpediente", method = RequestMethod.GET)
	public @ResponseBody List<EstadosExpediente> getAll(@ModelAttribute EstadosExpediente filterEstadosExpediente) {
		ConsultaPlanificacionExpedienteController.LOGGER.info("[GET - find_ALL] : Obtener Estados Expediente");
		List<Integer> listaEstados = new ArrayList<Integer>();
		listaEstados.add(EstadoExpedienteEnum.EN_CURSO.getValue());
		listaEstados.add(EstadoExpedienteEnum.RECHAZADO.getValue());
		listaEstados.add(EstadoExpedienteEnum.ANULADO.getValue());
		listaEstados.add(EstadoExpedienteEnum.CERRADO.getValue());
		listaEstados.add(EstadoExpedienteEnum.FINALIZADO.getValue());

		List<EstadosExpediente> listaResult = this.estadosExpedienteService.getEstados(listaEstados);
		if(listaResult!=null){
			Locale es = new Locale(Constants.LANG_CASTELLANO);
			Locale eu = new Locale(Constants.LANG_EUSKERA);
			EstadosExpediente estadoEliminado = new EstadosExpediente(Constants.CEROLONG);
			estadoEliminado.setDescEs(this.appMessageSource.getMessage("label.eliminado", new Object[] {}, es));
			estadoEliminado.setDescEu(this.appMessageSource.getMessage("label.eliminado", new Object[] {}, eu));
			listaResult.add(estadoEliminado);
		}
		
		return listaResult;
	}

	@RequestMapping(value = "/comboAsignadoa/{tareaAsigA}/{idTipoExp}", method = RequestMethod.GET)
	public @ResponseBody Object getEnlazadoComarca(@PathVariable String tareaAsigA, @PathVariable String idTipoExp) {
		ConsultaPlanificacionExpedienteController.LOGGER
				.info("[GET - find_ALL] : Obtener personas asignables por filtro");
		Tareas tareaFilter = new Tareas();
		if (!tareaAsigA.equals(Constants.MINUS_UNO.toString())) {
			return getPersonalPorRecurso(tareaAsigA, idTipoExp, tareaFilter);
		} else {
			return new ArrayList<PersonalIZO>();
		}
	}

	private List<?> getPersonalPorRecurso(String tareaAsigA, String idTipoExp, Tareas tareaFilter) {
		if (tareaAsigA.equals(TipoRecursoEnum.INTERNO.getValue())) {
			tareaFilter.setRecursoAsignacion(TipoRecursoEnum.INTERNO.getValue());
			return this.tareasGeneralService.findPersonasPorRecursoAsignacion(tareaFilter, idTipoExp);
		} else {
			if (idTipoExp.equals(TipoExpedienteEnum.INTERPRETACION.getValue())) {
				tareaFilter.setRecursoAsignacion(TipoRecursoEnum.EXTERNO.getValue());
				return this.tareasGeneralService.findPersonasPorRecursoAsignacion(tareaFilter, idTipoExp);
			} else {
				tareaFilter.setRecursoAsignacion(TipoRecursoEnum.EXTERNO.getValue());
				return this.tareasGeneralService.findProveedoresPorRecursoAsignacion(tareaFilter, idTipoExp);
			}
		}
	}

	/**
	 * Operacion de filtrado del componente RUP_TABLE.
	 * 
	 * @param filterRegistroAcciones
	 *            RegistroAcciones Bean que contiene los parametros de filtrado
	 *            a emplear.
	 * @param jqGridRequestDto
	 *            Dto que contiene los parametros de configuracion propios del
	 *            RUP_TABLE a aplicar en el filtrado.
	 * @return JQGridResponseDto<RegistroAcciones> Dto que contiene el resultado
	 *         del filtrado realizado por el componente RUP_TABLE.
	 */
	@RequestMapping(value = "/filter", method = RequestMethod.POST)
	public @ResponseBody JQGridResponseDto<ExpedientePlanificacion> filter(
			@RequestJsonBody(param = "filter") ExpedientePlanificacion filterExpedientePlanificacion,
			@RequestJsonBody JQGridRequestDto jqGridRequestDto) {
		ConsultaPlanificacionExpedienteController.LOGGER.info("[POST - filter] : Obtener ExpedientePlanificacion");
		if(filterExpedientePlanificacion!=null && filterExpedientePlanificacion.getFilterTarea()!=null 
				&& filterExpedientePlanificacion.getFilterTarea().getRecursoAsignacion()!=null
				&& this.esRecursoExternoYTradRev(filterExpedientePlanificacion)){
			//si selecciona recurso externo y entidad y tipo expediente trad o rev modificamos campos filtro para la busqueda
			String[] aux = StringUtils.split(filterExpedientePlanificacion.getFilterTarea().getPersIzoAsignTarea(), "_");
			GestorExpediente gestor = new GestorExpediente();
			Entidad entidad = new Entidad();
			if (aux.length == 2) {
				Integer i = 0;
				entidad.setTipo(aux[i++]);
				entidad.setCodigo(Integer.parseInt(aux[i++]));
			}
			gestor.setEntidad(entidad);
			filterExpedientePlanificacion.setGestorExpediente(gestor);
			filterExpedientePlanificacion.getFilterTarea().setPersIzoAsignTarea(null);
		}
		return this.expedienteService.consultaPlanificacionExpediente(filterExpedientePlanificacion, jqGridRequestDto,
				false);
	}

	public boolean esRecursoExternoYTradRev(ExpedientePlanificacion filterExpedientePlanificacion) {
		return !TipoExpedienteEnum.INTERPRETACION.equals(filterExpedientePlanificacion.getIdTipoExpediente()) 
				&& TipoRecursoEnum.EXTERNO.getValue().equals(filterExpedientePlanificacion.getFilterTarea().getRecursoAsignacion())
				&& filterExpedientePlanificacion.getFilterTarea().getPersIzoAsignTarea()!=null;
	}

	@RequestMapping(value = "/xlsxReport", method = RequestMethod.POST)
	public void xlsxTabla(@RequestParam(value = "columns", required = false) String columns,
			@RequestParam(value = "criterios", required = false) String criterios,
			@ModelAttribute() JQGridRequestDto jqGridRequestDto,
			@ModelAttribute() ExpedientePlanificacion filterExpedientePlanificacion, HttpServletRequest request,
			HttpServletResponse response, Model model) {
		ConsultaPlanificacionExpedienteController.LOGGER
				.info("[POST - subm]: xlsxTabla ========================================");
		Locale locale = LocaleContextHolder.getLocale();
		JQGridRequestDto jqGridRequestDtoReport = new JQGridRequestDto(null, null, jqGridRequestDto.getSidx(),
				jqGridRequestDto.getSord());
		JQGridResponseDto<ExpedientePlanificacion> respuesta = this.expedienteService
				.consultaPlanificacionExpediente(filterExpedientePlanificacion, jqGridRequestDtoReport, false);

		final String label = this.appMessageSource.getMessage(LITERAL_LABEL, new Object[] {}, locale);

		this.aa79bExcelReportService.generarExcelJson("printExcel", response, criterios, columns, respuesta.getRows(),
				locale, LITERAL_LABEL, label);
	}

	@RequestMapping(value = "/pdfReport", method = RequestMethod.POST)
	public void pdfTabla(@RequestParam(value = "columns", required = false) String columns,
			@RequestParam(value = "criterios", required = false) String criterios, HttpServletRequest request,
			HttpServletResponse response, @ModelAttribute() JQGridRequestDto jqGridRequestDto,
			@ModelAttribute() ExpedientePlanificacion filterExpedientePlanificacion, Model model) {
		ConsultaPlanificacionExpedienteController.LOGGER
				.info("[POST - subm]: pdfTabla ========================================");

		JQGridRequestDto jqGridRequestDtoReport = new JQGridRequestDto(null, null, jqGridRequestDto.getSidx(),
				jqGridRequestDto.getSord());

		JQGridResponseDto<ExpedientePlanificacion> respuesta = this.expedienteService
				.consultaPlanificacionExpediente(filterExpedientePlanificacion, jqGridRequestDtoReport, false);

		Locale locale = LocaleContextHolder.getLocale();
		final String label = this.appMessageSource.getMessage(LITERAL_LABEL, new Object[] {}, locale);

		this.aa79bPdfReportService.generarPdfJson("defaultPDF", response, criterios, columns, respuesta.getRows(),
				LITERAL_LABEL, locale, label);
	}
	
	/**
	 * Operacion de obtencion de ids de elementos seleccionados de RUP_TABLE.
	 * 
	 * @param tableObjects
	 *           Map<String, Object>
	 * @return List<ExpedientePlanificacion>
	 */
	@RequestMapping(value = "/getSelectedIds", method = RequestMethod.POST)
	public @ResponseBody List<ExpedientePlanificacion> getSelectedIds(
			@RequestJsonBody(param = "filterObject") ExpedientePlanificacion filterExpedientePlanificacion,
			@RequestJsonBody(param = "tableData") JQGridRequestDto tableData){
		ConsultaPlanificacionExpedienteController.LOGGER.info("[POST - filter] : getSelectedIds");
		if(filterExpedientePlanificacion!=null && filterExpedientePlanificacion.getFilterTarea()!=null 
				&& filterExpedientePlanificacion.getFilterTarea().getRecursoAsignacion()!=null
				&& this.esRecursoExternoYTradRev(filterExpedientePlanificacion)){
			//si selecciona recurso externo y entidad y tipo expediente trad o rev modificamos campos filtro para la busqueda
			String[] aux = StringUtils.split(filterExpedientePlanificacion.getFilterTarea().getPersIzoAsignTarea(), "_");
			GestorExpediente gestor = new GestorExpediente();
			Entidad entidad = new Entidad();
			if (aux.length == 2) {
				Integer i = 0;
				entidad.setTipo(aux[i++]);
				entidad.setCodigo(Integer.parseInt(aux[i++]));
			}
			gestor.setEntidad(entidad);
			filterExpedientePlanificacion.setGestorExpediente(gestor);
			filterExpedientePlanificacion.getFilterTarea().setPersIzoAsignTarea(null);
		}
		return this.expedienteService.consultaPlanificacionExpedienteGetSelectedIds(filterExpedientePlanificacion,tableData);
	}


}
