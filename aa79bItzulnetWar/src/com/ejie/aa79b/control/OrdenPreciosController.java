package com.ejie.aa79b.control;

import java.util.ArrayList;
import java.util.List;
import java.util.Locale;
import java.util.Properties;

import javax.servlet.http.HttpServletRequest;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.support.ReloadableResourceBundleMessageSource;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Controller;
import org.springframework.ui.ModelMap;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.ResponseStatus;
import org.springframework.web.servlet.ModelAndView;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.model.OrdenPrecios;
import com.ejie.aa79b.service.OrdenPreciosService;
import com.ejie.x38.control.bind.annotation.RequestJsonBody;
import com.ejie.x38.dto.JQGridRequestDto;
import com.ejie.x38.dto.JQGridResponseDto;
import com.ejie.x38.dto.TableRowDto;

/**
 * OrdenPreciosController generated by UDA, 15-dic-2017 14:11:46.
 * 
 * @author UDA
 */

@Controller
@RequestMapping(value = "/administracion/configuraciontarifas/ordenprecios")

public class OrdenPreciosController {

    private static final Logger LOGGER = LoggerFactory.getLogger(OrdenPreciosController.class);

    @Autowired()
    private Properties appConfiguration;

    @Autowired
    private OrdenPreciosService ordenPreciosService;

    @Autowired()
    private ReloadableResourceBundleMessageSource appMessageSource;

    /*
     * OPERACIONES CRUD (Create, Read, Update, Delete)
     * 
     */

    /**
     * Operacion CRUD Read. Devuelve el bean correspondiente al identificador
     * indicado.
     * 
     * @param id
     *            Long
     * @return OrdenPrecios Objeto correspondiente al identificador indicado.
     */
    @RequestMapping(value = "/{id}", method = RequestMethod.GET)
    public @ResponseBody OrdenPrecios get(@PathVariable Long id) {
        OrdenPrecios ordenPrecios = new OrdenPrecios();
        ordenPrecios.setId(id);
        ordenPrecios = this.ordenPreciosService.find(ordenPrecios);
        OrdenPreciosController.LOGGER.info("[GET - findBy_PK] : Obtener OrdenPrecios por PK");
        return ordenPrecios;
    }

    /**
     * Devuelve una lista de beans correspondientes a los valores de filtrados
     * indicados en el objeto pasado como parametro.
     *
     * @param filterOrdenPrecios
     *            OrdenPrecios Objeto que contiene los parametros de filtrado
     *            utilizados en la busqueda.
     * @return List<OrdenPrecios> Lista de objetos correspondientes a la
     *         busqueda realizada.
     */
    @RequestMapping(method = RequestMethod.GET)
    public @ResponseBody List<OrdenPrecios> getAll(@ModelAttribute OrdenPrecios filterOrdenPrecios) {
        OrdenPreciosController.LOGGER.info("[GET - find_ALL] : Obtener OrdenPrecios por filtro");
        return this.ordenPreciosService.findAll(filterOrdenPrecios, null);
    }

    /**
     * Operacion CRUD Edit. Modificacion del bean indicado.
     *
     * @param ordenPrecios
     *            OrdenPrecios Bean que contiene la informacion a modificar.
     * @return OrdenPrecios Bean resultante de la modificacion.
     */
    @RequestMapping(method = RequestMethod.PUT)
    public @ResponseBody OrdenPrecios edit(@RequestBody OrdenPrecios ordenPrecios) {
        OrdenPrecios ordenPreciosAux = this.ordenPreciosService.update(ordenPrecios);
        OrdenPreciosController.LOGGER.info("[PUT] : OrdenPrecios actualizado correctamente");
        return ordenPreciosAux;
    }

    /**
     * Operacion CRUD Create. Creacion de un nuevo registro a partir del bean
     * indicado.
     *
     * @param ordenPrecios
     *            OrdenPrecios Bean que contiene la informacion con la que se va
     *            a crear el nuevo registro.
     * @return OrdenPrecios Bean resultante del proceso de creacion.
     */
    @RequestMapping(method = RequestMethod.POST)
    public @ResponseBody OrdenPrecios add(@RequestBody OrdenPrecios ordenPrecios) {
        OrdenPrecios ordenPreciosAux = this.ordenPreciosService.add(ordenPrecios);
        OrdenPreciosController.LOGGER.info("[POST] : OrdenPrecios insertado correctamente");
        return ordenPreciosAux;
    }

    /**
     * Operacion CRUD Delete. Borrado del registro correspondiente al
     * identificador especificado.
     *
     * @param id
     *            Long Identificador del objeto que se desea eliminar.
     * @return OrdenPrecios Bean eliminado.
     */
    @RequestMapping(value = "/{id}", method = RequestMethod.DELETE)
    @ResponseStatus(value = HttpStatus.OK)
    public @ResponseBody OrdenPrecios remove(@PathVariable Long id) {
        OrdenPrecios ordenPrecios = new OrdenPrecios();
        ordenPrecios.setId(id);
        this.ordenPreciosService.remove(ordenPrecios);
        OrdenPreciosController.LOGGER.info("[DELETE] : OrdenPrecios borrado correctamente");
        return ordenPrecios;
    }

    /*
     * METODOS COMPONENTE RUP_TABLE
     * 
     */

    /**
     * Metodo de presentacion del RUP_TABLE.
     * 
     * @param model
     *            Model
     * @return String
     */
    @RequestMapping(value = "/maint", method = RequestMethod.GET)
    public String getFormEdit() {
        OrdenPreciosController.LOGGER.info("[GET - View] : ordenprecios");
        return "ordenprecios";
    }

    /**
     * Operacion de filtrado del componente RUP_TABLE.
     * 
     * @param filterOrdenPrecios
     *            OrdenPrecios Bean que contiene los parametros de filtrado a
     *            emplear.
     * @param jqGridRequestDto
     *            Dto que contiene los parametros de configuracion propios del
     *            RUP_TABLE a aplicar en el filtrado.
     * @return JQGridResponseDto<OrdenPrecios> Dto que contiene el resultado del
     *         filtrado realizado por el componente RUP_TABLE.
     */
    @RequestMapping(value = "/filter", method = RequestMethod.POST)
    public @ResponseBody JQGridResponseDto<OrdenPrecios> filter(
            @RequestJsonBody(param = "filter") OrdenPrecios filterOrdenPrecios,
            @RequestJsonBody JQGridRequestDto jqGridRequestDto) {
        OrdenPreciosController.LOGGER.info("[POST - filter] : Obtener OrdenPrecioss");
        return this.ordenPreciosService.filter(filterOrdenPrecios, jqGridRequestDto, false);
    }

    /**
     * Operacion de busqueda del componente RUP_TABLE.
     * 
     * @param filterOrdenPrecios
     *            OrdenPrecios Bean que contiene los parametros de filtrado a
     *            emplear.
     * @param searchOrdenPrecios
     *            OrdenPrecios Bean que contiene los parametros de busqueda a
     *            emplear.
     * @param jqGridRequestDto
     *            Dto que contiene los parametros de configuracion propios del
     *            RUP_TABLE a aplicar en la búsqueda.
     * @return TableRowDto<OrdenPrecios> Dto que contiene el resultado de la
     *         busqueda realizada por el componente RUP_TABLE.
     */
    @RequestMapping(value = "/search", method = RequestMethod.POST)
    public @ResponseBody List<TableRowDto<OrdenPrecios>> search(
            @RequestJsonBody(param = "filter") OrdenPrecios filterOrdenPrecios,
            @RequestJsonBody(param = "search") OrdenPrecios searchOrdenPrecios,
            @RequestJsonBody JQGridRequestDto jqGridRequestDto) {
        OrdenPreciosController.LOGGER.info("[POST - search] : Buscar OrdenPrecioss");
        return this.ordenPreciosService.search(filterOrdenPrecios, searchOrdenPrecios, jqGridRequestDto, false);
    }

    /**
     * Borrado multiple de registros
     * 
     * @param filterOrdenPrecios
     *            OrdenPrecios Bean que contiene los parametros de filtrado a
     *            emplear.
     * @param jqGridRequestDto
     *            Dto que contiene los parametros de configuracion propios del
     *            RUP_TABLE a aplicar en la busqueda.
     * @return List<String> Lista de los identificadores de los registros
     *         eliminados.
     * 
     */
    @RequestMapping(value = "/deleteAll", method = RequestMethod.POST)
    @ResponseStatus(value = HttpStatus.OK)
    public @ResponseBody List<String> removeMultiple(@RequestJsonBody(param = "filter") OrdenPrecios filterOrdenPrecios,
            @RequestJsonBody JQGridRequestDto jqGridRequestDto) {
        OrdenPreciosController.LOGGER
                .info("[POST - search] : [POST - removeMultiple] : Eliminar multiples OrdenPrecioss");
        this.ordenPreciosService.removeMultiple(filterOrdenPrecios, jqGridRequestDto, false);
        OrdenPreciosController.LOGGER.info("All entities correctly deleted!");

        return jqGridRequestDto.getMultiselection().getSelectedIds();
    }

    /**
     * 
     * @param idOrden
     *            Long
     * @return boolean
     */
    @RequestMapping(value = "/comprobarOrdenes", method = RequestMethod.POST)
    @ResponseStatus(value = HttpStatus.OK)
    public @ResponseBody boolean comprobarOrdenes(@RequestJsonBody Long idOrden) {
        OrdenPreciosController.LOGGER.info("[GET - comprobarOrdenes] : Comprobar ordenes");
        final OrdenPrecios ordenPrecios = new OrdenPrecios();
        ordenPrecios.setIndVigor(Constants.SI);
        ordenPrecios.setId(idOrden);
        return this.ordenPreciosService.comprobarOrdenes(ordenPrecios);
    }

    /**
     * Operación de X38 para la obtención de un informe de tipo pdf
     * 
     * @param modelMap
     *            El modelo
     * @param locale
     *            La locale
     * @param request
     *            La request
     * @return La vista configurada en reports-config.xml y el modelo
     *         actualizado
     */
    @RequestMapping(value = "generarPdf/{idOrden}")
    public ModelAndView generarPDFJasperReport(@PathVariable Long idOrden, ModelMap modelMap, Locale locale,
            HttpServletRequest request) {

        OrdenPrecios ordenPrecios = new OrdenPrecios(idOrden);
        ordenPrecios = this.ordenPreciosService.generarPdf(ordenPrecios);
        List<OrdenPrecios> lDatos = new ArrayList<OrdenPrecios>();

        // Nombre del fichero
        modelMap.put("fileName", this.appMessageSource.getMessage("menu.ordenPreciosPublicos", null, locale));
        modelMap.put("STATICS", this.appConfiguration.getProperty("datos.path"));
        modelMap.put("REPORT_LOCALE", new Locale(Constants.LANG_CASTELLANO, (Constants.LANG_CASTELLANO).toUpperCase()));
        // Cabecera y títulos comunes
        modelMap.put("TITULO", this.appMessageSource.getMessage("menu.ordenPreciosPublicos", null, locale));
        modelMap.put("DATOSGENERALES_FIELDSET", this.appMessageSource.getMessage("label.datosGenerales", null, locale));
        modelMap.put("DATOSGENERALES_TITULO", this.appMessageSource.getMessage("label.titulo", null, locale));
        modelMap.put("DATOSGENERALES_FECHAENTRADA",
                this.appMessageSource.getMessage("label.fechaEntrada", null, locale));

        modelMap.put("DATOSGENERALES_FECHASALIDA", this.appMessageSource.getMessage("label.fechaFin", null, locale));
        modelMap.put("DATOSGENERALES_URL", this.appMessageSource.getMessage("label.url", null, locale));

        modelMap.put("DATOSGENERALES_IVA", this.appMessageSource.getMessage("label.ivaYVigencia", null, locale));
        modelMap.put("IVA_IVA", this.appMessageSource.getMessage("label.iva", null, locale));
        modelMap.put("IVA_VIGENCIAIVA", this.appMessageSource.getMessage("label.vigenciaIva", null, locale));
        modelMap.put("IVA_ENVIGOR", this.appMessageSource.getMessage("label.enVigor", null, locale));
        modelMap.put("SI", this.appMessageSource.getMessage("gestion.si", null, locale));
        modelMap.put("NO", this.appMessageSource.getMessage("gestion.no", null, locale));
        modelMap.put("CTRAD_CUANTIA",
                this.appMessageSource.getMessage("label.cuantias.serviciosTraduccion", null, locale));
        modelMap.put("CREV_CUANTIA",
                this.appMessageSource.getMessage("label.cuantias.serviciosRevision", null, locale));
        modelMap.put("CUANTIA_RELEVANCIA", this.appMessageSource.getMessage("label.relevancia", null, locale));
        modelMap.put("CUANTIA_TARIFAESEU", this.appMessageSource.getMessage("label.tarifaEsEu", null, locale));
        modelMap.put("CUANTIA_TARIFAEUES", this.appMessageSource.getMessage("label.tarifaEuEs", null, locale));

        // Otros datos tarif
        modelMap.put("TIT_TARIFEXP", this.appMessageSource.getMessage("label.cuantias.tarifExpTradRev", null, locale));
        modelMap.put("TARIF_DIFICULTAD", this.appMessageSource.getMessage("label.recargoDificultad", null, locale));
        modelMap.put("TARIF_URGENCIA", this.appMessageSource.getMessage("label.recargoUrgencia", null, locale));
        modelMap.put("TARIF_PRECIOMIN", this.appMessageSource.getMessage("label.precioMinimo", null, locale));

        modelMap.put("TARIF_NUMPALABRAS", this.appMessageSource.getMessage("label.numPalabrasTarif", null, locale));
        modelMap.put("TARIF_PRECIOSTRAD",
                this.appMessageSource.getMessage("label.precioTraduccionesTramos", null, locale));
        modelMap.put("TARIF_%COINCI",
                this.appMessageSource.getMessage("label.porcentajePalabraCoincidencia", null, locale));
        modelMap.put("TARIF_95100", this.appMessageSource.getMessage("label.95100por", null, locale));
        modelMap.put("TARIF_8594", this.appMessageSource.getMessage("label.8594por", null, locale));
        modelMap.put("TARIF_84", this.appMessageSource.getMessage("label.85Menorpor", null, locale));
        // Serv interpretacion
        modelMap.put("TIT_CINTER",
                this.appMessageSource.getMessage("label.cuantias.serviciosInterpretacion", null, locale));
        modelMap.put("CINTER_PRECMININTERP", this.appMessageSource.getMessage("label.precioMinInterp", null, locale));
        modelMap.put("CINTER_ENCAE", this.appMessageSource.getMessage("label.encae", null, locale));
        modelMap.put("CINTER_NOENCAE", this.appMessageSource.getMessage("label.noencae", null, locale));
        modelMap.put("CINTER_CONGPLURI", this.appMessageSource.getMessage("label.congresosPluriling", null, locale));
        modelMap.put("CINTER_PRECJORNADA", this.appMessageSource.getMessage("label.precioJornada", null, locale));
        modelMap.put("CINTER_PRECMEDJORNADA", this.appMessageSource.getMessage("label.precioMedJornada", null, locale));
        modelMap.put("CINTER_PRECHORAOFRAC", this.appMessageSource.getMessage("label.precioHoraOFrac", null, locale));
        modelMap.put("CINTER_CONGNOPLURI",
                this.appMessageSource.getMessage("label.congresosPlurilingNoEus", null, locale));
        modelMap.put("CINTER_PARAMJORNADAS", this.appMessageSource.getMessage("label.paramJornadas", null, locale));
        modelMap.put("CINTER_JORNADACOMP", this.appMessageSource.getMessage("label.jornadaCompleta", null, locale));
        modelMap.put("CINTER_HORASDESDE", this.appMessageSource.getMessage("label.horasDesde", null, locale));
        modelMap.put("CINTER_HORASINCLUSIVE", this.appMessageSource.getMessage("label.horasInclusive", null, locale));
        modelMap.put("CINTER_MEDJORNADA", this.appMessageSource.getMessage("label.mediaJornada", null, locale));
        modelMap.put("CINTER_INTERPREUNION",
                this.appMessageSource.getMessage("label.interpretacionReunion", null, locale));
        modelMap.put("CINTER_EUROHORA", this.appMessageSource.getMessage("label.euroHora", null, locale));
        modelMap.put("CINTER_IVAINCLUIDO", this.appMessageSource.getMessage("label.ivaIncluidoPDF", null, locale));
        modelMap.put("Y", this.appMessageSource.getMessage("comun.y", null, locale));

        // Datos (field)
        lDatos.add(ordenPrecios);
        modelMap.put("lDatos", lDatos);

        // Generación del PDF
        return new ModelAndView("pdfOrdenPreciosPublicos", modelMap);
    }

}
