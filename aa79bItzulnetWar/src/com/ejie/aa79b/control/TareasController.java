package com.ejie.aa79b.control;

import java.io.InputStream;
import java.io.OutputStream;
import java.io.UnsupportedEncodingException;
import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.List;
import java.util.Locale;
import java.util.Properties;

import javax.servlet.http.HttpServletResponse;

import org.apache.commons.lang.StringUtils;
import org.codehaus.jackson.map.ObjectMapper;
import org.codehaus.jackson.type.TypeReference;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.ApplicationContext;
import org.springframework.context.support.ReloadableResourceBundleMessageSource;
import org.springframework.core.io.Resource;
import org.springframework.http.HttpStatus;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Controller;
import org.springframework.ui.ModelMap;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.ResponseStatus;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.common.JasperUtils;
import com.ejie.aa79b.model.DatosPagoProveedores;
import com.ejie.aa79b.model.DatosPersona;
import com.ejie.aa79b.model.DocPresupuestoTraduccion;
import com.ejie.aa79b.model.Entidad;
import com.ejie.aa79b.model.Expediente;
import com.ejie.aa79b.model.Fichero;
import com.ejie.aa79b.model.HorasEstimadas;
import com.ejie.aa79b.model.Lotes;
import com.ejie.aa79b.model.NivelesDeCalidad;
import com.ejie.aa79b.model.OrigenTareaNoConformidad;
import com.ejie.aa79b.model.OtrosTrabajos;
import com.ejie.aa79b.model.Persona;
import com.ejie.aa79b.model.PersonalIZO;
import com.ejie.aa79b.model.TareaIntPagoProveed;
import com.ejie.aa79b.model.Tareas;
import com.ejie.aa79b.model.TareasAsignado;
import com.ejie.aa79b.model.TareasGestionInterpretacion;
import com.ejie.aa79b.model.TareasTrabajo;
import com.ejie.aa79b.model.TiposTarea;
import com.ejie.aa79b.model.enums.FormatoInformeEnum;
import com.ejie.aa79b.model.enums.TipoExpedienteEnum;
import com.ejie.aa79b.model.enums.TipoTareaGestionAsociadaEnum;
import com.ejie.aa79b.model.excel.ExcelModel;
import com.ejie.aa79b.security.Usuario;
import com.ejie.aa79b.service.DatosPagoProveedoresService;
import com.ejie.aa79b.service.DatosPersonaService;
import com.ejie.aa79b.service.ExcelReportService;
import com.ejie.aa79b.service.LotesService;
import com.ejie.aa79b.service.NivelesDeCalidadService;
import com.ejie.aa79b.service.PersonalIZOService;
import com.ejie.aa79b.service.TareasService;
import com.ejie.aa79b.service.TareasTrabajoService;
import com.ejie.aa79b.utils.Utils;
import com.ejie.aa79b.webservices.PIDService;
import com.ejie.x38.control.bind.annotation.RequestJsonBody;
import com.ejie.x38.dto.JQGridRequestDto;
import com.ejie.x38.dto.JQGridResponseDto;

import net.sf.jasperreports.engine.JRException;
import net.sf.jasperreports.engine.JasperExportManager;
import net.sf.jasperreports.engine.JasperFillManager;
import net.sf.jasperreports.engine.JasperPrint;
import net.sf.jasperreports.engine.JasperReport;
import net.sf.jasperreports.engine.data.JRBeanCollectionDataSource;

/**
 * TipoRelevanciaController generated by UDA, 24-oct-2017 15:14:42.
 *
 * @author UDA
 */

@Controller
@RequestMapping(value = "/tramitacionexpedientes/planificacionCarga/tareas")
public class TareasController {
	@Autowired
	private LotesService lotesService;

	@Autowired
	private DatosPagoProveedoresService datosPagoProveedoresService;

	private static final Logger LOGGER = LoggerFactory.getLogger(TareasController.class);

	@Autowired
	private TareasService tareasService;

	@Autowired()
	private PersonalIZOService personalIZOService;

	@Autowired()
	private DatosPersonaService datosPersonaService;

	@Autowired()
	private ReloadableResourceBundleMessageSource appMessageSource;

	@Autowired()
	private Properties appConfiguration;

	@Autowired()
	private ApplicationContext ctx;

	@Autowired
	private ExcelReportService excelReportService;

	@Autowired()
	private PIDService pidService;

	@Autowired
    private NivelesDeCalidadService nivelesDeCalidadService;

	@Autowired
	private TareasTrabajoService tareasTrabajoService;


	/**
	 * Metodo de presentacion del RUP_TABLE.
	 *
	 * @param model
	 *            Model
	 * @return String
	 */
	@RequestMapping(value = "/maint", method = RequestMethod.GET)
	public String getFormEdit() {
		TareasController.LOGGER.info("[GET - View] : tareas");
		return "asignadoProveedores";
	}

	/**
	 * Devuelve una lista de beans correspondientes a los valores de filtrados
	 * indicados en el objeto pasado como parametro.
	 *
	 * @param filterTipoRelevancia
	 *            TipoRelevancia Objeto que contiene los parametros de filtrado
	 *            utilizados en la busqueda.
	 * @return List<TipoRelevancia> Lista de objetos correspondientes a la
	 *         busqueda realizada.
	 */
	@RequestMapping(method = RequestMethod.GET)
	public @ResponseBody List<Lotes> getAll(@ModelAttribute Lotes filterTipoRelevancia) {
		TareasController.LOGGER.info("[GET - find_ALL] : Obtener TipoRelevancia por filtro");
		return this.lotesService.findAll(filterTipoRelevancia, null);
	}

	@RequestMapping(value = "/filter", method = RequestMethod.POST)
	public @ResponseBody() JQGridResponseDto<Tareas> filter(@RequestJsonBody(param = "filter") Tareas filter,
			@RequestJsonBody() JQGridRequestDto jqGridRequestDto) {
		TareasController.LOGGER.info("[POST - filter] : Obtener Asignado Proveedor");
		return this.tareasService.filter(filter, jqGridRequestDto, false);

	}

	@RequestMapping(value = "/filtroAsignadoAproveedores/filter", method = RequestMethod.POST)
	public @ResponseBody() JQGridResponseDto<TareasAsignado> filterAsignadoAproveedores(
			@RequestJsonBody(param = "filter") Tareas filter, @RequestJsonBody() JQGridRequestDto jqGridRequestDto) {
		TareasController.LOGGER.info("[POST - filter] : Obtener Asignado Proveedor");
		jqGridRequestDto.setSidx(jqGridRequestDto.getSidx().replaceAll("TOTAL_NUM_PAL_IZO asc,",""));
		return this.tareasService.filterAsignadoAproveedores(filter, jqGridRequestDto, false);

	}

	/**
	 * Elimina las tareas seleccionadas
	 *
	 * @param listSelectedIds
	 *            List<String>
	 */
	@RequestMapping(value = "/removeTareas", method = RequestMethod.DELETE)
	@ResponseStatus(value = HttpStatus.OK)
	public void removeTareas(@RequestJsonBody() List<String> listSelectedIds) {
		TareasController.LOGGER.info("[DELETE - removeTareas] : Eliminar las tareas seleccionadas");
		this.tareasService.removeTareas(listSelectedIds);
	}

	/**
	 * Devuelve los datos del usuario conectado para poder autoasignar tareas
	 *
	 * @return Persona
	 */
	@RequestMapping(value = "/autoasignartareas", method = RequestMethod.GET)
	public @ResponseBody() Persona getAutoasignarTareas() {
		TareasController.LOGGER.info("[GET - View] : Autoasignar tareas");

		Usuario credentials = (Usuario) SecurityContextHolder.getContext().getAuthentication().getCredentials();
		Persona persona = new Persona();
		persona.setDni(credentials.getNif());
		persona.setNombre(credentials.getFullName());

		// actualizar
		boolean esta = this.datosPersonaService.comprobarPersona(persona.getDni());
		if (!esta) {
			PersonalIZO personalIZO = new PersonalIZO();
			personalIZO.setDni(persona.getDni());
			PersonalIZO personalAInsertar = this.personalIZOService.find(personalIZO);
			DatosPersona personaFoto = new DatosPersona();
			personaFoto.setDni(persona.getDni());
			personaFoto.setSufDni(personalAInsertar.getSufDni());
			personaFoto.setPreDni(personalAInsertar.getPreDni());
			personaFoto.setTipIden(personalAInsertar.getTipIden());
			personaFoto.setNombre(personalAInsertar.getNombre());
			personaFoto.setApellido1(personalAInsertar.getApellido1());
			personaFoto.setApellido2(personalAInsertar.getApellido2());
			this.datosPersonaService.add(personaFoto);
		}

		return persona;
	}

	/**
	 * Se reasignan las tareas al recurso indicado
	 *
	 * @param dni
	 *            String
	 * @param idEntidad
	 *            int
	 * @param tipoEntidad
	 *            String
	 * @param listSelectedIds
	 *            String
	 * @return Devuelve el número de tareas reasignadas
	 */
	@RequestMapping(value = "/reasignarTareas", method = RequestMethod.POST)
	public @ResponseBody() int reasignarTareas(@RequestParam(value = "dni") String dni,
			@RequestParam(value = "idEntidad") int idEntidad, @RequestParam(value = "tipoEntidad") String tipoEntidad,
			@RequestParam(value = "listSelectedIds") String listSelectedIds,
			@RequestParam(value = "tareaTrabajo", required = false) String tareaTrabajo) {
		TareasController.LOGGER.info("[POST] : Reasignar tareas");

		PersonalIZO persona = new PersonalIZO();
		persona.setDni(dni);
		Entidad entidad = new Entidad();
		entidad.setCodigo(idEntidad);
		entidad.setTipo(tipoEntidad);
		persona.setEntidad(entidad);

		if (StringUtils.isNotBlank(tareaTrabajo)) {
			return this.tareasTrabajoService.reasignarTareasTrabajo(persona, Utils.obtenerListIds(listSelectedIds));
		}

		return this.tareasService.reasignarTareas(persona, Utils.obtenerListIds(listSelectedIds));

	}

	/**
	 * Se comprueba si el orden establecido para las tareas es correcto.
	 *
	 * @param listTareasStr
	 *            String
	 * @return Devuelve (0/1): 0 - Si el orden establecido es correcto; 1 - en
	 *         caso contrario.
	 */
	@RequestMapping(value = "/reordenarTareas", method = RequestMethod.POST)
	public @ResponseBody() int reordenartareas(@RequestParam(value = "listaTareas") String listTareasStr) {
		TareasController.LOGGER.info("[POST] : Reordenar tareas");

		ObjectMapper mapper = new ObjectMapper();
		List<Tareas> listTareas = new ArrayList<Tareas>();
		try {
			listTareas = mapper.readValue(listTareasStr, new TypeReference<List<Tareas>>() {
			});
		} catch (Exception e) {
			TareasController.LOGGER.info("Exception listTareasStr", e);
		}

		return this.tareasService.reordenarTareas(listTareas);

	}

	/**
	 * Comprueba si la tarea seleccionada está asignada al usuario conectado y
	 * las tareas anteriores a la seleccionada están ejecutadas
	 *
	 * @param idTarea
	 *            BigDecimal
	 * @param anyoExpediente
	 *            Long
	 * @param idExpediente
	 *            Integer
	 * @return int, Devuelve (0/1/2): 0 - Si la tarea seleccionada está asignada
	 *         al usuario conectado y las tareas anteriores a la seleccionada
	 *         están ejecutadas; 1 - Si la tarea seleccionada no está asignada
	 *         al usuario conectado; 2 - Si existe alguna anterior a la
	 *         seleccionada que esté pendiente de ejecución
	 */
	@RequestMapping(value = "/comprobarTareaAsignador/{idTarea}/{anyoExpediente}/{idExpediente}/{idTipoTarea}", method = RequestMethod.GET)
	public @ResponseBody() int comprobarTareaAsignador(@PathVariable BigDecimal idTarea,
			@PathVariable Long anyoExpediente, @PathVariable Integer idExpediente, @PathVariable Long idTipoTarea) {
		TareasController.LOGGER.info("[POST] : Comprobar tarea asignador");

		Tareas tareas = new Tareas();
		PersonalIZO personaAsignada = new PersonalIZO();
		Usuario credentials = (Usuario) SecurityContextHolder.getContext().getAuthentication().getCredentials();
		personaAsignada.setDni(credentials.getNif());
		tareas.setPersonaAsignada(personaAsignada);
		tareas.setIdTarea(idTarea);
		tareas.setAnyo(anyoExpediente);
		tareas.setNumExp(idExpediente);
		TiposTarea tipoTarea = new TiposTarea();
		tipoTarea.setId015(idTipoTarea);
		tareas.setTipoTarea(tipoTarea);

		return this.tareasService.comprobarTareaAsignador(tareas);

	}

	/**
	 * Creacion de tareas por defecto para el expediente indicado
	 *
	 * @param anyoExpediente
	 *            Long
	 * @param numExpediente
	 *            Integer
	 */
	@RequestMapping(value = "/crearTareasDefecto", method = RequestMethod.POST)
	public @ResponseBody void crearTareasDefecto(@RequestJsonBody Expediente expediente) {
		this.tareasService.procCrearTareasDefectoPL(expediente.getAnyo(), expediente.getNumExp());
	}

	/**
	 * Operacion CRUD Create. Creacion de un nuevo registro a partir del bean
	 * indicado.
	 *
	 * @param tarea
	 *            Tareas Bean que contiene la informacion con la que se va a
	 *            crear el nuevo registro.
	 * @param documentosSelect
	 *            String
	 * @return int, Devuelve (0/1): 0 - Si la tarea se ha creado/actualizado
	 *         correctamente; 1 - Si el expediente está en curso y pendiente de
	 *         ejecución de la tarea proyecto trados
	 */
	@RequestMapping(value = "/addTarea", method = RequestMethod.POST)
	public @ResponseBody int add(@RequestJsonBody(required = false, param = "tarea") Tareas tarea,
			@RequestJsonBody(required = false, param = "documentosSelect") String documentosSelect) {
		// se guarda la tarea
		return this.tareasService.crearTarea(tarea, documentosSelect);
	}

	@RequestMapping(value = "/datosTareaInterp/{idTarea}", method = RequestMethod.GET)
	public @ResponseBody TareaIntPagoProveed getDatosTareaInt(@PathVariable Long idTarea) {

		return this.tareasService.getDatosTareaInt(idTarea);
	}

	/**
	 * Se calculan las horas estimadas para realizar una tarea de traducción o
	 * revisión
	 *
	 * @param expediente
	 *            Expediente
	 * @param documentosSelect
	 *            String
	 * @return
	 */
	@RequestMapping(value = "/calcularHorasPrevistasTradRev", method = RequestMethod.POST)
	public @ResponseBody HorasEstimadas getCalcularHorasPrevistasTradRev(
			@RequestJsonBody(required = false, param = "expediente") Expediente expediente,
			@RequestJsonBody(required = false, param = "documentosSelect") String documentosSelect,
			@RequestJsonBody(required = true, param = "idTipoTarea") BigDecimal idTipoTarea,
			@RequestJsonBody(required = true, param = "tareas") Tareas tarea ) {
		if (Integer.valueOf(idTipoTarea.toString()).equals(TipoTareaGestionAsociadaEnum.ENTREGA_CLIENTE_TRADUCCION.getValue())) {
			tarea.setAnyo(expediente.getAnyo());
			tarea.setNumExp(expediente.getNumExp());
			tarea.getTipoTarea().setId015(Long.valueOf(TipoTareaGestionAsociadaEnum.REVISAR_TRADUCCION.getValue()));
			// comprobar recurso de tarea revision traduccion externa anterior
			String recursoAsig = this.tareasService.getRecursoAsignado(tarea);
			if (StringUtils.isBlank(recursoAsig)) {
				// comprobar recurso de tarea revision traduccion interna anterior
				tarea.getTipoTarea().setId015(Long.valueOf(TipoTareaGestionAsociadaEnum.REVISAR_TRADUCCION_INTERNA.getValue()));
				recursoAsig = this.tareasService.getRecursoAsignado(tarea);
			}
			if (recursoAsig != null && recursoAsig.equals(tarea.getPersonaAsignada().getDni())) {
				HorasEstimadas horasEstimadas = new HorasEstimadas();
				horasEstimadas.setHorasIZO("00:05");
				horasEstimadas.setHorasProveedor("00:05");
				return horasEstimadas;
			} else {
				return this.tareasService.calcularHorasPrevistasTradRev(expediente, documentosSelect, idTipoTarea, tarea);
			}
		} else {
			return this.tareasService.calcularHorasPrevistasTradRev(expediente, documentosSelect, idTipoTarea, tarea);
		}
	}

	/**
	 * Se calculan las horas estimadas para realizar una tarea de traducción o
	 * revisión
	 *
	 * @param expediente
	 *            Expediente
	 * @param documentosSelect
	 *            String
	 * @return
	 */
	@RequestMapping(value = "/calcularFechaFinTarea", method = RequestMethod.POST)
	public @ResponseBody Long getCalcularFechaFinTarea(
			@RequestJsonBody(required = true, param = "tarea") Tareas tarea) {
		return this.tareasService.calcularFechaFinTarea(tarea);
	}

	@RequestMapping(value = "/calcularFechaIni", method = RequestMethod.POST)
	@ResponseBody public  Long calcularFechaIni(
			@RequestJsonBody(required = false, param = "expediente") Expediente expediente,
			@RequestJsonBody(required = false, param = "orden") String orden,
			@RequestJsonBody(required = false, param = "idTarea") BigDecimal idTarea) {
		return this.tareasService.calcularFechaIni(expediente,orden, idTarea);
	}


	/**
	 * Se calculan las horas estimadas para realizar un tarea de interpretación
	 *
	 * @param anyoExpediente
	 *            Long
	 * @param idExpediente
	 *            Integer
	 * @return String
	 */
	@RequestMapping(value = "/calcularHorasPrevistasInter/{anyoExpediente}/{idExpediente}", method = RequestMethod.GET)
	public @ResponseBody String getCalcularHorasPrevistasInter(@PathVariable Long anyoExpediente,
			@PathVariable Integer idExpediente) {

		Expediente expediente = new Expediente();
		expediente.setAnyo(anyoExpediente);
		expediente.setNumExp(idExpediente);

		return this.tareasService.calcularHorasPrevistasInter(expediente);
	}

	/**
	 * Se calculan el importe estimado para realizar un tarea de interpretación
	 *
	 * @param anyoExpediente
	 *            Long
	 * @param idExpediente
	 *            Integer
	 * @return String
	 */
	@RequestMapping(value = "/calcularImportePresupuestoInter", method = RequestMethod.POST)
	public @ResponseBody BigDecimal calcularImportePresupuestoInter(@RequestJsonBody Tareas tarea) {
		return this.tareasService.calcularImportePresupuestoInter(tarea);
	}

	@RequestMapping(value = "/calcularImportePrevistoLote/{idTarea}/{idLote}", method = RequestMethod.GET)
	public @ResponseBody BigDecimal calcularImportePrevistoLote(@PathVariable BigDecimal idTarea,
			@PathVariable Integer idLote) {
		return this.tareasService.calcularImportePrevistoLote(idTarea, idLote);
	}

	/**
	 * Se comprueba si el orden de la tarea indicado es correcto
	 *
	 * @param tarea
	 *            Tareas
	 * @return Devuelve (0/1): 0 - Si el orden es correcto; 1 - en caso
	 *         contrario.
	 */
	@RequestMapping(value = "/comprobarOrdenTareas", method = RequestMethod.POST)
	public @ResponseBody int comprobarOrdenTareas(@RequestJsonBody Tareas tarea) {
		return this.tareasService.comprobarOrdenTareas(tarea);
	}

	@RequestMapping(value = "/datosRecargoLote", method = RequestMethod.POST)
	public @ResponseBody Tareas datosRecargoLote(@RequestJsonBody Tareas tarea) {

		Tareas result = new Tareas();
		Lotes lote = this.lotesService.find(tarea.getLotes());
		result.setLotes(lote);

		if (tarea.getIdTarea() != null) {

			DatosPagoProveedores pagoProv = this.datosPagoProveedoresService.getDatosPagoProvTareaRel(tarea);
			result.setDatosPagoProveedores(pagoProv);
		}

		return result;
	}

	/**
	 * Se comprueba si es factible dar de alta el tipo de tarea indicado
	 *
	 * @param tarea
	 *            Tareas
	 * @return Devuelve (0/1): 0 - Si el orden es correcto; 1 - en caso
	 *         contrario.
	 */
	@RequestMapping(value = "/comprobarTipoTarea", method = RequestMethod.POST)
	public @ResponseBody int comprobarTipoTarea(@RequestJsonBody Tareas tarea) {
		return this.tareasService.comprobarTipoTarea(tarea);
	}

	/**
	 * Se comprueba si la fecha de fin de la tarea es superior a la fecha de
	 * entrega del expediente
	 *
	 * @param tarea
	 *            Tareas
	 * @return Devuelve (0/1): 0 - Si el orden es correcto; 1 - en caso
	 *         contrario.
	 */
	@RequestMapping(value = "/comprobarFechaFinTarea", method = RequestMethod.POST)
	public @ResponseBody int comprobarFechaFinTarea(@RequestJsonBody Tareas tarea) {
		return this.tareasService.comprobarFechaFinTarea(tarea);
	}

	/**
	 * Mostrar las 6 ultimas ejecuciones de las tareas interpretar entrega del
	 * expediente
	 *
	 * @param tarea
	 *            Tareas
	 * @return Devuelve (0/1): 0 - Si el orden es correcto; 1 - en caso
	 *         contrario.
	 */
	@RequestMapping(value = "/mostrarUltimasTareasInterpretacion", method = RequestMethod.GET)
	public @ResponseBody void mostrarUltimasTareasInterpretacion(Locale locale, HttpServletResponse response) {

		JQGridResponseDto<Tareas> datos = this.getUltimasTareasInterpretacion();

		final String reportTitle = "titulo.informeUltimasTareasInter";
		final String label = this.appMessageSource.getMessage(reportTitle, new Object[] {}, locale);

		StringBuilder columns = new StringBuilder("[[\"fechaHoraIni\",\"comun.fechaInicioTarea\",150,\"left\"],"
				+ "[\"fechaHoraFin\",\"comun.fechaHoraFinTarea\",150,\"left\"],"
				+ "[\"personaAsignador.nombreCompleto\",\"label.recursoAsignacion\",150,\"left\"],"
				+ "[\"horasTarea\",\"label.horasRealesDedic\",150,\"left\"]]");

		ExcelModel excelModel = this.excelReportService.getExcelModel(null, columns.toString(), datos.getRows(), locale,
				reportTitle, label);
		byte[] bytesInforme = null;
		Fichero ficheroBean = new Fichero();
		try {
			bytesInforme = this.excelReportService.generarExcel("printExcel", excelModel);
		} catch (Exception e1) {
			TareasController.LOGGER.info("ERROR generarExcel, Error: " + e1);
		}

		ficheroBean.setNombre(this.appMessageSource.getMessage("titulo.informeUltimasTareasInter", null, locale));
		ficheroBean.setExtension(FormatoInformeEnum.EXCEL.getExtension());
		ficheroBean.setContentType(FormatoInformeEnum.EXCEL.getContentType());
		ficheroBean.setTamano((long) bytesInforme.length);

		this.descargarDocumentos(ficheroBean, response, bytesInforme);
	}

	/**
	 * Se obtienen los datos de la tarea seleccionada
	 *
	 * @param idTarea
	 *            BigDecimal
	 * @return Tareas
	 */
	@RequestMapping(value = "/findConfTarea/{idTarea}", method = RequestMethod.GET)
	public @ResponseBody() Tareas findConfTarea(@PathVariable BigDecimal idTarea) {
		Tareas tarea = new Tareas();
		tarea.setIdTarea(idTarea);

		return this.tareasService.findConfTarea(tarea);
	}

	/**
	 * Reabre la tarea indicada
	 *
	 * @param idTarea
	 *            BigDecimal
	 */
	@RequestMapping(value = "/reabrirTarea/{idTarea}", method = RequestMethod.POST)
	public @ResponseBody int reabrirTarea(@PathVariable BigDecimal idTarea) {
		TareasController.LOGGER.info("[POST - reabrirTarea] : Reabre la tarea seleccionada");
		return this.tareasService.reabrirTarea(idTarea);
	}

	/**
	 * Comprueba la Reapertura de la tarea indicada
	 *
	 * @param idTarea
	 *            BigDecimal
	 */
	@RequestMapping(value = "/preReabrirTarea/{idTarea}", method = RequestMethod.POST)
	public @ResponseBody int preReabrirTarea(@PathVariable BigDecimal idTarea) {
		TareasController.LOGGER.info("[POST - reabrirTarea] : Reabre la tarea seleccionada");
		return this.tareasService.preReabrirTarea(idTarea);
	}

	/**
	 * Comprueba si existen tareas automáticas entre las tareas seleccionadas o
	 * tareas que no se puedan eliminar
	 *
	 * @param listSelectedIds
	 *            List<String>
	 * @param tipoExpediente
	 *            String
	 * @return int, Devuelve (0/1/2): 0 - Si no existen tareas automáticas; 1 -
	 *         si existen tareas automáticas; 2 - Si existen tareas que no se
	 *         puedan eliminar
	 */
	@RequestMapping(value = "/comprobarTareasAEliminar", method = RequestMethod.POST)
	public @ResponseBody() int comprobarTareasAEliminar(@RequestParam(value = "listSelectedIds") String listSelectedIds,
			@RequestParam(value = "tipoExpediente") String tipoExpediente) {
		TareasController.LOGGER.info("[POST] : Comprobar tareas automáticas");

		int rst = 0;
		List<String> idsSeleccionados = Utils.obtenerListIds(listSelectedIds);

		if (this.tareasService.findTareasAutomaticasCount(idsSeleccionados, tipoExpediente) > 0) {
			rst = 1;
		} else if (this.tareasService.comprobarTareasAEliminar(idsSeleccionados) > 0) {
			rst = 2;
		}

		return rst;

	}

	/**
	 * Se obtienen la tarea de revisión externa para el expediente indicado
	 *
	 * @param anyoExpediente
	 *            Long
	 * @param anyoExpediente
	 *            Integer
	 * @return Tareas
	 */
	@RequestMapping(value = "/findTareaRevisionExterna/{anyoExpediente}/{idExpediente}", method = RequestMethod.GET)
	public @ResponseBody() Tareas findTareaRevisionExterna(@PathVariable Long anyoExpediente,
			@PathVariable Integer idExpediente) {
		return this.tareasService.findTareaRevisionExterna(anyoExpediente, idExpediente);
	}

	/**
	 *
	 * @param tareaFilter
	 * @return
	 */
	@RequestMapping(value = "/findCountTareasRangoFechas", method = RequestMethod.POST)
	public @ResponseBody List<Integer> findTareasRangoFechas(@RequestJsonBody Tareas tareaFilter) {
		TareasController.LOGGER.info("[findTareasRangoFechas] : Obtener TipoRelevancia por filtro");

		return this.tareasService.findCountTareasRangoFechas(tareaFilter);
	}

	/**
	 * Se calculan las horas estimadas para realizar un tarea de interpretación
	 *
	 * @return String
	 */
	@RequestMapping(value = "/calcularHorasEntreFechas", method = RequestMethod.POST)
	public @ResponseBody String getCalcularHorasEntreFechas(
			@RequestJsonBody(required = false, param = "tarea") Tareas tarea) {
		return this.tareasService.calcularHorasEntreFechas(tarea);
	}

	/**
	 * Comprueba si existen tareas sin ejecutar para el expediente indicado
	 *
	 * @param anyoExpediente
	 *            Long
	 * @param idExpediente
	 *            Integer
	 * @return int, Devuelve (0/n): 0 - Si todas las tareas están ejecutadas; n
	 *         - Si existen tareas sin ejecutar
	 */
	@RequestMapping(value = "/findAllCountSinEjecutar/{anyoExpediente}/{idExpediente}", method = RequestMethod.GET)
	public @ResponseBody() long findAllCountSinEjecutar(@PathVariable Long anyoExpediente,
			@PathVariable Integer idExpediente) {
		TareasController.LOGGER.info("[POST] : findAllCountSinEjecutar");
		Tareas tareasFilter = new Tareas();
		tareasFilter.setAnyo(anyoExpediente);
		tareasFilter.setNumExp(idExpediente);
		return this.tareasService.findAllCountSinEjecutar(tareasFilter);
	}

	/**
	 * Descarga documento presupuesto interpretacion
	 *
	 * @param anyoExpediente
	 *            Long
	 * @param idExpediente
	 *            Integer
	 * @param idRequerimiento
	 *            Long
	 */
	@RequestMapping(value = "obtenerDocumentoPresupuestoInterpretacion/{numExpediente}/{anyoExpediente}/{idRequerimiento}", method = RequestMethod.GET)
	public void obtenerDocumentoPresupuestoInterpretacion(@PathVariable Integer numExpediente,
			@PathVariable Long anyoExpediente, @PathVariable Long idRequerimiento, HttpServletResponse response,
			Locale locale) {
		TareasController.LOGGER.info("[GET - View]: obtenerDocumentoPresupuestoInterpretacion");
		TareasGestionInterpretacion filter = new TareasGestionInterpretacion();
		filter.setAnyo(anyoExpediente);
		filter.setNumExp(numExpediente);
		filter.setIdRequerimiento(idRequerimiento);

		this.obtenerFicheroPresupuesto(filter, locale, response, TipoExpedienteEnum.INTERPRETACION.getValue());
	}

	/**
	 * Descarga documento presupuesto traduccion
	 *
	 * @param anyoExpediente
	 *            Long
	 * @param idExpediente
	 *            Integer
	 * @param idRequerimiento
	 *            Long
	 */
	@RequestMapping(value = "obtenerDocumentoPresupuestoTraduccion/{numExpediente}/{anyoExpediente}/{idRequerimiento}", method = RequestMethod.GET)
	public void obtenerDocumentoPresupuestoTraduccion(@PathVariable Integer numExpediente,
			@PathVariable Long anyoExpediente, @PathVariable Long idRequerimiento, HttpServletResponse response,
			Locale locale) {
		TareasController.LOGGER.info("[GET - View]: obtenerDocumentoPresupuestoTraduccion");
		TareasGestionInterpretacion filter = new TareasGestionInterpretacion();
		filter.setAnyo(anyoExpediente);
		filter.setNumExp(numExpediente);
		filter.setIdRequerimiento(idRequerimiento);

		this.obtenerFicheroPresupuesto(filter, locale, response, TipoExpedienteEnum.TRADUCCION.getValue());
	}

	/**
	 * Comprueba si existen tareas asignadas para el expediente indicado
	 *
	 * @param anyoExpediente
	 *            Long
	 * @param idExpediente
	 *            Integer
	 * @return long, Devuelve (0/n): 0 - Si no hay tareas asignadas; n - Si
	 *         existen tareas asignadas
	 */
	@RequestMapping(value = "/findAllCountTareasAsignadas/{anyoExpediente}/{idExpediente}", method = RequestMethod.GET)
	public @ResponseBody() long findAllCountTareasAsignadas(@PathVariable Long anyoExpediente,
			@PathVariable Integer idExpediente) {
		TareasController.LOGGER.info("[POST] : findAllCountTareasAsignadas");
		Tareas tareasFilter = new Tareas();
		tareasFilter.setAnyo(anyoExpediente);
		tareasFilter.setNumExp(idExpediente);
		return this.tareasService.findAllCountTareasAsignadas(tareasFilter);
	}

	private void descargarDocumentos(Fichero ficheroBean, HttpServletResponse response, byte[] bytesInforme) {

		try {
			ficheroBean.setRutaPif(this.pidService.subidaPif(ficheroBean.getNombre() + ficheroBean.getExtension(),
					bytesInforme, this.appConfiguration.getProperty("rutaPifAa06a"), false));
		} catch (UnsupportedEncodingException e) {
			TareasController.LOGGER.info("UnsupportedEncodingException - subidaPif: " + e);

		} catch (Exception e) {
			TareasController.LOGGER.error("pruebapid: subidaFichero Error: ", e);
		}

		TareasController.LOGGER.debug("WS_METHOD descargarDocumentos - FIN");

		response.setContentType(ficheroBean.getContentType());
		response.setHeader("Content-Disposition",
				"attachment; filename=\"" + ficheroBean.getNombre() + ficheroBean.getExtension() + "\"");
		response.setHeader("Pragma", "cache");
		response.setHeader("Expires", "0");
		response.setHeader("Cache-Control", "private");

		try {
			OutputStream out = response.getOutputStream();
			InputStream servicioGetDelPifInput = this.pidService.servicioGetDelPifInput(ficheroBean.getRutaPif());
			byte[] outputByte = new byte[4096];

			int resto = new BigDecimal(ficheroBean.getTamano()).intValueExact() % 4096;

			while (servicioGetDelPifInput.read(outputByte, 0, 4096) == 4096) {
				out.write(outputByte, 0, 4096);
			}
			if (resto != Constants.CERO) {
				out.write(outputByte, 0, resto);
			}

			servicioGetDelPifInput.close();
			out.close();
			response.flushBuffer();
		} catch (Exception e) {
			TareasController.LOGGER.error("ERROR descargando documento del PIF: ", e);
		}

		TareasController.LOGGER.info("[POST] : descargarDocumentos del PIF - fin");
	}

	public void obtenerFicheroPresupuesto(TareasGestionInterpretacion bean, Locale locale,
			HttpServletResponse response, String tipo) {

		ModelMap modelMap = new ModelMap();
		byte[] bytesInforme = null;
		String nombreFichero;

		if (tipo.equals(TipoExpedienteEnum.INTERPRETACION.getValue())) {

			Tareas laTarea = this.tareasService.getDatosDocumentoPptoInterpretacion(bean.getAnyo(), bean.getNumExp(),
					bean.getIdRequerimiento());

			List<Tareas> lDatos = new ArrayList<Tareas>();
			lDatos.add(laTarea);

			this.tareasService.getmodelMapDocumentoInterpretacion(locale, modelMap, lDatos);

			JasperPrint jasperPrint = null;
			try {
				Resource mainReport;

				mainReport = this.ctx.getResource(Constants.RUTA_JASPER_DOC_PRESUPUESTO_INTERPRETACION);

				JasperReport jasperReport = new JasperUtils().loadReport(mainReport);
				jasperPrint = JasperFillManager.fillReport(jasperReport, modelMap, new JRBeanCollectionDataSource(lDatos));
				bytesInforme = JasperExportManager.exportReportToPdf(jasperPrint);
			} catch (JRException e) {
				TareasController.LOGGER.error("Error pdf documentoPresupuesto " + e);
			}

			nombreFichero = "label.docPptoInterpNombreFich";

		} else {

			DocPresupuestoTraduccion laTarea = this.tareasService.getDatosDocumentoPptoTraduccion(bean.getAnyo(), bean.getNumExp(),
					bean.getIdRequerimiento());

			List<DocPresupuestoTraduccion> lDatos = new ArrayList<DocPresupuestoTraduccion>();
			lDatos.add(laTarea);

			this.tareasService.getmodelMapDocumentoTraduccion(locale, modelMap, lDatos);

			JasperPrint jasperPrint = null;
			try {
				Resource mainReport;

				mainReport = this.ctx.getResource(Constants.RUTA_JASPER_DOC_PRESUPUESTO_TRADUCCION);

				JasperReport jasperReport = new JasperUtils().loadReport(mainReport);
				jasperPrint = JasperFillManager.fillReport(jasperReport, modelMap, new JRBeanCollectionDataSource(lDatos));
				bytesInforme = JasperExportManager.exportReportToPdf(jasperPrint);
			} catch (JRException e) {
				TareasController.LOGGER.error("Error pdf documentoPresupuesto " + e);
			}

			nombreFichero = "label.docPptoTraducNombreFich";
		}

		Fichero ficheroBean = new Fichero();

		ficheroBean.setNombre(this.appMessageSource.getMessage(nombreFichero, null, locale) + "_"
				+ bean.getAnyo() + "_" + bean.getNumExp());
		ficheroBean.setExtension(FormatoInformeEnum.PDF.getExtension());
		ficheroBean.setContentType(FormatoInformeEnum.PDF.getContentType());
		ficheroBean.setTamano((long) bytesInforme.length);

		this.descargarDocumentos(ficheroBean, response, bytesInforme);
	}

	private JQGridResponseDto<Tareas> getUltimasTareasInterpretacion() {

		JQGridRequestDto jqGridRequestDtoReport = new JQGridRequestDto(null, null, "e1.FECHA_EJECUCION_082", "DESC");

		jqGridRequestDtoReport.setRows(new Long(6));

		return this.tareasService.ultimasTareasInterpretacion(jqGridRequestDtoReport);
	}

	/**
	 * Se obtienen los datos de la tarea seleccionada
	 *
	 * @param idTarea
	 *            BigDecimal
	 * @return Tareas
	 */
	@RequestMapping(value = "/findDatosCorreccionesProv/{idTarea}", method = RequestMethod.GET)
	public @ResponseBody() Tareas findDatosCorreccionesProv(@PathVariable BigDecimal idTarea) {
		Tareas tarea = new Tareas();
		tarea.setIdTarea(idTarea);

		return this.tareasService.findDatosCorreccionesProv(tarea);
	}

	/**
	 *
	 * @return List<NivelesDeCalidad>
	 */
	@RequestMapping(value = "/getNivelesDeCalidad", method = RequestMethod.GET)
	public @ResponseBody List<NivelesDeCalidad> getFasesExpedientePlanificacion() {
		TareasController.LOGGER.info("[GET - find_ALL] : Obtener NivelesDeCalidad");
		NivelesDeCalidad nivelesDeCalidad = new NivelesDeCalidad();
		nivelesDeCalidad.setEstado(Constants.ALTA);
		return this.nivelesDeCalidadService.findAllLike(nivelesDeCalidad, null, false);
	}

	/**
	 *
	 * @param tarea Tareas
	 * @return Tareas
	 */
	@RequestMapping(value = "/findEjecTareasPrevInterpretacion", method = RequestMethod.POST)
	public @ResponseBody() Tareas findEjecTareasPrevInterpretacion(@RequestJsonBody Tareas tarea) {
		TareasController.LOGGER.info("[GET - findEjecTareasPrevInterpretacion] : IdTarea: " + tarea.getIdTarea() + "; Anyo: " + tarea.getAnyo() + "; NumExp: " + tarea.getNumExp());
		return this.tareasService.findEjecTareasPrevInterpretacion(tarea);
	}

	/**
	 *
	 * @param tarea Tareas
	 * @return Integer
	 */
	@RequestMapping(value = "/actualizarTareasPrevInterpretacion", method = RequestMethod.POST)
	public @ResponseBody() Integer actualizarTareasPrevInterpretacion(@RequestJsonBody Tareas tarea) {
		TareasController.LOGGER.info("[GET - actualizarTareasPrevInterpretacion] : IdTarea: " + tarea.getIdTarea() + "; Anyo: " + tarea.getAnyo() + "; NumExp: " + tarea.getNumExp());
		return this.tareasService.actualizarTareasPrevInterpretacion(tarea);
	}

	@RequestMapping(value = "/obtenerOrigenNoConformidad/{idTarea}", method = RequestMethod.POST)
	public @ResponseBody() OrigenTareaNoConformidad obtenerOrigenNoConformidad(@PathVariable() BigDecimal idTarea) {
		TareasController.LOGGER.info("[POST - obtenerOrigenNoConformidad] : IdTarea: " + idTarea);
		return this.tareasService.obtenerOrigenNoConformidad(idTarea);
	}

	/**
	 * Comprobar si las fechas fin de las tareas no superan la fecha fin del expediente
	 *
	 * @param expediente Expediente
	 * @return Integer
	 */
	@RequestMapping(value = "/comprobarFechaFinTareasNoSuperaFechaFinExp", method = RequestMethod.POST)
	public @ResponseBody() Integer comprobarFechaFinTareasNoSuperaFechaFinExp(@RequestJsonBody Expediente expediente) {
		return this.tareasService.comprobarFechaFinTareasNoSuperaFechaFinExp(expediente);
	}

	@RequestMapping(value = "/obtenerEstadoEjecucionTarea/{anyo}/{numExp}/{idTarea}", method = RequestMethod.GET)
	public @ResponseBody Tareas obtenerEstadoEjecucionTarea(@PathVariable Long anyo, @PathVariable Integer numExp,
			@PathVariable BigDecimal idTarea) {
		TareasController.LOGGER.info("[GET] : obtenerEstadoEjecucionTarea");
		Tareas tarea = new Tareas();
		tarea.setAnyo(anyo);
		tarea.setNumExp(numExp);
		tarea.setIdTarea(idTarea);
		return this.tareasService.obtenerEstadoEjecucionTarea(tarea);
	}

	@RequestMapping(value = "/obtenerEstadoEjecucionTareaTrabajo/{idTarea}/{idTrabajo}", method = RequestMethod.GET)
	public @ResponseBody TareasTrabajo obtenerEstadoEjecucionTareaTrabajo(@PathVariable BigDecimal idTarea, @PathVariable BigDecimal idTrabajo) {
		TareasController.LOGGER.info("[GET] : obtenerEstadoEjecucionTarea");
		TareasTrabajo tarea = new TareasTrabajo();
		tarea.setIdTarea(idTarea);
		OtrosTrabajos otrosTrabajo = new OtrosTrabajos();
		otrosTrabajo.setIdTrabajo(idTrabajo);
		tarea.setTrabajo(otrosTrabajo);
		return this.tareasTrabajoService.obtenerEstadoEjecucionTarea(tarea);
	}

	/**
	 * Comprueba si la tarea seleccionada está asignada al usuario conectado y
	 * las tareas anteriores a la seleccionada están ejecutadas
	 *
	 * @param idTarea
	 *            BigDecimal
	 * @param idTrabajo
	 *            BigDecimal
	 * @param idTipoTarea
	 *            Long
	 * @return int, Devuelve (0/1/2): 0 - Si la tarea seleccionada está asignada
	 *         al usuario conectado y las tareas anteriores a la seleccionada
	 *         están ejecutadas; 1 - Si la tarea seleccionada no está asignada
	 *         al usuario conectado; 2 - Si existe alguna anterior a la
	 *         seleccionada que esté pendiente de ejecución
	 */
	@RequestMapping(value = "/comprobarTareaTrabajoAsignador/{idTarea}/{idTrabajo}/{idTipoTarea}", method = RequestMethod.GET)
	public @ResponseBody() int comprobarTareaTrabajoAsignador(@PathVariable BigDecimal idTarea,@PathVariable BigDecimal idTrabajo,
			@PathVariable Long idTipoTarea) {
		TareasController.LOGGER.info("[POST] : Comprobar tarea asignador");

		TareasTrabajo tareas = new TareasTrabajo();
		PersonalIZO personaAsignada = new PersonalIZO();
		Usuario credentials = (Usuario) SecurityContextHolder.getContext().getAuthentication().getCredentials();
		personaAsignada.setDni(credentials.getNif());
		tareas.setPersonaAsignada(personaAsignada);
		tareas.setIdTarea(idTarea);
		OtrosTrabajos otrosTrabajo = new OtrosTrabajos();
		otrosTrabajo.setIdTrabajo(idTrabajo);
		tareas.setTrabajo(otrosTrabajo);
		TiposTarea tipoTarea = new TiposTarea();
		tipoTarea.setId015(idTipoTarea);
		tareas.setTipoTarea(tipoTarea);

		return this.tareasTrabajoService.comprobarTareaTrabajoAsignador(tareas);

	}

	/**
	 * @param expediente
	 *            Expediente
	 * @return List<Persona>.
	 */
	@RequestMapping(value = "/getAsignadoTareaRevisionAnterior", method = RequestMethod.POST)
	public @ResponseBody Tareas getAsignadoTareaRevisionAnterior(@RequestBody Tareas tarea) {
		TareasController.LOGGER.info("[POST - getAsignadoTareaRevisionAnterior]: Inicio ========================================");

		List<Integer> tiposTarea = new ArrayList<Integer>();
		tiposTarea.add(TipoTareaGestionAsociadaEnum.REVISAR_TRADUCCION.getValue());
		tiposTarea.add(TipoTareaGestionAsociadaEnum.REVISAR_TRADUCCION_INTERNA.getValue());

		return this.tareasService.getAsignadoTareaRevisionAnterior(tarea, tiposTarea);
	}


}
