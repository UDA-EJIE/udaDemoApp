package com.ejie.aa79b.control;

import java.io.ByteArrayOutputStream;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.io.UnsupportedEncodingException;
import java.security.GeneralSecurityException;
import java.util.Locale;
import java.util.Properties;

import javax.servlet.ServletOutputStream;
import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.support.ReloadableResourceBundleMessageSource;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.multipart.MultipartFile;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.model.Fichero;
import com.ejie.aa79b.utils.AESCrypt;
import com.ejie.aa79b.webservices.PIDService;

/**
 * PruebasController generated by UDA, 27-nov-2017 12:26:24.
 *
 * @author UDA
 */

@Controller()
@RequestMapping(value = "/servicios")

public class ServiciosController {

    private static final Logger LOGGER = LoggerFactory.getLogger(ServiciosController.class);
    private static final String FICHEROFILE = "ficheroFile";

    private static final String RUTA_PIF = "rutaPifAa06a";

    @Autowired()
    private ReloadableResourceBundleMessageSource appMessageSource;

    @Autowired()
	private Properties appConfiguration;

    @Autowired()
	private PIDService pidService;

    /**
     * @return String
     */
    @RequestMapping(value = "/trataFicherosConfi/encripFicheros/maint", method = RequestMethod.GET)
    public String getFormEdit(Model model) {
        ServiciosController.LOGGER.info("PRUEBAS: maint");
        return "encryptDecrypt";
    }

    @RequestMapping(value = "/procesarFichero")
    public @ResponseBody Fichero procesarFichero(@RequestParam(value = "ficheroFile") MultipartFile fichero,
            HttpServletRequest request, HttpServletResponse response, Locale locale) {
        ServiciosController.LOGGER.info("PRUEBAS: Encriptar");
        String nombreFichero = fichero.getOriginalFilename();
        final String opcion = request.getParameter("opcion");
        final String passWd = request.getParameter("password");

        Fichero bean = new Fichero();
        try {

            AESCrypt aesCrypt = new AESCrypt(passWd);
        	ByteArrayOutputStream baos = new ByteArrayOutputStream();
            if (Constants.ENCRIPTAR.equals(opcion)) {
                // Encriptar
                aesCrypt.encrypt(1, fichero.getInputStream(), baos);
            } else if (Constants.DESENCRIPTAR.equals(opcion)) {
            	// Desencriptar
                aesCrypt.decrypt(fichero.getSize(), fichero.getInputStream(), baos);
            }

            bean.setRutaPif(this.pidService.subidaPif(nombreFichero, baos.toByteArray(), this.appConfiguration.getProperty(RUTA_PIF), false));
            bean.setNombre(nombreFichero);
            bean.setContentType(fichero.getContentType());


        } catch (UnsupportedEncodingException e) {
            ServiciosController.LOGGER.info("Error UnsupportedEncodingException: " + e);
            bean.setError("ERROR UnsupportedEncodingException");
        } catch (GeneralSecurityException e) {
            ServiciosController.LOGGER.info("Error GeneralSecurityException: " + e);
            bean.setError("ERROR GeneralSecurityException");
        } catch (IOException e) {
            ServiciosController.LOGGER.info("Error IOException: " + e);
            if (e.getLocalizedMessage().contains("password incorrect")) {
                bean.setError(this.appMessageSource.getMessage("label.passwrdDescIncorrecta", null, locale));
            } else if (e.getLocalizedMessage().contains("header")) {
                bean.setError(this.appMessageSource.getMessage("label.noEncriptado", null, locale));
            } else {
                bean.setError(this.appMessageSource.getMessage("label.errorGenEncript", null, locale));
            }
        }catch (Exception e) {
        	ServiciosController.LOGGER.error("Error Exceptioption: ", e);
        	 bean.setError(this.appMessageSource.getMessage("label.errorGenEncript", null, locale));
		}


        request.getSession().setAttribute(FICHEROFILE, bean);
        return bean;
    }

    @RequestMapping(value = "/abrirFichero")
    public void abrirFichero(HttpServletRequest request, HttpServletResponse response) {
        ServiciosController.LOGGER.info("PRUEBAS: cargarSolicitudes");
        Fichero aux = (Fichero) request.getSession().getAttribute(FICHEROFILE);

        response.setContentType(aux.getContentType());
        response.setHeader("Content-disposition", "attachment;filename=\"" + aux.getNombre() + "\"");

        response.setHeader("Pragma", "cache");
        response.setHeader("Expires", "0");
        response.setHeader("Cache-Control", "private");

        ByteArrayOutputStream baos = new ByteArrayOutputStream(aux.getBytes().length);
        baos.write(aux.getBytes(), 0, aux.getBytes().length);
        response.setContentLength(aux.getBytes().length);
        OutputStream os;
        try {
            os = response.getOutputStream();
            baos.writeTo(os);
            os.flush();
            os.close();
        } catch (IOException e) {
            ServiciosController.LOGGER.info("Error IOException: " + e);
        }

        Cookie cookie = new Cookie("fileDownload", "true");
        cookie.setPath("/");
        cookie.setSecure(true);
        response.addCookie(cookie);

        request.getSession().removeAttribute(FICHEROFILE);
    }

    @RequestMapping(value = "/abrirFicheroEncriptado")
    public void abrirFicheroEncriptado(HttpServletRequest request, HttpServletResponse response) {
    	ServiciosController.LOGGER.info("PRUEBAS: cargarSolicitudes");
        Fichero aux = (Fichero) request.getSession().getAttribute(FICHEROFILE);

        try {
        InputStream fileInputStream = this.pidService.servicioGetDelPifInput(aux.getRutaPif());

	        response.setContentType(aux.getContentType());
	        response.setHeader("Content-disposition", "attachment;filename=\"" + aux.getNombre() + "\"");

	        response.setHeader("Pragma", "cache");
	        response.setHeader("Expires", "0");
	        response.setHeader("Cache-Control", "private");

	        ServletOutputStream out = response.getOutputStream();

	        try{
	            byte[] buf=new byte[8192];
	            int bytesread = 0, bytesBuffered = 0;
	            while( (bytesread = fileInputStream.read( buf )) > -1 ) {
	                out.write( buf, 0, bytesread );
	                bytesBuffered += bytesread;
	              //flush after 1MB
	                if (bytesBuffered > 1024 * 1024) {
	                    bytesBuffered = 0;
	                    out.flush();
	                }
	            }
	        }finally {
	            if (out != null) {
	                out.flush();
	            }
	            if (fileInputStream != null) {
	            	fileInputStream.close();
	            }
	        }

	        Cookie cookie = new Cookie("fileDownload", "true");
	        cookie.setPath("/");
	        cookie.setSecure(true);
	        response.addCookie(cookie);

        } catch (FileNotFoundException fe) {
            ServiciosController.LOGGER.info("Error IOException: " + fe);
        } catch (IOException e) {
            ServiciosController.LOGGER.info("Error IOException: " + e);
        } catch (Exception e) {
            ServiciosController.LOGGER.info("Error Exception: " + e);
        }

        request.getSession().removeAttribute(FICHEROFILE);
    }
}