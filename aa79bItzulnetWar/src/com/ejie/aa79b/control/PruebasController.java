package com.ejie.aa79b.control;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.OutputStream;
import java.io.UnsupportedEncodingException;
import java.security.GeneralSecurityException;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import java.util.Locale;

import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.xml.parsers.ParserConfigurationException;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.i18n.LocaleContextHolder;
import org.springframework.context.support.ReloadableResourceBundleMessageSource;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.servlet.ModelAndView;
import org.xml.sax.SAXException;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.mail.MailService;
import com.ejie.aa79b.model.DireccionNora;
import com.ejie.aa79b.model.Expediente;
import com.ejie.aa79b.model.Fichero;
import com.ejie.aa79b.model.LibroRegistroModel;
import com.ejie.aa79b.model.ParametrosEmail;
import com.ejie.aa79b.model.RdoBatch;
import com.ejie.aa79b.o75.Batch;
import com.ejie.aa79b.service.DireccionNoraService;
import com.ejie.aa79b.utils.AESCrypt;
import com.ejie.aa79b.webservices.PIDService;
import com.ejie.aa79b.webservices.srp.RegistroPresencialWebService;
import com.ejie.x38.control.bind.annotation.RequestJsonBody;

import biweekly.Biweekly;
import biweekly.ICalendar;
import biweekly.component.VEvent;
import biweekly.util.Duration;
import biweekly.util.Frequency;
import biweekly.util.Recurrence;

/**
 * PruebasController generated by UDA, 27-nov-2017 12:26:24.
 *
 * @author UDA
 */

@Controller()
@RequestMapping(value = "/pruebas")

public class PruebasController {

	private static final Logger LOGGER = LoggerFactory.getLogger(PruebasController.class);
	private static final String FICHERO = "fichero";
	private static final String FICHEROFILE = "ficheroFile";

	@Autowired()
	private PIDService pidService;

	@Autowired()
	private MailService mailService;

	@Autowired()
	private DireccionNoraService direccionNoraService;

	@Autowired()
	private RegistroPresencialWebService registroPresencialWebService;

	@Autowired()
	private ReloadableResourceBundleMessageSource appMessageSource;

	@Autowired()
	private Batch batch;


	/**
	 * @return String
	 */
	@RequestMapping(value = "/maint", method = RequestMethod.GET)
	public String getFormEdit(Model model) {
		PruebasController.LOGGER.info("PRUEBAS: maint");
		return "pruebas";
	}

	@RequestMapping(value = "/subidaFichero", method = RequestMethod.POST)
	public @ResponseBody() Fichero subidaFichero(@RequestParam() MultipartFile fichero, HttpServletRequest request,
			Locale idioma) {
		PruebasController.LOGGER.info("PRUEBA DE TIEMPOS SUBIDA PIF 2GB: inicio subidaFichero");
		Fichero bean = new Fichero();
		String nombreFichero = fichero.getOriginalFilename();
		bean.setNombre(nombreFichero);
		try {
			bean.setRutaPif(this.pidService.subidaPif(nombreFichero, fichero.getBytes()));
			PruebasController.LOGGER.info("PRUEBA DE TIEMPOS SUBIDA PIF 2GB: final subidaFichero - " + nombreFichero
					+ " en la ruta " + bean.getRutaPif());
			PruebasController.LOGGER.info("PRUEBA DE TIEMPOS SUBIDA PIF-->PID 2GB: inicio PID");

			bean.setOid(this.pidService.addDocument(nombreFichero, bean.getRutaPif()));
			PruebasController.LOGGER.info("PRUEBA DE TIEMPOS SUBIDA PIF-->PID 2GB: fin PID - OID: " + bean.getOid());

		} catch (Exception e) {
			PruebasController.LOGGER.error("PRUEBA DE TIEMPOS SUBIDA PIF 2GB ERROR: ", e);
		}
		request.getSession().setAttribute(PruebasController.FICHERO, bean);
		return bean;
	}

	@RequestMapping(value = "/cargarSolicitudes", method = RequestMethod.POST)
	public @ResponseBody() Fichero cargarSolicitudes(@RequestJsonBody() Fichero fichero, HttpServletRequest request) {
		PruebasController.LOGGER.info("PRUEBAS: cargarSolicitudes");
		Fichero aux = (Fichero) request.getSession().getAttribute(PruebasController.FICHERO);
		String oid;
		try {
			oid = this.pidService.addDocument(aux.getNombre(), aux.getRutaPif());
			aux.setOid(oid);
			PruebasController.LOGGER.info("oid " + oid);
		} catch (Exception e) {
			PruebasController.LOGGER.info("pruebapid: ALEX - cargarSolicitudes Error: " + e);
		}
		request.getSession().removeAttribute(PruebasController.FICHERO);
		return aux;
	}

	@RequestMapping(value = "/procesarFichero")
	public @ResponseBody Fichero procesarFichero(@RequestParam(value = "ficheroFile") MultipartFile fichero,
			HttpServletRequest request, HttpServletResponse response) {
		PruebasController.LOGGER.info("PRUEBAS: Encriptar");
		String nombreFichero = fichero.getOriginalFilename();
		final String opcion = request.getParameter("opcion");

		Fichero bean = new Fichero();
		try {

			ByteArrayOutputStream baos = new ByteArrayOutputStream();
			AESCrypt aesCrypt = new AESCrypt("1111111");

			if ("E".equals(opcion)) {
				// Encriptar
				aesCrypt.encrypt(1, fichero.getInputStream(), baos);
			} else if ("D".equals(opcion)) {
				// Desencriptar
				aesCrypt.decrypt(fichero.getSize(), fichero.getInputStream(), baos);
			}

			bean.setBytes(baos.toByteArray());
			bean.setNombre(nombreFichero);
			bean.setContentType(fichero.getContentType());

		} catch (UnsupportedEncodingException e) {
			PruebasController.LOGGER.info("Error UnsupportedEncodingException: " + e);
			bean.setError("ERROR UnsupportedEncodingException");
		} catch (GeneralSecurityException e) {
			PruebasController.LOGGER.info("Error GeneralSecurityException: " + e);
			bean.setError("ERROR GeneralSecurityException");
		} catch (IOException e) {
			PruebasController.LOGGER.info("Error IOException: " + e);
			if (e.getLocalizedMessage().contains("password incorrect")) {
				bean.setError("La contraseña de desencriptación es incorrecta");
			} else if (e.getLocalizedMessage().contains("header")) {
				bean.setError("El archivo no está encriptado");
			} else {
				bean.setError("Error genérico");
			}
		}
		request.getSession().setAttribute(FICHEROFILE, bean);
		return bean;
	}

	@RequestMapping(value = "/pruebaAbrir")
	public void cargarSolicitudes(HttpServletRequest request, HttpServletResponse response) {
		PruebasController.LOGGER.info("PRUEBAS: cargarSolicitudes");
		Fichero aux = (Fichero) request.getSession().getAttribute(FICHEROFILE);

		response.setContentType(aux.getContentType());
		response.setHeader("Content-disposition", "attachment;filename=\"" + aux.getNombre() + "\"");

		response.setHeader("Pragma", "cache");
		response.setHeader("Expires", "0");
		response.setHeader("Cache-Control", "private");

		Cookie cookie = new Cookie("fileDownload", "true");
		cookie.setPath("/");
		cookie.setSecure(true);
		response.addCookie(cookie);

		ByteArrayOutputStream baos = new ByteArrayOutputStream(aux.getBytes().length);
		baos.write(aux.getBytes(), 0, aux.getBytes().length);
		response.setContentLength(aux.getBytes().length);
		OutputStream os;
		try {
			os = response.getOutputStream();
			baos.writeTo(os);
			os.flush();
			os.close();
		} catch (IOException e) {
			PruebasController.LOGGER.info("Error IOException: " + e);
		}

		request.getSession().removeAttribute(FICHEROFILE);
	}

	@RequestMapping(value = "/sendMail")
	public @ResponseBody String sendMail() {
		PruebasController.LOGGER.info("PRUEBAS: sendMail - Inicio");
		final List<String> listaDestinatarios = new ArrayList<String>();
		listaDestinatarios.add(Constants.DESTINATARIO_EMAIL_LOCAL);
		ParametrosEmail params = new ParametrosEmail();
		this.mailService.sendMailWithParameters(1, listaDestinatarios, params);
		PruebasController.LOGGER.info("PRUEBAS: sendMail - Fin");
		return null;
	}

	@RequestMapping(value = "/nora/maint")
	public ModelAndView noraLoad() {
		PruebasController.LOGGER.info("PRUEBAS: noraLoad");
		DireccionNora direccion = new DireccionNora();
		direccion.setDirNora(Constants.CERO);
		direccion = this.direccionNoraService.find(direccion);
		if (direccion == null) {
			direccion = new DireccionNora();
		}
		return new ModelAndView("ubicacionNora", "direccion", direccion);
	}

	@RequestMapping(value = "/nora/guardarUbic")
	public @ResponseBody() DireccionNora noraSave(@ModelAttribute() DireccionNora direccion) {
		PruebasController.LOGGER.info("PRUEBAS: noraSave");
		return this.direccionNoraService.update(direccion);
	}

	@RequestMapping(value = "/libroRegistro")
	public @ResponseBody() LibroRegistroModel libroRegistro() {
		PruebasController.LOGGER.info("PRUEBAS: libroRegistro");
		LibroRegistroModel libroRegistroEntrada = new LibroRegistroModel();
		libroRegistroEntrada.setMatter("Prueba Alta exp.");
		try {
			libroRegistroEntrada = this.registroPresencialWebService.altaRegistroEntrada(libroRegistroEntrada);
		} catch (Exception e) {
			PruebasController.LOGGER.error("libroRegistro: error" + e);
		}
		return libroRegistroEntrada;
	}

	/**
	 * @return String
	 */
	@RequestMapping(value = "/capas/maint", method = RequestMethod.GET)
	public String getCapas(Model model) {
		PruebasController.LOGGER.info("PRUEBAS: getCapas maint");
		return "capaspruebas";
	}

	/**
	 * @return String
	 */
	@RequestMapping(value = "/cargarJsp/{dispatch}", method = RequestMethod.GET)
	public ModelAndView cargarJspPruebas(@ModelAttribute() Expediente expediente, @PathVariable int dispatch) {
		PruebasController.LOGGER.info("PRUEBAS: getCapas maint");
		return new ModelAndView("capaspruebas" + dispatch, "expediente", expediente);
	}

	/**
	 *
	 * @param resultado
	 *            resultado
	 * @param model
	 *            model
	 * @param request
	 *            request
	 * @return String
	 * @throws ParserConfigurationException
	 * @throws IOException
	 * @throws SAXException
	 * @throws UnsupportedEncodingException
	 */
	@RequestMapping(value = "/procesoBatch", method = RequestMethod.GET)
	public @ResponseBody() String retornoO75(HttpServletRequest request) {
		String nomSh = "expPlazos.sh";

		RdoBatch rdo = this.batch.peticionBatch(request, nomSh, "", "AA79B - Exp. plazos");
		Locale locale = LocaleContextHolder.getLocale();

		if (rdo.isExito()) {
			return this.appMessageSource.getMessage("comun.mensajeBatchOk", new Object[] {}, locale);
		} else {
			PruebasController.LOGGER.info("lErrorCodigo", Long.valueOf(rdo.getlErrorCodigo()));
			PruebasController.LOGGER.info("sErrorDescripcion", rdo.getsErrorDescripcion());
			PruebasController.LOGGER.info("nErrorSQL", rdo.getnErrorSQL());
			PruebasController.LOGGER.info("sErrorMotivo", rdo.getsErrorMotivo());
			return rdo.getsErrorMotivo();
		}
	}

	/**
	 *
	 * @param request
	 *            HttpServletRequest
	 * @param response
	 *            HttpServletResponse
	 */
	@RequestMapping(value = "/descargarIcs", method = RequestMethod.GET)
	public void descargarIcs(HttpServletRequest request, HttpServletResponse response) {
		ICalendar ical = new ICalendar();
		VEvent event = new VEvent();
		event.setSummary("Reunión de equipo");
		event.setLocation("Barakaldo");
		event.setDescription("Reunión de seguimiento de Itzulnet");
		event.addAttendee("aa79b@eurohelp.local");

		Date start = new Date();
		event.setDateStart(start);

		Duration duration = new Duration.Builder().hours(1).build();
		event.setDuration(duration);

		Recurrence recur = new Recurrence.Builder(Frequency.WEEKLY).interval(2).build();
		event.setRecurrenceRule(recur);
		ical.addEvent(event);

		response.setContentType("text/calendar");
		response.setHeader("Content-disposition", "attachment;filename=myCalendar.ics");

		response.setHeader("Pragma", "cache");
		response.setHeader("Expires", "0");
		response.setHeader("Cache-Control", "private");

		Cookie cookie = new Cookie("fileDownload", "true");
		cookie.setPath("/");
		cookie.setSecure(true);
		response.addCookie(cookie);

		ByteArrayOutputStream baos = new ByteArrayOutputStream();
		try {
			Biweekly.write(ical).go(baos);
		} catch (IOException e) {
			PruebasController.LOGGER.error("Error al descargar ics: ", e);
		}
		response.setContentLength(baos.toByteArray().length);
		OutputStream os;
		try {
			os = response.getOutputStream();
			baos.writeTo(os);
			os.flush();
			os.close();
		} catch (IOException e) {
			PruebasController.LOGGER.info("Error IOException: " + e);
		}

	}

	/**
	 *
	 * @param laRuta
	 * @param nombreFich
	 * @param response
	 */
	@RequestMapping(value = "descargarOid", method = RequestMethod.GET)
	public void descargarOid(@RequestParam(value = "nombre", required = false) String nombre,
			@RequestParam(value = "oid", required = false) String oid, HttpServletResponse response) {
		PruebasController.LOGGER.info("[GET - View]: descargarDocPIF");

		// Se abre el documento
		response.setContentType("application/octet-stream");
		response.setHeader("Content-Disposition", "attachment; filename=\"" + nombre + "\"");
		response.setHeader("Pragma", "cache");
		response.setHeader("Expires", "0");
		response.setHeader("Cache-Control", "private");

		try {
			this.pidService.getDocument(oid, response.getOutputStream());
			response.flushBuffer();
		} catch (IOException e) {
			PruebasController.LOGGER.info("[GET - View]: IOException Error: ", e);
		} catch (Exception e) {
			PruebasController.LOGGER.info("[GET - View]: Exception Error: ", e);
		}

	}

}