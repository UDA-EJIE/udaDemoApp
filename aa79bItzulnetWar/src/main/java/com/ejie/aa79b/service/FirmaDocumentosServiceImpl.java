package com.ejie.aa79b.service;

import java.util.Locale;

import javax.servlet.http.HttpServletRequest;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.i18n.LocaleContextHolder;
import org.springframework.context.support.ReloadableResourceBundleMessageSource;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.dao.DocumentosGeneralDao;
import com.ejie.aa79b.model.DocumentoTareaAdjunto;
import com.ejie.aa79b.model.ListaDocumentoTareaAdjunto;
import com.ejie.aa79b.model.enums.EstadoFirmaEnum;
import com.ejie.aa79b.o75.Batch;

/**
 * firmaDocumentosServiceImpl generated by UDA, 16-May-2019 12:03:30.
 *
 * @author javarona
 */

@Service(value = "firmaDocumentosService")
public class FirmaDocumentosServiceImpl implements FirmaDocumentosService {

	@Autowired
	private DocumentosGeneralDao documentosGeneralDao;

	@Autowired()
	private Batch batch;

	@Autowired()
	private ReloadableResourceBundleMessageSource messageSource;

	private static final Logger LOGGER = LoggerFactory.getLogger(FirmaDocumentosServiceImpl.class);

	@Override()
	@Transactional(rollbackFor = Throwable.class)
	public ListaDocumentoTareaAdjunto firmarDocumento(ListaDocumentoTareaAdjunto listaDocumentoTareaAdjunto,
			HttpServletRequest request) {
		DocumentoTareaAdjunto documentoFinal = null;
		for (int x = 0; x < listaDocumentoTareaAdjunto.getListaDocumentoTareaAdjunto().size(); x++) {

			documentoFinal = listaDocumentoTareaAdjunto.getListaDocumentoTareaAdjunto().get(x);

			// Recuperar el próximo númExp del año actual
			this.documentosGeneralDao.updateEstadoFirma(documentoFinal, EstadoFirmaEnum.FIRMANDO.getValue());

			// Lamada al proceso Batch con el Id de la T0A8
			this.llamadaBatchFirmaDocumentos(documentoFinal, request);

		}

		// registro de acciones aquí o al acabar el proceso Batch?
		return listaDocumentoTareaAdjunto;

	}

	@Transactional(rollbackFor = Throwable.class)
	private void llamadaBatchFirmaDocumentos(DocumentoTareaAdjunto documentoFinal, HttpServletRequest request) {
		String nomSh = "firmarDoc.sh";

		final Locale locale = LocaleContextHolder.getLocale();
		final StringBuilder str = new StringBuilder();

		str.append(Constants.CONSTANTE_APLICACION)
				.append(this.messageSource.getMessage("label.firmaBatch", null, locale));
		FirmaDocumentosServiceImpl.LOGGER.info("......... LLAMADA A SH: firmarDoc.sh ..............");

		this.batch.peticionBatch(request, nomSh,
				"@@" + documentoFinal.getIdTarea() + "@@" + documentoFinal.getIdDocOriginal() + "@@", str.toString());

	}
}