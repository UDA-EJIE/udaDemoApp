package com.ejie.aa79b.service;

import java.util.LinkedHashMap;
import java.util.Locale;
import java.util.Map;

import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.support.ReloadableResourceBundleMessageSource;
import org.springframework.stereotype.Service;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.dao.GenericoDao;
import com.ejie.aa79b.dao.IvaPreciosDao;
import com.ejie.aa79b.dao.RegistroAccionesDao;
import com.ejie.aa79b.model.IvaPrecios;
import com.ejie.aa79b.model.RegistroAcciones;
import com.ejie.aa79b.utils.Utils;
import com.ejie.aa79b.utils.date.DateFormaterFactory;

/**
 * IvaPreciosServiceImpl generated by UDA, 15-dic-2017 14:11:45.
 * 
 * @author UDA
 */

@Service(value = "ivaPreciosService")
public class IvaPreciosServiceImpl extends GenericoServiceImpl<IvaPrecios> implements IvaPreciosService {

	@Autowired
	private IvaPreciosDao ivaPreciosDao;
	@Autowired()
	private RegistroAccionesDao registroAccionesDao;
	@Autowired()
	private ReloadableResourceBundleMessageSource msg;

	@Override
	protected GenericoDao<IvaPrecios> getDao() {
		return this.ivaPreciosDao;
	}

	@Override()
	public IvaPrecios add(IvaPrecios ivaprecios) {
		if (Constants.SI.equals(ivaprecios.getIndVigente())) {
			this.ivaPreciosDao.updateVigencia(ivaprecios);
		}
		IvaPrecios ivaPreciosAux = this.ivaPreciosDao.add(ivaprecios);

		RegistroAcciones regAcciones = new RegistroAcciones();
		regAcciones.setIdPuntoMenu(Constants.PUNTO_MENU_ORDEN_PRECIOS);
		regAcciones.setIdAccion(Constants.ACCION_ALTA);
		Locale locale = new Locale(Constants.LANG_EUSKERA);

		StringBuilder observ = new StringBuilder();
		observ.append(this.msg.getMessage("menu.ordenPreciosPublicos", null, locale)).append(" id: ")
				.append(ivaPreciosAux.getIdOrden()).append(" \n");
		observ.append(this.msg.getMessage("label.ivaYVigencia", null, locale)).append(" \n");

		observ.append(this.msg.getMessage("label.fechaDesde", null, locale)).append(": ").append(
				DateFormaterFactory.getInstance().getAa79bDateFormater().parse(ivaPreciosAux.getFechaDesdeVigencia()))
				.append(" - ");
		observ.append(this.msg.getMessage("label.fechaHasta", null, locale)).append(": ")
				.append((ivaPreciosAux.getFechaHastaVigencia() != null) ? DateFormaterFactory.getInstance()
						.getAa79bDateFormater().parse(ivaPreciosAux.getFechaHastaVigencia()) : "")
				.append(" \n");

		observ.append(this.msg.getMessage("label.iva", null, locale)).append(": ").append(ivaPreciosAux.getPorIva())
				.append(". ");
		observ.append(this.msg.getMessage("label.enVigor", null, locale)).append(": ")
				.append((ivaPreciosAux.getIndVigente() != null) ? ivaPreciosAux.getIndVigente() : Constants.NO)
				.append(". \n");

		regAcciones.setObserv(observ.toString());
		this.registroAccionesDao.add(regAcciones);

		return ivaPreciosAux;
	}

	@Override()
	public IvaPrecios update(IvaPrecios ivaprecios) {
		IvaPrecios original = this.ivaPreciosDao.find(ivaprecios);
		if (Constants.SI.equals(ivaprecios.getIndVigente())) {
			this.ivaPreciosDao.updateVigencia(ivaprecios);
		}
		IvaPrecios ivaPreciosAux = this.ivaPreciosDao.update(ivaprecios);

		if (ivaprecios.getIndVigente() == null) {
			ivaprecios.setIndVigente("N");
		}

		RegistroAcciones regAcciones = new RegistroAcciones();
		regAcciones.setIdPuntoMenu(Constants.PUNTO_MENU_ORDEN_PRECIOS);
		regAcciones.setIdAccion(Constants.ACCION_MODIFICACION);

		Map<String, String> paramAcciones = new LinkedHashMap<String, String>();
		paramAcciones.put("idOrden", "menu.ordenPreciosPublicos");
		paramAcciones.put("fechaDesdeVigencia", "label.fechaDesde");
		paramAcciones.put("fechaHastaVigencia", "label.fechaHasta");
		paramAcciones.put("porIva", "label.iva");
		paramAcciones.put("indVigente", "label.enVigor");

		Locale locale = new Locale(Constants.LANG_EUSKERA);
		String aux = Utils.observacionesRegistro(ivaprecios, original, paramAcciones, this.msg, locale);
		if (StringUtils.isNotBlank(aux)) {
			StringBuilder observ = new StringBuilder();
			observ.append(this.msg.getMessage("menu.ordenPreciosPublicos", null, locale)).append(" id: ")
					.append(original.getIdOrden()).append(" \n");
			observ.append(this.msg.getMessage("label.ivaYVigencia", null, locale)).append(" id: ")
					.append(original.getId()).append(" \n");
			observ.append(aux);
			regAcciones.setObserv(observ.toString());
			this.registroAccionesDao.add(regAcciones);
		}

		return ivaPreciosAux;
	}

	@Override()
	public IvaPrecios findIvaOrdePreciosPublicos() {
		return this.ivaPreciosDao.findIvaOrdePreciosPublicos();
	}

}