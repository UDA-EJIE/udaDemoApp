package com.ejie.aa79b.service;

import java.util.Locale;

import javax.servlet.http.HttpServletRequest;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.i18n.LocaleContextHolder;
import org.springframework.context.support.ReloadableResourceBundleMessageSource;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.dao.GenericoDao;
import com.ejie.aa79b.dao.ServicioClonacionExpedientesDao;
import com.ejie.aa79b.model.Clonacion;
import com.ejie.aa79b.o75.Batch;

/**
 * TiposRevisionServiceImpl generated by UDA, 28-nov-2017 15:23:30.
 * 
 * @author javarona
 */

@Service(value = "servicioClonacionExpedientesService")
public class ServicioClonacionExpedientesServiceImpl extends GenericoServiceImpl<Clonacion>
		implements ServicioClonacionExpedientesService {

	@Autowired
	private ServicioClonacionExpedientesDao clonacionDao;

	@Autowired()
	private Batch batch;

	@Autowired()
	private ReloadableResourceBundleMessageSource messageSource;

	@Override
	protected GenericoDao<Clonacion> getDao() {
		return this.clonacionDao;
	}

	@Override()
	@Transactional(rollbackFor = Throwable.class)
	public Clonacion clonarExpediente(Clonacion clonacion, HttpServletRequest request) {

		// Recuperar el próximo númExp del año actual
		Clonacion clonacionConClon = this.clonacionDao.getNuevoNumExp(clonacion);

		// Alta en TA08
		clonacionConClon = this.clonacionDao.add(clonacionConClon);

		// Lamada al proceso Batch con el Id de la T0A8
		this.llamadaBatchClonacion(clonacion, request);

		// registro de acciones aquí o al acabar el proceso Batch?
		return clonacionConClon;
	}

	@Transactional(rollbackFor = Throwable.class)
	private void llamadaBatchClonacion(Clonacion clonacion, HttpServletRequest request) {
		String nomSh = "clonarExp.sh";

		final Locale locale = LocaleContextHolder.getLocale();
		final StringBuilder str = new StringBuilder();
		str.append(Constants.CONSTANTE_APLICACION).append(Constants.ESPACIO).append(Constants.GUION)
				.append(Constants.ESPACIO).append(this.messageSource.getMessage("label.clon", null, locale));
		this.batch.peticionBatch(request, nomSh, String.valueOf(clonacion.getId()), str.toString());

	}
}