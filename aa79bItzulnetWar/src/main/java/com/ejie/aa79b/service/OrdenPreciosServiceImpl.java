package com.ejie.aa79b.service;

import java.util.LinkedHashMap;
import java.util.Locale;
import java.util.Map;

import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.support.ReloadableResourceBundleMessageSource;
import org.springframework.stereotype.Service;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.dao.CuantiaInterDao;
import com.ejie.aa79b.dao.CuantiaRevDao;
import com.ejie.aa79b.dao.CuantiaTradDao;
import com.ejie.aa79b.dao.GenericoDao;
import com.ejie.aa79b.dao.IvaPreciosDao;
import com.ejie.aa79b.dao.OrdenPreciosDao;
import com.ejie.aa79b.dao.RegistroAccionesDao;
import com.ejie.aa79b.dao.TarifExpTradRevDao;
import com.ejie.aa79b.model.CuantiaInter;
import com.ejie.aa79b.model.CuantiaRev;
import com.ejie.aa79b.model.CuantiaTrad;
import com.ejie.aa79b.model.IvaPrecios;
import com.ejie.aa79b.model.OrdenPrecios;
import com.ejie.aa79b.model.RegistroAcciones;
import com.ejie.aa79b.model.TarifExpTradRev;
import com.ejie.aa79b.utils.Utils;
import com.ejie.aa79b.utils.date.DateFormaterFactory;

/**
 * OrdenPreciosServiceImpl generated by UDA, 15-dic-2017 14:11:45.
 * 
 * @author UDA
 */
@Service(value = "ordenPreciosService")
public class OrdenPreciosServiceImpl extends GenericoServiceImpl<OrdenPrecios> implements OrdenPreciosService {

    @Autowired
    private OrdenPreciosDao ordenPreciosDao;
    @Autowired
    private IvaPreciosDao ivaPreciosDao;
    @Autowired()
    private RegistroAccionesDao registroAccionesDao;
    @Autowired()
    private ReloadableResourceBundleMessageSource msg;
    @Autowired
    private CuantiaTradDao cuantiasTradDao;
    @Autowired
    private CuantiaRevDao cuantiasRevDao;

    @Autowired
    private TarifExpTradRevDao tarifExpTradRevDao;
    @Autowired
    private CuantiaInterDao cuantiaInterDao;

    @Override
    protected GenericoDao<OrdenPrecios> getDao() {
        return this.ordenPreciosDao;
    }

    @Override()
    public OrdenPrecios add(OrdenPrecios ordenprecios) {
        OrdenPrecios ordenPreciosSave = ordenprecios;
        if (ordenprecios.getId() == null) {
            ordenPreciosSave = this.ordenPreciosDao.add(ordenprecios);
            // Se guarda el nuevo registro del Iva
            final IvaPrecios ivaPrecios = ordenprecios.getIvaVigente();
            ivaPrecios.setIdOrden(ordenPreciosSave.getId());
            ivaPrecios.setIndVigente(Constants.SI);
            this.ivaPreciosDao.add(ivaPrecios);

            RegistroAcciones regOrdenprecios = new RegistroAcciones();
            regOrdenprecios.setIdPuntoMenu(Constants.PUNTO_MENU_ORDEN_PRECIOS);
            regOrdenprecios.setIdAccion(Constants.ACCION_ALTA);
            Locale locale = new Locale(Constants.LANG_EUSKERA);
            StringBuilder observ = new StringBuilder();
            observ.append(this.msg.getMessage("label.datosGenerales", null, locale)).append(": ")
                    .append(ordenprecios.getTitulo()).append(": \n");
            observ.append(this.msg.getMessage("label.tituloOrden", null, locale)).append(": ")
                    .append(ordenprecios.getTitulo()).append(": \n");
            observ.append(this.msg.getMessage("label.fechaEntrada", null, locale)).append(": ").append(
                    DateFormaterFactory.getInstance().getAa79bDateFormater().parse(ordenprecios.getFechaVigor()))
                    .append(" - ");
            observ.append(this.msg.getMessage("label.fechaFin", null, locale)).append(": ")
                    .append((ordenprecios.getFechaFinVigor() != null) ? DateFormaterFactory.getInstance()
                            .getAa79bDateFormater().parse(ordenprecios.getFechaFinVigor()) : "")
                    .append(". ");
            observ.append(this.msg.getMessage("label.enVigor", null, locale)).append(": ")
                    .append((ordenprecios.getIndVigor() != null) ? ordenprecios.getIndVigor() : Constants.NO)
                    .append(". \n");
            observ.append(this.msg.getMessage("label.url", null, locale)).append(": ")
                    .append(ordenprecios.getUrlOrden()).append(". \n");
            regOrdenprecios.setObserv(observ.toString());
            this.registroAccionesDao.add(regOrdenprecios);
        } else {
            OrdenPrecios original = this.ordenPreciosDao.find(ordenprecios);
            ordenPreciosSave = this.ordenPreciosDao.update(ordenprecios);
            if (ordenprecios.getIndVigor() == null) {
                ordenprecios.setIndVigor(Constants.NO);
            }
            RegistroAcciones regOrdenprecios = new RegistroAcciones();
            regOrdenprecios.setIdPuntoMenu(Constants.PUNTO_MENU_ORDEN_PRECIOS);
            regOrdenprecios.setIdAccion(Constants.ACCION_MODIFICACION);

            Map<String, String> paramOrdenprecios = new LinkedHashMap<String, String>();
            paramOrdenprecios.put("titulo", "label.tituloOrden");
            paramOrdenprecios.put("fechaVigor", "label.fechaEntrada");
            paramOrdenprecios.put("fechaFinVigor", "label.fechaFin");
            paramOrdenprecios.put("indVigor", "label.enVigor");
            paramOrdenprecios.put("urlOrden", "label.url");
            Locale locale = new Locale(Constants.LANG_EUSKERA);
            String aux = Utils.observacionesRegistro(ordenprecios, original, paramOrdenprecios, this.msg, locale);
            if (StringUtils.isNotBlank(aux)) {
                StringBuilder observ = new StringBuilder();
                observ.append(this.msg.getMessage("label.datosGenerales", null, locale)).append(": ")
                        .append(original.getTitulo()).append(" (id=").append(original.getId()).append("): \n");
                observ.append(aux);
                regOrdenprecios.setObserv(observ.toString());
                this.registroAccionesDao.add(regOrdenprecios);
            }
        }
        return ordenPreciosSave;
    }

    @Override()
    public OrdenPrecios generarPdf(OrdenPrecios ordenprecios) {
        final OrdenPrecios ordenPreciosAux = this.find(ordenprecios);
        final IvaPrecios iva = new IvaPrecios();
        iva.setIdOrden(ordenPreciosAux.getId());
        ordenPreciosAux.setListaIva(this.ivaPreciosDao.findAllLike(iva, null, false));
        final CuantiaTrad cuantiaTrad = new CuantiaTrad();
        cuantiaTrad.setIdOrden(ordenprecios.getId());
        ordenPreciosAux.setListaCuantiaTrad(this.cuantiasTradDao.findAllLike(cuantiaTrad, null, false));
        final CuantiaRev cuantiaRev = new CuantiaRev();
        cuantiaRev.setIdOrden(ordenprecios.getId());
        ordenPreciosAux.setListaCuantiaRev(this.cuantiasRevDao.findAllLike(cuantiaRev, null, false));

        final TarifExpTradRev tarifExpTradRev = new TarifExpTradRev();
        tarifExpTradRev.setIdOrden(ordenprecios.getId());
        ordenPreciosAux.setTarifExpTradRev(this.tarifExpTradRevDao.find(tarifExpTradRev));

        final CuantiaInter cuantiaInter = new CuantiaInter();
        cuantiaInter.setIdOrden(ordenprecios.getId());
        ordenPreciosAux.setCuantiaInter(this.cuantiaInterDao.find(cuantiaInter));

        return ordenPreciosAux;
    }

    /**
     * 
     * @param ordenprecios
     *            OrdenPrecios
     * @return boolean
     */
    @Override
    public boolean comprobarOrdenes(OrdenPrecios ordenprecios) {
        final Long count = this.ordenPreciosDao.comprobarOrdenes(ordenprecios);
        return count > 0 ? true : false;
    }
}