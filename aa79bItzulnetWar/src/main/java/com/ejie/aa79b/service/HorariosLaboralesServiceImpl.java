package com.ejie.aa79b.service;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;

import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.support.ReloadableResourceBundleMessageSource;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.dao.GenericoDao;
import com.ejie.aa79b.dao.HorariosLaboralesDao;
import com.ejie.aa79b.dao.HorasHorariosLaboralesDao;
import com.ejie.aa79b.dao.RegistroAccionesDao;
import com.ejie.aa79b.model.HorariosLaborales;
import com.ejie.aa79b.model.HorasHorariosLaborales;
import com.ejie.aa79b.model.RegistroAcciones;
import com.ejie.aa79b.utils.Utils;
import com.ejie.x38.dto.JQGridRequestDto;
import com.ejie.x38.dto.JQGridResponseDto;
import com.ejie.x38.dto.TableRowDto;

/**
 * HorariosLaboralesServiceImpl generated by UDA, 21-nov-2017 14:44:52.
 * 
 * @author UDA
 */

@Service(value = "horariosLaboralesService")
public class HorariosLaboralesServiceImpl extends GenericoServiceImpl<HorariosLaborales>
        implements HorariosLaboralesService {

    protected static final String LUNES_JUEVES = "label.lunesJueves";
    protected static final String VIERNES = "label.viernes";
    protected static final String VERANO = "label.horario.verano";
    protected static final String INVIERNO = "label.horario.invierno";
    
    @Autowired
    private HorariosLaboralesDao horariosLaboralesDao;
    @Autowired
    private HorasHorariosLaboralesDao horasHorariosDao;
    @Autowired()
    private RegistroAccionesDao registroAccionesDao;
    @Autowired()
    private ReloadableResourceBundleMessageSource msg;
    
    @Override()
    protected GenericoDao<HorariosLaborales> getDao() {
        return this.horariosLaboralesDao;
    }

    @Override()
    @Transactional(rollbackFor = Throwable.class)
    public HorariosLaborales add(HorariosLaborales horariosLaborales) {

        HorariosLaborales horarioslaboralesAux = this.horariosLaboralesDao.add(horariosLaborales);

        List<HorasHorariosLaborales> horasHorarioses = horariosLaborales.getHorasHorarioses();
        for (HorasHorariosLaborales horasHorarios : horasHorarioses) {
            horasHorarios.setIdHorario039(horarioslaboralesAux.getId038());
            this.horasHorariosDao.add(horasHorarios);
        }
        
      //Registro de acciones...
        if (horarioslaboralesAux.getIndActivo038() == null){
            horarioslaboralesAux.setIndActivo038("N");
        }
        RegistroAcciones regHorariosAtencion = new RegistroAcciones();
        regHorariosAtencion.setIdPuntoMenu(Constants.PUNTO_MENU_HORARIO_LABORAL);
        regHorariosAtencion.setIdAccion(Constants.ACCION_ALTA);
        Locale locale = new Locale(Constants.LANG_EUSKERA);
        
        StringBuilder observ = new StringBuilder();
        observ.append(" (id=").append(horarioslaboralesAux.getId038()).append("): ");        
        observ.append(this.msg.getMessage("label.activo", null, locale)).append(": ").append(horarioslaboralesAux.getIndActivo038()).append(".\n");
                
        HorasHorariosLaborales horasHorariosesNuevo = horariosLaborales.getHorasHorarioses().get(0);  
        observ.append(this.msg.getMessage(INVIERNO, null, locale)+", "+this.msg.getMessage(LUNES_JUEVES, null, locale)).append(": ").append(horasHorariosesNuevo.getComparaLJ()).append(".\n");
        observ.append(this.msg.getMessage(INVIERNO, null, locale)+", "+this.msg.getMessage(VIERNES, null, locale)).append(": ").append(horasHorariosesNuevo.getComparaV()).append(".\n");
        
        horasHorariosesNuevo = horariosLaborales.getHorasHorarioses().get(1);  
        observ.append(this.msg.getMessage(VERANO, null, locale)+", "+this.msg.getMessage(LUNES_JUEVES, null, locale)).append(": ").append(horasHorariosesNuevo.getComparaLJ()).append(".\n");
        observ.append(this.msg.getMessage(VERANO, null, locale)+", "+this.msg.getMessage(VIERNES, null, locale)).append(": ").append(horasHorariosesNuevo.getComparaV()).append(".\n");
        
        regHorariosAtencion.setObserv(observ.toString());
        this.registroAccionesDao.add(regHorariosAtencion);    
        
        
        return horarioslaboralesAux;
    }
    
    @Override()
    @Transactional(rollbackFor = Throwable.class)
    public HorariosLaborales update(HorariosLaborales horariosLaborales) {
        HorariosLaborales original =  this.find(horariosLaborales);
                
        HorariosLaborales horarioslaboralesAux = this.horariosLaboralesDao.update(horariosLaborales);
        List<HorasHorariosLaborales> horasHorarioses = horariosLaborales.getHorasHorarioses();
        for (HorasHorariosLaborales horasHorarios : horasHorarioses) {
            this.horasHorariosDao.update(horasHorarios);
        }
      //Registro de acciones...
        if (horarioslaboralesAux.getIndActivo038() == null){
            horarioslaboralesAux.setIndActivo038("N");
        }
        RegistroAcciones regHorariosLaboral = new RegistroAcciones();
        regHorariosLaboral.setIdPuntoMenu(Constants.PUNTO_MENU_HORARIO_LABORAL);
        regHorariosLaboral.setIdAccion(Constants.ACCION_MODIFICACION);
        
        Map<String, String> paramHorariosLaboral = new LinkedHashMap<String, String>();        
        paramHorariosLaboral.put("indActivo038", "label.activo");
               
        Locale locale = new Locale(Constants.LANG_EUSKERA);
        String aux = Utils.observacionesRegistro(horarioslaboralesAux, original, paramHorariosLaboral, this.msg, locale);
        
        //Comprobar cambios hor.invierno
        HorasHorariosLaborales horasHorariosesOrig = original.getHorasHorarioses().get(0);
        HorasHorariosLaborales horasHorariosesNuevo = horariosLaborales.getHorasHorarioses().get(0);        
        Map<String, String> paramHorasHorariosLaborales = new LinkedHashMap<String, String>();
        paramHorasHorariosLaborales.put("comparaLJ", this.msg.getMessage(INVIERNO, null, locale)+", "+this.msg.getMessage(LUNES_JUEVES, null, locale));
        paramHorasHorariosLaborales.put("comparaV", this.msg.getMessage(INVIERNO, null, locale)+", "+this.msg.getMessage(VIERNES, null, locale));
        StringBuilder auxHorarios = new StringBuilder(Utils.observacionesRegistro(horasHorariosesNuevo, horasHorariosesOrig, paramHorasHorariosLaborales, this.msg, locale));
      
        //Comprobar cambios hor.verano
        horasHorariosesOrig = original.getHorasHorarioses().get(1);
        horasHorariosesNuevo = horariosLaborales.getHorasHorarioses().get(1);        
        paramHorasHorariosLaborales = new LinkedHashMap<String, String>();
        paramHorasHorariosLaborales.put("comparaLJ", this.msg.getMessage(VERANO, null, locale)+", "+this.msg.getMessage(LUNES_JUEVES, null, locale));
        paramHorasHorariosLaborales.put("comparaV", this.msg.getMessage(VERANO, null, locale)+", "+this.msg.getMessage(VIERNES, null, locale));
        auxHorarios.append(Utils.observacionesRegistro(horasHorariosesNuevo, horasHorariosesOrig, paramHorasHorariosLaborales, this.msg, locale));
        
        if ((StringUtils.isNotBlank(aux)) || (StringUtils.isNotBlank(auxHorarios.toString()))) {
            StringBuilder observ = new StringBuilder();
            observ.append(" (id=").append(original.getId038()).append("): ");
            observ.append(this.msg.getMessage("label.activo", null, locale)).append(": ").append(horarioslaboralesAux.getIndActivo038()).append(".\n");
            observ.append(aux);
            observ.append(auxHorarios);
            regHorariosLaboral.setObserv(observ.toString());
            this.registroAccionesDao.add(regHorariosLaboral);
        }      
        return horarioslaboralesAux;
    }

    @Override()
    public HorariosLaborales find(HorariosLaborales horariosLaborales) {

        HorariosLaborales horarioslaboralesAux = this.horariosLaboralesDao.find(horariosLaborales);

        HorasHorariosLaborales filterHorasHorarios = new HorasHorariosLaborales();
        filterHorasHorarios.setIdsHorariosLaborales(new ArrayList<Long>(Arrays.asList(horariosLaborales.getId038())));

        List<HorasHorariosLaborales> listaHorasHorarios = this.horasHorariosDao.findAllLike(filterHorasHorarios, null,
                false);
        horarioslaboralesAux.setHorasHorarioses(listaHorasHorarios);

        return horarioslaboralesAux;
    }

    @Override()
    public JQGridResponseDto<HorariosLaborales> filter(HorariosLaborales filterHorariosLaborales,
            JQGridRequestDto jqGridRequestDto, Boolean startsWith) {

        List<HorariosLaborales> listaHorariosLaborales = this.horariosLaboralesDao.findAllLike(filterHorariosLaborales,
                jqGridRequestDto, false);
        HorasHorariosLaborales filterHorasHorarios = new HorasHorariosLaborales();
        List<Long> idsHL = new ArrayList<Long>();

        // Resumen: Tratarlo
        for (HorariosLaborales horariosLaborales : listaHorariosLaborales) {
            // AÃ±ado el id de HorLab a la lista
            idsHL.add(horariosLaborales.getId038());
        }
        filterHorasHorarios.setIdsHorariosLaborales(idsHL);

        List<HorasHorariosLaborales> listaHorasHorarios = this.horasHorariosDao.findAllLike(filterHorasHorarios, null,
                false);

        // Ahora tengo las dos listas...como las recorro sin dar 1000 pasadas?
        for (HorariosLaborales horariosLaborales : listaHorariosLaborales) {
            for (HorasHorariosLaborales horasHorarios : listaHorasHorarios) {
                if (horasHorarios.getIdHorario039() == horariosLaborales.getId038()) {
                    horariosLaborales.getHorasHorarioses().add(horasHorarios);
                }
            }
        }

        Long recordNum = this.horariosLaboralesDao.findAllLikeCount(
                filterHorariosLaborales != null ? filterHorariosLaborales : new HorariosLaborales(), false);
        if (jqGridRequestDto.getMultiselection().getSelectedIds() != null) {
            List<TableRowDto<HorariosLaborales>> reorderSelection = this.horariosLaboralesDao
                    .reorderSelection(filterHorariosLaborales, jqGridRequestDto, startsWith);
            return new JQGridResponseDto<HorariosLaborales>(jqGridRequestDto, recordNum, listaHorariosLaborales,
                    reorderSelection);
        }
        return new JQGridResponseDto<HorariosLaborales>(jqGridRequestDto, recordNum, listaHorariosLaborales);
    }

}