package com.ejie.aa79b.service;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;

import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.support.ReloadableResourceBundleMessageSource;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.dao.GenericoDao;
import com.ejie.aa79b.dao.HorariosAtencionDao;
import com.ejie.aa79b.dao.HorasHorariosAtencionDao;
import com.ejie.aa79b.dao.RegistroAccionesDao;
import com.ejie.aa79b.model.HorariosAtencion;
import com.ejie.aa79b.model.HorasHorariosAtencion;
import com.ejie.aa79b.model.RegistroAcciones;
import com.ejie.aa79b.utils.Utils;
import com.ejie.x38.dto.JQGridRequestDto;
import com.ejie.x38.dto.JQGridResponseDto;
import com.ejie.x38.dto.TableRowDto;

/**
 * HorariosAtencionServiceImpl generated by UDA, 21-nov-2017 14:44:52.
 * 
 * @author UDA
 */

@Service(value = "horariosAtencionService")
public class HorariosAtencionServiceImpl extends GenericoServiceImpl<HorariosAtencion>
        implements HorariosAtencionService {

    protected static final String LUNES_JUEVES = "label.lunesJueves";
    protected static final String VIERNES = "label.viernes";
    protected static final String VERANO = "label.horario.verano";
    protected static final String INVIERNO = "label.horario.invierno";
    
    @Autowired
    private HorariosAtencionDao horariosAtencionDao;
    @Autowired
    private HorasHorariosAtencionDao horasHorariosDao;
    @Autowired()
    private RegistroAccionesDao registroAccionesDao;
    @Autowired()
    private ReloadableResourceBundleMessageSource msg;
    
    @Override()
    protected GenericoDao<HorariosAtencion> getDao() {
        return this.horariosAtencionDao;
    }
    
    @Override()
    @Transactional(rollbackFor = Throwable.class)
    public HorariosAtencion add(HorariosAtencion horariosAtencion) {

        HorariosAtencion horariosatencionAux = this.horariosAtencionDao.add(horariosAtencion);

        List<HorasHorariosAtencion> horasHorarioses = horariosAtencion.getHorasHorarioses();
        for (HorasHorariosAtencion horasHorarios : horasHorarioses) {
            horasHorarios.setIdHorario021(horariosatencionAux.getId020());
            this.horasHorariosDao.add(horasHorarios);
        }
        
        //Registro de acciones...
        if (horariosatencionAux.getIndActivo020() == null){
            horariosatencionAux.setIndActivo020("N");
        }
        RegistroAcciones regHorariosAtencion = new RegistroAcciones();
        regHorariosAtencion.setIdPuntoMenu(Constants.PUNTO_MENU_HORARIO_ATENCION);
        regHorariosAtencion.setIdAccion(Constants.ACCION_ALTA);
        Locale locale = new Locale(Constants.LANG_EUSKERA);
        
        StringBuilder observ = new StringBuilder();
        observ.append(" (id=").append(horariosatencionAux.getId020()).append("): ");
        observ.append(this.msg.getMessage("label.tipoHorario", null, locale)).append(": ").append(horariosatencionAux.getNivelUsuario020()).append(". ");
        observ.append(this.msg.getMessage("label.activo", null, locale)).append(": ").append(horariosatencionAux.getIndActivo020()).append(".\n");
                
        HorasHorariosAtencion horasHorariosesNuevo = horariosAtencion.getHorasHorarioses().get(0);  
        observ.append(this.msg.getMessage(INVIERNO, null, locale)+", "+this.msg.getMessage(LUNES_JUEVES, null, locale)).append(": ").append(horasHorariosesNuevo.getComparaLJ()).append(".\n");
        observ.append(this.msg.getMessage(INVIERNO, null, locale)+", "+this.msg.getMessage(VIERNES, null, locale)).append(": ").append(horasHorariosesNuevo.getComparaV()).append(".\n");
        
        horasHorariosesNuevo = horariosAtencion.getHorasHorarioses().get(1);  
        observ.append(this.msg.getMessage(VERANO, null, locale)+", "+this.msg.getMessage(LUNES_JUEVES, null, locale)).append(": ").append(horasHorariosesNuevo.getComparaLJ()).append(".\n");
        observ.append(this.msg.getMessage(VERANO, null, locale)+", "+this.msg.getMessage(VIERNES, null, locale)).append(": ").append(horasHorariosesNuevo.getComparaV()).append(".\n");
        
        regHorariosAtencion.setObserv(observ.toString());
        this.registroAccionesDao.add(regHorariosAtencion);       
        
        return horariosatencionAux;
    }

    @Override()
    @Transactional(rollbackFor = Throwable.class)
    public HorariosAtencion update(HorariosAtencion horariosAtencion) {
        HorariosAtencion original =  this.find(horariosAtencion);
                
        HorariosAtencion horariosatencionAux = this.horariosAtencionDao.update(horariosAtencion);
        List<HorasHorariosAtencion> horasHorarioses = horariosAtencion.getHorasHorarioses();
        for (HorasHorariosAtencion horasHorarios : horasHorarioses) {
            this.horasHorariosDao.update(horasHorarios);
        }
        //Registro de acciones...
        if (horariosatencionAux.getIndActivo020() == null){
            horariosatencionAux.setIndActivo020("N");
        }
        RegistroAcciones regHorariosAtencion = new RegistroAcciones();
        regHorariosAtencion.setIdPuntoMenu(Constants.PUNTO_MENU_HORARIO_ATENCION);
        regHorariosAtencion.setIdAccion(Constants.ACCION_MODIFICACION);
        
        Map<String, String> paramHorariosAtencion = new LinkedHashMap<String, String>();
        paramHorariosAtencion.put("nivelUsuario020", "label.tipoHorario");
        paramHorariosAtencion.put("indActivo020", "label.activo");
               
        Locale locale = new Locale(Constants.LANG_EUSKERA);
        String aux = Utils.observacionesRegistro(horariosatencionAux, original, paramHorariosAtencion, this.msg, locale);
        
        //Comprobar cambios hor.invierno
        HorasHorariosAtencion horasHorariosesOrig = original.getHorasHorarioses().get(0);
        HorasHorariosAtencion horasHorariosesNuevo = horariosAtencion.getHorasHorarioses().get(0);        
        Map<String, String> paramHorasHorariosAtencion = new LinkedHashMap<String, String>();
        paramHorasHorariosAtencion.put("comparaLJ", this.msg.getMessage(INVIERNO, null, locale)+", "+this.msg.getMessage(LUNES_JUEVES, null, locale));
        paramHorasHorariosAtencion.put("comparaV", this.msg.getMessage(INVIERNO, null, locale)+", "+this.msg.getMessage(VIERNES, null, locale));
        StringBuilder auxHorarios = new StringBuilder(Utils.observacionesRegistro(horasHorariosesNuevo, horasHorariosesOrig, paramHorasHorariosAtencion, this.msg, locale));
      
        //Comprobar cambios hor.verano
        horasHorariosesOrig = original.getHorasHorarioses().get(1);
        horasHorariosesNuevo = horariosAtencion.getHorasHorarioses().get(1);        
        paramHorasHorariosAtencion = new LinkedHashMap<String, String>();
        paramHorasHorariosAtencion.put("comparaLJ", this.msg.getMessage(VERANO, null, locale)+", "+this.msg.getMessage(LUNES_JUEVES, null, locale));
        paramHorasHorariosAtencion.put("comparaV", this.msg.getMessage(VERANO, null, locale)+", "+this.msg.getMessage(VIERNES, null, locale));
        auxHorarios.append(Utils.observacionesRegistro(horasHorariosesNuevo, horasHorariosesOrig, paramHorasHorariosAtencion, this.msg, locale));
        
        if ((StringUtils.isNotBlank(aux)) || (StringUtils.isNotBlank(auxHorarios.toString()))) {
            StringBuilder observ = new StringBuilder();
            observ.append(" (id=").append(original.getId020()).append("): ");
            observ.append(this.msg.getMessage("label.tipoHorario", null, locale)).append(": ").append(horariosatencionAux.getNivelUsuario020()).append(", ");
            observ.append(this.msg.getMessage("label.activo", null, locale)).append(": ").append(horariosatencionAux.getIndActivo020()).append(".\n");
            observ.append(aux);
            observ.append(auxHorarios);
            regHorariosAtencion.setObserv(observ.toString());
            this.registroAccionesDao.add(regHorariosAtencion);
        }        
        return horariosatencionAux;
    }

    @Override()
    public HorariosAtencion find(HorariosAtencion horariosAtencion) {

        HorariosAtencion horariosatencionAux = this.horariosAtencionDao.find(horariosAtencion);

        HorasHorariosAtencion filterHorasHorarios = new HorasHorariosAtencion();
        filterHorasHorarios.setIdsHorariosAtencion(new ArrayList<Long>(Arrays.asList(horariosAtencion.getId020())));

        List<HorasHorariosAtencion> listaHorasHorarios = this.horasHorariosDao.findAllLike(filterHorasHorarios, null,
                false);
        horariosatencionAux.setHorasHorarioses(listaHorasHorarios);

        return horariosatencionAux;
    }

    @Override()
    public JQGridResponseDto<HorariosAtencion> filter(HorariosAtencion filterHorariosAtencion,
            JQGridRequestDto jqGridRequestDto, Boolean startsWith) {

        List<HorariosAtencion> listaHorariosAtencion = this.horariosAtencionDao.findAllLike(filterHorariosAtencion,
                jqGridRequestDto, false);
        HorasHorariosAtencion filterHorasHorarios = new HorasHorariosAtencion();
        List<Long> idsHL = new ArrayList<Long>();

        // Resumen: Tratarlo
        for (HorariosAtencion horariosAtencion : listaHorariosAtencion) {
            // AÃ±ado el id de HorLab a la lista
            idsHL.add(horariosAtencion.getId020());
        }
        filterHorasHorarios.setIdsHorariosAtencion(idsHL);

        List<HorasHorariosAtencion> listaHorasHorarios = this.horasHorariosDao.findAllLike(filterHorasHorarios, null,
                false);

        // Ahora tengo las dos listas...como las recorro sin dar 1000 pasadas?
        for (HorariosAtencion horariosAtencion : listaHorariosAtencion) {
            for (HorasHorariosAtencion horasHorarios : listaHorasHorarios) {
                if (horasHorarios.getIdHorario021() == horariosAtencion.getId020()) {
                    horariosAtencion.getHorasHorarioses().add(horasHorarios);
                }
            }
        }

        Long recordNum = this.horariosAtencionDao.findAllLikeCount(
                filterHorariosAtencion != null ? filterHorariosAtencion : new HorariosAtencion(), false);
        if (jqGridRequestDto.getMultiselection().getSelectedIds() != null) {
            List<TableRowDto<HorariosAtencion>> reorderSelection = this.horariosAtencionDao
                    .reorderSelection(filterHorariosAtencion, jqGridRequestDto, startsWith);
            return new JQGridResponseDto<HorariosAtencion>(jqGridRequestDto, recordNum, listaHorariosAtencion,
                    reorderSelection);
        }
        return new JQGridResponseDto<HorariosAtencion>(jqGridRequestDto, recordNum, listaHorariosAtencion);
    }

}