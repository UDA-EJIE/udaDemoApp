package com.ejie.aa79b.service;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.dao.FacturasDao;
import com.ejie.aa79b.dao.GenericoDao;
import com.ejie.aa79b.dao.SolicitanteDao;
import com.ejie.aa79b.model.DatosFacturacionExpedienteInterpretacion;
import com.ejie.aa79b.model.Entidad;
import com.ejie.aa79b.model.EstadoFactura;
import com.ejie.aa79b.model.Facturas;
import com.ejie.aa79b.model.Fichero;
import com.ejie.aa79b.model.Persona;
import com.ejie.aa79b.model.Solicitante;
import com.ejie.aa79b.model.webservices.Aa79bEntradaConsultaFacturas;
import com.ejie.aa79b.model.webservices.Aa79bExpediente;
import com.ejie.aa79b.model.webservices.Aa79bSalidaConsultaFacturas;
import com.ejie.aa79b.utils.DateUtils;
import com.ejie.x38.dto.JQGridRequestDto;
import com.ejie.x38.dto.JQGridResponseDto;

/**
 * TareasGeneralServiceImpl generated by UDA, 28-nov-2017 15:23:30.
 * 
 * @author UDA
 */

@Service(value = "facturasService")
public class FacturasServiceImpl extends GenericoServiceImpl<Facturas> implements FacturasService {

	@Autowired()
	private FacturasDao facturasDao;

	@Autowired()
	private SolicitanteDao solicitanteDao;

	@Override
	public List<Entidad> findEntidadesFactura(Entidad entidadFilter) {
		return this.facturasDao.findEntidadesFactura(entidadFilter);
	}

	@Override
	public List<Persona> findContactoDeEntidadFaturas(Facturas facturasFilter) {
		return this.facturasDao.findContactoDeEntidadFaturas(facturasFilter);
	}

	@Override
	public Fichero getDocumentoFactura(Facturas bean) {
		return this.facturasDao.getDocumentoFactura(bean);
	}

	@Override
	public List<EstadoFactura> estadosFactura(boolean facturaE, boolean baja) {
		return this.facturasDao.estadosFactura(facturaE, baja);
	}

	@Override
	public JQGridResponseDto<Facturas> facturasFilter(Facturas filterFacturas, JQGridRequestDto jqGridRequestDto,
			boolean startsWith) {

		List<Facturas> listaT = this.facturasDao.filterFacturas(filterFacturas, jqGridRequestDto, false);
		Long recordNum = this.facturasDao.filterFacturasCount(filterFacturas, false);

		return new JQGridResponseDto<Facturas>(jqGridRequestDto, recordNum, listaT);
	}

	@Override
	protected GenericoDao<Facturas> getDao() {
		return this.facturasDao;
	}

	@Override
	public List<String> getTitulosExpedienteFacturados(String dni) {

		List<String> titulosExpediente = null;

		Solicitante solicitante = new Solicitante();
		solicitante.setDni(dni);
		solicitante = this.solicitanteDao.find(solicitante);

		if (solicitante != null && solicitante.getEntidad() != null) {
			titulosExpediente = this.facturasDao.getTitulosExpedienteFacturados(solicitante.getEntidad());
		}

		return titulosExpediente;
	}

	@Override
	public JQGridResponseDto<Aa79bSalidaConsultaFacturas> consultaFacturas(Aa79bEntradaConsultaFacturas bean,
			JQGridRequestDto jqGridRequestDto, boolean b) {

		Solicitante solicitante = new Solicitante();
		solicitante.setDni(bean.getDni());
		solicitante = this.solicitanteDao.find(solicitante);

		Facturas factura = new Facturas();

		factura.setIdFactura(bean.getIdFactura());

		factura.setFechaEmisionIni(
				DateUtils.obtFechaHoraFormateada(bean.getFechaEmisionIni(), Constants.HORA_MINUTOS_CERO));
		factura.setFechaEmisionFin(
				DateUtils.obtFechaHoraFormateada(bean.getFechaEmisionFin(), Constants.HORA_MINUTOS_CERO));
		DatosFacturacionExpedienteInterpretacion datosFacturacion = new DatosFacturacionExpedienteInterpretacion();
		EstadoFactura estadoFactura = new EstadoFactura();
		estadoFactura.setIndEstadoFactura(bean.getIdEstadoFactura());
		datosFacturacion.setEstadoFactura(estadoFactura);
		factura.setDatosFacturacionInterpretacion(datosFacturacion);
		factura.setDniContacto(bean.getDniContacto());
		Persona persona = new Persona();
		persona.setNombre(bean.getNombreContacto());
		persona.setApellido1(bean.getApellidosContacto());
		factura.setPersona(persona);
		factura.setAnyoExp(bean.getAnyoExp());
		factura.setNumExp(bean.getNumExp());
		factura.setTituloExp(bean.getTituloExp());

		if (solicitante != null && solicitante.getEntidad() != null) {
			factura.setIdEntidadAsoc((long) solicitante.getEntidad().getCodigo());
			factura.setTipoEntidadAsoc(solicitante.getEntidad().getTipo());
		}

		@SuppressWarnings("unchecked")
		List<Aa79bSalidaConsultaFacturas> listaFacturas = (List<Aa79bSalidaConsultaFacturas>) this.facturasDao
				.consultaFacturas(factura, bean.getIdioma(), jqGridRequestDto, false, false);

		Long recordNum = 0L;
		if (listaFacturas != null && !listaFacturas.isEmpty()) {
			recordNum = (Long) this.facturasDao.consultaFacturas(factura, bean.getIdioma(), jqGridRequestDto, false,
					true);
		}

		if (jqGridRequestDto != null) {
			return new JQGridResponseDto<Aa79bSalidaConsultaFacturas>(jqGridRequestDto, recordNum, listaFacturas);
		} else {
			return new JQGridResponseDto<Aa79bSalidaConsultaFacturas>(new JQGridRequestDto(), recordNum, listaFacturas);
		}
	}

	@Override
	public Facturas findDetalleFactura(Long idFactura) {
		return this.facturasDao.findDetalleFactura(idFactura);
	}

	@Override
	public boolean getAccesoFactura(String dni, Long idFactura) {
		boolean accesoFactura = false;

		Solicitante solicitante = new Solicitante();
		solicitante.setDni(dni);
		solicitante = this.solicitanteDao.find(solicitante);

		if (solicitante != null && solicitante.getEntidad() != null) {
			Facturas factura = new Facturas();
			factura.setIdEntidadAsoc((long) solicitante.getEntidad().getCodigo());
			factura.setTipoEntidadAsoc(solicitante.getEntidad().getTipo());
			factura.setIdFactura(idFactura);

			accesoFactura = this.facturasDao.getAccesoFactura(factura);
		}

		return accesoFactura;
	}

	@Override
	public Fichero findDocumentoFactura(Long idFactura) {
		return this.facturasDao.findDocumentoFactura(idFactura);
	}

	@Override
	public Fichero findCartaPago(Long idFactura) {
		return this.facturasDao.findCartaPago(idFactura);
	}

	@Override
	public JQGridResponseDto<Aa79bExpediente> expedientesFacturaTraduccion(Long idFactura,
			JQGridRequestDto jqGridRequestDto, boolean b) {
		@SuppressWarnings("unchecked")
		List<Aa79bExpediente> listaExpedientes = (List<Aa79bExpediente>) this.facturasDao
				.expedientesFacturaTraduccion(idFactura, jqGridRequestDto, false, false);

		Long recordNum = 0L;
		if (listaExpedientes != null && !listaExpedientes.isEmpty()) {
			recordNum = (Long) this.facturasDao.expedientesFacturaTraduccion(idFactura, jqGridRequestDto, false, true);
		}

		if (jqGridRequestDto != null) {
			return new JQGridResponseDto<Aa79bExpediente>(jqGridRequestDto, recordNum, listaExpedientes);
		} else {
			return new JQGridResponseDto<Aa79bExpediente>(new JQGridRequestDto(), recordNum, listaExpedientes);
		}
	}

	@Override
	public JQGridResponseDto<Aa79bExpediente> expedientesFacturaInterpretacion(Long idFactura,
			JQGridRequestDto jqGridRequestDto, boolean b) {
		@SuppressWarnings("unchecked")
		List<Aa79bExpediente> listaExpedientes = (List<Aa79bExpediente>) this.facturasDao
				.expedientesFacturaInterpretacion(idFactura, jqGridRequestDto, false, false);

		Long recordNum = 0L;
		if (listaExpedientes != null && !listaExpedientes.isEmpty()) {
			recordNum = (Long) this.facturasDao.expedientesFacturaInterpretacion(idFactura, jqGridRequestDto, false,
					true);
		}

		if (jqGridRequestDto != null) {
			return new JQGridResponseDto<Aa79bExpediente>(jqGridRequestDto, recordNum, listaExpedientes);
		} else {
			return new JQGridResponseDto<Aa79bExpediente>(new JQGridRequestDto(), recordNum, listaExpedientes);
		}
	}

}