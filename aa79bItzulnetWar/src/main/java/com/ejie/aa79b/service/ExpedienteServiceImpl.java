package com.ejie.aa79b.service;

import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.Date;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Properties;

import org.apache.commons.lang.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.support.ReloadableResourceBundleMessageSource;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.dao.Aa79bSolicitudWsDao;
import com.ejie.aa79b.dao.BitacoraExpedienteDao;
import com.ejie.aa79b.dao.CalendarioServicioDao;
import com.ejie.aa79b.dao.ConfigCalculoPresupuestoDao;
import com.ejie.aa79b.dao.DatosContactoDao;
import com.ejie.aa79b.dao.DatosPersonaDao;
import com.ejie.aa79b.dao.ExpedienteDao;
import com.ejie.aa79b.dao.ExpedienteInterpretacionDao;
import com.ejie.aa79b.dao.ExpedienteTradRevDao;
import com.ejie.aa79b.dao.ExpedientesRelacionadosDao;
import com.ejie.aa79b.dao.GenericoDao;
import com.ejie.aa79b.dao.GestorExpedienteDao;
import com.ejie.aa79b.dao.MotivosrechazoDao;
import com.ejie.aa79b.dao.RechazoExpedienteDao;
import com.ejie.aa79b.dao.RegistroAccionesDao;
import com.ejie.aa79b.dao.SolicitanteDao;
import com.ejie.aa79b.dao.TareasDao;
import com.ejie.aa79b.mail.MailService;
import com.ejie.aa79b.model.AnulacionRechazo;
import com.ejie.aa79b.model.BitacoraExpediente;
import com.ejie.aa79b.model.BitacoraSolicitante;
import com.ejie.aa79b.model.CamposSelecSub;
import com.ejie.aa79b.model.CamposSubsanacion;
import com.ejie.aa79b.model.ConfigCalculoPresupuesto;
import com.ejie.aa79b.model.DatosContacto;
import com.ejie.aa79b.model.DocumentoTareaAdjunto;
import com.ejie.aa79b.model.DocumentosExpediente;
import com.ejie.aa79b.model.DocusSelecSub;
import com.ejie.aa79b.model.EntradaFechaFinalizacion;
import com.ejie.aa79b.model.EntradaGestoresRepresentante;
import com.ejie.aa79b.model.EstadosExpediente;
import com.ejie.aa79b.model.Expediente;
import com.ejie.aa79b.model.ExpedientePlanificacion;
import com.ejie.aa79b.model.ExpedienteTradRev;
import com.ejie.aa79b.model.FasesExpediente;
import com.ejie.aa79b.model.GestorExpediente;
import com.ejie.aa79b.model.ListaExpediente;
import com.ejie.aa79b.model.Motivosrechazo;
import com.ejie.aa79b.model.ParametrosEmail;
import com.ejie.aa79b.model.PersonalIZO;
import com.ejie.aa79b.model.RechazoExpediente;
import com.ejie.aa79b.model.RegistroAcciones;
import com.ejie.aa79b.model.SalidaFechaFinalizacion;
import com.ejie.aa79b.model.Solicitante;
import com.ejie.aa79b.model.SubsanacionExpediente;
import com.ejie.aa79b.model.Tareas;
import com.ejie.aa79b.model.TiposTarea;
import com.ejie.aa79b.model.enums.AccionBitacoraEnum;
import com.ejie.aa79b.model.enums.AccionesEnum;
import com.ejie.aa79b.model.enums.EstadoAceptacionTareaEnum;
import com.ejie.aa79b.model.enums.EstadoExpedienteEnum;
import com.ejie.aa79b.model.enums.FaseExpedienteEnum;
import com.ejie.aa79b.model.enums.PuntosMenuEnum;
import com.ejie.aa79b.model.enums.TipoAvisoEnum;
import com.ejie.aa79b.model.enums.TipoCierreEnum;
import com.ejie.aa79b.model.enums.TipoExpedienteEnum;
import com.ejie.aa79b.model.enums.TipoRecursoEnum;
import com.ejie.aa79b.model.enums.TipoTareaGestionAsociadaEnum;
import com.ejie.aa79b.model.webservices.Aa79bExpedienteRelacionado;
import com.ejie.aa79b.model.webservices.Aa79bSolicitud;
import com.ejie.aa79b.security.Usuario;
import com.ejie.aa79b.utils.ExpedienteDaoUtils;
import com.ejie.aa79b.utils.TareasServiceUtils;
import com.ejie.aa79b.utils.Utils;
import com.ejie.aa79b.webservices.EventosService;
import com.ejie.x38.dto.JQGridRequestDto;
import com.ejie.x38.dto.JQGridResponseDto;
import com.ejie.x38.dto.TableRowDto;
/**
 * ExpedienteServiceImpl generated by UDA, 31-ene-2018 15:08:48.
 *
 * @author UDA
 */

@Service(value = "expedienteService")
public class ExpedienteServiceImpl extends GenericoServiceImpl<Expediente> implements ExpedienteService {

	@Autowired()
	private Properties appConfiguration;
	@Autowired
	private Aa79bSolicitudWsDao aa79bSolicitudWsDao;
	@Autowired
	private TareasDao tareasDao;
	@Autowired
	private ExpedienteDao expedienteDao;

	@Autowired
	private MotivosrechazoDao motivosRechazoDao;

	@Autowired()
	private RegistroAccionesDao registroAccionesDao;
	@Autowired()
	private ReloadableResourceBundleMessageSource appMessageSource;
	@Autowired
	private ExpedienteInterpretacionDao expedienteInterpretacionDao;
	@Autowired
	private ExpedienteTradRevDao expedienteTradRevDao;
	@Autowired
	private GestorExpedienteDao gestorExpedienteDao;
	@Autowired
	private BitacoraExpedienteDao bitacoraExpedienteDao;
	@Autowired()
	private PersonalIZOService personalIZOService;
	@Autowired()
	private CalendarioServicioDao calendarioServicioDao;
	@Autowired()
	private SolicitanteDao solicitanteDao;
	@Autowired()
	private ConfigCalculoPresupuestoDao configCalculoPresupuestoDao;
	@Autowired()
	private DatosContactoDao datosContactoDao;
	@Autowired()
	private DocumentosGeneralService documentosGeneralService;
	@Autowired()
	private RechazoExpedienteDao rechazoExpedienteDao;
	@Autowired
	private DatosPersonaDao datosPersonaDao;
	@Autowired()
	private MailService mailService;
	@Autowired
	private EventosService eventosService;
	@Autowired()
	private ReloadableResourceBundleMessageSource msg;
	@Autowired()
	private ExpedientesRelacionadosDao expedientesRelacionadosDao;

	private static final Logger LOGGER = LoggerFactory.getLogger(ExpedienteServiceImpl.class);

	@Override
	protected GenericoDao<Expediente> getDao() {
		return this.expedienteDao;
	}

	@Override()
	@Transactional(rollbackFor = Throwable.class)
	public Expediente add(Expediente expediente) {
		Expediente expedienteAux = this.expedienteDao.add(expediente);
		if (expediente.getExpedienteInterpretacion() != null) {
			expedienteAux.setExpedienteInterpretacion(
					this.expedienteInterpretacionDao.add(expediente).getExpedienteInterpretacion());
		}
		if (expediente.getExpedienteTradRev() != null) {
			expedienteAux.setExpedienteTradRev(this.expedienteTradRevDao.add(expediente.getExpedienteTradRev()));
		}
		if (expediente.getGestorExpediente() != null) {
			expedienteAux.setGestorExpediente(this.gestorExpedienteDao.add(expediente).getGestorExpediente());
		}
		if (expediente.getBitacoraExpediente() != null) {
			final BitacoraExpediente bitacora = expediente.getBitacoraExpediente();
			bitacora.setAnyo(expediente.getAnyo());
			bitacora.setNumExp(expediente.getNumExp());
			expedienteAux.setBitacoraExpediente(this.bitacoraExpedienteDao.add(bitacora));
		}
		if(expediente.getExpedienteTradRev() != null) {
			if (StringUtils.isNotBlank(expediente.getExpedienteTradRev().getRefTramitagune())) {
				List<Expediente> listExp = this.aa79bSolicitudWsDao.getExpedientesRefAplic(expediente);
				if(listExp.size() > 0) {
					this.expedientesRelacionadosDao.addLista(listExp, expediente);
				}
			}
		}

		return expedienteAux;
	}

	@Override
	@Transactional(rollbackFor = Throwable.class)
	public Expediente update(Expediente expediente) {
		Expediente expedienteAux = this.expedienteDao.update(expediente);
		if (expediente.getExpedienteInterpretacion() != null) {
			expedienteAux.setExpedienteInterpretacion(
					this.expedienteInterpretacionDao.update(expediente).getExpedienteInterpretacion());
		}
		if (expediente.getExpedienteTradRev() != null) {
			expedienteAux.setExpedienteTradRev(this.expedienteTradRevDao.update(expediente.getExpedienteTradRev()));
		}
		if (expediente.getGestorExpediente() != null) {
			expedienteAux.setGestorExpediente(this.gestorExpedienteDao.update(expediente).getGestorExpediente());
		}
		if (expediente.getBitacoraExpediente() != null) {
			final BitacoraExpediente bitacora = expediente.getBitacoraExpediente();
			bitacora.setAnyo(expediente.getAnyo());
			bitacora.setNumExp(expediente.getNumExp());
			expedienteAux.setBitacoraExpediente(this.bitacoraExpedienteDao.update(bitacora));
		}

		return expedienteAux;
	}

	@Override
	@Transactional(rollbackFor = Throwable.class)
	public List<Expediente> findAll(Expediente bean, JQGridRequestDto jqGridRequestDto) {
		List<Expediente> listaExpedientes = new ArrayList<Expediente>();
		listaExpedientes = this.expedienteDao.findAll(bean, jqGridRequestDto);

		return listaExpedientes;

	}

	@Override
	@Transactional(rollbackFor = Throwable.class)
	public List<Expediente> findAllLike(Expediente bean, JQGridRequestDto jqGridRequestDto, Boolean startsWith) {
		List<Expediente> listaExpedientes = new ArrayList<Expediente>();
		listaExpedientes = this.expedienteDao.findAllLike(bean, jqGridRequestDto, startsWith);

		return listaExpedientes;

	}

	@Override
	@Transactional(rollbackFor = Throwable.class)
	public Integer modificarEstado(Expediente expedientes) {
		return this.expedienteDao.modificarEstado(expedientes);
	}

	@Override
	public JQGridResponseDto<Expediente> filtroExpedienteEstadoEnEstudio(Expediente filterExpediente,
			JQGridRequestDto jqGridRequestDto, boolean startsWith) {
		List<Expediente> listaT = this.expedienteDao.filtroExpedienteEstadoEnEstudio(filterExpediente, jqGridRequestDto,
				false);
		Long recordNum = this.expedienteDao.filtroExpedienteEstadoEnEstudioCount(filterExpediente, false);

		if (jqGridRequestDto.getMultiselection().getSelectedIds() != null) {
			List<TableRowDto<Expediente>> reorderSelection = this.expedienteDao.reorderSelection(filterExpediente,
					jqGridRequestDto, startsWith);
			return new JQGridResponseDto<Expediente>(jqGridRequestDto, recordNum, listaT, reorderSelection);
		}
		return new JQGridResponseDto<Expediente>(jqGridRequestDto, recordNum, listaT);
	}

	@Override
	public JQGridResponseDto<Expediente> filtroExpedienteEstadoEnCurso(Expediente filterExpediente,
			JQGridRequestDto jqGridRequestDto, boolean startsWith) {
		List<Expediente> listaT = this.expedienteDao.filtroExpedienteEstadoEnCurso(filterExpediente, jqGridRequestDto,
				false);
		Long recordNum = this.expedienteDao.filtroExpedienteEstadoEnCursoCount(filterExpediente, false);

		if (jqGridRequestDto.getMultiselection().getSelectedIds() != null) {
			List<TableRowDto<Expediente>> reorderSelection = this.expedienteDao.reorderSelection(filterExpediente,
					jqGridRequestDto, startsWith);
			return new JQGridResponseDto<Expediente>(jqGridRequestDto, recordNum, listaT, reorderSelection);
		}
		return new JQGridResponseDto<Expediente>(jqGridRequestDto, recordNum, listaT);
	}

	@Override
	public Integer asignarTecnicoAExpedientes(ListaExpediente listaExpedientes) {
		// si no está, guardar tecnico en 77
		if (ExpedienteDaoUtils.listaExpedientesValido(listaExpedientes)
				&& listaExpedientes.getListaExpediente().get(0).getTecnico() != null) {
			boolean esta = this.datosPersonaDao
					.comprobarPersona(listaExpedientes.getListaExpediente().get(0).getTecnico().getDni());
			if (!esta) {
				PersonalIZO personalIZO = new PersonalIZO();
				personalIZO.setDni(listaExpedientes.getListaExpediente().get(0).getTecnico().getDni());
				PersonalIZO personalAInsertar = this.personalIZOService.find(personalIZO);

				this.expedienteDao.guardarPersona(personalAInsertar);
			}

		// Se obtienen los expedientes para los que hay que realizar una
		// inserción en la bitácora
		final List<Expediente> listaExpBitacoras = this.expedienteDao.obtenerNuevasBitacoras(listaExpedientes);
		if (listaExpBitacoras != null && !listaExpBitacoras.isEmpty()) {
			// Se añade la bitácora
			this.bitacoraExpedienteDao.addBitacoraListaExpedientes(listaExpBitacoras);
			// Se modifica el estado del expediente
			this.expedienteDao.modificarEstadoListaExpedientes(listaExpBitacoras);
		}

		// Se actualiza el técnico
		this.expedienteDao.asignarTecnicoAExpedientes(listaExpedientes);

		// Se actualiza el registro de acciones
		return this.registroAccionesDao.addRegistroListaExpedientes(listaExpedientes);
	} else {
			return 0;
		}
	}

	/**
	 * Funcion para obtener los expedientes no relacionados con el expediente pasado
	 * por parametro
	 *
	 */
	@Override
	public JQGridResponseDto<Expediente> obtenerExpedientesRelacionados(Expediente filterExpediente,
			JQGridRequestDto jqGridRequestDto, boolean startsWith, boolean noRelacionados) {
		List<Expediente> listaT = this.expedienteDao.obtenerExpedientesRelacionados(filterExpediente, jqGridRequestDto,
				false, noRelacionados);
		Long recordNum = this.expedienteDao.obtenerExpedientesRelacionadosCount(filterExpediente, false,
				noRelacionados);

		if (jqGridRequestDto.getMultiselection().getSelectedIds() != null) {
			List<TableRowDto<Expediente>> reorderSelection = this.expedienteDao.reorderSelection(filterExpediente,
					jqGridRequestDto, startsWith);
			return new JQGridResponseDto<Expediente>(jqGridRequestDto, recordNum, listaT, reorderSelection);
		}
		return new JQGridResponseDto<Expediente>(jqGridRequestDto, recordNum, listaT);
	}

	/**
	 *
	 * Relacionar expedientes (expedienteRelacionado.anyoExpRel y
	 * expedienteRelacionado.numExpRel) con el expediente pasado en los anyo y
	 * numExp
	 */

	@Override
	public ListaExpediente relacionarExpedientes(ListaExpediente listaExpedientes) {
		ListaExpediente listaExpedientesRelacionados = new ListaExpediente();
		List<Expediente> lista = new ArrayList<Expediente>();
		for (Expediente expedienteARelacionar : listaExpedientes.getListaExpediente()) {
			Integer guardado = this.expedienteDao.guardarRelacionExpediente(expedienteARelacionar);
			if (guardado == 0) {
				return null;
			} else {
				Expediente expediente = new Expediente();
				expediente.setAnyo(expedienteARelacionar.getExpedienteRelacionado().getAnyoExpRel());
				expediente.setNumExp(expedienteARelacionar.getExpedienteRelacionado().getNumExpRel());
				lista.add(this.expedienteDao.find(expediente));
			}
		}
		listaExpedientesRelacionados.setListaExpediente(lista);
		return listaExpedientesRelacionados;
	}

	@Override
	public Integer rechazarExpCambioEstadoExp(Expediente expedientes, RechazoExpediente rechazoExp) {
		return this.rechazarExpediente(expedientes, rechazoExp, "C");
	}

	@Override
	public Integer rechazarExpediente(Expediente expedientes, RechazoExpediente rechazoExp, String procedencia) {
		RechazoExpediente motivoRechazo = this.registrarMotivo(rechazoExp);
		Expediente expediente = this.expedienteDao.find(expedientes);

		Motivosrechazo motivo = new Motivosrechazo();
		motivo.setId013(rechazoExp.getIdMotivoRechazo());
		motivo = this.motivosRechazoDao.find(motivo);
		rechazoExp.setMotivo(motivo);

		// Registro de acciones (Tabla 43)
		this.registrarAcciones(expediente, motivoRechazo.getMotivoRechazoDesc(), procedencia);

		BitacoraExpediente bExp = new BitacoraExpediente();

		bExp.setAnyo(expediente.getAnyo());
		bExp.setNumExp(expediente.getNumExp());

		EstadosExpediente estado = new EstadosExpediente();
		estado.setId(Long.valueOf(EstadoExpedienteEnum.RECHAZADO.getValue()));
		bExp.setEstadoExp(estado);

		FasesExpediente fase = new FasesExpediente();
		fase.setId(Long.valueOf(FaseExpedienteEnum.RECHAZADO.getValue()));
		bExp.setFaseExp(fase);

		bExp.setDatoAdic("");
		bExp.setIdMotivoRechazo(Long.valueOf(motivoRechazo.getId067()));
		expediente.setBitacoraExpediente(bExp);

		this.bitacoraExpedienteDao.add(bExp);
		this.expedienteDao.modificarEstado(expediente);

		BitacoraSolicitante bitacoraSolicitante = new BitacoraSolicitante();
		bitacoraSolicitante.setAnyo(expediente.getAnyo());
		bitacoraSolicitante.setNumExp(expediente.getNumExp());
		bitacoraSolicitante.setUsuario(Constants.IZO);
		this.bitacoraExpedienteDao.addBitacoraSolicitante(bitacoraSolicitante,
				AccionBitacoraEnum.RECHAZO_EXP.getValue());

		expedientes = this.expedienteDao.getOrigenExpediente(expedientes);
		List<String> rutasPif = new ArrayList<String>();
		if(StringUtils.isNotBlank(expedientes.getOrigen()) && expedientes.getOrigen().equals("W") && StringUtils.isNotBlank(expedientes.getAplicacionOrigen())) {
			ExpedienteServiceImpl.LOGGER.info("AnulacionesServiceImpl.createCambioFecha");
			AnulacionRechazo anulacionRechazo = new AnulacionRechazo();
			anulacionRechazo.setMotivoDescEs(motivo.getDescEs013());
			anulacionRechazo.setMotivoDescEu(motivo.getDescEu013());
			if(rechazoExp.getObservacionesRechazo() != null) {
				anulacionRechazo.setObservaciones(rechazoExp.getObservacionesRechazo().getObsvRechazo068());
			}
			expedientes.setAnulacionRechazo(anulacionRechazo);
			this.eventosService.createInvoiceCambioEstado(expedientes, rutasPif, TipoCierreEnum.RECHAZADO.getValue());
		}

		return enviarEmailRechazoExp(expediente, motivoRechazo);
	}

	private RechazoExpediente registrarMotivo(RechazoExpediente rechazoExpediente) {
		Long recordNum = this.rechazoExpedienteDao.findMotivosCount();
		if (recordNum != null) {
			rechazoExpediente.setId067(recordNum);
			this.rechazoExpedienteDao.addMotivoRechazo(rechazoExpediente);
			this.rechazoExpedienteDao.addDescRechazo(rechazoExpediente);
		}
		return rechazoExpediente;
	}

	/**
	 * Se registra una nueva accion en la tabla 43 (Registro de acciones)
	 *
	 * @param bean              Expediente
	 * @param descMotivoRechazo String
	 */
	public void registrarAcciones(Expediente bean, String descMotivoRechazo, String procedencia) {
		RegistroAcciones reg = new RegistroAcciones();
		Long idPuntoMenu;
		if ("E".equals(procedencia)) {
			// Procedencia: Estudio de expedientes
			idPuntoMenu = PuntosMenuEnum.TRAMITACION_EXPEDIENTES.getValue();
		} else if ("P".equals(procedencia)) {
			// Procedencia: Planificación de expedientes
			idPuntoMenu = PuntosMenuEnum.PLANIFICACION_EXPEDIENTES.getValue();
		} else {
			// Procedencia ("C"): Servicio de cambio de estado del expediente
			idPuntoMenu = PuntosMenuEnum.SERVICIO_CAMBIO_ESTADO_EXP.getValue();
		}
		reg.setIdPuntoMenu(idPuntoMenu);
		reg.setIdAccion(AccionesEnum.MODIFICACION.getValue());

		Locale locale = new Locale(Constants.LANG_EUSKERA);
		StringBuilder observ = new StringBuilder();
		observ.append(this.msg.getMessage("mensaje.expedienteRechazado", null, locale)).append(" ");
		observ.append(descMotivoRechazo).append(" \n");
		reg.setAnyo(bean.getAnyo());
		reg.setNumExp(bean.getNumExp());
		reg.setIdEstadoBitacora(bean.getEstadoBitacora());
		reg.setObserv(observ.toString());
		this.registroAccionesDao.add(reg);
	}

	@Override
	public Integer finalizarEstudio(Expediente expedientes, JQGridRequestDto jqGridRequestDto, Boolean startsWith) {

		BitacoraExpediente bExp = new BitacoraExpediente();

		bExp.setAnyo(expedientes.getAnyo());
		bExp.setNumExp(expedientes.getNumExp());

		FasesExpediente fases = new FasesExpediente();
		fases.setId(Long.valueOf(FaseExpedienteEnum.PDTE_EJECT_TAREAS.getValue()));
		bExp.setFaseExp(fases);

		EstadosExpediente estado = new EstadosExpediente();
		estado.setId(Long.valueOf(EstadoExpedienteEnum.EN_CURSO.getValue()));
		bExp.setEstadoExp(estado);

		bExp.setIdMotivoRechazo(null);
		bExp.setDatoAdic("");
		expedientes.setBitacoraExpediente(bExp);

		this.bitacoraExpedienteDao.add(bExp);

		if (!TipoExpedienteEnum.INTERPRETACION.getValue().equals(expedientes.getIdTipoExpediente())) {
			BitacoraSolicitante bitacoraSolicitanteFilter = new BitacoraSolicitante();
			bitacoraSolicitanteFilter.setAnyo(expedientes.getAnyo());
			bitacoraSolicitanteFilter.setNumExp(expedientes.getNumExp());
			bitacoraSolicitanteFilter.setUsuario(Constants.IZO);
			this.bitacoraExpedienteDao.addBitacoraSolicitante(bitacoraSolicitanteFilter,
					AccionBitacoraEnum.EXP_EN_CURSO.getValue());
		}

		return this.expedienteDao.modificarEstado(expedientes);
	}

	@Override
	public Integer finAltaOficio(Expediente expedientes, JQGridRequestDto jqGridRequestDto, Boolean startsWith) {

		BitacoraExpediente bExp = new BitacoraExpediente();

		bExp.setAnyo(expedientes.getAnyo());
		bExp.setNumExp(expedientes.getNumExp());

		FasesExpediente fases = new FasesExpediente();
		fases.setId(Long.valueOf(FaseExpedienteEnum.PDTE_EJECT_TAREAS.getValue()));
		bExp.setFaseExp(fases);

		EstadosExpediente estado = new EstadosExpediente();
		estado.setId(Long.valueOf(EstadoExpedienteEnum.EN_CURSO.getValue()));
		bExp.setEstadoExp(estado);

		bExp.setIdMotivoRechazo(null);
		bExp.setDatoAdic("");
		expedientes.setBitacoraExpediente(bExp);

		this.bitacoraExpedienteDao.add(bExp);

		if (!TipoExpedienteEnum.INTERPRETACION.getValue().equals(expedientes.getIdTipoExpediente())) {
			BitacoraSolicitante bitacoraSolicitanteFilter = new BitacoraSolicitante();
			bitacoraSolicitanteFilter.setAnyo(expedientes.getAnyo());
			bitacoraSolicitanteFilter.setNumExp(expedientes.getNumExp());
			bitacoraSolicitanteFilter.setUsuario(Constants.IZO);
			this.bitacoraExpedienteDao.addBitacoraSolicitante(bitacoraSolicitanteFilter,
					AccionBitacoraEnum.EXP_EN_CURSO.getValue());
		}

		return this.expedienteDao.modificarEstado(expedientes);
	}

	@Override
	public List<CamposSubsanacion> findAllCamposSubsanacion(String tipoExp) {

		return this.expedienteDao.findCamposSub(tipoExp);
	}

	@Override
	public GestorExpediente getDatosContacto(Expediente expediente) {
		return this.gestorExpedienteDao.getDatosContacto(expediente);
	}

	@Override
	public SubsanacionExpediente registrarSubsanacion(SubsanacionExpediente subsanacionExpediente,
			String camposSelecSub, String docuSelecSub, Expediente expediente) {

		Long idSub = this.expedienteDao.getNextVal("AA79B64Q00");
		subsanacionExpediente.setId(idSub);
		this.expedienteDao.registrarSubsanacion(subsanacionExpediente);

		CamposSelecSub campoSeleccionado = new CamposSelecSub();
		DocusSelecSub docuSeleccionado = new DocusSelecSub();

		campoSeleccionado.setId065(idSub);
		for (String selecCampos : camposSelecSub.split(";")) {
			if (!selecCampos.isEmpty()) {
				campoSeleccionado.setIdcampo065(Long.valueOf(selecCampos));
				this.expedienteDao.putCampoSubsanacion(campoSeleccionado);
			}
		}

		docuSeleccionado.setId066(idSub);
		for (String descDocu : docuSelecSub.split(";")) {
			if (!descDocu.isEmpty()) {
				docuSeleccionado.setIddoc066(Long.valueOf(descDocu));
				this.expedienteDao.putDocuSubsanacion(docuSeleccionado);
			}
		}

		Expediente exp = this.expedienteDao.find(expediente);

		BitacoraExpediente bExp = new BitacoraExpediente();
		Locale locale = new Locale(Constants.LANG_EUSKERA);
		bExp.setDatoAdic(this.msg.getMessage("label.requiereSub", null, locale));

		bExp.setAnyo(expediente.getAnyo());
		bExp.setNumExp(expediente.getNumExp());

		SubsanacionExpediente subExp = new SubsanacionExpediente();
		subExp.setId(idSub);
		bExp.setSubsanacionExp(subExp);

		EstadosExpediente estado = new EstadosExpediente();
		estado.setId(Long.valueOf(EstadoExpedienteEnum.EN_ESTUDIO.getValue()));
		bExp.setEstadoExp(estado);

		FasesExpediente fases = new FasesExpediente();
		fases.setId(Long.valueOf(FaseExpedienteEnum.PDTE_TRAM_SUBSANACION.getValue()));
		bExp.setFaseExp(fases);

		bExp.setIdMotivoRechazo(null);
		exp.setBitacoraExpediente(bExp);

		this.bitacoraExpedienteDao.add(bExp);
		this.expedienteDao.modificarEstado(exp);

		BitacoraSolicitante bitacoraSolicitante = new BitacoraSolicitante();
		bitacoraSolicitante.setAnyo(expediente.getAnyo());
		bitacoraSolicitante.setNumExp(expediente.getNumExp());
		bitacoraSolicitante.setUsuario(Constants.IZO);
		this.bitacoraExpedienteDao.addBitacoraSolicitante(bitacoraSolicitante,
				AccionBitacoraEnum.REQU_SUBS_CLIENTE.getValue());

		return subsanacionExpediente;
	}

	@Transactional
	@Override
	public SubsanacionExpediente registrarSubsanacionTarea(SubsanacionExpediente subsanacionExpediente,
			String camposSelecSub, String docuSelecSub, Expediente expediente, Tareas tareas, Locale locale) {

		Usuario credentials = (Usuario) SecurityContextHolder.getContext().getAuthentication().getCredentials();
		Long idSub = this.expedienteDao.getNextVal("AA79B64Q00");
		subsanacionExpediente.setId(idSub);
		this.expedienteDao.registrarSubsanacion(subsanacionExpediente);

		Expediente exp = this.expedienteDao.find(expediente);

		RegistroAcciones registroAcciones = new RegistroAcciones();
		registroAcciones.setIdPuntoMenu(PuntosMenuEnum.REQUERIR_SUBSANACION.getValue());
		registroAcciones.setIdAccion(AccionesEnum.ALTA.getValue());
		registroAcciones.setAnyo(exp.getAnyo());
		registroAcciones.setNumExp(exp.getNumExp());
		registroAcciones.setObserv(this.appMessageSource.getMessage("label.subsanacionRealizada", null, locale)
				+ subsanacionExpediente.getFechaLimite());
		registroAcciones.setIdEstadoBitacora(exp.getEstadoBitacora());
		this.registroAccionesDao.add(registroAcciones);

		BitacoraExpediente bExp = new BitacoraExpediente();
		bExp.setDatoAdic(this.msg.getMessage("label.requiereSub", null, locale));
		bExp.setAnyo(expediente.getAnyo());
		bExp.setNumExp(expediente.getNumExp());

		SubsanacionExpediente subExp = new SubsanacionExpediente();
		subExp.setId(idSub);
		bExp.setSubsanacionExp(subExp);

		EstadosExpediente estado = new EstadosExpediente();
		estado.setId(Long.valueOf(EstadoExpedienteEnum.EN_CURSO.getValue()));
		bExp.setEstadoExp(estado);

		FasesExpediente fases = new FasesExpediente();
		fases.setId(Long.valueOf(FaseExpedienteEnum.PDTE_TRAM_CLIENTE.getValue()));
		bExp.setFaseExp(fases);
		bExp.setIdMotivoRechazo(null);
		exp.setBitacoraExpediente(bExp);

		this.bitacoraExpedienteDao.add(bExp);
		this.expedienteDao.modificarEstado(exp);

		BitacoraSolicitante bitacoraSolicitante = new BitacoraSolicitante();
		bitacoraSolicitante.setAnyo(expediente.getAnyo());
		bitacoraSolicitante.setNumExp(expediente.getNumExp());
		bitacoraSolicitante.setIdAccionBitacora(new Long(AccionBitacoraEnum.REQU_SUBS_CLIENTE.getValue()));
		bitacoraSolicitante.setUsuario(credentials.getFullName());
		this.aa79bSolicitudWsDao.addBitacoraSolicitante(bitacoraSolicitante);

		tareas.setAnyo(expediente.getAnyo());
		tareas.setNumExp(expediente.getNumExp());
		TiposTarea tipoTarea = new TiposTarea();
		tipoTarea.setId015(new Long(TipoTareaGestionAsociadaEnum.ESTUDIAR_SUBSANACION.getValue()));
		tareas.setTipoTarea(tipoTarea);
		tareas.setEstadoAsignado(EstadoAceptacionTareaEnum.ACEPTADA.getValue());
		tareas.setRecursoAsignacion(TipoRecursoEnum.INTERNO.getValue());
		tareas.setIdRequerimiento(idSub);
		Tareas tareaSub = this.tareasDao.addTareaSubsanacion(tareas);

		DocusSelecSub docuSeleccionado = new DocusSelecSub();

		docuSeleccionado.setId066(idSub);
		for (String descDocu : docuSelecSub.split(";")) {
			if (!descDocu.isEmpty()) {
				docuSeleccionado.setIddoc066(Long.valueOf(descDocu));
				this.expedienteDao.putDocuSubsanacion(docuSeleccionado);
				DocumentoTareaAdjunto documentoTareaAdjunto = new DocumentoTareaAdjunto();
				documentoTareaAdjunto.setIdTarea(tareaSub.getIdTarea());
				documentoTareaAdjunto.setIdDocOriginal(new BigDecimal(descDocu));
				this.documentosGeneralService.add83(documentoTareaAdjunto);
			}
		}
		return subsanacionExpediente;
	}

	@Override
	public void actualizarSubsanacion(SubsanacionExpediente subsanacionExpediente) {
		this.expedienteDao.actualizarSubsanacion(subsanacionExpediente);
	}

	@Override
	public void actualizarSubsanacionConObsvRechazo(SubsanacionExpediente subsanacionExpediente) {
		this.expedienteDao.actualizarSubsanacionConObsvRechazo(subsanacionExpediente);
	}

	@Override()
	@Transactional(rollbackFor = Throwable.class)
	public Integer comprobarRequisitosDocu(Expediente expediente) {
		return this.expedienteDao.comprobarRequisitosDocu(expediente);
	}

	@Override()
	@Transactional(rollbackFor = Throwable.class)
	public void setPdteTramitacion(Expediente exp) {

		BitacoraExpediente bExp = new BitacoraExpediente();

		bExp.setAnyo(exp.getAnyo());
		bExp.setNumExp(exp.getNumExp());

		FasesExpediente fases = new FasesExpediente();
		fases.setId(Long.valueOf(FaseExpedienteEnum.PDTE_TRAM_SUBSANACION.getValue()));
		bExp.setFaseExp(fases);

		EstadosExpediente estado = new EstadosExpediente();
		estado.setId(Long.valueOf(EstadoExpedienteEnum.EN_ESTUDIO.getValue()));
		bExp.setEstadoExp(estado);

		Locale locale = new Locale(Constants.LANG_EUSKERA);
		bExp.setDatoAdic(this.msg.getMessage("label.subAceptada", null, locale));

		SubsanacionExpediente subExp = new SubsanacionExpediente();
		subExp.setId(exp.getBitacoraExpediente().getSubsanacionExp().getId());
		bExp.setSubsanacionExp(subExp);

		bExp.setIdMotivoRechazo(null);
		exp.setBitacoraExpediente(bExp);

		this.bitacoraExpedienteDao.add(bExp);
		this.expedienteDao.modificarEstado(exp);
	}

	@Override()
	@Transactional(rollbackFor = Throwable.class)
	public void setEstudioExp(Expediente exp) {

		BitacoraExpediente bExp = new BitacoraExpediente();

		bExp.setAnyo(exp.getAnyo());
		bExp.setNumExp(exp.getNumExp());

		FasesExpediente fases = new FasesExpediente();
		fases.setId(Long.valueOf(FaseExpedienteEnum.ESTUDIO_EXPEDIENTE.getValue()));
		bExp.setFaseExp(fases);

		EstadosExpediente estado = new EstadosExpediente();
		estado.setId(Long.valueOf(EstadoExpedienteEnum.EN_ESTUDIO.getValue()));
		bExp.setEstadoExp(estado);

		SubsanacionExpediente subExp = new SubsanacionExpediente();
		subExp.setId(exp.getBitacoraExpediente().getSubsanacionExp().getId());
		bExp.setSubsanacionExp(subExp);

		bExp.setIdMotivoRechazo(null);
		bExp.setDatoAdic("");
		exp.setBitacoraExpediente(bExp);

		this.bitacoraExpedienteDao.add(bExp);
		this.expedienteDao.modificarEstado(exp);

		BitacoraSolicitante bitacoraSolicitante = new BitacoraSolicitante();
		bitacoraSolicitante.setAnyo(exp.getAnyo());
		bitacoraSolicitante.setNumExp(exp.getNumExp());
		bitacoraSolicitante.setUsuario(Constants.IZO);
		this.bitacoraExpedienteDao.addBitacoraSolicitante(bitacoraSolicitante,
				AccionBitacoraEnum.SUBS_ACEPT_IZO.getValue());
	}

	@Override()
	@Transactional(rollbackFor = Throwable.class)
	public void updateFechaLimite(SubsanacionExpediente subsanacionExpediente) {
		this.expedienteDao.updateFechaLimite(subsanacionExpediente);

	}

	@Override()
	@Transactional(rollbackFor = Throwable.class)
	public void setRechazarSubsanacion(Expediente exp) {

		BitacoraExpediente bExp = new BitacoraExpediente();

		bExp.setAnyo(exp.getAnyo());
		bExp.setNumExp(exp.getNumExp());

		FasesExpediente fases = new FasesExpediente();
		fases.setId(Long.valueOf(FaseExpedienteEnum.PDTE_TRAM_SUBSANACION.getValue()));
		bExp.setFaseExp(fases);

		EstadosExpediente estado = new EstadosExpediente();
		estado.setId(Long.valueOf(EstadoExpedienteEnum.EN_ESTUDIO.getValue()));
		bExp.setEstadoExp(estado);

		Locale locale = new Locale(Constants.LANG_EUSKERA);
		bExp.setDatoAdic(this.msg.getMessage("label.subRechazada", null, locale));
		bExp.setIdMotivoRechazo(null);

		SubsanacionExpediente subExp = new SubsanacionExpediente();
		subExp.setId(exp.getBitacoraExpediente().getSubsanacionExp().getId());
		bExp.setSubsanacionExp(subExp);

		this.bitacoraExpedienteDao.add(bExp);

		this.expedienteDao.modificarEstado(exp);

		BitacoraSolicitante bitacoraSolicitante = new BitacoraSolicitante();
		bitacoraSolicitante.setAnyo(exp.getAnyo());
		bitacoraSolicitante.setNumExp(exp.getNumExp());
		bitacoraSolicitante.setUsuario(Constants.IZO);
		this.bitacoraExpedienteDao.addBitacoraSolicitante(bitacoraSolicitante,
				AccionBitacoraEnum.SUBS_RECHAZ_IZO.getValue());
	}

	@Override()
	@Transactional(rollbackFor = Throwable.class)
	public List<Expediente> comprobarCamposSeleccionados(Expediente exp) {
		return this.expedienteDao.comprobarCamposSeleccionados(exp);
	}

	@Override()
	@Transactional(rollbackFor = Throwable.class)
	public List<Expediente> comprobarDocumentosSeleccionados(Expediente exp) {
		return this.expedienteDao.comprobarDocumentosSeleccionados(exp);
	}

	@Override()
	@Transactional(rollbackFor = Throwable.class)
	public List<String> getTitulosExpediente(EntradaGestoresRepresentante bean) {
		return this.expedienteDao.getTitulosExpediente(bean);
	}

	@Override()
	@Transactional(rollbackFor = Throwable.class)
	public Long countGestorExpPdteTramCliente(EntradaGestoresRepresentante bean) {
		return this.expedienteDao.countGestorExpPdteTramCliente(bean);
	}

	@Override()
	@Transactional(rollbackFor = Throwable.class)
	public SubsanacionExpediente getDetalleSubsanacion(Expediente bean) {
		return this.expedienteDao.getDetalleSubsanacion(bean);
	}

	@Override()
	@Transactional(rollbackFor = Throwable.class)
	public List<CamposSelecSub> getCampoSubsanacion(SubsanacionExpediente bean) {
		return this.expedienteDao.getCampoSubsanacion(bean);
	}

	@Override()
	@Transactional(rollbackFor = Throwable.class)
	public List<DocusSelecSub> getDocuSubsanacion(SubsanacionExpediente bean) {
		return this.expedienteDao.getDocuSubsanacion(bean);
	}

	@Override()
	@Transactional(rollbackFor = Throwable.class)
	public Expediente comprobarRequisitosSub(Expediente expediente) {
		return this.expedienteDao.comprobarRequisitosSub(expediente);
	}

	@Override()
	public SalidaFechaFinalizacion llamadaFncObtenerPlazoMinEntrega(EntradaFechaFinalizacion bean) {

		SalidaFechaFinalizacion salidaFechaFinalizacion = new SalidaFechaFinalizacion();

		Solicitante solicitante = new Solicitante();
		solicitante.setDni(bean.getDniGestor());
		solicitante = this.solicitanteDao.find(solicitante);

		Date fechaPlazoMinimo;
		if (solicitante != null) {
			fechaPlazoMinimo = this.expedienteDao.llamadaFncObtenerPlazoMinEntrega(bean,
					solicitante.getGestorExpedientesVIP());
		} else {
			fechaPlazoMinimo = new Date();
		}

		salidaFechaFinalizacion.setPlazoMinimo(fechaPlazoMinimo.getTime());

		salidaFechaFinalizacion.setDiasFestivos(this.calendarioServicioDao.getFestivosYFinde2anyos(fechaPlazoMinimo));

		ConfigCalculoPresupuesto configCalculoPresupuesto = this.configCalculoPresupuestoDao
				.find(new ConfigCalculoPresupuesto(Constants.ID_DATOS_BASICOS));

		if (configCalculoPresupuesto != null) {
			salidaFechaFinalizacion.setPalPresupuestoTrados(configCalculoPresupuesto.getPalPresupuesto());// cambiado
																											// para que
																											// obtenga
																											// palPresupuesto
		}

		return salidaFechaFinalizacion;
	}

	@Override()
	@Transactional(rollbackFor = Throwable.class)
	public List<Aa79bSolicitud> findSolicitud(Expediente expediente) {
		return this.expedienteDao.findSolicitud(expediente);
	}

	@Override()
	@Transactional(rollbackFor = Throwable.class)
	public List<DocumentosExpediente> documentosRelacionados(Expediente expediente) {
		return this.expedienteDao.documentosRelacionados(expediente);
	}

	@Override()
	@Transactional(rollbackFor = Throwable.class)
	public Integer updateIndSubsanacion(SubsanacionExpediente expediente) {
		return this.expedienteDao.updateIndSubsanacion(expediente);
	}

	@Override()
	@Transactional(rollbackFor = Throwable.class)
	public List<Aa79bExpedienteRelacionado> expRelacionadasFind(Expediente expediente) {
		return this.expedienteDao.expRelacionadasFind(expediente);
	}

	@Override()
	@Transactional(rollbackFor = Throwable.class)
	public List<Expediente> getJustificanteSolicitud(Expediente bean) {
		return this.expedienteDao.getJustificanteSolicitud(bean);
	}

	@Override
	public Integer countGruposTrabajoInterpretacion(String dni) {
		return this.expedienteDao.countGruposTrabajoInterpretacion(dni);
	}

	@Override
	public JQGridResponseDto<ExpedientePlanificacion> busquedageneral(ExpedientePlanificacion filter,
			JQGridRequestDto jqGridRequestDto, boolean isCount) {
		@SuppressWarnings("unchecked")
		List<ExpedientePlanificacion> listaExpedientes = (List<ExpedientePlanificacion>) this.expedienteDao
				.busquedageneral(filter, jqGridRequestDto, false, false);

		Long recordNum = 0L;

		if (listaExpedientes != null && !listaExpedientes.isEmpty()) {
			recordNum = (Long) this.expedienteDao.busquedageneral(filter, jqGridRequestDto, false, true);
		}

		if (jqGridRequestDto != null) {
			return new JQGridResponseDto<ExpedientePlanificacion>(jqGridRequestDto, recordNum, listaExpedientes);
		} else {
			return new JQGridResponseDto<ExpedientePlanificacion>(new JQGridRequestDto(), recordNum, listaExpedientes);
		}

	}

	@Override
	public JQGridResponseDto<ExpedientePlanificacion> consultaPlanificacionExpediente(ExpedientePlanificacion filter,
			JQGridRequestDto jqGridRequestDto, boolean isCount) {
		@SuppressWarnings("unchecked")
		List<ExpedientePlanificacion> listaExpedientes = (List<ExpedientePlanificacion>) this.expedienteDao
				.consultaPlanificacionExpediente(filter, jqGridRequestDto, false, false);

		Long recordNum = 0L;

		if (listaExpedientes != null && !listaExpedientes.isEmpty()) {
			recordNum = (Long) this.expedienteDao.consultaPlanificacionExpediente(filter, jqGridRequestDto, false,
					true);
		}

		if (jqGridRequestDto != null) {
			return new JQGridResponseDto<ExpedientePlanificacion>(jqGridRequestDto, recordNum, listaExpedientes);
		} else {
			return new JQGridResponseDto<ExpedientePlanificacion>(new JQGridRequestDto(), recordNum, listaExpedientes);
		}

	}

	@Override
	public Expediente updateAsignador(Expediente expediente) {
		return this.expedienteDao.updateAsignador(expediente);
	}

	@Override
	public BitacoraExpediente findEstadoFaseExpediente(Long anyo, Integer numExp) {
		return this.expedienteDao.findEstadoFaseExpediente(anyo, numExp);
	}

	@Override
	public String getPermisosBopv(Long anyo, Integer numExp) {
		Solicitante salida = this.solicitanteDao.getPermisosBopv(anyo, numExp);
		return salida.getGestorExpedientesBOPV();
	}

	/**
	 * @param expediente Expediente
	 * @return
	 */
	private int enviarEmailRechazoExp(Expediente expediente, RechazoExpediente rechazoExpediente) {
		List<String> listaDestinatarios = new ArrayList<String>();
		int rst = 0;

		if (this.appConfiguration.getProperty(Constants.APP_ENTORNO) != null) {
			if (Constants.LOCAL.equals(this.appConfiguration.getProperty(Constants.APP_ENTORNO))) {
				listaDestinatarios.add(Constants.DESTINATARIO_EMAIL_LOCAL);
			} else {
				listaDestinatarios.addAll(this.obtenerDestinatarios(expediente));
			}
		}

		if (TareasServiceUtils.isNotEmptyLstDestinatarios(listaDestinatarios)) {
			ParametrosEmail parametrosEmail = new ParametrosEmail();
			Locale localeTxt = new Locale(Constants.LANG_EUSKERA);

			Map<String, String> infoEu = new LinkedHashMap<String, String>();

			infoEu.put(this.appMessageSource.getMessage("label.numExpMin", null, localeTxt),
					expediente.getAnyoNumExpConcatenado());

			StringBuilder infoRechazo = new StringBuilder();
			infoRechazo.append(rechazoExpediente.getMotivo().getDescEu013()).append(". ");
			if (rechazoExpediente.getObservacionesRechazo() != null
					&& rechazoExpediente.getObservacionesRechazo().getObsvRechazo068() != null) {
				infoRechazo.append(rechazoExpediente.getObservacionesRechazo().getObsvRechazo068());
			}

			infoEu.put(this.appMessageSource.getMessage("label.motivoRechazo", null, localeTxt),
					infoRechazo.toString());

			parametrosEmail.setInfoEu(infoEu);

			localeTxt = new Locale(Constants.LANG_CASTELLANO);

			Map<String, String> infoEs = new LinkedHashMap<String, String>();

			infoEs.put(this.appMessageSource.getMessage("label.numExpMin", null, localeTxt),
					expediente.getAnyoNumExpConcatenado());

			infoRechazo = new StringBuilder();
			infoRechazo.append(rechazoExpediente.getMotivo().getDescEs013()).append(". ");
			if (rechazoExpediente.getObservacionesRechazo() != null
					&& rechazoExpediente.getObservacionesRechazo().getObsvRechazo068() != null) {
				infoRechazo.append(rechazoExpediente.getObservacionesRechazo().getObsvRechazo068());
			}

			infoEs.put(this.appMessageSource.getMessage("label.motivoRechazo", null, localeTxt),
					infoRechazo.toString());

			parametrosEmail.setInfoEu(infoEu);
			parametrosEmail.setInfoEs(infoEs);

			parametrosEmail.setAnyoNumExpediente(Utils.getNumExpedienteParameter(expediente));

			try {
				this.mailService.sendMailWithParameters(TipoAvisoEnum.RECHAZADO_EXP.getValue(), listaDestinatarios,
						parametrosEmail);
			} catch (Exception e) {
				ExpedienteServiceImpl.LOGGER.info("Error en el envío de email", e);
				rst = -2;
			}
		} else {
			rst = -1;
		}

		return rst;
	}

	/**
	 * @param tareas Tareas
	 * @return List<String>
	 */
	private List<String> obtenerDestinatarios(Expediente expediente) {
		final List<String> listaDestinatarios = new ArrayList<String>();
		if (expediente.getGestorExpediente() != null && expediente.getGestorExpediente().getSolicitante() != null
				&& StringUtils.isNotBlank(expediente.getGestorExpediente().getSolicitante().getDni())) {
			listaDestinatarios
					.add(this.obtenerEmailContacto(expediente.getGestorExpediente().getSolicitante().getDni()));
		}
		return listaDestinatarios;
	}

	/**
	 * @param dni
	 * @return
	 */
	public String obtenerEmailContacto(String dni) {
		String email = null;
		DatosContacto datosContacto = new DatosContacto();
		datosContacto.setDni031(dni);
		DatosContacto datosContactoAux = this.datosContactoDao.find(datosContacto);
		if (datosContactoAux != null) {
			email = datosContactoAux.getEmail031();
		}
		return email;
	}

	@Override
	public ExpedienteTradRev getFechaFinalIzo(Expediente bean) {
		return this.expedienteDao.getFechaFinalIzo(bean);
	}

	@Override
	public Integer asignarAsignadorAExpedientes(ListaExpediente listaExpedientes) {
		// si no está, guardar asignador en 77
		if (listaExpedientes != null && !listaExpedientes.getListaExpediente().isEmpty()
				&& listaExpedientes.getListaExpediente().get(0).getTecnico() != null) {
			boolean esta = this.datosPersonaDao
					.comprobarPersona(listaExpedientes.getListaExpediente().get(0).getTecnico().getDni());
			if (!esta) {
				PersonalIZO personalIZO = new PersonalIZO();
				personalIZO.setDni(listaExpedientes.getListaExpediente().get(0).getTecnico().getDni());
				PersonalIZO personalAInsertar = this.personalIZOService.find(personalIZO);

				this.expedienteDao.guardarPersona(personalAInsertar);
			}
		}

		// Se actualiza el asignador
		this.expedienteDao.asignarAsignadorAExpedientes(listaExpedientes);

		// Se actualiza el registro de acciones
		return this.registroAccionesDao.addRegistroListaExpedientes(listaExpedientes);
	}

	@Override
	public List<ExpedientePlanificacion> consultaPlanificacionExpedienteGetSelectedIds(
			ExpedientePlanificacion filterExpedientePlanificacion, JQGridRequestDto tableData) {
		return this.expedienteDao.consultaPlanificacionExpedienteGetSelectedIds(filterExpedientePlanificacion,
				tableData);
	}

	@Override
	public List<ExpedientePlanificacion> busquedageneralGetSelectedIds(ExpedientePlanificacion filter,
			JQGridRequestDto tableData) {
		return this.expedienteDao.busquedageneralGetSelectedIds(filter, tableData);
	}

	@Override
	public List<Expediente> filtroExpedienteEstadoEnEstudioGetSelectedIds(Expediente filterExpediente,
			JQGridRequestDto tableData) {
		return this.expedienteDao.filtroExpedienteEstadoEnEstudioGetSelectedIds(filterExpediente, tableData);
	}

}
