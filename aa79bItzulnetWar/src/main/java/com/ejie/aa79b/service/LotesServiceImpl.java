package com.ejie.aa79b.service;

import java.util.LinkedHashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;

import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.support.ReloadableResourceBundleMessageSource;
import org.springframework.stereotype.Service;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.dao.EmpresasProveedorasDao;
import com.ejie.aa79b.dao.EntidadesLoteDao;
import com.ejie.aa79b.dao.GenericoDao;
import com.ejie.aa79b.dao.IdiomaDestinoDao;
import com.ejie.aa79b.dao.LotesDao;
import com.ejie.aa79b.dao.ProveedorDao;
import com.ejie.aa79b.dao.RegistroAccionesDao;
import com.ejie.aa79b.model.EmpresasProveedoras;
import com.ejie.aa79b.model.EntidadesLote;
import com.ejie.aa79b.model.Expediente;
import com.ejie.aa79b.model.IdiomaDestino;
import com.ejie.aa79b.model.Lotes;
import com.ejie.aa79b.model.Proveedor;
import com.ejie.aa79b.model.RegistroAcciones;
import com.ejie.aa79b.utils.Utils;
import com.ejie.x38.dto.JQGridRequestDto;
import com.ejie.x38.dto.JQGridResponseDto;
import com.ejie.x38.dto.TableRowDto;

/**
 * LotesServiceImpl generated by UDA, 27-nov-2017 12:26:24.
 *
 * @author UDA
 */

@Service(value = "lotesService")
public class LotesServiceImpl extends GenericoServiceImpl<Lotes> implements LotesService {

	@Autowired
	private LotesDao lotesDao;
	@Autowired
	private IdiomaDestinoDao idiomaDestinoDao;
	@Autowired
	private ProveedorDao proveedorDao;
	@Autowired
	private EmpresasProveedorasDao empresasProveedorasDao;
	@Autowired()
	private RegistroAccionesDao registroAccionesDao;
	@Autowired()
	private EntidadesLoteDao entidadesLoteDao;
	@Autowired()
	private ReloadableResourceBundleMessageSource msg;

	@Override
	protected GenericoDao<Lotes> getDao() {
		return this.lotesDao;
	}

	/**
	 * Inserts a single row in the Lotes table.
	 *
	 * @param bean
	 *            Lotes
	 * @return Lotes
	 */
	@Override()
	public Lotes add(Lotes bean) {
		Lotes lotes = this.getDao().add(bean);

		this.registrarAccion(bean, null, "mensaje.loteNuevo");

		return lotes;
	}

	/**
	 * Updates a single row in the Lotes table.
	 *
	 * @param bean
	 *            Lotes
	 * @return Lotes
	 */
	@Override()
	public Lotes update(Lotes bean) {
		Lotes original = this.getDao().find(bean);
		Lotes lotes = this.getDao().update(bean);

		this.registrarAccion(bean, original, "mensaje.loteModificado");

		return lotes;
	}

	private void registrarAccion(Lotes bean, Lotes original, String labelMensaje) {
		RegistroAcciones reg = new RegistroAcciones();
		reg.setIdPuntoMenu(Constants.PUNTO_MENU_LOTES);
		if (original == null) {
			reg.setIdAccion(Constants.ACCION_ALTA);
		} else {
			reg.setIdAccion(Constants.ACCION_MODIFICACION);
		}

		Map<String, String> parametros = new LinkedHashMap<String, String>();
		parametros.put("idLote", "label.id");
		parametros.put("nombreLote", "label.nombre");
		parametros.put("descLoteEu", "comun.descripcionEus");
		parametros.put("descLoteEs", "comun.descripcionEs");
		parametros.put("contacto.dni", "label.contacto");
		parametros.put("fechaInicio", "label.fechaIni");
		parametros.put("fechaFin", "label.fechaFin");
		parametros.put("importeAsignado", "label.importeAsignado");
		parametros.put("importeConsumido", "label.importeConsumido");
		parametros.put("importePrevisto", "label.importePrevisto");
		parametros.put("importeRestante", "label.importeTotalRestante");
		parametros.put("importeDisponible", "label.importeDisponible");
		parametros.put("idIdiomaDestino", "label.idiomaDestino");
		parametros.put("importePalabra", "label.importePalabra");
		parametros.put("porPagoPalConcor8594", "label.8594por");
		parametros.put("porPagoPalConcor95100", "label.95100por");
		parametros.put("porRevision", "label.porTarea");
		parametros.put("porRecargoFormato", "label.recargoFormato");
		parametros.put("indRecargoApremio", "label.recargoApremio");
		parametros.put("porRecargoApremio", "label.porcentaje");
		parametros.put("idTipoPenalizacion", "label.penalizacionRetraso");
		parametros.put("porPenalizacion", "label.porcentajeMax");

		Locale locale = new Locale(Constants.LANG_EUSKERA);
		String aux = Utils.observacionesRegistro(bean, original, parametros, this.msg, locale);
		if (StringUtils.isNotBlank(aux)) {
			StringBuilder observ = new StringBuilder();
			observ.append(this.msg.getMessage(labelMensaje, null, locale)).append(" \n");
			observ.append(this.msg.getMessage("label.id", null, locale)).append(":").append(bean.getIdLote())
					.append(" \n");
			observ.append(aux);
			observ.append(this.obtenerMensajeResolucion(bean, original, locale));
			reg.setObserv(observ.toString());
			this.registroAccionesDao.add(reg);
		}

	}

	/**
	 * @param bean
	 * @param original
	 * @param locale
	 * @param strResolucion
	 */
	private String obtenerMensajeResolucion(Lotes bean, Lotes original, Locale locale) {
		StringBuilder strResolucion = new StringBuilder();
		String resolucion = bean.getResolucion();
		String strActual = resolucion == null ? "" : resolucion;
		if (original == null) {
			strResolucion.append(this.obtenerMensaje(locale, "mensaje.resolucionAnadida"));
		} else {
			resolucion = original.getResolucion();
			String strOriginal = resolucion == null ? "" : resolucion;
			if (!StringUtils.equals(strOriginal, strActual)) {
				strResolucion.append(this.obtenerMensaje(locale, "mensaje.resolucionModificada"));
			}
		}

		return strResolucion.toString();
	}

	/**
	 * @param locale
	 * @param strResolucion
	 */
	private String obtenerMensaje(Locale locale, String labelMensaje) {
		StringBuilder str = new StringBuilder();
		str.append(this.msg.getMessage("label.resolucionExpLote", null, locale)).append(": ");
		str.append(this.msg.getMessage(labelMensaje, null, locale));
		str.append("\n");

		return str.toString();
	}

	@Override()
	public Lotes generarPdf(Lotes lotes, Locale locale) {
		Lotes lotesAux = this.find(lotes);

		EmpresasProveedoras empresasProveedoras = new EmpresasProveedoras();
		empresasProveedoras.setTipo(lotesAux.getEmpresasProveedoras().getTipo());
		empresasProveedoras.setCodigo(lotesAux.getEmpresasProveedoras().getCodigo());
		EmpresasProveedoras empresasProveedorasAux = this.empresasProveedorasDao.find(empresasProveedoras);
		if (empresasProveedorasAux != null) {
			lotesAux.getEmpresasProveedoras().setCif(empresasProveedorasAux.getCif());
			lotesAux.getEmpresasProveedoras().setDescAmpEu(empresasProveedorasAux.getDescAmpEu());
			lotesAux.getEmpresasProveedoras().setDescAmpEs(empresasProveedorasAux.getDescAmpEs());
		}

		Proveedor proveedor = new Proveedor();
		proveedor.setDni(lotesAux.getContacto().getDni());
		Proveedor proveedorAux = this.proveedorDao.find(proveedor);
		if (proveedorAux != null) {
			lotesAux.getContacto().setNombre(proveedorAux.getNombre());
			lotesAux.getContacto().setApellido1(proveedorAux.getApellido1());
			lotesAux.getContacto().setApellido2(proveedorAux.getApellido2());
		}

		IdiomaDestino idiomaDestino = new IdiomaDestino();
		idiomaDestino.setIdIdioma(lotesAux.getIdIdiomaDestino());
		idiomaDestino.setCodIdioma(locale.getLanguage());
		IdiomaDestino idiomaDestinoAux = this.idiomaDestinoDao.find(idiomaDestino);
		if (idiomaDestinoAux != null) {
			String idiomaDestinoDesc;
			if (Constants.LANG_EUSKERA.equals(locale.getLanguage())) {
				idiomaDestinoDesc = idiomaDestinoAux.getDescIdiomaEu();
			} else {
				idiomaDestinoDesc = idiomaDestinoAux.getDescIdiomaEs();
			}
			lotesAux.setIdiomaDestinoDesc(idiomaDestinoDesc);
		}

		return lotesAux;
	}

	@Override
	public List<Lotes> getLotesExpedientePlanificacion(Lotes lotes, JQGridRequestDto jqGridRequestDto) {
		return this.lotesDao.getLotesExpedientePlanificacion(lotes, jqGridRequestDto);
	}

	@Override
	public JQGridResponseDto<Lotes> filterLotesVigentesExp(Expediente expediente, JQGridRequestDto jqGridRequestDto,
			boolean startsWith) {
		List<Lotes> listaLotes = this.lotesDao.filterLotesVigentesExp(expediente, jqGridRequestDto);
		Long recordNum = this.lotesDao.filterLotesVigentesExpCount(expediente, false);
		if (jqGridRequestDto.getMultiselection().getSelectedIds() != null) {
			List<TableRowDto<Lotes>> reorderSelection = this.lotesDao.reorderSelectionLotesVigentesExp(expediente,
					jqGridRequestDto, startsWith);
			return new JQGridResponseDto<Lotes>(jqGridRequestDto, recordNum, listaLotes, reorderSelection);
		}
		return new JQGridResponseDto<Lotes>(jqGridRequestDto, recordNum, listaLotes);

	}

	/**
	 *
	 * devuelve lotes: si tipo = 1 --> no pagados si tipo = 2 --> no pagados y
	 * pagados, y si el lote est√° activo
	 *
	 *
	 * @param codEntidad
	 * @param tipo
	 * @return
	 */
	@Override
	public List<Lotes> getLotesNoPagados(Long codEntidad, Integer tipo) {
		return this.lotesDao.getLotesNoPagados(codEntidad, tipo);
	}

	@Override
	public List<Lotes> getLotesNoPagados(String tipo, Integer codigo, Integer indPagado) {
		return this.lotesDao.getLotesNoPagados(tipo, codigo, indPagado);
	}

	@Override
	public EntidadesLote getLoteExpedienteDefecto(Long anyo, Integer numExp) {
		EntidadesLote lote = this.lotesDao.getLoteExpedienteDefecto(anyo, numExp);
		if (lote != null && lote.getIdLote() != null && this.entidadesLoteDao.entidadTieneComentario(lote)) {
			this.entidadesLoteDao.findComentarioEntidad(lote);
		}
		return lote;
	}
}
