package com.ejie.aa79b.dao;

import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.List;
import java.util.Locale;

import org.springframework.jdbc.core.RowMapper;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import org.springframework.context.i18n.LocaleContextHolder;
import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.common.DBConstants;
import com.ejie.aa79b.common.DaoConstants;
import com.ejie.aa79b.common.SqlUtils;
import com.ejie.aa79b.model.Factura;

/**
 * FacturaDaoImpl generated by UDA, 30-oct-2018 11:14:46.
 *
 * @author UDA
 */

@Repository()
@Transactional()
public class FacturaDaoImpl extends GenericoDaoImpl<Factura> implements FacturaDao {

	public static final String[] ORDER_BY_WHITE_LIST = new String[] { DBConstants.IDFACTURA,
			DBConstants.TIPOENTIDADASOCIADA, DBConstants.IDENTIDADASOCIADA, DBConstants.DNICONTACTO,
			DBConstants.IDLIQUIDACION, DBConstants.FECHAEMISION, DBConstants.TIPOEXPFACTURA };

	private RowMapper<Factura> rwMap = new RowMapper<Factura>() {
		@Override
		public Factura mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			Factura factura = new Factura();
			factura.setIdFactura(resultSet.getLong(DBConstants.IDFACTURA));
			factura.setTipoEntidadAsoc(resultSet.getString(DBConstants.TIPOENTIDADASOCIADA));
			factura.setIdEntidadAsoc(resultSet.getInt(DBConstants.IDENTIDADASOCIADA));
			factura.setDniContacto(resultSet.getString(DBConstants.DNICONTACTO));
			factura.setIdLiquidacion(resultSet.getString(DBConstants.IDLIQUIDACION));
			factura.setFechaEmision(resultSet.getDate(DBConstants.FECHAEMISION));
			factura.setTipoExpFactura(resultSet.getString(DBConstants.TIPOEXPFACTURA));
			return factura;
		}
	};

	private RowMapper<Factura> rwMapPK = new RowMapper<Factura>() {
		@Override
		public Factura mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			Factura factura = new Factura();
			factura.setIdFactura(resultSet.getLong(DBConstants.IDFACTURA));
			return factura;
		}
	};

	/**
	 * Constructor
	 */
	public FacturaDaoImpl() {
		super(Factura.class);
	}

	@Override()
	public Factura add(Factura factura) {
		if (factura.getIdFactura() == null) {
			factura.setIdFactura(this.getIdFacturaSgt());
		}

		String query = "INSERT INTO AA79BA4S01 (ID_FACTURA_0A4, TIPO_ENTIDAD_ASOC_0A4, ID_ENTIDAD_ASOC_0A4, DNI_CONTACTO_0A4, ID_LIQUIDACION_0A4, FECHA_EMISION_0A4, TIPO_EXP_FACTURA_0A4, APP_ID_0A4) VALUES (?,?,?,?,?,"
				+ DaoConstants.SYSDATE + ",?,?)";
		this.getJdbcTemplate().update(query, factura.getIdFactura(), factura.getTipoEntidadAsoc(),
				factura.getIdEntidadAsoc(), factura.getDniContacto(), factura.getIdLiquidacion(),
				factura.getTipoExpFactura(), Constants.ID_AA79B_W05B);
		return factura;
	}

	@Override()
	public Factura update(Factura factura) {
		String query = "UPDATE AA79BA4S01 SET TIPO_ENTIDAD_ASOC_0A4=?, ID_ENTIDAD_ASOC_0A4=?, DNI_CONTACTO_0A4=?, ID_LIQUIDACION_0A4=?, FECHA_EMISION_0A4=?, TIPO_EXP_FACTURA_0A4=? WHERE ID_FACTURA_0A4=?";
		this.getJdbcTemplate().update(query, factura.getTipoEntidadAsoc(), factura.getIdEntidadAsoc(),
				factura.getDniContacto(), factura.getIdLiquidacion(), factura.getFechaEmision(),
				factura.getTipoExpFactura(), factura.getIdFactura());
		return factura;
	}

	@Override()
	public void remove(Factura factura) {
		String query = "DELETE FROM AA79BA4S01 WHERE ID_FACTURA_0A4=?";
		this.getJdbcTemplate().update(query, factura.getIdFactura());
	}

	@Override()
	protected String getSelect() {
		StringBuilder query = new StringBuilder();

		query.append(DaoConstants.SELECT);
		query.append(DaoConstants.T1_MINUSCULA);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ID_FACTURA_0A4);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.IDFACTURA);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.T1_MINUSCULA);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.TIPO_ENTIDAD_ASOC_0A4);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.TIPOENTIDADASOCIADA);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.T1_MINUSCULA);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ID_ENTIDAD_ASOC_0A4);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.IDENTIDADASOCIADA);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.T1_MINUSCULA);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.DNI_CONTACTO_0A4);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.DNICONTACTO);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.T1_MINUSCULA);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.ID_LIQUIDACION_0A4);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.IDLIQUIDACION);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.T1_MINUSCULA);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.FECHA_EMISION_0A4);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.FECHAEMISION);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.T1_MINUSCULA);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DBConstants.TIPO_EXP_FACTURA_0A4);
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.TIPOEXPFACTURA);

		return query.toString();
	}

	@Override()
	protected String getFrom() {
		StringBuilder query = new StringBuilder();

		query.append(DaoConstants.FROM);
		query.append(DBConstants.TABLA_A4);
		query.append(DaoConstants.BLANK);
		query.append(DaoConstants.T1_MINUSCULA);

		return query.toString();
	}

	@Override()
	protected RowMapper<Factura> getRwMap() {
		return this.rwMap;
	}

	@Override()
	protected String[] getOrderBy() {
		return FacturaDaoImpl.ORDER_BY_WHITE_LIST;
	}

	@Override()
	protected String getPK() {
		return DBConstants.ID_FACTURA_0A4;
	}

	@Override()
	protected RowMapper<Factura> getRwMapPK() {
		return this.rwMapPK;
	}

	@Override()
	protected String getWherePK(Factura bean, List<Object> params) {
		params.add(bean.getIdFactura());

		StringBuilder where = new StringBuilder();
		where.append(DaoConstants.WHERE);
		where.append(DaoConstants.T1_MINUSCULA);
		where.append(DaoConstants.SIGNO_PUNTO);
		where.append(DBConstants.ID_FACTURA_0A4);
		where.append(DaoConstants.SIGNOIGUAL_INTERROGACION);

		return where.toString();
	}

	@Override()
	protected String getWhere(Factura bean, List<Object> params) {
		return getWhereClausule(bean, params);
	}

	@Override()
	protected String getWhereLike(Factura bean, Boolean startsWith, List<Object> params, Boolean search) {
		return getWhereClausule(bean, params);
	}

	/**
	 * Obtiene la clausula where
	 *
	 * @param bean
	 * @param params
	 * @return String
	 */
	private String getWhereClausule(Factura bean, List<Object> params) {
		StringBuilder where = new StringBuilder(FacturaDaoImpl.STRING_BUILDER_INIT);

		if (bean != null) {
			where.append(SqlUtils.generarWhereIgual(DBConstants.ID_FACTURA_0A4, bean.getIdFactura(), params));
			where.append(
					SqlUtils.generarWhereIgual(DBConstants.TIPO_ENTIDAD_ASOC_0A4, bean.getTipoEntidadAsoc(), params));
			where.append(SqlUtils.generarWhereIgual(DBConstants.ID_ENTIDAD_ASOC_0A4, bean.getIdEntidadAsoc(), params));
			where.append(SqlUtils.generarWhereIgual(DBConstants.DNI_CONTACTO_0A4, bean.getDniContacto(), params));
			where.append(SqlUtils.generarWhereIgual(DBConstants.ID_LIQUIDACION_0A4, bean.getIdLiquidacion(), params));
			where.append(SqlUtils.generarWhereIgual(DBConstants.FECHA_EMISION_0A4, bean.getFechaEmision(), params));
			where.append(
					SqlUtils.generarWhereIgual(DBConstants.TIPO_EXP_FACTURA_0A4, bean.getTipoExpFactura(), params));
		}

		return where.toString();
	}

	@Override
	public Long getIdFacturaSgt() {
		StringBuilder query = new StringBuilder();
		query.append(DaoConstants.SELECT);
		query.append(DaoConstants.TO_CHAR);
		query.append(DaoConstants.ABRIR_PARENTESIS);
		query.append(DaoConstants.SYSDATE);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.SIGNO_APOSTROFO);
		query.append("YY");
		query.append(DaoConstants.SIGNO_APOSTROFO);
		query.append(DaoConstants.CERRAR_PARENTESIS);
		query.append(DaoConstants.SIGNO_CONCATENACION);
		query.append(DaoConstants.LPAD);
		query.append(DaoConstants.ABRIR_PARENTESIS);
		query.append(DaoConstants.SIGNO_APOSTROFO);
		query.append(Constants.ID_AA79B_W05B);
		query.append(DaoConstants.SIGNO_APOSTROFO);
		query.append(DaoConstants.SIGNO_COMA);
		query.append("2");
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.SIGNO_APOSTROFO);
		query.append(DBConstants.VALOR_RELLENO_STRING_0);
		query.append(DaoConstants.SIGNO_APOSTROFO);
		query.append(DaoConstants.CERRAR_PARENTESIS);
		query.append(DaoConstants.SIGNO_CONCATENACION);
		query.append(DaoConstants.LPAD);
		query.append(DaoConstants.ABRIR_PARENTESIS);
		query.append(DBConstants.SECUENCIA_TABLA_A4);
		query.append(DaoConstants.SIGNO_PUNTO);
		query.append(DaoConstants.NEXTVAL);
		query.append(DaoConstants.SIGNO_COMA);
		query.append("6");
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.SIGNO_APOSTROFO);
		query.append(DBConstants.VALOR_RELLENO_STRING_0);
		query.append(DaoConstants.SIGNO_APOSTROFO);
		query.append(DaoConstants.CERRAR_PARENTESIS);
		query.append(DaoConstants.FROM);
		query.append(DaoConstants.DUAL);

		return this.getJdbcTemplate().queryForObject(query.toString(), Long.class);
	}

	@Override
	public Long comprobarPartidaPresupuestaria(String concepto, String tipoPartida) {
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder();
		query.append(DaoConstants.SELECT_COUNT);
		query.append(DBConstants.CONCEPTO);
		query.append(DaoConstants.BLANK);
		query.append(DaoConstants.FROM);
		query.append(DBConstants.W0505S01);
		query.append(DaoConstants.BLANK);
		query.append(DaoConstants.WHERE);
		query.append(DBConstants.T04_CONCEPTO_ID);
		query.append(DaoConstants.SIGNOIGUAL_INTERROGACION);
		query.append(DaoConstants.AND);
		query.append(DBConstants.T05_EJERCICIO);
		query.append(DaoConstants.SIGNOIGUAL_INTERROGACION);
		query.append(DaoConstants.AND);
		query.append(DBConstants.T05_TIPO);
		query.append(DaoConstants.SIGNOIGUAL_INTERROGACION);
		query.append(DaoConstants.AND);
		query.append(DaoConstants.CASE);
		query.append(DaoConstants.WHEN);
		query.append(DaoConstants.ABRIR_PARENTESIS);
		query.append(DBConstants.T05_CENTRO_GESTOR);
		query.append(DaoConstants.IS_NOT_NULL);
		query.append(DaoConstants.AND);
		query.append(DaoConstants.TRUNC);
		query.append(DaoConstants.ABRIR_PARENTESIS).append(DaoConstants.SYSDATE).append(DaoConstants.CERRAR_PARENTESIS);
		query.append(DaoConstants.BETWEEN);
		query.append(DaoConstants.TRUNC);
		query.append(DaoConstants.ABRIR_PARENTESIS).append(DBConstants.T05_FEC_VIGENCIA_DESDE)
				.append(DaoConstants.CERRAR_PARENTESIS);
		query.append(DaoConstants.AND);
		query.append(DaoConstants.TRUNC);
		query.append(DaoConstants.ABRIR_PARENTESIS).append(DBConstants.T05_FEC_VIGENCIA_HASTA)
				.append(DaoConstants.CERRAR_PARENTESIS);
		query.append(DaoConstants.AND);
		query.append(DaoConstants.TRUNC);
		query.append(DaoConstants.ABRIR_PARENTESIS).append(DaoConstants.SYSDATE).append(DaoConstants.CERRAR_PARENTESIS);
		query.append(DaoConstants.SIGNO_MAYOR_IGUAL_QUE);
		query.append(DaoConstants.TRUNC);
		query.append(DaoConstants.ABRIR_PARENTESIS).append(DBConstants.T05_FEC_ACTIVACION)
				.append(DaoConstants.CERRAR_PARENTESIS);
		query.append(DaoConstants.CERRAR_PARENTESIS).append(DaoConstants.THEN).append(" 1 ");
		query.append(DaoConstants.WHEN);
		query.append(DaoConstants.ABRIR_PARENTESIS);
		query.append(DBConstants.T05_CENTRO_GESTOR);
		query.append(DaoConstants.IS_NULL);
		query.append(DaoConstants.AND);
		query.append(DBConstants.T05_FECHA_BAJA);
		query.append(DaoConstants.IS_NULL);
		query.append(DaoConstants.CERRAR_PARENTESIS).append(DaoConstants.THEN).append(" 0 ");
		query.append(DaoConstants.ELSE).append(" 2 ");
		query.append(DaoConstants.END).append(DaoConstants.SIGNOIGUAL);
		query.append(DaoConstants.NVL2);
		query.append(DaoConstants.ABRIR_PARENTESIS);
		query.append(DBConstants.T05_CENTRO_GESTOR).append(",1,0").append(DaoConstants.CERRAR_PARENTESIS);

		params.add(concepto);
		Calendar calendar = Calendar.getInstance();
		params.add(String.valueOf(calendar.get(Calendar.YEAR)));
		params.add(tipoPartida);

		return this.getJdbcTemplate().queryForObject(query.toString(), params.toArray(), Long.class);
	}

	@Override

	public String obtenerCentroOrganico(String dni) {
		try {
			List<Object> params = new ArrayList<Object>();
		     StringBuilder query = new StringBuilder();
		     Locale locale = LocaleContextHolder.getLocale();
		     if (locale.getLanguage().equals(Constants.LANG_EUSKERA)) {
		          query.append("SELECT DESCRIPCION_EUSKERA_AMP ");
		     } else {
		          query.append("SELECT DESCRIPCION_CASTELLANO_AMP ");
		     }
		     query.append("FROM X54J52S01 WHERE DNI=? ");
		     params.add(dni);
		     return this.getJdbcTemplate().queryForObject(query.toString(), params.toArray(), String.class);
		} catch (Exception e) {
			return "";
		}

	}

}
