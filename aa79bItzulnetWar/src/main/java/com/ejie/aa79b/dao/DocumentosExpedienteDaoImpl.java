package com.ejie.aa79b.dao;

import java.math.BigDecimal;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;

import org.apache.commons.lang.StringUtils;
import org.springframework.context.i18n.LocaleContextHolder;
import org.springframework.dao.support.DataAccessUtils;
import org.springframework.jdbc.core.ResultSetExtractor;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.common.DBConstants;
import com.ejie.aa79b.common.DaoConstants;
import com.ejie.aa79b.common.SqlUtils;
import com.ejie.aa79b.dao.mapper.Aa79bDocumentosExpedienteRowMapper;
import com.ejie.aa79b.dao.mapper.DocumentosExpedienteConFinalyJustRowMapper;
import com.ejie.aa79b.dao.mapper.DocumentosExpedienteRowMapper;
import com.ejie.aa79b.model.DocumentosExpediente;
import com.ejie.aa79b.model.EntradaDatosDocumento;
import com.ejie.aa79b.model.Expediente;
import com.ejie.aa79b.model.FicheroDocExp;
import com.ejie.aa79b.model.Tareas;
import com.ejie.aa79b.model.enums.ClasificacionDocumentosEnum;
import com.ejie.aa79b.model.enums.OrigenExpedienteEnum;
import com.ejie.aa79b.model.enums.TipoOrigenFicheroEnum;
import com.ejie.aa79b.model.enums.TipoTareaGestionAsociadaEnum;
import com.ejie.aa79b.model.webservices.Aa79bDocumentoExpediente;
import com.ejie.aa79b.model.webservices.Aa79bFicheroDocExp;
import com.ejie.aa79b.security.Usuario;
import com.ejie.aa79b.utils.Utils;
import com.ejie.x38.dto.JQGridManager;
import com.ejie.x38.dto.JQGridRequestDto;

/**
 * DocumentosExpedienteDaoImpl generated by UDA, 06-feb-2018 10:13:42.
 *
 * @author UDA
 */

@Repository()
@Transactional()
public class DocumentosExpedienteDaoImpl extends GenericoDaoImpl<DocumentosExpediente>
		implements DocumentosExpedienteDao {

	protected static final String IDDOC = "IDDOC";
	protected static final String ID_DOC_056 = "ID_DOC_056";
	protected static final String ANYO_056 = "ANYO_056";
	protected static final String NUM_EXP_056 = "NUM_EXP_056";
	protected static final String OID_FICHERO_056 = "OID_FICHERO_056";
	protected static final String EXTENSION_DOC_056 = "EXTENSION_DOC_056";
	protected static final String TAMANO_DOC_056 = "TAMANO_DOC_056";
	protected static final String IND_ENCRIPTADO_056 = "IND_ENCRIPTADO_056";
	protected static final String ID_DOC_REL_056 = "ID_DOC_REL_056";
	protected static final String CLASE_DOCUMENTO_056 = "CLASE_DOCUMENTO_056";
	protected static final String TIPO_DOCUMENTO_056 = "TIPO_DOCUMENTO_056";
	protected static final String TITULO_056 = "TITULO_056";
	protected static final String NUM_PAL_SOLIC_056 = "NUM_PAL_SOLIC_056";
	protected static final String NUM_PAL_IZO_056 = "NUM_PAL_IZO_056";
	protected static final String PERSONA_CONTACTO_056 = "PERSONA_CONTACTO_056";
	protected static final String EMAIL_CONTACTO_056 = "EMAIL_CONTACTO_056";
	protected static final String TELEFONO_CONTACTO_056 = "TELEFONO_CONTACTO_056";
	protected static final String IND_VISIBLE_056 = "IND_VISIBLE_056";
	protected static final String FECHA_ALTA_056 = "FECHA_ALTA_056";
	protected static final String DNI_ALTA_056 = "DNI_ALTA_056";
	protected static final String ID_DOC_VERSION_056 = "ID_DOC_VERSION_056";
	protected static final String DIRECCION_CONTACTO_056 = "DIRECCION_CONTACTO_056";
	protected static final String ENTIDAD_CONTACTO_056 = "ENTIDAD_CONTACTO_056";
	protected static final String NOMBRE_FICHERO_056 = "NOMBRE_FICHERO_056";

	protected static final String[] ORDER_BY_WHITE_LIST = new String[] { IDDOC, DBConstants.ANYO, DBConstants.NUMEXP,
			DBConstants.OIDFICHERO, "EXTENSIONDOC", "TAMANODOC", "INDENCRIPTADO", "IDDOCREL", "CLASEDOCUMENTO",
			"TIPODOCUMENTO", DBConstants.TITULO, "NUMPALSOLIC", "NUMPALIZO", "PERSONACONTACTO", "EMAILCONTACTO",
			"TELEFONOCONTACTO", "INDVISIBLE", DBConstants.FECHAALTA, "DNIALTA", "IDDOCVERSION", "CLASEDOCUMENTODESC" };

	/*
	 * ROW_MAPPERS
	 */
	private RowMapper<DocumentosExpediente> rwMap = new DocumentosExpedienteRowMapper();
	private RowMapper<DocumentosExpediente> rwMapConFinalyJust = new DocumentosExpedienteConFinalyJustRowMapper();

	private RowMapper<Aa79bDocumentoExpediente> aa79bRwMap = new Aa79bDocumentosExpedienteRowMapper();

	private RowMapper<Aa79bFicheroDocExp> aa79bRwMapFichOID = new RowMapper<Aa79bFicheroDocExp>() {
		@Override()
		public Aa79bFicheroDocExp mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			Aa79bFicheroDocExp aa79bFicheroDocExp = new Aa79bFicheroDocExp();
			aa79bFicheroDocExp.setOid(resultSet.getString(OID_FICHERO_056));
			aa79bFicheroDocExp.setNombre(resultSet.getString(NOMBRE_FICHERO_056));
			return aa79bFicheroDocExp;
		}
	};

	private RowMapper<DocumentosExpediente> rwMapPK = new RowMapper<DocumentosExpediente>() {
		@Override()
		public DocumentosExpediente mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			DocumentosExpediente documentosExpediente = new DocumentosExpediente();
			documentosExpediente.setIdDoc(resultSet.getBigDecimal(IDDOC));

			return documentosExpediente;
		}
	};

	private RowMapper<FicheroDocExp> rwMapFichero = new RowMapper<FicheroDocExp>() {
		@Override()
		public FicheroDocExp mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			FicheroDocExp fichero = new FicheroDocExp();
			fichero.setNombre(resultSet.getString(DBConstants.NOMBREFICHERO));
			fichero.setOid(resultSet.getString(DBConstants.OIDFICHERO));
			fichero.setRutaPif(resultSet.getString(DBConstants.RUTAPIFFICHERO));
			fichero.setContentType(resultSet.getString(DBConstants.CONTENTTYPE));
			fichero.setTamano(resultSet.getLong(DBConstants.TAMANODOC));
			return fichero;
		}
	};

	private RowMapper<FicheroDocExp> rwMapFicheroIntermedio = new RowMapper<FicheroDocExp>() {
		@Override()
		public FicheroDocExp mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			FicheroDocExp fichero = new FicheroDocExp();
			fichero.setNombre(resultSet.getString(DBConstants.NOMBREFICHERO));
			fichero.setTituloAux(resultSet.getString("TITULOFICHERO"));
			fichero.setDescTarea(resultSet.getString("DESCTAREA"));
			fichero.setExtension(resultSet.getString("EXTENSIONFICHERO"));
			fichero.setEncriptado(resultSet.getString("INDENCRIPTADO"));
			fichero.setOid(resultSet.getString(DBConstants.OIDFICHERO));
			fichero.setContentType(resultSet.getString(DBConstants.CONTENTTYPE));
			fichero.setTamano(resultSet.getLong(DBConstants.TAMANODOC));
			fichero.setIdDocInsertado(resultSet.getBigDecimal("IDDOC"));
			return fichero;
		}
	};

	/**
	 * Constructor
	 */
	public DocumentosExpedienteDaoImpl() {
		super(DocumentosExpediente.class);
	}

	/**
	 * masParams * @param params List<Object> * @param documentosexpediente
	 * DocumentosExpediente * @param x int
	 *
	 * @return List<Object>
	 */
	public List<Object> masParams(List<Object> params, DocumentosExpediente documentosexpediente, int x) {

		params.add(documentosexpediente.getClaseDocumento());
		params.add(documentosexpediente.getTipoDocumento());
		params.add(documentosexpediente.getTitulo());
		params.add(documentosexpediente.getNumPalSolic());
		params.add(documentosexpediente.getNumPalIzo());
		if (documentosexpediente.getFicheros().get(x).getContacto() != null) {
			params.add(documentosexpediente.getFicheros().get(x).getContacto().getPersona());
			params.add(documentosexpediente.getFicheros().get(x).getContacto().getEmail());
			params.add(documentosexpediente.getFicheros().get(x).getContacto().getTelefono());
		} else {
			params.add(null);
			params.add(null);
			params.add(null);
		}
		params.add(
				(documentosexpediente.getIndVisible() != null) ? documentosexpediente.getIndVisible() : Constants.NO);
		return params;
	}

	/*
	 * OPERACIONES CRUD
	 */

	@Override()
	public DocumentosExpediente add(DocumentosExpediente documentosexpediente, int x) {
		Usuario credentials = (Usuario) SecurityContextHolder.getContext().getAuthentication().getCredentials();
		final Long elIdLong = this.getNextVal("AA79B56Q00");
		final BigDecimal elId = new BigDecimal(elIdLong.longValue());

		if (documentosexpediente.getTitulo() == null) {

			String elTitulo = documentosexpediente.getFicheros().get(x).getNombre();
			elTitulo = elTitulo.substring(Constants.CERO, elTitulo.lastIndexOf('.'));
			documentosexpediente.setTitulo(elTitulo);
		}

		documentosexpediente.setNumPalSolic(documentosexpediente.getNumPalIzo());
		List<Object> params = new ArrayList<Object>();
		params.add(elId);
		params.add(documentosexpediente.getAnyo());
		params.add(documentosexpediente.getNumExp());
		params.add(documentosexpediente.getFicheros().get(x).getOid());
		params.add(documentosexpediente.getFicheros().get(x).getExtension());
		params.add(documentosexpediente.getFicheros().get(x).getTamano());
		params.add(Utils.getValueInd(documentosexpediente.getFicheros().get(x).getEncriptado()));
		params.add((x == 0) ? null : documentosexpediente.getFicheros().get(0).getIdDocInsertado());

		params = this.masParams(params, documentosexpediente, x);

		params.add(new Date());
		params.add(credentials.getNif());
		adicionParametros(documentosexpediente, x, params);
		params.add(documentosexpediente.getFicheros().get(x).getRutaPif());

		params.add(TipoOrigenFicheroEnum.INTERNO.getValue());
		StringBuilder query = new StringBuilder(DocumentosExpedienteDaoImpl.STRING_BUILDER_INIT);
		query.append("INSERT INTO AA79B56S01 ");
		query.append("(ID_DOC_056, ANYO_056, NUM_EXP_056, OID_FICHERO_056, EXTENSION_DOC_056, ");
		query.append(
				"TAMANO_DOC_056, IND_ENCRIPTADO_056, ID_DOC_REL_056, CLASE_DOCUMENTO_056, TIPO_DOCUMENTO_056, TITULO_056, ");
		query.append(
				"NUM_PAL_SOLIC_056, NUM_PAL_IZO_056, PERSONA_CONTACTO_056, EMAIL_CONTACTO_056, TELEFONO_CONTACTO_056, ");
		query.append(
				"IND_VISIBLE_056, FECHA_ALTA_056, DNI_ALTA_056, ID_DOC_VERSION_056,DIRECCION_CONTACTO_056,ENTIDAD_CONTACTO_056, ");
		query.append("CONTENT_TYPE_056, NOMBRE_FICHERO_056, RUTA_PIF_FICHERO_056,IND_ORIGEN_056");
		if (documentosexpediente.getNumPalConcor084() != null && documentosexpediente.getNumPalConcor8594() != null
				&& documentosexpediente.getNumPalConcor9599() != null && documentosexpediente.getNumPalConcor100() != null) {
			// documentos de trabajo pueden llevar tramos de concor v.3.9.40
			params.add(documentosexpediente.getNumPalConcor084());
			params.add(documentosexpediente.getNumPalConcor8594());
			params.add(documentosexpediente.getNumPalConcor9599()+ documentosexpediente.getNumPalConcor100());
			params.add(documentosexpediente.getNumPalConcor9599());
			params.add(documentosexpediente.getNumPalConcor100());
			query.append(" , NUM_PAL_CONCOR_0_84_056, NUM_PAL_CONCOR_85_94_056, NUM_PAL_CONCOR_95_100_056, NUM_PAL_CONCOR_95_99_056, NUM_PAL_CONCOR_100_056");
			query.append(") VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)");
		} else {
			query.append(") VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)");
		}
		this.getJdbcTemplate().update(query.toString(), params.toArray());

		documentosexpediente.getFicheros().get(x).setIdDocInsertado(elId);
		documentosexpediente.setIdDoc(elId);
		documentosexpediente.setTituloDifferentFromFileName();
		return documentosexpediente;
	}

	@Override()
	public DocumentosExpediente update(DocumentosExpediente documentosexpediente, int x) {

		List<Object> params = new ArrayList<Object>();

		params.add(documentosexpediente.getAnyo());
		params.add(documentosexpediente.getNumExp());
		params.add(documentosexpediente.getFicheros().get(x).getOid());
		params.add(documentosexpediente.getFicheros().get(x).getExtension());
		params.add(documentosexpediente.getFicheros().get(x).getTamano());
		params.add(documentosexpediente.getFicheros().get(x).getEncriptado());
		params.add(documentosexpediente.getFicheros().get(x).getIdDocRel());

		params = this.masParams(params, documentosexpediente, x);

		params.add(documentosexpediente.getFicheros().get(x).getFechaAlta());
		params.add(documentosexpediente.getFicheros().get(x).getDniAlta());
		adicionParametros(documentosexpediente, x, params);
		params.add(documentosexpediente.getFicheros().get(x).getRutaPif());

		StringBuilder query = new StringBuilder(DocumentosExpedienteDaoImpl.STRING_BUILDER_INIT);
		query.append("UPDATE AA79B56S01 SET ANYO_056=?, NUM_EXP_056=?, OID_FICHERO_056=?, ");
		query.append(" EXTENSION_DOC_056=?, TAMANO_DOC_056=?, IND_ENCRIPTADO_056=?, ID_DOC_REL_056=?, ");
		query.append(
				" CLASE_DOCUMENTO_056=?, TIPO_DOCUMENTO_056=?, TITULO_056=?, NUM_PAL_SOLIC_056=?, NUM_PAL_IZO_056=?,");
		query.append(
				" PERSONA_CONTACTO_056=?, EMAIL_CONTACTO_056=?, TELEFONO_CONTACTO_056=?, IND_VISIBLE_056=?, FECHA_ALTA_056=?,");
		query.append(
				" DNI_ALTA_056=?, ID_DOC_VERSION_056=?,DIRECCION_CONTACTO_056=?,ENTIDAD_CONTACTO_056=?,CONTENT_TYPE_056=?,NOMBRE_FICHERO_056=?,");
		query.append(" RUTA_PIF_FICHERO_056=? ");
		// Si llega dato de origen lo añado a la update
		if (StringUtils.isNotEmpty(documentosexpediente.getFicheros().get(x).getOrigen())) {
			query.append(", IND_ORIGEN_056=? ");
			params.add(documentosexpediente.getFicheros().get(x).getOrigen());
		}
		if (documentosexpediente.getNumPalConcor084() != null && documentosexpediente.getNumPalConcor8594() != null
				&& documentosexpediente.getNumPalConcor9599() != null && documentosexpediente.getNumPalConcor100() != null) {
			// documentos de trabajo pueden llevar tramos de concor v.3.9.40
			params.add(documentosexpediente.getNumPalConcor084());
			params.add(documentosexpediente.getNumPalConcor8594());
			params.add(documentosexpediente.getNumPalConcor9599()+ documentosexpediente.getNumPalConcor100());
			params.add(documentosexpediente.getNumPalConcor9599());
			params.add(documentosexpediente.getNumPalConcor100());
			query.append(
					" , NUM_PAL_CONCOR_0_84_056 = ?, NUM_PAL_CONCOR_85_94_056 = ?, NUM_PAL_CONCOR_95_100_056 = ?, NUM_PAL_CONCOR_95_99_056 = ?, NUM_PAL_CONCOR_100_056 = ? ");
		}
		query.append(" WHERE ID_DOC_056=?");
		params.add(documentosexpediente.getFicheros().get(x).getIdDocInsertado());
		this.getJdbcTemplate().update(query.toString(), params.toArray());

		documentosexpediente.setTituloDifferentFromFileName();
		return documentosexpediente;
	}

	/**
	 * @param documentosexpediente
	 * @param x
	 * @param params
	 */
	private void adicionParametros(DocumentosExpediente documentosexpediente, int x, List<Object> params) {
		params.add(documentosexpediente.getFicheros().get(x).getIdDocVersion());
		if (documentosexpediente.getFicheros().get(x).getContacto() != null) {
			params.add(documentosexpediente.getFicheros().get(x).getContacto().getDireccion());
			params.add(documentosexpediente.getFicheros().get(x).getContacto().getEntidad());
		} else {
			params.add(null);
			params.add(null);
		}
		params.add(documentosexpediente.getFicheros().get(x).getContentType());
		params.add(documentosexpediente.getFicheros().get(x).getNombre());
	}

	@Override()
	public void remove(DocumentosExpediente documentosexpediente) {

		List<Object> params = new ArrayList<Object>();
		String query = "DELETE FROM AA79B56S01 WHERE (ID_DOC_056=?) OR (ID_DOC_REL_056=?)";
		params.add(documentosexpediente.getIdDoc());
		params.add(documentosexpediente.getIdDoc());
		this.getJdbcTemplate().update(query, params.toArray());
	}

	@Override()
	public List<String> getOidsABorrar(BigDecimal elId) {
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder();
		query.append("SELECT OID_FICHERO_056 FROM AA79B56S01 WHERE (ID_DOC_056=?) OR (ID_DOC_REL_056=?) ");
		params.add(elId);
		params.add(elId);
		return this.getJdbcTemplate().queryForList(query.toString(), params.toArray(), String.class);
	}

	@Override
	protected String getSelect() {
		return this.getSelect(true, null);
	}

	private String getSelect(boolean existe, Locale locale2) {
		Locale locale;
		if (locale2 == null) {
			locale = LocaleContextHolder.getLocale();
		} else {
			locale = locale2;
		}
		StringBuilder query = new StringBuilder();

		query.append("SELECT t1.ID_DOC_056 IDDOC");
		query.append(", t1.ANYO_056 ANYO");
		query.append(", t1.NUM_EXP_056 NUMEXP");
		query.append(", t12.IND_PUBLICAR_BOPV_053 ISBOPV");
		query.append(", t1.OID_FICHERO_056 OIDFICHERO");
		query.append(", t1.EXTENSION_DOC_056 EXTENSIONDOC");
		query.append(", t1.TAMANO_DOC_056 TAMANODOC");
		query.append(", t1.IND_ENCRIPTADO_056 INDENCRIPTADO");
		query.append(", t1.CONTENT_TYPE_056 CONTENTTYPE");
		query.append(", t1.ID_DOC_REL_056 IDDOCREL");
		query.append(", t1.CLASE_DOCUMENTO_056 CLASEDOCUMENTO");
		query.append(", t1.TIPO_DOCUMENTO_056 TIPODOCUMENTO");
		query.append(", t1.TITULO_056 TITULO");
		query.append(", t1.NUM_PAL_SOLIC_056 NUMPALSOLIC");
		query.append(", t1.NUM_PAL_IZO_056 NUMPALIZO");
		query.append(", t1.PERSONA_CONTACTO_056 PERSONACONTACTO");
		query.append(", t1.EMAIL_CONTACTO_056 EMAILCONTACTO");
		query.append(", t1.TELEFONO_CONTACTO_056 TELEFONOCONTACTO");
		query.append(", t1.IND_VISIBLE_056 INDVISIBLE");
		query.append(", t1.FECHA_ALTA_056 FECHAALTA");
		query.append(", t1.IND_ORIGEN_056 ORIGEN");
		if (existe) {
			query.append(", t1.DNI_ALTA_056 DNIALTA");
			query.append(", t1.ID_DOC_VERSION_056 IDDOCVERSION");

		}

		query.append(", t1.DIRECCION_CONTACTO_056 DIRECCIONCONTACTO");
		query.append(", t1.ENTIDAD_CONTACTO_056 ENTIDADCONTACTO");
		query.append(", t1.NOMBRE_FICHERO_056 NOMBREFICHERO");
		query.append(", t1.RUTA_PIF_FICHERO_056 RUTAPIFFICHERO");
		query.append(", t1.NUM_PAL_CONCOR_0_84_056 NUMPALCONCOR084");
		query.append(", t1.NUM_PAL_CONCOR_85_94_056 NUMPALCONCOR8594");
		query.append(", t1.NUM_PAL_CONCOR_95_100_056 NUMPALCONCOR95100");
		query.append(", t1.NUM_PAL_CONCOR_95_99_056 NUMPALCONCOR9599");
		query.append(", t1.NUM_PAL_CONCOR_100_056 NUMPALCONCOR100");

		query.append(", t2.ID_DOC_056 IDDOC2");
		query.append(", t2.ANYO_056 ANYO2");
		query.append(", t2.NUM_EXP_056 NUMEXP2");
		query.append(", t2.OID_FICHERO_056 OIDFICHERO2");
		query.append(", t2.EXTENSION_DOC_056 EXTENSIONDOC2");
		query.append(", t2.TAMANO_DOC_056 TAMANODOC2");
		query.append(", t2.IND_ENCRIPTADO_056 INDENCRIPTADO2");
		query.append(", t2.CONTENT_TYPE_056 CONTENTTYPE2");
		query.append(", t2.ID_DOC_REL_056 IDDOCREL2");
		query.append(", t2.CLASE_DOCUMENTO_056 CLASEDOCUMENTO2");
		query.append(", t2.TIPO_DOCUMENTO_056 TIPODOCUMENTO2");
		query.append(", t2.TITULO_056 TITULO2");
		query.append(", t2.NUM_PAL_SOLIC_056 NUMPALSOLIC2");
		query.append(", t2.NUM_PAL_IZO_056 NUMPALIZO2");
		query.append(", t2.PERSONA_CONTACTO_056 PERSONACONTACTO2");
		query.append(", t2.EMAIL_CONTACTO_056 EMAILCONTACTO2");
		query.append(", t2.TELEFONO_CONTACTO_056 TELEFONOCONTACTO2");
		query.append(", t2.IND_VISIBLE_056 INDVISIBLE2");
		query.append(", t2.FECHA_ALTA_056 FECHAALTA2");
		query.append(", t2.DNI_ALTA_056 DNIALTA2");
		query.append(", t2.ID_DOC_VERSION_056 IDDOCVERSION2");
		query.append(", t2.DIRECCION_CONTACTO_056 DIRECCIONCONTACTO2");
		query.append(", t2.ENTIDAD_CONTACTO_056 ENTIDADCONTACTO2");
		query.append(", t2.NOMBRE_FICHERO_056 NOMBREFICHERO2");
		query.append(", t2.RUTA_PIF_FICHERO_056 RUTAPIFFICHERO2");

		query.append(", t3.DESC_ES_075 AS CLASEDOCUMENTODESCES");
		query.append(", t4.DESC_ES_042 AS TIPODOCUMENTODESCES");
		query.append(", t3.DESC_EU_075 AS CLASEDOCUMENTODESCEU");
		query.append(", t4.DESC_EU_042 AS TIPODOCUMENTODESCEU");

		if (Constants.LANG_CASTELLANO.equals(locale.getLanguage())) {
			query.append(", t3.DESC_ES_075 AS CLASEDOCUMENTODESC");
			query.append(", t4.DESC_ES_042 AS TIPODOCUMENTODESC");
		} else {
			query.append(", t3.DESC_EU_075 AS CLASEDOCUMENTODESC");
			query.append(", t4.DESC_EU_042 AS TIPODOCUMENTODESC");
		}

		query.append(DaoConstants.SIGNO_COMA + DaoConstants.T10_MINUSCULA_PUNTO + DBConstants.NOMBRE_077
				+ DaoConstants.BLANK + DBConstants.NOMBREDOC1 + DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.T10_MINUSCULA_PUNTO + DBConstants.APEL1_077 + DaoConstants.BLANK
				+ DBConstants.APEL1DOC1 + DaoConstants.SIGNO_COMA);
		query.append(
				DaoConstants.T10_MINUSCULA_PUNTO + DBConstants.APEL2_077 + DaoConstants.BLANK + DBConstants.APEL2DOC1);

		return query.toString();
	}

	@Override()
	protected String getFrom() {

		StringBuilder query = new StringBuilder();
		query.append(" FROM AA79B56S01 t1 ");
		query.append(" LEFT JOIN AA79B56S01 t2 ON t1.ID_DOC_056 = t2.ID_DOC_REL_056 ");
		query.append(" LEFT JOIN AA79B75S01 t3 ON t1.CLASE_DOCUMENTO_056 = t3.ID_075 ");
		query.append(" LEFT JOIN AA79B42S01 t4 ON t1.TIPO_DOCUMENTO_056 = t4.ID_042 ");
		query.append(" LEFT JOIN AA79B53T00 t12 ON t1.ANYO_056 = t12.ANYO_053 AND t1.NUM_EXP_056 = t12.NUM_EXP_053 ");

		/* HITO 6 - INICIO */
		query.append(DaoConstants.LEFT_JOIN + DBConstants.TABLA_77 + DaoConstants.BLANK + DaoConstants.T10_MINUSCULA);
		query.append(DaoConstants.ON + DaoConstants.T1_MINUSCULA_PUNTO + DBConstants.DNI_ALTA_056
				+ DaoConstants.SIGNOIGUAL + DaoConstants.T10_MINUSCULA_PUNTO + DBConstants.DNI_077);
		query.append(DaoConstants.LEFT_JOIN + DBConstants.TABLA_77 + DaoConstants.BLANK + DaoConstants.T11_MINUSCULA);
		query.append(DaoConstants.ON + DaoConstants.T2_MINUSCULA_PUNTO + DBConstants.DNI_ALTA_056
				+ DaoConstants.SIGNOIGUAL + DaoConstants.T11_MINUSCULA_PUNTO + DBConstants.DNI_077);

		return query.toString();
	}

	@Override()
	protected RowMapper<DocumentosExpediente> getRwMap() {
		return this.rwMap;
	}

	protected RowMapper<DocumentosExpediente> getRwMapConFinalyJust() {
		return this.rwMapConFinalyJust;
	}

	private RowMapper<Aa79bDocumentoExpediente> getAa79bRwMap() {
		return this.aa79bRwMap;
	}

	@Override()
	protected String[] getOrderBy() {
		return DocumentosExpedienteDaoImpl.ORDER_BY_WHITE_LIST;
	}

	@Override()
	protected String getPK() {
		return ID_DOC_056;
	}

	@Override()
	protected RowMapper<DocumentosExpediente> getRwMapPK() {
		return this.rwMapPK;
	}

	@Override()
	protected String getWherePK(DocumentosExpediente bean, List<Object> params) {
		params.add(bean.getIdDoc());
		return " WHERE t1.ID_DOC_056 = ?";
	}

	// añadir AND t1.ID_DOC_REL_056 = NULL para que no repita el doc relacionado
	@Override()
	protected String getWhere(DocumentosExpediente bean, List<Object> params) {

		StringBuilder where = new StringBuilder(DocumentosExpedienteDaoImpl.STRING_BUILDER_INIT);

		if (bean != null) {
			getWhereComun(bean, params, where);
			if (bean.getClaseDocumentoDesc() != null) {
				this.anadirOrClasesDoc(where, params);
			}
		}
		return where.toString();
	}

	private void anadirOrClasesDoc(StringBuilder laWhere, List<Object> losParams) {
		laWhere.append(" AND (t1.CLASE_DOCUMENTO_056 = ? OR t1.CLASE_DOCUMENTO_056 = ?) ");
		losParams.add(ClasificacionDocumentosEnum.TRADUCCION.getValue());
		losParams.add(ClasificacionDocumentosEnum.REVISION.getValue());
	}

	@Override()
	protected String getWhereLike(DocumentosExpediente bean, Boolean startsWith, List<Object> params, Boolean search) {

		StringBuilder where = new StringBuilder(DocumentosExpedienteDaoImpl.STRING_BUILDER_INIT);

		if (bean != null) {
			getWhereComun(bean, params, where);
		}
		return where.toString();
	}

	/**
	 * @param bean
	 * @param params
	 * @param where
	 */
	private void getWhereComun(DocumentosExpediente bean, List<Object> params, StringBuilder where) {
		where.append(SqlUtils.generarWhereIgual(ID_DOC_056, bean.getIdDoc(), params));
		where.append(SqlUtils.generarWhereIgual("t1." + ANYO_056, bean.getAnyo(), params));
		where.append(SqlUtils.generarWhereIgual("t1." + NUM_EXP_056, bean.getNumExp(), params));
		where.append(SqlUtils.generarWhereIsNull("t1." + ID_DOC_REL_056, true));
		where.append(SqlUtils.generarWhereIsNull("t1." + ID_DOC_VERSION_056, true));
		if (bean.getFicheros() != null && !bean.getFicheros().isEmpty()) {
			where.append(SqlUtils.generarWhereIgual(OID_FICHERO_056, bean.getFicheros().get(0).getOid(), params));
			where.append(
					SqlUtils.generarWhereIgual(EXTENSION_DOC_056, bean.getFicheros().get(0).getExtension(), params));
			where.append(SqlUtils.generarWhereIgual(NOMBRE_FICHERO_056, bean.getFicheros().get(0).getNombre(), params));
			where.append(SqlUtils.generarWhereIgual(TAMANO_DOC_056, bean.getFicheros().get(0).getTamano(), params));
			where.append(
					SqlUtils.generarWhereIgual(IND_ENCRIPTADO_056, bean.getFicheros().get(0).getEncriptado(), params));
			where.append(SqlUtils.generarWhereIgual(ID_DOC_REL_056, bean.getFicheros().get(0).getIdDocRel(), params));
			where.append(SqlUtils.generarWhereIgual(FECHA_ALTA_056, bean.getFicheros().get(0).getFechaAlta(), params));
			where.append(SqlUtils.generarWhereIgual(DNI_ALTA_056, bean.getFicheros().get(0).getDniAlta(), params));
			where.append(SqlUtils.generarWhereIgual(ID_DOC_VERSION_056, bean.getFicheros().get(0).getIdDocVersion(),
					params));
			if (bean.getFicheros().get(0).getContacto() != null) {
				where.append(SqlUtils.generarWhereIgual(PERSONA_CONTACTO_056,
						bean.getFicheros().get(0).getContacto().getPersona(), params));
				where.append(SqlUtils.generarWhereIgual(EMAIL_CONTACTO_056,
						bean.getFicheros().get(0).getContacto().getEmail(), params));
				where.append(SqlUtils.generarWhereIgual(TELEFONO_CONTACTO_056,
						bean.getFicheros().get(0).getContacto().getTelefono(), params));
				where.append(SqlUtils.generarWhereIgual(DIRECCION_CONTACTO_056,
						bean.getFicheros().get(0).getContacto().getDireccion(), params));
				where.append(SqlUtils.generarWhereIgual(ENTIDAD_CONTACTO_056,
						bean.getFicheros().get(0).getContacto().getEntidad(), params));
			}
		}
		where.append(SqlUtils.generarWhereIgual(CLASE_DOCUMENTO_056, bean.getClaseDocumento(), params));
		where.append(SqlUtils.generarWhereIgual(TIPO_DOCUMENTO_056, bean.getTipoDocumento(), params));
		where.append(SqlUtils.generarWhereIgual(TITULO_056, bean.getTitulo(), params));
		where.append(SqlUtils.generarWhereIgual(NUM_PAL_SOLIC_056, bean.getNumPalSolic(), params));
		where.append(SqlUtils.generarWhereIgual(NUM_PAL_IZO_056, bean.getNumPalIzo(), params));
		where.append(SqlUtils.generarWhereIgual(IND_VISIBLE_056, bean.getIndVisible(), params));
	}

	@Override()
	public Long comprobarencriptados(DocumentosExpediente documentosExpedienteFiltro, String reqEncriptado) {
		final List<Object> params = new ArrayList<Object>();
		final StringBuilder query = new StringBuilder(DocumentosExpedienteDaoImpl.STRING_BUILDER_INIT);

		// LOS FICHEROS DE CUALQUIER CLASE DE DOCUMENTO O SOLO LOS DE TRADUCCiÓN
		// y REVISIÓN?
		query.append(
				"SELECT COUNT(1) FROM aa79b56s01 WHERE ANYO_056 = ? AND NUM_EXP_056 = ? AND IND_ENCRIPTADO_056 = ? AND ID_DOC_VERSION_056 IS NULL");
		params.add(documentosExpedienteFiltro.getAnyo());
		params.add(documentosExpedienteFiltro.getNumExp());
		params.add(reqEncriptado);
		return this.getJdbcTemplate().queryForObject(query.toString(), params.toArray(), Long.class);
	}

	@Override
	public Integer sumatorioPalabrasExpediente(DocumentosExpediente bean) {
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder(
				"SELECT NVL(SUM( NUM_PAL_IZO_056 ),0) sumaPalabras FROM AA79B56S01 WHERE ANYO_056 = ?  AND NUM_EXP_056 = ?");
		params.add(bean.getAnyo());
		params.add(bean.getNumExp());
		if (bean.getIdDoc() != null) {
			query.append("  AND ID_DOC_056 != ? ");
			params.add(bean.getIdDoc());
		}
		return this.getJdbcTemplate().queryForObject(query.toString(), params.toArray(), Integer.class);
	}

	@Override
	public List<Aa79bFicheroDocExp> getAa79bDocumentoExpediente(EntradaDatosDocumento bean) {
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder();
		query.append("SELECT OID_FICHERO_056, NOMBRE_FICHERO_056 ");
		query.append("FROM AA79B56S01 ");
		query.append("WHERE ID_DOC_056 IN (?) ");
		query.append("AND ANYO_056 = ? AND NUM_EXP_056 = ? ");
		query.append("AND EXISTS ( ");
		query.append("SELECT NUM_EXP_054 ");
		query.append("FROM AA79B54T00 ");
		query.append("WHERE ANYO_054 = ? ");
		query.append("AND NUM_EXP_054 = ? ");
		params.add(bean.getIdsFichero());
		params.add(bean.getAnyo());
		params.add(bean.getNumExp());
		params.add(bean.getAnyo());
		params.add(bean.getNumExp());

		return this.getJdbcTemplate().query(query.toString(), this.aa79bRwMapFichOID, params.toArray());
	}

	@Override
	public List<Aa79bDocumentoExpediente> getAa79bDocumentosExpediente(Aa79bDocumentoExpediente bean, Locale locale) {
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder(this.getSelect(false, locale));

		/* HITO 6 - INICIO */
		getSelectFinalJustificante(query);
		// Añadimos para recuperar el oid de los ficheros firmados, solo para
		// aa06a
		query.append(
				" ,T5.ID_DOC_FIRMADO_ORIG_092 ID_DOC_ORIG_FIRMADO, T5.ID_DOC_FIRMADO_FINAL_092 ID_DOC_FINAL_FIRMADO ");

		query.append(this.getFrom());

		getFromAnadidoFinalJustificante(query, null);

		/* HITO 6 - FIN */
		query.append(
				" WHERE t1.ANYO_056 = ? AND t1.NUM_EXP_056 = ? AND t1.ID_DOC_REL_056 IS NULL AND t1.ID_DOC_VERSION_056 IS NULL AND t1.IND_VISIBLE_056 = 'S' AND (T1.CLASE_DOCUMENTO_056 <> ")
				.append(ClasificacionDocumentosEnum.TRABAJO.getValue());
		query.append(" OR T1.CLASE_DOCUMENTO_056 IS NULL) ");
		query.append(DaoConstants.ORDER_BY + "T1.ID_DOC_056 ASC ");
		params.add(bean.getAnyo());
		params.add(bean.getNumExp());
		return this.getJdbcTemplate().query(query.toString(), this.getAa79bRwMap(), params.toArray());
	}

	/**
	 * @param query
	 */
	private void getFromAnadidoFinalJustificante(StringBuilder query, String dni) {
		query.append(
				" LEFT JOIN AA79B81S01 T9 ON (T1.NUM_EXP_056 = T9.NUM_EXP_081 AND T1.ANYO_056 = T9.ANYO_081 AND T9.IND_NO_CONFORMIDAD_081 = 'N' AND t9.ID_TIPO_TAREA_081 in (")
				.append(TipoTareaGestionAsociadaEnum.CORREDACTAR.getValue() + ","
						+ TipoTareaGestionAsociadaEnum.ENTREGA_CLIENTE_TRADUCCION.getValue() + ","
						+ TipoTareaGestionAsociadaEnum.TRAD_ENTREGA_CLIENTE_TRADUCCION.getValue() + ","
						+ TipoTareaGestionAsociadaEnum.ENTREGA_CLIENTE_REVISION.getValue())
				.append(")");
		if (StringUtils.isNotBlank(dni)) {
			query.append(" AND dni_recurso_081 = '").append(dni).append("'");
		}

		query.append(
				") LEFT JOIN AA79B92S01 T5 ON ( T1.ID_DOC_056 = T5.ID_DOC_ORIG_092 AND IND_VISIBLE_092 = 'S' AND t9.ID_TAREA_081 = t5.iD_TAREA_092) LEFT JOIN AA79B88S01 T6 ON T5.ID_FICHERO_FINAL_092 = T6.ID_FICHERO_088 LEFT JOIN AA79B88S01 T11 ON T5.ID_DOC_FINAL_ORIG_092 = T11.ID_FICHERO_088 ");
		query.append(
				" LEFT JOIN AA79B93S01 t7 ON (t1.ID_DOC_056 = t7.ID_DOC_ORIG_093 AND IND_VISIBLE_093='S' AND t9.id_tarea_081 = t7.id_tarea_093) LEFT JOIN AA79B88S01 t8 ON t7.ID_FICHERO_JUSTIFICANTE_093 = t8.ID_FICHERO_088 ");
	}

	/**
	 * @param query
	 */
	private void getSelectFinalJustificante(StringBuilder query) {
		query.append(DaoConstants.SIGNO_COMA + DaoConstants.TO_CHAR + DaoConstants.ABRIR_PARENTESIS
				+ DaoConstants.T1_MINUSCULA_PUNTO + DBConstants.FECHA_ALTA_056 + DaoConstants.SIGNO_COMA
				+ DaoConstants.FORMATO_HORA + DaoConstants.CERRAR_PARENTESIS + DBConstants.HORAALTA
				+ DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.T10_MINUSCULA_PUNTO + DBConstants.NOMBRE_077 + DaoConstants.BLANK
				+ DBConstants.NOMBREDOC1 + DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.T10_MINUSCULA_PUNTO + DBConstants.APEL1_077 + DaoConstants.BLANK
				+ DBConstants.APEL1DOC1 + DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.T10_MINUSCULA_PUNTO + DBConstants.APEL2_077 + DaoConstants.BLANK
				+ DBConstants.APEL2DOC1 + DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.TO_CHAR + DaoConstants.ABRIR_PARENTESIS + DaoConstants.T2_MINUSCULA_PUNTO
				+ DBConstants.FECHA_ALTA_056 + DaoConstants.SIGNO_COMA + DaoConstants.FORMATO_HORA
				+ DaoConstants.CERRAR_PARENTESIS + DBConstants.HORAALTA2 + DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.T11_MINUSCULA_PUNTO + DBConstants.NOMBRE_077 + DaoConstants.BLANK
				+ DBConstants.NOMBREDOC2 + DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.T11_MINUSCULA_PUNTO + DBConstants.APEL1_077 + DaoConstants.BLANK
				+ DBConstants.APEL1DOC2 + DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.T11_MINUSCULA_PUNTO + DBConstants.APEL2_077 + DaoConstants.BLANK
				+ DBConstants.APEL2DOC2 + DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.T5_MINUSCULA_PUNTO + DBConstants.FECHA_ALTA_092 + DaoConstants.BLANK
				+ DBConstants.FECHAALTAFICHEROFINAL + DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.TO_CHAR + DaoConstants.ABRIR_PARENTESIS + DaoConstants.T5_MINUSCULA_PUNTO
				+ DBConstants.FECHA_ALTA_092 + DaoConstants.SIGNO_COMA + DaoConstants.FORMATO_HORA
				+ DaoConstants.CERRAR_PARENTESIS + DBConstants.HORAALTAFICHEROFINAL + DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.T7_MINUSCULA_PUNTO + DBConstants.FECHA_ALTA_093 + DaoConstants.BLANK
				+ DBConstants.FECHAALTAJUSTIFICANTE + DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.TO_CHAR + DaoConstants.ABRIR_PARENTESIS + DaoConstants.T7_MINUSCULA_PUNTO
				+ DBConstants.FECHA_ALTA_093 + DaoConstants.SIGNO_COMA + DaoConstants.FORMATO_HORA
				+ DaoConstants.CERRAR_PARENTESIS + DBConstants.HORAALTAJUSTIFICANTE);
		/* HITO 6 - INICIO */
		query.append(" ,t5.ID_FICHERO_FINAL_092 ID_FICHERO_FINAL, t5.IND_VISIBLE_092 IND_VISIBLE_FINAL, "
				+ "t6.IND_ENCRIPTADO_088 IND_ENCRIPTADO_FINAL,t6.OID_FICHERO_088 OID_FICHERO_FINAL,t6.TITULO_FICHERO_088 "
				+ "TITULO_FICHERO_FINAL,t6.EXTENSION_FICHERO_088 EXTENSION_FICHERO_FINAL,t6.TAMANO_FICHERO_088 TAMANO_FICHERO_FINAL, "
				+ "t6.CONTENT_TYPE_FICHERO_088 CONTENTTYPE_FINAL, T6.NOMBRE_FICHERO_088 NOMBRE_FICHERO_FINAL ");
		query.append(" ,t5.ID_DOC_FINAL_ORIG_092 ID_DOC_FINAL_ORIG, "
				+ "t11.IND_ENCRIPTADO_088 IND_ENCRIPTADO_FINAL_ORIG,t11.OID_FICHERO_088 OID_FICHERO_FINAL_ORIG, "
				+ "t11.TITULO_FICHERO_088 TITULO_FICHERO_FINAL_ORIG,t11.EXTENSION_FICHERO_088 EXTENSION_FICHERO_FINAL_ORIG,t11.TAMANO_FICHERO_088 TAMANO_FICHERO_FINAL_ORIG, "
				+ "t11.CONTENT_TYPE_FICHERO_088 CONTENTTYPE_FINAL_ORIG, t11.NOMBRE_FICHERO_088 NOMBRE_FICHERO_FINAL_ORIG ");
		query.append(
				" ,t7.ID_FICHERO_JUSTIFICANTE_093 ID_FICHERO_JUSTIFICANTE, t7.IND_VISIBLE_093 IND_VISIBLE_JUSTIFICANTE,"
						+ " t8.IND_ENCRIPTADO_088 IND_ENCRIPTADO_JUSTIFICANTE,t8.OID_FICHERO_088 OID_FICHERO_JUSTIFICANTE,"
						+ "t8.TITULO_FICHERO_088 TITULO_FICHERO_JUSTIFICANTE,t8.EXTENSION_FICHERO_088 EXTENSION_FICHERO_JUSTIFICANTE,"
						+ "t8.TAMANO_FICHERO_088 TAMANO_FICHERO_JUSTIFICANTE, t8.CONTENT_TYPE_FICHERO_088 CONTENTTYPE_JUSTIFICANTE,"
						+ "t8.NOMBRE_FICHERO_088 NOMBRE_FICHERO_JUSTIFICANTE ");
		query.append(",T1.IND_ORIGEN_056 ORIGEN,T2.IND_ORIGEN_056 ORIGEN2 ");
	}

	/**
	 *
	 * @param anyo    Long
	 * @param numExp  Integer
	 * @param idTarea BigDecimal
	 * @return Map<String, BigDecimal>
	 */
	@Override()
	public Map<String, BigDecimal> getMapaDocumentosExpediente(Long anyo, Integer numExp, BigDecimal idTarea) {
		final StringBuilder query = new StringBuilder();
		query.append(" SELECT t1.ID_DOC_056 IDDOC, t1.NOMBRE_FICHERO_056 NOMBRE_FICHERO_056 ")
				.append(" FROM AA79B56S01 t1 ").append(" JOIN AA79B83S01 t2 ")
				.append(" ON t1.ID_DOC_056 = t2.ID_DOC_083 ").append(" JOIN AA79B81S01 t3 ")
				.append(" ON t2.ID_TAREA_083 = t3.ID_TAREA_081 ").append(" AND t3.ANYO_081 = t1.ANYO_056 ")
				.append(" AND t3.NUM_EXP_081 = t1.NUM_EXP_056 ").append(DaoConstants.WHERE_1_1)
				.append(" AND t1.ANYO_056 = ? AND t1.NUM_EXP_056 = ? ").append(" AND t3.ID_TAREA_081 = ? ")
				.append(" AND (t1.CLASE_DOCUMENTO_056 = ? OR t1.CLASE_DOCUMENTO_056 = ?) ");
		return this.getJdbcTemplate().query(query.toString(), this.resultSetMapa, anyo, numExp, idTarea,
				ClasificacionDocumentosEnum.TRADUCCION.getValue(), ClasificacionDocumentosEnum.TRABAJO.getValue());
	}

	ResultSetExtractor<Map<String, BigDecimal>> resultSetMapa = new ResultSetExtractor<Map<String, BigDecimal>>() {
		@Override
		public Map<String, BigDecimal> extractData(ResultSet rs) throws SQLException {
			Map<String, BigDecimal> mapOfKeys = new HashMap<String, BigDecimal>();
			while (rs.next()) {
				mapOfKeys.put(rs.getString(NOMBRE_FICHERO_056), rs.getBigDecimal(IDDOC));
			}
			return mapOfKeys;
		}
	};

	@Override
	public List<DocumentosExpediente> findAllEstudioSubsanacion(Long anyo, Integer numExp, Long idTarea) {
		Locale locale = LocaleContextHolder.getLocale();
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder(this.getSelect(true, locale));
		query.replace(0, 6, DaoConstants.SELECT + DaoConstants.DISTINCT);
		query.append(" FROM AA79B56S01 t1 ");
		query.append(" LEFT JOIN AA79B56S01 t2 ON t1.ID_DOC_056 = t2.ID_DOC_REL_056 ");
		query.append(" LEFT JOIN AA79B75S01 t3 ON t1.CLASE_DOCUMENTO_056 = t3.ID_075 ");
		query.append(" LEFT JOIN AA79B42S01 t4 ON t1.TIPO_DOCUMENTO_056 = t4.ID_042 ");
		query.append(DaoConstants.JOIN + DBConstants.TABLA_081 + " t5 ");
		query.append(DaoConstants.ON + "t5.ANYO_081 = t1.ANYO_056 ");
		query.append(DaoConstants.AND + "t5.NUM_EXP_081 = t1.NUM_EXP_056");
		query.append(DaoConstants.JOIN + DBConstants.TABLA_083 + " t7 ");
		query.append(DaoConstants.ON + "t5.ID_TAREA_081 = t7.ID_TAREA_083 ");
		query.append(DaoConstants.AND + "t1.ID_DOC_056 = t7.ID_DOC_083");
		query.append(DaoConstants.LEFT_JOIN + DBConstants.TABLA_066 + " t6");
		query.append(DaoConstants.ON + "t6.ID_066 = t5.ID_REQUERIMIENTO_081");
		query.append(DaoConstants.AND + " t6.ID_DOC_066 = t1.ID_DOC_056 ");
		query.append(DaoConstants.WHERE_1_1);
		query.append(DaoConstants.AND + "t1.ANYO_056 " + DaoConstants.SIGNOIGUAL_INTERROGACION);
		query.append(DaoConstants.AND + "t1.NUM_EXP_056 " + DaoConstants.SIGNOIGUAL_INTERROGACION);
		query.append(DaoConstants.AND + "t5.ID_TAREA_081 " + DaoConstants.SIGNOIGUAL_INTERROGACION);
		query.append(DaoConstants.AND + "t1.ID_DOC_REL_056" + DaoConstants.IS_NULL);
		query.append(DaoConstants.AND + "t1.ID_DOC_VERSION_056" + DaoConstants.IS_NULL);
		params.add(anyo);
		params.add(numExp);
		params.add(idTarea);
		return this.getJdbcTemplate().query(query.toString(), this.rwMap, params.toArray());
	}

	@Override
	public FicheroDocExp findDatosFichero(BigDecimal idDoc) {

		final List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder();

		query.append(DaoConstants.SELECT);
		query.append(DaoConstants.T1).append(".OID_FICHERO_056");
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.OIDFICHERO);
		query.append(DaoConstants.BLANK);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.T1).append(".NOMBRE_FICHERO_056");
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.NOMBREFICHERO);
		query.append(DaoConstants.BLANK);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.T1).append(".RUTA_PIF_FICHERO_056");
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.RUTAPIFFICHERO);
		query.append(DaoConstants.BLANK);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.T1).append(".CONTENT_TYPE_056");
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.CONTENTTYPE);
		query.append(DaoConstants.BLANK);
		query.append(DaoConstants.SIGNO_COMA);
		query.append(DaoConstants.T1).append(".TAMANO_DOC_056");
		query.append(DaoConstants.BLANK);
		query.append(DBConstants.TAMANODOC);
		query.append(DaoConstants.BLANK);
		query.append(DaoConstants.FROM);
		query.append(DBConstants.TABLA_56);
		query.append(DaoConstants.BLANK);
		query.append(DaoConstants.T1);
		query.append(DaoConstants.WHERE);
		query.append(DaoConstants.T1).append(".ID_DOC_056");
		query.append(DaoConstants.SIGNOIGUAL_INTERROGACION);

		params.add(idDoc);

		List<FicheroDocExp> beanList = this.getJdbcTemplate().query(query.toString(), this.rwMapFichero,
				params.toArray());

		return DataAccessUtils.uniqueResult(beanList);
	}

	@Override()
	public List<DocumentosExpediente> findDocumentosTarea(DocumentosExpediente documentosExpediente, String dni,
			JQGridRequestDto jqGridRequestDto) {
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder(this.getSelect());
		// From
		query.append(this.getFrom(documentosExpediente, params));
		// Where
		query.append(DocumentosExpedienteDaoImpl.DEFAULT_WHERE);
		query.append(this.getWhere(documentosExpediente, params));

		query.append(DaoConstants.AND + " T1.ID_DOC_056 IN (");
		query.append(" SELECT ID_DOC_083 FROM AA79B83T00, AA79B81T00 WHERE ");
		query.append(" ID_TAREA_083 = ID_TAREA_081 AND  DNI_RECURSO_081 = ? AND ANYO_081 = ? AND NUM_EXP_081 = ? ) ");
		params.add(dni);
		params.add(documentosExpediente.getAnyo());
		params.add(documentosExpediente.getNumExp());

		if (jqGridRequestDto != null) {
			query = JQGridManager.getPaginationQuery(jqGridRequestDto, query, this.getOrderBy());
		}

		return this.getJdbcTemplate().query(query.toString(), this.getRwMap(), params.toArray());
	}

	@Override()
	public List<DocumentosExpediente> findAllConFinales(DocumentosExpediente documentosExpediente, String dni,
			JQGridRequestDto jqGridRequestDto) {
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder(this.getSelect());

		/* Añadimos la info del final y justificante */
		getSelectFinalJustificante(query);
		query.append(
				" ,T5.ID_DOC_FIRMADO_ORIG_092 ID_DOC_ORIG_FIRMADO, T5.ID_DOC_FIRMADO_FINAL_092 ID_DOC_FINAL_FIRMADO ");
		// From
		query.append(this.getFrom(documentosExpediente, params));
		/* Añadimos las joins del doc final y justificante */
		getFromAnadidoFinalJustificante(query, dni);

		// Where
		query.append(DocumentosExpedienteDaoImpl.DEFAULT_WHERE);
		query.append(this.getWhere(documentosExpediente, params));

		if (StringUtils.isNotBlank(dni)) {
			query.append(DaoConstants.AND + " T1.ID_DOC_056 IN (");
			query.append(" SELECT ID_DOC_083 FROM AA79B83T00, AA79B81T00 WHERE ");
			query.append(
					" ID_TAREA_083 = ID_TAREA_081 AND  DNI_RECURSO_081 = ? AND ANYO_081 = ? AND NUM_EXP_081 = ? ) ");
			params.add(dni);
			params.add(documentosExpediente.getAnyo());
			params.add(documentosExpediente.getNumExp());
		}

		if (jqGridRequestDto != null) {
			query = JQGridManager.getPaginationQuery(jqGridRequestDto, query, this.getOrderBy());
		}

		return this.getJdbcTemplate().query(query.toString(), this.getRwMapConFinalyJust(), params.toArray());
	}

	@Override()
	public List<FicheroDocExp> findAllIntermedios(DocumentosExpediente documentosExpediente, String dni,
			JQGridRequestDto jqGridRequestDto) {
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder(DocumentosExpedienteDaoImpl.STRING_BUILDER_INIT);

		query.append(
				"SELECT ID_DOC_083,ID_FICHERO_088 IDDOC,OID_FICHERO_088 OIDFICHERO,TITULO_FICHERO_088 TITULOFICHERO, ");
		query.append(
				"EXTENSION_FICHERO_088 EXTENSIONFICHERO,TAMANO_FICHERO_088 TAMANODOC, IND_ENCRIPTADO_088 INDENCRIPTADO,");
		query.append(
				"CONTENT_TYPE_FICHERO_088 CONTENTTYPE,NOMBRE_FICHERO_088 NOMBREFICHERO, FECHA_ALTA_087 FECHAALTA,");
		query.append("T1.ID_TAREA_081 || '-' || DESC_EU_015 DESCTAREA ");
		query.append("FROM AA79B81T00 T1 ");
		query.append("JOIN AA79B82T00 ON T1.ID_TAREA_081 = ID_TAREA_082 AND T1.ESTADO_EJECUCION_081 = 3 ");
		query.append("JOIN AA79B83T00 ON T1.ID_TAREA_081 = ID_TAREA_083 AND ID_DOC_083 = ? ");
		query.append("JOIN AA79B87S01 T5 ON ( ID_DOC_083 = ID_DOC_ORIG_087 AND T1.ID_TAREA_081 = ID_TAREA_087 ) ");
		query.append("JOIN AA79B88S01 ON ID_FICHERO_TRADUCIDO_087 = ID_FICHERO_088 ");
		query.append("JOIN AA79B15S01 ON T1.ID_TIPO_TAREA_081 = ID_015 ");
		params.add(documentosExpediente.getIdDoc());
		// Si llega DNI es una consulta desde un perfil de traductor
		// Si no llega --> perfil técnico
		if (StringUtils.isNotBlank(dni)) {
			query.append(" LEFT JOIN AA79B81T00 TAREASTRAD ON T1.ANYO_081 = TAREASTRAD.ANYO_081 ");
			query.append(
					" AND T1.NUM_EXP_081 = TAREASTRAD.NUM_EXP_081 AND TAREASTRAD.DNI_RECURSO_081 = ? AND T1.ORDEN_081 <= TAREASTRAD.ORDEN_081 ");
			params.add(dni);
		}

		query.append("WHERE T1.ID_TIPO_TAREA_081 IN (?,?,?,?,?) ");
		query.append("AND T1.ANYO_081 = ? AND T1.NUM_EXP_081 = ? ");
		params.add(TipoTareaGestionAsociadaEnum.TRADUCIR.getValue());
		params.add(TipoTareaGestionAsociadaEnum.CORREDACTAR.getValue());
		params.add(TipoTareaGestionAsociadaEnum.REVISAR.getValue());
		params.add(TipoTareaGestionAsociadaEnum.NO_CONFORMIDAD_PROVEEDOR.getValue());
		params.add(TipoTareaGestionAsociadaEnum.REVISAR_TRADUCCION.getValue());
		params.add(documentosExpediente.getAnyo());
		params.add(documentosExpediente.getNumExp());

		if (StringUtils.isNotBlank(dni)) {
			query.append(
					" AND ( TAREASTRAD.ID_TAREA_REL_081 = T1.ID_TAREA_081 OR TAREASTRAD.ID_TAREA_REL_081 = T1.ID_TAREA_REL_081 ");
			query.append(" OR TAREASTRAD.ID_TAREA_081 = T1.ID_TAREA_081 ) ");
		}

		if (jqGridRequestDto != null) {
			query = JQGridManager.getPaginationQuery(jqGridRequestDto, query, this.getOrderBy());
		}

		return this.getJdbcTemplate().query(query.toString(), this.rwMapFicheroIntermedio, params.toArray());
	}

	@Override()
	public List<FicheroDocExp> findAllJustificantesIntermedios(DocumentosExpediente documentosExpediente, String dni,
			JQGridRequestDto jqGridRequestDto) {
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder(DocumentosExpedienteDaoImpl.STRING_BUILDER_INIT);

		query.append(
				"SELECT ID_DOC_083,ID_FICHERO_088 IDDOC,OID_FICHERO_088 OIDFICHERO,TITULO_FICHERO_088 TITULOFICHERO, ");
		query.append(
				"EXTENSION_FICHERO_088 EXTENSIONFICHERO,TAMANO_FICHERO_088 TAMANODOC, IND_ENCRIPTADO_088 INDENCRIPTADO,");
		query.append(
				"CONTENT_TYPE_FICHERO_088 CONTENTTYPE,NOMBRE_FICHERO_088 NOMBREFICHERO, FECHA_ALTA_093 FECHAALTA,");
		query.append("T1.ID_TAREA_081 || '-' || DESC_EU_015 DESCTAREA ");
		query.append("FROM AA79B81T00 T1 ");
		query.append("JOIN AA79B82T00 ON T1.ID_TAREA_081 = ID_TAREA_082 AND T1.ESTADO_EJECUCION_081 = 3 ");
		query.append("JOIN AA79B83T00 ON T1.ID_TAREA_081 = ID_TAREA_083 AND ID_DOC_083 = ? ");
		query.append("JOIN AA79B93S01 T5 ON ( ID_DOC_083 = ID_DOC_ORIG_093 AND T1.ID_TAREA_081 = ID_TAREA_093 ) ");
		query.append("JOIN AA79B88S01 ON ID_FICHERO_JUSTIFICANTE_093 = ID_FICHERO_088 ");
		query.append("JOIN AA79B15S01 ON T1.ID_TIPO_TAREA_081 = ID_015 ");
		params.add(documentosExpediente.getIdDoc());
		// Si llega DNI es una consulta desde un perfil de traductor
		// Si no llega --> perfil técnico
		if (StringUtils.isNotBlank(dni)) {
			query.append(" LEFT JOIN AA79B81T00 TAREASTRAD ON T1.ANYO_081 = TAREASTRAD.ANYO_081 ");
			query.append(
					" AND T1.NUM_EXP_081 = TAREASTRAD.NUM_EXP_081 AND TAREASTRAD.DNI_RECURSO_081 = ? AND T1.ORDEN_081 <= TAREASTRAD.ORDEN_081 ");
			params.add(dni);
		}

		query.append("WHERE T1.ID_TIPO_TAREA_081 IN (?,?,?,?,?) ");
		query.append("AND T1.ANYO_081 = ? AND T1.NUM_EXP_081 = ? ");
		params.add(TipoTareaGestionAsociadaEnum.TRADUCIR.getValue());
		params.add(TipoTareaGestionAsociadaEnum.CORREDACTAR.getValue());
		params.add(TipoTareaGestionAsociadaEnum.REVISAR.getValue());
		params.add(TipoTareaGestionAsociadaEnum.NO_CONFORMIDAD_PROVEEDOR.getValue());
		params.add(TipoTareaGestionAsociadaEnum.REVISAR_TRADUCCION.getValue());
		params.add(documentosExpediente.getAnyo());
		params.add(documentosExpediente.getNumExp());

		if (StringUtils.isNotBlank(dni)) {
			query.append(
					" AND ( TAREASTRAD.ID_TAREA_REL_081 = T1.ID_TAREA_081 OR TAREASTRAD.ID_TAREA_REL_081 = T1.ID_TAREA_REL_081 ");
			query.append(" OR TAREASTRAD.ID_TAREA_081 = T1.ID_TAREA_081 ) ");
		}

		if (jqGridRequestDto != null) {
			query = JQGridManager.getPaginationQuery(jqGridRequestDto, query, this.getOrderBy());
		}

		return this.getJdbcTemplate().query(query.toString(), this.rwMapFicheroIntermedio, params.toArray());
	}

	@Override
	public Boolean comprobarXliffObligatorio(Expediente expediente) {
		List<Object> paramsCXO = new ArrayList<Object>();
		StringBuilder queryCXO = new StringBuilder(DocumentosExpedienteDaoImpl.STRING_BUILDER_INIT);
		Boolean esOblig = false;
		queryCXO.append(" SELECT ( ");
		queryCXO.append(" CASE WHEN ((t1.NUM_TOTAL_PAL_IZO_053 > r1.PAL_TRADOS_003) ");
		queryCXO.append(" AND (0 = ");
		queryCXO.append("  (SELECT COUNT(1) ");
		queryCXO.append(" FROM AA79B56S01 c1 ");
		queryCXO.append(" JOIN AA79B42S01 c2 ");
		queryCXO.append(" ON c1.TIPO_DOCUMENTO_056 = c2.ID_042 ");
		queryCXO.append(" JOIN AA79B51S01 c3 ");
		queryCXO.append(" ON c3.ANYO_051 = c1.ANYO_056 ");
		queryCXO.append(" AND c3.NUM_EXP_051 = c1.NUM_EXP_056");
		queryCXO.append(" WHERE c1.ANYO_056  = t1.ANYO_053 ");
		queryCXO.append(" AND c1.NUM_EXP_056 = t1.NUM_EXP_053");
		queryCXO.append("  AND c2.ID_042 = " + Constants.ID_TIPO_DOC_NOTA_PRENSA); // nota_de_prensa
		queryCXO.append(" AND c3.ORIGEN_051 = '" + OrigenExpedienteEnum.OFICIO.getValue() + "' ))) "); // origen_expediente
		queryCXO.append(" THEN " + Constants.UNO);
		queryCXO.append(" ELSE " + Constants.CERO);
		queryCXO.append("  END) RESUL ");
		queryCXO.append(" FROM AA79B53S01 t1 ");
		queryCXO.append(" JOIN AA79B03S01 r1 ");
		queryCXO.append(" ON r1.ID_003 = " + Constants.CERO);
		queryCXO.append(" WHERE 1=1 ");
		queryCXO.append(SqlUtils.generarWhereIgual("t1.ANYO_053", expediente.getAnyo(), paramsCXO));
		queryCXO.append(SqlUtils.generarWhereIgual("t1.NUM_EXP_053", expediente.getNumExp(), paramsCXO));
		Integer iResul = this.getJdbcTemplate().queryForObject(queryCXO.toString(), Integer.class, paramsCXO.toArray());
		if (iResul > Constants.CERO) {
			esOblig = true;
		}
		return esOblig;
	}

	@Override
	public Boolean comprobarXliffObligatorioAlinearPostEntrega(Tareas tarea) {
		List<Object> paramsCXO = new ArrayList<Object>();
		StringBuilder queryCXO = new StringBuilder();
		Boolean esOblig = false;
		queryCXO.append("SELECT COUNT(*) FROM AA79B96T00 WHERE ID_TAREA_096 = ?");
		Integer iResul = this.getJdbcTemplate().queryForObject(queryCXO.toString(), Integer.class, tarea.getIdTarea());
		if (iResul == Constants.CERO) {
			esOblig = true;
		}
		return esOblig;
	}

}
