package com.ejie.aa79b.dao;

import java.math.BigDecimal;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;
import java.util.Locale;

import org.springframework.context.i18n.LocaleContextHolder;
import org.springframework.dao.support.DataAccessUtils;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.common.DBConstants;
import com.ejie.aa79b.common.DaoConstants;
import com.ejie.aa79b.common.SqlUtils;
import com.ejie.aa79b.model.AusenciasCalendarioPersonal;
import com.ejie.aa79b.model.enums.TipoJornadaEnum;

/**
 * AusenciasCalendarioPersonalDaoImpl generated by UDA, 17-nov-2017 13:04:12.
 * 
 * @author UDA
 */

@Repository
@Transactional
public class AusenciasCalendarioPersonalDaoImpl extends GenericoDaoImpl<AusenciasCalendarioPersonal>
		implements AusenciasCalendarioPersonalDao {

	protected static final String IDAUSENCIA025 = "IDAUSENCIA025";
	protected static final String ID_AUSENCIA_025 = "ID_AUSENCIA_025";
	protected static final String DNI025 = "DNI025";

	protected static final String ANYO025 = "ANYO025";
	protected static final String FECHADESDE025 = "FECHADESDE025";
	protected static final String FECHAHASTA025 = "FECHAHASTA025";
	protected static final String TIPOJORNADA025 = "TIPOJORNADA025";
	protected static final String TIPOJORNADATXT = "TIPOJORNADATXT";

	protected static final String[] ORDER_BY_WHITE_LIST = new String[] { IDAUSENCIA025, DNI025, ANYO025, FECHADESDE025,
			FECHAHASTA025, TIPOJORNADA025, TIPOJORNADATXT };

	private RowMapper<AusenciasCalendarioPersonal> rwMap = new RowMapper<AusenciasCalendarioPersonal>() {
		@Override
		public AusenciasCalendarioPersonal mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			AusenciasCalendarioPersonal ausenciasCalendarioPersonalAUX = new AusenciasCalendarioPersonal(
					resultSet.getInt(IDAUSENCIA025));

			ausenciasCalendarioPersonalAUX.setDni(resultSet.getString(DNI025));

			ausenciasCalendarioPersonalAUX.setAnyo(resultSet.getLong(ANYO025));
			ausenciasCalendarioPersonalAUX.setFechaDesde(resultSet.getDate(FECHADESDE025));
			ausenciasCalendarioPersonalAUX.setFechaHasta(resultSet.getDate(FECHAHASTA025));
			ausenciasCalendarioPersonalAUX.setTipoJornada(resultSet.getString(TIPOJORNADA025));
			ausenciasCalendarioPersonalAUX.setTipoJornadaTxt(resultSet.getString(TIPOJORNADATXT));
			return ausenciasCalendarioPersonalAUX;

		}
	};

	private RowMapper<AusenciasCalendarioPersonal> rwMapPK = new RowMapper<AusenciasCalendarioPersonal>() {
		@Override
		public AusenciasCalendarioPersonal mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			return new AusenciasCalendarioPersonal(resultSet.getInt(IDAUSENCIA025));
		}
	};

	private RowMapper<AusenciasCalendarioPersonal> rwMapConObservaciones = new RowMapper<AusenciasCalendarioPersonal>() {
		@Override
		public AusenciasCalendarioPersonal mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			AusenciasCalendarioPersonal ausenciasCalendarioPersonalAUX = new AusenciasCalendarioPersonal(
					resultSet.getInt(IDAUSENCIA025));

			ausenciasCalendarioPersonalAUX.setDni(resultSet.getString(DNI025));

			ausenciasCalendarioPersonalAUX.setAnyo(resultSet.getLong(ANYO025));
			ausenciasCalendarioPersonalAUX.setFechaDesde(resultSet.getDate(FECHADESDE025));
			ausenciasCalendarioPersonalAUX.setFechaHasta(resultSet.getDate(FECHAHASTA025));
			ausenciasCalendarioPersonalAUX.setTipoJornada(resultSet.getString(TIPOJORNADA025));
			ausenciasCalendarioPersonalAUX.setObservDia(resultSet.getString("OBSERV_DIA_076"));
			ausenciasCalendarioPersonalAUX.setTipoJornadaTxt(resultSet.getString(TIPOJORNADATXT));
			return ausenciasCalendarioPersonalAUX;

		}
	};

	/**
	 * Constructor
	 */
	public AusenciasCalendarioPersonalDaoImpl() {
		/* Constructor */
		super(AusenciasCalendarioPersonal.class);
	}

	/**
	 * Inserts a single row in the AusenciasCalendarioPersonal table.
	 *
	 * @param ausenciascalendariopersonal
	 *            AusenciasCalendarioPersonal
	 * @return AusenciasCalendarioPersonal
	 */
	@Override
	public AusenciasCalendarioPersonal add(AusenciasCalendarioPersonal ausenciascalendariopersonal) {

		String queryID = "SELECT AA79B25Q00.NEXTVAL from dual";
		Long elIdLong = this.getJdbcTemplate().queryForObject(queryID, Long.class);
		Integer elId = elIdLong.intValue();

		String query = "INSERT INTO AA79B25S01 (ID_AUSENCIA_025,DNI_025, ANYO_025,  FECHA_DESDE_025, FECHA_HASTA_025, TIPO_JORNADA_025, ID_TAREA_INTER_025) VALUES (?,?,?,?,?,?,?)";
		this.getJdbcTemplate().update(query, elId, ausenciascalendariopersonal.getDni(),
				ausenciascalendariopersonal.getAnyo(), ausenciascalendariopersonal.getFechaDesde(),
				ausenciascalendariopersonal.getFechaHasta(), ausenciascalendariopersonal.getTipoJornada(),
				ausenciascalendariopersonal.getIdTarea());
		ausenciascalendariopersonal.setIdAusencia(elId);

		return ausenciascalendariopersonal;
	}

	@Override
	public AusenciasCalendarioPersonal update(AusenciasCalendarioPersonal ausenciascalendariopersonal) {
		String query = "UPDATE AA79B25S01 SET DNI_025=?, FECHA_DESDE_025=?, FECHA_HASTA_025=?, TIPO_JORNADA_025=?, ANYO_025=? WHERE ID_AUSENCIA_025=?";
		this.getJdbcTemplate().update(query, ausenciascalendariopersonal.getDni(),
				ausenciascalendariopersonal.getFechaDesde(), ausenciascalendariopersonal.getFechaHasta(),
				ausenciascalendariopersonal.getTipoJornada(), ausenciascalendariopersonal.getAnyo(),
				ausenciascalendariopersonal.getIdAusencia());
		return ausenciascalendariopersonal;
	}

	@Override
	public void remove(AusenciasCalendarioPersonal ausenciascalendariopersonal) {
		String query = "DELETE FROM AA79B25S01 WHERE ID_AUSENCIA_025=?";
		this.getJdbcTemplate().update(query, ausenciascalendariopersonal.getIdAusencia());
	}

	@Override
	public boolean comprobarRangoAusencias(AusenciasCalendarioPersonal ausenciascalendariopersonal) {
		List<Object> params = new ArrayList<Object>();

		StringBuilder query = new StringBuilder("SELECT COUNT(*) FROM AA79B25S01 t1 WHERE t1.DNI_025 = ? ");
		if (ausenciascalendariopersonal.getIdAusencia() != null) {
			query.append(" AND t1.ID_AUSENCIA_025 != ? ");
		}
		query.append(" AND t1.TIPO_JORNADA_025 != ? ");

		query.append(" AND ((? BETWEEN t1.FECHA_DESDE_025 AND t1.FECHA_HASTA_025) ");
		query.append(" OR (? BETWEEN t1.FECHA_DESDE_025 AND t1.FECHA_HASTA_025) ");
		query.append(" OR (? <= t1.FECHA_DESDE_025 AND ? >= t1.FECHA_HASTA_025 ))");

		params.add(ausenciascalendariopersonal.getDni());
		if (ausenciascalendariopersonal.getIdAusencia() != null) {
			params.add(ausenciascalendariopersonal.getIdAusencia());
		}
		params.add(TipoJornadaEnum.INTERPRETACION.getValue());
		params.add(ausenciascalendariopersonal.getFechaHasta());
		params.add(ausenciascalendariopersonal.getFechaDesde());
		params.add(ausenciascalendariopersonal.getFechaDesde());
		params.add(ausenciascalendariopersonal.getFechaHasta());

		long numConflictos = this.getJdbcTemplate().queryForObject(query.toString(), params.toArray(), Long.class);

		return numConflictos != 0;
	}

	@Override()
	protected String getSelect() {
		Locale locale = LocaleContextHolder.getLocale();
		StringBuilder sb = new StringBuilder();

		sb.append(
				"SELECT t1.DNI_025 DNI025, t1.ANYO_025 ANYO025, t1.ID_AUSENCIA_025 IDAUSENCIA025, t1.FECHA_DESDE_025 FECHADESDE025, t1.FECHA_HASTA_025 FECHAHASTA025, t1.TIPO_JORNADA_025 TIPOJORNADA025 ");

		if (Constants.LANG_CASTELLANO.equals(locale.getLanguage())) {
			sb.append(",t2.DESC_ES_040 TIPOJORNADATXT");
		} else {
			sb.append(",t2.DESC_EU_040 TIPOJORNADATXT");
		}

		return sb.toString();
	}

	@Override()
	protected String getFrom() {
		return "  FROM AA79B25S01 t1 LEFT JOIN AA79B40S01 t2 ON t1.TIPO_JORNADA_025 = t2.ID_040  ";
	}

	@Override()
	protected RowMapper<AusenciasCalendarioPersonal> getRwMap() {
		return this.rwMap;
	}

	@Override()
	protected String[] getOrderBy() {
		return AusenciasCalendarioPersonalDaoImpl.ORDER_BY_WHITE_LIST;
	}

	@Override()
	protected String getPK() {
		return ID_AUSENCIA_025;
	}

	@Override()
	protected RowMapper<AusenciasCalendarioPersonal> getRwMapPK() {
		return this.rwMapPK;
	}

	@Override()
	protected String getWherePK(AusenciasCalendarioPersonal bean, List<Object> params) {
		params.add(bean.getIdAusencia());
		return " WHERE t1.ID_AUSENCIA_025 = ?";
	}

	@Override
	protected String getWhere(AusenciasCalendarioPersonal bean, List<Object> params) {

		StringBuilder where = new StringBuilder(AusenciasCalendarioPersonalDaoImpl.STRING_BUILDER_INIT);

		where.append(SqlUtils.generarWhereIgual("DNI_025", bean.getDni(), params));
		where.append(SqlUtils.generarWhereIgual("ANYO_025", bean.getAnyo(), params));
		where.append(SqlUtils.generarWhereIgual(ID_AUSENCIA_025, bean.getIdAusencia(), params));
		where.append(SqlUtils.generarWhereIgual("FECHA_DESDE_025", bean.getFechaDesde(), params));
		where.append(SqlUtils.generarWhereIgual("FECHA_HASTA_025", bean.getFechaHasta(), params));
		where.append(SqlUtils.generarWhereIgual("TIPO_JORNADA_025", bean.getTipoJornada(), params));

		return where.toString();
	}

	@Override
	protected String getWhereLike(AusenciasCalendarioPersonal bean, Boolean startsWith, List<Object> params,
			Boolean search) {

		StringBuilder where = new StringBuilder(AusenciasCalendarioPersonalDaoImpl.STRING_BUILDER_INIT);

		where.append(SqlUtils.generarWhereIgual("DNI_025", bean.getDni(), params));
		where.append(SqlUtils.generarWhereIgual("ANYO_025", bean.getAnyo(), params));
		where.append(SqlUtils.generarWhereIgual(ID_AUSENCIA_025, bean.getIdAusencia(), params));
		where.append(SqlUtils.generarWhereIgual("FECHA_DESDE_025", bean.getFechaDesde(), params));
		where.append(SqlUtils.generarWhereIgual("FECHA_HASTA_025", bean.getFechaHasta(), params));
		where.append(SqlUtils.generarWhereIgual("TIPO_JORNADA_025", bean.getTipoJornada(), params));

		return where.toString();
	}

	protected RowMapper<AusenciasCalendarioPersonal> getRwMapConObservaciones() {
		return this.rwMapConObservaciones;
	}

	@Override()
	@Transactional(readOnly = true)
	public AusenciasCalendarioPersonal findConObservaciones(AusenciasCalendarioPersonal ausenciasCalendarioPersonal) {

		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder(this.getSelect());
		query.append(",t3.OBSERV_DIA_076 ");

		query.append(this.getFrom());
		query.append(" LEFT JOIN AA79B76S01 t3 ON t1.ID_AUSENCIA_025 = t3.ID_AUSENCIA_076 ");
		query.append(this.getWherePK(ausenciasCalendarioPersonal, params));

		List<AusenciasCalendarioPersonal> beanList = this.getJdbcTemplate().query(query.toString(),
				this.getRwMapConObservaciones(), params.toArray());
		return DataAccessUtils.uniqueResult(beanList);

	}

	@Override
	public int updateDatosTarea(AusenciasCalendarioPersonal ausenciascalendariopersonal) {
		int numFilasActualizadas = 0;

		if (ausenciascalendariopersonal != null) {
			StringBuilder query = new StringBuilder(DaoConstants.UPDATE);
			query.append(DBConstants.AA79B25S01);
			query.append(DaoConstants.SET);
			query.append(DBConstants.DNI_025);
			query.append(DaoConstants.SIGNOIGUAL_INTERROGACION);
			query.append(DaoConstants.SIGNO_COMA);
			query.append(DBConstants.FECHA_DESDE_025);
			query.append(DaoConstants.SIGNOIGUAL_INTERROGACION);
			query.append(DaoConstants.SIGNO_COMA);
			query.append(DBConstants.FECHA_HASTA_025);
			query.append(DaoConstants.SIGNOIGUAL_INTERROGACION);
			query.append(DaoConstants.WHERE);
			query.append(DBConstants.ID_TAREA_INTER_025);
			query.append(DaoConstants.SIGNOIGUAL_INTERROGACION);

			numFilasActualizadas = this.getJdbcTemplate().update(query.toString(), ausenciascalendariopersonal.getDni(),
					ausenciascalendariopersonal.getFechaDesde(), ausenciascalendariopersonal.getFechaHasta(),
					ausenciascalendariopersonal.getIdTarea());
		}

		return numFilasActualizadas;
	}

	@Override
	public int updateDatosReasignacionTarea(AusenciasCalendarioPersonal ausenciascalendariopersonal) {
		int numFilasActualizadas = 0;

		if (ausenciascalendariopersonal != null) {
			StringBuilder query = new StringBuilder(DaoConstants.UPDATE);
			query.append(DBConstants.AA79B25S01);
			query.append(DaoConstants.SET);
			query.append(DBConstants.DNI_025);
			query.append(DaoConstants.SIGNOIGUAL_INTERROGACION);
			query.append(DaoConstants.WHERE);
			query.append(DBConstants.ID_TAREA_INTER_025);
			query.append(DaoConstants.SIGNOIGUAL_INTERROGACION);

			numFilasActualizadas = this.getJdbcTemplate().update(query.toString(), ausenciascalendariopersonal.getDni(),
					ausenciascalendariopersonal.getIdTarea());
		}

		return numFilasActualizadas;
	}

	@Override
	public void removeDatosTarea(BigDecimal idTarea) {

		if (idTarea != null) {

			StringBuilder sbQuery = new StringBuilder(DaoConstants.SELECT + DBConstants.ID_AUSENCIA_025);
			sbQuery.append(DaoConstants.FROM + DBConstants.AA79B25S01);
			sbQuery.append(DaoConstants.WHERE + DBConstants.ID_TAREA_INTER_025 + DaoConstants.SIGNOIGUAL + idTarea);

			StringBuilder query = new StringBuilder(DaoConstants.DELETE);
			query.append(DaoConstants.FROM + DBConstants.AA79B76S01);
			query.append(DaoConstants.WHERE + DBConstants.ID_AUSENCIA_076 + DaoConstants.SIGNOIGUAL);
			query.append(DaoConstants.ABRIR_PARENTESIS + sbQuery.toString() + DaoConstants.CERRAR_PARENTESIS);

			this.getJdbcTemplate().update(query.toString());

			query = new StringBuilder(DaoConstants.DELETE);
			query.append(DaoConstants.FROM + DBConstants.AA79B25S01);
			query.append(DaoConstants.WHERE + DBConstants.ID_TAREA_INTER_025 + DaoConstants.SIGNOIGUAL + idTarea);

			this.getJdbcTemplate().update(query.toString());
		}

	}

}
