package com.ejie.aa79b.dao;

import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;
import java.util.Locale;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.i18n.LocaleContextHolder;
import org.springframework.context.support.ReloadableResourceBundleMessageSource;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.common.DBConstants;
import com.ejie.aa79b.common.SqlUtils;
import com.ejie.aa79b.dao.mapper.EntidadesContactosFacturarInterRowMapper;
import com.ejie.aa79b.dao.mapper.EntidadesContactosFacturarRowMapper;
import com.ejie.aa79b.model.CentroOrganico;
import com.ejie.aa79b.model.ContactoFacturacionExpediente;
import com.ejie.aa79b.model.Entidad;
import com.ejie.aa79b.model.Solicitante;
import com.ejie.x38.dto.JQGridManager;
import com.ejie.x38.dto.JQGridRequestDto;

/**
 * ContactoFacturacionExpedienteDaoImpl generated by UDA, 29-ene-2018 12:17:36.
 *
 * @author UDA
 */

@Repository
@Transactional
public class ContactoFacturacionExpedienteDaoImpl extends GenericoDaoImpl<ContactoFacturacionExpediente>
		implements ContactoFacturacionExpedienteDao {

	@Autowired()
	private ReloadableResourceBundleMessageSource msg;

	private static final String DEFAULT_WHERE_JOIN = " WHERE 1=1 ";
	private static final String ID058 = "ID058";
	private static final String TIPOENTIDADASOC058 = "TIPOENTIDADASOC058";
	private static final String IDENTIDADASOC058 = "IDENTIDADASOC058";
	private static final String DNICONTACTO058 = "DNICONTACTO058";
	private static final String PORFACTURA058 = "PORFACTURA058";
	private static final String ID_058 = "ID_058";
	private static final String COMUN_SI = "comun.si";
	private static final String COMUN_NO = "comun.no";
	private static final String LEFTJOIN_X54SOLIC_ON_T4DNI = "  LEFT JOIN X54JAPI_SOLICITANTES t4 ON t4.DNI = t1.DNI_CONTACTO_058 AND t4.TIPO_ENTIDAD =  t1.TIPO_ENTIDAD_ASOC_058 AND t4.COD_ENTIDAD = t1.ID_ENTIDAD_ASOC_058";
	private static final String LEFTJOIN_X54ENTISOLIC_ON_X54ENTIASOC = " LEFT JOIN X54JAPI_ENTIDADES_SOLIC t2 ON (t2.CODIGO = t1.ID_ENTIDAD_ASOC_058 AND t2.TIPO = t1.TIPO_ENTIDAD_ASOC_058) ";

	protected static final String[] ORDER_BY_WHITE_LIST = new String[] { ID058, DBConstants.ANYO, DBConstants.NUMEXP,
			TIPOENTIDADASOC058, IDENTIDADASOC058, DNICONTACTO058, PORFACTURA058, "ENTIDADDESCAMP", "CONTACTOAPEL1",
			DBConstants.FACTURABLE, DBConstants.IVA, "FACTURABLEDESC", "IVADESC", DBConstants.DESCENTIDADEU,
			DBConstants.NOMBRE, DBConstants.IVA, DBConstants.COUNTEXPEDIENTES, DBConstants.CENTRO_ORGANICO_ES, DBConstants.CENTRO_ORGANICO_EU,
			DBConstants.CENTRO_ORGANICO_ES, DBConstants.CENTRO_ORGANICO_EU  };

	/*
	 * ROW_MAPPERS
	 */
	private RowMapper<ContactoFacturacionExpediente> rwMap = new RowMapper<ContactoFacturacionExpediente>() {
		@Override
		public ContactoFacturacionExpediente mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			return new ContactoFacturacionExpediente(resultSet.getLong(ID058), resultSet.getLong(DBConstants.ANYO),
					resultSet.getInt(DBConstants.NUMEXP), resultSet.getString(TIPOENTIDADASOC058),
					resultSet.getInt(IDENTIDADASOC058), resultSet.getString(DNICONTACTO058),
					resultSet.getLong(PORFACTURA058));
		}
	};

	private RowMapper<ContactoFacturacionExpediente> rwMapPK = new RowMapper<ContactoFacturacionExpediente>() {
		@Override
		public ContactoFacturacionExpediente mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			return new ContactoFacturacionExpediente(resultSet.getLong(ID058));
		}
	};

	private class RWConJoin implements RowMapper<ContactoFacturacionExpediente> {
		@Override()
		public ContactoFacturacionExpediente mapRow(ResultSet resultSet, int rowNum) throws SQLException {
			Locale locale = LocaleContextHolder.getLocale();

			ContactoFacturacionExpediente contactoFacturacionExpedienteAux = new ContactoFacturacionExpediente(
					resultSet.getLong(ID058), resultSet.getLong(DBConstants.ANYO), resultSet.getInt(DBConstants.NUMEXP),
					resultSet.getString(TIPOENTIDADASOC058), resultSet.getInt(IDENTIDADASOC058),
					resultSet.getString(DNICONTACTO058), resultSet.getLong(PORFACTURA058));
			Entidad entidadSolicitante = new Entidad();
			entidadSolicitante.setCodigo(resultSet.getInt(IDENTIDADASOC058));
			entidadSolicitante.setTipo(resultSet.getString(TIPOENTIDADASOC058));
			entidadSolicitante.setDescAmpEu(resultSet.getString("ENTIDADDESCAMP"));
			entidadSolicitante.setFacturable(resultSet.getString(DBConstants.FACTURABLE));
			entidadSolicitante.setIva(resultSet.getString(DBConstants.IVA));
			entidadSolicitante.setFacturableDesc(resultSet.getString("FACTURABLEDESC"));
			entidadSolicitante.setIvaDesc(resultSet.getString("IVADESC"));
			contactoFacturacionExpedienteAux.setEntidadSolicitante(entidadSolicitante);
			Solicitante contacto = new Solicitante();
			contacto.setApellido1(resultSet.getString("CONTACTOAPEL1"));
			contacto.setApellido2(resultSet.getString("CONTACTOAPEL2"));
			contacto.setNombre(resultSet.getString("CONTACTONOMBRE"));
			contacto.setDni(resultSet.getString(DNICONTACTO058));
			CentroOrganico centroOrganico = new CentroOrganico();
			if (Constants.LANG_EUSKERA.equals(locale.getLanguage())) {
		          centroOrganico.setDescAmp(resultSet.getString("CENTROORGANICOEU"));
		     } else {
		          centroOrganico.setDescAmp(resultSet.getString("CENTROORGANICOES"));
		     }
			contacto.setCentroOrganico(centroOrganico);
			contactoFacturacionExpedienteAux.setContacto(contacto);
			return contactoFacturacionExpedienteAux;
		}
	}

	protected RowMapper<ContactoFacturacionExpediente> getRWConJoin() {
		return this.rWConJoin;
	}

	protected RowMapper<ContactoFacturacionExpediente> getRWConJoinInter() {
		return this.rWConJoinInter;
	}

	private RowMapper<ContactoFacturacionExpediente> rwMapConJoin = new RWConJoin();

	private RowMapper<ContactoFacturacionExpediente> rWConJoin = new EntidadesContactosFacturarRowMapper();

	private RowMapper<ContactoFacturacionExpediente> rWConJoinInter = new EntidadesContactosFacturarInterRowMapper();

	public ContactoFacturacionExpedienteDaoImpl() {
		/* Constructor */
		super(ContactoFacturacionExpediente.class);
	}

	/*
	 * OPERACIONES CRUD
	 */

	/**
	 * Inserts a single row in the ContactoFacturacionExpediente table.
	 *
	 * @param contactoexcepfact
	 *            ContactoFacturacionExpediente
	 * @return ContactoFacturacionExpediente
	 */
	@Override
	public ContactoFacturacionExpediente add(ContactoFacturacionExpediente contactoexcepfact) {
		final Long elId = this.getNextVal("AA79B58Q00");
		String query = "INSERT INTO AA79B58S01 (ID_058,ANYO_058, NUM_EXP_058, TIPO_ENTIDAD_ASOC_058, ID_ENTIDAD_ASOC_058, DNI_CONTACTO_058, POR_FACTURA_058) VALUES (?,?,?,?,?,?,?)";
		this.getJdbcTemplate().update(query, elId, contactoexcepfact.getAnyo(), contactoexcepfact.getNumExp(),
				contactoexcepfact.getTipoEntidadAsoc058(), contactoexcepfact.getIdEntidadAsoc058(),
				contactoexcepfact.getDniContacto058(), contactoexcepfact.getPorFactura058());
		contactoexcepfact.setId058(elId);
		return contactoexcepfact;
	}

	@Override
	public ContactoFacturacionExpediente addContactosEntidadesFacturacion(ContactoFacturacionExpediente bean) {
		String query = "INSERT INTO AA79B98S01 (ID_098, DIR_NORA_098, IND_FACTURABLE_098, IND_IVA_098, NUM_TOTAL_PAL_FACTURAR_098, "
				+ "NUM_PAL_CONCOR_0_84_098, NUM_PAL_CONCOR_85_94_098, NUM_PAL_CONCOR_95_100_098, IMPORTE_DIFICULTAD_098, "
				+ "IMPORTE_URGENCIA_098, IMPORTE_BASE_098, IMPORTE_IVA_098, IMPORTE_TOTAL_098) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?)";
		this.getJdbcTemplate().update(query, bean.getId058(), bean.getEntidadSolicitante().getDireccion().getDirNora(),
				bean.getEntidadSolicitante().getFacturable(), bean.getEntidadSolicitante().getIva(),
				bean.getDatosFacturacionExpediente().getNumTotalPalFacturar(),
				bean.getDatosFacturacionExpediente().getNumPalConcor084(),
				bean.getDatosFacturacionExpediente().getNumPalConcor8594(),
				bean.getDatosFacturacionExpediente().getNumPalConcor95100(),
				bean.getDatosFacturacionExpediente().getImporteDificultad(),
				bean.getDatosFacturacionExpediente().getImporteUrgencia(),
				bean.getDatosFacturacionExpediente().getImporteBase(),
				bean.getDatosFacturacionExpediente().getImporteIva(),
				bean.getDatosFacturacionExpediente().getImporteTotal());
		return bean;
	}

	@Override
	public int updateContactosEntidadesFacturacion(ContactoFacturacionExpediente bean) {
		String query = "UPDATE AA79B98S01 SET DIR_NORA_098=?, IND_FACTURABLE_098=?, IND_IVA_098=?, NUM_TOTAL_PAL_FACTURAR_098=?, NUM_PAL_CONCOR_0_84_098=?, NUM_PAL_CONCOR_85_94_098=?, "
				+ "NUM_PAL_CONCOR_95_100_098=?, IMPORTE_DIFICULTAD_098=?, IMPORTE_URGENCIA_098=?, IMPORTE_BASE_098=?, IMPORTE_IVA_098=?, IMPORTE_TOTAL_098=? WHERE ID_098=?";
		return this.getJdbcTemplate().update(query, bean.getEntidadSolicitante().getDireccion().getDirNora(),
				bean.getEntidadSolicitante().getFacturable(), bean.getEntidadSolicitante().getIva(),
				bean.getDatosFacturacionExpediente().getNumTotalPalFacturar(),
				bean.getDatosFacturacionExpediente().getNumPalConcor084(),
				bean.getDatosFacturacionExpediente().getNumPalConcor8594(),
				bean.getDatosFacturacionExpediente().getNumPalConcor95100(),
				bean.getDatosFacturacionExpediente().getImporteDificultad(),
				bean.getDatosFacturacionExpediente().getImporteUrgencia(),
				bean.getDatosFacturacionExpediente().getImporteBase(),
				bean.getDatosFacturacionExpediente().getImporteIva(),
				bean.getDatosFacturacionExpediente().getImporteTotal(), bean.getId058());
	}

	/**
	 * Updates a single row in the ContactoFacturacionExpediente table.
	 *
	 * @param contactoexcepfact
	 *            ContactoFacturacionExpediente
	 * @return ContactoFacturacionExpediente
	 */
	@Override
	public ContactoFacturacionExpediente update(ContactoFacturacionExpediente contactoexcepfact) {
		String query = "UPDATE AA79B58S01 SET ANYO_058=?, NUM_EXP_058=?, TIPO_ENTIDAD_ASOC_058=?, ID_ENTIDAD_ASOC_058=?, DNI_CONTACTO_058=?,POR_FACTURA_058=? WHERE ID_058=?";
		this.getJdbcTemplate().update(query, contactoexcepfact.getAnyo(), contactoexcepfact.getNumExp(),
				contactoexcepfact.getTipoEntidadAsoc058(), contactoexcepfact.getIdEntidadAsoc058(),
				contactoexcepfact.getDniContacto058(), contactoexcepfact.getPorFactura058(),
				contactoexcepfact.getId058());
		return contactoexcepfact;
	}

	/**
	 * Removes a single row in the ContactoFacturacionExpediente table.
	 *
	 * @param contactoexcepfact
	 *            ContactoFacturacionExpediente
	 * @return
	 */
	@Override
	public void remove(ContactoFacturacionExpediente contactoexcepfact) {
		String query = "DELETE FROM AA79B58S01 WHERE ID_058=?";
		this.getJdbcTemplate().update(query, contactoexcepfact.getId058());
	}

	/**
	 * Removes a single row in the ContactoFacturacionExpediente table.
	 *
	 * @param contactoexcepfact
	 *            ContactoFacturacionExpediente
	 * @return
	 */
	@Override
	public void borraTodosPorIdExcepcion(Long id058, Long idExcepcion058, Integer numExp) {
		String query = "DELETE FROM AA79B58S01 WHERE ID_058=? AND ANYO_058=? AND NUM_EXP_058=?";
		this.getJdbcTemplate().update(query, id058, idExcepcion058, numExp);
	}

	@Override
	public void borraTodosContactoEntidadPorId(Long id058) {
		String query = "DELETE FROM AA79B98S01 WHERE ID_098=?";
		this.getJdbcTemplate().update(query, id058);
	}

	/**
	 * The method getQuery.
	 *
	 * @return String OJO CON ESTE MÉTOD
	 */
	@Override()
	protected String getSelect() {
		StringBuilder sb = new StringBuilder();

		sb.append(
				"SELECT t1.ID_058 ID058,t1.ANYO_058 ANYO, t1.NUM_EXP_058 NUMEXP, t1.TIPO_ENTIDAD_ASOC_058 TIPOENTIDADASOC058, t1.ID_ENTIDAD_ASOC_058 IDENTIDADASOC058, t1.DNI_CONTACTO_058 DNICONTACTO058, t1.POR_FACTURA_058 PORFACTURA058 ");

		return sb.toString();
	}

	@Override()
	protected String getFrom() {
		return " FROM AA79B58S01 t1  ";
	}

	@Override()
	protected RowMapper<ContactoFacturacionExpediente> getRwMap() {
		return this.rwMap;
	}

	@Override()
	protected String[] getOrderBy() {
		return ContactoFacturacionExpedienteDaoImpl.ORDER_BY_WHITE_LIST;
	}

	@Override()
	protected String getPK() {
		return ID_058;
	}

	@Override()
	protected RowMapper<ContactoFacturacionExpediente> getRwMapPK() {
		return this.rwMapPK;
	}

	protected RowMapper<ContactoFacturacionExpediente> getRwMapConJoin() {
		return this.rwMapConJoin;
	}

	@Override()
	protected String getWherePK(ContactoFacturacionExpediente bean, List<Object> params) {
		params.add(bean.getId058());
		return "  WHERE t1.ID_058 = ?";
	}
	/*
	 * MÉTODOS PRIVADOS
	 */

	@Override()
	protected String getWhere(ContactoFacturacionExpediente bean, List<Object> params) {

		StringBuilder where = new StringBuilder(ContactoFacturacionExpedienteDaoImpl.STRING_BUILDER_INIT);

		where.append(SqlUtils.generarWhereIgual(ID_058, bean.getId058(), params));
		where.append(SqlUtils.generarWhereIgual("ANYO_058", bean.getAnyo(), params));
		where.append(SqlUtils.generarWhereIgual("NUM_EXP_058", bean.getNumExp(), params));
		where.append(SqlUtils.generarWhereIgual("TIPO_ENTIDAD_ASOC_058", bean.getTipoEntidadAsoc058(), params));
		where.append(SqlUtils.generarWhereIgual("ID_ENTIDAD_ASOC_058", bean.getIdEntidadAsoc058(), params));
		where.append(SqlUtils.generarWhereIgual("DNI_CONTACTO_058", bean.getDniContacto058(), params));
		where.append(SqlUtils.generarWhereIgual("POR_FACTURA_058", bean.getPorFactura058(), params));
		return where.toString();
	}

	@Override
	protected String getWhereLike(ContactoFacturacionExpediente bean, Boolean startsWith, List<Object> params,
			Boolean search) {

		StringBuilder whereLike = new StringBuilder(ContactoFacturacionExpedienteDaoImpl.STRING_BUILDER_INIT);
		whereLike.append(SqlUtils.generarWhereIgual(ID_058, bean.getId058(), params));
		whereLike.append(SqlUtils.generarWhereIgual("ANYO_058", bean.getAnyo(), params));
		whereLike.append(SqlUtils.generarWhereIgual("NUM_EXP_058", bean.getNumExp(), params));
		whereLike.append(SqlUtils.generarWhereIgual("TIPO_ENTIDAD_ASOC_058", bean.getTipoEntidadAsoc058(), params));
		whereLike.append(SqlUtils.generarWhereIgual("ID_ENTIDAD_ASOC_058", bean.getIdEntidadAsoc058(), params));
		whereLike.append(SqlUtils.generarWhereIgual("DNI_CONTACTO_058", bean.getDniContacto058(), params));
		whereLike.append(SqlUtils.generarWhereIgual("POR_FACTURA_058", bean.getPorFactura058(), params));
		return whereLike.toString();
	}

	/**
	 * Finds rows in the T table using like.
	 *
	 * @param bean
	 *            T
	 * @param jqGridRequestDto
	 *            JQGridRequestDto
	 * @param startsWith
	 *            Boolean
	 * @return List<T>
	 */
	@Override
	@Transactional(readOnly = true)
	public List<ContactoFacturacionExpediente> filtroConJoins(ContactoFacturacionExpediente bean,
			JQGridRequestDto jqGridRequestDto, Boolean startsWith) {
		Locale locale = LocaleContextHolder.getLocale();
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder(this.getSelect());
		query.append(
				" ,t2.DESC_AMP_EU ENTIDADDESCAMP, t4.NOMBRE_077 CONTACTONOMBRE, t4.APEL1_077 CONTACTOAPEL1, t4.APEL2_077 CONTACTOAPEL2, t2.FACTURABLE FACTURABLE, t2.IVA IVA ");

		query.append(", DECODE(t2.FACTURABLE, '").append(Constants.SI).append("', '")
				.append(this.msg.getMessage(COMUN_SI, null, locale)).append("', '")
				.append(this.msg.getMessage(COMUN_NO, null, locale)).append("') AS FACTURABLEDESC");

		query.append(", DECODE(t2.IVA, '").append(Constants.SI).append("', '")
				.append(this.msg.getMessage(COMUN_SI, null, locale)).append("', '")
				.append(this.msg.getMessage(COMUN_NO, null, locale)).append("') AS IVADESC");
		query.append(", d3.DESCRIPCION_CASTELLANO_AMP AS CENTROORGANICOES");
		query.append(", d3.DESCRIPCION_EUSKERA_AMP AS CENTROORGANICOEU");

		query.append(this.getFrom(bean, params));
		query.append(LEFTJOIN_X54ENTISOLIC_ON_X54ENTIASOC);
		query.append(" LEFT JOIN AA79B77S01 T4 ON T4.DNI_077 = T1.DNI_CONTACTO_058 ");
		query.append(" LEFT JOIN X54JAPI_CENORGS_PERSONA d3 ON t1.DNI_CONTACTO_058 = d3.DNI");
		query.append(ContactoFacturacionExpedienteDaoImpl.DEFAULT_WHERE_JOIN);
		query.append(this.getWhereLike(bean, startsWith, params, false));

		if (jqGridRequestDto != null) {
			query = JQGridManager.getPaginationQuery(jqGridRequestDto, query, this.getOrderBy());
		}

		return this.getJdbcTemplate().query(query.toString(), this.getRwMapConJoin(), params.toArray());
	}

	@Override
	@Transactional(readOnly = true)
	public List<ContactoFacturacionExpediente> entidadesContactosAFacturarFilter(ContactoFacturacionExpediente bean,
			JQGridRequestDto jqGridRequestDto, Boolean startsWith) {
		Locale locale = LocaleContextHolder.getLocale();
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder(this.getSelect());
		query.append(", ").append(SqlUtils.normalizarCampoSql("t2.DESC_AMP_EU")).append(" AS ENTIDADDESCAMP");
		query.append(
				", t77.NOMBRE_077 CONTACTONOMBRE, t77.APEL1_077 CONTACTOAPEL1, t77.APEL2_077 CONTACTOAPEL2, t2.FACTURABLE FACTURABLE, t2.IVA IVA, t4.DNI DNIVINCULADOOBAJA");
		query.append(
				", f1.NUM_TOTAL_PAL_FACTURAR_098 NUMTOTALPALFACTURAR, f1.NUM_PAL_CONCOR_0_84_098 NUMPALCONCOR084, f1.NUM_PAL_CONCOR_85_94_098 NUMPALCONCOR8594,	f1.NUM_PAL_CONCOR_95_100_098 NUMPALCONCOR95100");
		query.append(
				", f1.IMPORTE_DIFICULTAD_098 IMPORTEDIFICULTAD, f1.IMPORTE_URGENCIA_098 IMPORTEURGENCIA, f1.IMPORTE_BASE_098 IMPORTEBASE, f1.IMPORTE_IVA_098 IMPORTEIVA, f1.IMPORTE_TOTAL_098 IMPORTETOTAL, i1.POR_IVA_097 PORIVA");
		query.append(", DECODE(t2.FACTURABLE, '").append(Constants.SI).append("', '")
				.append(this.msg.getMessage(COMUN_SI, null, locale)).append("', '")
				.append(this.msg.getMessage(COMUN_NO, null, locale)).append("') AS FACTURABLEDESC");

		query.append(", DECODE(t2.IVA, '").append(Constants.SI).append("', '")
				.append(this.msg.getMessage(COMUN_SI, null, locale)).append("', '")
				.append(this.msg.getMessage(COMUN_NO, null, locale)).append("') AS IVADESC");
		query.append(", DECODE(d2.CDIRNORA, NULL, d1.CDIRNORA, d2.CDIRNORA) AS CDIRNORA");
		query.append(", DECODE(d2.TIPONORA, NULL, d1.TIPONORA, d2.TIPONORA) AS TIPONORA");
		query.append(", DECODE(d2.CODPAIS, NULL, d1.CODPAIS, d2.CODPAIS) AS CODPAIS");
		query.append(", DECODE(d2.PAIS, NULL, d1.PAIS, d2.PAIS) AS PAIS");
		query.append(", DECODE(d2.CODPROVINCIA, NULL, d1.CODPROVINCIA, d2.CODPROVINCIA) AS CODPROV");
		query.append(", DECODE(d2.PROVINCIA, NULL, d1.PROVINCIA, d2.PROVINCIA) AS PROVINCIA");
		query.append(", DECODE(d2.CODMUNICIPIO, NULL, d1.CODMUNICIPIO, d2.CODMUNICIPIO) AS CODMUNI");
		query.append(", DECODE(d2.MUNICIPIO, NULL, d1.MUNICIPIO, d2.MUNICIPIO) AS MUNICIPIO");
		query.append(", DECODE(d2.CODPOSTAL, NULL, d1.CODPOSTAL, d2.CODPOSTAL) AS CODPOSTAL");
		query.append(", DECODE(d2.CODLOCALIDAD, NULL, d1.CODLOCALIDAD, d2.CODLOCALIDAD) AS CODLOCAL");
		query.append(", DECODE(d2.LOCALIDAD, NULL, d1.LOCALIDAD, d2.LOCALIDAD) AS LOCALIDAD");
		query.append(", DECODE(d2.CODCALLE, NULL, d1.CODCALLE, d2.CODCALLE) AS CODCALLE");
		query.append(", DECODE(d2.CALLE, NULL, d1.CALLE, d2.CALLE) AS CALLE");
		query.append(", DECODE(d2.CODPORTAL, NULL, d1.CODPORTAL, d2.CODPORTAL) AS CODPORTAL");
		query.append(", DECODE(d2.PORTAL, NULL, d1.PORTAL, d2.PORTAL) AS PORTAL");
		query.append(", DECODE(d2.ESCALERA, NULL, d1.ESCALERA, d2.ESCALERA) AS ESCALERA");
		query.append(", DECODE(d2.PISO, NULL, d1.PISO, d2.PISO) AS PISO");
		query.append(", DECODE(d2.MANO, NULL, d1.MANO, d2.MANO) AS MANO");
		query.append(", DECODE(d2.PUERTA, NULL, d1.PUERTA, d2.PUERTA) AS PUERTA");
		query.append(", DECODE(d2.APROX, NULL, d1.APROX, d2.APROX) AS APROX");
		query.append(", " + SqlUtils.normalizarCampoSql("DECODE(d2.DIRECCION, NULL, d1.DIRECCION, d2.DIRECCION)")
				+ " AS DIRECCION");
		query.append(", d3.DESCRIPCION_CASTELLANO_AMP AS CENTROORGANICOES");
		query.append(", d3.DESCRIPCION_EUSKERA_AMP AS CENTROORGANICOEU");
		query.append(this.getFrom(bean, params));
		query.append(" LEFT JOIN AA79B77T00 t77 ON t1.DNI_CONTACTO_058 = t77.DNI_077");
		query.append(LEFTJOIN_X54ENTISOLIC_ON_X54ENTIASOC);
		query.append(LEFTJOIN_X54SOLIC_ON_T4DNI);
		query.append(" LEFT JOIN X54JNORA d1 ON d1.CDIRNORA = t2.CDIRNORA");
		query.append(" LEFT JOIN X54JNORA d2 ON d2.CDIRNORA = t4.CDIRNORA");
		query.append(" LEFT JOIN AA79B98S01 f1 ON f1.ID_098 = t1.ID_058 ");
		query.append(" LEFT JOIN AA79B97S01 i1 ON i1.ANYO_097 = t1.ANYO_058 AND i1.NUM_EXP_097 = t1.NUM_EXP_058");
		query.append(" LEFT JOIN X54JAPI_CENORGS_PERSONA d3 ON t1.DNI_CONTACTO_058 = d3.DNI");

		query.append(ContactoFacturacionExpedienteDaoImpl.DEFAULT_WHERE_JOIN);
		query.append(this.getWhereLike(bean, startsWith, params, false));

		return this.getJdbcTemplate().query(query.toString(), this.getRWConJoin(), params.toArray());
	}

	/**
	 * Counts rows in the T table using like.
	 *
	 * @param bean
	 *            T
	 * @param startsWith
	 *            Boolean
	 * @return Long
	 */
	@Override
	@Transactional(readOnly = true)
	public Long entidadesContactosAFacturarFilterCount(ContactoFacturacionExpediente bean, Boolean startsWith) {
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder("SELECT COUNT(1)");
		query.append(this.getFrom(bean, params));
		query.append(LEFTJOIN_X54ENTISOLIC_ON_X54ENTIASOC);
		query.append(LEFTJOIN_X54SOLIC_ON_T4DNI);
		query.append(" LEFT JOIN X54JNORA d1 ON d1.CDIRNORA = t2.CDIRNORA");
		query.append(" LEFT JOIN X54JNORA d2 ON d2.CDIRNORA = t4.CDIRNORA");
		query.append(" LEFT JOIN AA79B98S01 f1 ON f1.ID_098 = t1.ID_ENTIDAD_ASOC_058 ");

		query.append(ContactoFacturacionExpedienteDaoImpl.DEFAULT_WHERE_JOIN);
		query.append(this.getWhereLike(bean, startsWith, params, false));

		return this.getJdbcTemplate().queryForObject(query.toString(), params.toArray(), Long.class);
	}

	@Override
	@Transactional(readOnly = true)
	public Long filtroConJoinsCount(ContactoFacturacionExpediente bean, Boolean startsWith) {
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder("SELECT COUNT(1)");
		query.append(this.getFrom(bean, params));
		query.append(LEFTJOIN_X54ENTISOLIC_ON_X54ENTIASOC);
		query.append(LEFTJOIN_X54SOLIC_ON_T4DNI);

		query.append(ContactoFacturacionExpedienteDaoImpl.DEFAULT_WHERE_JOIN);
		query.append(this.getWhereLike(bean, startsWith, params, false));

		return this.getJdbcTemplate().queryForObject(query.toString(), params.toArray(), Long.class);
	}

	@Override
	public Integer sumatorioPorcentajesExcepEntidad(ContactoFacturacionExpediente bean) {
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder(
				"SELECT NVL(SUM(POR_FACTURA_058),0) sumaPorcentajes FROM AA79B58S01 WHERE ANYO_058=? AND NUM_EXP_058=? ");
		params.add(bean.getAnyo());
		params.add(bean.getNumExp());
		if (bean.getId058() != null) {
			query.append("  AND ID_058 != ? ");
			params.add(bean.getId058());
		}

		return this.getJdbcTemplate().queryForObject(query.toString(), params.toArray(), Integer.class);
	}

	@Override
	public ContactoFacturacionExpediente addContactosEntidadesFactExpInter(ContactoFacturacionExpediente bean) {
		String query = "INSERT INTO AA79BA6S01 (ID_0A6, DIR_NORA_0A6, IND_FACTURABLE_0A6, IND_IVA_0A6, IMPORTE_BASE_0A6, "
				+ "IMPORTE_IVA_0A6, IMPORTE_TOTAL_0A6) VALUES (?,?,?,?,?,?,?)";
		this.getJdbcTemplate().update(query, bean.getId058(), bean.getEntidadSolicitante().getDireccion().getDirNora(),
				bean.getEntidadSolicitante().getFacturable(), bean.getEntidadSolicitante().getIva(),
				bean.getDatosFacturacionExpInter().getImporteBase(), bean.getDatosFacturacionExpInter().getImporteIva(),
				bean.getDatosFacturacionExpInter().getImporteTotal());
		return bean;
	}

	@Override
	public int updateContactosEntidadesFactExpInter(ContactoFacturacionExpediente bean) {
		String query = "UPDATE AA79BA6S01 SET DIR_NORA_0A6=?, IND_FACTURABLE_0A6=?, IND_IVA_0A6=?, IMPORTE_BASE_0A6=?, IMPORTE_IVA_0A6=?, IMPORTE_TOTAL_0A6=? WHERE ID_0A6=?";
		return this.getJdbcTemplate().update(query, bean.getEntidadSolicitante().getDireccion().getDirNora(),
				bean.getEntidadSolicitante().getFacturable(), bean.getEntidadSolicitante().getIva(),
				bean.getDatosFacturacionExpInter().getImporteBase(), bean.getDatosFacturacionExpInter().getImporteIva(),
				bean.getDatosFacturacionExpInter().getImporteTotal(), bean.getId058());
	}

	@Override
	public List<ContactoFacturacionExpediente> entidadesContactosAFacturarInterFilter(
			ContactoFacturacionExpediente filterContactoFacturacionExpediente, JQGridRequestDto jqGridRequestDto,
			Boolean startsWith) {
		Locale locale = LocaleContextHolder.getLocale();
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder(this.getSelect());
		query.append(", ").append(SqlUtils.normalizarCampoSql("t2.DESC_AMP_EU")).append(" AS ENTIDADDESCAMP");
		query.append(
				", t77.NOMBRE_077 CONTACTONOMBRE, t77.APEL1_077 CONTACTOAPEL1, t77.APEL2_077 CONTACTOAPEL2, t2.FACTURABLE FACTURABLE, t2.IVA IVA, t4.DNI DNIVINCULADOOBAJA");

		query.append(
				", f1.IMPORTE_BASE_0A6 IMPORTEBASE, f1.IMPORTE_IVA_0A6 IMPORTEIVA, f1.IMPORTE_TOTAL_0A6 IMPORTETOTAL, i1.POR_IVA_0A3 PORIVA");
		query.append(", DECODE(t2.FACTURABLE, '").append(Constants.SI).append("', '")
				.append(this.msg.getMessage(COMUN_SI, null, locale)).append("', '")
				.append(this.msg.getMessage(COMUN_NO, null, locale)).append("') AS FACTURABLEDESC");

		query.append(", DECODE(t2.IVA, '").append(Constants.SI).append("', '")
				.append(this.msg.getMessage(COMUN_SI, null, locale)).append("', '")
				.append(this.msg.getMessage(COMUN_NO, null, locale)).append("') AS IVADESC");
		query.append(", DECODE(d2.CDIRNORA, NULL, d1.CDIRNORA, d2.CDIRNORA) AS CDIRNORA");
		query.append(", DECODE(d2.TIPONORA, NULL, d1.TIPONORA, d2.TIPONORA) AS TIPONORA");
		query.append(", DECODE(d2.CODPAIS, NULL, d1.CODPAIS, d2.CODPAIS) AS CODPAIS");
		query.append(", DECODE(d2.PAIS, NULL, d1.PAIS, d2.PAIS) AS PAIS");
		query.append(", DECODE(d2.CODPROVINCIA, NULL, d1.CODPROVINCIA, d2.CODPROVINCIA) AS CODPROV");
		query.append(", DECODE(d2.PROVINCIA, NULL, d1.PROVINCIA, d2.PROVINCIA) AS PROVINCIA");
		query.append(", DECODE(d2.CODMUNICIPIO, NULL, d1.CODMUNICIPIO, d2.CODMUNICIPIO) AS CODMUNI");
		query.append(", DECODE(d2.MUNICIPIO, NULL, d1.MUNICIPIO, d2.MUNICIPIO) AS MUNICIPIO");
		query.append(", DECODE(d2.CODPOSTAL, NULL, d1.CODPOSTAL, d2.CODPOSTAL) AS CODPOSTAL");
		query.append(", DECODE(d2.CODLOCALIDAD, NULL, d1.CODLOCALIDAD, d2.CODLOCALIDAD) AS CODLOCAL");
		query.append(", DECODE(d2.LOCALIDAD, NULL, d1.LOCALIDAD, d2.LOCALIDAD) AS LOCALIDAD");
		query.append(", DECODE(d2.CODCALLE, NULL, d1.CODCALLE, d2.CODCALLE) AS CODCALLE");
		query.append(", DECODE(d2.CALLE, NULL, d1.CALLE, d2.CALLE) AS CALLE");
		query.append(", DECODE(d2.CODPORTAL, NULL, d1.CODPORTAL, d2.CODPORTAL) AS CODPORTAL");
		query.append(", DECODE(d2.PORTAL, NULL, d1.PORTAL, d2.PORTAL) AS PORTAL");
		query.append(", DECODE(d2.ESCALERA, NULL, d1.ESCALERA, d2.ESCALERA) AS ESCALERA");
		query.append(", DECODE(d2.PISO, NULL, d1.PISO, d2.PISO) AS PISO");
		query.append(", DECODE(d2.MANO, NULL, d1.MANO, d2.MANO) AS MANO");
		query.append(", DECODE(d2.PUERTA, NULL, d1.PUERTA, d2.PUERTA) AS PUERTA");
		query.append(", DECODE(d2.APROX, NULL, d1.APROX, d2.APROX) AS APROX");
		query.append(", " + SqlUtils.normalizarCampoSql("DECODE(d2.DIRECCION, NULL, d1.DIRECCION, d2.DIRECCION)")
				+ " AS DIRECCION");
		query.append(this.getFrom(filterContactoFacturacionExpediente, params));
		query.append(" LEFT JOIN AA79B77T00 t77 ON t1.DNI_CONTACTO_058 = t77.DNI_077");
		query.append(LEFTJOIN_X54ENTISOLIC_ON_X54ENTIASOC);
		query.append(LEFTJOIN_X54SOLIC_ON_T4DNI);
		query.append(" LEFT JOIN X54JNORA d1 ON d1.CDIRNORA = t2.CDIRNORA");
		query.append(" LEFT JOIN X54JNORA d2 ON d2.CDIRNORA = t4.CDIRNORA");
		query.append(" LEFT JOIN AA79BA6S01 f1 ON f1.ID_0A6 = t1.ID_058 ");
		query.append(" LEFT JOIN AA79BA3S01 i1 ON i1.ANYO_0A3 = t1.ANYO_058 AND i1.NUM_EXP_0A3 = t1.NUM_EXP_058");

		query.append(ContactoFacturacionExpedienteDaoImpl.DEFAULT_WHERE_JOIN);
		query.append(this.getWhereLike(filterContactoFacturacionExpediente, startsWith, params, false));

		return this.getJdbcTemplate().query(query.toString(), this.getRWConJoinInter(), params.toArray());
	}

	@Override
	public Long entidadesContactosAFacturarInterFilterCount(
			ContactoFacturacionExpediente filterContactoFacturacionExpediente, Boolean startsWith) {
		List<Object> params = new ArrayList<Object>();
		StringBuilder query = new StringBuilder("SELECT COUNT(1)");
		query.append(this.getFrom(filterContactoFacturacionExpediente, params));
		query.append(LEFTJOIN_X54ENTISOLIC_ON_X54ENTIASOC);
		query.append(LEFTJOIN_X54SOLIC_ON_T4DNI);
		query.append(" LEFT JOIN X54JNORA d1 ON d1.CDIRNORA = t2.CDIRNORA");
		query.append(" LEFT JOIN X54JNORA d2 ON d2.CDIRNORA = t4.CDIRNORA");
		query.append(" LEFT JOIN AA79BA6S01 f1 ON f1.ID_0A6 = t1.ID_ENTIDAD_ASOC_058 ");

		query.append(ContactoFacturacionExpedienteDaoImpl.DEFAULT_WHERE_JOIN);
		query.append(this.getWhereLike(filterContactoFacturacionExpediente, startsWith, params, false));

		return this.getJdbcTemplate().queryForObject(query.toString(), params.toArray(), Long.class);
	}

}
