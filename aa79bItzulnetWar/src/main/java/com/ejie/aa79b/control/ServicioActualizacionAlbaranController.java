package com.ejie.aa79b.control;

import java.math.BigDecimal;
import java.text.NumberFormat;
import java.util.List;
import java.util.Locale;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.propertyeditors.CustomNumberEditor;
import org.springframework.context.i18n.LocaleContextHolder;
import org.springframework.context.support.ReloadableResourceBundleMessageSource;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.WebDataBinder;
import org.springframework.web.bind.annotation.InitBinder;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;

import com.ejie.aa79b.common.formatter.Aa79BFormatMoneda;
import com.ejie.aa79b.model.Albaran;
import com.ejie.aa79b.model.DatosPagoProveedores;
import com.ejie.aa79b.model.Pagamentos;
import com.ejie.aa79b.service.ExcelReportService;
import com.ejie.aa79b.service.PdfReportService;
import com.ejie.aa79b.service.ServicioActualizacionAlbaranService;
import com.ejie.x38.control.bind.annotation.RequestJsonBody;
import com.ejie.x38.dto.JQGridRequestDto;
import com.ejie.x38.dto.JQGridResponseDto;

/**
 * ExpedienteAltaController generated by UDA, 31-ene-2018 15:08:53.
 * 
 * @author UDA
 */

@Controller
@RequestMapping(value = "/servicios/actualizacionalbaran")

public class ServicioActualizacionAlbaranController {

	@Autowired()
	private ServicioActualizacionAlbaranService servicioActualizacionAlbaranService;
	@Autowired
	private ExcelReportService aa79bExcelReportService;
	@Autowired()
	private PdfReportService aa79bPdfReportService;
	@Autowired()
	private ReloadableResourceBundleMessageSource appMessageSource;

	private static final String LITERAL_LABEL = "menu.actualizacionAlbaran";
	private static final Logger LOGGER = LoggerFactory.getLogger(ServicioActualizacionAlbaranController.class);


	@InitBinder()
	void initBinder(WebDataBinder binder, Locale locale) {
				
		NumberFormat formatMoneda = new Aa79BFormatMoneda();
		
		CustomNumberEditor cNE = new CustomNumberEditor(Double.class, formatMoneda, true);
		
		binder.registerCustomEditor(BigDecimal.class, "importePrevisto", cNE);
		binder.registerCustomEditor(BigDecimal.class, "importeFactura", cNE);
		
		binder.registerCustomEditor(BigDecimal.class, "lotes.importeAsignado", cNE);
		binder.registerCustomEditor(BigDecimal.class, "lotes.importeConsumido", cNE);
		binder.registerCustomEditor(BigDecimal.class, "lotes.importePrevisto", cNE);
		binder.registerCustomEditor(BigDecimal.class, "lotes.importeDisponible", cNE);
	}
	
	/**
	 * Metodo de presentacion del RUP_TABLE.
	 * 
	 * @param model
	 *            Model
	 * @return String
	 */
	@RequestMapping(value = "/maint", method = RequestMethod.GET)
	public String getModel() {
		ServicioActualizacionAlbaranController.LOGGER.info("[GET - View] : actualizacionalbaran");
		return "servicioActializarAlbaran";
	}

	@RequestMapping(value = "/filter", method = RequestMethod.POST)
	public @ResponseBody JQGridResponseDto<Albaran> getFilter(@RequestJsonBody(param = "filter") Albaran albaranFilter,
			@RequestJsonBody JQGridRequestDto jqGridRequestDto) {
		ServicioActualizacionAlbaranController.LOGGER.info("[POST - filter] : Obtener albaranes");
		return this.servicioActualizacionAlbaranService.filter(albaranFilter, jqGridRequestDto, false);
	}
	
	/**
	 * Operacion de obtencion de ids de elementos seleccionados de RUP_TABLE.
	 * 
	 * @param tableObjects
	 *           Map<String, Object>
	 * @return List<ExpedienteConsulta>
	 */
	@RequestMapping(value = "/getSelectedIds", method = RequestMethod.POST)
	public @ResponseBody List<Albaran> getSelectedIds(
			@RequestJsonBody(param = "filterObject") Albaran filterAlbaran,
			@RequestJsonBody(param = "tableData") JQGridRequestDto tableData){
		ServicioActualizacionAlbaranController.LOGGER.info("[POST] : Obtener albaranes - getSelectedIds");
		return this.servicioActualizacionAlbaranService.filterGetSelectedIds(filterAlbaran,tableData);
	}

	@RequestMapping(value = "/comprobarEstadoAlbaranTareas/{refAlbaranListString}", method = RequestMethod.GET)
	public @ResponseBody Integer comprobarEstadoAlbaranTareas(@PathVariable String refAlbaranListString,
			Locale locale) {
		ServicioActualizacionAlbaranController.LOGGER.info("[POST - filter] : comprobarEstadoAlbaranTareas");
		String[] refAlbaranList = refAlbaranListString.split(",");
		return this.servicioActualizacionAlbaranService.comprobarEstadoAlbaranTareas(refAlbaranList);
	}

	@RequestMapping(value = "/borrarAlbaran/{refAlbaranListString}", method = RequestMethod.GET)
	public @ResponseBody void borrarAlbaran(@PathVariable String refAlbaranListString, Locale locale) {
		ServicioActualizacionAlbaranController.LOGGER.info("[POST - filter] : BorrarAlbaran");
		String[] refAlbaranList = refAlbaranListString.split(",");
		this.servicioActualizacionAlbaranService.borrarAlbaran(refAlbaranList, locale);
	}

	@RequestMapping(value = "/xlsxReport", method = RequestMethod.POST)
	public void xlsxTabla(@RequestParam(value = "columns", required = false) String columns,
			@RequestParam(value = "criterios", required = false) String criterios,
			@ModelAttribute() JQGridRequestDto jqGridRequestDto, @ModelAttribute() Albaran albaranFilter,
			HttpServletRequest request, HttpServletResponse response, Model model) {
		ServicioActualizacionAlbaranController.LOGGER
				.info("[POST - subm]: xlsxTabla ========================================");
		Locale locale = LocaleContextHolder.getLocale();
		JQGridRequestDto jqGridRequestDtoReport = new JQGridRequestDto(null, null, jqGridRequestDto.getSidx(),
				jqGridRequestDto.getSord());
		JQGridResponseDto<Albaran> respuesta = this.servicioActualizacionAlbaranService.filter(albaranFilter,
				jqGridRequestDtoReport, false);

		final String label = this.appMessageSource.getMessage(LITERAL_LABEL, new Object[] {}, locale);

		this.aa79bExcelReportService.generarExcelJson("printExcel", response, criterios, columns, respuesta.getRows(),
				locale, LITERAL_LABEL, label);
	}

	@RequestMapping(value = "/pdfReport", method = RequestMethod.POST)
	public void pdfTabla(@RequestParam(value = "columns", required = false) String columns,
			@RequestParam(value = "criterios", required = false) String criterios, HttpServletRequest request,
			HttpServletResponse response, @ModelAttribute() JQGridRequestDto jqGridRequestDto,
			@ModelAttribute() Albaran albaranFilter, Model model) {
		ServicioActualizacionAlbaranController.LOGGER
				.info("[POST - subm]: pdfTabla ========================================");

		JQGridRequestDto jqGridRequestDtoReport = new JQGridRequestDto(null, null, jqGridRequestDto.getSidx(),
				jqGridRequestDto.getSord());

		JQGridResponseDto<Albaran> respuesta = this.servicioActualizacionAlbaranService.filter(albaranFilter,
				jqGridRequestDtoReport, false);

		Locale locale = LocaleContextHolder.getLocale();
		final String label = this.appMessageSource.getMessage(LITERAL_LABEL, new Object[] {}, locale);

		this.aa79bPdfReportService.generarPdfJson("defaultPDF", response, criterios, columns, respuesta.getRows(),
				LITERAL_LABEL, locale, label);
	}

	@RequestMapping(value = "/detalleAlbaran", method = RequestMethod.POST)
	public String getDetalle(Model model, @RequestJsonBody() Albaran albaranFilter) {
		Albaran albaran = this.servicioActualizacionAlbaranService.obtenerDatosDetalleAlbaran(albaranFilter);
		model.addAttribute("albaran", albaran);
		return "detalleAlbaran";
	}

	@RequestMapping(value = "/detalleAlbaran/findTareasAlbaran/filter", method = RequestMethod.POST)
	public @ResponseBody JQGridResponseDto<DatosPagoProveedores> getFilterTareasAlbaran(
			@RequestJsonBody(param = "filter") Pagamentos filter, @RequestJsonBody JQGridRequestDto jqGridRequestDto) {
		ServicioActualizacionAlbaranController.LOGGER.info("[POST - filter] : Obtener albaranes");
		DatosPagoProveedores datosPagoProveedoresFilter = new DatosPagoProveedores();
		Albaran albaranFilter = new Albaran();
		albaranFilter.setIdAlbaran(new BigDecimal(filter.getIdAlbaran()));
		albaranFilter.setIdLote(filter.getIdLote());
		datosPagoProveedoresFilter.setAlbaran(albaranFilter);
		return this.servicioActualizacionAlbaranService.detalleTareasAlbaran(datosPagoProveedoresFilter,
				jqGridRequestDto, false);
	}

	@RequestMapping(value = "/detalleAlbaran/desasociarTareas/{refAlbaranListString}", method = RequestMethod.GET)
	public @ResponseBody void desasociarTareas(@PathVariable String refAlbaranListString, Locale locale) {
		ServicioActualizacionAlbaranController.LOGGER.info("[POST - filter] : DesasociarTareas");
		String[] idTareasList = refAlbaranListString.split(",");
		this.servicioActualizacionAlbaranService.desasociarAlbaran(idTareasList, locale);
	}

}
