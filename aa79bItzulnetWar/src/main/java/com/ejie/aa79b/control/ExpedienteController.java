package com.ejie.aa79b.control;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Properties;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.commons.lang.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.i18n.LocaleContextHolder;
import org.springframework.context.support.ReloadableResourceBundleMessageSource;
import org.springframework.http.HttpStatus;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.ui.ModelMap;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.ResponseStatus;
import org.springframework.web.servlet.ModelAndView;

import com.ejie.aa79b.common.Constants;
import com.ejie.aa79b.dao.DatosContactoDao;
import com.ejie.aa79b.mail.MailService;
import com.ejie.aa79b.model.BitacoraExpediente;
import com.ejie.aa79b.model.CamposSubsanacion;
import com.ejie.aa79b.model.ConfigCalculoPresupuesto;
import com.ejie.aa79b.model.ConfigPerfilSolicitante;
import com.ejie.aa79b.model.DatosContacto;
import com.ejie.aa79b.model.DocumentoTareaAdjunto;
import com.ejie.aa79b.model.DocumentosExpediente;
import com.ejie.aa79b.model.DocumentosPostTraduccionBOE;
import com.ejie.aa79b.model.EntradaLibroRegistroSol;
import com.ejie.aa79b.model.Expediente;
import com.ejie.aa79b.model.ExpedienteTradRev;
import com.ejie.aa79b.model.ExpedientesRelacionados;
import com.ejie.aa79b.model.GestorExpediente;
import com.ejie.aa79b.model.LibroRegistro;
import com.ejie.aa79b.model.LibroRegistroModel;
import com.ejie.aa79b.model.ListaExpediente;
import com.ejie.aa79b.model.ParametrosEmail;
import com.ejie.aa79b.model.ProcesoEmail;
import com.ejie.aa79b.model.RechazoExpediente;
import com.ejie.aa79b.model.SubsanacionExpediente;
import com.ejie.aa79b.model.enums.EstadoRequerimientoEnum;
import com.ejie.aa79b.model.enums.ModoDetalleExpedienteEnum;
import com.ejie.aa79b.model.enums.TipoAvisoEnum;
import com.ejie.aa79b.model.enums.TipoExpedienteEnum;
import com.ejie.aa79b.security.Usuario;
import com.ejie.aa79b.service.ConfigCalculoPresupuestoService;
import com.ejie.aa79b.service.ConfigLibroRegistroService;
import com.ejie.aa79b.service.ConfigPerfilSolicitanteService;
import com.ejie.aa79b.service.DocumentosExpedienteService;
import com.ejie.aa79b.service.DocumentosGeneralService;
import com.ejie.aa79b.service.ExcelReportService;
import com.ejie.aa79b.service.ExpedienteInterpretacionService;
import com.ejie.aa79b.service.ExpedienteService;
import com.ejie.aa79b.service.ExpedienteTradRevService;
import com.ejie.aa79b.service.ExpedientesRelacionadosService;
import com.ejie.aa79b.service.ProcesoEmailService;
import com.ejie.aa79b.service.TareasGeneralService;
import com.ejie.aa79b.utils.SubsanacionUtils;
import com.ejie.aa79b.utils.Utils;
import com.ejie.aa79b.webservices.EventosService;
import com.ejie.aa79b.webservices.srp.RegistroPresencialWebService;
import com.ejie.x38.control.bind.annotation.RequestJsonBody;
import com.ejie.x38.dto.JQGridRequestDto;
import com.ejie.x38.dto.JQGridResponseDto;
import com.ejie.x38.dto.TableRowDto;

/**
 * ExpedienteController generated by UDA, 31-ene-2018 15:08:53.
 *
 * @author UDA
 */

@Controller
@RequestMapping(value = "/tramitacionexpedientes/gestionexpedientes/estudioexpedientes/expediente")

public class ExpedienteController {

	private static final Logger LOGGER = LoggerFactory.getLogger(ExpedienteController.class);
	public static final String TITULO_JUSTIFICANTE_SOLICITUD = "titulo.justificanteSolicitud";
	public static final String LABEL_NOMBREAPELLIDOS = "label.nombreapellidos";
	public static final String LABEL_ENTIDAD = "label.entidad";

	@Autowired()
	private Properties appConfiguration;
	@Autowired
	private ExpedienteService expedienteService;
	@Autowired
	private TareasGeneralService tareasGeneralService;
	@Autowired
	private ProcesoEmailService procesoEmailService;
	@Autowired
	private ExpedienteTradRevService expedienteTradRevService;
	@Autowired()
	private ExpedientesRelacionadosService expedientesRelacionadosService;
	@Autowired
	private ConfigLibroRegistroService configLibroRegistroService;
	@Autowired
	private ConfigPerfilSolicitanteService configPerfilSolicitanteService;
	@Autowired
	private ExcelReportService aa79bExcelReportService;
	@Autowired
	private DocumentosExpedienteService documentosExpedienteService;
	@Autowired
	private ConfigCalculoPresupuestoService configCalculoPresupuestoService;
	@Autowired()
	private ReloadableResourceBundleMessageSource appMessageSource;
	@Autowired()
	private RegistroPresencialWebService registroPresencialWebService;
	@Autowired()
	private ExpedienteInterpretacionService expedienteInterpretacionService;
	@Autowired()
	private MailService mailService;
	@Autowired()
	private EventosService eventosService;
	@Autowired
	private DatosContactoDao datosContactoDao;
	@Autowired
	private DocumentosGeneralService documentosGeneralService;
	private static final String WSDL = "webservice.evento.wsdl";
	private static final String NAME_SPACE_URI = "qname.evento.namespaceURI";
	private static final String LOCAL_PART = "qname.evento.localpart";

	/*
	 * OPERACIONES CRUD (Create, Read, Update, Delete)
	 *
	 */

	/**
	 * Operacion CRUD Read. Devuelve el bean correspondiente al identificador
	 * indicado.
	 *
	 * @param anyo
	 *            Long
	 * @param numExp
	 *            Integer
	 * @return Expediente Objeto correspondiente al identificador indicado.
	 */
	@RequestMapping(value = "/{anyo}/{numExp}", method = RequestMethod.GET)
	public @ResponseBody Expediente get(@PathVariable Long anyo, @PathVariable Integer numExp) {
		Expediente expediente = new Expediente();
		expediente.setAnyo(anyo);
		expediente.setNumExp(numExp);
		expediente = this.expedienteService.find(expediente);
		ExpedienteController.LOGGER.info("[GET - findBy_PK] : Obtener Expediente por PK");
		return expediente;
	}

	/**
	 * Devuelve una lista de beans con id de estado de expediente 2
	 *
	 * @return List<Expediente> Lista de objetos correspondientes a la busqueda
	 *         realizada.
	 */
	@RequestMapping(value = "/filtroExpedienteEstadoEnEstudio/filter", method = RequestMethod.POST)
	public @ResponseBody JQGridResponseDto<Expediente> getExpedientePorIdEstado(
			@RequestJsonBody(param = "filter") Expediente filterExpediente,
			@RequestJsonBody JQGridRequestDto jqGridRequestDto) {

		ExpedienteController.LOGGER.info("[GET - findBy_PK] : Obtener Expediente por filtro estado expediente = 2");
		return this.expedienteService.filtroExpedienteEstadoEnEstudio(filterExpediente, jqGridRequestDto, false);
	}

	/**
	 * Operacion de obtencion de ids de elementos seleccionados de RUP_TABLE.
	 *
	 * @param tableObjects
	 *           Map<String, Object>
	 * @return List<ExpedienteConsulta>
	 */
	@RequestMapping(value = "/filtroExpedienteEstadoEnEstudio/getSelectedIds", method = RequestMethod.POST)
	public @ResponseBody List<Expediente> getSelectedIds(
			@RequestJsonBody(param = "filterObject") Expediente filterExpediente,
			@RequestJsonBody(param = "tableData") JQGridRequestDto tableData){
		ExpedienteController.LOGGER.info("[POST] : filtroExpedienteEstadoEnEstudio - getSelectedIds");
		return this.expedienteService.filtroExpedienteEstadoEnEstudioGetSelectedIds(filterExpediente,tableData);
	}

	/**
	 * Registra motivo de rechazo Cambia estado Expediente y Fase a rechazado
	 *
	 */
	@RequestMapping(value = "/rechazarExp/{procedencia}", method = RequestMethod.POST)
	public @ResponseBody Integer rechazarExpediente(
			@RequestJsonBody(required = false, param = "expediente") Expediente expedientes,
			@RequestJsonBody(required = false, param = "rechazoExp") RechazoExpediente rechazoExp,
			@PathVariable() String procedencia) {
		ExpedienteController.LOGGER.info("[POST] : Rechazar expediente");

		return this.expedienteService.rechazarExpediente(expedientes, rechazoExp, procedencia);
	}

	/**
	 * Cambia estado de Fase a Pendiente de asignar
	 *
	 *
	 */
	@RequestMapping(value = "/finEstudio", method = RequestMethod.POST)
	public @ResponseBody Integer finalizarEstudio(
			@RequestJsonBody(required = false, param = "expediente") Expediente expedientes,
			@RequestJsonBody JQGridRequestDto jqGridRequestDto) {
		ExpedienteController.LOGGER.info("[POST] : Expedientes modificados correctamente");

		Expediente expediente = this.expedienteService.find(expedientes);

		Integer rst = this.expedienteService.finalizarEstudio(expediente, jqGridRequestDto, null);

		Usuario credentials = (Usuario) SecurityContextHolder.getContext().getAuthentication().getCredentials();
		Integer idProcesoMail = this.tareasGeneralService.crearTareasExpediente(expedientes.getAnyo(), expedientes.getNumExp(), credentials.getNif());

		if (idProcesoMail != 0) {
			ProcesoEmail bean = new ProcesoEmail();
			bean.setIdProceso(idProcesoMail);
			this.procesoEmailService.enviarMail(bean);
		}
		// si expediente de traduccion o revision, comprobamos si las fechas de solic y la de izo son diferentes
		// en el caso de que lo sean, se enviara un email al solicitante informando al respecto
		if (expediente != null &&
				StringUtils.isNotBlank(expediente.getIdTipoExpediente()) &&
				(TipoExpedienteEnum.REVISION.getValue().equals(expediente.getIdTipoExpediente()) ||
						TipoExpedienteEnum.TRADUCCION.getValue().equals(expediente.getIdTipoExpediente()))) {
			this.comprobarCambioFechaFinExpediente(expediente);

			if(StringUtils.isNotBlank(expediente.getOrigen()) && expediente.getOrigen().equals("W")) {
				ExpedienteController.LOGGER.info("ExpedienteController.createInvoiceCambioFecha");
				ExpedienteTradRev expedienteTradRev = expediente.getExpedienteTradRev();
				this.eventosService.createInvoiceCambioFecha(expedienteTradRev, expediente);
    		}
		}

		return rst;
	}

	/**
	 * si fechas solic e izo son diferentes, se envia un email a solicitante
	 * @param expediente
	 */
	private void comprobarCambioFechaFinExpediente(Expediente expediente) {
		if (expediente.getExpedienteTradRev() != null &&
				this.fechaFinalSolicEIzoDiferentes(expediente.getExpedienteTradRev()) &&
				this.appConfiguration.getProperty(Constants.APP_ENTORNO) != null) {
			//  enviar email
			ExpedienteController.LOGGER.info("************************** Proceso de envio de email - INICIO **************************");
			List<String> listaDestinatarios = new ArrayList<String>();
				DatosContacto datosContacto = new DatosContacto();
				datosContacto.setDni031(expediente.getGestorExpediente().getSolicitante().getDni());
				datosContacto = this.datosContactoDao.findDatosContacto(datosContacto);
				if (datosContacto != null && StringUtils.isNotBlank(datosContacto.getEmail031())) {
					listaDestinatarios.add(datosContacto.getEmail031());
					ExpedienteController.LOGGER.info("entorno: " + this.appConfiguration.getProperty(Constants.APP_ENTORNO));
					ParametrosEmail parametrosEmail = new ParametrosEmail();
					Locale localeEu = new Locale(Constants.LANG_EUSKERA);
					Map<String, String> infoEu = new LinkedHashMap<String, String>();
					Locale localeEs = new Locale(Constants.LANG_CASTELLANO);
					Map<String, String> infoEs = new LinkedHashMap<String, String>();
					parametrosEmail.setAnyoNumExpediente(expediente.getAnyoNumExpConcatenado());
					infoEu.put(this.appMessageSource.getMessage(Constants.LABEL_NUM_EXP, null, localeEu),
							Constants.DOS_PUNTOS + Constants.ESPACIO + expediente.getAnyoNumExpConcatenado() + Constants.ESPACIO
									+ Constants.ABRIR_PARENTESIS + expediente.getTitulo() + Constants.CERRAR_PARENTESIS);
					infoEu.put(this.appMessageSource.getMessage(Constants.LABEL_FECHA_FIN_NUEVA, null, localeEu),
							Constants.DOS_PUNTOS + Constants.ESPACIO + expediente.getExpedienteTradRev().getFechaHoraFinalIZO());
					infoEs.put(this.appMessageSource.getMessage(Constants.LABEL_NUM_EXP, null, localeEs),
							Constants.DOS_PUNTOS + Constants.ESPACIO + expediente.getAnyoNumExpConcatenado() + Constants.ESPACIO
									+ Constants.ABRIR_PARENTESIS + expediente.getTitulo() + Constants.CERRAR_PARENTESIS);
					infoEs.put(this.appMessageSource.getMessage(Constants.LABEL_FECHA_FIN_NUEVA, null, localeEs),
							Constants.DOS_PUNTOS + Constants.ESPACIO + expediente.getExpedienteTradRev().getFechaHoraFinalIZO());
					parametrosEmail.setInfoEu(infoEu);
					parametrosEmail.setInfoEs(infoEs);
					try {
						this.mailService.sendMailWithParameters(TipoAvisoEnum.CAMBIO_FECHA_FINALIZACION.getValue(),
								listaDestinatarios, parametrosEmail);
					} catch (Exception e) {
						ExpedienteController.LOGGER.info("Error en el envío de email", e);
					}
				} else {
					ExpedienteController.LOGGER.info("No hay destinatarios", listaDestinatarios);
				}
			ExpedienteController.LOGGER.info("************************** Proceso de envio de email - FIN **************************");
		}

	}

	/**
	 * comprobar si fecha-hora solic es diferente a fecha-hora izo
	 * @param expedienteTradRev ExpedienteTradRev
	 * @return boolean
	 */
	private boolean fechaFinalSolicEIzoDiferentes(ExpedienteTradRev expedienteTradRev) {
		if (expedienteTradRev.getFechaFinalSolic() != null &&
				expedienteTradRev.getFechaFinalIzo() != null &&
				StringUtils.isNotBlank(expedienteTradRev.getHoraFinalSolic()) &&
				StringUtils.isNotBlank(expedienteTradRev.getHoraFinalIzo())) {
			return expedienteTradRev.getFechaFinalSolic().getTime() != expedienteTradRev.getFechaFinalIzo().getTime() ||
					!expedienteTradRev.getHoraFinalSolic().equals(expedienteTradRev.getHoraFinalIzo());
		}

		return false;
	}

	/**
	 * finalizar alta de oficio. Cambia estado a "en curso y fase a "Pdte de
	 * asignar", y lo registra en bitácora
	 *
	 *
	 */
	@RequestMapping(value = "/finAltaOficio", method = RequestMethod.POST)
	public @ResponseBody Integer finAltaOficio(
			@RequestJsonBody(required = false, param = "expediente") Expediente expedientes,
			@RequestJsonBody JQGridRequestDto jqGridRequestDto) {
		ExpedienteController.LOGGER.info("[POST] : finAltaOficio");

		Expediente expediente = this.expedienteService.find(expedientes);

		int rst = 0;

		if (!TipoExpedienteEnum.INTERPRETACION.getValue().equals(expediente.getIdTipoExpediente())) {
			rst = this.expedienteService.finAltaOficio(expediente, jqGridRequestDto, null);

			Usuario credentials = (Usuario) SecurityContextHolder.getContext().getAuthentication().getCredentials();
			Integer idProcesoMail = this.tareasGeneralService.crearTareasExpediente(expedientes.getAnyo(), expedientes.getNumExp(), credentials.getNif());

			if (idProcesoMail != 0) {
				ProcesoEmail bean = new ProcesoEmail();
				bean.setIdProceso(idProcesoMail);
				this.procesoEmailService.enviarMail(bean);
			}
		}

		return rst;
	}

	@RequestMapping(value = "/registrarSubsanacion", method = RequestMethod.POST)
	public @ResponseBody void putSubsanacion(
			@RequestJsonBody(required = false, param = "expediente") Expediente expedientes,
			@RequestJsonBody(required = false, param = "camposSelectSub") String camposSelecSub,
			@RequestJsonBody(required = false, param = "docuSelecSub") String docuSelecSub,
			@RequestJsonBody(required = false, param = "subsanacionExp") SubsanacionExpediente subsanacionExpediente) {
		ExpedienteController.LOGGER.info("[GET - findBy_PK] : Registrar subsanacion");
		ExpedienteController.LOGGER.info("GET ENTORNO : " + this.appConfiguration.getProperty("app.entorno"));
		Locale locale = LocaleContextHolder.getLocale();

		this.expedienteService.registrarSubsanacion(subsanacionExpediente, camposSelecSub, docuSelecSub, expedientes);

		GestorExpediente gestor = this.expedienteService.getDatosContacto(expedientes);

		StringBuilder sb = new StringBuilder();
		sb.append(this.appMessageSource.getMessage("menu.requerirSub", null, locale)).append(" ")
				.append(expedientes.getAnyoNumExpConcatenado());
		LibroRegistroModel libroRegistroEntrada = new LibroRegistroModel();
		libroRegistroEntrada.setMatter(sb.toString());

		try {
			LibroRegistroModel libroRegistroRst = this.registroPresencialWebService
					.altaRegistroEntrada(libroRegistroEntrada);

			if (libroRegistroRst != null) {
				LibroRegistro libroRegistro = new LibroRegistro();
				libroRegistro.setAnyo(expedientes.getAnyo());
				libroRegistro.setNumExp(expedientes.getNumExp());
				libroRegistro.setMatter(sb.toString());
				libroRegistro.setTelematico(Constants.NO);
				libroRegistro.setFechaRegistro(libroRegistroRst.getFechaRegistro());
				libroRegistro.setNumRegistro(libroRegistroRst.getNumRegistro());

				this.configLibroRegistroService.add(libroRegistro);
			}

		} catch (Exception e) {
			ExpedienteController.LOGGER.info("Error al grabar en el libro de registro", e);
		}

		SubsanacionUtils subsanacionUtils = new SubsanacionUtils();
		subsanacionUtils.enviarEmailRequerirSubsanacion(expedientes, subsanacionExpediente, gestor);
	}

	@RequestMapping(value = "/comprobarRequisitosDocu", method = RequestMethod.POST)
	public @ResponseBody Integer comprobarRequisitosDocu(
			@RequestJsonBody(required = false, param = "expediente") Expediente expedientes) {
		return this.expedienteService.comprobarRequisitosDocu(expedientes);
	}

	@RequestMapping(value = "/comprobarEstadoSubsanacion", method = RequestMethod.POST)
	public @ResponseBody BitacoraExpediente comprobarEstadoSubsanacion(
			@RequestJsonBody(required = false, param = "expediente") Expediente expedientes) {
		Expediente result = this.expedienteService.comprobarRequisitosSub(expedientes);
		return result.getBitacoraExpediente();
	}

	@RequestMapping(value = "/comprobarCamposSeleccionados", method = RequestMethod.POST)
	public @ResponseBody List<Expediente> comprobarCamposSeleccionados(
			@RequestJsonBody(required = false, param = "expediente") Expediente expedientes) {
		Expediente exp = this.expedienteService.find(expedientes);
		return this.expedienteService.comprobarCamposSeleccionados(exp);
	}

	@RequestMapping(value = "/comprobarDocumentosSeleccionados", method = RequestMethod.POST)
	public @ResponseBody List<Expediente> comprobarDocumentosSeleccionados(
			@RequestJsonBody(required = false, param = "expediente") Expediente expedientes) {
		Expediente exp = this.expedienteService.find(expedientes);
		return this.expedienteService.comprobarDocumentosSeleccionados(exp);
	}

	@RequestMapping(value = "/updateFechaLimite", method = RequestMethod.POST)
	public @ResponseBody void updateFechaLimite(
			@RequestJsonBody(required = false, param = "expediente") Expediente expedientes,
			@RequestJsonBody(required = false, param = "subsanacionExpediente") SubsanacionExpediente subsanacionExpediente) {

		Expediente exp = this.expedienteService.find(expedientes);
		SubsanacionExpediente subExp = new SubsanacionExpediente();
		subExp.setId(exp.getBitacoraExpediente().getSubsanacionExp().getId());
		subExp.setFechaLimite(subsanacionExpediente.getFechaLimite());
		subExp.setHoraLimite(subsanacionExpediente.getHoraLimite());

		this.expedienteService.updateFechaLimite(subExp);

	}

	@RequestMapping(value = "/aceptarSubsanacion", method = RequestMethod.POST)
	public @ResponseBody void aceptarSubsanacion(
			@RequestJsonBody(required = false, param = "expediente") Expediente expedientes,
			@RequestJsonBody(required = false, param = "subsanacionExpediente") SubsanacionExpediente subsanacionExpediente) {

		Expediente exp = this.expedienteService.find(expedientes);
		SubsanacionExpediente subExp = new SubsanacionExpediente();
		subExp.setId(subsanacionExpediente.getId());
		subExp.setEstado(EstadoRequerimientoEnum.ACEPTADA.getValue());

		this.expedienteService.actualizarSubsanacion(subExp);
		this.expedienteService.setPdteTramitacion(exp);
		this.expedienteService.setEstudioExp(exp);
	}

	@RequestMapping(value = "/rechazarSubsanacion", method = RequestMethod.POST)
	public @ResponseBody void rechazarSubsanacion(
			@RequestJsonBody(required = false, param = "expediente") Expediente expedientes,
			@RequestJsonBody(required = false, param = "subsanacionExpediente") SubsanacionExpediente subsanacionExpediente) {

		Expediente exp = this.expedienteService.find(expedientes);
		SubsanacionExpediente subExp = new SubsanacionExpediente();
		subExp.setId(subsanacionExpediente.getId());
		subExp.setEstado(EstadoRequerimientoEnum.RECHAZADA.getValue());

		this.expedienteService.actualizarSubsanacion(subExp);
		this.expedienteService.setRechazarSubsanacion(exp);
	}

	@RequestMapping(value = "/listaDocuAsociados", method = RequestMethod.POST)
	public @ResponseBody List<DocumentosExpediente> getListadoDocumentos(
			@RequestJsonBody(required = false, param = "docuExp") DocumentosExpediente documentosExpediente) {
		ExpedienteController.LOGGER.info("[getDocumentosExpediente] : Obtener documentos de un expediente");

		JQGridRequestDto jqGridRequestDto = new JQGridRequestDto();
		jqGridRequestDto.setSord("ASC");
		jqGridRequestDto.setSidx("IDDOC");

		return this.documentosExpedienteService.findAll(documentosExpediente, jqGridRequestDto);
	}

	/**
	 * Devuelve una lista de beans con id de estado de expediente 2
	 *
	 * @param filterExpediente
	 * @param jqGridRequestDto
	 * @return List<Expediente> Lista de objetos correspondientes a la busqueda
	 *         realizada.
	 */
	@RequestMapping(value = "/obtenerExpedientesNoRelacionados/filter", method = RequestMethod.POST)
	public @ResponseBody JQGridResponseDto<Expediente> obtenerExpedientesNoRelacionados(
			@RequestJsonBody(param = "filter") Expediente filterExpediente,
			@RequestJsonBody JQGridRequestDto jqGridRequestDto) {

		ExpedienteController.LOGGER
				.info("[GET - findBy_PK] : Obtener Expedientes no relacionados con el pasado por parametro");
		return this.expedienteService.obtenerExpedientesRelacionados(filterExpediente, jqGridRequestDto, false, true);
	}

	/**
	 * Devuelve una lista de expedientes relacionados
	 *
	 * @param filterExpediente
	 * @param jqGridRequestDto
	 * @return List<Expediente> Lista de expedientes relacionados.
	 */
	@RequestMapping(value = "/obtenerExpedientesRelacionados/filter", method = RequestMethod.POST)
	public @ResponseBody JQGridResponseDto<Expediente> obtenerExpedientesRelacionados(
			@RequestJsonBody(param = "filter") Expediente filterExpediente,
			@RequestJsonBody JQGridRequestDto jqGridRequestDto) {

		ExpedienteController.LOGGER
				.info("[GET - findBy_PK] : Obtener Expedientes no relacionados con el pasado por parametro");
		return this.expedienteService.obtenerExpedientesRelacionados(filterExpediente, jqGridRequestDto, false, false);
	}

	/**

	 */
	@RequestMapping(value = "/relacionarExpedientes", method = RequestMethod.POST)
	public @ResponseBody ListaExpediente relacionarExpedientes(@RequestJsonBody ListaExpediente listaExpedientes) {

		ExpedienteController.LOGGER.info("[POST] : Expedientes modificados correctamente");
		return this.expedienteService.relacionarExpedientes(listaExpedientes);
	}

	/**
	 * Operacion CRUD Delete. Borrado del registro correspondiente al
	 * identificador especificado.
	 *
	 * @param expediente
	 */
	@RequestMapping(value = "/eliminarExpedienteRelacionado", method = RequestMethod.DELETE)
	@ResponseStatus(value = HttpStatus.OK)
	public void eliminarExpedienteRelacionado(@RequestJsonBody Expediente expediente) {
		this.expedientesRelacionadosService.removeExpedienteRelacionado(expediente);
		ExpedienteController.LOGGER.info("[DELETE] : Expediente relacionado borrado correctamente");
	}

	/**

	 */
	@RequestMapping(value = "/asignarTecnicoAExpedientes", method = RequestMethod.POST)
	public @ResponseBody Integer asignarTecnicoAExpedientes(@RequestJsonBody ListaExpediente listaExpedientes) {

		ExpedienteController.LOGGER.info("[POST] : asignarTecnicoAExpedientes");
		return this.expedienteService.asignarTecnicoAExpedientes(listaExpedientes);
	}

	/**

	 */
	@RequestMapping(value = "/asignarAsignadorAExpedientes", method = RequestMethod.POST)
	public @ResponseBody Integer asignarAsignadorAExpedientes(@RequestJsonBody ListaExpediente listaExpedientes) {

		ExpedienteController.LOGGER.info("[POST] : asignarAsignadorAExpedientes");
		return this.expedienteService.asignarAsignadorAExpedientes(listaExpedientes);
	}

	/**
	 * Devuelve una lista de beans correspondientes a los valores de filtrados
	 * indicados en el objeto pasado como parametro.
	 *
	 * @param filterExpediente
	 *            Expediente Objeto que contiene los parametros de filtrado
	 *            utilizados en la busqueda.
	 * @return List<Expediente> Lista de objetos correspondientes a la busqueda
	 *         realizada.
	 */
	@RequestMapping(method = RequestMethod.GET)
	public @ResponseBody List<Expediente> getAll(@ModelAttribute Expediente filterExpediente) {
		ExpedienteController.LOGGER.info("[GET - find_ALL] : Obtener Expediente por filtro");
		return this.expedienteService.findAll(filterExpediente, null);
	}

	@RequestMapping(value = "/findAllSubsanciones", method = RequestMethod.POST)
	public @ResponseBody List<CamposSubsanacion> getAllSubsanciones(
			@RequestJsonBody(required = false, param = "anyo") Long anyo,
			@RequestJsonBody(required = false, param = "numExp") Integer numExp,
			@RequestJsonBody(required = false, param = "tipoExp") String tipoExp) {
		List<CamposSubsanacion> camposListResult = new ArrayList<CamposSubsanacion>();
		final ConfigCalculoPresupuesto configCalculoPresupuesto = this.configCalculoPresupuestoService
				.find(new ConfigCalculoPresupuesto(Constants.ID_DATOS_BASICOS));
		Integer numComprobar = 0;
		String permisoBopv = this.expedienteService.getPermisosBopv(anyo, numExp);
		ExpedienteTradRev expedienteTradRev = new ExpedienteTradRev(anyo, numExp);
		List<CamposSubsanacion> camposList = this.expedienteService.findAllCamposSubsanacion(tipoExp);
		expedienteTradRev = this.expedienteTradRevService.find(expedienteTradRev);
		for (CamposSubsanacion campo : camposList) {
			numComprobar = expedienteTradRev.getNumTotalPalIzo();
			if (expedienteTradRev.getNumTotalPalIzo() == 0) {
				numComprobar = expedienteTradRev.getNumTotalPalSolic();
			}

			if (isMostrarPresupuestoTradRev(tipoExp, configCalculoPresupuesto, numComprobar, campo)
					|| isMostrarBOPV(tipoExp, permisoBopv, campo)) {
				camposListResult.add(campo);
			}
		}
		camposList.removeAll(camposListResult);
		return camposList;
	}

	private boolean isMostrarBOPV(String tipoExp, String permisoBopv, CamposSubsanacion campo) {
		return permisoBopv.equals(Constants.NO) && (!tipoExp.equals(TipoExpedienteEnum.INTERPRETACION.getValue()))
				&& (campo.getId078().equals(new Long(Constants.DOS))
						|| campo.getId078().equals(new Long(Constants.NUEVE)));
	}

	private boolean isMostrarPresupuestoTradRev(String tipoExp, final ConfigCalculoPresupuesto configCalculoPresupuesto,
			Integer numComprobar, CamposSubsanacion campo) {
		return campo.getId078().equals(new Long(Constants.SIETE))
				&& ((tipoExp.equals(TipoExpedienteEnum.TRADUCCION.getValue())
						&& configCalculoPresupuesto.getPalPresupuesto() > numComprobar)
						|| tipoExp.equals(TipoExpedienteEnum.REVISION.getValue()));
	}

	/**
	 * Operacion CRUD Edit. Modificacion del bean indicado.
	 *
	 * @param expediente
	 *            Expediente Bean que contiene la informacion a modificar.
	 * @return Expediente Bean resultante de la modificacion.
	 */
	@RequestMapping(method = RequestMethod.PUT)
	public @ResponseBody Expediente edit(@RequestBody Expediente expediente) {
		Expediente expedienteAux = this.expedienteService.update(expediente);
		ExpedienteController.LOGGER.info("[PUT] : Expediente actualizado correctamente");
		return expedienteAux;
	}

	/**
	 * Operacion CRUD Create. Creacion de un nuevo registro a partir del bean
	 * indicado.
	 *
	 * @param expediente
	 *            Expediente Bean que contiene la informacion con la que se va a
	 *            crear el nuevo registro.
	 * @return Expediente Bean resultante del proceso de creacion.
	 */
	@RequestMapping(method = RequestMethod.POST)
	public @ResponseBody Expediente add(@RequestBody Expediente expediente) {
		Expediente expedienteAux = this.expedienteService.add(expediente);
		ExpedienteController.LOGGER.info("[POST] : Expediente insertado correctamente");
		return expedienteAux;
	}

	/**
	 * Operacion CRUD Delete. Borrado del registro correspondiente al
	 * identificador especificado.
	 *
	 * @param anyo
	 *            Long
	 * @param numExp
	 *            Integer Identificador del objeto que se desea eliminar.
	 * @return Expediente Bean eliminado.
	 */
	@RequestMapping(value = "/{anyo}/{numExp}", method = RequestMethod.DELETE)
	@ResponseStatus(value = HttpStatus.OK)
	public @ResponseBody Expediente remove(@PathVariable Long anyo, @PathVariable Integer numExp) {
		Expediente expediente = new Expediente();
		expediente.setAnyo(anyo);
		expediente.setNumExp(numExp);
		this.expedienteService.remove(expediente);
		ExpedienteController.LOGGER.info("[DELETE] : Expediente borrado correctamente");
		return expediente;
	}

	/*
	 * METODOS COMPONENTE RUP_TABLE
	 *
	 */

	/**
	 * Metodo de presentacion del RUP_TABLE.
	 *
	 * @param model
	 *            Model
	 * @return String
	 */
	@RequestMapping(value = "/maint", method = RequestMethod.GET)
	public String getFormEdit(Model model) {
		ExpedienteController.LOGGER.info("[GET - View] : expediente");
		return "estudioexpedientes";
	}

	/**
	 * Operacion de filtrado del componente RUP_TABLE.
	 *
	 * @param filterExpediente
	 *            Expediente Bean que contiene los parametros de filtrado a
	 *            emplear.
	 * @param jqGridRequestDto
	 *            Dto que contiene los parametros de configuracion propios del
	 *            RUP_TABLE a aplicar en el filtrado.
	 * @return JQGridResponseDto<Expediente> Dto que contiene el resultado del
	 *         filtrado realizado por el componente RUP_TABLE.
	 */
	@RequestMapping(value = "/filter", method = RequestMethod.POST)
	public @ResponseBody JQGridResponseDto<Expediente> filter(
			@RequestJsonBody(param = "filter") Expediente filterExpediente,
			@RequestJsonBody JQGridRequestDto jqGridRequestDto) {
		ExpedienteController.LOGGER.info("[POST - filter] : Obtener Expedientes");
		return this.expedienteService.filter(filterExpediente, jqGridRequestDto, false);
	}

	/**
	 * Operacion de busqueda del componente RUP_TABLE.
	 *
	 * @param filterExpediente
	 *            Expediente Bean que contiene los parametros de filtrado a
	 *            emplear.
	 * @param searchExpediente
	 *            Expediente Bean que contiene los parametros de busqueda a
	 *            emplear.
	 * @param jqGridRequestDto
	 *            Dto que contiene los parametros de configuracion propios del
	 *            RUP_TABLE a aplicar en la búsqueda.
	 * @return TableRowDto<Expediente> Dto que contiene el resultado de la
	 *         busqueda realizada por el componente RUP_TABLE.
	 */
	@RequestMapping(value = "/search", method = RequestMethod.POST)
	public @ResponseBody List<TableRowDto<Expediente>> search(
			@RequestJsonBody(param = "filter") Expediente filterExpediente,
			@RequestJsonBody(param = "search") Expediente searchExpediente,
			@RequestJsonBody JQGridRequestDto jqGridRequestDto) {
		ExpedienteController.LOGGER.info("[POST - search] : Buscar Expedientes");
		return this.expedienteService.search(filterExpediente, searchExpediente, jqGridRequestDto, false);
	}

	@RequestMapping(value = "/cabeceraDetalleExp/{anyo}/{numExp}", method = RequestMethod.GET)
	public @ResponseBody ModelAndView getCabeceraDetalleExp(Model model, @PathVariable Long anyo,
			@PathVariable Integer numExp) {

		Expediente expediente = new Expediente();
		expediente.setAnyo(anyo);
		expediente.setNumExp(numExp);
		Expediente bean = this.expedienteService.find(expediente);
		Map<String,Object> mapaValores = new HashMap<String, Object>();
		mapaValores.put("expediente", bean);
		mapaValores.put("modoDetalle", ModoDetalleExpedienteEnum.PESTANYA.getValue());
		return new ModelAndView("cabeceraDetalleExp", mapaValores);
	}

	@RequestMapping(value = "/cabeceraDetalleExpNuevaVentana/{anyo}/{numExp}", method = RequestMethod.GET)
	public @ResponseBody ModelAndView getCabeceraDetalleExpNuevaVentana(Model model, @PathVariable Long anyo,
			@PathVariable Integer numExp) {

		Expediente expediente = new Expediente();
		expediente.setAnyo(anyo);
		expediente.setNumExp(numExp);
		Expediente bean = this.expedienteService.find(expediente);
		Map<String,Object> mapaValores = new HashMap<String, Object>();
		mapaValores.put("expediente", bean);
		mapaValores.put("modoDetalle", ModoDetalleExpedienteEnum.VENTANA_NUEVA.getValue());
		return new ModelAndView("cabeceraDetalleExpNuevaVentana", mapaValores);
	}

	@RequestMapping(value = "/detalleExpediente/{anyo}/{numExp}", method = RequestMethod.GET)
	public @ResponseBody ModelAndView getDetalle(Model model, @PathVariable Long anyo, @PathVariable Integer numExp) {

		Expediente expediente = new Expediente();
		expediente.setAnyo(anyo);
		expediente.setNumExp(numExp);
		Expediente bean = this.expedienteService.find(expediente);

		return new ModelAndView("detalleExpediente", "expediente", bean);
	}

	@RequestMapping(value = "/listado/{anyo}/{numExp}/{origen}", method = RequestMethod.GET)
	public ModelAndView getListado(@PathVariable Long anyo, @PathVariable Integer numExp, @PathVariable String origen) {
		ExpedienteController.LOGGER.info("[getDocumentosExpediente] : Obtener documentos de un expediente");

		return obtenerDatosDocumentos(anyo, numExp, false, null);
	}

	@RequestMapping(value = "/listadoConFactYPresup/{anyo}/{numExp}/{origen}/{tipoExp}", method = RequestMethod.GET)
	public ModelAndView getListadoConFactYPresup(@PathVariable Long anyo, @PathVariable Integer numExp,
			@PathVariable String origen, @PathVariable String tipoExp) {
		ExpedienteController.LOGGER.info("[getDocumentosExpediente] : Obtener documentos de un expediente");

		return obtenerDatosDocumentos(anyo, numExp, true, tipoExp);
	}

	private ModelAndView obtenerDatosDocumentos(Long anyo, Integer numExp, boolean datosFactYPres, String tipoExp) {
		// Se prepara el objeto con sus filtros
		final DocumentosExpediente documentosExpedienteFiltro = new DocumentosExpediente();
		documentosExpedienteFiltro.setAnyo(anyo);
		documentosExpedienteFiltro.setNumExp(numExp);
		List<DocumentosExpediente> listaDocumentosExpediente = this.documentosExpedienteService
				.findAllConFinales(documentosExpedienteFiltro, null);
		final ConfigCalculoPresupuesto configCalculoPresupuesto = this.configCalculoPresupuestoService
				.find(new ConfigCalculoPresupuesto(Constants.ID_DATOS_BASICOS));
		final DocumentosPostTraduccionBOE documentosPostTradBOE = this.documentosExpedienteService
				.findficherosBoePosttraduccion(documentosExpedienteFiltro);
		ModelMap map = new ModelMap();
		map.put("listaDocumentos", listaDocumentosExpediente);
		Usuario credentials = (Usuario) SecurityContextHolder.getContext().getAuthentication().getCredentials();
		//MOSTRAR DOCUMENTOS XLIFF EN PESTANYA DOCUMENTOS
		List<DocumentoTareaAdjunto> lDocsXliff = null;
		lDocsXliff = this.documentosGeneralService.obtenerDocsXliffDeExpediente(documentosExpedienteFiltro);
		map.put("listaDocumentosXliff", lDocsXliff);
		map.put("documentosBOE", documentosPostTradBOE);
		map.put("anyo", anyo);
		map.put("numExp", numExp);
		map.put("palPresupuesto", configCalculoPresupuesto.getPalPresupuesto());// se ha cambiado por palPresupuesto

		if (datosFactYPres) {
			ExpedienteTradRev filterFactYPres = new ExpedienteTradRev();
			filterFactYPres.setAnyo(anyo);
			filterFactYPres.setNumExp(numExp);
			if (TipoExpedienteEnum.INTERPRETACION.getValue().equals(tipoExp)) {
				SubsanacionExpediente expedienteInter = this.expedienteInterpretacionService
						.findDatosEstadoPresupuesto(filterFactYPres);
				map.put("datosFactYPresupInter", expedienteInter);
			} else {
				ExpedienteTradRev expedienteTradRev = this.expedienteTradRevService
						.findConDatosFacturacion(filterFactYPres);
				map.put("datosFactYPresup", expedienteTradRev);
			}
		}
		return new ModelAndView("detalleDocumentosExp", map);
	}

	/**
	 * @param columns
	 * @param criterios
	 * @param jqGridRequestDto
	 * @param filterExpediente
	 * @param request
	 * @param response
	 * @param model
	 */
	@RequestMapping(value = "/xlsxReport", method = RequestMethod.POST)
	public void xlsxTabla(@RequestParam(value = "columns", required = false) String columns,
			@RequestParam(value = "criterios", required = false) String criterios,
			@ModelAttribute() JQGridRequestDto jqGridRequestDto, @ModelAttribute() Expediente filterExpediente,
			HttpServletRequest request, HttpServletResponse response, Model model) {
		ExpedienteController.LOGGER.info("[POST - subm]: xlsxTabla =======================================  =");
		Locale locale = LocaleContextHolder.getLocale();
		JQGridRequestDto jqGridRequestDtoReport = new JQGridRequestDto(null, null, jqGridRequestDto.getSidx(),
				jqGridRequestDto.getSord());
		JQGridResponseDto<Expediente> respuesta = this.expedienteService
				.filtroExpedienteEstadoEnEstudio(filterExpediente, jqGridRequestDtoReport, false);

		final String expedienteLabel = "titulo.expediente";
		final String label = this.appMessageSource.getMessage(expedienteLabel, new Object[] {}, locale);

			this.aa79bExcelReportService.generarExcelJson("printExcel", response, criterios, columns, respuesta.getRows(),
					locale, expedienteLabel, label);
	}

	@RequestMapping(value = "/informes/descargarJustificanteSolicitud/{anyo}/{numExp}", method = RequestMethod.GET)
	public @ResponseBody ModelAndView getJustificante(ModelMap modelMap, @PathVariable Long anyo,
			@PathVariable Integer numExp, Locale locale) {

		Expediente filterExpediente = new Expediente();
		String anyoSubstring = anyo.toString().substring(Constants.DOS);
		filterExpediente.setAnyo(new Long(anyoSubstring));
		filterExpediente.setNumExp(numExp);

		List<Expediente> exp = this.expedienteService.getJustificanteSolicitud(filterExpediente);
		filterExpediente.setAnyo(anyo);

		int numExpDigits = String.valueOf((int) exp.get(Constants.CERO).getNumExp()).length();
		StringBuilder numExpFormated = this.obtenerNumExpConCeros(numExpDigits);
		exp.get(Constants.CERO).setNumExpFormated(exp.get(Constants.CERO).getAnyo().toString().substring(Constants.DOS)
				+ "/" + numExpFormated + exp.get(Constants.CERO).getNumExp());

		List<ExpedientesRelacionados> expRelacionados = this.expedientesRelacionadosService
				.selectExpRelacionadosList(filterExpediente);

		if (!expRelacionados.isEmpty()) {
			for (int i = Constants.CERO; i < expRelacionados.size(); i++) {
				int numExpRelDigits = String.valueOf((int) expRelacionados.get(i).getNumExpRel()).length();
				StringBuilder numExpRelFormated = this.obtenerNumExpConCeros(numExpRelDigits);
				expRelacionados.get(i)
						.setNumExpFormated(expRelacionados.get(i).getAnyoExpRel().toString().substring(Constants.DOS)
								+ "/" + numExpRelFormated + expRelacionados.get(i).getNumExpRel());
			}
		}
		exp.get(Constants.CERO).setListaExpedientesRelacionados(expRelacionados);

		ConfigPerfilSolicitante configPerfilSolicitanteFilter = new ConfigPerfilSolicitante();
		configPerfilSolicitanteFilter.setId(Constants.CONFIG_DEFAULT_ID);

		ConfigPerfilSolicitante configPerfilSolicitante = this.configPerfilSolicitanteService
				.find(configPerfilSolicitanteFilter);

		EntradaLibroRegistroSol entradaLibroRegistroSol = new EntradaLibroRegistroSol();
		entradaLibroRegistroSol.setAnyo(anyo);
		entradaLibroRegistroSol.setNumExp(numExp);
		List<LibroRegistro> libroRegistro = this.configLibroRegistroService
				.getlibroRegistroSol(entradaLibroRegistroSol);

		Locale localEu = new Locale("eu");
		Locale localEs = new Locale("es");

		// Nombre fichero
		modelMap.put("fileName", this.appMessageSource.getMessage(TITULO_JUSTIFICANTE_SOLICITUD, null, locale));
		// En línea (no descarga fichero) ?
		modelMap.put("isInline", false);
		// Cabeceras comunes y locale (parameter)
		modelMap.put("REPORT_LOCALE", locale);
		modelMap.put("STATICS", this.appConfiguration.getProperty("datos.path"));
		modelMap.put("RUTAWAR", this.appConfiguration.getProperty("war.path"));

		if (!libroRegistro.isEmpty()) {
			modelMap.put("LIBRO_REGISTRO_NUM", this.appMessageSource
					.getMessage(libroRegistro.get(Constants.CERO).getNumRegistro(), null, localEs));
		}

		modelMap.put("RESGUARDO_ES", this.appMessageSource.getMessage("label.pdf.resguardo", null, localEs));
		modelMap.put("LIBRO_REGISTRO_ES", this.appMessageSource.getMessage("label.libroRegistro", null, localEs));
		modelMap.put("NUMERO_ANOTACION_ES", this.appMessageSource.getMessage("label.numeroAnotacion", null, localEs));
		modelMap.put("DECLARACION_ES",
				this.appMessageSource.getMessage(configPerfilSolicitante.getDeclaracionResponsableEs(), null, localEs));
		modelMap.put("DECLARACION_RESPON_ES",
				this.appMessageSource.getMessage("label.pdf.declaracionRespon", null, localEs));
		modelMap.put("DATOS_PERSONAL_ES", this.appMessageSource.getMessage("label.datosPersonales", null, localEs));
		modelMap.put("TITULO_ES", this.appMessageSource.getMessage(TITULO_JUSTIFICANTE_SOLICITUD, null, localEs));
		modelMap.put("GESTOR_ES", this.appMessageSource.getMessage("label.gestor", null, localEs));
		modelMap.put("CIF_ES", this.appMessageSource.getMessage("label.cif", null, localEs));
		modelMap.put("NIF_ES", this.appMessageSource.getMessage("label.nif", null, localEs));
		modelMap.put("ENTIDAD_ES", this.appMessageSource.getMessage(LABEL_ENTIDAD, null, localEs));
		modelMap.put("MAIL_ES", this.appMessageSource.getMessage("label.email", null, localEs));
		modelMap.put("NOM_APELLIDOS_ES", this.appMessageSource.getMessage(LABEL_NOMBREAPELLIDOS, null, localEs));
		modelMap.put("TIPO_EXP_ES", this.appMessageSource.getMessage("label.tipoExpediente", null, localEs));
		modelMap.put("TITULO_EXP_ES", this.appMessageSource.getMessage("label.tituloJusti", null, localEs));
		modelMap.put("TITULO_EXP_REL_ES", this.appMessageSource.getMessage("label.titulo", null, localEs));
		modelMap.put("OBSERVACIONES_ES", this.appMessageSource.getMessage("label.ficheroObservaciones", null, localEs));
		modelMap.put("NOTAS_ES", this.appMessageSource.getMessage("label.notas", null, localEs));
		modelMap.put("NOM_FICHERO_ES", this.appMessageSource.getMessage("label.ficheroAdjunto", null, localEs));
		modelMap.put("DATOS_SOLICITUD_ES", this.appMessageSource.getMessage("label.datosSolicitud", null, localEs));
		modelMap.put("DATOS_REVISION_ES", this.appMessageSource.getMessage("label.datosRevision", null, localEs));
		modelMap.put("IDIOMA_ES", this.appMessageSource.getMessage("label.idiomaDestinoTrad", null, localEs));
		modelMap.put("REFERENCIA_TRAM_ES", this.appMessageSource.getMessage("label.refTramitagune", null, localEs));
		modelMap.put("BOPV_ES", this.appMessageSource.getMessage("label.publicarBOPV", null, localEs));
		modelMap.put("CONFIDENCIAL_ES", this.appMessageSource.getMessage("label.esConfidencial", null, localEs));
		modelMap.put("CORREDACCION_ES", this.appMessageSource.getMessage("label.esCorredaccion", null, localEs));
		modelMap.put("TEXT_ELABORAR_ES", this.appMessageSource.getMessage("label.texto", null, localEs));
		modelMap.put("PARTICIPANTES_ES", this.appMessageSource.getMessage("label.participantes", null, localEs));
		modelMap.put("NUM_EXP_ES", this.appMessageSource.getMessage("label.numeroExpediente", null, localEs));
		modelMap.put("FECHA_ALTA_ES", this.appMessageSource.getMessage("label.fechaAlta", null, localEs));
		modelMap.put("TIPO_REDACCION_ES",
				this.appMessageSource.getMessage("label.tipoRedaccionBilingue", null, localEs));
		modelMap.put("EXP_RELACIONADAS_ES",
				this.appMessageSource.getMessage("menu.expedientesRelacionados", null, localEs));
		modelMap.put("DATOS_INTERPRETACION_ES",
				this.appMessageSource.getMessage("label.datosInterpretacion", null, localEs));
		modelMap.put("LUGAR_ES", this.appMessageSource.getMessage("label.lugarInterpretacion", null, localEs));
		modelMap.put("INDICADOR_ES", this.appMessageSource.getMessage("label.indProgramada", null, localEs));
		modelMap.put("MODO_INTERPRETACION_ES",
				this.appMessageSource.getMessage("label.modoInterpretacion", null, localEs));
		modelMap.put("PRESUPUESTO_ES", this.appMessageSource.getMessage("label.presupuestoJusti", null, localEs));
		modelMap.put("TIPO_ACTO_ES", this.appMessageSource.getMessage("label.tipoActo", null, localEs));
		modelMap.put("TIPO_PETICIONARIO_ES", this.appMessageSource.getMessage("label.tipoPeticionario", null, localEs));
		modelMap.put("FECHA_INI_INTER_ES",
				this.appMessageSource.getMessage("label.fechaHoraIniInterpretacion", null, localEs));
		modelMap.put("FECHA_FIN_INTER_ES",
				this.appMessageSource.getMessage("label.fechaHoraFinInterpretacion", null, localEs));
		modelMap.put("FECHA_INI_ES", this.appMessageSource.getMessage("label.fechaIni", null, localEs));
		modelMap.put("FECHA_FIN_ES", this.appMessageSource.getMessage("label.fechaFin", null, localEs));
		modelMap.put("SOLIC_PRESUPUESTO_ES",
				this.appMessageSource.getMessage("label.solicitarPresupuesto", null, localEs));
		modelMap.put("CONTACTO_ES", this.appMessageSource.getMessage("label.contactoJusti", null, localEs));
		modelMap.put("TELEFONO_ES", this.appMessageSource.getMessage("label.telefono", null, localEs));
		modelMap.put("DOCUMENTACION_ES", this.appMessageSource.getMessage("label.documentacion", null, localEs));
		modelMap.put("PALABRAS_SOL_ES", this.appMessageSource.getMessage("label.documento.numPalabras", null, localEs));
		modelMap.put("GARRANTZIA_ES", this.appMessageSource.getMessage("label.relevancia", null, localEs));
		modelMap.put("EXP_FACTURABLE_ES", this.appMessageSource.getMessage("label.entidadFacturable", null, localEs));
		modelMap.put("URGENTE_ES", this.appMessageSource.getMessage("label.urgente", null, localEs));
		modelMap.put("REQUIERE_PRESUPUESTO_ES",
				this.appMessageSource.getMessage("label.requierePresupuesto", null, localEs));
		modelMap.put("FECHA_FIN_IZO_ES", this.appMessageSource.getMessage("label.fechaHoraFinalIzo", null, localEs));
		modelMap.put("FECHA_FIN_SOL_ES", this.appMessageSource.getMessage("label.fechaFinalSolic", null, localEs));
		modelMap.put("FECHA_FIN_PROPUESTA_ES", this.appMessageSource.getMessage("label.fechaFinProp", null, localEs));
		modelMap.put("CLASE_DOCU_ES", this.appMessageSource.getMessage("label.claseDocumento", null, localEs));
		modelMap.put("TIPO_DOCU_ES", this.appMessageSource.getMessage("label.tipo", null, localEs));
		modelMap.put("NUM_PALABRAS_IZO_ES",
				this.appMessageSource.getMessage("label.documento.numPalabrasIZO", null, localEs));
		modelMap.put("NUM_PALABRAS_SOLIC_ES",
				this.appMessageSource.getMessage("label.documento.numPalabrasSolicitante", null, localEs));

		modelMap.put("SI_ES", this.appMessageSource.getMessage("gestion.si", null, localEs));
		modelMap.put("NO_ES", this.appMessageSource.getMessage("gestion.no", null, localEs));

		modelMap.put("RESGUARDO_EU", this.appMessageSource.getMessage("label.pdf.resguardo", null, localEu));
		modelMap.put("LIBRO_REGISTRO_EU", this.appMessageSource.getMessage("label.libroRegistro", null, localEu));
		modelMap.put("NUMERO_ANOTACION_EU", this.appMessageSource.getMessage("label.numeroAnotacion", null, localEu));
		modelMap.put("DECLARACION_EU",
				this.appMessageSource.getMessage(configPerfilSolicitante.getDeclaracionResponsableEu(), null, localEu));
		modelMap.put("DECLARACION_RESPON_EU",
				this.appMessageSource.getMessage("label.pdf.declaracionRespon", null, localEu));
		modelMap.put("DATOS_PERSONAL_EU", this.appMessageSource.getMessage("label.datosPersonales", null, localEu));
		modelMap.put("TITULO_EU", this.appMessageSource.getMessage(TITULO_JUSTIFICANTE_SOLICITUD, null, localEu));
		modelMap.put("GESTOR_EU", this.appMessageSource.getMessage("label.gestor", null, localEu));
		modelMap.put("CIF_EU", this.appMessageSource.getMessage("label.cif", null, localEu));
		modelMap.put("NIF_EU", this.appMessageSource.getMessage("label.nif", null, localEu));
		modelMap.put("ENTIDAD_EU", this.appMessageSource.getMessage(LABEL_ENTIDAD, null, localEu));
		modelMap.put("MAIL_EU", this.appMessageSource.getMessage("label.email", null, localEu));
		modelMap.put("NOM_APELLIDOS_EU", this.appMessageSource.getMessage(LABEL_NOMBREAPELLIDOS, null, localEu));
		modelMap.put("TIPO_EXP_EU", this.appMessageSource.getMessage("label.tipoExpediente", null, localEu));
		modelMap.put("TITULO_EXP_EU", this.appMessageSource.getMessage("label.tituloJusti", null, localEu));
		modelMap.put("TITULO_EXP_REL_EU", this.appMessageSource.getMessage("label.titulo", null, localEu));
		modelMap.put("OBSERVACIONES_EU", this.appMessageSource.getMessage("label.ficheroObservaciones", null, localEu));
		modelMap.put("NOTAS_EU", this.appMessageSource.getMessage("label.notas", null, localEu));
		modelMap.put("NOM_FICHERO_EU", this.appMessageSource.getMessage("label.ficheroAdjunto", null, localEu));
		modelMap.put("DATOS_SOLICITUD_EU", this.appMessageSource.getMessage("label.datosSolicitud", null, localEu));
		modelMap.put("DATOS_REVISION_EU", this.appMessageSource.getMessage("label.datosRevision", null, localEu));
		modelMap.put("IDIOMA_EU", this.appMessageSource.getMessage("label.idiomaDestinoTrad", null, localEu));
		modelMap.put("REFERENCIA_TRAM_EU", this.appMessageSource.getMessage("label.refTramitagune", null, localEu));
		modelMap.put("BOPV_EU", this.appMessageSource.getMessage("label.publicarBOPV", null, localEu));
		modelMap.put("CONFIDENCIAL_EU", this.appMessageSource.getMessage("label.esConfidencial", null, localEu));
		modelMap.put("CORREDACCION_EU", this.appMessageSource.getMessage("label.esCorredaccion", null, localEu));
		modelMap.put("TEXT_ELABORAR_EU", this.appMessageSource.getMessage("label.texto", null, localEu));
		modelMap.put("PARTICIPANTES_EU", this.appMessageSource.getMessage("label.participantes", null, localEu));
		modelMap.put("NUM_EXP_EU", this.appMessageSource.getMessage("label.numeroExpediente", null, localEu));
		modelMap.put("FECHA_ALTA_EU", this.appMessageSource.getMessage("label.fechaAlta", null, localEu));
		modelMap.put("TIPO_REDACCION_EU",
				this.appMessageSource.getMessage("label.tipoRedaccionBilingue", null, localEu));
		modelMap.put("EXP_RELACIONADAS_EU",
				this.appMessageSource.getMessage("menu.expedientesRelacionados", null, localEu));
		modelMap.put("DATOS_INTERPRETACION_EU",
				this.appMessageSource.getMessage("label.datosInterpretacion", null, localEu));
		modelMap.put("LUGAR_EU", this.appMessageSource.getMessage("label.lugarInterpretacion", null, localEu));
		modelMap.put("INDICADOR_EU", this.appMessageSource.getMessage("label.indProgramada", null, localEu));
		modelMap.put("MODO_INTERPRETACION_EU",
				this.appMessageSource.getMessage("label.modoInterpretacion", null, localEu));
		modelMap.put("PRESUPUESTO_EU", this.appMessageSource.getMessage("label.presupuestoJusti", null, localEu));
		modelMap.put("TIPO_ACTO_EU", this.appMessageSource.getMessage("label.tipoActo", null, localEu));
		modelMap.put("TIPO_PETICIONARIO_EU", this.appMessageSource.getMessage("label.tipoPeticionario", null, localEu));
		modelMap.put("FECHA_INI_EU", this.appMessageSource.getMessage("label.fechaIni", null, localEu));
		modelMap.put("FECHA_FIN_EU", this.appMessageSource.getMessage("label.fechaFin", null, localEu));
		modelMap.put("SOLIC_PRESUPUESTO_EU",
				this.appMessageSource.getMessage("label.solicitarPresupuesto", null, localEu));
		modelMap.put("FECHA_INI_INTER_EU",
				this.appMessageSource.getMessage("label.fechaHoraIniInterpretacion", null, localEu));
		modelMap.put("FECHA_FIN_INTER_EU",
				this.appMessageSource.getMessage("label.fechaHoraFinInterpretacion", null, localEu));
		modelMap.put("CONTACTO_EU", this.appMessageSource.getMessage("label.contactoJusti", null, localEu));
		modelMap.put("TELEFONO_EU", this.appMessageSource.getMessage("label.telefono", null, localEu));
		modelMap.put("DOCUMENTACION_EU", this.appMessageSource.getMessage("label.documentacion", null, localEu));
		modelMap.put("PALABRAS_SOL_EU", this.appMessageSource.getMessage("label.documento.numPalabras", null, localEu));
		modelMap.put("GARRANTZIA_EU", this.appMessageSource.getMessage("label.relevancia", null, localEu));
		modelMap.put("EXP_FACTURABLE_EU", this.appMessageSource.getMessage("label.entidadFacturable", null, localEu));
		modelMap.put("URGENTE_EU", this.appMessageSource.getMessage("label.urgente", null, localEu));
		modelMap.put("REQUIERE_PRESUPUESTO_EU",
				this.appMessageSource.getMessage("label.requierePresupuesto", null, localEu));
		modelMap.put("FECHA_FIN_IZO_EU", this.appMessageSource.getMessage("label.fechaHoraFinalIzo", null, localEu));
		modelMap.put("FECHA_FIN_SOL_EU", this.appMessageSource.getMessage("label.fechaFinalSolic", null, localEu));
		modelMap.put("FECHA_FIN_PROPUESTA_EU", this.appMessageSource.getMessage("label.fechaFinProp", null, localEu));
		modelMap.put("CLASE_DOCU_EU", this.appMessageSource.getMessage("label.claseDocumento", null, localEu));
		modelMap.put("TIPO_DOCU_EU", this.appMessageSource.getMessage("label.tipo", null, localEu));
		modelMap.put("NUM_PALABRAS_IZO_EU",
				this.appMessageSource.getMessage("label.documento.numPalabrasIZO", null, localEu));
		modelMap.put("NUM_PALABRAS_SOLIC_EU",
				this.appMessageSource.getMessage("label.documento.numPalabrasSolicitante", null, localEu));
		modelMap.put("SI_EU", this.appMessageSource.getMessage("gestion.si", null, localEu));
		modelMap.put("NO_EU", this.appMessageSource.getMessage("gestion.no", null, localEu));

		List<List<Expediente>> datos = Utils.separarLista(exp, "numExp");
		final List<Expediente> rdo2 = new ArrayList<Expediente>();
		for (List<Expediente> list : datos) {
			for (Expediente expediente : list) {
				DocumentosExpediente filterDocumentosExpediente = new DocumentosExpediente();
				filterDocumentosExpediente.setAnyo(anyo);
				filterDocumentosExpediente.setNumExp(numExp);
				List<DocumentosExpediente> listDocu = this.documentosExpedienteService
						.findAll(filterDocumentosExpediente, null);
				expediente.setDocumentosExpediente(listDocu);
				rdo2.add(expediente);

			}

		}

		modelMap.put("lDatos", rdo2);

		if (TipoExpedienteEnum.INTERPRETACION.getValue().equals(exp.get(Constants.CERO).getIdTipoExpediente())) {
			return new ModelAndView("pdfJustificanteInterpretacion", modelMap);
		} else {
			return new ModelAndView("pdfJustificanteTradRev", modelMap);
		}

	}

	@RequestMapping(value = "/getPermisosBopv/{anyo}/{numExp}", method = RequestMethod.GET)
	@ResponseBody()
	public String getPermisosBopv(@PathVariable Long anyo, @PathVariable Integer numExp) {
		ExpedienteController.LOGGER.info("[GET - View]: obtenerDatosGestorX54j");
		return this.expedienteService.getPermisosBopv(anyo, numExp);
	}

	private StringBuilder obtenerNumExpConCeros(Integer numExpRelDigitsAux) {
		StringBuilder numExpFormated = new StringBuilder();
		Integer numExpRelDigits = numExpRelDigitsAux;
		if (numExpRelDigits <= Constants.SEIS) {
			numExpRelDigits = Constants.SEIS - numExpRelDigits;
			numExpFormated.setLength(Constants.CERO);
			for (int j = Constants.CERO; j < numExpRelDigits; j++) {
				numExpFormated.append("0");
			}
		}
		return numExpFormated;
	}
}